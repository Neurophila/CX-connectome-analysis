---
title: "Projecting synapse locations to plane that contains most variance"
output:
  html_document:
    df_print: paged
---
#Analysis of Ring neuron connectivity
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(natverse)
require(matlib)

source("neuprintQueryUtils.R")
source("SynapsePCAUtils.R")
require(alphahull)
require(RColorBrewer)
library("paletteer")
```

```{r}
neuprint_login()
#neuprint_login(config=httr::set_config(httr::config(ssl_verifypeer = 0L)))
```


### (0) Get some synapse locations
Choose ROI and get curated list of neurons
```{r}
myROI = "BU(R)"
#load(paste0("/Users/haberkernh/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/",myROI,"/",myROI,"_Types.RData"))

saveName = paste0("RN_in_", myROI)
my_types = c("R1","R2","R3","R4","R5","R6")#c("TuBu")# 
my_types = paste0(my_types, ".*")
cmapName = "colorMap_RingNeurons"#"colorMap_TuBus"#

my_neurons = getBodyIdsForList(my_types)
# Ring neurons: c("R1","R2","R3","R4","R5","R6")
# ExR: #EB_Type[grep("ExR.*", EB_Type)]
# ExR etc in BU: c("ExR", "PDM21a", "TuTu") "colorMap_ExR_and_PDM21a"
# Columnar: c("EL","EPG","EPGt","PEG","PEN_a","PEN_b")
# TuBu:  c("TuBu")

#Load custom color palette
myColorMap <- read.csv(paste0("~/Documents/code/neuprintR-notebooks/",cmapName,".csv"))

```

...use this list to get synapse locations
```{r}
my_synapses = neuprint_get_synapses(as.numeric(getBodyIdsForList(my_types)$bodyid),myROI)
```

```{r}
my_synapses = my_synapses %>% mutate(
name=neuprint_get_meta(as.numeric(bodyid), all_segments = TRUE)[["name"]],
type=neuprint_get_meta(as.numeric(bodyid), all_segments = TRUE)[["type"]],
partnerName=neuprint_get_meta(as.numeric(partner), all_segments = TRUE)[["name"]],
partnertype=neuprint_get_meta(as.numeric(partner), all_segments = TRUE)[["type"]])
```

### (1) Import of ROI meshes and get vertices in x,y,z
```{r}
roiMesh = neuprint_ROI_mesh(myROI)
roiMeshPts = data.frame(dotprops(roiMesh)$points)
names(roiMeshPts) <- c("x","y","z")
```


### (2) Find convenient coordinate system based on PCA of vertices and center of mass of the ROI
***Transform mesh  and synapse locations***
```{r}
# define new origin from roi center of mass
origin = getCOM(roiMeshPts)

#reset orgin
roiMeshPts = resetOrigin(roiMeshPts, origin)

#get eigenvectors
roiEigen = covPCA(roiMeshPts)

roiMeshPtsRot = changeBasis(roiMeshPts, roiEigen)

#Synapse locations
synPts = data.frame(x=as.numeric(my_synapses$x),
                    y=as.numeric(my_synapses$y),
                    z=as.numeric(my_synapses$z))
synPts = resetOrigin(synPts, origin)
synPtsRot = changeBasis(synPts, roiEigen)

```

***Select either original or EV coordinates and rotate***
```{r}
rot = c(45,180, 0) #BU (45,180, 0) EB: (0,0,180) AOTU: (0,180,0)

roiMeshPtsPlane = data.frame(x=roiMeshPtsRot$X,
                             y=roiMeshPtsRot$Y,
                             z=roiMeshPtsRot$Z)
synPtsPlane = data.frame(x=synPtsRot$X,
                             y=synPtsRot$Y,
                             z=synPtsRot$Z)
# rotate points
roiMeshPtsPlane = data.matrix(roiMeshPtsPlane)
synPtsPlane = data.matrix(synPtsPlane)

roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatXY(rot[1])
synPtsPlane = synPtsPlane %*% makeRotMatXY(rot[1])
roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatYZ(rot[2])
synPtsPlane = synPtsPlane %*% makeRotMatYZ(rot[2])
roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatXZ(rot[3])
synPtsPlane = synPtsPlane %*% makeRotMatXZ(rot[3])

roiMeshPtsPlane = data.frame(x=roiMeshPtsPlane[,1],y=roiMeshPtsPlane[,2],z=roiMeshPtsPlane[,3])
synPtsPlane = data.frame(x=synPtsPlane[,1],y=synPtsPlane[,2],z=synPtsPlane[,3],
                         type = as.factor(my_synapses$type), 
                         partnerType = as.factor(my_synapses$partnertype),
                         name = as.factor(my_synapses$name), 
                         partnerName = as.factor(my_synapses$partnerName),
                         id = as.factor(my_synapses$bodyid),
                         partnerid = as.factor(my_synapses$partner))

#Add simple type name
synPtsPlane = synPtsPlane %>% mutate(simpleType = gsub("_.*", "",type))
```

```{r}
synCount = synPtsPlane %>% count(type)
typeFilter = synCount$type[synCount$n > 10]

# generate color map
dataFilt = synPtsPlane %>% filter(type %in% typeFilter)

myTypeCols = myColorMap %>% filter(Type %in% unique(dataFilt$simpleType)) %>% filter(Simpletype == "yes")
myTypeCols = myTypeCols[match(as.character(unique(dataFilt$simpleType)), myTypeCols$Type),] %>%
  arrange(unique(dataFilt$simpleType))

mySubtypeCols = myColorMap %>% filter(Type %in% unique(dataFilt$type)) %>% filter(Simpletype == "no")
mySubtypeCols = mySubtypeCols[match(as.character(unique(dataFilt$type)), mySubtypeCols$Type),] %>%
  arrange(unique(dataFilt$type))

```

### Look at synapse distributions of individual neurons

3D plot
```{r}
partnerSubset = getBodyIdsForList(paste0(c("TuBu"),".*")) # "R1", "R2","R3","R4", "R5", "R6""
data = dataFilt %>% filter(partnerType %in% partnerSubset$type) %>% filter(type %in% c("R4d"))

mycols = paletteer_d("Polychrome::palette36")
myids = unique(data$id)

nclear3d()
for (i in seq(length(myids))){
  toplot = synPtsPlane%>%filter(id == myids[i]) %>% select(c('x','y','z'))
  plot3d(toplot, col=mycols[i], add=TRUE)
  plot3d(toplot %>% summarize_each(mean), col=mycols[i], size=10, add=TRUE)
}
decorate3d(box=FALSE)
```

```{r}
synRelDist = dataFilt %>% group_by(id) %>% filter(partnerType %in% partnerSubset$type) %>%
  mutate(x_h = x - mean(x), y_h = y - mean(y),z_h = z - mean(z)) %>%
  mutate(syndist = sqrt( x_h^2 + y_h^2 + z_h^2)) %>%
  mutate(npartner = length(unique(partnerid)))
```



Glomeruli size

```{r}

synDistDistr = ggplot(data=synRelDist) + 
  geom_density(aes(x=syndist,color=type, hue=id)) +
  #facet_grid(rows=vars(type)) + 
  scale_color_manual(values = as.character(mySubtypeCols$hex)) +
  guides() + theme_classic() + coord_cartesian(xlim = c(0, 1500))

print(synDistDistr)
plotW = 20
plotH = 12
ggsave( paste("synapseDistributions_",saveName,'_synDistanceDistribution.pdf', sep=''), plot = synDistDistr, device='pdf',
        path = "../neuprintR_analysis_plots/", scale = 1, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)


```


```{r}
meanGlomSize = synRelDist %>% group_by(type, id) %>% summarize(meandist = mean(syndist),
                                                               mediandist = median(syndist), 
                                                               stddist = sd(syndist), 
                                                               x = median(x),
                                                               y = median(y),
                                                               z = median(z),
                                                               npartner = mean(npartner))

meanglom = ggplot(data=meanGlomSize,aes(x=type, y=mediandist, fill=type)) + 
  geom_dotplot(binaxis = "y", stackdir = "center",dotsize= 2, binwidth=10)  + #0.65
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  coord_cartesian(ylim = c(0, 1200)) +
  guides(fill=FALSE) + theme_classic()

stdglom = ggplot(data=meanGlomSize,aes(x=type, y=stddist, fill=type)) + 
  geom_dotplot(binaxis = "y", stackdir = "center",dotsize=1, binwidth=10)  +  #1.4
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  coord_cartesian(ylim = c(0, 800)) +
  guides(fill=FALSE) + 
  theme_classic()

print(meanglom)
print(stdglom)

plotW = length(unique(dataFilt$type)) +  4
plotH = 12
ggsave( paste("synapseDistributions_",saveName,'_medianGlomerulusSize.pdf', sep=''), plot = meanglom, device='pdf',
        path = "../neuprintR_analysis_plots/", scale = 1, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)

ggsave( paste("synapseDistributions_",saveName,'_stdGlomerulusSize.pdf', sep=''), plot = stdglom, device='pdf',
        path = "../neuprintR_analysis_plots/", scale = 1, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)


# Do this for different directions spearately to cover that glomeruli may not be circular

```


```{r}
partnerGlomSize = dataFilt %>% 
  group_by(id, partnerid) %>% filter(partnerType %in% partnerSubset$type) %>%
  mutate(x_h = x - mean(x), y_h = y - mean(y),z_h = z - mean(z)) %>%
  mutate(syndist = sqrt( x_h^2 + y_h^2 + z_h^2)) %>%
  mutate(npartner = length(unique(partnerid))) %>% 
  group_by(type, id, partnerid) %>% 
  summarize(meandist = mean(syndist),
            mediandist = median(syndist), 
            stddist = sd(syndist), 
            npartner = mean(npartner),
            nconnection = length(syndist))

partnerGlomSize = left_join(partnerGlomSize, unique(dataFilt[c("partnerType", "partnerid")]))
```
```{r}

partnerglom = ggplot(data=partnerGlomSize ,aes(x=partnerType, y=nconnection, fill=type)) + 
  geom_dotplot(binaxis = "y", stackdir = "center",dotsize=2, binwidth=1)  +  #1.4
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  coord_cartesian(ylim = c(0, 120)) +
  guides(fill=FALSE) + 
  theme_classic()
print(partnerglom)

ggsave( paste("synapseDistributions_",saveName,'_partnerDistribution.pdf', sep=''), plot = partnerglom, device='pdf',
        path = "../neuprintR_analysis_plots/", scale = 1, width = length(unique(dataFilt$partnerType)), height = plotH*1.5, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}

pwdistPlot = ggplot(data=partnerGlomSize %>% filter(nconnection>0),aes(x=mediandist, y=nconnection, fill=type, color=type)) + 
  geom_point()  +  #0.4 $1
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) +
  scale_color_manual(values = as.character(mySubtypeCols$hex)) +
  #coord_cartesian(ylim = c(0, 2000)) +
  guides(fill=FALSE, color=FALSE) + 
  theme_classic()
print(pwdistPlot)

ggsave( paste("synapseDistributions_",saveName,'_syncountperpartnerVsMediansyndist.pdf', sep=''), plot = pwdistPlot, device='pdf',
        path = "../neuprintR_analysis_plots/", scale = 1, width = 15, height = 10, units ="cm", dpi = 600, limitsize = TRUE)
```


Distance between glomeruli (i.e. are there duplicates?)
TODO: Check if center of mass of neuron_i is within center of mass of neuron_j + 

```{r}
pwDist = data.frame()
typeList = unique(meanGlomSize$type)
for(i in seq(length(typeList))){
  currtype = typeList[i]
  posData = meanGlomSize %>% filter(type==currtype) %>% select(c('x','y','z'))
  distVals = as.matrix(dist(posData,diag=FALSE, upper = TRUE)) 
  distVals = distVals + diag(NA, dim(distVals))
  
  tmp = data.frame(type = currtype, distances = apply(distVals, 2, min,na.rm=TRUE), meandists = apply(distVals, 2, mean,na.rm=TRUE))

  pwDist = bind_rows(pwDist,tmp)
}

pwdistPlot = ggplot(data=pwDist,aes(x=type, y=distances, fill=type)) + 
  #geom_point(aes(color=type))  +  geom_jitter(width=0.25, height=0) + 
  #scale_color_manual(values = as.character(mySubtypeCols$hex)) + 
  geom_dotplot(binaxis = "y", stackdir = "center", binwidth=10, dotsize=3)  +  #0.4 $1
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  coord_cartesian(ylim = c(0, 2000)) +
  guides(fill=FALSE) + 
  theme_classic()
print(pwdistPlot)

ggsave( paste("synapseDistributions_",saveName,'_shortestDistBetweenGloms.pdf', sep=''), plot = pwdistPlot, device='pdf',
        path = "../neuprintR_analysis_plots/", scale = 1, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)
```


UMAP (uniform manifold approximation)

```{r}
library(umap)

gloms.umap = umap(bind_cols(pwDist[c("distances", "meandists")], meanGlomSize[c("stddist","mediandist")]))

layout = gloms.umap$layout

umapdf = data.frame(x = layout[,1], y = layout[,2], type = meanGlomSize$type)

# Find the convex hull of the points being plotted
hull <- umapdf %>% group_by(type)  %>% slice(chull(x,y))

umapplot = ggplot(data = umapdf,aes(x,y, color=type)) + 
  # Overlay the convex hull
  geom_polygon(data = hull, alpha = 0.2, aes(fill=type) ) +
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) +
  geom_point(size=3, shape=20) + 
  scale_color_manual(values = as.character(mySubtypeCols$hex)) +
  theme_classic()


print(umapplot)

ggsave(paste("synapseDistributions_",saveName,'_umapEmbedding.pdf', sep=''), plot = umapplot, device='pdf',
        path = "../neuprintR_analysis_plots/", scale = 1, width = 20, height = 15, units ="cm", dpi = 600, 
       useDingbats=FALSE)
```
