---
title: "PB Figure 3 - D7s vs P6-8P9"
output: html_notebook
---


```{r}
library(neuprintr)
library(tidyverse)
library(cowplot)
library(neuprintrExtra)
library(reshape2)
library(patchwork)
library(ggnewscale)
library(gridExtra)

source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\PBAnalysisUtils.R")
```

Specify plotting text sizes
```{r}
tickLabSz <- 6
axLabSz <- 8
legSz <- 6
legTitSz <- 8
pltTit <- 8

theme_set(theme(axis.title = element_text(size = axLabSz), 
      axis.text = element_text(size = tickLabSz),
      legend.text = element_text(size = legSz),
      legend.title = element_text(size = legTitSz),
      plot.title = element_text(size = pltTit)))

stCols <- supertype2Palette()
```

Get the R and L PB neurons
```{r}
nronNames_R <- c("P6-8P9(PB14)_R", "Delta7(PB15)_L8R1R9_L")
nronNames_L <- c("P6-8P9(PB14)_L", "Delta7(PB15)_L1L9R8_R")
```

Plot the synaptic input by position for gloms 4-9 for P6-8P9s and D7s
```{r}
# Look at the right PB only since the left PB only has one complete P6-8P9
PBGloms <- c("R9","R8","R7","R6","R5","R4")

# Initialize a data frame to hold the data across gloms
synsByGlom_in <- data.frame(type.from = c(),name.to = c(),
                         numSyns = c(),roi = c())

# Step through the gloms
for (g in 1:length(PBGloms)){
  # Get the info about each synapse restricted to the ROIs of interest
  synDatByGlom <- neuprint_get_synapses(
    getTypesTable(c("Delta7","P6-8P9")) %>% filter(name %in% nronNames_R) %>% select(bodyid),
    roi=paste0("PB(",PBGloms[g],")")) %>%
    filter(prepost == 1) %>%
    mutate(name.from = neuprint_get_meta(partner)$name,
           type.from = neuprint_get_meta(partner)$type,
           name.to = neuprint_get_meta(bodyid)$name,
           type.to = neuprint_get_meta(bodyid)$type)
  synDatByGlom <- synDatByGlom %>% filter(!is.na(name.from))
  synDatByGlom$id.from <- PBRename(synDatByGlom$name.from,synDatByGlom$partner)
  synDatByGlom$id.to <- PBRename(synDatByGlom$name.to,synDatByGlom$name)
  
  # Count up the synapses per input type
  glomSyns <- synDatByGlom %>% group_by(type.from,name.to,id.to) %>% summarize(numSyns = n())
  
  # Store the data
  glomSyns$roi <- PBGloms[g]
  synsByGlom_in <- rbind(synsByGlom_in,glomSyns)
}

# Find the mean across individual neurons
synsByGlomStats_in <- synsByGlom_in %>% group_by(type.from,name.to,roi) %>% summarize(meanSyns = mean(numSyns))
synsByGlomStats_in$supertype <- supertype(synsByGlomStats_in$type.from)

# Plot
g_glomIns <- ggplot(synsByGlomStats_in) + geom_bar(aes(x = as.factor(roi),y=meanSyns,fill=as.factor(supertype)),stat="identity") + 
  facet_grid(vars(as.factor(name.to))) + 
  theme_cowplot() + scale_fill_manual(values = stCols$pal, breaks = stCols$breaks)
print(g_glomIns)
```

```{r}
# Get the info about each synapse restricted to the ROIs of interest
synDatByGlom_out <- neuprint_get_synapses(
    getTypesTable(c("Delta7","P6-8P9")) %>% filter(name %in% nronNames_R) %>% select(bodyid),
    roi=paste0("PB(R9)")) %>%
    filter(prepost == 0) %>%
    mutate(name.to = neuprint_get_meta(partner)$name,
           type.to = neuprint_get_meta(partner)$type,
           name.from = neuprint_get_meta(bodyid)$name,
           type.from = neuprint_get_meta(bodyid)$type)
synDatByGlom_out <- synDatByGlom_out %>% filter(!is.na(name.to))
synDatByGlom_out$id.from<- PBRename(synDatByGlom_out$name.from,synDatByGlom_out$bodyid)
synDatByGlom_out$id.to <- PBRename(synDatByGlom_out$name.to,synDatByGlom_out$partner)

# Find the number of synapses per type
glomSyns_out <- synDatByGlom_out %>% group_by(id.from,name.from,type.to) %>% summarize(numSyns = n())

# Average over the neurons
glomSynsStats_out <- glomSyns_out %>% group_by(name.from,type.to) %>% summarize(meanSyns = mean(numSyns))
glomSynsStats_out$supertype <- supertype(glomSynsStats_out$type.to)

# Plot    
g_glomOuts <- ggplot(glomSynsStats_out) + geom_bar(aes(x = as.factor(name.from),y=meanSyns,fill=as.factor(supertype)),stat="identity") + 
  theme_cowplot() + theme(axis.text.x = element_text(angle=90)) +
  scale_fill_manual(values = stCols$pal, breaks = stCols$breaks)
print(g_glomOuts)
```

```{r}
glomSyns_idin <- synDatByGlom_out %>% group_by(type.from,id.from,type.to,id.to) %>% summarize(numSyns = n())
glomSyns_idin <- glomSyns_idin %>% filter(grepl("R9",id.to) |
                                            grepl("LPsP",id.to) |
                                            grepl("P6-8P9",id.to))
glomSyns_idin$supertype <- supertype(glomSyns_idin$type.to)

fillBreaks <- glomSyns_idin$id.from %>% unique() %>% as.character() %>% sort()
fillCols <- c()
for (n in 1:length(fillBreaks)){
  if (grepl("Delta7",fillBreaks[n])){
    fillCols <- append(fillCols,stCols$pal[which(stCols$breaks == "Delta7")])
  } else {
    fillCols <- append(fillCols,stCols$pal[which(stCols$breaks == "P")])
  }
}
txtLabs <- glomSyns_idin$id.to %>% unlist() %>% unique() %>% as.character() %>% sort()
typLabs <- lapply(txtLabs,function(t) strsplit(t,'_')[[1]][1]) %>% unlist() %>% as.character() %>% unlist() %>% unique()
txtCols <- lapply(txtLabs,
                  function(t)
                    stCols$pal[
                      which(stCols$breaks == 
                              unique(glomSyns_idin[which(glomSyns_idin$id.to == t),]$supertype))]) %>% unlist()

# Plot    
g_typeIn <- ggplot(glomSyns_idin) + geom_bar(aes(x = as.factor(id.to),y=numSyns,fill=as.factor(id.from)),stat="identity",color='black') + 
  theme_cowplot() + theme(axis.text.x = element_text(angle=90,color=txtCols)) +
  scale_fill_manual(values = fillCols,
                    breaks = fillBreaks) + 
  theme(axis.text.x = element_text()) + xlab('downstream neuron') + ylab('number of synapses')
offset <- 0.5
for (t in 1:(length(typLabs)-1)){
  offset <- offset + length(which(grepl(typLabs[t],txtLabs)))
  g_typeIn <- g_typeIn + geom_vline(xintercept = offset,color='gray',linetype="dashed")
}
print(g_typeIn)

glomSyns_typein <- synDatByGlom_out %>% group_by(type.from,id.to,type.to) %>% summarize(numSyns = n())
glomSyns_typein[which(glomSyns_typein$type.from == "P6-8P9"),]$type.from <- "P68P9"
glomSyns_typein <- dcast(glomSyns_typein, id.to + type.to ~ type.from)
glomSyns_typein[is.na(glomSyns_typein)] <- 0
glomSyns_typein$supertype <- supertype(glomSyns_typein$type.to)

g_scat <- ggplot(glomSyns_typein) + geom_point(aes(x=Delta7,y=P68P9,color=supertype)) +
  geom_smooth(aes(x=Delta7,y=P68P9),method='lm') +
  scale_color_manual(values = stCols$pal,
                     breaks = stCols$breaks) +
  theme_cowplot() + xlab('Delta 7 synapses') + ylab('P6-8P9 synapses')
print(g_scat)

g_all <- g_typeIn / g_scat

save_plot('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\P68P9VsD7DSIns.pdf',
          g_all,
          base_height=8)
```


Combine the plots and save
```{r}
P68P8VsD7Plots <- g_glomIns + g_glomOuts
save_plot('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\P68P9VsD7InsNOutsByGlom.pdf',
          P68P8VsD7Plots,
          base_height=8)
```

For each type that the P6-8P9's output to, plot the activity (assuming E-PG bump -> D7 -> type) with and without them
First generate an artificial EPG bump at all positions
```{r}
# Generate a von Mises profile
actProf <- data.frame(act = vonMisesProf(),
                        glom = c("R1","L8","R2","L7","R3","L6","R4","L5",
                                 "R5","L4","R6","L3","R7","L2","R8","L1"))

# Get the ids and gloms for all of the EPGs
allEPGids = paste(getTypesTable(c("EPG"))$name,
                     getTypesTable(c("EPG"))$bodyid,sep='_') %>%
    as.character() %>% unique() %>% PBGlomSort()
allEPGGloms = strsplit(allEPGids,"_") %>% lapply(function(x){tail(x,2)[1]}) %>% unlist()

# Initialize data frames to hold all of the circular permutations
allEPGProfs <- data.frame(nameid = allEPGids, glom = allEPGGloms)

# Permute through the glomeruli
for (pkGlom in 1:16){
  actProf$act <- c(tail(actProf$act, -1), head(actProf$act, 1))
  
  # Get the EPG activity given the assumed profile
  EPGact = numeric(length(allEPGids))
  for (EPG in 1:length(allEPGids)){
    EPGact[EPG] <- actProf[which(actProf$glom == allEPGGloms[EPG]),]$act
  }
  allEPGProfs[paste0("act",pkGlom)] <- EPGact
}
```

Now get the types (and names of P6-8P9 downstream partners)
```{r}
# Get the info about each synapse restricted to the ROIs of interest
synDatByGlom_out <- neuprint_get_synapses(
    getTypesTable(c("P6-8P9")) %>% filter(name %in% nronNames_R) %>% select(bodyid),
    roi=paste0("PB(R9)")) %>%
    filter(prepost == 0) %>%
    mutate(name.to = neuprint_get_meta(partner)$name,
           type.to = neuprint_get_meta(partner)$type,
           name.from = neuprint_get_meta(bodyid)$name,
           type.from = neuprint_get_meta(bodyid)$type) %>%
  mutate(id.to = paste(name.to,partner,sep='_'),
         id.from = paste(name.from,bodyid,sep='_'))
synDatByGlom_out <- synDatByGlom_out %>% filter(!is.na(name.to))
```

Get a matrix of EPGs to P6-8P9s to a given type
```{r}
P68P9TransMat <- function(DSType){
  # Get the neuron ids
  allEPGids <- paste(getTypesTable(c("EPG"))$name,
                     getTypesTable(c("EPG"))$bodyid,sep='_') %>%
    as.character() %>% unique() %>% PBGlomSort()
  
  P6P89_R <- getTypesTable(c("P6-8P9")) %>% filter(name %in% nronNames_R)
  allP6P89ids_R <- paste(P6P89_R$name,
                         P6P89_R$bodyid,sep='_') %>%
    as.character() %>% unique() %>% sort()
  
  allPBTpids <- paste(getTypesTable(c(DSType))$name,
                      getTypesTable(c(DSType))$bodyid,sep='_') %>%
    as.character() %>% unique() %>% sort()
  
  # Get the EPG to P6-8P9 connection table
  EPG_2_P68P9 <- getConnectionTable(
    getTypesTable(c("EPG"))$bodyid,
    "POST",
    "PB",
    synThresh= 0) %>% filter(type.from == "EPG" & type.to == "P6-8P9")
  EPG_2_P68P9$nameid = paste(as.character(EPG_2_P68P9$name.from), as.character(EPG_2_P68P9$from), sep = "_")
  EPG_2_P68P9$partnerid = paste(as.character(EPG_2_P68P9$name.to), as.character(EPG_2_P68P9$to), sep = "_")
  
  # Convert it to a weight matrix
  EPG_2_P68P9_WM <- WMFromConTab(EPG_2_P68P9,allEPGids,allP6P89ids_R)
  
  # Get the P6-8P9 connection table
  P68P9_2_Type <- getConnectionTable(
    EPG_2_P68P9 %>% filter(name.to %in% nronNames_R) %>% select(to) %>% unique() %>% unlist() %>% as.numeric(),
    "POST",
    "PB",
    synThresh= 0) %>% filter(type.to == DSType)
  P68P9_2_Type$nameid = paste(as.character(P68P9_2_Type$name.from), as.character(P68P9_2_Type$from), sep = "_")
  P68P9_2_Type$partnerid = paste(as.character(P68P9_2_Type$name.to), as.character(P68P9_2_Type$to), sep = "_")
  
  # Convert it to a weight matrix
  P68P9_2_Type_WM <- WMFromConTab(P68P9_2_Type,allP6P89ids_R,allPBTpids)
  
  # Calculate the overall matrix
  transMat <- EPG_2_P68P9_WM %*% P68P9_2_Type_WM
  colnames(transMat) <- allPBTpids
  rownames(transMat) <- allEPGids
  
  return(transMat)
}
```

For those partners, look at the profile of "input" with and without the P6-8P9s
```{r}
# Get the types of the downstream partners
P68P9DS <- synDatByGlom_out %>% filter(name.from %in% nronNames_R) %>% select(type.to) %>% unique() %>% unlist() %>% as.character()
P68P9DS <- P68P9DS[which(!(P68P9DS %in% c("P1-9","LPsP","SpsP","P6-8P9","Delta7")))] %>% sort()
  
g_list <- list()
for (t in 1:length(P68P9DS)){
  g_type <- ggplot()
  
  # Get the EPG to D7 to type matrix
  transMat_D7<- EPGToD7Mat(P68P9DS[t])
  transMat_P68P9 <- P68P9TransMat(P68P9DS[t])
  typeNrons <- colnames(transMat_D7)
  
  # Get the names of the neurons that are downstream
  DSNames <- synDatByGlom_out %>% filter(name.from %in% nronNames_R, type.to == P68P9DS[t]) %>% select(id.to) %>% unique() %>% unlist() %>% as.character()
  
  # Find (and plot) the curves for each neuron
  for (n in 1:length(DSNames)){
    act_D7 <-  c()
    act_P68P9 <-  c()
    nronPos <- which(typeNrons == as.character(DSNames[n]))
    if (length(nronPos) == 0){
      print(DSNames[n])
      next
    }
    for (i in 1:16){
      typeAct_D7 <- as.vector(unlist(allEPGProfs[paste0('act',i)])%*%transMat_D7)
      typeAct_P68P9 <- as.vector(unlist(allEPGProfs[paste0('act',i)])%*%transMat_P68P9)
      act_D7 <- append(act_D7,typeAct_D7[nronPos])
      act_P68P9 <- append(act_P68P9,typeAct_P68P9[nronPos])
    }
    allDat_D7 <- data.frame(bumpPos = seq(1:16), act = act_D7)
    allDat_P68P9 <- data.frame(bumpPos = seq(1:16), act = act_P68P9+act_D7)
    g_type <- g_type + geom_line(data = allDat_D7,aes(x=bumpPos,y =act),color='black')
    g_type <- g_type + geom_line(data = allDat_P68P9,aes(x=bumpPos,y =act),color='red',linetype='dashed')
  }
  g_list[[t]] <- g_type + theme_cowplot() + ggtitle(P68P9DS[t])
}

pdf('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\Glom9\\AddP6-8P9Ins.pdf', width = unit(8,"in"), height = unit(8,"in"))
grid.arrange(grobs=g_list)
dev.off()

```

Get the presynaptic partners for P6-8P9s and the Delta7s that arborize in L or R glom 9
```{r}
nronNames_R <- c("P6-8P9(PB14)_R", "Delta7(PB15)_L8R1R9_L")
nronNames_L <- c("P6-8P9(PB14)_L", "Delta7(PB15)_L1L9R8_R")

D7vsP68P9_CT_PB_PRE <- getConnectionTable(getTypesTable(c("Delta7","P6-8P9"))$bodyid,"PRE","PB")
D7vsP68P9_CT_PB_PRE <- D7vsP68P9_CT_PB_PRE %>% filter(!is.na(type.from) & type.from !="SIFa")
D7vsP68P9_CT_PB_PRE <- D7vsP68P9_CT_PB_PRE %>% filter(name.to %in% c(nronNames_R,nronNames_L))

D7vsP68P9_CT_PB_PRE$id.from <- PBRename(D7vsP68P9_CT_PB_PRE$name.from,D7vsP68P9_CT_PB_PRE$from)
D7vsP68P9_CT_PB_PRE$id.to <- PBRename(D7vsP68P9_CT_PB_PRE$name.to,D7vsP68P9_CT_PB_PRE$to)
```

```{r}
D7vsP68P9_CT_PB_PRE$glom.from <- D7vsP68P9_CT_PB_PRE$id.from %>% as.character() %>% strsplit("_") %>% lapply(function(x)head(x,2)[2]) %>% unlist() %>% strsplit('-') %>% lapply(function(x)head(x,1)[1]) %>% unlist()
D7vsP68P9_CT_PB_PRE$glom.from[which(D7vsP68P9_CT_PB_PRE$type.from == "PFR_b")] <- 
  D7vsP68P9_CT_PB_PRE$id.from[which(D7vsP68P9_CT_PB_PRE$type.from == "PFR_b")] %>%
  as.character() %>% strsplit("_") %>% lapply(function(x)head(x,3)[3]) %>% unlist() %>% strsplit('-') %>% lapply(function(x)head(x,1)[1]) %>% unlist()

glomOld <- c()
glomNew <- c()
glomOrder_R = c("L7R2","L7R3","L6R3","R3/4/5","L6R4","L5R4","L4R5","R5/6","L3R6","L4R6","R7/9","L2R7",
                "L1L9R8","L8R1R9",
              "L","R")
glomOrder_L = c("L1","L2","L2R7","L3","L3R6","L4","L4R5","L4R6","L5","L5R4",
                "L6","L6R3","L6R4","L7","L7R3","L7R2","L8","L9",
                "R1","R2","R3","R3/4/5","R4","R5","R5/6","R6","R7","R7/9","R8","R9",
                "L1L9R8","L8R1R9",
                "L","R")
```


Plot the connection matrix
```{r}
D7vsP68P9_CT_PB_PRE$glom.from <- factor(D7vsP68P9_CT_PB_PRE$glom.from,levels = glomOrder_R)

D7vsP68P9_PB_PRE_R <- ggplot(D7vsP68P9_CT_PB_PRE %>% filter(name.to %in% nronNames_R)) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(D7vsP68P9_CT_PB_PRE$weightRelative),
                       limits=c(0,max(D7vsP68P9_CT_PB_PRE$weightRelative))) +
  #facet_grid(rows = vars(glom.from), scales = 'free') +
  geom_tile(aes(id.to,id.from,fill=weightRelative)) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("pre-synaptic type") + ylab("post-synaptic type")

print(D7vsP68P9_PB_PRE_R)

D7vsP68P9_CT_PB_PRE$glom.from <- factor(D7vsP68P9_CT_PB_PRE$glom.from,levels = glomOrder_L)

D7vsP68P9_PB_PRE_L <- ggplot(D7vsP68P9_CT_PB_PRE %>% filter(name.to %in% nronNames_L)) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(D7vsP68P9_CT_PB_PRE$weightRelative),
                       limits=c(0,max(D7vsP68P9_CT_PB_PRE$weightRelative))) +
  #facet_grid(rows = vars(glom.from), scales = 'free') +
  geom_tile(aes(id.to,id.from,fill=weightRelative)) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("pre-synaptic type") + ylab("post-synaptic type")

print(D7vsP68P9_PB_PRE_L)


```


```{r}

```


Create a type-to-type table for Delta7, P6-8P9 - POST
```{r}
D7vsP68P9_CT_PB_POST <- getConnectionTable(getTypesTable(c("Delta7","P6-8P9"))$bodyid,"POST","PB")
D7vsP68P9_CT_PB_POST <- D7vsP68P9_CT_PB_POST %>% filter(!is.na(type.to) & !is.na(type.from)) %>%
  filter(type.to !="SIFa" & type.from !="SIFa")

P68P9_T2T_PB_POST <- getTypeToTypeTable(D7vsP68P9_CT_PB_POST %>% filter(type.from == "P6-8P9"),
                                        pThresh=1)
D7_T2T_PB_POST <- getTypeToTypeTable(D7vsP68P9_CT_PB_POST %>% filter(type.from == "Delta7"))
D7vsP68P9_T2T_PB_POST <- rbind(P68P9_T2T_PB_POST,D7_T2T_PB_POST)

T2TPlot_D7vsP68P9_PB_POST <- ggplot(D7vsP68P9_T2T_PB_POST) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(D7vsP68P9_T2T_PB_POST$weightRelative),
                       limits=c(0,max(D7vsP68P9_T2T_PB_POST$weightRelative))) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("pre-synaptic type") + ylab("post-synaptic type")

print(T2TPlot_D7vsP68P9_PB_POST)
```



Combine in one plot
```{r}
pdf('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\OtherInsAndOuts.pdf', width = unit(8,"in"), height = unit(8,"in"))
grid.arrange(T2TPlot_NM_PB_POST,T2TPlot_D7vsP68P9_PB_POST,T2TPlot_D7vsP68P9_PB_PRE,
             layout_matrix=rbind(c(1,3),c(2,NA)),
             widths = 3:2)
dev.off()
```