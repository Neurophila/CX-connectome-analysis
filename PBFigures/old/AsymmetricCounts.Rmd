Load the libraries
```{r}
library(nat)
library(neuprintr)
library(neuprintrExtra)
library(dplyr)
library(ggplot2)
library(cowplot)
library(patchwork)
source(file.path("..","..","PBFigures","PBAnalysisUtils.R"))
source(file.path("..","..","R","paperTheme.R"))
```

Get the neuronBag for the columnar PB neurons
```{r}
colNrons <- c('EPG','PEN_a(PEN1)','PEN_b(PEN2)',
              unique(neuprint_search('PFN.*')$type),
              'PFL2', 'PFL3',
              'PFR_a', 'PFR_b')
colNronsBag <- neuronBag(getTypesTable(colNrons))
```

Specify the rois to look at
```{r}
rois <- c('PB','EB','FB','NO','LAL(R)','ROB(R)')
```

Get the output data
```{r}
colNronOuts <- colNronsBag$outputs_raw
colNronOuts$glom <- colNronOuts$name.from %>% lapply(function(x) sub(".*_([L|R][[:digit:]])_?.*","\\1",x)) %>% unlist() %>% unlist()
colNronOuts <- colNronOuts[!grepl('irreg',colNronOuts$glom),] # remove the irregular neurons
colNronOuts$id.from <- PBRename(colNronOuts$name.from, colNronOuts$from)
```

Group by roi, neuron id
```{r}
colNronOutsByID <- colNronOuts %>% group_by(roi, id.from, glom, type.from) %>% summarize(totalOutput = sum(ROIweight))
colNronOutsByID <- colNronOutsByID[colNronOutsByID$roi %in% rois,]
colNronOutsByID$glom <- factor(colNronOutsByID$glom, levels = as.factor(PBGlomSort(unique(colNronOutsByID$glom))))
```

Plot the output synapses per glomeruli
For the PB
```{r, fig.width=5, fig.height = 2}
Outs_barPlt_PB <- ggplot(colNronOutsByID %>% filter(roi == "PB", type.from == "EPG")) + geom_bar(aes(x=glom,y=totalOutput),stat='identity',position = 'stack',fill='black',color='white') +
  facet_grid(rows = vars(type.from)) +
  theme_cowplot() + ylab('total # of output synapses')
Outs_barPlt_PB
```
For the EB
```{r, fig.width=5, fig.height = 5}
Outs_barPlt_EB <- ggplot(colNronOutsByID %>% filter(roi == "EB")) + geom_bar(aes(x=glom,y=totalOutput),stat='identity',position = 'stack',fill='black',color='white') +
  facet_grid(rows = vars(type.from)) +
  theme_cowplot() + ylab('total # of output synapses')
Outs_barPlt_EB
```
For the FB
```{r, fig.width=5, fig.height = 10}
Outs_barPlt_FB <- ggplot(colNronOutsByID %>% filter(roi == "FB", !(type.from %in% c('PEN_b(PEN2)','PFL1','PFL2','PFL3')))) +
  geom_bar(aes(x=glom,y=totalOutput),stat='identity',position = 'stack',fill='black',color='white') +
  facet_grid(rows = vars(type.from), scales = 'free') +
  theme_cowplot() + ylab('total # of output synapses')
Outs_barPlt_FB
```
For the NO
```{r, fig.width=5, fig.height = 10}
Outs_barPlt_NO <- ggplot(colNronOutsByID %>% filter(roi == "NO")) +
  geom_bar(aes(x=glom,y=totalOutput),stat='identity',position = 'stack',fill='black',color='white') +
  facet_grid(rows = vars(type.from), scales = 'free') +
  theme_cowplot() + ylab('total # of output synapses')
Outs_barPlt_NO
```
For the LAL and ROB
```{r}
Outs_barPlt_Other <- ggplot(colNronOutsByID %>% filter(roi %in% c("LAL(R)","CRE(L)","ROB(R)"))) +
  geom_bar(aes(x=glom,y=totalOutput),stat='identity',position = 'stack',fill='black',color='white') +
  facet_grid(rows = vars(type.from), cols = vars(roi), scales = 'free') +
  theme_cowplot() + ylab('total # of output synapses')
Outs_barPlt_Other
```

Find the number of neurons per glomerulus
```{r}
numLookup <- colNronOutsByID$id.from %>% unique() %>% lapply(function(x) strsplit(as.character(x),'-')[[1]][1]) %>%
  lapply(function(x) sub('_C[[:digit:]]','',x))  %>% unlist() %>% table() %>% as.data.frame()
colnames(numLookup) <- c('name','freq')
```
```{r, fig.width=10, fig.height = 10}
colNronOutsByID$freq <- colNronOutsByID$id.from %>% 
  lapply(function(x) numLookup[numLookup$name == sub('_C[[:digit:]]','',strsplit(as.character(x),'-')[[1]][1]),]$freq) %>% unlist()

colNronOutsByID_mean <- colNronOutsByID %>% group_by(roi, type.from, freq) %>% summarize(meanSyns = mean(totalOutput)) %>% as.data.frame()
```
Plot the total number of synapses per roi per number within a type
```{r, fig.width=5, fig.height = 10}
Outs_pointPlts <- list()
for (r in 1:length(rois)){
  types <- colNronOutsByID$type.from %>% unique()
  if (rois[r] == 'PB')
    types <- c('EPG')
  if (rois[r] == 'EB')
    types <-c('EPG', 'PEN_a(PEN1)', 'PEN_b(PEN2)')
  if (rois[r] == 'FB')
    types <- c("PFNa", "PFNd", "PFNm_a", "PFNm_b", "PFNp_a", "PFNp_b", "PFNp_c", "PFNp_d", "PFNp_e", "PFNv", "PFR_a","PFR_b")
  if (rois[r] == 'NO')
    types <- c('PEN_a(PEN1)', 'PEN_b(PEN2)', "PFNa", "PFNd", "PFNm_a", "PFNm_b", "PFNp_a", "PFNp_b", "PFNp_c", "PFNp_d", "PFNp_e", "PFNv")
  Outs_pointPlts[[rois[r]]] <- ggplot(colNronOutsByID %>% filter(roi == rois[r], type.from %in% types)) + 
    geom_point(aes(x=freq,y=totalOutput), size = 2, alpha = 0.25) + 
    geom_point(data = colNronOutsByID_mean %>% filter(roi == rois[r], type.from %in% types), aes(x = freq, y = meanSyns), size = 4, color = 'red', alpha=0.5) +
    facet_grid(rows=vars(type.from), scales = 'free_y') + 
    theme_minimal_grid() +
    ylab('total # of output synapses') + xlab('# of instances per glom')
}

```

Plot the mean of the total number of synapses per roi per number within a type normalized by the total counts for the minimum number of neurons per glom
```{r}
colNronOutsByID_meanNorm_tmp <- by(colNronOutsByID_mean,
                                   list(colNronOutsByID_mean$roi,
                                        colNronOutsByID_mean$type.from),
                                   function(x){as.data.frame(list(
                                     roi = x$roi,
                                     type.from = x$type.from,
                                     freq = x$freq,
                                     freq.norm = x$freq/min(x$freq),
                                     meanSyns = x$meanSyns,
                                     meanSyns.norm = x$meanSyns/filter(x,freq==min(x$freq))$meanSyns))})
colNronOutsByID_meanNorm <- do.call(rbind,colNronOutsByID_meanNorm_tmp)
```
```{r, fig.width=3, fig.height = 4}
colNronOutsByID_meanNorm$supertype <- supertype(colNronOutsByID_meanNorm$type.from)

x <- seq(from=1, to = 2, by = 0.1)
y1 <- 1
y2 <- 1/x
decayFn <- as.data.frame(list(x = x, y1 = y1, y2 = y2))

EBPBEtc_OutPlt <- ggplot(colNronOutsByID_meanNorm %>% filter(!(roi %in% c('FB','NO')))) + 
  geom_point(aes(x=freq.norm, y = meanSyns.norm, 
                 color = as.factor(supertype)),
             size = 1, alpha = 0.5) +
  geom_line(data = decayFn, aes(x = x, y = y1), size=0.1) +
  geom_line(data = decayFn, aes(x = x, y = y2), size=0.1) +
  scale_color_manual(breaks = supertype2Palette()$breaks,
                      values = supertype2Palette()$pal) +
  facet_grid(rows = vars(roi)) +
  theme_paper() +
  coord_cartesian(xlim = c(1,2), ylim = c(0.4,1), expand = FALSE, clip ='off') +
  xlab('numerosity factor') + 
  ylab('normalized total synapse count') +
  ggtitle('outputs') +
  theme(plot.margin = margin(0.25,0.25,0.25,0.25,'cm'),
        panel.spacing = unit(0.5, "cm")) +
  scale_x_continuous(breaks = c(1,1.5,2)) +
  scale_y_continuous(breaks = c(0,0.5,1))
EBPBEtc_OutPlt
```
```{r, fig.width=6, fig.height = 4}
x <- seq(from=1, to = 3.5, by = 0.1)
y1 <- 1
y2 <- 1/x
decayFn <- as.data.frame(list(x = x, y1 = y1, y2 = y2))

FBNO_OutPlt <- ggplot(colNronOutsByID_meanNorm %>% filter(roi %in% c('FB','NO'))) + 
  geom_jitter(aes(x=freq.norm, y = meanSyns.norm, 
                 color = as.factor(supertype)),
             size = 1, alpha = 0.5, width = 0.05) +
  geom_line(data = decayFn, aes(x = x, y = y1), size=0.1) +
  geom_line(data = decayFn, aes(x = x, y = y2), size=0.1) +
  scale_color_manual(breaks = supertype2Palette()$breaks,
                      values = supertype2Palette()$pal) +
  facet_grid(rows = vars(roi)) +
  theme_paper() +
  coord_cartesian(xlim = c(1,3.5), ylim = c(0,1.5), expand = FALSE, clip ='off') +
  xlab('numerosity factor') + 
  ylab('normalized total synapse count') +
  ggtitle('outputs') +
  theme(plot.margin = margin(0.25,0.25,0.25,0.25,'cm'),
        panel.spacing = unit(0.5, "cm")) +
  scale_x_continuous(breaks = 1:12)
FBNO_OutPlt
```


Get the input data
```{r}
colNronIns <- colNronsBag$inputs_raw
colNronIns$glom <- colNronIns$name.to %>% lapply(function(x) sub(".*_([L|R][[:digit:]])_?.*","\\1",x)) %>% unlist() %>% unlist()
colNronIns <- colNronIns[!grepl('irreg',colNronIns$glom),] # remove the irregular neurons
colNronIns$id.to <- PBRename(colNronIns$name.to, colNronIns$to)
```

Group by roi, neuron id
```{r}
colNronInsByID <- colNronIns %>% group_by(roi, id.to, glom, type.to) %>% summarize(totalInput = sum(ROIweight))
colNronInsByID <- colNronInsByID[colNronInsByID$roi %in% rois,]
colNronInsByID$glom <- factor(colNronInsByID$glom, levels = as.factor(PBGlomSort(unique(colNronInsByID$glom))))
```

Plot the input synapses per glomeruli
For the PB
```{r, fig.width=5, fig.height = 12}
Ins_barPlt_PB <- ggplot(colNronInsByID %>% filter(roi == "PB")) + geom_bar(aes(x=glom,y=totalInput),stat='identity',position = 'stack',fill='black',color='white') +
  facet_grid(rows = vars(type.to), scales = "free") +
  theme_cowplot() + ylab('total # of input synapses')
Ins_barPlt_PB
```
For the EB
```{r, fig.width=5, fig.height = 4}
Ins_barPlt_EB <- ggplot(colNronInsByID %>% filter(roi == "EB", type.to %in% c('EPG', 'PEN_a(PEN1)','PEN_b(PEN2)'))) + geom_bar(aes(x=glom,y=totalInput),stat='identity',position = 'stack',fill='black',color='white') +
  facet_grid(rows = vars(type.to), scale = "free") +
  theme_cowplot() + ylab('total # of input synapses')
Ins_barPlt_EB
```
For the FB
```{r, fig.width=5, fig.height = 10}
Ins_barPlt_FB <- ggplot(colNronInsByID %>% filter(roi == "FB")) +
  geom_bar(aes(x=glom,y=totalInput),stat='identity',position = 'stack',fill='black',color='white') +
  facet_grid(rows = vars(type.to), scales = 'free') +
  theme_cowplot() + ylab('total # of input synapses')
Ins_barPlt_FB
```
For the NO
```{r, fig.width=5, fig.height = 10}
Ins_barPlt_NO <- ggplot(colNronInsByID %>% filter(roi == "NO")) +
  geom_bar(aes(x=glom,y=totalInput),stat='identity',position = 'stack',fill='black',color='white') +
  facet_grid(rows = vars(type.to), scales = 'free') +
  theme_cowplot() + ylab('total # of input synapses')
Ins_barPlt_NO
```
For the LAL and ROB
```{r}
Ins_barPlt_Other <- ggplot(colNronInsByID %>% filter(roi %in% c("LAL(R)","CRE(L)","ROB(R)"))) +
  geom_bar(aes(x=glom,y=totalInput),stat='identity',position = 'stack',fill='black',color='white') +
  facet_grid(rows = vars(type.to), cols = vars(roi), scales = 'free') +
  theme_cowplot() + ylab('total # of input synapses')
Ins_barPlt_Other
```

Find the number of neurons per glomerulus
```{r}
numLookup <- colNronInsByID$id.to %>% unique() %>% lapply(function(x) strsplit(as.character(x),'-')[[1]][1]) %>% 
   lapply(function(x) sub('_C[[:digit:]]','',x)) %>% unlist() %>% table() %>% as.data.frame()
colnames(numLookup) <- c('name','freq')
```
```{r, fig.width=10, fig.height = 10}
colNronInsByID$freq <- colNronInsByID$id.to %>% 
  lapply(function(x) numLookup[numLookup$name == sub('_C[[:digit:]]','',strsplit(as.character(x),'-')[[1]][1]),]$freq) %>% unlist()

colNronInsByID_mean <- colNronInsByID %>% group_by(roi, type.to, freq) %>% summarize(meanSyns = mean(totalInput)) %>% as.data.frame()
```
Plot the total number of synapses per roi per number within a type
```{r, fig.width=5, fig.height = 10}
Ins_pointPlts <- list()
for (r in 1:length(rois)){
  types <- colNronInsByID$type.to %>% unique()
  if (rois[r] == 'EB')
    types <-c('EPG', 'PEN_a(PEN1)', 'PEN_b(PEN2)')
  if (rois[r] == 'FB')
    types <- c("PFNa", "PFNd", "PFNm_a", "PFNm_b", "PFNp_a", "PFNp_b", "PFNp_c", "PFNp_d", "PFNp_e", "PFNv", "PFR_a","PFR_b","PFL2","PFL3")
  if (rois[r] == 'NO')
    types <- c('PEN_a(PEN1)', 'PEN_b(PEN2)', "PFNa", "PFNd", "PFNm_a", "PFNm_b", "PFNp_a", "PFNp_b", "PFNp_c", "PFNp_d", "PFNp_e", "PFNv")
  Ins_pointPlts[[rois[r]]] <- ggplot(colNronInsByID %>% filter(roi == rois[r], type.to %in% types)) + 
    geom_point(aes(x=freq,y=totalInput), size = 2, alpha = 0.25) + 
    geom_point(data = colNronInsByID_mean %>% filter(roi == rois[r], type.to %in% types), aes(x = freq, y = meanSyns), size = 4, color = 'red', alpha=0.5) +
    facet_grid(rows=vars(type.to), scales = 'free_y') + 
    theme_minimal_grid() +
    ylab('total # of input synapses') + xlab('# of instances per glom') +
    ggtitle(rois[r])
}

```

Plot the mean of the total number of synapses per roi per number within a type normalized by the total counts for the minimum number of neurons per glom
```{r}
colNronInsByID_meanNorm_tmp <- by(colNronInsByID_mean,
                                   list(colNronInsByID_mean$roi,
                                        colNronInsByID_mean$type.to),
                                   function(x){as.data.frame(list(
                                     roi = x$roi,
                                     type.to = x$type.to,
                                     freq = x$freq,
                                     freq.norm = x$freq/min(x$freq),
                                     meanSyns = x$meanSyns,
                                     meanSyns.norm = x$meanSyns/filter(x,freq==min(x$freq))$meanSyns))})
colNronInsByID_meanNorm <- do.call(rbind,colNronInsByID_meanNorm_tmp)
```
```{r, fig.width=3, fig.height = 4}
colNronInsByID_meanNorm$supertype <- supertype(colNronInsByID_meanNorm$type.to)

x <- seq(from=1, to = 2, by = 0.1)
y1 <- 1
y2 <- 1/x
decayFn <- as.data.frame(list(x = x, y1 = y1, y2 = y2))

EBEtc_InPlt <- ggplot(colNronInsByID_meanNorm %>% filter(!(roi %in% c('PB','FB','NO')))) + 
  geom_point(aes(x=freq.norm, y = meanSyns.norm, 
                 color = as.factor(supertype)),
             size = 1, alpha = 0.5) +
  geom_line(data = decayFn, aes(x = x, y = y1), size=0.1) +
  geom_line(data = decayFn, aes(x = x, y = y2), size=0.1) +
  scale_color_manual(breaks = supertype2Palette()$breaks,
                      values = supertype2Palette()$pal) +
  facet_grid(rows = vars(roi)) +
  theme_paper() +
  coord_cartesian(xlim = c(1,2), ylim = c(0,1), expand = FALSE, clip ='off') +
  xlab('numerosity factor') + 
  ylab('normalized total synapse count') +
  ggtitle('inputs') +
  theme(plot.margin = margin(0.25,0.25,0.25,0.25,'cm'),
        panel.spacing = unit(0.5, "cm")) +
  scale_x_continuous(breaks = c(1,1.5,2)) +
  scale_y_continuous(breaks = c(0,0.5,1))
EBEtc_InPlt
```
```{r, fig.width=6, fig.height = 6}
x <- seq(from=1, to = 3.5, by = 0.1)
y1 <- 1
y2 <- 1/x
decayFn <- as.data.frame(list(x = x, y1 = y1, y2 = y2))

PBFBNO_InPlt <- ggplot(colNronInsByID_meanNorm %>% filter(roi %in% c('PB','FB','NO'))) + 
  geom_jitter(aes(x=freq.norm, y = meanSyns.norm, 
                 color = as.factor(supertype)),
             size = 1, alpha = 0.5, width = 0.05) +
  geom_line(data = decayFn, aes(x = x, y = y1), size=0.1) +
  geom_line(data = decayFn, aes(x = x, y = y2), size=0.1) +
  scale_color_manual(breaks = supertype2Palette()$breaks,
                      values = supertype2Palette()$pal) +
  facet_grid(rows = vars(roi)) +
  theme_paper() +
  coord_cartesian(xlim = c(1,3.5), ylim = c(0,2.5), expand = FALSE, clip ='off') +
  xlab('numerosity factor') + 
  ylab('normalized total synapse count') +
  ggtitle('inputs') +
  theme(plot.margin = margin(0.25,0.25,0.25,0.25,'cm'),
        panel.spacing = unit(0.5, "cm")) +
  scale_x_continuous(breaks = 1:12)
PBFBNO_InPlt
```

Plot just the EPG data
```{r, fig.width=4, fig.height = 6}
EPGOutDat <- colNronOutsByID %>% filter(roi != "FB", type.from == "EPG")
names(EPGOutDat)[names(EPGOutDat)=="type.from"] <- "type"
names(EPGOutDat)[names(EPGOutDat)=="totalOutput"] <- "totalSyns"
EPGOutDat$inOut <- "out"

EPGInDat <- colNronInsByID %>% filter(roi != "FB", type.to == "EPG")
names(EPGInDat)[names(EPGInDat)=="type.to"] <- "type"
names(EPGInDat)[names(EPGInDat)=="totalInput"] <- "totalSyns"
EPGInDat$inOut <- "in"

EPGDat <- rbind(EPGOutDat,EPGInDat)
EPGDat$roi <- factor(EPGDat$roi, levels = as.factor(c('EB','PB','LAL(R)')))                

EPG_barPlt <- ggplot(EPGDat) + geom_bar(aes(x=glom,y=totalSyns),stat='identity',position = 'stack',fill='black',color='white',size=0.2) +
  facet_grid(rows = vars(roi), cols = vars(inOut), scales = 'free') +
  theme_paper() + ylab('total # of synapses') +
  theme(plot.margin = margin(1,1,1,1,'cm'),
        axis.text.x = element_text(angle=90,hjust=1,vjust=0))
EPG_barPlt
```
```{r, fig.width=4, fig.height = 6}
EPGOutDat_mean <- colNronOutsByID_mean %>% filter(roi != "FB", type.from == "EPG")
names(EPGOutDat_mean)[names(EPGOutDat_mean)=="type.from"] <- "type"
EPGOutDat_mean$inOut <- "out"

EPGInDat_mean <- colNronInsByID_mean %>% filter(roi != "FB", type.to == "EPG")
names(EPGInDat_mean)[names(EPGInDat_mean)=="type.to"] <- "type"
EPGInDat_mean$inOut <- "in"

EPGDat_mean <- rbind(EPGOutDat_mean, EPGInDat_mean)
EPGDat_mean$roi <- factor(EPGDat_mean$roi, levels = as.factor(c('EB','PB','LAL(R)')))    

EPG_ptPlt <- ggplot(EPGDat) + 
  geom_jitter(aes(x=freq,y=totalSyns), size = 1, alpha = 0.25, width = 0.2) + 
  geom_point(data = EPGDat_mean, aes(x = freq, y = meanSyns, fill =as.factor('mean')), size = 4) +
  facet_grid(rows=vars(roi), cols=vars(inOut), scales = 'free_y') + 
  theme_paper() +
  ylab('total # of synapses') + xlab('# of instances per glom') +
  theme(plot.margin = margin(1,1,1,1,'cm')) +
  scale_x_continuous(breaks = 2:4) +
  coord_cartesian(clip = FALSE) +
  geom_vline(aes(xintercept=-Inf), size=0.1) +
  geom_hline(aes(yintercept=-Inf), size=0.1)
EPG_ptPlt
```



Combine the plots
```{r, fig.width=8, fig.height = 4}
design <- "
  112
"
EPGPlts <- EPG_barPlt + EPG_ptPlt +
  plot_layout(design = design) +
  plot_annotation(tag_levels='A')
EPGPlts
ggsave('synsPerGlom_EPG.pdf',EPGPlts,
       width=8, height=4)
```
```{r, fig.width=7, fig.height = 4}
design <- "
  122344
"
statPlts <- EBEtc_InPlt + PBFBNO_InPlt +
  EBPBEtc_OutPlt + FBNO_OutPlt +
  plot_layout(design = design, guides = 'collect') +
  plot_annotation(tag_levels='A')
statPlts
ggsave('synsPerGlom_stats.pdf',statPlts,
       width=7, height=3)
```

