---
title: "R Notebook"
output: html_notebook
---

Load the functions
```{r}
library(neuprintr)
library(tidyverse)
library(cowplot)
library(neuprintrExtra)
library(reshape2)
library(patchwork)
library(grid)
source(file.path("..","..","PBFigures","PBAnalysisUtils.R"))
source(file.path("..","..","PBFigures","old","PBAnalysisFunctions.R"))
source(file.path("..","..","R","visualizeConnectivityTables.R"))
source(file.path("..","..","R","paperTheme.R"))
```



```{r}
allGloms <- c("R9","R8","R7","R6","R5","R4","R3","R2","R1",
                "L1","L2","L3","L4","L5","L6","L7","L8","L9")
```


Get the columnar PB and D7 connections
```{r}
PBPropBag <- neuronBag(getTypesTable(c("EPG","EPGt","Delta7",
                                      "PEG","PEN_a(PEN1)","PEN_b(PEN2)",
                                      unique(neuprint_search("PF.*")$type))))
```

Include the EPGts?
```{r}
EPGtInc <- 1
```


Create a von Mises profile in the EPGs - in the EB
```{r, fig.width=2, fig.height=1}
gloms = c("R1","L8","R2","L7","R3","L6","R4","L5",
         "R5","L4","R6","L3","R7","L2","R8","L1")
actProfvM <- data.frame(act = vonMisesProf(),glom = gloms)
actProfvM$glom <- factor(actProfvM$glom, levels = gloms)
g_EPGact_in_EB <- ggplot(actProfvM) + geom_bar(aes(x = glom, weight = act)) + 
  theme_paper() + coord_cartesian(expand=FALSE) + xlab('PB glom') + ylab('normalized activity')
print(g_EPGact_in_EB)
```

Move the "bump" around the EB
```{r, fig.width = 3, fig.height = 3}
actProfAll <- actProfvM
actProfAll$peakGlom <- "R5"
actNow <- actProfvM$act
for (g in 2:length(gloms)){
  actNow <- c(tail(actNow, -1), head(actNow, 1))
  df <- data.frame(act = actNow, glom = gloms)
  df$peakGlom <- df[df$act == max(df$act),]$glom
  actProfAll <- rbind(actProfAll, df)
}
if (EPGtInc <- 1){
  for (p in 1:length(gloms)){
    actProfAll <- rbind(actProfAll, data.frame(glom = 'R9', peakGlom = gloms[p],
                                               act = actProfAll[which(actProfAll$peakGlom == gloms[p] & actProfAll$glom == 'L1'),]$act))
    actProfAll <- rbind(actProfAll, data.frame(glom = 'L9', peakGlom = gloms[p],
                                               act = actProfAll[which(actProfAll$peakGlom == gloms[p] & actProfAll$glom == 'R1'),]$act))
  }
  EPGtgloms <- c("L9",gloms,"R9")
}

actProfAll$peakGlom <- factor(actProfAll$peakGlom, levels = gloms)
actProfAll$glom <- factor(actProfAll$glom, levels = EPGtgloms)

EPGAct_around <- ggplot(actProfAll) + geom_tile(aes(x=glom,y=as.factor(peakGlom),fill=act)) +
  theme_paper() + coord_equal(ratio=1)
EPGAct_around
```

Get the EPG ids
```{r}
if (EPGtInc){
  EPGIDs <- PBRename(neuprint_search("EPG.*")$name, neuprint_search("EPG.*")$bodyid)
} else {
  EPGIDs <- PBRename(neuprint_search(".*PB08.*")$name, neuprint_search(".*PB08.*")$bodyid)
}
```

Look at how this activity is passed to the downstream neurons
```{r}
DSnrons <- c("EPG","PEG","PEN_a(PEN1)","PEN_b(PEN2)",
             sort(unique(neuprint_search("PF.*")$type)))
```

Directly from the EPGs
```{r}
EPGToDSDat <- list()
for (ds in 2:length(DSnrons)){
  # Get the connection table
  if (EPGtInc){
    connTab <- PBPropBag$inputs_raw %>% filter(roi == "PB", type.from %in% c("EPG","EPGt"), type.to == DSnrons[ds])
  } else {
    connTab <- PBPropBag$inputs_raw %>% filter(roi == "PB", type.from == "EPG", type.to == DSnrons[ds])
  }
  if (nrow(connTab) == 0)
    next
  connTab$nameOrder.to <- PBRename(connTab$name.to, connTab$to)
  connTab$nameOrder.from <- PBRename(connTab$name.from, connTab$from)
  
  # Get the ids for the current downstream type
  DSIDs <- PBRename(neuprint_search(paste(str_split(DSnrons[ds],'\\(')[[1]][1],".*",sep=''))$name, 
                    neuprint_search(paste(str_split(DSnrons[ds],'\\(')[[1]][1],".*",sep=''))$bodyid)
  connTab$nameOrder.to <- factor(connTab$nameOrder.to, levels = DSIDs)
  connTab$nameOrder.from <- factor(connTab$nameOrder.from, levels = EPGIDs)
  
  # Convert to a weight matrix
  WM <- WMFromConTab(connTab, EPGIDs, DSIDs)
  
  # Find the output activity
  EPGAct <-  numeric(length(EPGIDs))
  for (g in 1:length(gloms)){
    actProfNow <- actProfAll %>% filter(peakGlom == gloms[g])
    for (EPG in 1:length(EPGIDs)){
      EPGAct[EPG] <- actProfNow[which(actProfNow$glom == sub('.*_(R[1-9]|L[1-9]).*','\\1',EPGIDs[EPG])),]$act
    }
    DSAct <- EPGAct %*% WM
    DSActNow <- data.frame(name = DSIDs, act = t(DSAct), peakGlom = gloms[g])
    if (g == 1)
      DSActAll <- DSActNow
    else
      DSActAll <- rbind(DSActAll, DSActNow)
  }
  DSActAll$peakGlom <- factor(DSActAll$peakGlom, levels = gloms)
  
  # Store the data
  EPGToDSDat[[DSnrons[ds]]] <- DSActAll
}
```

From the EPGs to the D7s

Get the D7 ids
```{r}
D7IDs <- PBRename(neuprint_search(".*PB15.*")$name, neuprint_search(".*PB15.*")$bodyid)
```

Get the EPG to D7 weight matrix
```{r}
# Get the connection table
if (EPGtInc){
  connTab <- PBPropBag$inputs_raw %>% filter(roi == "PB", type.from %in% c("EPG","EPGt"), type.to == "Delta7")
} else {
  connTab <- PBPropBag$inputs_raw %>% filter(roi == "PB", type.from == "EPG", type.to == "Delta7")
}
connTab$nameOrder.to <- PBRename(connTab$name.to, connTab$to)
connTab$nameOrder.to <- factor(connTab$nameOrder.to, levels = D7IDs)
connTab$nameOrder.from <- PBRename(connTab$name.from, connTab$from)

# Convert to a weight matrix
WM_EPGToD7 <- WMFromConTab(connTab, EPGIDs, D7IDs)
```

```{r}

EPGToD7ToDSDat <- list()
for (ds in 1:length(DSnrons)){
  # Get the connection table
  connTab <- PBPropBag$inputs_raw %>% filter(roi == "PB", type.from == "Delta7", type.to == DSnrons[ds])
  if (nrow(connTab) == 0)
    next
  connTab$nameOrder.to <- PBRename(connTab$name.to, connTab$to)
  connTab$nameOrder.from <- PBRename(connTab$name.from, connTab$from)
  
  # Get the ids for the current downstream type
  DSIDs <- PBRename(neuprint_search(paste(str_split(DSnrons[ds],'\\(')[[1]][1],".*",sep=''))$name, 
                    neuprint_search(paste(str_split(DSnrons[ds],'\\(')[[1]][1],".*",sep=''))$bodyid)
  DSIDs <- factor(DSIDs[!grepl('EPGt',DSIDs)], levels=levels(DSIDs)[!grepl('EPGt',levels(DSIDs))])
  connTab$nameOrder.to <- factor(connTab$nameOrder.to, levels = DSIDs)
  connTab$nameOrder.from <- factor(connTab$nameOrder.from, levels = D7IDs)
  
  # Convert to a weight matrix
  WM <- WMFromConTab(connTab, D7IDs, DSIDs)
  
  # Find the output activity
  EPGAct <-  numeric(length(EPGIDs))
  for (g in 1:length(gloms)){
    actProfNow <- actProfAll %>% filter(peakGlom == gloms[g])
    for (EPG in 1:length(EPGIDs)){
      EPGAct[EPG] <- actProfNow[which(actProfNow$glom == sub('.*_(R[1-9]|L[1-9]).*','\\1',EPGIDs[EPG])),]$act
    }
    DSAct <- EPGAct %*% WM_EPGToD7 %*% WM
    DSActNow <- data.frame(name = DSIDs, act = t(DSAct), peakGlom = gloms[g])
    if (g == 1)
      DSActAll <- DSActNow
    else
      DSActAll <- rbind(DSActAll, DSActNow)
  }
  DSActAll$peakGlom <- factor(DSActAll$peakGlom, levels = gloms)
  
  # Store the data
  EPGToD7ToDSDat[[DSnrons[ds]]] <- DSActAll
}
```

Align the peaks
The original EB bump
```{r, fig.width = 4, fig.height = 3}
for (g in 1:length(gloms)){
  DatNow <- actProfAll %>% filter(peakGlom == gloms[g])
  for (EPG in 1:length(EPGIDs))
    EPGAct[EPG] <- DatNow[which(DatNow$glom == sub('.*_(R[1-9]|L[1-9]).*','\\1',EPGIDs[EPG])),]$act
  EPGDF <- data.frame(act = EPGAct, name = EPGIDs, peakGlom = gloms[g])
  if (g == 1)
    EPGDat <- EPGDF
  else
    EPGDat <- rbind(EPGDat, EPGDF)
}

BumpToAlign <- list()
BumpToAlign[["EPG"]] <- EPGDat
alignedEPGBump <- alignBumps(c("EPG"), BumpToAlign, 3)

rawPlt_EPGBump <- ggplot(alignedEPGBump[["EPG"]]) + geom_tile(aes(x=glom,y=as.factor(peakGlom),fill=meanAct)) + 
  theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=0, vjust =1))
alignPlt_EPGBump <- ggplot(alignedEPGBump[["EPG"]]) + geom_tile(aes(x=glom,y=as.factor(peakGlom),fill=alignAct)) + 
  theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=0, vjust =1))
EPGBumpPlt <- rawPlt_EPGBump + alignPlt_EPGBump + plot_layout(guides = 'collect')
print(EPGBumpPlt)
ggsave("EPGBump_Aligned.pdf",EPGBumpPlt,
       width=4, height = 2)
```

Plot the EPG bump in the EB and in the PB
```{r}
# Split the data by right and left
EPGBump_R <- alignedEPGBump[["EPG"]] %>% filter(grepl("R",peakGlom))
EPGBump_L <- alignedEPGBump[["EPG"]] %>% filter(grepl("L",peakGlom))

# Find the R and L mean shape
EPGBump_R_stats <- EPGBump_R %>% group_by(glom) %>% summarize(mean = mean(alignAct))
EPGBump_L_stats <- EPGBump_L %>% group_by(glom) %>% summarize(mean = mean(alignAct))
```
```{r}
# Sort the EPG glomeruli by their order in the EB
if (EPGtInc){
  EPGBump_R_stats$glom <- factor(EPGBump_R_stats$glom, levels = EPGtgloms)
  EPGBump_L_stats$glom <- factor(EPGBump_L_stats$glom, levels = EPGtgloms)
} else {
  EPGBump_R_stats$glom <- factor(EPGBump_R_stats$glom, levels = gloms)
  EPGBump_L_stats$glom <- factor(EPGBump_L_stats$glom, levels = gloms)
}


BumpProf_EB <- ggplot() + geom_line(data = EPGBump_R_stats, aes(x=glom,y=mean,group=1, color='R profile')) +
  geom_line(data = EPGBump_L_stats, aes(x=glom,y=mean,group=1, color='L profile')) +
  theme_paper() + scale_color_manual(values = c('R profile' = 'royalblue',
                                                'L profile' = 'tan1')) +
  ggtitle('EPG neurons')
```
```{r}
# Sort the EPG glomeruli by their order in the PB
EPGBump_R_stats$glom <- factor(EPGBump_R_stats$glom, levels = allGloms)
EPGBump_L_stats$glom <- factor(EPGBump_L_stats$glom, levels = allGloms)

BumpProf_PB_R_fromR <- ggplot(filter(EPGBump_R_stats, grepl("R",glom))) + 
  geom_line(aes(x=glom,y=mean,group=1), color='royalblue') +
  theme_paper() +
  scale_x_discrete(breaks = allGloms,
                   limits = allGloms[which(grepl("R",allGloms))])

BumpProf_PB_R_fromL <- ggplot(filter(EPGBump_L_stats, grepl("R",glom))) + 
  geom_line(aes(x=glom,y=mean,group=1), color = 'tan1') +
  theme_paper() +
  scale_x_discrete(breaks = allGloms,
                   limits = allGloms[which(grepl("R",allGloms))])

BumpProf_PB_L_fromR <- ggplot(filter(EPGBump_R_stats, grepl("L",glom))) + 
  geom_line(aes(x=glom,y=mean,group=1), color = 'royalblue') +
  theme_paper() +
  scale_x_discrete(breaks = allGloms,
                   limits = allGloms[which(grepl("L",allGloms))])

BumpProf_PB_L_fromL <- ggplot(filter(EPGBump_L_stats, grepl("L",glom))) + 
  geom_line(aes(x=glom,y=mean,group=1), color = 'tan1') +
  theme_paper() +
  scale_x_discrete(breaks = allGloms,
                   limits = allGloms[which(grepl("L",allGloms))])
```

```{r, fig.width = 6, fig.height = 3}
design <- "
  1223
  4455
  6677
"

BumpProf_EPGs <- plot_spacer() + BumpProf_EB + plot_spacer() + 
  BumpProf_PB_L_fromR + BumpProf_PB_L_fromL + 
  BumpProf_PB_R_fromR + BumpProf_PB_R_fromL + 
  plot_layout(design = design, guides = 'collect')
BumpProf_EPGs
```

Create a summary EPG bump figure 
```{r}
design <- "
  12
  33
  33
"
EPGBumpSummary <- EPGBumpPlt + BumpProf_EPGs + plot_layout(design = design)
ggsave("EPGBumpSummary.pdf", EPGBumpSummary,
       width = 8, height = 10)
```



The PFN bumps
```{r}
PFNs <- DSnrons[which(grepl('PFN',DSnrons))]
```
```{r}
alignedEPGToPFNs <- alignBumps(PFNs, EPGToDSDat, 2)
```
```{r}
alignedEPGToD7ToPFNs <- alignBumps(PFNs, EPGToD7ToDSDat, 2)
```
```{r, fig.width = 10, fig.height = 8}
PFNInPlts <- alignedPlts(PFNs, alignedEPGToPFNs, alignedEPGToD7ToPFNs)
PFNInPlts
ggsave("PFNBumps.pdf", PFNInPlts,
       width = 10, height = 8)
```
```{r}
alignedPFNStats <- alignedStats(PFNs, alignedEPGToPFNs, alignedEPGToD7ToPFNs)
```
```{r, fig.width = 10, fig.height = 8}
allPlts <- list()
for (p in 1:length(PFNs)){
  plt <- inputComp(alignedPFNStats[[PFNs[p]]], PFNs[p])
  
  allPlts[[p]] <- plt
}
print(patchwork::wrap_plots(allPlts,nrow =3, ncol = 4) + plot_layout(guides = 'collect'))
```
```{r}
gloms_PFN <- c('L9','L8','L7','L6','L5','L4','L3','L2',
               'R2','R3','R4','R5','R6','R7','R8','R9')
angs <- seq(from = -pi, to = pi, length.out = 9)
glomToAngMap_PFNs <- data.frame(glom = gloms_PFN, ang = c(angs[2:9],angs[1:8]))
```
```{r}
for (p in 1:length(PFNs)){
  alignedPFNStats[[PFNs[p]]] <- alignedPFNStats[[PFNs[p]]] %>% filter(!is.na(glom))
  alignedPFNStats[[PFNs[p]]]$ang <- alignedPFNStats[[PFNs[p]]]$glom %>% 
    lapply(function(x) glomToAngMap_PFNs[which(glomToAngMap_PFNs$glom == x),]$ang) %>% unlist()
}
```
```{r, fig.width = 10, fig.height = 8}
allPlts <- list()
for (p in 1:length(PFNs)){
  plt <- inputCompAngs(alignedPFNStats[[PFNs[p]]], PFNs[p], "D7")
  
  allPlts[[p]] <- plt
}
print(patchwork::wrap_plots(allPlts,nrow =3, ncol = 4) + plot_layout(guides = 'collect'))
```
```{r, fig.width = 4, fig.height = 3}
inptTps <- c("EPG","D7")

for (i in 1:length(inptTps)){
  for (p in 1:length(PFNs)){
    if (nrow(alignedPFNStats[[PFNs[p]]] %>% filter(inpt == inptTps[i])) == 0)
      next
    phaseDiffs <- phaseDiffCalc(alignedPFNStats[[PFNs[p]]], inptTps[i])
    phaseDiffs$type <- PFNs[p]
    phaseDiffs$input <- inptTps[i]
    
    if (p == 1 & i == 1){
      allPhaseDiffs <- phaseDiffs
    } else{
      allPhaseDiffs <- rbind(allPhaseDiffs,phaseDiffs)
    }
  }
}

diffPlt <- ggplot(allPhaseDiffs) + geom_point(aes(x = as.factor(type), y = diff, color = RL), size = 2, alpha = 0.5) +
  facet_grid(rows = vars(input)) +
  scale_color_manual(values = c('R' = 'royalblue', 'L' = 'tan1')) +
  theme_paper() + theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(limits = c(0,pi), breaks = seq(from = 0, to = pi, by = pi/4), label = c('0','p/4','p/2','3p/4','p')) +
  geom_hline(yintercept = (pi/2 + pi/8)) +
  geom_hline(yintercept = pi/2) +
  xlab('type') +
  ylab('phase offset between R and L PB bumps')
diffPlt
```
```{r}
PFNAngMap <- ggplot(glomToAngMap_PFNs) + geom_point(aes(x = glom, y = ang), size = 2) + 
  scale_y_continuous(limits = c(-pi,pi), breaks = seq(from = -pi, to = pi, by = pi/4), 
                     label = c('-p','-3p/4','-p/2','-p/4','0','p/4','p/2','3p/4','p')) +
  theme_paper()
```
```{r}
design <- "
  12
"
PFNPhaseAnalysis <- PFNAngMap + diffPlt + plot_layout(design = design)
ggsave("PFNPhaseAnalysis.pdf",PFNPhaseAnalysis,
       width = 6, height = 3)
```



The PFL bumps
```{r}
PFLs <- DSnrons[which(grepl('PFL',DSnrons))]
```
```{r}
alignedEPGToPFLs <- alignBumps(PFLs, EPGToDSDat,2)
```
```{r}
alignedEPGToD7ToPFLs <- alignBumps(PFLs, EPGToD7ToDSDat, 2)
```
```{r}
for (p in 1:length(PFLs)){

  rawPlt_EPG <- ggplot(alignedEPGToPFLs[[PFLs[p]]]) + geom_tile(aes(x=glom,y=as.factor(peakGlom),fill=meanAct)) + 
    theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=0, vjust =1)) + ggtitle(PFLs[p])
  
  rawPlt_D7 <- ggplot(alignedEPGToD7ToPFLs[[PFLs[p]]]) + geom_tile(aes(x=glom,y=as.factor(peakGlom),fill=meanAct)) + 
    theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=0, vjust =1)) + ggtitle(PFLs[p])
  
  if (p == 1){
    EPGInPlts <- rawPlt_EPG + plot_layout(guides = 'collect')
    D7InPlts <- rawPlt_D7 + plot_layout(guides = 'collect')
  } else{
    EPGInPlts <- EPGInPlts | rawPlt_EPG + plot_layout(guides = 'collect')
    D7InPlts <- D7InPlts | rawPlt_D7 + plot_layout(guides = 'collect')
  }
    
}
PFLCombPts <- EPGInPlts / D7InPlts
ggsave("PFLInputs.pdf",PFLCombPts,
       width=10, height = 8)
PFLCombPts
```
Assign angles to the columns
```{r}
# Create a general column to angle map
cols <- c("C1","C2","C3","C4","C5","C6","C7","C8","C9")
angs <- seq(from = -pi, to= pi, length.out = 9)
colAngMap <- data.frame(col = cols, ang = angs)
```

Plot the activity - by glom and col
Specify the glomerulus and column order
```{r}
glomColLevels <- list()
glomColLevels[['PFL1']] <- c('R7,C1','R1,C2','R6,C3','R5,C4','R4,C5','R3,C6','R2,C7',
                           'L2,C3','L3,C4','L4,C5','L5,C6','L6,C7','L1,C8','L7,C9')
glomColLevels[['PFL2']] <- c('R5,C1','R4,C2','R3,C3','R2,C4','R1,C4','L1,C5','L2,C6','L3,C7','L4,C8','L5,C9')
glomColLevels[['PFL3']] <- c('R7,C1','R6,C2','R5,C3','R4,C4','R3,C5','R2,C6','R1,C7','L1,C8','L2,C9',
                           'R2,C1','R1,C2','L1,C3','L2,C4','L3,C5','L4,C6','L5,C7','L6,C8','L7,C9')
```

Plot the mean data sorted by the above levels
```{r}
allDat_sum <- list()
for (p in 1:length(PFLs)){
  
  DatNow_EPG <- EPGToDSDat[[PFLs[p]]]
  DatNow_EPG$glom <- DatNow_EPG$name %>% lapply(function(x) sub('.*_(L[1-9]|R[1-9]).*','\\1',x)) %>% unlist()
  DatNow_EPG$col <- DatNow_EPG$name %>% lapply(function(x) sub('.*_(C[1-9]).*','\\1',x)) %>% unlist()
  DatNow_EPG$glomCol <- as.factor(paste(DatNow_EPG$glom, DatNow_EPG$col, sep = ','))
  DatNow_EPG_sum <- DatNow_EPG %>% group_by(glomCol, peakGlom) %>% summarise(meanAct = mean(act), totAct = sum(act))
  DatNow_EPG_sum$glomCol <- factor(DatNow_EPG_sum$glomCol, levels = glomColLevels[[PFLs[p]]])
  DatNow_EPG_sum$inSrc <- "EPG"
  
  
  DatNow_D7 <- EPGToD7ToDSDat[[PFLs[p]]]
  DatNow_D7$glom <- DatNow_D7$name %>% lapply(function(x) sub('.*_(L[1-9]|R[1-9]).*','\\1',x)) %>% unlist()
  DatNow_D7$col <- DatNow_D7$name %>% lapply(function(x) sub('.*_(C[1-9]).*','\\1',x)) %>% unlist()
  DatNow_D7$glomCol <- as.factor(paste(DatNow_D7$glom, DatNow_D7$col, sep = ','))
  DatNow_D7_sum <- DatNow_D7 %>% group_by(glomCol, peakGlom) %>% summarise(meanAct = mean(act), totAct = sum(act))
  DatNow_D7_sum$glomCol <- factor(DatNow_D7_sum$glomCol, levels = glomColLevels[[PFLs[p]]])
  DatNow_D7_sum$inSrc <- "D7"
  
  DatNow_sum <- rbind(DatNow_EPG_sum, DatNow_D7_sum)
  DatNow_sum$peakGlom <- factor(DatNow_sum$peakGlom, levels = allGloms)
  allDat_sum[[PFLs[p]]] <- DatNow_sum

  rawPlt_EPG <- ggplot(DatNow_sum %>% filter(inSrc == "EPG")) + geom_tile(aes(x=glomCol,y=as.factor(peakGlom),fill=meanAct)) + 
    theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0)) + ggtitle(PFLs[p])
  rawPlt_D7 <- ggplot(DatNow_sum %>% filter(inSrc == "D7")) + geom_tile(aes(x=glomCol,y=as.factor(peakGlom),fill=meanAct)) + 
    theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0)) + ggtitle(PFLs[p])
  
  if (p == 1){
    EPGInPlts <- rawPlt_EPG + plot_layout(guides = 'collect')
    D7InPlts <- rawPlt_D7 + plot_layout(guides = 'collect')
  } else{
    EPGInPlts <- EPGInPlts | rawPlt_EPG + plot_layout(guides = 'collect')
    D7InPlts <- D7InPlts | rawPlt_D7 + plot_layout(guides = 'collect')
  }
    
}
PFL2Gloms <- c('R5','R4','R3','R2','R1','L1','L2','L3','L4','L5')
PFL3Gloms <- c('R7','R6','R5','R4','R3','R2','R1','L1','L2','L3','L4','L5','L6','L7')
rawPlt_EPGBump_PFL2 <- ggplot(alignedEPGBump[["EPG"]] %>% filter(glom %in% PFL2Gloms)) + geom_tile(aes(x=glom,y=as.factor(peakGlom),fill=meanAct)) + 
  theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=1, vjust =0)) + ggtitle('EPG activity (gloms R5-L5)')
rawPlt_EPGBump_PFL3 <- ggplot(alignedEPGBump[["EPG"]] %>% filter(glom %in% PFL3Gloms)) + geom_tile(aes(x=glom,y=as.factor(peakGlom),fill=meanAct)) + 
  theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=1, vjust =0)) + ggtitle('EPG activity (gloms R7-L7)')

PFLCombPts <- (rawPlt_EPGBump_PFL2 + rawPlt_EPGBump_PFL3) / EPGInPlts / D7InPlts
PFLCombPts
ggsave("PFLInputs.pdf",PFLCombPts,
       width = 8, height = 10)
```
Register the bumps
EPG input to the PFL3s
```{r}
RSide <- c('R7,C1','R6,C2','R5,C3','R4,C4','R3,C5','R2,C6','R1,C7','L1,C8','L2,C9')
LSide <- c('R2,C1','R1,C2','L1,C3','L2,C4','L3,C5','L4,C6','L5,C7','L6,C8','L7,C9')
```
```{r}
# Get the relevant data
#DatNow <- EPGToDSDat[['PFL3']]
DatNow <- EPGToD7ToDSDat[['PFL3']]
```

```{r}
# Find the average activity per glomerulus column pair
DatNow$glom <- DatNow$name %>% lapply(function(x) sub('.*_(L[1-9]|R[1-9]).*','\\1',x)) %>% unlist()
DatNow$col <- DatNow$name %>% lapply(function(x) sub('.*_(C[1-9]).*','\\1',x)) %>% unlist()
DatNow$glomCol <- as.factor(paste(DatNow$glom, DatNow$col, sep = ','))

# Find the mean of the data
DatNow_byGlomCol <- DatNow %>% group_by(glomCol, col, peakGlom) %>% summarize(meanAct = mean(act))
```
```{r}

gloms_PBSort <- c("R8","R7","R6","R5","R4","R3","R2","R1",
                  "L1","L2","L3","L4","L5","L6","L7","L8")

# Shift the activity
for (g in 1:length(gloms_PBSort)){
  
  # Split right and left
  RActDat <- DatNow_byGlomCol %>% filter(peakGlom == gloms_PBSort[g], glomCol %in% RSide)
  RActDat$glomCol <- factor(RActDat$glomCol, levels = RSide)
  RActDat <- RActDat[order(RActDat$glomCol),]
  RActDat$alignAct <- 0
  LActDat <- DatNow_byGlomCol %>% filter(peakGlom == gloms_PBSort[g], glomCol %in% LSide)
  LActDat$glomCol <- factor(LActDat$glomCol, levels = LSide)
  LActDat <- LActDat[order(LActDat$glomCol),]
  LActDat$alignAct <- 0
  
  # Shift the 
  RAct <- RActDat$meanAct
  LAct <- LActDat$meanAct
  if (g < 9){
    RAct <- c(tail(RAct, -g), head(RAct, g))
    LAct <- c(tail(LAct, -g), head(LAct, g))
  } else {
    RAct <- c(tail(RAct, -(g-8)), head(RAct, (g-8)))
    LAct <- c(tail(LAct, -(g-8)), head(LAct, (g-8)))
  }
  
  # Put the shifted values back in the array
  RActDat$alignAct <- RAct
  LActDat$alignAct <- LAct
  
  shiftDat <- rbind(RActDat,LActDat)
  
  if (g == 1)
    alignedDat <- shiftDat
  else
    alignedDat <- rbind(alignedDat, shiftDat)
}

alignedDat$glomCol <- factor(alignedDat$glomCol,levels=c(RSide, LSide)) 
alignedDat$peakGlom <- factor(alignedDat$peakGlom,levels=allGloms)

ggplot(alignedDat) + geom_tile(aes(x=glomCol, y = peakGlom, fill = alignAct)) + theme(axis.text.x = element_text(angle = 90))
```
```{r}
alignedDat$ang <- alignedDat$col %>% lapply(function(x) colAngMap[which(colAngMap$col == x),]$ang) %>% unlist()
alignedDat_sum <- alignedDat %>% group_by(glomCol, ang) %>% summarize(mean = mean(alignAct), sd = sd(alignAct))

alignedDat_sum[which(alignedDat_sum$glomCol %in% RSide),]$mean <- meanNorm(alignedDat_sum[which(alignedDat_sum$glomCol %in% RSide),]$mean)
alignedDat_sum[which(alignedDat_sum$glomCol %in% LSide),]$mean <- meanNorm(alignedDat_sum[which(alignedDat_sum$glomCol %in% LSide),]$mean)

PFL3MeanPlt <- ggplot() + geom_line(data = alignedDat_sum %>% filter(glomCol %in% RSide), aes(x = ang, y = mean, color = 'R PFL3 activity')) +
  geom_line(data = alignedDat_sum %>% filter(glomCol %in% LSide), aes(x = ang, y = mean, color = 'L PFL3 activity'))

```

```{r}
RcosFit <- cosFit(alignedDat_sum %>% filter(glomCol %in% RSide))
LcosFit <- cosFit(alignedDat_sum %>% filter(glomCol %in% LSide))
cosAngs <- seq(from = -pi, to = pi, by = pi/16)
RcosVals <- coef(RcosFit)['C1'] * cos(cosAngs - coef(RcosFit)['theta'])+coef(RcosFit)['C2']
LcosVals <- coef(LcosFit)['C1'] * cos(cosAngs - coef(LcosFit)['theta'])+coef(LcosFit)['C2']
cosPlt <- data.frame(ang = cosAngs, RVal = RcosVals, LVal = LcosVals)

PFL3MeanPlt_D7 <- PFL3MeanPlt + geom_line(data = cosPlt, aes(x = ang, y = RVal, color = 'R cos fit'), linetype = 2) + 
  geom_line(data = cosPlt, aes(x = ang, y = LVal, color = 'L cos fit'), linetype = 2) +
  scale_color_manual(values = c('R PFL3 activity' = 'royalblue',
                                'L PFL3 activity' = 'tan1',
                                'R cos fit' = 'royalblue',
                                'L cos fit' = 'tan1')) +
  theme_paper() +
  annotate(geom="text", x=0, y=0.9, 
           label=paste('offset = ', as.character(2*pi+(coef(LcosFit)['theta'] - coef(RcosFit)['theta'])), sep = ''),
              color="black", size = 2) +
   scale_x_continuous(limits = c(-pi,pi), breaks = seq(from = -pi, to = pi, by = pi/4), 
                     label = c('-p','-3p/4','-p/2','-p/4','0','p/4','p/2','3p/4','p'))

PFL3MeanPlt_D7
```

```{r}
RvMFit <- vMFit(alignedDat_sum %>% filter(glomCol %in% RSide))
LvMFit <- vMFit(alignedDat_sum %>% filter(glomCol %in% LSide))
vMAngs <- seq(from = -pi, to = pi, by = pi/16)
RvMVals <- coef(RvMFit)['C1'] * exp(coef(RvMFit)['k']*cos(vMAngs - coef(RvMFit)['theta']))/(2*pi*besselI(coef(RvMFit)['k'],0)) 
LvMVals <- coef(LvMFit)['C1'] * exp(coef(LvMFit)['k']*cos(vMAngs - coef(LvMFit)['theta']))/(2*pi*besselI(coef(LvMFit)['k'],0))
vMPlt <- data.frame(ang = vMAngs, RVal = RvMVals, LVal = LvMVals)

PFL3MeanPlt_EPG <- PFL3MeanPlt + geom_line(data = vMPlt, aes(x = ang, y = RVal, color = 'R vonMises fit'), linetype = 2) + 
  geom_line(data = vMPlt, aes(x = ang, y = LVal, color = 'L vonMises fit'), linetype = 2) +
  scale_color_manual(values = c('R PFL3 activity' = 'royalblue',
                                'L PFL3 activity' = 'tan1',
                                'R vonMises fit' = 'royalblue',
                                'L vonMises fit' = 'tan1')) +
  theme_paper() +
  annotate(geom="text", x=0, y=0.9, 
           label=paste('offset = ', as.character(2*pi+(coef(LvMFit)['theta'] - coef(RvMFit)['theta'])), sep = ''),
              color="black", size = 2) +
   scale_x_continuous(limits = c(-pi,pi), breaks = seq(from = -pi, to = pi, by = pi/4), 
                     label = c('-p','-3p/4','-p/2','-p/4','0','p/4','p/2','3p/4','p'))

PFL3MeanPlt_EPG
```
```{r}
PFL3MeanPlts <- PFL3MeanPlt_EPG / PFL3MeanPlt_D7
ggsave('PFL3MeanPlts.pdf',PFL3MeanPlts,
       width = 4, height = 4)
```



PFG/PFR_a analysis
```{r}
PFOs <- c("PFR_a","PFGs")
```
```{r}
alignedEPGToPFOs <- alignBumps(PFOs, EPGToDSDat,2)
```
```{r}
alignedEPGToD7ToPFOs <- alignBumps(PFOs, EPGToD7ToDSDat, 2)
```
```{r}
for (p in 1:length(PFOs)){

  rawPlt_EPG <- ggplot(alignedEPGToPFOs[[PFOs[p]]]) + geom_tile(aes(x=glom,y=as.factor(peakGlom),fill=meanAct)) + 
    theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=0, vjust =1)) + ggtitle(PFOs[p])
  
  align_EPG <- ggplot(alignedEPGToPFOs[[PFOs[p]]]) + geom_tile(aes(x=glom,y=as.factor(peakGlom),fill=alignAct)) + 
    theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=0, vjust =1)) + ggtitle(PFOs[p])
  
  rawPlt_D7 <- ggplot(alignedEPGToD7ToPFOs[[PFOs[p]]]) + geom_tile(aes(x=glom,y=as.factor(peakGlom),fill=meanAct)) + 
    theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=0, vjust =1)) + ggtitle(PFOs[p])
  
  align_D7 <- ggplot(alignedEPGToD7ToPFOs[[PFOs[p]]]) + geom_tile(aes(x=glom,y=as.factor(peakGlom),fill=alignAct)) + 
    theme_paper() + coord_equal(ratio=1) + theme(axis.text.x = element_text(angle = 90, hjust=0, vjust =1)) + ggtitle(PFOs[p])
  
  if (p == 1){
    EPGInPlts <- (rawPlt_EPG + align_EPG) + plot_layout(guides = 'collect')
    D7InPlts <- (rawPlt_D7 + align_D7) + plot_layout(guides = 'collect')
  } else{
    EPGInPlts <- EPGInPlts | (rawPlt_EPG + align_EPG) + plot_layout(guides = 'collect')
    D7InPlts <- D7InPlts | (rawPlt_D7 + align_D7) + plot_layout(guides = 'collect')
  }
    
}
PFOCombPts <- EPGInPlts / D7InPlts
ggsave("PFOInputs.pdf",PFOCombPts,
       width=10, height = 8)
PFOCombPts
```
```{r}
gloms_PFO <- c('L9','L8','L7','L6','L5','L4','L3','L2','L1',
               'R1','R2','R3','R4','R5','R6','R7','R8','R9')
angs <- seq(from = -pi, to = pi, length.out = 9)
angs[9] <- angs[1]
glomToAngMap_PFOs <- data.frame(glom = gloms_PFO, ang = c(angs[1:8],angs[1],angs[9],angs[2:9]))
```
```{r}
alignedPFOStats <- alignedStats(PFOs, alignedEPGToPFOs, alignedEPGToD7ToPFOs)
```
```{r}
for (p in 1:length(PFOs)){
  alignedPFOStats[[PFOs[p]]]$ang <- alignedPFOStats[[PFOs[p]]]$glom %>% 
    lapply(function(x) glomToAngMap_PFOs[which(glomToAngMap_PFOs$glom == x),]$ang) %>% unlist()
}
```
```{r, fig.width = 10, fig.height = 8}
allPlts <- list()
for (p in 1:length(PFOs)){
  plt <- inputCompAngs(alignedPFOStats[[PFOs[p]]], PFOs[p], "EPG")
  allPlts[[p]] <- plt
  plt <- inputCompAngs(alignedPFOStats[[PFOs[p]]], PFOs[p], "D7")
  allPlts[[p+2]] <- plt
}

PFOMeanPlts <-patchwork::wrap_plots(allPlts,nrow =2, ncol = 2) + plot_layout(guides = 'collect')
ggsave('PFOMeanPlts.pdf',PFOMeanPlts,
       width = 10, height = 4)
```