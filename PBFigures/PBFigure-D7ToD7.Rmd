---
title: "PB - D7 analysis"
output: html_notebook
---

Load the libraries
```{r}
library(neuprintr)
library(neuprintrExtra)
library(tidyverse)
library(cowplot)
library(reshape2)
library(igraph)
library(ggraph)
library(paletteer)
library(patchwork)
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\R\\paperTheme.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\EBFigures\\EBUtils.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\PBAnalysisUtils.R")
```

Pull the D7 neuron bag
```{r}
D7Bag <- neuronBag(getTypesTable("Delta7"))
```

Plot the D7 to D7 connections
```{r}
D7ToD7 <- D7Bag$outputs_raw %>% filter(type.to == "Delta7", roi=="PB")
D7ToD7$id.from <- EBGlomOrder(D7ToD7$name.from,D7ToD7$from,"PB")
D7ToD7$id.to <- EBGlomOrder(D7ToD7$name.to,D7ToD7$to,"PB")

D7ToD7_Plt <- ggplot(D7ToD7) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(D7ToD7$ROIweight),
                       limits=c(0,max(D7ToD7$ROIweight))) +
  geom_tile(aes(id.to,id.from,fill=ROIweight)) +
  theme_paper() + 
  theme(axis.text.x = element_text(angle=90)) +
  xlab("postsynaptic neuron") + ylab("presynaptic neuron") +
  coord_equal(ratio=1)

D7ToD7_Plt_rescale <- ggplot(D7ToD7) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =15,
                       limits=c(0,30)) +
  geom_tile(aes(id.to,id.from,fill=ROIweight)) +
  theme_paper() + 
  theme(axis.text.x = element_text(angle=90)) +
  xlab("postsynaptic neuron") + ylab("presynaptic neuron") +
  coord_equal(ratio=1)

print(D7ToD7_Plt + D7ToD7_Plt_rescale)
```

Convert to a weight matrix and shift the rows to align them
```{r}
D7ToD7WM <- WMFromConTab(D7ToD7, levels(D7ToD7$id.from), levels(D7ToD7$id.to))

D7ToD7WM_shift <- matrix(0L,nrow=length(levels(D7ToD7$id.from)),ncol=length(levels(D7ToD7$id.to))) 
for (s in 1:length(levels(D7ToD7$id.from))){
  wNow <- D7ToD7WM[s,]
  shift <- s
  wNow <- c(tail(wNow, -shift), head(wNow, shift))
  
  # Fit a gaussian to the peak
  pts = c(1:length(wNow)-1)
  df = data.frame(pts = pts, wNow = wNow)
  fit <- nls(wNow ~ (C1 * exp(-(pts-mean1)**2/(2 * sigma1**2))), data=df,
    start=list(C1=20, mean1=15, sigma1=5), algorithm="port") 
  dffit <- data.frame(pts)
  dffit$wNow <- predict(fit, newdata=dffit)
  
  # Align the center of the higher amplitude Gaussian to the same position
  shift = coef(fit)['mean1'] %>% as.numeric() + 20
  
  if (shift == 0)
    wNow
  else
    wNow <- c(tail(wNow, -shift), head(wNow, shift))
  D7ToD7WM_shift[s,] <- wNow
}
rownames(D7ToD7WM_shift) <- levels(D7ToD7$id.from)
shiftMat2Plt <- melt(D7ToD7WM_shift,varnames=c("id.from","id.to"))

WM_plt <- ggplot(shiftMat2Plt)+geom_tile(aes(x=id.to,y=id.from,fill=value))+
   scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =18,
                       limits=c(0,36))+
  theme_paper()+
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank())+
  coord_fixed(ratio=1) + 
  ggtitle("connectivity shifted to align peaks")
print(D7ToD7_Plt+WM_plt)

```

Plot the mean profile
```{r}
meanD7ToD7Prof <- shiftMat2Plt %>% group_by(id.to) %>% summarize(mean = mean(value), sd = sd(value))
meanD7ToD7Prof_Plt <- ggplot(meanD7ToD7Prof)+ geom_line(aes(x=id.to,y=mean,group=1),color='black') +
  geom_line(aes(x=id.to,y=mean-sd,group=1),color='gray') +
  geom_line(aes(x=id.to,y=mean+sd,group=1),color='gray') +
  theme_paper() + ggtitle("mean and SD of shifted connectivity")

print(WM_plt / meanD7ToD7Prof_Plt)
```

List the order of PB gloms
```{r}
PBGlomOrder <- c("R9","R8","R7","R6","R5","R4","R3","R2","R1",
                 "L1","L2","L3","L4","L5","L6","L7","L8","L9")
```

Create a von Mises profile in the EPGs - in the EB
```{r}
gloms = c("R1","L8","R2","L7","R3","L6","R4","L5",
         "R5","L4","R6","L3","R7","L2","R8","L1")
actProfvM <- data.frame(act = vonMisesProf(),glom = gloms)
actProfvM$glom <- factor(actProfvM$glom, levels = gloms)
```

Propogate the profile into the PB
```{r}
# Get the EPG to D7 connections
EPG_2_Delta7 <- D7Bag$inputs_raw %>% filter(type.from == "EPG" & type.to == "Delta7" & roi=="PB")
EPG_2_Delta7$id.from <- EBGlomOrder(EPG_2_Delta7$name.from,EPG_2_Delta7$from,"PB")
EPG_2_Delta7$id.to <- EBGlomOrder(EPG_2_Delta7$name.to,EPG_2_Delta7$to,"PB")
```

Get the EPG activity given a von Mises profile
```{r}
allEPGids <- PBRename(EPG_2_Delta7$name.from,EPG_2_Delta7$from) %>% unique() %>% as.character() %>% sort()
allD7ids <-levels(D7ToD7$id.from)
allEPGGloms <-  allEPGids %>% as.character() %>% strsplit("_") %>% lapply(function(x)tail(x,1)[1]) %>% unlist() %>% strsplit('-') %>% lapply(function(x)head(x,1)[1]) %>% unlist()
EPGact <-  numeric(length(allEPGids))
for (EPG in 1:length(allEPGids)){
  EPGact[EPG] <- actProfvM[which(actProfvM$glom == allEPGGloms[EPG]),]$act
}
EPGProf <- data.frame(nameid = allEPGids, act = EPGact, glom = allEPGGloms)
EPGProf$glom <- factor(EPGProf$glom, levels = PBGlomOrder)
```
```{r}
g_EPGact_in_PB <- ggplot(EPGProf) + geom_bar(aes(x = nameid, weight = act)) + 
  theme_paper() + coord_cartesian(expand=FALSE) + xlab('EPG neuron') + ylab('normalized activity') + 
  theme(axis.text.x = element_text(angle = 90))
print(g_EPGact_in_PB)
```

Convert this to a Delta 7 activity profile
```{r}
justWeights_EPG_2_D7 <- WMFromConTab(EPG_2_Delta7,allEPGids,allD7ids)
D7outAct <- as.vector(EPGact %*% justWeights_EPG_2_D7)
D7outAct <- (D7outAct - min(D7outAct))/(max(D7outAct)-min(D7outAct))
allD7Gloms = allD7ids %>% lapply(function(x){str_split(x,'_')[[1]][2]}) %>% unlist()
D7act <- data.frame(id = allD7ids %>% unique(), act= D7outAct, glom = allD7Gloms)

g_D7act_fromEPGS <- ggplot(D7act) + geom_bar(aes(x=id, weight=act)) + 
  theme_paper() + coord_cartesian(expand=FALSE) + 
  xlab('D7 neuron') + ylab('normalized activity') + 
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  ggtitle("input from EPGs")
print(g_D7act_fromEPGS)
```

Look at how this D7 profile would excite other D7s
```{r}
D7outAct <- as.vector(D7outAct %*% D7ToD7WM)
D7outAct <- (D7outAct - min(D7outAct))/(max(D7outAct)-min(D7outAct))
allD7Gloms = allD7ids %>% lapply(function(x){str_split(x,'_')[[1]][2]}) %>% unlist()
D7act <- data.frame(id = allD7ids %>% unique(), act= D7outAct, glom = allD7Gloms)

g_D7act_fromD7s <- ggplot(D7act) + geom_bar(aes(x=id, weight=act)) + 
  theme_paper() + coord_cartesian(expand=FALSE) + 
  xlab('D7 neuron') + ylab('normalized activity') + 
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("input from D7s")
print(g_D7act_fromD7s)
```

Combine the plots
```{r}
layout <- "
AB
#C
"

D7ToD7ConProfs <- D7ToD7_Plt + WM_plt + meanD7ToD7Prof_Plt + plot_layout(design = layout)
D7ToD7ActProp <- g_EPGact_in_PB / g_D7act_fromEPGS / g_D7act_fromD7s

ggsave("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\FirstDraftFigs\\PB\\Panels\\D7ToD7Profile.pdf",D7ToD7ConProfs)
ggsave("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\FirstDraftFigs\\PB\\Panels\\D7ToD7Activity.pdf",D7ToD7ActProp)

```
