---
title: "PB Figure 3"
output: html_notebook
---


```{r}
library(neuprintr)
library(tidyverse)
library(cowplot)
library(neuprintrExtra)
library(reshape2)
library(patchwork)
library(ggnewscale)
library(gridExtra)

source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\PBAnalysisUtils.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\visualizeConnectivityTables.R")
```

Specify plotting text sizes
```{r}
mm2pt <- 0.352777778
update_geom_defaults("text", list(size = 6*mm2pt))
theme_paper <- function(...){
  theme_cowplot(font_size=7,font_family="sans",rel_small=6/7,rel_tiny = 5/7,rel_large = 12/7, line_size = 0.5*mm2pt) + theme(strip.background = element_blank(),plot.tag=element_text(size=12,face="bold",family = "sans"),...)
}

```

Get the connection tables from EPGs, D7s, IBSpsP, and SpsP Neurons to other FB types
```{r}
nronTypes <- c("EPG","Delta7","IbSpsP","SpsP",
               "PEN_a(PEN1)","PEN_b(PEN2)","PEG",
               "PFNa","PFNd","PFNm_a","PFNm_b","PFNp_a","PFNp_b","PFNp_c","PFNp_d","PFNp_e","PFNv",
               "PFGs","PFR_a","PFR_b","PFL1","PFL2","PFL3")
ROI = "PB"
  
# Get the connection tables
conTab <- getConnectionTable(getTypesTable(nronTypes)$bodyid,
                             "POST",ROI) %>% filter(type.to %in% nronTypes)

conTab$nameid <- PBRename(conTab$name.from,conTab$from)
conTab$partnerid <- PBRename(conTab$name.to,conTab$to)

conmatPlot <- ggplot(conTab) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", midpoint =0.5*max(conTab$weightRelative),
                       limits=c(0,max(conTab$weightRelative))) +
  geom_tile(aes(partnerid,nameid,fill=weightRelative)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,size=4,hjust=1),
        axis.text.y = element_text(size=4)) +
  xlab("pre-synaptic neuron") + ylab("post-synaptic neuron")

print(conmatPlot)
```

```{r}
typeToType <- getTypeToTypeTable(conTab)

plt_order = c("Delta7","EPG","IbSpsP", "PEN_a(PEN1)","PEN_b(PEN2)","PEG","PFGs",
              "PFNa","PFNd","PFNm_a","PFNm_b","PFNp_a","PFNp_b","PFNp_c","PFNp_d","PFNp_e","PFNv",
              "PFL1","PFL2","PFL3","PFR_a","PFR_b","SpsP")
typeToType$type.from <- factor(typeToType$type.from,levels=plt_order)
typeToType$type.to <- factor(typeToType$type.to,levels=plt_order)

conmatPlot_T2T <- ggplot(typeToType %>% filter(type.from != "PFR_b")) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", midpoint =0.5*max(typeToType$weightRelative),
                       limits=c(0,max(typeToType$weightRelative))) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) +
  theme_minimal() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("post-synaptic type") + ylab("pre-synaptic type") +
  geom_hline(yintercept = 0.5) + geom_hline(yintercept = 3.5) + geom_hline(yintercept = 5.5) +
  geom_vline(xintercept = 0.5) + geom_vline(xintercept = 3.5) + geom_vline(xintercept = 23.5) 

print(conmatPlot_T2T)
```
Split the connection table in two
```{r}
EPGD7Dat <- typeToType %>% filter(type.from %in% c("EPG","Delta7"))
conmatPlot_T2T_D7EPG <- ggplot(EPGD7Dat) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", midpoint =0.5*max(EPGD7Dat$weightRelative),
                       limits=c(0,max(EPGD7Dat$weightRelative))) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) +
  theme_paper() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("postsynaptic type") + ylab("presynaptic type")

otherDat <- typeToType %>% filter(type.from %in% c("SpsP","PFNv","IbSpsP"))
conmatPlot_T2T_other <- ggplot(otherDat) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", midpoint =0.5*max(otherDat$weightRelative),
                       limits=c(0,max(otherDat$weightRelative))) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) +
  theme_paper() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("postsynaptic type") + ylab("presynaptic type")

conmatSplt <- conmatPlot_T2T_D7EPG / conmatPlot_T2T_other
ggsave('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\FirstDraftFigs\\PB\\PBTypeToType_Split.pdf',
       conmatSplt, width = 3.5, height = 4)
```

```{r}
conmatPlot_T2T
save_plot('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\PBTypeToType.pdf',conmatPlot_T2T)
```

Look at PFNv connectivity in the FB
```{r}
nronTypes <- c("PFNv")
ROI = "CX"
  
# Get the connection tables
conTab_PFNv_PRE <- getConnectionTable(getTypesTable(nronTypes)$bodyid,"PRE",ROI)

typeToType_PFNv_PRE <- getTypeToTypeTable(conTab_PFNv_PRE)

plt_order = c("Delta7","EPG","IbSpsP","LPsP","ExR5","OA-VPM3","FB1H","FB4B","FB4M","PFR_b","LNO2","LNO3","PFNv")
typeToType_PFNv_PRE$type.from = factor(typeToType_PFNv_PRE$type.from, levels = plt_order)

conmatPlot_PFNv <- ggplot(typeToType_PFNv_PRE %>% filter(type.from != "PFR_b")) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", 
                       midpoint =0.5*max(typeToType_PFNv_PRE$weightRelative),
                       limits=c(0,max(typeToType_PFNv_PRE$weightRelative))) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("post-synaptic neuron") + ylab("pre-synaptic neuron")

conmatPlot_PFNv
save_plot('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\PFNvInputs.pdf',conmatPlot_PFNv)
```

Create a Hanesch plot showing where the IbSpsP neurons get their input
```{r}

IbSpsPs <- getTypesTable("IbSpsP")
#IbSpsPs[which(IbSpsPs$cellBodyFiber == 'PDM21'),]$type = "IbSpsP_R"
#IbSpsPs[which(grepl('_R',IbSpsPs$name)),]$type = "IbSpsP_R"
#IbSpsPs[which(is.na(IbSpsPs$cellBodyFiber)),]$type = "IbSpsP_L"
#IbSpsPs[which(grepl('_L',IbSpsPs$name)),]$type = "IbSpsP_L"

ISP_ins <- getROISummary(IbSpsPs)

IbSpsP_in_ROIs <- haneschPlot(ISP_ins)

IbSpsP_in_ROIs
save_plot('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\IbSpsPIns.pdf',IbSpsP_in_ROIs)
```



Create a type-to-type table for P1-9, LPsP
```{r}
NM_CT_PB_POST <- getConnectionTable(getTypesTable(c("LPsP","P1-9"))$bodyid,"POST","PB")
NM_CT_PB_POST <- NM_CT_PB_POST %>% filter(!is.na(type.to) & !is.na(type.from)) %>%
  filter(type.to !="SIFa" & type.from !="SIFa")

NM_T2T_PB_POST <- getTypeToTypeTable(NM_CT_PB_POST)

T2TPlot_NM_PB_POST <- ggplot(NM_T2T_PB_POST) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(NM_T2T_PB_POST$outputContribution),
                       limits=c(0,max(NM_T2T_PB_POST$outputContribution))) +
  geom_tile(aes(type.to,type.from,fill=outputContribution)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("pre-synaptic type") + ylab("post-synaptic type")

print(T2TPlot_NM_PB_POST)
```

Create a neuron-to-neuron table for LPsP outputs
```{r}
LPsP_POST <- getConnectionTable(getTypesTable("LPsP")$bodyid,"POST","PB")
LPsP_POST <- LPsP_POST %>% filter(!is.na(type.to) & !is.na(type.from)) %>%
  filter(type.to !="SIFa" & type.from !="SIFa")

LPsP_POST$id.from <- PBRename(LPsP_POST$name.from,LPsP_POST$from)
LPsP_POST$id.to <- PBRename(LPsP_POST$name.to,LPsP_POST$to)
```


```{r}
LPsP_POST_Plt_PFNs <- ggplot(LPsP_POST %>% filter(grepl("PFN",type.to))) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(LPsP_POST$outputContribution),
                       limits=c(0,max(LPsP_POST$outputContribution))) +
  geom_tile(aes(id.to,id.from,fill=outputContribution)) +
  theme_paper() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1,size=2)) +
  xlab("presynaptic type") + ylab("postsynaptic type")

typesTo <- LPsP_POST %>% filter(grepl("PFN",type.to)) %>% select(type.to) %>% unique() %>% unlist() %>% as.character() %>% sort() %>% 
  lapply(function(x) str_replace(x,'_','')) %>% unlist()
idsTo <- LPsP_POST %>% filter(grepl("PFN",type.to)) %>% select(id.to) %>% unique() %>% unlist() %>% as.character() %>% sort() %>% 
  lapply(function(x) strsplit(x,'_')[[1]][1]) %>% unlist()
offset <- 0.5
for (t in 1:length(typesTo)){
  offset <- offset + length(which(typesTo[t] == idsTo))
  LPsP_POST_Plt_PFNs <- LPsP_POST_Plt_PFNs + geom_vline(xintercept = offset, size=0.5)
}

LPsP_POST_Plt <- ggplot(LPsP_POST %>% filter(!grepl("PFN",type.to))) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(LPsP_POST$outputContribution),
                       limits=c(0,max(LPsP_POST$outputContribution))) +
  geom_tile(aes(id.to,id.from,fill=outputContribution)) +
  theme_paper() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1,size=2)) +
  xlab("presynaptic type") + ylab("postsynaptic type")

typesTo <- LPsP_POST %>% filter(!grepl("PFN",type.to)) %>% select(type.to) %>% unique() %>% unlist() %>% as.character() %>% sort() %>% 
  lapply(function(x) gsub("\\s*\\([^\\)]+\\)","",x)) %>% unlist() %>%
  lapply(function(x) gsub("PEN_a","PEN1",x)) %>% unlist() %>%
  lapply(function(x) gsub("PEN_b","PEN2",x)) %>% unlist()
idsTo <- LPsP_POST %>% filter(!grepl("PFN",type.to)) %>% select(id.to) %>% unique() %>% unlist() %>% as.character() %>% sort() %>% 
  lapply(function(x) strsplit(x,'_')[[1]][1]) %>% unlist() %>%
  lapply(function(x) gsub("PFR","PFR_b",x)) %>% unlist()
offset <- 0.5
for (t in 1:length(typesTo)){
  offset <- offset + length(which(typesTo[t] == idsTo))
  LPsP_POST_Plt <- LPsP_POST_Plt + geom_vline(xintercept = offset, size=0.5)
}

LPsP_Post_Plts <- LPsP_POST_Plt / LPsP_POST_Plt_PFNs
print(LPsP_Post_Plts)
ggsave('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\FirstDraftFigs\\PB\\LPsP_NronToNron.pdf',LPsP_Post_Plts)
```

```{r}
LPsP_POST_Plt_PEGs <- ggplot(LPsP_POST %>% filter(type.to == 'PEG')) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(LPsP_POST$outputContribution),
                       limits=c(0,max(LPsP_POST$outputContribution))) +
  geom_tile(aes(id.to,id.from,fill=outputContribution)) +
  theme_paper() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("presynaptic type") + ylab("postsynaptic type")

LPsP_POST_Plt_PEN1s <- ggplot(LPsP_POST %>% filter(type.to == 'PEN_a(PEN1)')) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(LPsP_POST$outputContribution),
                       limits=c(0,max(LPsP_POST$outputContribution))) +
  geom_tile(aes(id.to,id.from,fill=outputContribution)) +
  theme_paper() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("presynaptic type") + ylab("postsynaptic type")

LPsP_POST_Plt_Focus <- LPsP_POST_Plt_PEGs / LPsP_POST_Plt_PEN1s
print(LPsP_POST_Plt_Focus)
ggsave('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\FirstDraftFigs\\PB\\LPsP_NronToNron_PEGsPEN1s.pdf',LPsP_POST_Plt_Focus)

```
Create a neuron-to-neuron table for LPsP outputs
```{r}
LPsP_POST <- getConnectionTable(getTypesTable("LPsP")$bodyid,"POST","PB")
LPsP_POST <- LPsP_POST %>% filter(!is.na(type.to) & !is.na(type.from)) %>%
  filter(type.to !="SIFa" & type.from !="SIFa")

LPsP_POST$id.from <- PBRename(LPsP_POST$name.from,LPsP_POST$from)
LPsP_POST$id.to <- PBRename(LPsP_POST$name.to,LPsP_POST$to)
```
```{r}
PBColTypes <- c("EPG","EPGt","IbSpsP","PEG","PEN_a(PEN1)","PEN_b(PEN2)","PFGs","PFL1","PFL2","PFL3",
            "PFNa","PFNd","PFNp_a","PFNp_b","PFNp_c","PFNp_e","PFNv","PFR_b")
LPsP_POST_Columnar <- LPsP_POST %>% filter(type.to %in% PBColTypes)
LPsP_POST_Columnar$glom.to <- LPsP_POST_Columnar$id.to %>% 
  lapply(function(x) substr(x,
                            gregexpr(pattern ='_R|_L',x)[[1]][1]+1,
                            gregexpr(pattern ='_R|_L',x)[[1]][1]+2)) %>%
  unlist()
LPsP_POST_Columnar$glom.to <- factor(LPsP_POST_Columnar$glom.to, levels = c('L9','L8','L7','L6','L5','L4','L3','L2','L1',
                                                                            'R1','R2','R3','R4','R5','R6','R7','R8','R9'))
LPsP_POST_Columnar$id.to <- LPsP_POST_Columnar$id.to %>% lapply(function(x) strsplit(as.character(x),'-')[[1]][2]) %>% unlist() %>% as.factor()
```
```{r}
LPsP_POST_Plt_Cols <- ggplot(LPsP_POST_Columnar) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(LPsP_POST_Columnar$outputContribution),
                       limits=c(0,max(LPsP_POST_Columnar$outputContribution))) +
  geom_tile(aes(id.to,id.from,fill=outputContribution)) +
  theme_paper() +
  theme(axis.text.x = element_text(angle = 90,hjust=1,size=2)) +
  xlab("postsynaptic neuron #") + ylab("presynaptic type") +
  facet_grid(rows=vars(type.to),cols=vars(glom.to),scales='free')
print(LPsP_POST_Plt_Cols)
ggsave('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\FirstDraftFigs\\PB\\LPsP_NronToNron_byGlom.pdf',LPsP_POST_Plt_Cols)

```

```{r}

```
```{r}
LPsP_POST_Columnar_MeanAll <- LPsP_POST_Columnar %>% group_by(type.to, glom.to) %>% summarize(meanOutputContribution = mean(outputContribution))

typesTo <- LPsP_POST_Columnar_MeanAll$type.to %>% unique() %>% sort()
glomsTo <- LPsP_POST_Columnar_MeanAll$glom.to %>% unique() %>% sort()
for (t in 1:length(typesTo)){
  for (g in 1:length(glomsTo)){
    if (nrow(LPsP_POST_Columnar_MeanAll %>% filter(type.to == typesTo[t] & glom.to == glomsTo[g])) == 0){
      LPsP_POST_Columnar_MeanAll <- rbind(LPsP_POST_Columnar_MeanAll,
                                          data.frame(type.to=typesTo[t],
                                                     glom.to = glomsTo[g],
                                                     meanOutputContribution = 0))
    }
  }
}


for (t in 1:length(typesTo)){
  datNow <- LPsP_POST_Columnar_MeanAll[which(LPsP_POST_Columnar_MeanAll$type.to == typesTo[t]),]$meanOutputContribution
  LPsP_POST_Columnar_MeanAll[which(LPsP_POST_Columnar_MeanAll$type.to == typesTo[t]),]$meanOutputContribution <- datNow/max(datNow)
}

LPsP_POST_Plt_Cols_Mean_Line <- ggplot(LPsP_POST_Columnar_MeanAll) +
  geom_line(aes(x=glom.to,y=meanOutputContribution, group=type.to,color=type.to)) +
  theme_paper() +
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("PB glom") + ylab("presynaptic type")

print(LPsP_POST_Plt_Cols_Mean_Line)
```

```{r}
LPsP_POST_Columnar_Mean <- LPsP_POST_Columnar %>% group_by(id.from, type.to, glom.to) %>% summarize(meanOutputContribution = mean(outputContribution))

LPsP_POST_Plt_Cols_Mean_Tile <- ggplot(LPsP_POST_Columnar_Mean) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(LPsP_POST_Columnar_Mean$meanOutputContribution),
                       limits=c(0,max(LPsP_POST_Columnar_Mean$meanOutputContribution))) +
  geom_tile(aes(x=glom.to,y= id.from, fill = meanOutputContribution)) +
  theme_paper() +
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("PB glom") + ylab("presynaptic type") +
  facet_grid(rows=vars(type.to),scales='free')
print(LPsP_POST_Plt_Cols_Mean_Tile)
```

```{r}
LPsP_POST_Plt_Cols_Mean <- LPsP_POST_Plt_Cols_Mean_Tile / LPsP_POST_Plt_Cols_Mean_Line

ggsave('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\FirstDraftFigs\\PB\\LPsP_NronToNron_byGlom_Mean.pdf',LPsP_POST_Plt_Cols_Mean)

```

Plot the EPG to downstream neuron-to-neuron connectivity
Get the EPG neuron bag in the PB
```{r}
EPGBag <- neuronBag(getTypesTable('EPG'))
```
Get the neuron-to-neuron connections only
```{r}
EPG_PB_DS <- EPGBag$outputs_raw %>% filter(roi == "PB" & grepl("PF",type.to))
EPG_PB_DS$id.from <- PBRename(EPG_PB_DS$name.from, EPG_PB_DS$from)
EPG_PB_DS$id.to <- PBRename(EPG_PB_DS$name.to, EPG_PB_DS$to)
```
Plot!
```{r}
EPG_PB_nTon_Plt_PFNs <- ggplot(EPG_PB_DS %>% filter(grepl("PFN",type.to))) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(EPG_PB_DS$weightRelative),
                       limits=c(0,max(EPG_PB_DS$weightRelative))) +
  geom_tile(aes(id.to,id.from,fill=weightRelative)) +
  theme_paper() + 
  xlab("presynaptic type") + ylab("postsynaptic type")

EPG_PB_nTon_Plt_PFNs <- structureMatrixPlotByType_lines(EPG_PB_nTon_Plt_PFNs)

EPG_PB_nTon_Plt_Other <- ggplot(EPG_PB_DS %>% filter(!grepl("PFN",type.to))) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(EPG_PB_DS$weightRelative),
                       limits=c(0,max(EPG_PB_DS$weightRelative))) +
  geom_tile(aes(id.to,id.from,fill=weightRelative)) +
  theme_paper() +
  xlab("presynaptic type") + ylab("postsynaptic type")

EPG_PB_nTon_Plt_Other <- structureMatrixPlotByType_lines(EPG_PB_nTon_Plt_Other)

EPG_PB_nTon_Plt <- EPG_PB_nTon_Plt_PFNs / EPG_PB_nTon_Plt_Other
print(EPG_PB_nTon_Plt)
```
```{r}
ggsave('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\FirstDraftFigs\\PB\\EPG_NronToNron.pdf',EPG_PB_nTon_Plt)
```
