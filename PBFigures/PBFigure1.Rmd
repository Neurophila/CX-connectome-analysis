---
title: "PB Figure 1"
output: html_notebook
---


```{r}
library(neuprintr)
library(tidyverse)
library(cowplot)
library(neuprintrExtra)
library(patchwork)

source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\PBAnalysisUtils.R")
```

Specify plotting text sizes
```{r}
tickLabSz <- 6
axLabSz <- 8
legSz <- 6
legTitSz <- 8
pltTit <- 8

theme_set(theme(axis.title = element_text(size = axLabSz), 
      axis.text = element_text(size = tickLabSz),
      legend.text = element_text(size = legSz),
      legend.title = element_text(size = legTitSz),
      plot.title = element_text(size = pltTit)))

```

Figure 1 A - Plot an outline of the PB glomeruli
```{r}
PBGloms <- c("L1","L2","L3","L4","L5","L6","L7","L8","L9",
             "R1","R2","R3","R4","R5","R6","R7","R8","R9")
gOutline <- ggplot()
for (g in 1:length(PBGloms)){
  olDat <- roiOutline(paste0("PB(",PBGloms[g],")")) %>% filter(proj == "xz")
  gOutline <- gOutline + geom_path(data=olDat, aes(x = x, y = -y)) +
    annotate("text", x=mean(olDat$x), y=-mean(olDat$y), label= PBGloms[g],size=2)
}
gOutline <- gOutline + theme_nothing() + coord_fixed()
```

Figure 1 B - Plot a Delta 7 neurons
# C:\Users\turnerevansd\Dropbox (HHMI)\FIBSEM CX Paper Jan 2020\Figures\Renderings\CX_Neurons_Final\Other_PB\Delta7_911241750_XZ.tif

Figure 1 C - Plot a EPGt neuron
# C:\Users\turnerevansd\Dropbox (HHMI)\FIBSEM CX Paper Jan 2020\Figures\Renderings\CX_Neurons_Final\PB-EB_Columnar\EPGt_1168664447_View3.tif

Figure 1D - PB Hanesch plot

Figure 1E - Hanesch style plot showing which PB glomeruli the different neuron types arborize in
Picking the lowest level ROIs
```{r}
## Basic roi hierarchy
roiH <- getRoiTree()
```

```{r}
## The set of rois to color label in the plot
labelRoisPB <- selectRoiSet(roiH,default_level = 0,exceptions = list("PB"=2,"AL(R)"=1,"AL(L)"=1),exceptionLevelMatch = c(2,1,1))
```

```{r}
PBTypes <-c("Delta7","P6-8P9","P1-9","LPsP","SpsP","EPGt","EPG","IbSpsP","PEN_b(PEN2)","PEN_a(PEN1)","PFNv",paste0("PFNp_",c("e","d","c","b","a")),"PFNm_b","PFNm_a","PFNd","PFNa","PEG","PFGs",paste0("PFL",1:3),"PFR_b","PFR_a")
## Create a summary per roi of the types of interest and select only PB glomeruli rois (and reorder them)
PBInts <- getTypesTable(PBTypes)
PBSummaryNonLat <- getROISummary(PBInts,threshold = 0) %>% filter(startsWith(roi,"PB(")) %>% mutate(roi = factor(roi,levels = c(paste0("PB(R",9:1,")"),paste0("PB(L",1:9,")"))))

## Order the types
PBSummaryNonLat$type <- factor(PBSummaryNonLat$type,levels=PBTypes)
PBSummaryNonLat$databaseType <- factor(PBSummaryNonLat$databaseType,levels=PBTypes)
## Order the supertypes
PBSummaryNonLat$supertype2 <- factor(PBSummaryNonLat$supertype2,levels=c("Delta7","P","LPsP","SPS-PB","EPGt","EPG","PEN","PFN","PEG","PFGs","PFL","PFR"))
```

```{r}
## ROIs to use in the plot
PBRoisDetailed <- selectRoiSet(roiH,default_level = 2,exceptions = list("PB"=4,"LAL(R)"=4,"AL(R)"=1,"AL(L)"=1),exceptionLevelMatch = c(2,2,1,1))
PBRoisDetailedOnly <- filter(PBRoisDetailed,startsWith(as.character(roi),"PB(")) %>% mutate(roi = factor(roi,levels = c(paste0("PB(R",9:1,")"),paste0("PB(L",1:9,")"))))
```
```{r}
## Make the Hanesch plot (this one for the multi glomeruli)
haneschPBLoc <- haneschPlot(PBSummaryNonLat %>% filter(databaseType %in% c("Delta7","P1-9","LPsP","P6-8P9","SpsP","EPGt")),roiSelect = PBRoisDetailedOnly,flip = F,grouping = "supertype2",roiLabel = labelRoisPB,interactive=TRUE,showCount = T,theme=theme_minimal_grid(),regionOutlines = F)
haneschPBLoc
```

Same thing with columnar neurons - EPGs, and IbSpsPs
```{r}
haneschPBColumn_EPGIbSpsP <- haneschPlot(PBSummaryNonLat %>% filter(type %in% PBTypes & (databaseType %in% c("EPG","IbSpsP"))),roiSelect = PBRoisDetailedOnly,grouping = "supertype2",roiLabel = labelRoisPB,interactive=TRUE,showCount = T,theme=theme_minimal_grid(),regionOutlines = F)
haneschPBColumn_EPGIbSpsP
```

Same thing with columnar neurons - PENs, PEGs, PFGs, PFLs, and PFRs
```{r}
haneschPBColumn_PEPF <- haneschPlot(PBSummaryNonLat %>% filter(type %in% PBTypes & (databaseType %in% c("PEN_b(PEN2)","PEN_a(PEN1)","PEG","PFGs",paste0("PFL",1:3),"PFR_b","PFR_a"))),roiSelect = PBRoisDetailedOnly,grouping = "supertype2",roiLabel = labelRoisPB,interactive=TRUE,showCount = T,theme=theme_minimal_grid(),regionOutlines = F)
haneschPBColumn_PEPF
```

Same thing with columnar neurons - PFNs
```{r}
haneschPBColumn_PFNs <- haneschPlot(PBSummaryNonLat %>% filter(type %in% PBTypes & (databaseType %in% c("PFNv",paste0("PFNp_",c("e","d","c","b","a")),"PFNm_b","PFNm_a","PFNd","PFNa"))),roiSelect = PBRoisDetailedOnly,grouping = "supertype2",roiLabel = labelRoisPB,interactive=TRUE,showCount = T,theme=theme_minimal_grid(),regionOutlines = F)
haneschPBColumn_PFNs
```


Combine the plots with patchwork
```{r}
haneschPBDetails <- haneschPBLoc / haneschPBColumn_EPGIbSpsP / haneschPBColumn_PEPF / haneschPBColumn_PFNs + plot_layout(guides="collect",heights=c(2,1,4,4))
haneschPBDetails
```

```{r}
save_plot('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\PBDetails_HaneshPlot.pdf',haneschPBDetails,nrow=3,ncol=1.5)
```