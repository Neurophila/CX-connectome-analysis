---
title: "PB Figure 5 - EPGs vs EPGts"
output: html_notebook
---


```{r}
library(neuprintr)
library(tidyverse)
library(cowplot)
library(neuprintrExtra)
library(reshape2)
library(patchwork)
library(ggnewscale)
library(gridExtra)

source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\PBAnalysisUtils.R")
```

Specify plotting text sizes
```{r}
tickLabSz <- 6
axLabSz <- 8
legSz <- 6
legTitSz <- 8
pltTit <- 8

theme_set(theme(axis.title = element_text(size = axLabSz), 
      axis.text = element_text(size = tickLabSz),
      legend.text = element_text(size = legSz),
      legend.title = element_text(size = legTitSz),
      plot.title = element_text(size = pltTit)))

stCols <- supertype2Palette()
```

Compare the EPG and EPGt connections in the PB - inputs
```{r}
EPGt_CT_PB_PRE <- getConnectionTable(getTypesTable(c("EPG","EPGt"))$bodyid,"PRE","PB")
EPGt_CT_PB_PRE <- EPGt_CT_PB_PRE %>% filter(!is.na(type.to) & !is.na(type.from)) %>%
  filter(type.to !="SIFa" & type.from !="SIFa")

EPGt_T2T_PB_PRE <- getTypeToTypeTable(EPGt_CT_PB_PRE)

T2TPlot_EPGt_PB_PRE <- ggplot(EPGt_T2T_PB_PRE) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(EPGt_T2T_PB_PRE$weightRelative),
                       limits=c(0,max(EPGt_T2T_PB_PRE$weightRelative))) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("post-synaptic type") + ylab("pre-synaptic type")

print(T2TPlot_EPGt_PB_PRE)
```

Compare the EPG and EPGt connections in the EB - inputs
```{r}
EPGt_CT_EB_PRE <- getConnectionTable(getTypesTable(c("EPG","EPGt"))$bodyid,"PRE","EB")
EPGt_CT_EB_PRE <- EPGt_CT_EB_PRE %>% filter(!is.na(type.to) & !is.na(type.from))

EPGt_T2T_EB_PRE <- getTypeToTypeTable(EPGt_CT_EB_PRE)

T2TPlot_EPGt_EB_PRE <- ggplot(EPGt_T2T_EB_PRE) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(EPGt_T2T_EB_PRE$weightRelative),
                       limits=c(0,max(EPGt_T2T_EB_PRE$weightRelative))) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("post-synaptic type") + ylab("pre-synaptic type")

print(T2TPlot_EPGt_EB_PRE)
```

Compare the EPG and EPGt connections in the gall - inputs
```{r}
EPGt_CT_GA_PRE <- getConnectionTable(getTypesTable(c("EPG","EPGt"))$bodyid,"PRE","LAL(R)")
EPGt_CT_GA_PRE <- rbind(EPGt_CT_GA_PRE,
                        getConnectionTable(getTypesTable(c("EPG","EPGt"))$bodyid,"PRE","CRE(R)"))
EPGt_CT_GA_PRE <- EPGt_CT_GA_PRE %>% filter(!is.na(type.to) & !is.na(type.from))
EPGt_CT_GA_PRE$id.from <- PBRename(EPGt_CT_GA_PRE$name.from,EPGt_CT_GA_PRE$from)
EPGt_CT_GA_PRE$id.to <- PBRename(EPGt_CT_GA_PRE$name.to,EPGt_CT_GA_PRE$to)

T2TPlot_EPGt_GA_PRE <- ggplot(EPGt_CT_GA_PRE) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(EPGt_CT_GA_PRE$weightRelative),
                       limits=c(0,max(EPGt_CT_GA_PRE$weightRelative))) +
  geom_tile(aes(id.to,id.from,fill=weightRelative)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("post-synaptic type") + ylab("pre-synaptic type")

print(T2TPlot_EPGt_GA_PRE)
```


Combine the plots
```{r}
EPgtInComp <- T2TPlot_EPGt_PB_PRE + T2TPlot_EPGt_EB_PRE + T2TPlot_EPGt_GA_PRE
save_plot('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\EPGtVSSPGInputs.pdf',EPgtInComp, base_width = 16)
```


Compare the EPG and EPGt connections in the PB - outputs
```{r}
EPGt_CT_PB_POST <- getConnectionTable(getTypesTable(c("EPG","EPGt"))$bodyid,"POST","PB")
EPGt_CT_PB_POST <- EPGt_CT_PB_POST %>% filter(!is.na(type.to) & !is.na(type.from)) %>%
  filter(type.to !="SIFa" & type.from !="SIFa")
EPGt_CT_PB_POST$id.from <- PBRename(EPGt_CT_PB_POST$name.from, EPGt_CT_PB_POST$from)
EPGt_CT_PB_POST$id.to <- PBRename(EPGt_CT_PB_POST$name.to, EPGt_CT_PB_POST$to)

conmatPlot_EPGt_PB_POST <- ggplot(EPGt_CT_PB_POST) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(EPGt_CT_PB_POST$weightRelative),
                       limits=c(0,max(EPGt_CT_PB_POST$weightRelative))) +
  geom_tile(aes(id.to,id.from,fill=weightRelative)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("pre-synaptic neuron") + ylab("post-synaptic neuron")

#print(conmatPlot_EPGt_PB_POST)

EPGt_T2T_PB_POST <- getTypeToTypeTable(EPGt_CT_PB_POST,
                                  pThresh=0.1)

T2TPlot_EPGt_PB_POST <- ggplot(EPGt_T2T_PB_POST) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(EPGt_T2T_PB_POST$outputContribution),
                       limits=c(0,max(EPGt_T2T_PB_POST$outputContribution))) +
  geom_tile(aes(type.to,type.from,fill=outputContribution)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("pre-synaptic type") + ylab("post-synaptic type")

print(T2TPlot_EPGt_PB_POST)
save_plot('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\EPGtAndEPGPBOutputs.pdf',
          T2TPlot_EPGt_PB_POST)

```


Create weight matrices that compare the PEN1 and PEN2 connectivity in the EB
```{r}
EPGt_CT_EB_PRE <- getConnectionTable(getTypesTable(c("EPG","EPGt"))$bodyid,"PRE","EB",synThresh= 0)
EPGt_CT_EB_PRE <- EPGt_CT_EB_PRE %>% filter(type.from %in% c('PEN_a(PEN1)','PEN_b(PEN2)'))
EPGt_CT_EB_PRE$id.from <- PBRename(EPGt_CT_EB_PRE$name.from, EPGt_CT_EB_PRE$from)
EPGt_CT_EB_PRE$id.to <- PBRename(EPGt_CT_EB_PRE$name.to, EPGt_CT_EB_PRE$to)

pltLevels <- levels(EPGt_CT_EB_PRE$id.to)
pltLevels <- c(pltLevels[47:48],pltLevels[1:46],pltLevels[49:50])
EPGt_CT_EB_PRE$id.to <- factor(EPGt_CT_EB_PRE$id.to,levels=pltLevels)

conmatPlot_EPGt_EB_PRE <- ggplot(EPGt_CT_EB_PRE) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(EPGt_CT_EB_PRE$weightRelative),
                       limits=c(0,max(EPGt_CT_EB_PRE$weightRelative))) +
  geom_tile(aes(id.to,id.from,fill=weightRelative)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("pre-synaptic neuron") + ylab("post-synaptic neuron") +
  geom_vline(xintercept = 2.5) + geom_vline(xintercept = 48.5) + geom_vline(xintercept = 50.5) +
  geom_hline(yintercept = 20.5) + geom_hline(yintercept = 42.5)

print(conmatPlot_EPGt_EB_PRE)
```

Create weight matrices that compare the PEN1 and PEN2 connectivity in the PB
```{r}
EPGt_CT_PB_POST <- getConnectionTable(getTypesTable(c("EPG","EPGt"))$bodyid,"POST","PB",synThresh= 0)
EPGt_CT_PB_POST <- EPGt_CT_PB_POST %>% filter(!is.na(type.to) & !is.na(type.from))
EPGt_CT_PB_POST <- EPGt_CT_PB_POST %>% filter(type.to %in% c('PEN_a(PEN1)','PEN_b(PEN2)'))
EPGt_CT_PB_POST$id.from <- PBRename(EPGt_CT_PB_POST$name.from, EPGt_CT_PB_POST$from)
EPGt_CT_PB_POST$id.to <- PBRename(EPGt_CT_PB_POST$name.to, EPGt_CT_PB_POST$to)


pltLevels <- levels(EPGt_CT_PB_POST$id.from)
pltLevels <- c(pltLevels[47:48],pltLevels[1:46],pltLevels[49:50])
EPGt_CT_PB_POST$id.from <- factor(EPGt_CT_PB_POST$id.from,levels=pltLevels)

conmatPlot_EPGt_PB_POST <- ggplot(EPGt_CT_PB_POST) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(EPGt_CT_PB_POST$weightRelative),
                       limits=c(0,max(EPGt_CT_PB_POST$weightRelative))) +
  geom_tile(aes(id.to,id.from,fill=weightRelative)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("pre-synaptic neuron") + ylab("post-synaptic neuron") +
  geom_hline(yintercept = 2.5) + geom_hline(yintercept = 48.5) + geom_hline(yintercept = 50.5) +
  geom_vline(xintercept = 20.5) + geom_vline(xintercept = 42.5)

print(conmatPlot_EPGt_PB_POST)
```

Combine the plots
```{r}
EPGtwPENs <- conmatPlot_EPGt_EB_PRE + conmatPlot_EPGt_PB_POST
save_plot('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\EPGtwPENs.pdf',EPGtwPENs, base_width = 12)
```

Get the total number of input and output synapses by roi
```{r}
EPG_ROIs <- neuprint_get_roiInfo(getTypesTable(c("EPG","EPGt"))$bodyid)
```

Plot the relative number of input synapses
```{r}
EPG_inputROIs <- EPG_ROIs %>% select(bodyid,PB.upstream,EB.upstream,`LAL(R).upstream`)
EPG_inputROIs[is.na(EPG_inputROIs)] <- 0
colnames(EPG_inputROIs) <- c("bodyid","PB","EB","LAL")
EPG_inputROIs <- melt(EPG_inputROIs,id.vars='bodyid',value.name='syns',variable.name = 'ROI')
EPG_inputROIs <- EPG_inputROIs %>% mutate(type = neuprint_get_meta(bodyid)$type,
                                          name = neuprint_get_meta(bodyid)$name)
EPG_inputROIs$nameid <- PBRename(EPG_inputROIs$name,EPG_inputROIs$bodyid)
EPG_inputROIs$ROI <- factor(EPG_inputROIs$ROI,levels = c("EB","PB","LAL"))

relEPGInputs <- ggplot(EPG_inputROIs,aes(color=as.factor(type),y=syns,x=ROI)) +
  geom_point(position=position_jitterdodge(dodge.width=0.4),alpha=0.5,size=3) +
  theme_cowplot() + scale_y_continuous(expand = c(0, 0)) + 
  ylab("pre-synapses")
relEPGInputs
```

Plot the relative number of output synapses
```{r}
EPG_outputROIs <- EPG_ROIs %>% select(bodyid,PB.downstream,EB.downstream,`LAL(R).downstream`)
EPG_outputROIs[is.na(EPG_outputROIs)] <- 0
colnames(EPG_outputROIs) <- c("bodyid","PB","EB","LAL")
EPG_outputROIs <- melt(EPG_outputROIs,id.vars='bodyid',value.name='syns',variable.name = 'ROI')
EPG_outputROIs <- EPG_outputROIs %>% mutate(type = neuprint_get_meta(bodyid)$type,
                                          name = neuprint_get_meta(bodyid)$name)
EPG_outputROIs$nameid <- PBRename(EPG_outputROIs$name,EPG_outputROIs$bodyid)
EPG_outputROIs$ROI <- factor(EPG_outputROIs$ROI,levels = c("EB","PB","LAL"))

relEPGOutputs <- ggplot(EPG_outputROIs,aes(color=as.factor(type),y=syns,x=ROI)) +
  geom_point(position=position_jitterdodge(dodge.width=0.4),alpha=0.5,size=3) +
  theme_cowplot() + scale_y_continuous(expand = c(0, 0)) + 
  ylab("post-synapses")
relEPGOutputs
```

Plot the EPGt connection table in the EB
```{r}
EPGt_CT_EB <- getConnectionTable(getTypesTable(c("EPGt"))$bodyid,"PRE","EB")
EPGt_CT_EB$id.from <- PBRename(EPGt_CT_EB$name.from, EPGt_CT_EB$from)
EPGt_CT_EB$id.to <- PBRename(EPGt_CT_EB$name.to, EPGt_CT_EB$to)

conmatPlot_EPGt_EB <- ggplot(EPGt_CT_EB) + 
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black",
                       midpoint =0.5*max(EPGt_CT_EB$weightRelative),
                       limits=c(0,max(EPGt_CT_EB$weightRelative))) +
  geom_tile(aes(id.to,id.from,fill=weightRelative)) +
  theme_cowplot() + coord_fixed(ratio = 1) + 
  theme(axis.text.x = element_text(angle = 90,hjust=1)) +
  xlab("post-synaptic neuron") + ylab("pre-synaptic neuron")

print(conmatPlot_EPGt_EB)
```


Combine the plots
```{r}
pdf('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\EPGtOverview1.pdf', width = unit(8,"in"), height = unit(6,"in"))
grid.arrange(relEPGInputs,relEPGOutputs,T2TPlot_EPGt_PB_POST,
             layout_matrix = rbind(c(1,2),c(3,3)))
dev.off()

pdf('C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\ForPaper\\EPGtOverview2.pdf', width = unit(8,"in"), height = unit(8,"in"))
grid.arrange(T2TPlot_EPGt_PB_PRE,conmatPlot_EPGt_EB,
             ncol=2,widths=2:3)
dev.off()
```