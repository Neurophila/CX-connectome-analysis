---
title: "Analysis of wind (mechanosensoy) info comming into CX"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
#Analysis of sensory pathways to the LNO

```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
library(neuprintrExtra)
library(igraph)

options(nat.plotengine = 'rgl')
```

```{r}
neuprint_login()
```

```{r messages=FALSE, warning=FALSE}
# Get some custom functions
source("../R/visualizeConnectivityTables.R")
```

## Bodyid's of sensory neurons:
mechanosensory
```{r}
APN2type =  c("SAD004", "SAD003")
APN3type = "SAD077"
APN3 = neuprint_search("SAD077_.*")
APN2 = bind_rows(neuprint_search("SAD004.*"),neuprint_search("SAD003.*"))
APN2and3 = bind_rows(APN2, APN3) 

APNBodies = c(APN3$bodyid,APN2$bodyid)

WLLtype =  "LAL138"
WLL = neuprint_search(paste0(WLLtype,".*"))

# Putative WPN, based on morphology and connectivity:
#(these were identified in a shortest path analysis as shown later)
WPNtype = "LHPV6q1"
WPN = neuprint_search(paste0(WPNtype,".*"))

allMec = bind_rows(APN2and3,WLL,WPN)

```

heating & cooling
```{r}
heating = c(1858901026,1881401277,1943811736,1943812176,1975187675,1975878958)
cooling = c(603785283,663432544,850717220,1755556097,5813040515)
unknown = c(663787020,664814903,5813056072)

heating = neuprint_get_meta(heating)
cooling = neuprint_get_meta(cooling)
unknown = neuprint_get_meta(unknown)
```

dry & humid
```{r}
dryAndEvap = c(634759240,1639234609,1639243580,1727979406)
humid = c(1944502935,2069648663,5813063239, 5813063239) #last one is putative gustatory receptor
dryAndEvap = neuprint_get_meta(dryAndEvap)
humid = neuprint_get_meta(humid)
```


Also get body ID's of putative downstream partners
```{r}
# LNO
LNO = neuprint_search("LNO.*")
LCNO = neuprint_search("LCNO.*")
GLNO = neuprint_search("GLNO.*")

allLNO =  bind_rows(LNO,LCNO,GLNO) 

splitLR = TRUE
```

## Find paths to the CX
```{r}
maxL = 3
allMec_to_LNO_t2tpath = get_type2typePath(allMec, allLNO, by.roi = FALSE, n_steps = seq(maxL),renaming=lateralize_types)
```

```{r}
heating_to_LNO_t2tpath = get_type2typePath(heating, allLNO, by.roi = FALSE, n_steps = seq(maxL),renaming=lateralize_types)
cooling_to_LNO_t2tpath = get_type2typePath(cooling, allLNO, by.roi = FALSE, n_steps = seq(maxL),renaming=lateralize_types)

unknown_to_LNO_t2tpath = get_type2typePath(unknown, allLNO, by.roi = FALSE, n_steps = seq(maxL),renaming=lateralize_types)
```

```{r}
dryAndEvap_to_LNO_t2tpath = get_type2typePath(dryAndEvap, allLNO, by.roi = FALSE, n_steps = seq(maxL),renaming=lateralize_types)
humid_to_LNO_t2tpath = get_type2typePath(humid, allLNO, by.roi = FALSE, n_steps = seq(maxL),renaming=lateralize_types)
```

```{r}
cutoff = 0#0.02#0.01#
edcurve = 0.15
vertexSize = 7
edgeNorm = 0.04
minPathWeight = 0.05 ** maxL#
plotSize = 10

sourcegroup = "allMec"
pathDf = allMec_to_LNO_t2tpath %>% filter(weightRelative_path  >= minPathWeight )
graphName = paste0("pathGraph_",sourcegroup,"2LNO_0-05-exp",maxL)

graphDataFrame = pathDf2graphDf(pathDf) %>% mutate(relWeight =  weightRelative)

myGraph = constructConnectivityGraph(graphDataFrame, cutoff, vertexSize, selfFBscale=1, arrowSize=0, edgeNorm)

l = layout_with_dh(myGraph)
myGraph$main = paste("Min path weight = ", minPathWeight)

plot(myGraph,edge.curved=edcurve, layout=l, edge.color = customizeGraphEdges(myGraph), 
     family="Arial", vertex.label.family  = "sans")
maxEdge = max(E(myGraph)$width)
minEdge = min(E(myGraph)$width)
legend(x=-0.8,y=1, legend = edgeNorm*seq(round(minEdge, digits = 0),round(maxEdge, digits = 0)), 
       lwd	 = seq(round(minEdge, digits = 0),round(maxEdge, digits = 0)),  bty = "n", seg.len=0.5)

dev.print(pdf, paste0("../../neuprintR_analysis_plots/",graphName,".pdf"), width=plotSize, height=plotSize,useDingbats=FALSE)
```

```{r}
patternLayers =  c("LH","WED","LAL", "PEN","LNO")
  #c("SAD","WED","LH","LAL","ER","PEN","PFN","LNO")
layerPos = c(0,1,2,4,5)
  #c(0,1,2,3,4,6,7,8)
defaultY = 3
edcurve = 0.1

myGraph = constructConnectivityGraph(graphDataFrame, cutoff, vertexSize, selfFBscale=1, arrowSize=0, edgeNorm)

vertexProps = data.frame(name = V(myGraph)$name, col = V(myGraph)$color) %>% mutate(name = gsub("_[R,L]", "", name))
vertexProps = vertexProps %>% mutate(loc = "default", yloc = seq(length(vertexProps$col)), xloc = defaultY)

for(layer in seq(length(patternLayers))){
  vertexProps[grepl(patternLayers[layer],vertexProps$name),] = vertexProps[grepl(patternLayers[layer],vertexProps$name),] %>% 
    mutate(loc = paste0("layer",layerPos[layer]+1), xloc = layerPos[layer], yloc = 1*seq(length(loc)))
}
vertexProps$yloc[vertexProps$loc == "default"] = 1*seq(length(vertexProps$loc[vertexProps$loc == "default"]))


plot(myGraph,edge.curved=edcurve, layout=layout.norm(as.matrix(vertexProps[,c("xloc","yloc")])), edge.color = customizeGraphEdges(myGraph), 
     family="Arial",family="Arial", vertex.label.family  = "sans")

maxEdge = max(E(myGraph)$width)
minEdge = min(E(myGraph)$width)
legend(x=-1.2,y=1, legend = edgeNorm*seq(round(minEdge, digits = 0),round(maxEdge, digits = 0),3), 
       lwd	 = seq(round(minEdge, digits = 0),round(maxEdge, digits = 0),3),  bty = "n", seg.len=0.5)

dev.print(pdf, paste0("../../neuprintR_analysis_plots/",graphName,"_structured.pdf"), width=plotSize, height=plotSize,useDingbats=FALSE)

```
