---
title: "Pie charts"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
library(plotly)
library(paletteer)
options(nat.plotengine = 'rgl')
```

```{r}
neuprint_login()
```

```{r messages=FALSE, warning=FALSE}
# Get some custom functions
source("neuprintQueryUtils.R")
source("InputOutputByTypeUtils.R")
source("connectionPieChart.R")
```

### Construct neuron bag for type of interest
```{r}
myType = "EPG"
myType_bag = buildInputsOutputsByType(myType)

slctROIs = c("PB", "FB", "NO", "EB","LAL(R)","WED(R)", "CRE(R)", "EPA(R)") #"LAL(-GA)(R)", "GA(R)",
# Filter out neurons from left side?
splitLR = FALSE
if(splitLR){myType = paste0(myType,"_L")}

saveDir = "../neuprintR_analysis_plots/mechanoPW/"
```

Saving figures to static images is a bit tricky and requires installation of a command line tool (orca). I had to install it through conda and then need to point it too the binaries manually:
```{r}
Sys.setenv("PATH" = paste(Sys.getenv("PATH"), "/Users/haberkernh/anaconda3/bin", sep = .Platform$path.sep))
```

### Generate data for pie chart
```{r}
myTypeIn = prepData4pieChart(myType_bag,partnerDirection="input",slctRoi=slctROIs, splitLR,myType,minweight=0)
myTypeOut = prepData4pieChart(myType_bag,partnerDirection="output",slctRoi=slctROIs, splitLR,myType,minweight=0)
```

### Make chart that illustrates input and output fraction per region
```{r}

if(length(myTypeIn$roi)>0){
  pieDat_in = generatePieChartData(myTypeIn, myType, rootlab = paste0(myType," input"))
  fig_in <- plot_ly(data=pieDat_in, ids = ~ids, labels = ~labels, parents = ~parents, values = ~values, 
               type = 'sunburst',branchvalues = 'total') %>%
  layout(sunburstcolorway = paletteer_d("awtools::a_palette"), uniformtext=list(minsize=8, mode="show"))
  
  
  orca(fig_in, file = paste0(saveDir,"pieChart_",myType,"_in.pdf"))
}

if(length(myTypeOut$roi)>0){
  pieDat_out = generatePieChartData(myTypeOut, myType, rootlab = paste0(myType," output"))
  fig_out <- plot_ly(data=pieDat_out, ids = ~ids, labels = ~labels, parents = ~parents, values = ~values, 
               type = 'sunburst',branchvalues = 'total') %>%
  layout(sunburstcolorway = paletteer_d("awtools::a_palette"), uniformtext=list(minsize=8, mode="show"))

  fig_out
  
  orca(fig_out, file = paste0(saveDir,"pieChart_",myType,"_out.pdf"))
} 

fig_in
fig_out

```
