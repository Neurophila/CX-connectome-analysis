---
title: "LAL explorations"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
options(nat.plotengine = 'rgl')
```


```{r}
neuprint_login()
```

### PFLs outputs

```{r}
PFLaNames = neuprint_search("PB12a.*")
PFLbNames = neuprint_search("PB12b.*")
PFLcNames = neuprint_search("PB12c.*")
head(PFLbNames)
```

One can then get a table of connections in a roi with a given polarity (for selected neurons):

```{r}
## Using all_segments = FALSE to restrict to synapses between "neurons" (vs weird fragment). Note that the majority of the LAL is still small fragments
lalPostConnectionsA = neuprint_connection_table(PFLaNames[["bodyid"]],"PRE","LAL",all_segments = FALSE)
lalPostConnectionsB = neuprint_connection_table(PFLbNames[["bodyid"]],"PRE","LAL",all_segments = FALSE)
lalPostConnectionsC = neuprint_connection_table(PFLcNames[["bodyid"]],"PRE","LAL",all_segments = FALSE)
head(lalPostConnectionsA)
```


```{r}
lalPostConnectionsA = lalPostConnectionsA %>%
                     mutate(partnerName = neuprint_get_meta(partner)[["name"]],name =neuprint_get_meta(bodyid)[["name"]])   

lalPostConnectionsB = lalPostConnectionsB %>%
                     mutate(partnerName = neuprint_get_meta(partner)[["name"]],name =neuprint_get_meta(bodyid)[["name"]])   

lalPostConnectionsC = lalPostConnectionsC %>%
                     mutate(partnerName = neuprint_get_meta(partner)[["name"]],name =neuprint_get_meta(bodyid)[["name"]])   



head(lalPostConnectionsB)
```


```{r}
lalPostConnectionsA = lalPostConnectionsA %>% 
                       group_by(name) %>% 
                       mutate(weightRelative = weight/sum(weight)) %>%
                       ungroup() #%>%
                  

connectionsPerNameA = lalPostConnectionsA %>%
                       group_by(name,partnerName) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )
## same data summed by neuronName -> partnerName combination 

connectionsPerNeuronA = lalPostConnectionsA %>%
                       group_by(name,partner) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )
## same data summed by neuronName -> bodyId combination 

lalPostConnectionsB = lalPostConnectionsB %>% 
                       group_by(name) %>% 
                       mutate(weightRelative = weight/sum(weight)) %>%
                       ungroup() #%>%
                 

connectionsPerNameB = lalPostConnectionsB %>%
                       group_by(name,partnerName) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )
## same data summed by neuronName -> partnerName combination 

connectionsPerNeuronB = lalPostConnectionsB %>%
                       group_by(name,partner) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )

lalPostConnectionsC = lalPostConnectionsC %>% 
                       group_by(name) %>% 
                       mutate(weightRelative = weight/sum(weight)) %>%
                       ungroup() #%>%
                       

connectionsPerNameC = lalPostConnectionsC %>%
                       group_by(name,partnerName) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )
## same data summed by neuronName -> partnerName combination 

connectionsPerNeuronC = lalPostConnectionsC %>%
                       group_by(name,partner) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )

```

Then plot it with `ggplot2` (see [this other chapter](https://r4ds.had.co.nz/data-visualisation.html))
```{r}
## Again, note that those proportions are artificially high because we're ignoring any synapse to a "non neuron" fragment
ggplot(connectionsPerNameA %>% filter(weight>10)) + geom_bar(aes(x=name,y=weightRelative,fill=partnerName),stat="identity") +theme(axis.text.x = element_text(angle = 90))
ggplot(connectionsPerNameB %>% filter(weight>10)) + geom_bar(aes(x=name,y=weightRelative,fill=partnerName),stat="identity") +theme(axis.text.x = element_text(angle = 90))
ggplot(connectionsPerNameC %>% filter(weight>10)) + geom_bar(aes(x=name,y=weightRelative,fill=partnerName),stat="identity") +theme(axis.text.x = element_text(angle = 90))
```
It still seems that a majority of connections from all those neurons are very weak (filtering connections less than 4 reduces a lot the fraction of outputs covered).

### Perspective from the outputs

Create connection tables for all the different outputs
```{r}
lalOutputsA = neuprint_connection_table(unique(lalPostConnectionsA$partner),"POST","LAL",all_segments = FALSE) %>%
                     mutate(partnerName = neuprint_get_meta(partner)[["name"]],name =neuprint_get_meta(bodyid)[["name"]])   

lalOutputsB = neuprint_connection_table(unique(lalPostConnectionsB$partner),"POST","LAL",all_segments = FALSE) %>%
                     mutate(partnerName = neuprint_get_meta(partner)[["name"]],name =neuprint_get_meta(bodyid)[["name"]])   

lalOutputsC = neuprint_connection_table(unique(lalPostConnectionsC$partner),"POST","LAL",all_segments = FALSE) %>%
                     mutate(partnerName = neuprint_get_meta(partner)[["name"]],name =neuprint_get_meta(bodyid)[["name"]])   
```


Calculate relative input weights, then restrict to PFL synapses.
```{r}
lalOutputsA = lalOutputsA %>% 
                       group_by(bodyid) %>% 
                       mutate(weightRelative = weight/sum(weight)) %>%
                       ungroup() %>% 
                       filter(partnerName %in% PFLaNames$name)
                       
lalOutputsB = lalOutputsB %>% 
                       group_by(bodyid) %>% 
                       mutate(weightRelative = weight/sum(weight)) %>%
                       ungroup() %>% 
                       filter(partnerName %in% PFLbNames$name)

lalOutputsC = lalOutputsC %>% 
                       group_by(bodyid) %>% 
                       mutate(weightRelative = weight/sum(weight)) %>%
                       ungroup() %>% 
                       filter(partnerName %in% PFLbNames$name)
```

```{r}
## How much do the PFL contribute to each neuron/type? Use that to filter for the rest
totalConnectionsPerNeuronA = lalOutputsA %>%
                       group_by(bodyid,name) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )

totalConnectionsPerNeuronB = lalOutputsB %>%
                       group_by(bodyid,name) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )

totalConnectionsPerNeuronC = lalOutputsC %>%
                       group_by(bodyid,name) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )

## Let's only consider neurons that get at least 2% of their total inputs in the LAL from a PFL type
totalConnectionsPerNeuronA = totalConnectionsPerNeuronA %>% filter(weightRelative>0.02)
totalConnectionsPerNeuronB = totalConnectionsPerNeuronB %>% filter(weightRelative>0.02)
totalConnectionsPerNeuronC  = totalConnectionsPerNeuronC %>% filter(weightRelative>0.02)
```


```{r}
ggplot(totalConnectionsPerNeuronA) + geom_point(aes(x=name,y=weightRelative,color=name)) + theme(axis.text.x = element_text(angle = 90)) + guides(color="none")
ggplot(totalConnectionsPerNeuronB) + geom_point(aes(x=name,y=weightRelative,color=name)) + theme(axis.text.x = element_text(angle = 90)) + guides(color="none")
ggplot(totalConnectionsPerNeuronC) + geom_point(aes(x=name,y=weightRelative,color=name)) + theme(axis.text.x = element_text(angle = 90)) + guides(color="none")
```


```{r}
## Filtering the main dataframe
lalOutputsA = lalOutputsA %>% filter(name %in% totalConnectionsPerNeuronA$name)
lalOutputsB = lalOutputsB %>% filter(name %in% totalConnectionsPerNeuronB$name)
lalOutputsB = lalOutputsB %>% filter(name %in% totalConnectionsPerNeuronB$name)
```

```{r}
unique(lalOutputsA$bodyid)
```


#### Extra cleanup using a LAL mesh

```{r}
pflaOutputs = neuprint_read_neurons(unique(lalOutputsA$bodyid))
pflbOutputs = neuprint_read_neurons(unique(lalOutputsB$bodyid))
pflcOutputs = neuprint_read_neurons(unique(lalOutputsC$bodyid))
```


```{r}
lalMesh = neuprint_ROI_mesh("LAL")
```
```{r}
inLAL = function(x){subset(x,pointsinside(x,lalMesh))}
pflaOutputsInLAL = nlapply(pflaOutputs,inLAL,OmitFailures = TRUE)
pflbOutputsInLAL = nlapply(pflbOutputs,inLAL,OmitFailures = TRUE)
pflcOutputsInLAL = nlapply(pflcOutputs,inLAL,OmitFailures = TRUE)
```
```{r}
summaryA = summary(pflaOutputsInLAL, include.attached.dataframe = TRUE)
summaryB = summary(pflbOutputsInLAL, include.attached.dataframe = TRUE)
summaryC = summary(pflcOutputsInLAL, include.attached.dataframe = TRUE)
```

```{r}
innervatesLalA = summaryA %>% filter(endpoints>20)
lalOutputsA = lalOutputsA %>% filter(bodyid %in% innervatesLalA$bodyid)

innervatesLalB = summaryB %>% filter(endpoints>20)
lalOutputsB = lalOutputsB %>% filter(bodyid %in% innervatesLalB$bodyid)

innervatesLalC = summaryC %>% filter(endpoints>20)
lalOutputsC = lalOutputsC %>% filter(bodyid %in% innervatesLalC$bodyid)
```

```{r}
## How much do the PFL contribute to each neuron/type? Use that to filter for the rest
totalConnectionsPerNeuronA = lalOutputsA %>%
                       group_by(bodyid,name) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )

totalConnectionsPerNeuronB = lalOutputsB %>%
                       group_by(bodyid,name) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )

totalConnectionsPerNeuronC = lalOutputsC %>%
                       group_by(bodyid,name) %>%
                       summarise(
                         weightRelative = sum(weightRelative),
                         weight = sum(weight)
                       )

## Let's only consider neurons that get at least 1% of their total inputs in the LAL from a PFL type. We also want to exclude PFLs from this set for now
totalConnectionsPerNeuronA = totalConnectionsPerNeuronA %>% filter(weightRelative>0.01 & !(name %in% PFLaNames$name))
totalConnectionsPerNeuronB = totalConnectionsPerNeuronB %>% filter(weightRelative>0.01 & !(name %in% PFLbNames$name))
totalConnectionsPerNeuronC  = totalConnectionsPerNeuronC %>% filter(weightRelative>0.01 & !(name %in% PFLcNames$name)  & !(name %in% PFLbNames$name))
```

```{r}
## Filtering the main dataframe
lalOutputsA = lalOutputsA %>% filter(name %in% totalConnectionsPerNeuronA$name)
lalOutputsB = lalOutputsB %>% filter(name %in% totalConnectionsPerNeuronB$name)
lalOutputsC = lalOutputsC %>% filter(name %in% totalConnectionsPerNeuronC$name)
```

```{r}
ggplot(totalConnectionsPerNeuronA) + geom_point(aes(x=name,y=weightRelative,color=name)) + theme(axis.text.x = element_text(angle = 90)) + guides(color="none")
ggplot(totalConnectionsPerNeuronB) + geom_point(aes(x=name,y=weightRelative,color=name)) + theme(axis.text.x = element_text(angle = 90)) + guides(color="none")
ggplot(totalConnectionsPerNeuronC) + geom_point(aes(x=name,y=weightRelative,color=name)) + theme(axis.text.x = element_text(angle = 90)) + guides(color="none")
```

```{r,warning=FALSE,message=FALSE}
## This would be a nice plot if all PFL were homogeneously traced
ggplot(lalOutputsA) + geom_line(aes(x=partnerName,y=weightRelative,group=bodyid)) + facet_wrap(~name,scales="free_y") + theme(axis.text.x = element_text(angle = 90))
ggplot(lalOutputsB) + geom_line(aes(x=partnerName,y=weightRelative,group=bodyid)) + facet_wrap(~name,scales="free_y") + theme(axis.text.x = element_text(angle = 90))
ggplot(lalOutputsC) + geom_line(aes(x=partnerName,y=weightRelative,group=bodyid)) + facet_wrap(~name,scales="free_y") + theme(axis.text.x = element_text(angle = 90))
```


### Do output networks interact/overlap

```{r}
A_outputsMat = neuprint_connection_table(lalOutputsA$bodyid,"POST","LAL") %>%
                       mutate(partnerName = neuprint_get_meta(partner)[["name"]],name =neuprint_get_meta(bodyid)[["name"]])   %>% 
                       group_by(name) %>% 
                       mutate(weightRelative = weight/sum(weight)) %>%
                       ungroup() %>%
                       filter(partner %in% bodyid) 

B_outputsMat = neuprint_connection_table(lalOutputsB$bodyid,"POST","LAL")%>%
                       mutate(partnerName = neuprint_get_meta(partner)[["name"]],name =neuprint_get_meta(bodyid)[["name"]])   %>% 
                       group_by(name) %>% 
                       mutate(weightRelative = weight/sum(weight)) %>%
                       ungroup()%>%
                       filter(partner %in% bodyid) 

C_outputsMat = neuprint_connection_table(lalOutputsC$bodyid,"POST","LAL") %>%
                       mutate(partnerName = neuprint_get_meta(partner)[["name"]],name =neuprint_get_meta(bodyid)[["name"]])   %>% 
                       group_by(name) %>% 
                       mutate(weightRelative = weight/sum(weight)) %>%
                       ungroup()%>%
                       filter(partner %in% bodyid) 
```

```{r}
ggplot(A_outputsMat) + geom_tile(aes(name,partnerName,fill=weightRelative)) + theme(axis.text.x = element_text(angle = 90))
ggplot(B_outputsMat) + geom_tile(aes(name,partnerName,fill=weightRelative)) + theme(axis.text.x = element_text(angle = 90))
ggplot(C_outputsMat) + geom_tile(aes(name,partnerName,fill=weightRelative)) + theme(axis.text.x = element_text(angle = 90))
```


