---
title: "LAL explorations"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(ggforce)
library(igraph)
library(tidygraph)
library(ggraph)
source("neuprintQueryUtils.R")
source("table2ggraphUtils.R")
source("InputOutputByTypeUtils.R")
options(nat.plotengine = 'rgl')
```

### PFLs
Building connection table in steps to avoid timeouts.
```{r}
PFL1InOut <- buildInputsOutputsByType("PFL1.*")
PFL2InOut <- buildInputsOutputsByType("PFL2.*")
```

```{r}
PFL3InOut <- buildInputsOutputsByType("PFL3.*")
```

```{r}
PFLInOut <- bind_InoutLists(PFL1InOut,PFL2InOut,PFL3InOut)
```

Some general type renaming:
```{r}
## Divide PFL2 according to left/right
PFLInOut <- redefineTypeByNameInList(PFLInOut,typeList = c("PFL2"),pattern = "_L",newPostFixes = c("_L","_R"))
```

```{r}
## Divide PFL1  L/R taking into account the column 1 exception
PFLInOut <- redefineTypeByNameInList(PFLInOut,typeList = c("PFL1"),pattern = "_L[2-7]|_R1",newPostFixes = c("_L*","_R*"))
```

```{r}
## Divide PFL3  L/R taking into account the "irregular" neurons
PFLInOut <- redefineTypeByNameInList(PFLInOut,typeList = c("PFL3"),pattern = "(^.*_L(?!.*irreg))|(^.*_R.*irreg)",perl=TRUE,newPostFixes = c("_L*","_R*"))
```

```{r}
## Divide all the output neurons (except PFLs) according to Left/Right
outputTypes <- unique((PFLInOut[["outputs"]] %>% filter(!(grepl("PFL1.*|PFL2.*|PFL3.*",type.to))))[["type.to"]])
```

```{r}
PFLInOut <- lateralizeInputOutputList(PFLInOut,typeList=outputTypes)
```

## Number of instances for PFLs 

```{r}
PFLCounts <- ggplot(PFLInOut$names) + geom_bar(aes(x=name)) + theme(axis.text.x = element_text(angle = 90)) +guides(fill="none") + facet_wrap(~type,scales = "free_x") 
```


```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/LAL/PFLCounts.svg",PFLCounts,width = 20,height=12)
```

## Proportions of outputs of various types in the LAL
Averaging output contribution per name (~column)
```{r}
PFLsOutputLALProp <- PFLInOut$outputs_raw %>% filter(roi == "LAL(-GA)(R)") %>%
                     group_by(name.from) %>%
                     mutate(n_instances.from = length(unique(from))) %>%
                     ungroup() %>%
                     mutate(avgOutputContribution = outputContribution/n_instances.from)
```


```{r}
## Again, note that those proportions are artificially high because we're ignoring any synapse to a "non neuron" fragment
outputProportions <- ggplot(PFLsOutputLALProp) + geom_bar(aes(x=name.from,y=avgOutputContribution,fill=type.to),stat="identity") + theme(axis.text.x = element_text(angle = 90)) +guides(fill="none") + facet_wrap(~type.from,scales = "free_x") 
```

```{r}
outputProportions
```


```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/LAL/PFLPostProportions.svg",outputProportions,width = 20,height=12)
```

### Perspective from the outputs

How much do various types contribute to each neuron/type? Use that to filter for the rest?
```{r}
PFLLalOutputs <- makePyramidGraph(PFLInOut,ROIs = c("LAL(-GA)(R)"),polarity="outputs",plot = TRUE)
```

```{r}
PFLLalOutputs
```


```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/LAL/outputsListFig.svg",PFLLalOutputs,width=49,height=15)
```

```{r}
PFLOutputsProportions <- ggplot(PFLInOut$outputs %>% filter(roi == "LAL(-GA)(R)")) + geom_point(aes(x=reorder(type.to,desc(weightRelative)),y=weightRelative,color=type.to)) + theme_minimal() + theme(axis.text.x = element_text(angle = 90)) + guides(color="none") + labs(y="Relative weight in the LAL",x="Type name") + facet_wrap(~type.from,scales = "free_x")
PFLOutputsProportions
```


```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/LAL/PFLOutputsProportions.svg",PFLOutputsProportions,width = 15,height=10)
```


```{r}
ggplot(onlyConnections) + geom_point(aes(x=weightRelativeTotal,y=weightRelative,color=type)) + theme_minimal()
```


## What are those neurons?

```{r}
lalMesh <-  neuprint_ROI_mesh("LAL(-GA)(R)")
gallMesh <- neuprint_ROI_mesh("GA(R)")
```

```{r}
roiH <- neuprint_ROI_hierarchy()
```

## PFL1 outputs
```{r}
PFL1Outs <- (PFLInOut$outputs %>% filter(databaseTypeFrom == "PFL1" & roi == "LAL(-GA)(R)" & !grepl("PFL.*",databaseTypeTo)))
PFL1OutRef <- PFLInOut$outputsTableRef %>% filter(type %in% PFL1Outs$type.to)
```

```{r}
PFL1Out_InOut <- buildInputsOutputsByType(PFL1OutRef,selfRef = TRUE)
```

```{r}
## Add filter for significant connections. Make a function for bubble plot from in out list
PFL1Out_ROIOutputs <- PFL1Out_InOut$outputs_raw %>% group_by(roi,type.from)   %>%
             summarize(OutputWeight = sum(weight)) %>% rename(type = type.from)
```

```{r}
PFL1Out_ROIInputs <- PFL1Out_InOut$inputs_raw %>% group_by(roi,type.to)   %>%
             summarize(InputWeight = sum(weight)) %>% rename(type = type.to)
```

```{r}
PFL1Out_ROIs <- 
  full_join(PFL1Out_ROIInputs,PFL1Out_ROIOutputs,) %>% replace_na(list(InputWeight=0,OutputWeight=0)) %>%
                                          mutate(fullWeight = OutputWeight+InputWeight,
                                                 deltaWeight = (OutputWeight - InputWeight)/fullWeight)
```


```{r}
ggplot(PFL1Out_ROIs,aes(x=roi,y=type)) + geom_point(aes(size=fullWeight,alpha=deltaWeight))+geom_point(aes(size=fullWeight),shape=21) + theme_minimal()+ theme(axis.text.x = element_text(angle = 90)) 
```


```{r}
rois <- merge(PFLInOut$outputsTableRef,neuprint_get_roiInfo(PFLInOut$outputsTableRef),by="bodyid")
```

Picking the lowest level ROIs
```{r}
normalROIs <- neuprint_ROIs()
normalROIs <- normalROIs[sapply(normalROIs, function(r) !(r %in% roiH$parent))]
```


```{r}
connectionsPerROI <- rois %>% pivot_longer(-c(bodyid,name,type,pre,post,status,statusLabel,cellBodyFiber),names_to = c("ROI","pol"),names_sep = "\\.",values_to = "weight",values_drop_na=T) %>% 
                                filter(ROI %in% normalROIs)
connectionsPerROI$weightRelative <- connectionsPerROI$weight/unlist(sapply(1:length(connectionsPerROI$pol),function(i) connectionsPerROI[i,connectionsPerROI$pol[i]]))                       

```

```{r}
connectionsPerROI <- connectionsPerROI %>%
                     mutate(bodyid = as.character(bodyid)) %>% 
                     arrange(type)

connectionsPerROIPerType <- connectionsPerROI %>% group_by(type,ROI,pol) %>%
                                           summarize(weightRelative = mean(weightRelative),
                                                     weight = sum(weight)) %>% filter((type %in% filter(PFLInOut$outputs,roi == "LAL(-GA)(R)")[["type.to"]]) & !grepl("PFL",type))
head(connectionsPerROIPerType)
```

```{r}
LALOutputsInnervationPlot <- connectionsPerROIPerType %>% ggplot(aes(x=ROI,y=type,color=type)) + geom_point(aes(size=weight)) + facet_wrap(~pol,labeller=labeller(pol = c(post="Postsynapses",pre="Presynapses"))) + theme(axis.text.x = element_text(angle = 90)) + guides(color="none")
LALOutputsInnervationPlot
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/LAL/regionInnervationPlot.svg",LALOutputsInnervationPlot,width=25,height=13)
```

```{r}
lalOutputsF <- PFLInOut$outputs_raw %>% filter(paste0(type.from,type.to) %in% paste0(PFLInOut$outputs$type.from,PFLInOut$outputs$type.to) & roi == "LAL(-GA)(R)" & !(grepl("PFL1|PFL2|PFL3",type.to)))
```


```{r}
PFL_breakdown <- ggplot(lalOutputsF,aes(x=name.from,y=weightRelative,group=to,color=as.factor(to))) + geom_point() + geom_line() + facet_wrap(~databaseTypeFrom+type.to ,drop=TRUE,scales = "free_x") + theme_minimal() + theme(axis.text.x = element_text(angle = 90))+  guides(color="none")+ labs(y="Relative weight in the LAL",x="Input Neuron")
PFL_breakdown
```




```{r,warning=FALSE,message=FALSE}
## This would be a nice plot if all PFL were homogeneously traced
PFL1_breakdown <- ggplot(lalOutputsF %>% filter(databaseTypeFrom == "PFL1"),aes(x=name.from,y=weightRelative,group=to,color=as.factor(to))) + geom_point() + geom_line() + facet_wrap(~type.to,drop=TRUE) + theme_minimal() + theme(axis.text.x = element_text(angle = 90))+  guides(color="none")+ labs(y="Relative weight in the LAL",x="Input Neuron")
PFL2_breakdown <- ggplot(lalOutputsF %>% filter(databaseTypeFrom == "PFL2"),aes(x=name.from,y=weightRelative,group=to,color=as.factor(to))) + geom_point() + geom_line() + facet_wrap(~type.to,drop=TRUE) + theme_minimal() + theme(axis.text.x = element_text(angle = 90))+  guides(color="none")+ labs(y="Relative weight in the LAL",x="Input Neuron")
PFL3_breakdown <- ggplot(lalOutputsF %>% filter(databaseTypeFrom == "PFL3"),aes(x=name.from,y=weightRelative,group=to,color=as.factor(to))) + geom_point() + geom_line() + facet_wrap(~type.to,drop=TRUE) + theme_minimal() + theme(axis.text.x = element_text(angle = 90))+  guides(color="none")+ labs(y="Relative weight in the LAL",x="Input Neuron")
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/LAL/PFL1Bkdwn.svg",PFL1_breakdown,width=20,height=13)
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/LAL/PFL2Bkdwn.svg",PFL2_breakdown,width=20,height=13)

ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/LAL/PFL3Bkdwn.svg",PFL3_breakdown,width=20,height=13)
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/LAL/PFLFullBkdwn.svg",PFL_breakdown,width=49,height=49)
```


### Connections between those neurons

```{r}
outputsAdjMat = neuprint_connection_table(onlyConnections$partner,"PRE","LAL(-GA)(R)") %>%
                       mutate(partnerName = neuprint_get_meta(partner)[["name"]],
                              name =neuprint_get_meta(bodyid)[["name"]],
                              partnerType = unlist(sapply(partner,function(p) onlyConnections[["partnerType"]][onlyConnections[["partner"]] == p][1])),
                              type = unlist(sapply(bodyid,function(p) onlyConnections[["partnerType"]][onlyConnections[["partner"]] == p][1])))   %>% 
                       group_by(name) %>% 
                       mutate(weightRelative = weight/sum(weight)) %>%
                       ungroup() %>%
                       filter(partner %in% bodyid) 
#outputsAdjMat <- getConnectionTable_forSubset(onlyConnections$partner,onlyConnections$partner,"LAL(-GA)(R)")

```


```{r}
#outputsAdjMat$name <- factor(outputsAdjMat$name,levels = order(outputsAdjMat$PFL1,outputsAdjMat$PFL2L,outputsAdjMat$PFL2R,outputsAdjMat$PFL3))
#outputsAdjMat$partnerName <- factor(outputsAdjMat$partnerName,levels = order(outputsAdjMat$PFL1,outputsAdjMat$PFL2L,outputsAdjMat$PFL2R,outputsAdjMat$PFL3))
```

```{r}

betweenGraph <- outputsAdjMat %>% 
                 #   group_by(type,partnerType) %>%
                #    summarize(weightRelative=mean(weightRelative)) %>%
                    filter(weightRelative>0.01) 

outputNodes <- data.frame(bodyid = unique(c(betweenGraph$bodyid,betweenGraph$partner)),stringsAsFactors = F) %>% 
               mutate(inputWeight = sapply(bodyid, function(b) sum(onlyConnections[["weightRelative"]][onlyConnections[["partner"]]==b]))) %>%
               mutate(name= unlist(sapply(bodyid,function(p) onlyConnections[["partnerName"]][onlyConnections[["partner"]] == p][1]))) %>%
               mutate(type = unlist(sapply(bodyid,function(p) onlyConnections[["partnerType"]][onlyConnections[["partner"]] == p][1]))) %>%
               mutate(inputType = sapply(bodyid, function(n) paste0(unique(onlyConnections[["type"]][onlyConnections[["partner"]] == n]),collapse=",")))

betweenGraph <- betweenGraph %>%
                mutate(from = sapply(partner, function(f) which(f == outputNodes$bodyid)),
                       to = sapply(bodyid, function(f) which(f == outputNodes$bodyid)))
                                 



```

```{r}

betweenGraphT <- outputsAdjMat %>% 
                    group_by(type,partnerType) %>%
                    summarize(weightRelative=mean(weightRelative)) %>%
                    filter(weightRelative>0.01) 

outputNodesT <- data.frame(type = unique(c(betweenGraphT$type,betweenGraphT$partnerType)),stringsAsFactors = F) %>% 
               mutate(inputWeight = sapply(type, function(b) mean(onlyConnections[["weightRelative"]][which(onlyConnections[["partnerType"]]==b)]))) %>%
               mutate(inputType = sapply(type, function(n) paste0(unique(onlyConnections[["type"]][which(onlyConnections[["partnerType"]] == n)]),collapse=",")))

betweenGraphT <- betweenGraphT %>%
                mutate(from = sapply(partnerType, function(f) which(f == outputNodesT$type)),
                       to = sapply(type, function(f) which(f == outputNodesT$type)))
                                 



```

```{r}
betweenTblGraph <- tbl_graph(outputNodes,betweenGraph)
betweenTblGraphT <- tbl_graph(outputNodesT,betweenGraphT)
```


```{r}
betweenGraphFig <- ggraph(betweenTblGraph) + geom_edge_parallel(aes(col=weightRelative,alpha=weightRelative),arrow = arrow(length = unit(3, 'mm')), 
                  start_cap = circle(3, 'mm'),
                  end_cap = circle(3, 'mm')) + scale_edge_color_continuous(trans="reverse")+geom_node_point(aes(col=inputType,size=inputWeight)) + geom_node_text(aes(label=type),size=4) + geom_edge_loop(alpha=0.2) + scale_color_brewer(palette = "Set1")
```

```{r}
betweenGraphFigT <- ggraph(betweenTblGraphT) + geom_edge_fan(aes(col=weightRelative,alpha=weightRelative),arrow = arrow(length = unit(3, 'mm')), 
                  start_cap = circle(3, 'mm'),
                  end_cap = circle(3, 'mm')) + scale_edge_color_continuous(trans="reverse")+geom_node_point(aes(col=inputType,size=inputWeight)) + geom_node_text(aes(label=type),size=4) + geom_edge_loop(alpha=0.2) + scale_color_brewer(palette = "Set1")
```



```{r}
betweenGraphFigT
```



```{r}
ggsave("/home/romain/outputsBetweenFig.svg",betweenGraphFig,width=25,height=12)
ggsave("/home/romain/outputsBetweenFigPerType.svg",betweenGraphFigT,width=25,height=12)
```

```{r}
test <- neuprint_read_neuron_simple(1107561814)
```
```{r}
plot3d(test,WithNodes = F)
```


### Relation to ExR neurons?

```{r}
bd <- neuprint_search("ExR8.*")
```

```{r}
test <- neuprint_common_connectivity(c(onlyConnections$partner,bd$bodyid),prepost="PRE",all_segments = FALSE)
```






