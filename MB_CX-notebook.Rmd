---
title: "MB-CX connections"
output: html_notebook
---

### Load the libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(plotly)
library(dplyr)
library(pbapply)

# Go to the neurpintR-notebooks directory before loading these functions
source("pathways.R")
source("visualizeConnectivityTables.R")
source("neuprintQueryUtils.R")
source("inputOutputRegionsVis.R")
source("table2ggraphUtils.R")
source("InputOutputByTypeUtils.R")
source("GetNeuronsInRoi.R")
source("romainNeuronsInRoi.R")

options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose save/plot directories
```{r}
# Directory to save data to.
SaveDir = "/Users/danc/Documents/Data_Analysis/FIBSEM_Analysis"

# Directory to save plots to.
PlotDir = "/Users/danc/Documents/Data_Analysis/FIBSEM_Analysis"
```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint
```{r}
# neuprint_login()
neuprint_login(config=httr::set_config(httr::config(ssl_verifypeer = 0L)))
```

### Get a list of all ROIs
```{r}
# Get all ROIs
allROIs = neuprint_ROIs()
```

### Get all CX neurons
```{r}
# Get all CX neurons
allCXneurons <- getNeuronsInRoi("CX")
head(allCXneurons)
```

### Find all CX neurons and their connected ROIs
```{r}
# Get the synapse counts in all ROIs for all CX neurons
Output = Get_SynapseCount_In_Rois("CX", FALSE)
list2env(Output ,.GlobalEnv)
remove(Output)

# Filter data by synapse counts
roi_Connect_bytype_df = filter(roi_Connect_bytype_df, count > 0 )
roi_Connect_df = filter(roi_Connect_df, count > 0 )
```

### Find all CX neuron types with input/output in the MB
```{r}
CXtypes_connect2MB <- roi_Connect_bytype_df  %>% filter(roi == "MB")
```

### Make plot of all these neurons and histogram of synapse counts
```{r}
# Plot all of the ROIs (and sub ROIs) that all MB-touching CX neurons innervate
p0 <- ggplot(CXtypes_connect2MB, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("All CX Neuron Types with Input/Output in MB")
ggsave(paste(PlotDir, "All_CX_","inputOutputInMB_perType.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 30, height = 20, units ="in", dpi = 300, limitsize = TRUE)

# Plot histogram of synapse counts
HistDat = data.frame(NumberOfSyns = CXtypes_connect2MB$count)
p1 <- ggplot(HistDat, aes(x=NumberOfSyns)) + geom_histogram(binwidth=10) + xlim(0, 500) +
  ylim(0, length(HistDat$NumberOfSyns[HistDat$NumberOfSyns>2 & HistDat$NumberOfSyns<=11]) )
print(p1)

```




### Get CX neurons separated by ROIs
```{r}
# Get all CX neurons
allEBneurons <- getNeuronsInRoi("EB")
allFBneurons <- getNeuronsInRoi("FB")
allPBneurons <- getNeuronsInRoi("PB")
allNOneurons <- getNeuronsInRoi("NO")
```

### Get all LAL neurons
```{r}
allLAL_Rneurons <- getNeuronsInRoi("LAL(R)")
allLAL_Lneurons <- getNeuronsInRoi("LAL(L)")

```

### Get CX neurons with inputs from MB directly
```{r}
# Get all MB(+ACA)(R) neurons
allMB_ACA_Rneurons <- getNeuronsInRoi("MB(+ACA)(R)")

# Find those that innervate the CX
FbBodiesROIinfo <- neuprint_get_roiInfo(allFBneurons$bodyid)
FbBodiesInfoInMB <- FbBodiesROIinfo  %>% filter(MB.pre +MB.post > 30)
FBneuronsInMB <- allFBneurons %>% filter(bodyid %in% FbBodiesInfoInMB$bodyid)
```

### Get CX neurons with outputs in MB directly


### Get the MBONs
```{r}
# Find all MBONs
MBON_Names <- neuprint_search("MBON.*")
head(MBON_Names)
```

### Find who the MBONs talk to
```{r}
# Find the postsynaptic partners of all MBONs
MBON_PostConnections <- getConnectionTable(MBON_Names,synapseType = "POST",synThresh=3)
head(MBON_PostConnections)
```

### Among these, find who innervate the CX
```{r}
# Find the MBON postsynaptic partners that innervate the FB
outputROIinfo <- neuprint_get_roiInfo(MBON_PostConnections$to)
FBOutputs <- outputROIinfo  %>% filter(FB.pre +FB.post > 30)
MBONFbConnections <- MBON_PostConnections %>% filter(to %in% FBOutputs$bodyid)
```

### Plot the connectivity matrix
```{r}
MBONFbConnections %>% plotConnectivityMatrix
```

### Make the TypeToType connection table from MBON to CX
```{r}
MBONFbTypeToTypeConnections <- getTypeToTypeTable(MBONFbConnections)
head(MBONFbTypeToTypeConnections)
```

### Plot the TypeToType connetivity matrix
```{r}
plotConnectivityMatrix(MBONFbTypeToTypeConnections,byGroup = "type")
```


### Make type-by-type synapse heat map in the CX


### Get the FB neuron types
```{r}

```

### Find all connections between all MBONs and FB neurons
