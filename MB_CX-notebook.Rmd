---
title: "MB-CX connections"
output: html_notebook
---

### Load the libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(plotly)
library(dplyr)
library(pbapply)
library(tidygraph)
library(ggraph)
library(gridExtra)

# Go to the neurpintR-notebooks directory before loading these functions
source("pathways.R")
source("visualizeConnectivityTables.R")
source("neuprintQueryUtils.R")
source("inputOutputRegionsVis.R")
source("R/table2ggraphUtils.R")
source("InputOutputByTypeUtils.R")
source("GetNeuronsInRoi.R")
source("FBNetworkVisUtils.R")
source("R/rois.R")
source("R/supertypeUtils.R")
source("colorCodeLookup.R")

options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose save/plot directories
```{r}
# Directory to save data to.
SaveDir = "/Users/danc/Dropbox (HHMI)/WorkDrop/Data/FIBSEM_Analysis"

# Directory to save plots to.
PlotDir = "/Users/danc/Dropbox (HHMI)/WorkDrop/Data/FIBSEM_Analysis"
```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint
```{r}
# neuprint_login()
neuprint_login(config=httr::set_config(httr::config(ssl_verifypeer = 0L)))
```

### Trace MBON to CX Connections and Graph Pathways ###
```{r}

### Get CX neurons with outputs in MB directly

### Get the MBONs
# Find all MBONs
MBON_Names <- neuprint_search("MBON.*")
# head(MBON_Names)

### Find who the MBONs talk to
# Find the postsynaptic partners of all MBONs
MBON_PostConnections <- getConnectionTable(MBON_Names,synapseType = "POST",synThresh=5)
# head(MBON_PostConnections)

### Among these, find who innervate the CX
# Find the MBON postsynaptic partners that innervate the FB
MBONtargetROIinfo <- neuprint_get_roiInfo(MBON_PostConnections$to)
MBONtargetInCX_ROIinfo <- MBONtargetROIinfo  %>% filter(CX.pre + CX.post > 10)
MBON_CX_Connections <- MBON_PostConnections %>% filter(to %in% MBONtargetInCX_ROIinfo$bodyid)
# head(MBON_CX_Connections)

### Plot the connectivity matrix
MBON_CX_Connections %>% plotConnectivityMatrix

### Make the TypeToType connection table from MBON to CX
MBON_CX_TypeToTypeConnections <- getTypeToTypeTable(MBON_CX_Connections)
# head(MBON_CX_TypeToTypeConnections)

### Plot the TypeToType connetivity matrix based on the connectionMeasure of "weightRelative"
p3 <- plotConnectivityMatrix(MBON_CX_TypeToTypeConnections,byGroup = "type",connectionMeasure="weightRelative")
print(p3)
ggsave("MBON_CX_ConnectionsByType_weightRelative.eps", plot=p3, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)

### Pull significant MBON_CX_TypeToTypeConnections based on "weightRelative"
# Find Strongly connected MBON targets in the CX
StrongMBON_CX_TypeToTypeConnections <- MBON_CX_TypeToTypeConnections  %>% filter(weightRelative > 0.05)
StrongMBON2CX_TargetsType = unique(pull(StrongMBON_CX_TypeToTypeConnections, type.to))
StrongMBON2CX_TargetIds <- neuprint_search(StrongMBON2CX_TargetsType, field='type')
# head(StrongMBON2CX_TargetIds)

# Find the postsynaptic partners of StrongMBON2CX_TargetIds
StrongMBON2CX_TargetsCnctTable <- getConnectionTable(StrongMBON2CX_TargetIds,synapseType="POST",synThresh=5)
# head(StrongMBON2CX_TargetsCnctTable)
StrongMBON2CX_TargetsType2TypeTable <- getTypeToTypeTable(StrongMBON2CX_TargetsCnctTable)
# head(StrongMBON2CX_TargetsType2TypeTable)

# Plot and save the StrongMBON2CX_TargetsType2TypeTable based on the connectionMeasure of "weightRelative"
p4 <- plotConnectivityMatrix(StrongMBON2CX_TargetsType2TypeTable,byGroup="type",connectionMeasure="weightRelative")
print(p4)
ggsave("StrongMBON2CXTargetsType2TypeCnctTable_weightRelative.eps", plot=p4, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)

```

#### put a break here

```{r}

### Plot the pathways from MBONs to CX
# Get the subset of strong connections in the FB
ROI <- "FB"
StrongMBON2CXTargetsToPostInFB <- getConnectionTable_forSubset(StrongMBON2CX_TargetIds$bodyid,
                                       StrongMBON2CX_TargetsCnctTable$to,
                                       ROI)
StrongMBON2CXTargetsToPostInFB_Type2TypeTab <- getTypeToTypeTable(StrongMBON2CXTargetsToPostInFB)
# head(StrongMBON2CXTargetsToPostInFB_Type2TypeTab)

# Set up the layout for the pathway plot
types <- unique(c(unique(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.from),unique(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.to)))
xyLookup = data.frame(type = types,
                      x = c(-1,vector(mode = "numeric",length = (length(types)-1))),
                      y = c(0,seq(-1,1,length.out = (length(types)-1))))

# Graph the TypeToType ConnTable using the combined lookupTable
gg_MBONtargetTab <- graphConTab(StrongMBON2CXTargetsToPostInFB_Type2TypeTab,xyLookup,FALSE,TRUE)
gg_MBONtargetTab <- gg_MBONtargetTab + scale_y_reverse()
print(gg_MBONtargetTab)
ggsave("gg_MBONtargetTab.svg", plot=gg_MBONtargetTab, device="svg", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```

#### put a break here

```{r}

# Find the most strongly connected targets of StrongMBON2CXTargets based on "outputContribution"
StrongMBON2CX2FBtargets_Type2TypeTab <- StrongMBON2CXTargetsToPostInFB_Type2TypeTab  %>% filter(outputContribution > 0.05)
StrongMBON2CX2FBtargetsTypes = unique(pull(StrongMBON2CX2FBtargets_Type2TypeTab, type.to))
StrongMBON2CX2FBtargetsIds <- neuprint_search(StrongMBON2CX2FBtargetsTypes, field='type')
# head(StrongMBON2CX2FBtargetsIds)

# Find the postsynaptic partners of StrongMBON2CX2FBtargetsIds
StrongMBON2CX2FBtargetsConnTab <- getConnectionTable(StrongMBON2CX2FBtargetsIds,synapseType="POST",synThresh=5)
# head(StrongMBON2CX2FBtargetsConnTab)
StrongMBON2CX2FBtargets_Type2TypeTab <- getTypeToTypeTable(StrongMBON2CX2FBtargetsConnTab)
# head(StrongMBON2CX2FBtargets_Type2TypeTab)

# Plot and save the StrongMBON2CX2FBtargets_Type2TypeTab based on the connectionMeasure of "weightRelative"
connPlot <- plotConnectivityMatrix(StrongMBON2CX2FBtargets_Type2TypeTab,byGroup="type",connectionMeasure="weightRelative")
print(connPlot)
ggsave("StrongMBON2CX2FBtargets_Type2TypeTab_weightRelative.eps", plot=connPlot, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)

```

```{r}

### Plot the pathways from StrongMBON2CX2FBtargets to their strongest FB targets
# Get the subset of strong connections in the FB
ROI <- "FB"
StrongMBON2CX2SecondaryFBtargetsConnTab <- getConnectionTable_forSubset(StrongMBON2CX2FBtargetsIds$bodyid,
                                       StrongMBON2CX2FBtargetsConnTab$to,
                                       ROI)
StrongMBON2CX2SecondaryFBtargets_Type2TypeTab <- getTypeToTypeTable(StrongMBON2CX2SecondaryFBtargetsConnTab)
# head(StrongMBON2CX2SecondaryFBtargets_Type2TypeTab)

# Set up the layout for the pathway plot
types <- unique(c(unique(StrongMBON2CX2SecondaryFBtargets_Type2TypeTab$type.from),unique(StrongMBON2CX2SecondaryFBtargets_Type2TypeTab$type.to)))
xyLookup = data.frame(type = types,
                      x = c(-1,vector(mode = "numeric",length = (length(types)-1))),
                      y = c(0,seq(-1,1,length.out = (length(types)-1))))

# Graph the TypeToType ConnTable using the combined lookupTable
gg_MBONtargetTab <- graphConTab(StrongMBON2CX2SecondaryFBtargets_Type2TypeTab,xyLookup,FALSE,TRUE)
gg_MBONtargetTab <- gg_MBONtargetTab + scale_y_reverse()
print(gg_MBONtargetTab)
ggsave("StrongMBON2CX2SecondaryFBtargets_Type2TypeTab.svg", plot=gg_MBONtargetTab, device="svg", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```

# Histrogram of secondary to tertiary MBON targets connectoins weightRelative
```{r}
# hist(StrongMBON2CX2SecondaryFBtargets_Type2TypeTab$weightRelative,breaks=10)
```

# Pick strong secondary to tertiary MBON targets connections based on weightRelative
```{r}
# Pick strong secondary to tertiary MBON targets connections based on weightRelative
StrongMBON2CX2Secondary_TertiaryFBtargets_Type2TypeTab <- StrongMBON2CX2SecondaryFBtargets_Type2TypeTab  %>% filter(weightRelative > 0.05)

# Set up the layout for the pathway plot
types <- unique(c(unique(StrongMBON2CX2Secondary_TertiaryFBtargets_Type2TypeTab$type.from),unique(StrongMBON2CX2Secondary_TertiaryFBtargets_Type2TypeTab$type.to)))
xyLookup = data.frame(type = types,
                      x = c(-1,vector(mode = "numeric",length = (length(types)-1))),
                      y = c(0,seq(-1,1,length.out = (length(types)-1))))

# Graph the TypeToType ConnTable using the combined lookupTable
gg_MBONtargetTab <- graphConTab(StrongMBON2CX2Secondary_TertiaryFBtargets_Type2TypeTab,xyLookup,FALSE,TRUE)
gg_MBONtargetTab <- gg_MBONtargetTab + scale_y_reverse()
print(gg_MBONtargetTab)
ggsave("StrongMBON2CX2Secondary_TertiaryFBtargets_Type2TypeTab.svg", plot=gg_MBONtargetTab, device="svg", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)

```








### Plot the TypeToType connetivity matrix based on the connectionMeasure of "outputContribution"
```{r}
p5 <- plotConnectivityMatrix(MBON_CX_TypeToTypeConnections,byGroup = "type",connectionMeasure="outputContribution")
print(p5)
ggsave("MBON_CX_ConnectionsByType_outputContribution.eps", plot=p5, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```


### Test DanTE's code: Plot the PFNd,v to Delta6B, Delta6B to others pathways
```{r}
tp1 = c("PFNd","PFNv")
tp2 = c("Delta6B")

ROI <- "FB"

conTab1 <- getConnectionTable_forSubset(getBodyIdsForList(tp1)$bodyid,
                                       getBodyIdsForList(tp2)$bodyid,
                                       ROI)
conTab1_Clean <- getTypeToTypeTable(conTab1)

conTab2 <- getConnectionTable(getBodyIdsForList(tp2)$bodyid,"POST",ROI,synThresh = 3)
conTab2 <- conTab2[which(!is.na(conTab2$type.to)),]
conTab2 <- conTab2[which(!grepl("FB",conTab2$type.to)),]
conTab2 <- conTab2[which(!grepl("EL",conTab2$type.to)),]
conTab2_Clean <- getTypeToTypeTable(conTab2)

conTab_Clean <- rbind(conTab1_Clean,conTab2_Clean)

gg_PFNdToD6B <- graphConTab(conTab_Clean,xyLookupTableInner(),FALSE,TRUE)
gg_PFNdToD6B <- gg_PFNdToD6B + xlim(-0.75,0.75) + ylim(0.5,3.5) + scale_y_reverse()
print(gg_PFNdToD6B)
ggsave("PFNdvToDelta6B.pdf", plot=gg_PFNdToD6B, device="pdf", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)

```

### End of DanTE's Code





### Get a list of all ROIs
```{r}
# Get all ROIs
allROIs = neuprint_ROIs()
```

### Get all CX neurons
```{r}
# Get all CX neurons
allCXneurons <- getNeuronsInRoiTable("CX")
head(allCXneurons)
```

### Find all CX neurons and their connected ROIs
```{r}
# Get the synapse counts in all ROIs for all CX neurons
Output = Get_SynapseCount_In_Rois("CX", FALSE)
list2env(Output ,.GlobalEnv)
remove(Output)

# Filter data by synapse counts
roi_Connect_bytype_df = filter(roi_Connect_bytype_df, count > 5 )
roi_Connect_df = filter(roi_Connect_df, count > 5 )
```

### Find all CX neuron types with input/output in the MB
```{r}
CXtypes_connect2MB <- roi_Connect_bytype_df  %>% filter(roi == "MB")
head(CXtypes_connect2MB)
```

### Make a plot of all these neuron types and synapse counts
```{r}
# Plot the synapse counts of all MB-touching CX neuron types
p0 <- ggplot(data=CXtypes_connect2MB, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("All CX Neuron Types with Input/Output in MB")

# Show the plot
print(p0)

# Save the plot
ggsave("allCXtypes_inputOutputInMB.eps", plot=p0, device="eps", path=PlotDir, scale=1, 
       width=30, height=20, units="in", dpi=300, limitsize=TRUE)
```

### Make a histogram of synapse counts
```{r}
# Plot histogram of synapse counts
HistDat = data.frame(NumberOfSyns = CXtypes_connect2MB$count)
p1 <- ggplot(data=HistDat, aes(x=NumberOfSyns)) + geom_histogram(binwidth=10) + xlim(0, 500) +
  ylim(0, length(HistDat$NumberOfSyns[HistDat$NumberOfSyns>2 & HistDat$NumberOfSyns<=11]) )
print(p1)

```

### Get CX neurons separated by ROIs
```{r}
# Get all CX neurons
allEBneurons <- getNeuronsInRoiTable("EB")
allFBneurons <- getNeuronsInRoiTable("FB")
allPBneurons <- getNeuronsInRoiTable("PB")
allNOneurons <- getNeuronsInRoiTable("NO")
```

### Get all LAL neurons
```{r}
# Get all LAL neurons
allLAL_Rneurons <- getNeuronsInRoiTable("LAL(R)")
allLAL_Lneurons <- getNeuronsInRoiTable("LAL(L)")
```

### Get MB neurons innervating the CX directly, using Romain's functions
```{r}
# Get all MB neurons
allMB_L_neurons <- getNeuronsInRoiTable("MB(L)")
allMB_R_neurons <- getNeuronsInRoiTable("MB(R)")
allMB_neurons <- union(allMB_L_neurons,allMB_R_neurons)

# Find those that innervate the CX
MbBodiesROIinfo <- neuprint_get_roiInfo(allMB_neurons$bodyid)
MbBodiesROIinfoInCX <- MbBodiesROIinfo  %>% filter(CX.pre + CX.post > 10)
MBneuronsInCX <- allMB_neurons %>% filter(bodyid %in% MbBodiesROIinfoInCX$bodyid)
```

### Make type-by-type synapse heat map in the CX


### Get the FB neuron types
```{r}

```

### Find all connections between all MBONs and FB neurons
