---
title: "MB-CX connections"
output: html_notebook
---

### Load the libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(plotly)
library(dplyr)
library(pbapply)

# Go to the neurpintR-notebooks directory before loading these functions
source("pathways.R")
source("visualizeConnectivityTables.R")
source("neuprintQueryUtils.R")
source("inputOutputRegionsVis.R")
source("R/table2ggraphUtils.R")
source("InputOutputByTypeUtils.R")
source("GetNeuronsInRoi.R")
source("R/rois.R")

options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose save/plot directories
```{r}
# Directory to save data to.
SaveDir = "/Users/danc/Dropbox (HHMI)/WorkDrop/Data/FIBSEM_Analysis"

# Directory to save plots to.
PlotDir = "/Users/danc/Dropbox (HHMI)/WorkDrop/Data/FIBSEM_Analysis"
```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint
```{r}
# neuprint_login()
neuprint_login(config=httr::set_config(httr::config(ssl_verifypeer = 0L)))
```

### Get a list of all ROIs
```{r}
# Get all ROIs
allROIs = neuprint_ROIs()
```

### Get all CX neurons
```{r}
# Get all CX neurons
allCXneurons <- getNeuronsInRoiTable("CX")
head(allCXneurons)
```

### Find all CX neurons and their connected ROIs
```{r}
# Get the synapse counts in all ROIs for all CX neurons
Output = Get_SynapseCount_In_Rois("CX", FALSE)
list2env(Output ,.GlobalEnv)
remove(Output)

# Filter data by synapse counts
roi_Connect_bytype_df = filter(roi_Connect_bytype_df, count > 5 )
roi_Connect_df = filter(roi_Connect_df, count > 5 )
```

### Find all CX neuron types with input/output in the MB
```{r}
CXtypes_connect2MB <- roi_Connect_bytype_df  %>% filter(roi == "MB")
head(CXtypes_connect2MB)
```

### Make a plot of all these neuron types and synapse counts
```{r}
# Plot the synapse counts of all MB-touching CX neuron types
p0 <- ggplot(data=CXtypes_connect2MB, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("All CX Neuron Types with Input/Output in MB")

# Show the plot
print(p0)

# Save the plot
ggsave("allCXtypes_inputOutputInMB.eps", plot=p0, device="eps", path=PlotDir, scale=1, 
       width=30, height=20, units="in", dpi=300, limitsize=TRUE)
```

### Make a histogram of synapse counts
```{r}
# Plot histogram of synapse counts
HistDat = data.frame(NumberOfSyns = CXtypes_connect2MB$count)
p1 <- ggplot(data=HistDat, aes(x=NumberOfSyns)) + geom_histogram(binwidth=10) + xlim(0, 500) +
  ylim(0, length(HistDat$NumberOfSyns[HistDat$NumberOfSyns>2 & HistDat$NumberOfSyns<=11]) )
print(p1)

```

### Get CX neurons separated by ROIs
```{r}
# Get all CX neurons
allEBneurons <- getNeuronsInRoiTable("EB")
allFBneurons <- getNeuronsInRoiTable("FB")
allPBneurons <- getNeuronsInRoiTable("PB")
allNOneurons <- getNeuronsInRoiTable("NO")
```

### Get all LAL neurons
```{r}
# Get all LAL neurons
allLAL_Rneurons <- getNeuronsInRoiTable("LAL(R)")
allLAL_Lneurons <- getNeuronsInRoiTable("LAL(L)")
```

### Get MB neurons innervating the CX directly, using Romain's functions
```{r}
# Get all MB neurons
allMB_L_neurons <- getNeuronsInRoiTable("MB(L)")
allMB_R_neurons <- getNeuronsInRoiTable("MB(R)")
allMB_neurons <- union(allMB_L_neurons,allMB_R_neurons)

# Find those that innervate the CX
MbBodiesROIinfo <- neuprint_get_roiInfo(allMB_neurons$bodyid)
MbBodiesROIinfoInCX <- MbBodiesROIinfo  %>% filter(CX.pre + CX.post > 10)
MBneuronsInCX <- allMB_neurons %>% filter(bodyid %in% MbBodiesROIinfoInCX$bodyid)
```

### Good data etc up to here ###


### Get CX neurons with outputs in MB directly


### Get the MBONs
```{r}
# Find all MBONs
MBON_Names <- neuprint_search("MBON.*")
head(MBON_Names)
```

### Find who the MBONs talk to
```{r}
# Find the postsynaptic partners of all MBONs
MBON_PostConnections <- getConnectionTable(MBON_Names,synapseType = "POST",synThresh=5)
head(MBON_PostConnections)
```

### Among these, find who innervate the CX
```{r}
# Find the MBON postsynaptic partners that innervate the FB
MBONtargetROIinfo <- neuprint_get_roiInfo(MBON_PostConnections$to)
MBONtargetInCX_ROIinfo <- MBONtargetROIinfo  %>% filter(CX.pre + CX.post > 10)
MBON_CX_Connections <- MBON_PostConnections %>% filter(to %in% MBONtargetInCX_ROIinfo$bodyid)
head(MBON_CX_Connections)
```

### Plot the connectivity matrix
```{r}
MBON_CX_Connections %>% plotConnectivityMatrix
```

### Make the TypeToType connection table from MBON to CX
```{r}
MBON_CX_TypeToTypeConnections <- getTypeToTypeTable(MBON_CX_Connections)
head(MBON_CX_TypeToTypeConnections)
```

### Plot the TypeToType connetivity matrix based on the connectionMeasure of "weightRelative"
```{r}
p3 <- plotConnectivityMatrix(MBON_CX_TypeToTypeConnections,byGroup = "type",connectionMeasure="weightRelative")
print(p3)
ggsave("MBON_CX_ConnectionsByType_weightRelative.eps", plot=p3, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```

### Pull significant MBON_CX_TypeToTypeConnections based on "weightRelative"
```{r}
# Find Strongly connected MBON to CX Neurons
StrongMBON_CX_TypeToTypeConnections <- MBON_CX_TypeToTypeConnections  %>% filter(weightRelative > 0.05)
StrongMBON2CX_TargetsType = unique(pull(StrongMBON_CX_TypeToTypeConnections, type.to))
StrongMBON2CX_Targets <- neuprint_search(StrongMBON2CX_TargetsType, field='type')
# head(StrongMBON2CX_Targets)

# Find the postsynaptic partners of StrongMBON2CX_Targets
StrongMBON2CX_TargetsCnctTable <- getConnectionTable(StrongMBON2CX_Targets,synapseType="POST",synThresh=5)
# head(StrongMBON2CX_TargetsCnctTable)
StrongMBON2CX_TargetsType2TypeTable <- getTypeToTypeTable(StrongMBON2CX_TargetsCnctTable)
# head(StrongMBON2CX_TargetsType2TypeTable)

# Plot and save the StrongMBON2CX_TargetsType2TypeTable based on the connectionMeasure of "weightRelative"
p4 <- plotConnectivityMatrix(StrongMBON2CX_TargetsType2TypeTable,byGroup="type",connectionMeasure="weightRelative")
print(p4)
ggsave("StrongMBON2CXTargetsType2TypeCnctTable_weightRelative.eps", plot=p4, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)


```



### Plot the TypeToType connetivity matrix based on the connectionMeasure of "outputContribution"
```{r}
p5 <- plotConnectivityMatrix(MBON_CX_TypeToTypeConnections,byGroup = "type",connectionMeasure="outputContribution")
print(p5)
ggsave("MBON_CX_ConnectionsByType_outputContribution.eps", plot=p5, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```


### Make type-by-type synapse heat map in the CX


### Get the FB neuron types
```{r}

```

### Find all connections between all MBONs and FB neurons
