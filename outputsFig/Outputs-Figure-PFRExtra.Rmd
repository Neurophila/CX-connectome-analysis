---
title: "PFR panels"
output: html_notebook
---

```{r}
library(neuprintr)
library(tidyverse)
library(cowplot)
library(patchwork)
library(neuprintrExtra)
library(nat)
library(Cairo)
library(paletteer)
library(tidygraph)
library(ggraph)
library(igraph)
```

```{r message=FALSE}
source("outputFunctions-display.R")
source("outputFunctions-core.R")
source("../R/paperTheme_linux.R")
source("../R/neuronMeshes.R")
#source("../R/table2ggraphUtils.R")
outputsFolder <- "~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/figure3-CX2CX/"

```

```{r}
load("outputsBasics.RData")
load("mainTargetsAndConns.Rdata")
load("mainTargetsAndConns.Rdata")
CX_outGraphRed <- readRDS("output_graph_reduced.rds")
endpoints <- readRDS("endpoints-influenceFullSummary.rds")

endpointsStrong <- filter(endpoints,Path_weight>=0.5)

CX_outGraphRed <- CX_outGraphRed %N>% 
   mutate(influencing=endpointsStrong$supertype.to[match(type,endpointsStrong$type.from)]) %E>% 
    mutate(influencing.from = .N()$influencing[match(type.from,.N()$type)])
```

```{r}

mainFFTargetsS <- mainFFTargets %>% rename(type=type.to,databaseType=databaseType.to) %>% supertype() %>% selectSupertypeSet(default_level = 3,exceptions=list("Terra incognita"=2))



customGraphPalette <- supertype3Palette[names(supertype3Palette) %in% filter(mainFFConns, Path_weight>0.005)$supertype3.to]
extraPal <- p36[!p36 %in% customSupertypePalette & !p36 %in% customGraphPalette]
extraLevs <- unique(mainFFConns$supertype2.to[mainFFConns$supertype3.to=="Terra incognita"])
extraPal <- extraPal[1:length(extraLevs)]
names(extraPal) <- extraLevs
customGraphPalette <- c(customGraphPalette,extraPal,"Source"="red")
```

```{r}
PFRGraph <- plotSubgraph(c("PFR_b_L*","PFR_a_L*"),graph=CX_outGraphRed,layout="stress") + coord_cartesian(clip="off")
PFRGraph
```

```{r}
save_plot(paste0(outputsFolder,"PFRGraphOut.svg"),PFRGraph,base_height = 5,base_width=7)
```


```{r}
displayAnatomies(neurons=list(
   "LAL"=filter(mainFFTargetsNeurons,type %in% c("LAL002_R"))$bodyid
),ROIs = c("FB","LAL(R)","CRE(R)"),saveName = "LAL002",neuronPalette = c(customGraphPalette,customSupertypePalette))
```