---
title: "CX to CX connections (figure 57)"
output: html_notebook
---

Where the data has been saved (by "Outputs-Core.Rmd"):
```{r}
dataFolder="data"
```

## Figure 57
Generating a summary per type (one has to restrict it to outputs of CX output neurons):
```{r}
CXInfluenceSummary <- group_by(filter(CXInfluence,type.from %in% CXOutputTypes),type.from,kind) %>%
  summarize(totalOC=sum(Path_weight)) %>% 
  ungroup() %>% 
  mutate(databaseType.from=type.from) %>% 
  supertype()
```

```{r}
CXInfluenceSummaryPlot <- ggplot(CXInfluenceSummary,aes(x=type.from,y=totalOC)) + geom_col(aes(fill=kind)) + theme_paper()+ theme(strip.text.x=element_blank(),axis.text.x = element_text(angle=90,hjust = 1,vjust=0.5))+facet_grid(.~supertype3.from,scales = "free",space="free") + scale_fill_paletteer_d("ggthemes::Tableau_20",name="Target type") + ylab("normalized pathway weight") + xlab("")
CXInfluenceSummaryPlot
```


```{r}
CXInfluenceOther <- filter(CXInfluence,!(databaseType.from %in% localNeuropileNeurons) & type.from %in% CXOutputTypes) %>% group_by(type.from) %>% mutate(normalizedWeight=Path_weight/sum(Path_weight)) %>% ungroup() %>% group_by(supertype3.to,type.from,supertype3.from) %>% summarize(Path_weight=sum(Path_weight),normalizedWeight=sum(normalizedWeight)) %>% ungroup()

backCXCompositionOther <- ggplot(CXInfluenceOther,aes(x=type.from,y=Path_weight)) + geom_col(aes(fill=supertype3.to)) + scale_fill_manual(name="Target supertype",values=supertype3Palette)+ theme_paper()+ theme(strip.text.x=element_blank(),axis.text.x = element_text(angle=90,hjust = 1,vjust=0.5))+facet_grid(.~supertype3.from,scales = "free",space="free") + ylab("normalized pathway weight") + xlab("CX output type")
backCXCompositionOther
```
The connectivity matrix connections:
```{r}
CX2CXFullMat <- filter(CXoutFull,databaseType.to %in% CXOutsideTypes$databaseType) %>% mutate(roi="outside") %>% supertype() %>% filter(Path_weight>0.005)

CX2CXFullPlot <- plotConnectivity(CX2CXFullMat,grouping = "type",facetInputs="supertype3.from",facetOutputs = "supertype3.to",xaxis = "outputs",connectionMeasure = "Path_weight",orderIn = typesCXOrder,orderOut=typesCXOrder,theme=theme_paper_grid_rects()) + xlab("target type") + ylab("CX output type")+guides(fill=guide_colorbar(title="pathway weight"))+ scale_fill_paletteer_c("ggthemes::Blue") + theme(legend.position = c(0.1,0.35),strip.background = element_rect(color="black"))

CX2CXFullPlot

CX2CXFullPLotRedux <- plotConnectivity(filter(CX2CXFullMat,supertype2.from != "FBt" & supertype2.to != "FBt" & !(databaseType.from %in% localNeuropileNeurons)),grouping = "type",facetInputs="supertype3.from",facetOutputs = "supertype3.to",xaxis = "outputs",connectionMeasure = "Path_weight",orderIn = typesCXOrder,orderOut=typesCXOrder,theme=theme_paper_rects()) + xlab("target type") + ylab("CX output type")+guides(fill=guide_colorbar(title="pathway weight"))+ scale_fill_paletteer_c("ggthemes::Blue") + theme(strip.background = element_rect(color="black"))
CX2CXFullPLotRedux
```


```{r}
save_plot(file.path(outputsFolder,"outputs-CXInfluenceSummary.svg"),CXInfluenceSummaryPlot,ncol=1.3,nrow=6,base_width = 8.5,base_height = 11/25)

save_plot(file.path(outputsFolder,"outputs-CXInfluenceCompositionOther.svg"),backCXCompositionOther,ncol=1,nrow=6,base_width = 8.5,base_height = 11/35)
save_plot(file.path(outputsFolder,"outputs-CX2CXFullMat.svg"),CX2CXFullPlot,ncol=1.3,nrow=19,base_width = 8.5,base_height = 11/35)
save_plot(file.path(outputsFolder,"outputs-CX2CXReduxMat.svg"),CX2CXFullPLotRedux,base_width = 6.5,base_height = 4)
```
