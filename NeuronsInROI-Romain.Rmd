---
title: "Neurons in ROI/Romain trials"
output: html_notebook
---


```{r}
library(neuprintr)
library(tidyverse)
library(ggiraph)
library(neuprintrExtra)
library(cowplot)
library(patchwork)
```
  
Picking the lowest level ROIs
```{r}
roiH <- getRoiTree()
```

```{r}
haneschSaveFolder <- "~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/FirstDraftFigs/HaneschPlots/"
```


# EB
This might take a while
```{r}
EBTypesTable <- getTypesInRoiTable("EB",lateralize = FALSE)
```


```{r}
EBTypesTable <- cxRetyping(EBTypesTable)
```


```{r}
EBRois <- selectRoiSet(roiH,default_level = 2,exceptions = list("EB"=4,"LAL(R)"=4,"AL(R)"=1,"AL(L)"=1),exceptionLevelMatch = c(2,2,1,1))
```

```{r}
labelRoisEB <- selectRoiSet(roiH,default_level = 0,exceptions = list("EB"=2),exceptionLevelMatch = 2)
```


```{r}
EBTypes <- typesInROI(EBTypesTable,ROI = "EB")
```

```{r}
EBSummary <- getROISummary(EBTypesTable,threshold=20)
```

```{r}
haneschEB_R <- haneschPlot(EBSummary %>% filter(type %in% EBTypes$type & ((!grepl("_L.*",type) & supertype3 != "EB Columnar")| grepl("_L",type) & supertype3 == "EB Columnar")),grouping="supertype2",flip=T,roiSelect = EBRois,roiLabel = labelRoisEB,interactive=TRUE,showCount = TRUE,theme = theme_minimal_grid())
haneschEB_R
```

```{r}
save_plot(paste0(haneschSaveFolder,"EB/EBTypesRightWidth2.svg"),haneschEB_R,nrow=2,ncol=2)
save_plot(paste0(haneschSaveFolder,"EB/EBTypesRightWidth25.svg"),haneschEB_R,nrow=2,ncol=2.5)
```

```{r}
interHaneschEB_R <- girafe(ggobj = haneschEB_R, width_svg=20,height_svg=10,
  )
```

```{r}
htmlwidgets::saveWidget(interHaneschEB_R,paste0(haneschSaveFolder,"EB/EBTypesRight.html"))
```

```{r}
haneschExR <- haneschPlot(EBSummary %>% filter(startsWith(type,"ExR") & grepl("_R.*",type)),flip=T,roiSelect = EBRois,roiLabel = labelRoisEB,interactive=TRUE,showCount = T,theme=theme_minimal_grid())
haneschExR
```

```{r}
save_plot(paste0(haneschSaveFolder,"EB/ExRs.svg"),haneschExR,nrow=2)
```

```{r}
interHaneschExR <- girafe(ggobj = haneschExR, width_svg=6,height_svg=6)
htmlwidgets::saveWidget(interHaneschExR,paste0(haneschSaveFolder,"EB/ExRs.html"))
```

```{r}
ExRTable <- neuprint_search("ExR.*",field="type") %>% mutate(databaseType = type) %>% lateralize_types(postfix = "raw") %>% filter(grepl("_R.*",type))
```

```{r}
ExRNeurons <- neuprint_read_neurons(ExRTable$bodyid,meta = FALSE,connectors = FALSE)
```
```{r}
ExRNeuronsXY <- neuron2polygon(ExRNeurons)
ExRNeuronsXZ <- neuron2polygon(ExRNeurons,axis=c("x","z"))
ExRNeurons <- bind_rows(ExRNeuronsXY[seq(1,by=2,to=nrow(ExRNeuronsXY)),],ExRNeuronsXZ[seq(1,by=2,to=nrow(ExRNeuronsXZ)),]) %>% mutate(type = ExRTable$type[match(bodyid,ExRTable$bodyid)])
```

```{r}
EBShape <- roiOutline("EB",alpha=200)
LALRShape <- roiOutline("LAL(-GA)(R)",alpha=200)
GAShape <- roiOutline("GA(R)")
BUShape <- roiOutline("BU(R)")
outlineRois <- selectRoiSet(roiH,exceptions=list("LAL(R)"=3))
roiShapes <- bind_rows(EBShape,LALRShape,GAShape,BUShape) %>% mutate(l4 = outlineRois$level4[match(roi,outlineRois$roi)],superroi = labelRoisEB$roi[match(l4,labelRoisEB$level4)])
```


```{r}
ExRAnatPlot <- ggplot() + geom_path(data=roiShapes,aes(x=x,y=y,group=roi),color="grey50") + geom_polygon(data=roiShapes,aes(x=x,y=y,group=roi,fill=superroi),alpha=0.3) + scale_fill_manual(values=roiPal) + geom_polygon_interactive(data=ExRNeurons,aes(x=x,y=y,group=bodyid,data_id=type),fill="grey80",alpha=0.2) + facet_grid(proj~.) + theme_void() + coord_fixed()  + scale_y_reverse()
```

```{r}
ExRSummaryPlot <- plot_grid(ExRAnatPlot + theme(legend.position = "none"),haneschExR)
```

```{r}
interExRSummary <- girafe(ggobj = ExRSummaryPlot, width_svg=14,height_svg=7,options = list(
    opts_hover(css= girafe_css(css = "stroke:red;",
                               area = "fill:black;stroke:none;fill-opacity:1;"
                               ))
  ))
```

```{r}
htmlwidgets::saveWidget(interExRSummary,paste0(haneschSaveFolder,"EB/ExRSummary.html"))
```


```{r}
haneschExRFull <- haneschPlot(EBSummary %>% filter(startsWith(type,"ExR")),flip=T,roiSelect = EBRois,roiLabel = labelRoisEB,interactive=TRUE)
```

```{r}
ggsave(paste0(haneschSaveFolder,"EB/ExRRight.svg"),haneschExR,width = 8,height=6)
ggsave(paste0(haneschSaveFolder,"EB/ExRFull.svg"),haneschExRFull,width = 10,height=6)
```

```{r}
interHaneschExR <- girafe(ggobj = haneschExR, width_svg=8,height_svg=6,
  options = list(
    opts_sizing(width=0.7)
  ))
interHaneschExRFull <- girafe(ggobj = haneschExRFull, width_svg=8,height_svg=6,
  options = list(
    opts_sizing(width=0.7)
  ))
```

```{r}
htmlwidgets::saveWidget(interHaneschExR,paste0(haneschSaveFolder,"EB/ExRRight.html"))
htmlwidgets::saveWidget(interHaneschExRFull,paste0(haneschSaveFolder,"EB/ExRFull.html"))
```

How do those compare to the Brad Types
```{r}
load("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/EB/EB_Types.RData")
```

```{r}
EB_Type[!(EB_Type %in% EBTypes$databaseType)]
```
That's fine, EQ5 is not a type anymore (it's called EL now)
```{r}
EBTypes$databaseType[!(EBTypes$databaseType %in% EB_Type)]
```

# NO

```{r}
NOTypesTable <- getTypesInRoiTable("NO(R)",lateralize=TRUE)
```

```{r}
NORTypes <- typesInROI(NOTypesTable,ROI = "NO(R)")
```

```{r}
NORois <- selectRoiSet(roiH,default_level = 2,exceptions = list("NO"=4,"LAL(R)"=4,"AL(R)"=1,"AL(L)"=1),exceptionLevelMatch = c(2,2,1,1))

labelRoisNO <- selectRoiSet(roiH,default_level = 0,exceptions = list("NO"=2,"AL(R)"=1,"AL(L)"=1),exceptionLevelMatch = c(2,1,1))
```


```{r}
NOSummary <- getROISummary(NOTypesTable,threshold=20)
```

```{r}
haneschNOR <- haneschPlot(NOSummary %>% filter(type %in% NORTypes$type),grouping="supertype2",flip=T,roiSelect = NORois,roiLabel = labelRoisNO,interactive=TRUE,showCount = TRUE,theme=theme_minimal_grid())
haneschNOR
```

```{r}
interHaneschNOR <- girafe(ggobj = haneschNOR, width_svg=15,height_svg=8,
  )
```

```{r}
htmlwidgets::saveWidget(interHaneschNOR,paste0(haneschSaveFolder,"NO/NO_RTypes.html"))
```


```{r}
save_plot(paste0(haneschSaveFolder,"NO/NO_RTypes.svg"),haneschNOR,ncol=2,nrow=2.5)
```


How do those compare to the Brad Types

```{r}
load("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NO/NO_Types.RData")
```

```{r}
NO_Type[!(NO_Type %in% NORTypes$databaseType)]
```
```{r}
NORTypes$databaseType[!(NORTypes$databaseType %in% NO_Type)]
```

# PB
```{r}
PBTypesTable <- getTypesInRoiTable("PB",lateralize = FALSE)
```

```{r}
PBTypesTable <- cxRetyping(PBTypesTable)
```


```{r}
PBTypes <- typesInROI(PBTypesTable,ROI = "PB")
```

```{r}
PBRois <- selectRoiSet(roiH,default_level = 2,exceptions = list("PB"=2,"LAL(R)"=4,"AL(R)"=1,"AL(L)"=1),exceptionLevelMatch = c(2,2,1,1))

labelRoisPB <- selectRoiSet(roiH,default_level = 0,exceptions = list("PB"=2,"AL(R)"=1,"AL(L)"=1),exceptionLevelMatch = c(2,1,1))
```

```{r}
PBSummary <- getROISummary(PBTypesTable,threshold=20)
```

```{r}
haneschPB <- haneschPlot(PBSummary %>% filter(type %in% PBTypes$type & !(databaseType %in% "SIFamide")),roiSelect = PBRois,flip = T,grouping = "supertype2",roiLabel = labelRoisPB,interactive=TRUE,showCount = T,theme=theme_minimal_grid())
haneschPB
```
```{r}
interHaneschPB <- girafe(ggobj = haneschPB, width_svg=19,height_svg=8
  )
```

```{r}
htmlwidgets::saveWidget(interHaneschPB,paste0(haneschSaveFolder,"PB/PBTypes.html"))
```

```{r}
save_plot(paste0(haneschSaveFolder,"PB/PBTypes.svg"),haneschPB,nrow=2,ncol=2.5)
```

```{r}
PBRoisDetailed <- selectRoiSet(roiH,default_level = 2,exceptions = list("PB"=4,"LAL(R)"=4,"AL(R)"=1,"AL(L)"=1),exceptionLevelMatch = c(2,2,1,1))
```
```{r}
haneschPBLoc <- haneschPlot(PBSummary %>% filter(databaseType %in% c("Delta7","P1-9","LPsP","P6-8P9","SpsP")),roiSelect = PBRoisDetailed,flip = T,grouping = "supertype2",roiLabel = labelRoisPB,interactive=TRUE,showCount = T,theme=theme_minimal_grid())
haneschPBLoc
```
```{r}
interHaneschPBLoc <- girafe(ggobj = haneschPBLoc, width_svg=6,height_svg=6
  )
```

```{r}
htmlwidgets::saveWidget(interHaneschPBLoc,paste0(haneschSaveFolder,"PB/PBTypesLocal.html"))
```

```{r}
save_plot(paste0(haneschSaveFolder,"PB/PBTypesLocal.svg"),haneschPBLoc,nrow=1.5,ncol=1.5)
```

```{r}
load("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/PB/PB_Types.RData")
```

```{r}
PB_Type[!(PB_Type %in% PBTypes$databaseType)]
```
```{r}
PBTypes$databaseType[!(PBTypes$databaseType %in% PB_Type)]
```

# FB
Tighten your seat belts, there are many neurons here.
```{r}
FBTypesTable <- getTypesInRoiTable("FB",lateralize = F)
```

```{r}
FBTypesTable <- cxRetyping(FBTypesTable)
```


```{r}
FBTypes <- typesInROI(FBTypesTable,ROI = "FB")
```

```{r}
FBRois <- selectRoiSet(roiH,default_level = 2,exceptions = list("FB"=4,"LAL(R)"=4,"CRE(R)"=4,"AL(R)"=1,"AL(L)"=1),exceptionLevelMatch = c(2,2,2,1,1))

labelRoisFB <- selectRoiSet(roiH,default_level = 0,exceptions = list("FB"=2,"AL(R)"=1,"AL(L)"=1),exceptionLevelMatch = c(2,1,1))
```

```{r}
FBSummary <- getROISummary(FBTypesTable,threshold=20)
```

```{r}
haneschFBtR <- haneschPlot(FBSummary %>% filter((type %in% FBTypes$type) & supertype2 == "FBt" & !grepl("_L",type)),roiSelect=FBRois,flip = T,roiLabel = labelRoisFB,grouping="supertype1",interactive = TRUE,showCount = T,theme=theme_minimal_grid()) 
haneschFBtR
```

```{r}
interHaneschFBtR <- girafe(ggobj = haneschFBtR, width_svg=25,height_svg=8,
  )
```

```{r}
htmlwidgets::saveWidget(interHaneschFBtR,paste0(haneschSaveFolder,"FB/FBTangentialsRight.html"))
```

```{r}
save_plot(paste0(haneschSaveFolder,"FB/FBTangentialsRight.svg"),haneschFBtR,nrow=2,ncol=4)
```

```{r}
haneschFBOutLay <- haneschPlot(FBSummary %>% filter((type %in% FBTypes$type) & (supertype3 == "FB Output") & !grepl("_R",type)),roiSelect = FBRois,flip=T,roiLabel = labelRoisFB,grouping="supertype2",interactive=TRUE,showCount = T,theme=theme_minimal_grid())
haneschFBOutLay
```

```{r}
interHaneschFBQL <- girafe(ggobj = haneschFBOutLay, width_svg=12,height_svg=8,
  )
```

```{r}
htmlwidgets::saveWidget(interHaneschFBQL,paste0(haneschSaveFolder,"FB/FBQsLeft.html"))
```

```{r}
save_plot(paste0(haneschSaveFolder,"FB/FBQsLeft.svg"),haneschFBOutLay,nrow=1.5,ncol=1.5)
```

```{r}
haneschFBColL <- haneschPlot(FBSummary %>% filter((type %in% FBTypes$type) & (supertype3 == "FB Columnar") & !grepl("_R",type)),roiSelect = FBRois,flip=T,roiLabel = labelRoisFB,grouping="supertype2",interactive=TRUE,showCount = T,theme=theme_minimal_grid())
haneschFBColL
```
```{r}
interHaneschFBColL <- girafe(ggobj = haneschFBColL, width_svg=12,height_svg=8
  )
```

```{r}
htmlwidgets::saveWidget(interHaneschFBColL,paste0(haneschSaveFolder,"FB/FBColumnarLeft.html"))
```

```{r}
save_plot(paste0(haneschSaveFolder,"FB/FBColsLeft.svg"),haneschFBColL,nrow=1.5,ncol=1.5)
```

```{r}
haneschDeltas <- haneschPlot(FBSummary %>% filter((type %in% FBTypes$type) & (supertype3 == "FB Interneuron") & !grepl("_R",type)),roiSelect = FBRois,flip=T,roiLabel = labelRoisFB,grouping="supertype2",interactive=TRUE,showCount = T,theme=theme_minimal_grid())
haneschDeltas
```
```{r}
interHaneschDelta <- girafe(ggobj = haneschDeltas, width_svg=10,height_svg=7)
```

```{r}
htmlwidgets::saveWidget(interHaneschDelta,paste0(haneschSaveFolder,"FB/FBDeltas.html"))
```

```{r}
save_plot(paste0(haneschSaveFolder,"FB/FBDeltas.svg"),haneschDeltas,nrow=1.5,ncol=1.5)
```

### Full FB schematic?

```{r}
summaryFB <- FBSummary %>% filter((type %in% FBTypes$type) & (supertype3 == "FB Output" | supertype3 == "FB Interneuron" | supertype3 == "FB Columnar") & !grepl("_R",type))
summaryFB$supertype2 <- factor(summaryFB$supertype2,levels=c("PFN","D0","D6","PFGs","PFR","PFL","FC","FS","FR"))
```


```{r}
haneschFBSummary <- haneschPlot(summaryFB,roiSelect = FBRois,flip=T,roiLabel = labelRoisFB,grouping="supertype2",interactive=TRUE,showCount = T,theme=theme_minimal_grid())
haneschFBSummary
```

```{r}
save_plot(paste0(haneschSaveFolder,"FB/FBSummary.svg"),haneschFBSummary,nrow=2,ncol=3)
```

```{r}
interHaneschFBSummary <- girafe(ggobj = haneschFBSummary, width_svg=13,height_svg=7
  )
```

```{r}
htmlwidgets::saveWidget(interHaneschFBSummary,paste0(haneschSaveFolder,"FB/FBSummary.html"))
```

## WIP add ons to hanesch plots

```{r}
library(ggraph)
```

```{r}
FBoutputsAugmented <- FBTypesTable$outputs %>% mutate(supertype1.from = supertype(databaseTypeFrom,level=1),supertype1.to = supertype(databaseTypeTo,level=1),
                                                      supertype2.from = supertype(databaseTypeFrom,level=2),supertype2.to = supertype(databaseTypeTo,level=2),
                                                      supertype3.from = supertype(databaseTypeFrom,level=3),supertype3.to = supertype(databaseTypeTo,level=3),
                                                     ) %>% filter(supertype3.from %in% c("FB Columnar","FB Interneuron","FB Output") & supertype3.to %in% c("FB Columnar","FB Interneuron","FB Output") & startsWith(roi,"FBl")) %>%
                                           group_by(supertype1.from,supertype1.to,roi,supertype2.from,supertype2.to,supertype3.to,supertype3.from) %>%
                                               summarize(weightRelative= sum(weightRelative),
                                                         weight = sum(absoluteWeight)) %>% ungroup()

nodesS <- unique(c(FBoutputsAugmented$supertype1.from,FBoutputsAugmented$supertype1.to))
FBoutputsAugmented <- FBoutputsAugmented %>% mutate(edge.id = 1:nrow(FBoutputsAugmented),
                                                    from = match(supertype1.from,nodesS),
                                                    to = match(supertype1.to,nodesS),
                                                    circular=FALSE,
                                                    roiE = roi)
```

```{r}
haneschFBSummary <- haneschPlot(FBSuperSummary %>% filter(supertype3 %in% c("FB Columnar","FB Interneuron","FB Output") & startsWith(roi,"FB")),roiSelect = normalROIs,flip=TRUE,alphaG = 0.2)
#haneschFBSummaryPlus <- haneschFBSummary + geom_edge_arc(data=FBoutputsAugmented,aes(x=roi,xend=roi,y=supertype1.from,yend=supertype1.to,color=supertype2.from,width=weightRelative),alpha=0.3) + facet_wrap(roiE ~ .) 
#haneschFBSummaryPlus
```
```{r}
PFL1FBSummary <- haneschFBSummary + geom_edge_arc(data=FBoutputsAugmented %>% filter(supertype1.from == "PFL1" | supertype1.to == "PFL1"),aes(x=roi,xend=roi,y=supertype1.from,yend=supertype1.to,color=supertype2.from,width=weightRelative),alpha=0.3) 
PFL2FBSummary <-haneschFBSummary + geom_edge_arc(data=FBoutputsAugmented %>% filter(supertype1.from == "PFL2" | supertype1.to == "PFL2"),aes(x=roi,xend=roi,y=supertype1.from,yend=supertype1.to,color=supertype2.from,width=weightRelative),alpha=0.3) 
PFL3FBSummary <-haneschFBSummary + geom_edge_arc(data=FBoutputsAugmented %>% filter(supertype1.from == "PFL3" | supertype1.to == "PFL3"),aes(x=roi,xend=roi,y=supertype1.from,yend=supertype1.to,color=supertype2.from,width=weightRelative),alpha=0.3)  
```

```{r}
PFL1FBSummary <- haneschFBSummary + geom_point(data=FBoutputsAugmented %>% filter(supertype1.from == "PFL1" | supertype1.to == "PFL1"),aes(x=roi,y=ifelse(supertype1.from=="PFL1",supertype1.to,supertype1.from),size=weight))
PFL2FBSummary <- haneschFBSummary + geom_point(data=FBoutputsAugmented %>% filter(supertype1.from == "PFL2" | supertype1.to == "PFL2"),aes(x=roi,y=ifelse(supertype1.from=="PFL1",supertype1.to,supertype1.from),size=weight))
PFL3FBSummary <- haneschFBSummary + geom_point(data=FBoutputsAugmented %>% filter(supertype1.from == "PFL3" | supertype1.to == "PFL3"),aes(x=roi,y=ifelse(supertype1.from=="PFL3",supertype1.to,supertype1.from),size=weight))
```

```{r}
PFLSummary <- plot_grid(PFL1FBSummary,PFL2FBSummary,PFL3FBSummary,labels=c("PFL1","PFL2","PFL3"),nrow = 1)
```

```{r}
save_plot("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/FB/RoiInOut/PFLsInFB.svg",PFLSummary,base_width = 28,base_height = 6)
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/FB/RoiInOut/HaneschFBTypesInFBWithEdges2.svg",haneschFBSummaryPlus,width = 30,height=20)
```

```{r}
load("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/FB/FB_Types.RData")
```

```{r}
FB_Type[!(FB_Type %in% FBTypes$databaseType)]
```
```{r}
FBTypes$databaseType[!(FBTypes$databaseType %in% FB_Type)]
```
