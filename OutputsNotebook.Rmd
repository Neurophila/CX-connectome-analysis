---
title: "Outputs"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(ggforce)
library(igraph)
library(tidygraph)
library(ggraph)
library(pbapply)
library(parallel)
source("neuprintQueryUtils.R")
source("R/table2ggraphUtils.R")
source("InputOutputByTypeUtils.R")
source("R/rois.R")
options(nat.plotengine = 'rgl')
```

## Building the outputs neuron bag
Building connection table in steps to avoid timeouts.
```{r}
outputBag <- buildInputsOutputsByType("FC[1|2].*|FS.*|^FR.*|ExR7.*|ExR8.*|PFL.*|PFR_b.*")
```

### Renaming (convenience function does that dealing with tricky PF types)
```{r}
outputBag <- cxRetyping(outputBag)
```

## What do their respective innervation patterns look like ?
```{r}
roiH <- getRoiTree()
roisOut <- selectRoiSet(roiH,exceptions=list("LAL(R)"=4,"CRE(R)"=4))
roisOut <- roisOut %>% filter(!(level2 %in% c("ATL(L)","ICL(L)")))
roiOutLabels <- selectRoiSet(roiH,default_level = 0)
```
```{r}
outputsByRoi <- getROISummary(outputBag,filter=FALSE)
```


```{r}
outputsInnervation_L <- haneschPlot(outputsByRoi %>% filter(grepl("_L.*",type) | startsWith(type,"ExR8")),roiSelect = roisOut,grouping = "supertype2",roiLabel = roiOutLabels,flip=TRUE)
```

```{r}
outputsInnervation_L
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/CXoutputsHaneschL.svg",outputsInnervation_L,width=6,height=8)
```

## Who are those neurons they talk to?
We'll select all their partners in "output" regions

```{r}
allOutsTable <- (outputBag$outputs %>% filter(roi %in% c("WED(R)","SLP(R)","SIP(R)","SMP(R)","SPS","IPS","CRE(R)","RUB(R)","ROB(R)","BU(R)","LAL(R)","AB(R)","GNG") & !(databaseType.to %in% outputBag$names$databaseType)))
allOuts <- outputBag$outputsTableRef %>% filter(type %in% allOutsTable$type.to)
```


```{r}
outputsInOutBag <- buildInputsOutputsByType(allOuts,selfRef = TRUE,verbose=TRUE,progress=TRUE)
```

```{r}
outputsInOutBag <- cxRetyping(outputsInOutBag)
```
## Find feedback pathways in there.
```{r}
CXtypes <- read_csv("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/CX-cell-types3")
CXRois <- unique(unlist(roiH %>% filter(level1=="CX")))
```
```{r}
feedbackNeurons <- unique((outputsInOutBag$outputs %>% filter(databaseType.to %in% CXtypes$n.type & (roi %in% CXRois)))$type.from)
feedbackBag <- filter(outputsInOutBag,filterPartners=FALSE,type %in% feedbackNeurons)
```

```{r}
feedbackRoiSummary <- getROISummary(feedbackBag,filter=FALSE)
```

```{r}
feedbackHanesch <- haneschPlot(feedbackRoiSummary,grouping="supertype2",flip=TRUE,roiSelect=roisOut,roiLabel=roiOutLabels)
feedbackHanesch
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/feedbacksHanesch.svg",feedbackHanesch,width=12,height=7)
```

```{r}
feedbackG <- makeGraph(feedbackBag,polarity="inputs",ROIs = (roisOut %>% filter(level1 != "CX"))$roi)
```

```{r}
feedbackGraphPlot <- ggraph(feedbackG$graph,layout="stress") + 
      geom_edge_fan(aes(width=weightRelative,color=supertype.from2),alpha=0.5) + 
      geom_edge_loop(colour="grey",aes(direction=10,span=10,width=weightRelative),alpha=0.5) +
      geom_node_point(aes(color=supertype2,shape=as.factor(layer)),size=8) + 
      geom_node_text(aes(label=name),angle=40,size=4)+
      scale_fill_discrete()+
      scale_shape_discrete(name="Neuron kind",labels=c("Outputs","Feedback"))
feedbackGraphPlot
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/feedbacksGraph.svg",feedbackGraphPlot,width=12)
```




```{r}
PFL1Summary <- outputsOutputPlotSummary(outputBag,outputsSuperSummary,inputType="PFL1_L*")
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/PFL1Summary.svg",PFL1Summary)
PFL1Summary
```


```{r}
PFL1Outputs <- outputsOutputPlot(outputBag,outputsOutputsByRoi,inputType = "PFL1_L*")
```

```{r}
PFL1Outputs
```


```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/PFL1Outs.svg",PFL1Outputs)
```

```{r}
PFL2Outputs <- outputsOutputPlot(outputBag,outputsOutputsByRoi,"PFL2_L")
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/PFL2Outs.svg",PFL2Outputs,height=12)
PFL2Outputs
```
```{r}
PFL2Summary <- outputsOutputPlotSummary(outputBag,outputsSuperSummary,inputType="PFL2_L")
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/PFL2Summary.svg",PFL2Summary,height=9)
PFL2Summary
```

```{r}
PFL3Outputs <- outputsOutputPlot(outputBag,outputsOutputsByRoi,"PFL3_L*")
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/PFL3Outs.svg",PFL3Outputs,height=15)
PFL3Outputs
```
```{r}
PFL3Summary <- outputsOutputPlotSummary(outputBag,outputsSuperSummary,inputType="PFL3_L*")
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/PFL3Summary.svg",PFL3Summary,height=10)
PFL3Summary
```

```{r}
ExR7Outputs <- outputsOutputPlot(outputBag,outputsOutputsByRoi,"ExR7_L")
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/ExR7Outs.svg",ExR7Outputs,height=12)
ExR7Outputs
```

```{r}
ExR7Summary <- outputsOutputPlotSummary(outputBag,outputsSuperSummary,inputType="ExR7_L")
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/ExR7Summary.svg",ExR7Summary,height=9)
ExR7Summary
```


```{r}
ExR8Outputs <- outputsOutputPlot(outputBag,outputsOutputsByRoi,"ExR8_R")
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/ExR8Outs.svg",ExR8Outputs,height=12)
ExR8Outputs
```
```{r}
ExR8Summary <- outputsOutputPlotSummary(outputBag,outputsSuperSummary,inputType="ExR8_R")
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/ExR8Summary.svg",ExR8Summary,height=9)
ExR8Summary
```


```{r}
FC1Summary <- outputsOutputPlotSummary(outputBag,outputsSuperSummary,"FC1",inputCol = "supertypeFrom1")
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/FC1Summary.svg",FC1Summary,height=10)
FC1Summary
```
```{r}
FC2Summary <- outputsOutputPlotSummary(outputBag,outputsSuperSummary,"FC2",inputCol = "supertypeFrom1")
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/FC2Summary.svg",FC2Summary,height=10)
FC2Summary
```

```{r}
DNOutOut <- outputsInOutBag$outputs %>% filter(startsWith(databaseTypeTo,"DN"))
```

```{r}
unique(DNOutOut$type.to)
```

```{r}

```

### In the LAL
```{r}
LALOutPyramid <- makePyramidGraph(outputBag,ROIs = "LAL(-GA)(R)",polarity = "outputs",plot = TRUE)
LALOutPyramid
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/LALOutPyramid.svg",LALOutPyramid,width=49,height=10)
```

```{r}
CREOutPyramid <- makePyramidGraph(outputBag,ROIs = "CRE(-ROB,-RUB)(R)",polarity = "outputs",plot = TRUE)
CREOutPyramid
```
```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/CREOutPyramid.svg",CREOutPyramid,width=49,height=10)
```

```{r}
ROBOutPyramid <- makePyramidGraph(outputBag,ROIs = "ROB(R)",polarity = "outputs",plot = TRUE)
ROBOutPyramid
```
```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/ROBOutPyramid.svg",ROBOutPyramid,width=18,height=10)
```

```{r}
RUBOutPyramid <- makePyramidGraph(outputBag,ROIs = "RUB(R)",polarity = "outputs",plot = TRUE)
RUBOutPyramid
```
```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/RUBOutPyramid.svg",RUBOutPyramid,width=18,height=10)
```

```{r}
SMPOutPyramid <- makePyramidGraph(outputBag,ROIs = "SMP(R)",polarity = "outputs",plot = TRUE)
SMPOutPyramid
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/NewOutputs/SMPOutPyramid.svg",SMPOutPyramid,width=30,height=10)
```


## "Homogeneity" plots
```{r}
lalOutputsF <- PFLInOut$outputs_raw %>% filter(paste0(type.from,type.to) %in% paste0(PFLInOut$outputs$type.from,PFLInOut$outputs$type.to) & roi == "LAL(-GA)(R)" & !(grepl("PFL1|PFL2|PFL3",type.to)))
```


```{r}
PFL_breakdown <- ggplot(lalOutputsF,aes(x=name.from,y=weightRelative,group=to,color=as.factor(to))) + geom_point() + geom_line() + facet_wrap(~databaseTypeFrom+type.to ,drop=TRUE,scales = "free_x") + theme_minimal() + theme(axis.text.x = element_text(angle = 90))+  guides(color="none")+ labs(y="Relative weight in the LAL",x="Input Neuron")
PFL_breakdown
```


