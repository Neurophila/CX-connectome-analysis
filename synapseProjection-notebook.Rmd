---
title: "Projecting synapse locations to plane that contains most variance"
output:
  html_document:
    df_print: paged
---
#Analysis of Ring neuron connectivity
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(natverse)
require(matlib)
library(neuprintrExtra)
source("SynapsePCAUtils.R")
source("R/paperTheme.R")
require(alphahull)
require(RColorBrewer)
library("paletteer")
```

```{r}
neuprint_login()

getBodyIdsForList = function (neuronList,prefix="",postfix=".*",...){
  #' Get one dataframe of bodyIDs for all search strings in neuronList
  #' @param neuronList: A list of search strings to be passed.
  #' @param prefix: String to be added before each query (default "")
  #' @param postfix: String to be added after each query (default ".*")
  #' @param ...: Parameters to be passed to neuprint_search. Note that meta=FALSE won't work for now.
  #' @return A data frame of metadata for the results of all the queries
  #' @examples
  #' \dontrun{
  #' # Both will return the same
  #' getBodyIdsForList(c("PFL1","PFL2"))
  #' getBodyIdsForList(c("PFL1","PFL2"),postfix="",field="type")
  #' }
  
  neuronList <-  paste0(prefix,neuronList,postfix)
  bodiesList <- lapply(neuronList,neuprint_search,...)
  return(bind_rows(bodiesList))
}

#neuprint_login(config=httr::set_config(httr::config(ssl_verifypeer = 0L)))
```


### (0) Get some synapse locations
Choose ROI and get curated list of neurons
```{r}
myROI = "EB"
#load(paste0("/Users/haberkernh/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/",myROI,"/",myROI,"_Types.RData"))

saveName = paste0("ring_in_", myROI)
my_types = c("ExR")
my_types = paste0(my_types, ".*")
cmapName = "colorMap_RingNeurons.csv"

my_neurons = getBodyIdsForList(my_types)
# Ring neurons: c("ER1","ER2","ER3","ER4","ER5","ER6")
# ExR: #EB_Type[grep("ExR.*", EB_Type)]
# ExR etc in BU: c("ExR", "PDM21a", "TuTu") "colorMap_ExR_and_PDM21a"
# Columnar: c("EL","EPG","EPGt","PEG","PEN_a","PEN_b")
# TuBu:  c("TuBu")

# Load custom color palette
myColorMap <- read.csv(paste0("~/Documents/code/neuprintR-notebooks/",cmapName))

```


...use this list to get synapse locations
```{r}
my_synapses = neuprint_get_synapses(as.numeric(getBodyIdsForList(my_types)$bodyid),myROI)
```

```{r}

my_synapses = my_synapses %>% mutate(
name=neuprint_get_meta(as.numeric(bodyid), all_segments = TRUE)[["name"]],
type=neuprint_get_meta(as.numeric(bodyid), all_segments = TRUE)[["type"]],
partnerName=neuprint_get_meta(as.numeric(partner), all_segments = TRUE)[["name"]],
partnertype=neuprint_get_meta(as.numeric(partner), all_segments = TRUE)[["type"]])

```

### (1) Import of ROI meshes and get vertices in x,y,z
```{r}
roiMesh = neuprint_ROI_mesh(myROI)
roiMeshPts = data.frame(dotprops(roiMesh)$points)
names(roiMeshPts) <- c("x","y","z")
```


### (2) Find convenient coordinate system based on PCA of vertices and center of mass of the ROI
***Transform mesh  and synapse locations***
```{r}
# define new origin from roi center of mass
origin = getCOM(roiMeshPts)

#reset orgin
roiMeshPts = resetOrigin(roiMeshPts, origin)

#get eigenvectors
roiEigen = covPCA(roiMeshPts)

roiMeshPtsRot = changeBasis(roiMeshPts, roiEigen)

#Synapse locations
synPts = data.frame(x=as.numeric(my_synapses$x),
                    y=as.numeric(my_synapses$y),
                    z=as.numeric(my_synapses$z))
synPts = resetOrigin(synPts, origin)
synPtsRot = changeBasis(synPts, roiEigen)

```

***Use 3D plot to choose which reference frame to use and how to rotate points within that reference frame***
```{r message=FALSE}
nclear3d()
#plot3d(roiMeshPtsRot[c('x','y','z')], col='seagreen3')
#plot3d(roiMeshPtsRot[c('X','Y','Z')], col='maroon', add=TRUE)
plot3d(synPtsRot[c('x','y','z')], col='maroon', add=TRUE)
vectors3d(sqrt(roiEigen$values[1])*roiEigen$vectors[1,], col="black", lwd=2, radius=1/25)
vectors3d(sqrt(roiEigen$values[2])*roiEigen$vectors[2,], col="grey", lwd=2, radius=1/25)
vectors3d(sqrt(roiEigen$values[3])*roiEigen$vectors[3,], col="blue", lwd=2, radius=1/25)

smallestEV = which(roiEigen$values == min(roiEigen$values), arr.ind = TRUE)
n_plane =c(roiEigen$vectors[smallestEV,1], roiEigen$vectors[smallestEV,2], roiEigen$vectors[smallestEV,3])
n_plane =  n_plane / sqrt(sum(n_plane * n_plane))

planes3d(n_plane[1],n_plane[2],n_plane[3], 0, col="gray", alpha=0.2)
plot3d(roiMesh-origin, alpha=0.2,  add=TRUE)
decorate3d(box=FALSE)
```

### (3) Plot
***Select either original or EV coordinates and rotate***
```{r}
rot = c(0, 0, 180) #BU (45,180, 0) EB: (0,0,180) AOTU: (0,180,0)

flipx = 1
flipy = -1
flipz = 1

roiMeshPtsPlane = data.frame(x=roiMeshPtsRot$X,
                             y=roiMeshPtsRot$Y,
                             z=roiMeshPtsRot$Z)
synPtsPlane = data.frame(x=synPtsRot$X,
                             y=synPtsRot$Y,
                             z=synPtsRot$Z)
# rotate points
roiMeshPtsPlane = data.matrix(roiMeshPtsPlane)
synPtsPlane = data.matrix(synPtsPlane)

roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatXY(rot[1])
synPtsPlane = synPtsPlane %*% makeRotMatXY(rot[1])
roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatYZ(rot[2])
synPtsPlane = synPtsPlane %*% makeRotMatYZ(rot[2])
roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatXZ(rot[3])
synPtsPlane = synPtsPlane %*% makeRotMatXZ(rot[3])

roiMeshPtsPlane = data.frame(x=flipx*roiMeshPtsPlane[,1],y=flipy*roiMeshPtsPlane[,2],z=flipz*roiMeshPtsPlane[,3])
synPtsPlane = data.frame(x=flipx*synPtsPlane[,1],y=flipy*synPtsPlane[,2],z=flipz*synPtsPlane[,3],
                         type = as.factor(my_synapses$type), 
                         partnerType = as.factor(my_synapses$partnertype),
                         name = as.factor(my_synapses$name), 
                         partnerName = as.factor(my_synapses$partnerName),
                         id = as.factor(my_synapses$bodyid),
                         partnerid = as.factor(my_synapses$partner),
                         prepost = as.factor(my_synapses$prepost))

#Add simple type name
synPtsPlane = synPtsPlane %>% mutate(simpleType = gsub("_.*", "",type))
```

# Frontal view
***Get outline using alpha shape and plot***
```{r}
plotW = 14#12
plotH =  6# 4
Cmax = 160#40#20#100#60# #EB col 150
nbins = 40#40#50# #5
nlevels = 5#11 #7 ; for EB: 5
```

```{r}
# get outline
if(myROI=="AOTU(R)"){
  meshOutline <- ahull(x=roiMeshPtsPlane$x,y=roiMeshPtsPlane$y,alpha=200)
}else{
  meshOutline <- ahull(x=roiMeshPtsPlane$x,y=roiMeshPtsPlane$y,alpha=150)
}
outline = data.frame(meshOutline$arcs)
#outline = bind_rows(outline, outline[1,]) # close the shape
```

```{r} 
synCount = synPtsPlane %>% count(type)
typeFilter = synCount$type[synCount$n > 10]

# generate color map
dataFilt = synPtsPlane %>% filter(type %in% typeFilter)

myTypeCols = myColorMap %>% filter(Type %in% unique(dataFilt$simpleType)) %>% filter(Simpletype == "yes")
myTypeCols = myTypeCols[match(as.character(unique(dataFilt$simpleType)), myTypeCols$Type),] %>%
  arrange(unique(dataFilt$simpleType))

mySubtypeCols = myColorMap %>% filter(Type %in% unique(dataFilt$type)) %>% filter(Simpletype == "no")
mySubtypeCols = mySubtypeCols[match(as.character(unique(dataFilt$type)), mySubtypeCols$Type),] %>%
  arrange(unique(dataFilt$type))

```

```{r}
synprojFront = ggplot() + 
  geom_hex(data=dataFilt, aes(x=x, y=y), bins=nbins) +   #fill=type, color=type
  scale_fill_gradientn(colours = brewer.pal(5,"BuPu"), breaks=c(0,Cmax), limits=c(0, Cmax), oob = scales::squish) +
  facet_wrap(~type, ncol=ceiling(length(unique(dataFilt$simpleType))/2)) +
  coord_fixed(ratio = 1) +  theme_void() + guides(color=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojFront)
ggsave( paste("synapseDistributions_",saveName,'_front.pdf', sep=''), plot = synprojFront, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH*1.5, units ="cm", dpi = 600, limitsize = TRUE)
```


Helper plotting function
```{r}
coloredDensityPlot <- function(mydata, dims, grouping, colorcode){
  densPlot = ggplot() + stat_density_2d(data = mydata, aes(x=mydata[[dims[1]]], y=mydata[[dims[2]]], fill=mydata[[grouping]], alpha = stat(nlevel)), bins=nlevels,contour_var = "ndensity", geom = "polygon") +
  coord_fixed(ratio = 1) + theme_void() + guides(fill=guide_legend(ncol=2)) +
  scale_fill_manual(values = as.character(colorcode), name=grouping)
  return(densPlot)
}
```


```{r}
synprojFront = coloredDensityPlot(dataFilt, c("x","y"), "type", mySubtypeCols$hex)
synprojFront = synprojFront + 
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5) +
  facet_wrap(~simpleType, ncol=6)
print(synprojFront)

ggsave( paste("synapseDistributions_",saveName,'_front_simpletype.pdf', sep=''), plot = synprojFront, device='pdf',
        path = "../neuprintR_analysis_plots/", scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)

```
```{r}
synprojFront = coloredDensityPlot(dataFilt, c("x","y"), "type", mySubtypeCols$hex)
synprojFront = synprojFront + geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojFront)

ggsave( paste("synapseDistributions_",saveName,'_front_level.pdf', sep=''), plot = synprojFront, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 10, height = 10, units ="cm", dpi = 600, limitsize = TRUE)

synprojFront = coloredDensityPlot(dataFilt, c("x","y"), "simpleType", myTypeCols$hex)
synprojFront = synprojFront + geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojFront)
 
ggsave( paste("synapseDistributions_",saveName,'_front_level_simpletypes.pdf', sep=''), plot = synprojFront, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 10, height = 10, units ="cm", dpi = 600, limitsize = TRUE)

```

For a given population, plot each neuron separately

```{r}
synprojFront = ggplot() + 
  geom_point(data=dataFilt, aes(x=x, y=y, fill=id, color=id), size=0.5) + 
  #scale_fill_manual(values=paletteer_c("grDevices::Hot", n=length(unique(dataFilt$id)))) +
  #scale_fill_manual(values = as.character(myTypeCols$hex)) +
  facet_wrap(~type, ncol=ceiling(length(unique(dataFilt$simpleType))/2)) +
  coord_fixed(ratio = 1) +  theme_void() + guides(color=FALSE, fill=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojFront)
ggsave( paste("synapseDistributions_",saveName,'_idColored_front.pdf', sep=''), plot = synprojFront, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH*1.5, units ="cm", dpi = 600, limitsize = TRUE)
```

# Side view
```{r}
plotW = 14
plotH =  6#10
Cmax = 160#30##EB col 150
nbins = 40
```

```{r}
# get outline
meshOutline <- ahull(x=roiMeshPtsPlane$z,y=roiMeshPtsPlane$y,alpha=100)
outline = data.frame(meshOutline$arcs)
outline = bind_rows(outline, outline[1,]) # close the shape
```

```{r}
synprojSide = ggplot() + 
  geom_hex(data=dataFilt, aes(x=z, y=y), bins=nbins) +   #fill=type, color=type
  scale_fill_gradientn(colours = brewer.pal(5,"BuPu"), breaks=c(0,Cmax), limits=c(0, Cmax), oob = scales::squish) +
  facet_wrap(~type, ncol=8) +
  coord_fixed(ratio = 1) + theme_void() + guides(color=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)

print(synprojSide)
ggsave( paste("synapseDistributions_",saveName,'_side.pdf', sep=''), plot = synprojSide, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)

```

```{r}
synprojSide = coloredDensityPlot(dataFilt, c("z","y"), "type", mySubtypeCols$hex)
synprojSide = synprojSide + facet_wrap(~simpleType, ncol=6) + geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSide)

ggsave( paste("synapseDistributions_",saveName,'_side_type.pdf', sep=''), plot = synprojSide, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)

```


```{r}
synprojSide = coloredDensityPlot(dataFilt, c("z","y"), "type", mySubtypeCols$hex)
synprojSide = synprojSide + geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSide)

ggsave( paste("synapseDistributions_",saveName,'_side_all.pdf', sep=''), plot = synprojSide, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW*0.8, height = plotH*1.2, units ="cm", dpi = 600, limitsize = TRUE)

```

# Top view
```{r}
plotW = 14
plotH =  6#10
Cmax = 150##EB col 150
nbins = 40
nlevels = 7
```

```{r}
# get outline
meshOutline <- ahull(x=roiMeshPtsPlane$x,y=roiMeshPtsPlane$z,alpha=150)
outline = data.frame(meshOutline$arcs)
outline = bind_rows(outline, outline[1,]) # close the shape
```

```{r}
synprojSide = ggplot() + 
  geom_hex(data=dataFilt, aes(x=x, y=z), bins=nbins) +   #fill=type, color=type
  scale_fill_gradientn(colours = brewer.pal(5,"BuPu"), breaks=c(0,Cmax), limits=c(0, Cmax), oob = scales::squish) +
  facet_wrap(~type, ncol=6) +
  coord_fixed(ratio = 1) + theme_void() + guides(color=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)

print(synprojSide)
ggsave( paste("synapseDistributions_",saveName,'_top.pdf', sep=''), plot = synprojSide, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)

```


```{r}
synprojSide = coloredDensityPlot(dataFilt, c("x","z"), "type", mySubtypeCols$hex)
synprojSide = synprojSide + facet_wrap(~simpleType, ncol=5) + geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSide)

ggsave( paste("synapseDistributions_",saveName,'_top_type.pdf', sep=''), plot = synprojSide, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)

```


```{r}
synprojSide = coloredDensityPlot(dataFilt, c("x","z"), "type", mySubtypeCols$hex)
synprojSide = synprojSide + geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSide)

ggsave( paste("synapseDistributions_",saveName,'_top_all.pdf', sep=''), plot = synprojSide, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW*0.8, height = plotH*1.2, units ="cm", dpi = 600, limitsize = TRUE)

```




### Collapse along EB ring
***Compute angle of vectors to each point relative to x-axis***
```{r}
syn_ang = numeric(length(synPtsPlane$x))
syn_dist = numeric(length(synPtsPlane$x))
for (i in seq(1,length(synPtsPlane$x))) {
  syn_ang[i] = angle(as.numeric(synPtsPlane[i,1:2]), c(0,-1))
  syn_dist[i] = sqrt(sum(synPtsPlane[i,1:2] * synPtsPlane[i,1:2]))
  if (synPtsPlane[i,1] < 0){
    syn_ang[i] = 360-syn_ang[i]
  }
}

synPtsPlane$angle = syn_ang
synPtsPlane$dist = syn_dist

```

```{r}
# Uncomment lines below if you'd like to see a vizualization of the definition of syn_angle and syn_dist
#ggplot(synPtsPlane, aes(x=x,y=y, color=angle)) + geom_point()
#ggplot(synPtsPlane, aes(x=x,y=y, color=dist)) + geom_point()
```

```{r}
roi_dist = numeric(length(roiMeshPtsPlane$x))
roi_ang = numeric(length(roiMeshPtsPlane$x))
for (i in seq(1,length(roiMeshPtsPlane$x))) {
  roi_dist[i] = sqrt(sum(roiMeshPtsPlane[i,1:2] * roiMeshPtsPlane[i,1:2]))
  roi_ang[i] = angle(as.numeric(roiMeshPtsPlane[i,1:2]), c(0,-1))
  if (roiMeshPtsPlane[i,1] < 0){
    roi_ang[i] = 360-roi_ang[i]
  }
}
roiMeshPtsPlane$dist = roi_dist
roiMeshPtsPlane$angle = roi_ang
roiMeshPtsPlane = roiMeshPtsPlane %>%  mutate(angleGroup = cut(angle, breaks=c(-0, 1/8*360 ,2/8*360, 3/8*360, 1/2*360 ,5/8*360, 6/8*360, 7/8*360, 360), labels=c("1","2","3","4","5","6","7","8")))

```

```{r}
plotW = 12
plotH =  8
Cmax = 300#20#500#
nbins = 50#40

dataFilt = synPtsPlane %>% filter(type %in% typeFilter)
```

```{r}
# get outline
meshOutline <- ahull(x=roiMeshPtsPlane$z,y=roiMeshPtsPlane$dist,alpha=100)
outline = data.frame(meshOutline$arcs)
#outline = bind_rows(outline, outline[1,]) # close the shape
```

```{r}
synprojSlice = ggplot() + 
  geom_hex(data=dataFilt, aes(x=z, y=syn_dist), bins=30) +
  scale_fill_gradientn(colours = brewer.pal(5,"BuPu"), breaks=c(0,Cmax), limits=c(0, Cmax), oob = scales::squish) +
  facet_wrap(~type, ncol=6) +
  coord_fixed(ratio = 1) + theme_void() +# guides(fill=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_singleCol.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
nlevels = 5#3
synprojSlice = ggplot() + 
  stat_density_2d(data=dataFilt, aes(x=z, y=syn_dist, fill=type, alpha = stat(nlevel)), 
                  bins=nlevels,contour_var = "ndensity", geom = "polygon") + 
  scale_alpha(range = c(0.2, 1)) +
  facet_wrap(~type, ncol=4) +
  coord_fixed(ratio = 1) + theme_void() + guides(fill=FALSE) +
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5) + guides(fill=guide_legend(ncol=2))
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_levels_type.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)

```


```{r}
synprojSlice = ggplot() + 
  stat_density_2d(data=dataFilt, aes(x=z, y=syn_dist, fill=type, alpha = stat(nlevel)), 
                  bins=nlevels,contour_var = "ndensity", geom = "polygon") + 
  facet_wrap(~simpleType, ncol=4) +
  coord_fixed(ratio = 1) + theme_void() + guides(fill=FALSE) +
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5) + guides(fill=guide_legend(ncol=2))
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_levels_subtype.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
synprojSlice = ggplot() + 
  stat_density_2d(data=dataFilt, aes(x=z, y=syn_dist, fill=type, alpha = stat(nlevel)), 
                  bins=nlevels,contour_var = "ndensity", geom = "polygon") + 
  scale_alpha(range = c(0.2, 1)) +
  coord_fixed(ratio = 1) + theme_void() + guides(alpha=FALSE) +
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5) + guides(fill=guide_legend(ncol=2))
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_levels.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 7, height = 7, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
synprojSlice = ggplot() + 
  stat_density_2d(data=dataFilt, aes(x=z, y=syn_dist, fill=simpleType, alpha = stat(nlevel)), 
                  bins=nlevels,contour_var = "ndensity", geom = "polygon") +
  scale_alpha(range = c(0.2, 1)) +
  coord_fixed(ratio = 1) + theme_void() + guides(alpha=FALSE) +
  scale_fill_manual(values = as.character(myTypeCols$hex)) + 
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5) + guides(fill=guide_legend(ncol=2))
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_levels2.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 7, height = 7, units ="cm", dpi = 600, limitsize = TRUE)
```



Color code by region (Ring neurons only)
```{r}
regiondata = left_join(dataFilt, myTypeCols[c("Type","regions","hex")], by = c("simpleType" = "Type"))
synprojSlice = ggplot() + 
  stat_density_2d(data=regiondata, aes(x=z, y=syn_dist, fill=regions, alpha = stat(nlevel)), 
                  bins=nlevels,contour_var = "ndensity", geom = "polygon")+ scale_alpha(range = c(0.2, 1)) +
  coord_fixed(ratio = 1) + theme_void() + guides(alpha=FALSE) +
  scale_fill_manual(values = paletteer_d("basetheme::brutal", length(unique(myTypeCols$regions)))) + 
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5) + guides(fill=guide_legend(ncol=1))
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_levels_byRegion.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 7, height = 7, units ="cm", dpi = 600, limitsize = TRUE)
```

 
```{r}
# get outline
meshOutline <- ahull(x=roiMeshPtsPlane$z,y=roiMeshPtsPlane$dist,alpha=100)
outline = data.frame(meshOutline$arcs)
#outline = bind_rows(outline, outline[1,]) # close the shape
```


Split into quadrants

```{r}
# Uncomment lines below if you'd like to see a vizualization of the definition of syn_angle and syn_dist
ggplot(dataFilt %>% filter(type == "ER4d"), aes(x=x,y=y, color=angleGroup)) + geom_point()  + theme_classic()
ggsave( paste("synapseDistributions_",saveName,'_splitRad.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 13, height = 6, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
# get outline 
outline = data.frame()
for (i in unique(roiMeshPtsPlane$angleGroup)) {
  roiMeshPtsPlaneSub = roiMeshPtsPlane %>% filter(angleGroup == i)
  meshOutline <- ahull(x=roiMeshPtsPlaneSub$z,y=roiMeshPtsPlaneSub$dist,alpha=250)
  outlineGroup = data.frame(meshOutline$arcs) %>% mutate(angleGroup = i)
  outline = bind_rows(outline,outlineGroup)
  #outline = bind_rows(outline, outline[1,]) # close the shape
}
```

```{r}
ggplot() + geom_path(data=outline, aes(x=c1, y=c2), size = 0.5) + facet_wrap( ~ angleGroup,  ncol=4) +
  coord_fixed(ratio = 1) + theme_void()
```

```{r}
dataFilt = dataFilt %>% mutate(angleGroup = cut(angle, breaks=c(-0, 1/8*360 ,2/8*360, 3/8*360, 1/2*360 ,5/8*360, 6/8*360, 7/8*360, 360), labels=c("1","2","3","4","5","6","7","8")))
```


```{r}
library(cowplot)

synprojSlice = ggplot() + 
  stat_density_2d(data=dataFilt, aes(x=z, y=syn_dist, fill=type, alpha = stat(nlevel)), 
                  bins=nlevels,contour_var = "ndensity", geom = "polygon") + 
  scale_alpha(range = c(0.2, 1)) +
  facet_wrap( ~ angleGroup,  ncol=4) +
  coord_fixed(ratio = 1) + theme_void() + theme_cowplot(font_size=7,font_family="sans",rel_small=6/7,rel_tiny = 5/7,rel_large = 12/7, line_size = 0.5*mm2pt) +
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5) + guides(fill=guide_legend(ncol=1))
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_splitRad.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 13, height = 6, units ="cm", dpi = 600, limitsize = TRUE)
```


```{r}
library(cowplot)

synprojSlice = ggplot() + 
  stat_density_2d(data=dataFilt, aes(x=z, y=syn_dist, fill=simpleType, alpha = stat(nlevel)), 
                  bins=nlevels,contour_var = "ndensity", geom = "polygon") + 
  scale_alpha(range = c(0.2, 1)) +
  facet_wrap( ~ angleGroup,  ncol=4) +
  coord_fixed(ratio = 1) + theme_void() + theme_cowplot(font_size=7,font_family="sans",rel_small=6/7,rel_tiny = 5/7,rel_large = 12/7, line_size = 0.5*mm2pt) +
  scale_fill_manual(values = as.character(myTypeCols$hex)) + 
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5) + guides(fill=guide_legend(ncol=1))
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_simple_splitRad.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 13, height = 6, units ="cm", dpi = 600, limitsize = TRUE)
```

