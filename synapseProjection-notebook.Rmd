---
title: "Projecting synapse locations to plane that contains most variance"
output:
  html_document:
    df_print: paged
---
#Analysis of Ring neuron connectivity
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(natverse)
require(matlib)

source("neuprintQueryUtils.R")
source("SynapsePCAUtils.R")
require(alphahull)
require(RColorBrewer)
```

```{r}
neuprint_login()
#neuprint_login(config=httr::set_config(httr::config(ssl_verifypeer = 0L)))
```


### (0) Get some synapse locations
Choose ROI and get curated list of neurons
```{r}
myROI = "AOTU(R)"
#load(paste0("/Users/haberkernh/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/",myROI,"/",myROI,"_Types.RData"))

saveName = paste0("TuBu_in_", myROI)
my_types = c("TuBu.*")#c("R1.*","R2.*","R3.*","R4.*","R5.*","R6.*") #c("ExR.*", "PDM21a.*")
my_neurons = getBodyIdsForList(my_types)
# Ring neurons c("R1.*","R2.*","R3.*","R4.*","R5.*","R6.*")
# ExR: #EB_Type[grep("ExR.*", EB_Type)]
# ExR etc in BU: c("ExR.*", "PDM21a.*")
# Columnar: c("EL","EPG","EPGt","PEG","PEN_a","PEN_b")
```

Load custom color palette
```{r}
myColorMap <- read.csv("~/Documents/code/neuprintR-notebooks/colorMap_TuBus.csv")

#library("paletteer")
```


...use this list to get synapse locations
```{r}
my_synapses = neuprint_get_synapses(as.numeric(getBodyIdsForList(my_types[1])$bodyid),myROI)
if (length(my_types) > 1){
  for(nt in my_types[2:length(my_types)]){
    print(nt)
    tmp <- neuprint_get_synapses(as.numeric(getBodyIdsForList(nt)$bodyid),myROI)
    my_synapses <- rbind(my_synapses, tmp)
  }
}
```

```{r}
useNeuprintTest = FALSE

if(useNeuprintTest){
  my_ids = my_synapses$bodyid
  metaid = data.frame(name=neuprint_get_meta(as.numeric(my_ids[1]), all_segments = TRUE)[["name"]],
                     type=neuprint_get_meta(as.numeric(my_ids[1]), all_segments = TRUE)[["type"]])
  for(id in my_ids[2:length(my_ids)]){
    tmp = data.frame(name=neuprint_get_meta(as.numeric(id), all_segments = TRUE)[["name"]],
                     type=neuprint_get_meta(as.numeric(id), all_segments = TRUE)[["type"]])
    metaid = rbind(metaid, tmp)
  }
  
  my_partners = my_synapses$partner
  metapartner = data.frame(partnerName=neuprint_get_meta(as.numeric(my_partners[1]), all_segments = TRUE)[["name"]],
                           partnertype=neuprint_get_meta(as.numeric(my_partners[1]), all_segments = TRUE)[["type"]])
  for(part in my_partners[2:length(my_partners)]){
    tmp = data.frame(partnerName=neuprint_get_meta(as.numeric(part), all_segments = TRUE)[["name"]],
                     partnertype=neuprint_get_meta(as.numeric(part), all_segments = TRUE)[["type"]])
    metapartner = rbind(metapartner, tmp)
  }
  
  my_synapses = bind_cols(my_synapses, metaid, metapartner)
}else{
  my_synapses = my_synapses %>% mutate(
  name=neuprint_get_meta(as.numeric(bodyid), all_segments = TRUE)[["name"]],
  type=neuprint_get_meta(as.numeric(bodyid), all_segments = TRUE)[["type"]],
  partnerName=neuprint_get_meta(as.numeric(partner), all_segments = TRUE)[["name"]],
  partnertype=neuprint_get_meta(as.numeric(partner), all_segments = TRUE)[["type"]])
}

```

### (1) Import of ROI meshes and get vertices in x,y,z
```{r}
roiMesh = neuprint_ROI_mesh(myROI)
roiMeshPts = data.frame(dotprops(roiMesh)$points)
names(roiMeshPts) <- c("x","y","z")
```


### (2) Find convenient coordinate system based on PCA of vertices and center of mass of the ROI
***Transform mesh  and synapse locations***
```{r}
# define new origin from roi center of mass
origin = getCOM(roiMeshPts)

#reset orgin
roiMeshPts = resetOrigin(roiMeshPts, origin)

#get eigenvectors
roiEigen = covPCA(roiMeshPts)

roiMeshPtsRot = changeBasis(roiMeshPts, roiEigen)

#Synapse locations
synPts = data.frame(x=as.numeric(my_synapses$x),
                    y=as.numeric(my_synapses$y),
                    z=as.numeric(my_synapses$z))
synPts = resetOrigin(synPts, origin)
synPtsRot = changeBasis(synPts, roiEigen)

```

***Use 3D plot to choose which reference frame to use and how to rotate points within that reference frame***
```{r message=FALSE}
nclear3d()
#plot3d(roiMeshPtsRot[c('x','y','z')], col='seagreen3')
#plot3d(roiMeshPtsRot[c('X','Y','Z')], col='maroon', add=TRUE)
plot3d(synPtsRot[c('x','y','z')], col='maroon', add=TRUE)
vectors3d(sqrt(roiEigen$values[1])*roiEigen$vectors[1,], col="black", lwd=2, radius=1/25)
vectors3d(sqrt(roiEigen$values[2])*roiEigen$vectors[2,], col="grey", lwd=2, radius=1/25)
vectors3d(sqrt(roiEigen$values[3])*roiEigen$vectors[3,], col="blue", lwd=2, radius=1/25)

smallestEV = which(roiEigen$values == min(roiEigen$values), arr.ind = TRUE)
n_plane =c(roiEigen$vectors[smallestEV,1], roiEigen$vectors[smallestEV,2], roiEigen$vectors[smallestEV,3])
n_plane =  n_plane / sqrt(sum(n_plane * n_plane))

planes3d(n_plane[1],n_plane[2],n_plane[3], 0, col="gray", alpha=0.2)
plot3d(roiMesh-origin, alpha=0.2,  add=TRUE)
decorate3d(box=FALSE)
```

### (3) Plot
***Select either original or EV coordinates and rotate***
```{r}
rot = c(0,0, 0)#BU (45,180, 0) EB: (0,0,180) AOTU: (0,0,0)

roiMeshPtsPlane = data.frame(x=roiMeshPtsRot$X,
                             y=roiMeshPtsRot$Y,
                             z=roiMeshPtsRot$Z)
synPtsPlane = data.frame(x=synPtsRot$X,
                             y=synPtsRot$Y,
                             z=synPtsRot$Z)
# rotate points
roiMeshPtsPlane = data.matrix(roiMeshPtsPlane)
synPtsPlane = data.matrix(synPtsPlane)

roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatXY(rot[1])
synPtsPlane = synPtsPlane %*% makeRotMatXY(rot[1])
roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatYZ(rot[2])
synPtsPlane = synPtsPlane %*% makeRotMatYZ(rot[2])
roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatXZ(rot[3])
synPtsPlane = synPtsPlane %*% makeRotMatXZ(rot[3])

roiMeshPtsPlane = data.frame(x=roiMeshPtsPlane[,1],y=roiMeshPtsPlane[,2],z=roiMeshPtsPlane[,3])
synPtsPlane = data.frame(x=synPtsPlane[,1],y=synPtsPlane[,2],z=synPtsPlane[,3],
                         type = as.factor(my_synapses$type), 
                         partnerType = as.factor(my_synapses$partnertype),
                         name = as.factor(my_synapses$name), 
                         partnerName = as.factor(my_synapses$partnerName))

#Add simple type name
synPtsPlane = synPtsPlane %>% mutate(simpleType = gsub("_.*", "",type))
```

***Get outline using alpha shape and plot***
```{r}
plotW = 12
plotH =  4# 6#10
Cmax = 30 #EB col 150
nbins = 50#40
nlevels = 5
```
Frontal view
```{r}
# get outline
if(myROI=="AOTU(R)"){
  meshOutline <- ahull(x=roiMeshPtsPlane$x,y=roiMeshPtsPlane$y,alpha=120)
}else{
  meshOutline <- ahull(x=roiMeshPtsPlane$x,y=roiMeshPtsPlane$y,alpha=100)
}
outline = data.frame(meshOutline$arcs)
#outline = bind_rows(outline, outline[1,]) # close the shape
```

```{r}
synCount = synPtsPlane %>% count(type)
typeFilter = synCount$type[synCount$n > 10]

# generate color map
dataFilt = synPtsPlane %>% filter(type %in% typeFilter)

myTypeCols = myColorMap %>% filter(Type %in% unique(dataFilt$simpleType)) %>% filter(Simpletype == "yes")
mySubtypeCols = myColorMap %>% filter(Type %in% unique(dataFilt$type)) %>% filter(Simpletype == "no")

```


```{r}
synprojFront = ggplot() + 
  geom_hex(data=synPtsPlane, aes(x=x, y=y), bins=nbins) +   #fill=type, color=type
  scale_fill_gradientn(colours = brewer.pal(5,"BuPu"), breaks=c(0,Cmax), limits=c(0, Cmax), oob = scales::squish) +
  facet_wrap(~type, ncol=6) +
  coord_fixed(ratio = 1) +  theme_void() + guides(color=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojFront)
ggsave( paste("synapseDistributions_",saveName,'_front.pdf', sep=''), plot = synprojFront, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
synprojFront = ggplot() + 
  stat_density_2d(data=dataFilt, aes(x=x, y=y, fill=type, alpha = stat(nlevel)), bins=nlevels, geom = "polygon") +
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  facet_wrap(~simpleType, ncol=5) +
  coord_fixed(ratio = 1) + theme_void() + guides(fill=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)

print(synprojFront)
ggsave( paste("synapseDistributions_",saveName,'_front_simpletype.pdf', sep=''), plot = synprojFront, device='pdf',
        path = "../neuprintR_analysis_plots/", scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
synprojFront = ggplot() + 
  stat_density_2d(data=synPtsPlane %>% filter(type %in% typeFilter), aes(x=x, y=y, fill=type, alpha = stat(nlevel)), bins=nlevels, geom = "polygon") +
  coord_fixed(ratio = 1) + theme_void() + guides(fill=guide_legend(ncol=2)) +
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)

print(synprojFront)
ggsave( paste("synapseDistributions_",saveName,'_front_level_subtypes.pdf', sep=''), plot = synprojFront, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 10, height = 10, units ="cm", dpi = 600, limitsize = TRUE)

synprojFront = ggplot() + 
  stat_density_2d(data=synPtsPlane %>% filter(type %in% typeFilter), aes(x=x, y=y, fill=simpleType, alpha = stat(nlevel)), bins=nlevels, geom = "polygon") +
  coord_fixed(ratio = 1) + theme_void() + guides(fill=guide_legend(ncol=2)) +
  scale_fill_manual(values = as.character(myTypeCols$hex)) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)

print(synprojFront)
ggsave( paste("synapseDistributions_",saveName,'_front_level.pdf', sep=''), plot = synprojFront, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 10, height = 10, units ="cm", dpi = 600, limitsize = TRUE)
```

Side view
```{r}
plotW = 12
plotH =  6#10
Cmax = 30#15 #EB col 150
nbins = 40
nlevels = 5
```

```{r}
# get outline
meshOutline <- ahull(x=roiMeshPtsPlane$z,y=roiMeshPtsPlane$y,alpha=100)
outline = data.frame(meshOutline$arcs)
outline = bind_rows(outline, outline[1,]) # close the shape
```

```{r}
synprojSide = ggplot() + 
  geom_hex(data=synPtsPlane %>% filter(type %in% typeFilter), aes(x=z, y=y), bins=nbins) +   #fill=type, color=type
  scale_fill_gradientn(colours = brewer.pal(5,"BuPu"), breaks=c(0,Cmax), limits=c(0, Cmax), oob = scales::squish) +
  facet_wrap(~type, ncol=8) +
  coord_fixed(ratio = 1) + theme_void() + guides(color=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)

print(synprojSide)
ggsave( paste("synapseDistributions_",saveName,'_side.pdf', sep=''), plot = synprojSide, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)

```


```{r}
synprojSide = ggplot() + 
  stat_density_2d(data=synPtsPlane %>% filter(type %in% typeFilter), aes(x=z, y=y, fill=type, alpha = stat(nlevel)), bins=nlevels, geom = "polygon") +
  facet_wrap(~simpleType, ncol=6) +
  coord_fixed(ratio = 1) + theme_void() + guides(fill=guide_legend(ncol=2)) +
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSide)

ggsave( paste("synapseDistributions_",saveName,'_side_type.pdf', sep=''), plot = synprojSide, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)

```


```{r}
synprojSide = ggplot() + 
  stat_density_2d(data=synPtsPlane %>% filter(type %in% typeFilter), aes(x=z, y=y, fill=type, alpha = stat(nlevel)), bins=nlevels, geom = "polygon") +
  coord_fixed(ratio = 1) + theme_void() + guides(fill=guide_legend(ncol=2)) +
  scale_fill_manual(values = as.character(mySubtypeCols$hex)) + 
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSide)

ggsave( paste("synapseDistributions_",saveName,'_side_level.pdf', sep=''), plot = synprojSide, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)

```

### Collapse along EB ring
***Compute angle of vectors to each point relative to x-axis***
```{r}
syn_ang = numeric(length(synPtsPlane$x))
syn_dist = numeric(length(synPtsPlane$x))
for (i in seq(1,length(synPtsPlane$x))) {
  syn_ang[i] = angle(as.numeric(synPtsPlane[i,1:2]), c(0,-1))
  syn_dist[i] = sqrt(sum(synPtsPlane[i,1:2] * synPtsPlane[i,1:2]))
  if (synPtsPlane[i,1] < 0){
    syn_ang[i] = 360-syn_ang[i]
  }
}

synPtsPlane$angle = syn_ang
synPtsPlane$dist = syn_dist

# Uncomment lines below if you'd like to see a vizualization of the definition of syn_angle and syn_dist
#ggplot(syn_2d, aes(x=x,y=y, color=angle)) + geom_point()
#ggplot(syn_2d, aes(x=x,y=y, color=dist)) + geom_point()
```

```{r}
roi_dist = numeric(length(roiMeshPtsPlane$x))
for (i in seq(1,length(roiMeshPtsPlane$x))) {
  roi_dist[i] = sqrt(sum(roiMeshPtsPlane[i,1:2] * roiMeshPtsPlane[i,1:2]))
}

roiMeshPtsPlane$dist = roi_dist
```

```{r}
plotW = 12
plotH =  6
Cmax = 500#200#20
nbins = 50#40
```

```{r}
# get outline
meshOutline <- ahull(x=roiMeshPtsPlane$z,y=roiMeshPtsPlane$dist,alpha=70)
outline = data.frame(meshOutline$arcs)
#outline = bind_rows(outline, outline[1,]) # close the shape
```

```{r}
synprojSlice = ggplot() + 
  #geom_point(data=synPtsPlane, aes(x=syn_dist, y=z, color=type), size=0.1, alpha=0.1) +
  geom_hex(data=synPtsPlane, aes(x=z, y=syn_dist,fill=type), bins=50) +
  facet_wrap(~type, ncol=8) +
  coord_fixed(ratio = 1) + theme_void() + guides(fill=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
synprojSlice = ggplot() + 
  geom_hex(data=synPtsPlane, aes(x=z, y=syn_dist), bins=30) +
  scale_fill_gradientn(colours = brewer.pal(5,"BuPu"), breaks=c(0,Cmax), limits=c(0, Cmax), oob = scales::squish) +
  facet_wrap(~type, ncol=8) +
  coord_fixed(ratio = 1) + theme_void() +# guides(fill=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_singleCol.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
nlevel = 3
synprojSlice = ggplot() + 
  stat_density_2d(data=synPtsPlane, aes(x=z, y=syn_dist, fill=type, alpha = stat(nlevel)), bins=4, geom = "polygon") + scale_alpha(range = c(0.2, 1)) +
  facet_wrap(~type, ncol=8) +
  coord_fixed(ratio = 1) + theme_void() + guides(fill=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_levels_type.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)

```


```{r}
nlevel = 3
synprojSlice = ggplot() + 
  stat_density_2d(data=synPtsPlane, aes(x=z, y=syn_dist, fill=type, alpha = stat(nlevel)), bins=4, geom = "polygon") + scale_alpha(range = c(0.2, 1)) +
  facet_wrap(~simpleType, ncol=6) +
  coord_fixed(ratio = 1) + theme_void() + guides(fill=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_levels_subtype.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
nlevel = 3
synprojSlice = ggplot() + 
  stat_density_2d(data=synPtsPlane, aes(x=z, y=syn_dist, fill=type, alpha = stat(nlevel)), bins=4, geom = "polygon") + scale_alpha(range = c(0.2, 1)) +
  coord_fixed(ratio = 1) + theme_void() + guides(alpha=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_levels.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 7, height = 7, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
nlevel = 3
synprojSlice = ggplot() + 
  stat_density_2d(data=synPtsPlane, aes(x=z, y=syn_dist, fill=simpleType, alpha = stat(nlevel)), bins=4, geom = "polygon") + scale_alpha(range = c(0.2, 1)) +
  coord_fixed(ratio = 1) + theme_void() + guides(alpha=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSlice)

ggsave( paste("synapseDistributions_",saveName,'_slice_levels2.pdf', sep=''), plot = synprojSlice, device='pdf', path = "../neuprintR_analysis_plots/",
    scale = 1.5, width = 7, height = 7, units ="cm", dpi = 600, limitsize = TRUE)
```



# TODO: Make poygons from synapse densities, compute area and center of mass...
```{r}
synprojSlice = ggplot() + 
  stat_density_2d(data=synPtsPlane, aes(x=z, y=dist, color=simpleType, fill=nlevel), bins=2, geom ="contour", show.legend=TRUE) + 
  coord_fixed(ratio = 1) + theme_void() + #guides(alpha=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSlice)
```

```{r}
#dens = MASS::kde2d(synPtsPlane$z, synPtsPlane$dist, n = 100)

synprojSlice = ggplot() + 
  geom_contour(data=synPtsPlane, aes(x=z, y=dist, z=..density.., color=simpleType)) + 
  coord_fixed(ratio = 1) + theme_void() + #guides(alpha=FALSE) +
  geom_path(data=outline, aes(x=c1, y=c2), size = 0.5)
print(synprojSlice)
```

```{r}
synPtsPlane

```


# ############################
# OLDER CODE
### Build data frame
```{r}
syn_2d$post = my_synapses$prepost  # 1 for post, 0 for pre?
syn_2d$post[syn_2d$post == 1] <- 'post'
syn_2d$post[syn_2d$post == 0] <- 'pre'
syn_2d$type = my_synapses$type
syn_2d$name = my_synapses$name
syn_2d$id = my_synapses$bodyid
syn_2d$partnertype = my_synapses$partnertype
syn_2d$partnerName = my_synapses$partnerName
syn_2d$zdir = syn_locs_transf$z
```
```{r}
#syn_2d = syn_2d %>% rowwise() %>% mutate(suptype = strsplit(as.character(type), split="_")[[1]][[1]] ) %>% ungroup()
```


Make list of significant partners
```{r}
ggplot(syn_2d,aes(x=partnertype, fill=partnertype)) + geom_bar() + theme_classic() + 
  theme(axis.text.x = element_text(angle = 90)) + guides(fill=FALSE)
```

```{r}
minSyn = length(my_neurons)*320
majorPartners = as.data.frame(table(unlist(syn_2d$partnertype)))
majorPartners = arrange(majorPartners, desc(Freq)) %>% filter(Freq >= minSyn)
majorPartners

syn_2d_filt = na.omit(syn_2d)
syn_2d_filt = syn_2d_filt  %>% filter(partnertype %in% majorPartners$Var1)

syn_2d_filt = syn_2d_filt %>% 
  mutate(partnerSide = regmatches(partnerName, regexpr("_[R,L]{1}", partnerName)) )
```

### Illustrate synaptic positions across EB slice 
...differentiating by type


```{r}
r3types = c('R3a_a','R3a_b','R3a_c','R3d_a','R3d_b','R3d_c','R3m','R3p_a','R3p_b','R3w_a', 'R3w_b', 'R3w_c')
r3types_a = c('R3a_a','R3a_b','R3a_c','R3d_a','R3d_b','R3d_c','R3m')
r3types_b = c('R3p_a','R3p_b','R3w_a', 'R3w_b', 'R3w_c')
r4types = c('R4d_a','R4d_b','R4m')
```

```{r}
ggplot(syn_2d, aes(x=dist, y=zdir))+ geom_bin2d() +  #geom_point(alpha=0.5) + 
  facet_grid(cols = vars(type), rows=vars(post)) +
  scale_fill_gradient(low='grey', high='black') + 
  guides(color=FALSE) + theme_classic() + theme(axis.text.x = element_text(angle = 90))
```


```{r}
ggplot(syn_2d_filt, aes(x=dist, y=zdir, fill=type)) +
  stat_density_2d(aes(alpha = stat(nlevel)),bins=3, geom = "polygon") +
  facet_grid(cols=vars(post)) + theme_classic() + xlim(500, 5000) + ylim(-1500, 1500) #+ guides(color=FALSE)

```

```{r}
ggplot(syn_2d_filt %>% filter(type %in% r3types_a), aes(x=dist, y=zdir, fill=type)) +
  stat_density_2d(aes(alpha = stat(nlevel)),bins=3, geom = "polygon") +
  facet_grid(cols=vars(post)) + theme_classic() + xlim(500, 5000) + ylim(-1500, 1500) #+ guides(color=FALSE)

ggplot(syn_2d_filt %>% filter(type %in% r3types_b), aes(x=dist, y=zdir, fill=type)) +
  stat_density_2d(aes(alpha = stat(nlevel)),bins=3, geom = "polygon") +
  facet_grid(cols=vars(post)) + theme_classic() + xlim(500, 5000) + ylim(-1500, 1500) #+ guides(color=FALSE)

ggplot(syn_2d_filt %>% filter(type %in% r4types), aes(x=dist, y=zdir, fill=type)) +
  stat_density_2d(aes(alpha = stat(nlevel)),bins=3, geom = "polygon") +
  facet_grid(cols=vars(post)) + theme_classic() + xlim(500, 5000) + ylim(-1500, 1500)#+ guides(color=FALSE)
```

...differentiating by partner
```{r}
ggplot(syn_2d_filt, aes(x=dist, y=zdir, fill=partnertype)) +
  stat_density_2d(aes(alpha = stat(nlevel)), bins=3, geom = "polygon") +
  facet_grid(cols=vars(post)) + theme_classic() + xlim(500, 5000) + ylim(-1500, 1500) #+ guides(color=FALSE)

```

```{r}
#ggplot(syn_2d_filt %>% filter(type %in% r3types_a), aes(x=dist, y=zdir, fill=partnertype)) +
#  stat_density_2d(aes(alpha = stat(nlevel)), bins=3, geom = "polygon") +
#  facet_grid(cols=vars(post)) + theme_classic() + xlim(500, 5000) + ylim(-1500, 1500) #+ guides(color=FALSE)

#ggplot(syn_2d_filt %>% filter(type %in% r3types_b), aes(x=dist, y=zdir, fill=partnertype)) +
#  stat_density_2d(aes(alpha = stat(nlevel)), bins=3, geom = "polygon") +
#  facet_grid(cols=vars(post)) + theme_classic() + xlim(500, 5000) + ylim(-1500, 1500) #+ guides(color=FALSE)

ggplot(syn_2d_filt %>% filter(type %in% r4types), aes(x=dist, y=zdir, fill=partnertype)) +
  stat_density_2d(aes(alpha = stat(nlevel)), bins=3, geom = "polygon") +
  facet_grid(cols=vars(type), rows=vars(post)) + theme_classic() #+ xlim(500, 5000) + ylim(-1500, 1500)#+ guides(color=FALSE)
```


### Spatial inhomogeneity of synapse density along the ring

```{r}
circBins = 16
ggplot(syn_2d_filt, aes(x=angle, color=type)) + geom_freqpoly(bins=circBins) + #, linetype=post
  facet_grid(cols = vars(post)) + theme_classic() + xlim(0, 360) + theme(axis.text.x = element_text(angle = 90)) 

ggplot(syn_2d_filt, aes(x=angle, color=id)) + geom_freqpoly(bins=circBins) +
  facet_grid(cols = vars(type), rows=vars(post)) +
  guides(color=FALSE) + theme_classic() + xlim(0, 360) + theme(axis.text.x = element_text(angle = 90))

ggplot(syn_2d_filt %>% filter(partnertype %in% c("EPG","EQ5","PEN_b(PEN2)","R4d_a","R4d_b","R4m")), 
       aes(x=angle, color=name)) + geom_freqpoly(bins=circBins) +
  facet_wrap(cols = vars(partnertype), rows=vars(post), scales="free") +
  theme_classic() + xlim(0, 360) + theme(axis.text.x = element_text(angle = 90)) #guides(color=FALSE) 
```
```{r}
syn_2d_to_PENa = syn_2d %>% filter(partnertype == "PEN_a(PEN1)") %>% 
  mutate(partnerSide = regmatches(syn_2d_to_PENa$partnerName, regexpr("_[R,L]{1}", syn_2d_to_PENa$partnerName)) )

```

```{r}
circBins = 16

ggplot(syn_2d_filt %>% filter(partnertype == "PEN_a(PEN1)"), aes(x=angle, color=partnerSide)) + geom_freqpoly(bins=circBins) +
  facet_grid(cols = vars(type), rows=vars(post)) +
  theme_classic() + xlim(-5, 365) + theme(axis.text.x = element_text(angle = 90)) #guides(color=FALSE) 

ggplot(syn_2d_filt %>% filter(partnertype == "PEN_a(PEN1)"), aes(x=angle, color=partnerSide, linestyle=partnerName)) + geom_freqpoly(bins=circBins) +
  facet_grid(cols = vars(type), rows=vars(post)) +
  theme_classic() + xlim(-5, 365) + theme(axis.text.x = element_text(angle = 90)) #guides(color=FALSE) 
```

```{r}
circBins = 16

ggplot(syn_2d_filt %>% filter(partnertype == "EPG"), aes(x=angle, color=partnerSide)) + geom_freqpoly(bins=circBins) +
  facet_grid(cols = vars(type), rows=vars(post)) +
  theme_classic() + xlim(-5, 365) + theme(axis.text.x = element_text(angle = 90)) #guides(color=FALSE) 

ggplot(syn_2d_filt %>% filter(partnertype == "EPG"), aes(x=angle, color=partnerSide, linestyle=partnerName)) + geom_freqpoly(bins=circBins) +
  facet_grid(cols = vars(type), rows=vars(post)) +
  theme_classic() + xlim(-5, 365) + theme(axis.text.x = element_text(angle = 90)) #guides(color=FALSE) 
```



```{r}
ggplot(syn_2d, aes(x=dist, stat(density), color=type, linetype=post)) + geom_freqpoly(bins=50) + theme(axis.text.x = element_text(angle = 90)) + 
  theme_classic()

ggplot(syn_2d, aes(x=dist, color=id)) + geom_freqpoly(bins=50) +
  facet_grid(cols = vars(type),rows=vars(post)) + guides(color=FALSE) + theme_classic() + theme(axis.text.x = element_text(angle = 90))
```

### Connection specific analysis (e.g. Ring neuron to EPG)
```{r}
ggplot(syn_2d_filt %>% filter(partnertype =="EPG"), aes(x=dist, color=id)) + geom_freqpoly(bins=15) + 
  facet_grid(cols = vars(type), rows=vars(post)) + xlim(0, 5000) +
  theme_classic() + guides(color=FALSE)

ggplot(syn_2d_filt %>% filter(partnertype =="EPG"), aes(x=angle,  color=id)) + geom_freqpoly(bins=12) + 
  facet_grid(cols = vars(type), rows=vars(post)) +
  theme_classic() + xlim(0, 360) + guides(color=FALSE)
```


```{r}
ggplot(syn_2d_filt %>% filter(partnertype =="EPG"), aes(x=dist, color=name)) + geom_freqpoly(bins=20) + 
  facet_grid(cols = vars(type), rows=vars(post), scales = "free_y") + xlim(500, 5000) + theme_classic() +theme(axis.text.x = element_text(angle = 90)) #+ guides(color=FALSE)

ggplot(syn_2d_filt %>% filter(partnertype =="EPG"), aes(x=zdir, color=name)) + geom_freqpoly(bins=20) + 
  facet_grid(cols = vars(type), rows=vars(post), scales = "free_y") + xlim(-2000, 2000) + theme_classic() +theme(axis.text.x = element_text(angle = 90)) #+ guides(color=FALSE)

ggplot(syn_2d_filt %>% filter(partnertype =="EPG"), aes(x=angle, color=name)) + geom_freqpoly(bins=12) + 
  facet_grid(cols = vars(type), rows=vars(post), scales = "free_y",) + theme_classic() + xlim(0, 360) +theme(axis.text.x = element_text(angle = 90)) #+ guides(color=FALSE)
```

```{r}
colpartners =  c("EPG", "PEN1","PEN2")
ringpartners =  c("R4d_a", "R4d_b","R4m")
exRpartners =  c("ExR4", "ExR5","EQ5")

ggplot(syn_2d_filt) +
  geom_point(data = syn_2d_filt %>% filter(partnertype %in% exRpartners), aes(x=dist, y=zdir), 
             color='orange', size=0.5, alpha=0.3) +
    geom_point(data = syn_2d_filt %>% filter(partnertype %in% colpartners), aes(x=dist, y=zdir), 
             color='plum3', size=0.5, alpha=0.3)  +
  geom_point(data = syn_2d_filt %>% filter(partnertype %in% ringpartners), aes(x=dist, y=zdir), 
             color='turquoise3', size=0.5, alpha=0.3) +
  facet_grid(cols = vars(type), rows=vars(post)) + theme_classic()


ggplot(syn_2d_filt) +
  geom_point(data = syn_2d_filt %>% filter(partnertype %in% exRpartners), aes(x=dist, y=angle), 
             color='orange', size=0.5, alpha=0.3) +
    geom_point(data = syn_2d_filt %>% filter(partnertype %in% colpartners), aes(x=dist, y=angle), 
             color='plum3', size=0.5, alpha=0.3)  +
  geom_point(data = syn_2d_filt %>% filter(partnertype %in% ringpartners), aes(x=dist, y=angle), 
             color='turquoise3', size=0.5, alpha=0.3) +
  facet_grid(cols = vars(type), rows=vars(post)) + theme_classic()

ggplot(syn_2d_filt) +
  geom_point(data = syn_2d_filt %>% filter(partnertype %in% exRpartners), aes(x=zdir, y=angle), 
             color='orange', size=0.5, alpha=0.3) +
    geom_point(data = syn_2d_filt %>% filter(partnertype %in% colpartners), aes(x=zdir, y=angle), 
             color='plum3', size=0.5, alpha=0.3)  +
  geom_point(data = syn_2d_filt %>% filter(partnertype %in% ringpartners), aes(x=zdir, y=angle), 
             color='turquoise3', size=0.5, alpha=0.3) +
  facet_grid(cols = vars(type), rows=vars(post)) + theme_classic()

```
