---
title: "Notebook plotting synapse distributions for columnar neurons of the FB"
output:
  html_document:
    df_print: paged
---

### Command to clear environment is: rm(list = ls(all.names = TRUE))
### Command to update is remotes::update_packages('neuprintr')
### Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(plotly)
library(dplyr)
library(matlib)
library(car)
library(imager)
library(reshape2)
library(zoo)
library(ggpubr)
library(ks)
library(RColorBrewer)
library(ggraph)
library(robustbase)
require(alphahull)
options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose ROI and save/plot directories
```{r}

# The region of interest.
ROI="FB"  

# Directory to save data to.
SaveDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/"

# Directory to save plots to.
PlotDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/ColumnarSynapseLocs/"


```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint server.
```{r}
neuprint_login()
```

### Get general functions
```{r}
source("inputOutputRegionsVis.r")
source("GetNeuronsInRoi.r")
source("SynapsePCAUtils.r")
source("GetRoiMeshOutline.r")
source("FB_SynapseDistribution_Utils.r")
```


### Get neurons in the ROI and
### Exclude neurons not in known FB columnar types
```{r}

# get all FB bodies
NamedBodies = Get_AllNeurons_InRoi(ROI, FALSE)
NamedBodies=ComputeRelativeSynapseCounts(NamedBodies)

# Load known FB types
load(paste(SaveDir,"FB_Types.RData",sep=""))

# Exclude bodies that are not columnar
FB_Columnar_Type=c("PF","Delta","FR","FS","FC")
ExcludedTypes=unique(NamedBodies$bodytype[!( startsWith(NamedBodies$bodytype, FB_Columnar_Type))])
IncludedTypes=unique(NamedBodies$bodytype[( startsWith(NamedBodies$bodytype, FB_Columnar_Type))])
ColumnarBodies=subset(NamedBodies, NamedBodies$bodytype %in% IncludedTypes)


```


### Get synapse distributions for all columnar neurons (or load previous data) and subset by layer
```{r}
# load(paste(SaveDir,"FBColumnarSynapses.RData",sep=""))


# Get synapses in layers 1-9
SynLocs_L1=Get_FBlayer_ColumnarSyns("FBl1","L1",IncludedTypes)
SynLocs_L2=Get_FBlayer_ColumnarSyns("FBl2","L2",IncludedTypes)
SynLocs_L3=Get_FBlayer_ColumnarSyns("FBl3","L3",IncludedTypes)
SynLocs_L4=Get_FBlayer_ColumnarSyns("FBl4","L4",IncludedTypes)
SynLocs_L5=Get_FBlayer_ColumnarSyns("FBl5","L5",IncludedTypes)
SynLocs_L6=Get_FBlayer_ColumnarSyns("FBl6","L6",IncludedTypes)
SynLocs_L7=Get_FBlayer_ColumnarSyns("FBl7","L7",IncludedTypes)
SynLocs_L8=Get_FBlayer_ColumnarSyns("FBl8","L8",IncludedTypes)
SynLocs_L9=Get_FBlayer_ColumnarSyns("FBl9","L9",IncludedTypes)


# Bind layer data into single data frame
FBC_SynsAll = do.call("rbind", list(SynLocs_L1, SynLocs_L2, SynLocs_L3, SynLocs_L4, SynLocs_L5, 
                                    SynLocs_L6, SynLocs_L7, SynLocs_L8, SynLocs_L9))
FBC_SynsAll$Layer=as.factor(FBC_SynsAll$Layer)


# Get meshes
Mesh_FB= neuprint_ROI_mesh("FB")
Mesh_FB_L1= neuprint_ROI_mesh("FBl1")
Mesh_FB_L2= neuprint_ROI_mesh("FBl2")
Mesh_FB_L3= neuprint_ROI_mesh("FBl3")
Mesh_FB_L4= neuprint_ROI_mesh("FBl4")
Mesh_FB_L5= neuprint_ROI_mesh("FBl5")
Mesh_FB_L6= neuprint_ROI_mesh("FBl6")
Mesh_FB_L7= neuprint_ROI_mesh("FBl7")
Mesh_FB_L8= neuprint_ROI_mesh("FBl8")
Mesh_FB_L9= neuprint_ROI_mesh("FBl9")


# Save synapse locations for later loading
save(FBC_SynsAll, Mesh_FB, Mesh_FB_L1, Mesh_FB_L2, Mesh_FB_L3, Mesh_FB_L4, Mesh_FB_L5,
     Mesh_FB_L6, Mesh_FB_L7, Mesh_FB_L8, Mesh_FB_L9, file = paste(SaveDir,"FBColumnarSynapses.RData",sep=""))


# Remove SynLocs of layers
rm(list = c('SynLocs_L1','SynLocs_L2','SynLocs_L3','SynLocs_L4','SynLocs_L5','SynLocs_L6','SynLocs_L7','SynLocs_L8','SynLocs_L9'))


```


# Get mesh points
```{r}

Mesh_FB_Points=MeshPoints(Mesh_FB)
Mesh_FB_L1_Points=MeshPoints(Mesh_FB_L1)
Mesh_FB_L2_Points=MeshPoints(Mesh_FB_L2)
Mesh_FB_L3_Points=MeshPoints(Mesh_FB_L3)
Mesh_FB_L4_Points=MeshPoints(Mesh_FB_L4)
Mesh_FB_L5_Points=MeshPoints(Mesh_FB_L5)
Mesh_FB_L6_Points=MeshPoints(Mesh_FB_L6)
Mesh_FB_L7_Points=MeshPoints(Mesh_FB_L7)
Mesh_FB_L8_Points=MeshPoints(Mesh_FB_L8)
Mesh_FB_L9_Points=MeshPoints(Mesh_FB_L9)

```


# Center synapses and mesh points at new origin
```{r}

# define new origin from roi center of mass
origin = getCOM(Mesh_FB_Points)


#reset orgin of all layers
Mesh_FB_Points = resetOrigin(Mesh_FB_Points, origin)
Mesh_FB_L1_Points = resetOrigin(Mesh_FB_L1_Points, origin)
Mesh_FB_L2_Points = resetOrigin(Mesh_FB_L2_Points, origin)
Mesh_FB_L3_Points = resetOrigin(Mesh_FB_L3_Points, origin)
Mesh_FB_L4_Points = resetOrigin(Mesh_FB_L4_Points, origin)
Mesh_FB_L5_Points = resetOrigin(Mesh_FB_L5_Points, origin)
Mesh_FB_L6_Points = resetOrigin(Mesh_FB_L6_Points, origin)
Mesh_FB_L7_Points = resetOrigin(Mesh_FB_L7_Points, origin)
Mesh_FB_L8_Points = resetOrigin(Mesh_FB_L8_Points, origin)
Mesh_FB_L9_Points = resetOrigin(Mesh_FB_L9_Points, origin)


# Reset origin of all synapses 
FBC_SynsAll = resetOrigin(FBC_SynsAll, origin)


```


# Perform PCA and rotation to get axes
```{r}

#get eigenvectors
roiEigen = covPCA(Mesh_FB_Points)

# Rotate PCs some
RotMat=makeRotMatYZ(-33) # 33
roiEigen$vectors= roiEigen$vectors %*% RotMat
RotMat=makeRotMatXY(-3) # -3
roiEigen$vectors= roiEigen$vectors %*% RotMat

# Project meshes into PCA space
Mesh_FB_Points = changeBasis(Mesh_FB_Points, roiEigen)
Mesh_FB_L1_Points = changeBasis(Mesh_FB_L1_Points, roiEigen)
Mesh_FB_L2_Points = changeBasis(Mesh_FB_L2_Points, roiEigen)
Mesh_FB_L3_Points = changeBasis(Mesh_FB_L3_Points, roiEigen)
Mesh_FB_L4_Points = changeBasis(Mesh_FB_L4_Points, roiEigen)
Mesh_FB_L5_Points = changeBasis(Mesh_FB_L5_Points, roiEigen)
Mesh_FB_L6_Points = changeBasis(Mesh_FB_L6_Points, roiEigen)
Mesh_FB_L7_Points = changeBasis(Mesh_FB_L7_Points, roiEigen)
Mesh_FB_L8_Points = changeBasis(Mesh_FB_L8_Points, roiEigen)
Mesh_FB_L9_Points = changeBasis(Mesh_FB_L9_Points, roiEigen)


# Project synapses into PCA space
FBC_SynsAll=changeBasis_df(FBC_SynsAll, roiEigen)



```


# Get pre and post neuron names based on bodyids
```{r}

# Get pre and post body names (to get PB columns later)
BodyId_And_Names=NamedBodies[c("bodyid","bodyname")]
BodyId_And_PartnerNames=NamedBodies[c("bodyid","bodyname")]
colnames(BodyId_And_PartnerNames)<-c("partner","partnername")
FBC_SynsAll=merge(FBC_SynsAll, BodyId_And_Names, by="bodyid")
FBC_SynsAll=merge(FBC_SynsAll, BodyId_And_PartnerNames, by="partner")


```



# Plot data in new and old reference frame
```{r message=FALSE}


# Make scatter plot new projection
ggplot(Mesh_FB_Points, aes(x=X, y=-Y)) + geom_point(size=1, alpha = 0.05) +  xlab("x=PC1") + ylab("y=PC2") + coord_fixed(ratio = 1) 
ggplot() + geom_point(data=Mesh_FB_Points, aes(x=X, y=-Y), colour= "azure2",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L1_Points, aes(x=X, y=-Y), colour= "azure4",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L2_Points, aes(x=X, y=-Y), colour= "azure2",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L3_Points, aes(x=X, y=-Y), colour= "azure4",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L4_Points, aes(x=X, y=-Y), colour= "azure2",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L5_Points, aes(x=X, y=-Y), colour= "azure4",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L6_Points, aes(x=X, y=-Y), colour= "azure2",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L7_Points, aes(x=X, y=-Y), colour= "azure4",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L8_Points, aes(x=X, y=-Y), colour= "azure2",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L9_Points, aes(x=X, y=-Y), colour= "azure4",  size=1, alpha = 0.01) + coord_fixed(ratio = 1) 



# Make scatter plot of original space
ggplot(Mesh_FB_Points, aes(x=x, y=-z)) + geom_point(size=1, alpha = 0.05) +  xlab("x=PC1") + ylab("y=PC2") + coord_fixed(ratio = 1) 
ggplot() + geom_point(data=Mesh_FB_Points, aes(x=x, y=-z), colour= "azure2",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L1_Points, aes(x=x, y=-z), colour= "azure4",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L2_Points, aes(x=x, y=-z), colour= "azure2",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L3_Points, aes(x=x, y=-z), colour= "azure4",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L4_Points, aes(x=x, y=-z), colour= "azure2",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L5_Points, aes(x=x, y=-z), colour= "azure4",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L6_Points, aes(x=x, y=-z), colour= "azure2",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L7_Points, aes(x=x, y=-z), colour= "azure4",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L8_Points, aes(x=x, y=-z), colour= "azure2",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L9_Points, aes(x=x, y=-z), colour= "azure4",  size=1, alpha = 0.01) + coord_fixed(ratio = 1) 


# Scatter subset of synapses, colored by layer
data2=FBC_SynsAll[seq(from = 1, to = length(FBC_SynsAll$x), by = 500), ]
ggplot() + geom_point(data=Mesh_FB_Points, aes(x=X, y=-Y), colour= "darkgray",  size=1, alpha = 0.01) +
           geom_point(data=data2, aes(x=X, y=-Y, colour= Layer),  size=1, alpha = 0.7) + coord_fixed(ratio = 1) 
remove(data2)




```




# Get rid of original frame (the lowercase x,y,z data)
```{r}

# Meshes
Mesh_FB_Points=Mesh_FB_Points[ , !(names(Mesh_FB_Points) %in% c("x","y","z"))]
Mesh_FB_L1_Points=Mesh_FB_L1_Points[ , !(names(Mesh_FB_L1_Points) %in% c("x","y","z"))]
Mesh_FB_L2_Points=Mesh_FB_L2_Points[ , !(names(Mesh_FB_L2_Points) %in% c("x","y","z"))]
Mesh_FB_L3_Points=Mesh_FB_L3_Points[ , !(names(Mesh_FB_L3_Points) %in% c("x","y","z"))]
Mesh_FB_L4_Points=Mesh_FB_L4_Points[ , !(names(Mesh_FB_L4_Points) %in% c("x","y","z"))]
Mesh_FB_L5_Points=Mesh_FB_L5_Points[ , !(names(Mesh_FB_L5_Points) %in% c("x","y","z"))]
Mesh_FB_L6_Points=Mesh_FB_L6_Points[ , !(names(Mesh_FB_L6_Points) %in% c("x","y","z"))]
Mesh_FB_L7_Points=Mesh_FB_L7_Points[ , !(names(Mesh_FB_L7_Points) %in% c("x","y","z"))]
Mesh_FB_L8_Points=Mesh_FB_L8_Points[ , !(names(Mesh_FB_L8_Points) %in% c("x","y","z"))]
Mesh_FB_L9_Points=Mesh_FB_L9_Points[ , !(names(Mesh_FB_L9_Points) %in% c("x","y","z"))]


#Synapses
FBC_SynsAll=FBC_SynsAll[ , !(names(FBC_SynsAll) %in% c("x","y","z"))]


```




# Get outlines of each layer
```{r}

# Get XY outlines of each layer, with Y direction reverse so dorsal is up
Outline_FB_XY=MeshOutline(Mesh_FB_Points, "XY")
Outline_L1_XY=MeshOutline(Mesh_FB_L1_Points, "XY")
Outline_L2_XY=MeshOutline(Mesh_FB_L2_Points, "XY")
Outline_L3_XY=MeshOutline(Mesh_FB_L3_Points, "XY")
Outline_L4_XY=MeshOutline(Mesh_FB_L4_Points, "XY")
Outline_L5_XY=MeshOutline(Mesh_FB_L5_Points, "XY")
Outline_L6_XY=MeshOutline(Mesh_FB_L6_Points, "XY")
Outline_L7_XY=MeshOutline(Mesh_FB_L7_Points, "XY")
Outline_L8_XY=MeshOutline(Mesh_FB_L8_Points, "XY")
Outline_L9_XY=MeshOutline(Mesh_FB_L9_Points, "XY")


# Get XZ outlines of each layer, with Y direction reverse so dorsal is up
Outline_FB_XZ=MeshOutline(Mesh_FB_Points, "XZ")
Outline_L1_XZ=MeshOutline(Mesh_FB_L1_Points, "XZ")
Outline_L2_XZ=MeshOutline(Mesh_FB_L2_Points, "XZ")
Outline_L3_XZ=MeshOutline(Mesh_FB_L3_Points, "XZ")
Outline_L4_XZ=MeshOutline(Mesh_FB_L4_Points, "XZ")
Outline_L5_XZ=MeshOutline(Mesh_FB_L5_Points, "XZ")
Outline_L6_XZ=MeshOutline(Mesh_FB_L6_Points, "XZ")
Outline_L7_XZ=MeshOutline(Mesh_FB_L7_Points, "XZ")
Outline_L8_XZ=MeshOutline(Mesh_FB_L8_Points, "XZ")
Outline_L9_XZ=MeshOutline(Mesh_FB_L9_Points, "XZ")


# Check layer 4/7, which have holes
ggplot() + geom_point(data=Mesh_FB_L4_Points, aes(x=X, y=Z), colour= 'blueviolet',  size=1, alpha = 0.05) + 
  coord_fixed(ratio = 1) +  theme_void() + guides(color=FALSE) +
  geom_path(data=Outline_L4_XZ, aes(x=c1, y=c2), size = 1) 

ggplot() + geom_point(data=Mesh_FB_L7_Points, aes(x=X, y=Z), colour= 'blueviolet',  size=1, alpha = 0.05) + 
  coord_fixed(ratio = 1) +  theme_void() + guides(color=FALSE) +
  geom_path(data=Outline_L7_XZ, aes(x=c1, y=c2), size = 1) 


```

# Post-process layers 4,6 to make smooth
```{r}

# Layer 4
Bad_L4_Inds=which( abs(diff(Outline_L4_XZ$c2))>1000)
Outline_L4_XZ = Outline_L4_XZ[ - seq((Bad_L4_Inds[1]+1),Bad_L4_Inds[length(Bad_L4_Inds)]), ]

# Layer 7 XZ
Bad_L7_Inds=which( abs(diff(Outline_L7_XZ$c2))>1000)
Outline_L7_XZ = Outline_L7_XZ[ - seq((Bad_L7_Inds[1]+1),Bad_L7_Inds[length(Bad_L7_Inds)]), ] 

# Check that holes have been removed
ggplot() + geom_point(data=Mesh_FB_L4_Points, aes(x=X, y=Z), colour= 'blueviolet',  size=1, alpha = 0.05) + 
  coord_fixed(ratio = 1) +  theme_void() + guides(color=FALSE) +
  geom_path(data=Outline_L4_XZ, aes(x=c1, y=c2), size = 1) 

ggplot() + geom_point(data=Mesh_FB_L7_Points, aes(x=X, y=Z), colour= 'blueviolet',  size=1, alpha = 0.05) + 
  coord_fixed(ratio = 1) +  theme_void() + guides(color=FALSE) +
  geom_path(data=Outline_L7_XZ, aes(x=c1, y=c2), size = 1) 

```


# Save data for later loading
```{r}

# Save synapse locations for later loading
save(NamedBodies, FB_Columnar_Type, ColumnarBodies, FBC_SynsAll, Mesh_FB_Points, Mesh_FB_L1_Points, Mesh_FB_L2_Points, Mesh_FB_L3_Points, Mesh_FB_L4_Points,
     Mesh_FB_L5_Points, Mesh_FB_L6_Points, Mesh_FB_L7_Points, Mesh_FB_L8_Points, Mesh_FB_L9_Points,
     roiEigen, origin, Outline_FB_XY,  Outline_L1_XY,  Outline_L2_XY,  Outline_L3_XY,  Outline_L4_XY,  Outline_L5_XY,  
     Outline_L6_XY,    Outline_L7_XY,  Outline_L8_XY,  Outline_L9_XY,  Outline_FB_XZ,  Outline_L1_XZ,  Outline_L2_XZ,
     Outline_L3_XZ,    Outline_L4_XZ,  Outline_L5_XZ,  Outline_L6_XZ,  Outline_L7_XZ,  Outline_L8_XZ,  Outline_L9_XZ,
     file = paste(SaveDir,"FBColumnarSynapses_PostPCA.RData",sep=""))
     
```


#####################################################################
###### PRE PROCESSING ENDS HERE #####################################
#####################################################################


# Load pre-processed data
```{r}

load(paste(SaveDir,"FBColumnarSynapses_PostPCA.RData",sep=""))

```



# Get PB glomeruli or columns (Some columns are mixed and are named _L1/2 for example)
```{r}


# Assign side (pb or fb column half)
FBC_SynsAll$Side=NA
FBC_SynsAll$Side[grepl("_R",FBC_SynsAll$bodyname)]<-"R"
FBC_SynsAll$Side[grepl("_L",FBC_SynsAll$bodyname)]<-"L"

# Assign PB glom
FBC_SynsAll$PBglom=NA
RightColumns=str_extract(FBC_SynsAll$bodyname, "_R(\\d+)")
LeftColumns=str_extract(FBC_SynsAll$bodyname, "_L(\\d+)")
FBC_SynsAll$PBglom[which(!is.na(RightColumns))]=RightColumns[which(!is.na(RightColumns))]
FBC_SynsAll$PBglom[which(!is.na(LeftColumns))]=LeftColumns[which(!is.na(LeftColumns))]
FBC_SynsAll$PBglom=sapply(FBC_SynsAll$PBglom, substring, 2, 3)

# Assign FB glom
FBC_SynsAll$FBcol=NA
FBC_SynsAll$FBcol=str_extract(FBC_SynsAll$bodyname, "_C(\\d+)")
FBC_SynsAll$FBcol=sapply(FBC_SynsAll$FBcol, substring, 2, 3)


# Manually change PB glom of one neuron (PFNp_a)
FBC_SynsAll$PBglom[FBC_SynsAll$bodyid == 912898873] = "L2"
FBC_SynsAll$PBglom[FBC_SynsAll$bodyid == 5813128416] = NA


```



### Get general plotting and analysis functions
```{r}

source("FB_SynapseDistribution_Utils.R")
source("FB_LayerOutline_Utils.R")

```



# Bisect FB layer outlines
```{r}

Mid_L1=Get_Mid(Outline_L1_XZ)
Mid_L2=Get_Mid(Outline_L2_XZ)
Mid_L3=Get_Mid(Outline_L3_XZ)
Mid_L4=Get_Mid(Outline_L4_XZ)
Mid_L5=Get_Mid(Outline_L5_XZ)
Mid_L6=Get_Mid(Outline_L6_XZ)
Mid_L7=Get_Mid(Outline_L7_XZ)
Mid_L8=Get_Mid(Outline_L8_XZ)


```



# Get synapse distribution information from FX neurons 
```{r}


# Make plotting directories
Fx_Dir=paste(PlotDir,"FX_Plots_All","/",sep="")
Fx_Dir_Dist=paste(Fx_Dir,"FX_Dist","/",sep="")
Fx_Dir_SynScatter=paste(Fx_Dir,"FX_SynScatter","/",sep="")
Fx_Dir_Crosses=paste(Fx_Dir,"FX_Crosses","/",sep="")
if (!dir.exists(Fx_Dir)){dir.create(Fx_Dir)}
if (!dir.exists(Fx_Dir_Dist)){dir.create(Fx_Dir_Dist)}
if (!dir.exists(Fx_Dir_SynScatter)){dir.create(Fx_Dir_SynScatter)}
if (!dir.exists(Fx_Dir_Crosses)){dir.create(Fx_Dir_Crosses)}

# Get all FX neurons (FC, FS, FR)
All_Fx=subset(FBC_SynsAll, !(is.na(FBcol)) & startsWith(type,"F"))
All_Fx$FBcol=factor(All_Fx$FBcol, levels=sort(unique(All_Fx$FBcol)) )


# Get synapse distributions per layer
FX_Distribution=Get_SynLayerDistribution(All_Fx, 50, Fx_Dir_Dist) # 50 is good here


# Plot distribution of all synapses in entire FB and by layer
PlotSyns_byColumn(All_Fx, "FX All", "FX_All", Fx_Dir, TRUE, TRUE)
PlotSyns_byLayer(All_Fx, "FX All", "FX_All_Layers", "FBcol", Fx_Dir_SynScatter, TRUE, TRUE)


# Make the same plots but per neuron type 
FX_Types=unique(All_Fx$type)
for (ttt in 1:length(FX_Types)){
  SubData=subset(All_Fx, type == FX_Types[ttt])
  PlotSyns_byColumn(SubData, FX_Types[ttt], paste("FX_",FX_Types[ttt],sep=""), Fx_Dir_SynScatter, TRUE, FALSE)
}
for (ttt in 1:length(FX_Types)){
  SubData=subset(All_Fx, type == FX_Types[ttt])
  PlotSyns_byLayer(SubData, FX_Types[ttt], paste("FX_",FX_Types[ttt],"_Layers",sep=""), "FBcol", Fx_Dir_SynScatter, FALSE, FALSE)
}



```



# For each layer, define mean column position based on FX data and plot
```{r}


# Get average X/Z position of each column in each layer
FX_Column_Positions = as.data.frame(FX_Distribution %>% group_by(FBcol, Layer, type) %>% 
                                      summarise(X_Mean = mean(X_Mean), Y_Mean=mean(Y_Mean), Z_Mean = mean(Z_Mean),
                                                Cross_XL_X = mean(Cross_XL_X), Cross_XL_Z = mean(Cross_XL_Z),
                                                Cross_XR_X = mean(Cross_XR_X), Cross_XR_Z = mean(Cross_XR_Z),
                                                Cross_YU_X = mean(Cross_YU_X), Cross_YU_Z = mean(Cross_YU_Z),
                                                Cross_YD_X = mean(Cross_YD_X), Cross_YD_Z = mean(Cross_YD_Z)))
 
                          
# Plot the distribution of Fx column positions for all Fx neurons and each Fx type individually 
PlotColumn_Aves(FX_Column_Positions, "FX_Columns_All", Fx_Dir_Crosses, FALSE)
PlotColumn_Types(FX_Column_Positions, "FX_Columns", Fx_Dir_Crosses, FALSE) 


# Subset Fx column positions to include only those neurons that innervate all columns in a layer
FX_ColumnsInnervatedPerLayer= FX_Column_Positions %>% group_by(type, Layer) %>% summarise(n=n())
FX_ColumnsInnervatedPerLayer= subset(FX_ColumnsInnervatedPerLayer, n==9) 


# Get just those layers where the FX neuron types innervates all columns
FX_Column_Positions_Filt= inner_join(FX_Column_Positions, FX_ColumnsInnervatedPerLayer, by = c("type","Layer"))


# Replot data
PlotColumn_Aves(FX_Column_Positions_Filt, "FX_Columns_All_Filt", Fx_Dir_Crosses, FALSE)
PlotColumn_Types(FX_Column_Positions_Filt, "FX_Columns_Filt", Fx_Dir_Crosses, FALSE) 


# Subset FX_Distribution based on neurons that innervate all columns of a layer
FX_Distribution_Filt= inner_join(FX_Distribution, FX_ColumnsInnervatedPerLayer, by = c("type","Layer"))



```



# Get PB-FB-XX and Delta0 synapse distribution data
```{r}

# Make PB-FB-X  plotting directory
PFX_Dir=paste(PlotDir,"FPX_Plots_All","/",sep="")
PFX_Dir_Dist=paste(PFX_Dir,"PFX_Dist","/",sep="")
PFX_Dir_Mapping=paste(PFX_Dir,"PFX_Mapping","/",sep="")
PFX_Dir_MapGraph=paste(PFX_Dir,"PFX_MapGraph","/",sep="")
PFX_Dir_Crosses=paste(PFX_Dir,"PFX_Crosses","/",sep="")
if (!dir.exists(PFX_Dir)){dir.create(PFX_Dir)}
if (!dir.exists(PFX_Dir_Dist)){dir.create(PFX_Dir_Dist)}
if (!dir.exists(PFX_Dir_Mapping)){dir.create(PFX_Dir_Mapping)}
if (!dir.exists(PFX_Dir_MapGraph)){dir.create(PFX_Dir_MapGraph)}
if (!dir.exists(PFX_Dir_Crosses)){dir.create(PFX_Dir_Crosses)}

# Get PB-FB-X neuron synapse locations per layer
All_PFX=subset(FBC_SynsAll, !(is.na(PBglom)) & startsWith(type,"PF"))
PFX_Distribution=Get_SynLayerDistribution(All_PFX, 25, PFX_Dir_Dist) # 25 is good here, as some types have low synapse counts


# Make plotting directory
D0_Dir=paste(PlotDir,"D0_Plots_All","/",sep="")
D0_Dir_Dist=paste(D0_Dir,"D0_Dist","/",sep="")
if (!dir.exists(D0_Dir)){dir.create(D0_Dir)}
if (!dir.exists(D0_Dir_Dist)){dir.create(D0_Dir_Dist)}

# Get Delta0 neuron synapse locations per layer
All_D0=subset(FBC_SynsAll, startsWith(type,"Delta0") & !startsWith(bodyname,"Delta12"))
D0_Distribution=Get_SynLayerDistribution(All_D0, 25, D0_Dir_Dist) # 25 is good here, as some types have low synapse counts


```



# Subset PFX_Distribution and D0_Distribution by layers that contain all neurons of the population type
```{r}

# Subaet PFX data to include only layers innervated by all neurons of a type
PFX_NamedBodies=subset(NamedBodies, startsWith(bodytype,"PF")) 
PFX_NeuronsPerType = PFX_NamedBodies %>% group_by(bodytype) %>% summarise(NeuronsPerType=n())
colnames(PFX_NeuronsPerType)[1]="type"
PFX_NeuronsOfTypePerLayer= PFX_Distribution %>% group_by(type, Layer) %>% summarise(NeuronsPerLayer=n())
PFX_NeuronsOfTypePerLayer=merge(PFX_NeuronsOfTypePerLayer, PFX_NeuronsPerType)
PFX_NeuronsOfTypePerLayer$PercentInLayer=PFX_NeuronsOfTypePerLayer$NeuronsPerLayer/PFX_NeuronsOfTypePerLayer$NeuronsPerType*100 
PFX_NeuronsOfTypePerLayer = subset(PFX_NeuronsOfTypePerLayer, PercentInLayer>90) #PFNp_a has less than 100- 4 bodies dont innervate pb glom. PFNp_b has one neuron missing.
PFX_Distribution_Filt=inner_join(PFX_Distribution, PFX_NeuronsOfTypePerLayer, by = c("type","Layer"))
remove(PFX_Distribution)

# Subaet D0 data to include only layers innervated by all neurons of a type


```



# Assign the PB-FB-XX and Delta0 neurons to columns defined by the closet FX column for each layer.
# Plot the PB-FB glomerulus->column pattern for each PB-FB-XX neuron
```{r}


library(ggraph)
library(igraph)
library(tidygraph)
source("FB_SynapseDistribution_Utils.R")


# Assign column names based on closest neuron
PFX_Distribution_Columns = Assign_FB_Columns3(PFX_Distribution_Filt, FX_Distribution_Filt, PFX_Dir_Mapping)
PFX_Distribution_Columns$PBglom = factor(PFX_Distribution_Columns$PBglom, levels= c("L9","L8","L7","L6","L5","L4","L3","L2","L1",
                                                                    "R1","R2","R3","R4","R5","R6","R7","R8","R9")) 
remove(PFX_Distribution_Filt)

# Get number of neurons going from each glom to each column
PFX_GlomToColumn_All=PFX_Distribution_Columns %>% group_by(bodyid, type, PBglom, FBcol) %>% summarise(Num_layers = n(), FBcol_Con= mean(FBcol_Con))
PFX_GlomToColumn_All=PFX_GlomToColumn_All %>% group_by(type, PBglom, FBcol) %>% summarise(Num_Neurons = n(), FBcol_Con= mean(FBcol_Con))



# Plot PB->FB mapping as a graph
Plot_PBglom_FBcol_Mapping(PFX_GlomToColumn_All, PFX_Dir_MapGraph, "ALL")


# Manually update mappings to correct what we think are errors
PFX_GlomToColumn_Sym=PFX_GlomToColumn_All
UpdateMapping=data.frame(type = character(), PBglom =  character(), FBcol=  character(), FBcol_New =  character() )
UpdateMapping=rbind(UpdateMapping,
                    data.frame(type = "PFGs", PBglom = "L8", FBcol= "C9", FBcol_New = "C8" ),
                    data.frame(type = "PFGs", PBglom = "L7", FBcol= "C8", FBcol_New = "C7" ),
                    data.frame(type = "PFL1", PBglom = "R6", FBcol= "C2", FBcol_New = "C3" ),
                    data.frame(type = "PFL1", PBglom = "R5", FBcol= "C3", FBcol_New = "C4" ),
                    data.frame(type = "PFNa", PBglom = "L7", FBcol= "C7", FBcol_New = "C6" ),
                    data.frame(type = "PFNd", PBglom = "R8", FBcol= "C3", FBcol_New = "C2" ),
                    data.frame(type = "PFNd", PBglom = "L5", FBcol= "C5", FBcol_New = "C4" ),
                    data.frame(type = "PFNp_a", PBglom = "L4", FBcol= "C4", FBcol_New = "C3" ),
                    data.frame(type = "PFNp_a", PBglom = "L3", FBcol= "C1", FBcol_New = "C2" ),
                    data.frame(type = "PFNp_c", PBglom = "L9", FBcol= "C8", FBcol_New = "C9" ),
                    data.frame(type = "PFR_a", PBglom = "L8", FBcol= "C9", FBcol_New = "C8" ),
                    data.frame(type = "PFNp_b", PBglom = "R2", FBcol= "C8", FBcol_New = "C9"),
                    data.frame(type = "PFNp_b", PBglom = "L6", FBcol= "C6", FBcol_New = "C5"),
                    data.frame(type = "PFL3", PBglom = "L3", FBcol= "C6", FBcol_New = "C5" ),
                    data.frame(type = "PFL3", PBglom = "R1", FBcol= "C8", FBcol_New = "C7" ))



# Create new mapping with corrections from UpdateMapping  
N_Count=0
for (rrr in 1:length(UpdateMapping$type)){
  Row_Ind=which(as.character(PFX_GlomToColumn_Sym$type) == as.character(UpdateMapping$type[rrr]) &
                as.character(PFX_GlomToColumn_Sym$PBglom) == as.character(UpdateMapping$PBglom[rrr]) &
                as.character(PFX_GlomToColumn_Sym$FBcol) == as.character(UpdateMapping$FBcol[rrr]) )
  PFX_GlomToColumn_Sym$FBcol[Row_Ind] = as.character(UpdateMapping$FBcol_New[rrr])
  N_Count=N_Count+length(Row_Ind)
}
PFX_GlomToColumn_Sym = PFX_GlomToColumn_Sym %>% group_by(type, PBglom, FBcol) %>% summarise(Num_Neurons = sum(Num_Neurons),  FBcol_Con = mean(FBcol_Con))

# Plot NEW PB->FB mapping as a graph
Plot_PBglom_FBcol_Mapping(PFX_GlomToColumn_Sym, PFX_Dir_MapGraph, "SYM")

# Get number of neurons mapped from glom to cols
PFX_NeuonrsPerTypeWithMappings=PFX_GlomToColumn_All %>% group_by(type) %>% summarize(Num = sum(Num_Neurons))


```



# Now that we have the columns (in PFX_Distribution_Columns), assign them to All_PFX and plot the crosses
```{r}


# Get subset of mapping information
PFX_Distribution_Columns_Mapping=PFX_Distribution_Columns[c("bodyid","PBglom","FBcol")]


# Update All_PFX
Temp_ColNames=colnames(All_PFX)
All_PFX=All_PFX[!colnames(All_PFX)=="FBcol"]
All_PFX=inner_join(All_PFX, PFX_Distribution_Columns_Mapping, by=c("bodyid","PBglom"))
All_PFX=All_PFX[Temp_ColNames]


# Get average X/Z position of each column in each layer
PFX_Column_Positions = as.data.frame(PFX_Distribution_Columns %>% group_by(FBcol, Layer, type) %>% 
                                      summarise(X_Mean = mean(X_Mean), Y_Mean=mean(Y_Mean), Z_Mean = mean(Z_Mean),
                                                Cross_XL_X = mean(Cross_XL_X), Cross_XL_Z = mean(Cross_XL_Z),
                                                Cross_XR_X = mean(Cross_XR_X), Cross_XR_Z = mean(Cross_XR_Z),
                                                Cross_YU_X = mean(Cross_YU_X), Cross_YU_Z = mean(Cross_YU_Z),
                                                Cross_YD_X = mean(Cross_YD_X), Cross_YD_Z = mean(Cross_YD_Z)))


# Plot the distribution of PB-FB-XX column positions for all neurons and each type individually 
PlotColumn_Aves(PFX_Column_Positions, "PFX_Columns_All", PFX_Dir_Crosses, FALSE)
PlotColumn_Types(PFX_Column_Positions, "PFX_Columns", PFX_Dir_Crosses, FALSE) 

# Save entire workspace to file
save.image(file=paste(SaveDir,'All_Data.Rdata',sep=""))



```




# Plot connectivity to of PB-FB-XX neurons to check for offsets 
```{r}


source("InputOutputByTypeUtils.R")
source("neuprintQueryUtils.R")


PFX_Types=unique(PFX_NeuronsPerType$type)
PFX_Bag=buildInputsOutputsByType(PFX_Types[2], slctROI="FB")
PFX_FB_Outputs=PFX_Bag[["outputs_raw"]]
PFX_FB_Inputs=PFX_Bag[["inputs_raw"]]



for (nnn in 1:length()){
  Temp_Type=PFX_Types[nnn]
  Temp_OutputTable=subset(PFX_FB_Outputs, databaseType.from == Temp_Type=PFX_Types[nnn])
  
  Temp_Bag <- buildInputsOutputsByType(Temp_Type, slctROI="FB")
  
  A=res[["outputs_raw"]]

  
  
}


 buildInputsOutputsByType(c("PFN.*"))



```



















# Delta0 neuron plots/analysis
```{r}









  










```




# Plot width of all cell types
```{r}



# Get all synapse distribution data
All_Distributions=rbind(FX_Distribution, PFX_Distribution, D0_Distribution)



##################### Group by neuron type ###########################
# Group my neuron type and average

All_TypeSummary=All_Distributions %>% group_by(type, Layer) %>% summarise(Width = mean(X_HW_Orth*2), SEM= sd(X_HW_Orth*2)/length(X_HW_Orth)^0.5,
  NormWidth=mean((X_HW_Orth*2)/LayerLength), Norm_SEM = sd((X_HW_Orth*2)/LayerLength)/length(X_HW_Orth)^0.5 )
All_TypeSummary=subset(All_TypeSummary, !is.na(All_TypeSummary$SEM))

# Make plot
ggplot(All_TypeSummary, aes(x=Layer, y=Width, group=type, color=type)) + 
  geom_line() + geom_point()+ geom_errorbar(aes(ymin=Width-SEM, ymax=Width+SEM), width=.25,position=position_dodge(0)) +
  ylim(c(0,6000))


ggplot(All_TypeSummary, aes(x=Layer, y=NormWidth, group=type, color=type)) + 
  geom_line() + geom_point()+ geom_errorbar(aes(ymin=NormWidth-Norm_SEM, ymax=NormWidth+Norm_SEM), width=.25,position=position_dodge(0)) +
  ylim(c(0,0.4))


##################### Group by neuron class ###########################

All_Distributions$Grouping=NA
All_Distributions$type=as.character(All_Distributions$type)
All_Distributions$Grouping[ startsWith(All_Distributions$type, "Delta0") ]  ="Delta0"
All_Distributions$Grouping[ startsWith(All_Distributions$type, "FC") |
                            startsWith(All_Distributions$type, "FR") |
                            startsWith(All_Distributions$type, "FS") ]  ="FX"
All_Distributions$Grouping[ startsWith(All_Distributions$type, "PF") ]  ="PB-FB-XX"
All_Distributions$Grouping=factor(All_Distributions$Grouping, levels = c("Delta0", "FX", "PB-FB-XX"))


All_GroupSummary=All_Distributions %>% group_by(Grouping, Layer) %>% summarise(Width = mean(X_HW_Orth*2), CON= 1.96*sd(X_HW_Orth*2)/length(X_HW_Orth)^0.5,
  NormWidth=mean((X_HW_Orth*2)/LayerLength), Norm_CON = 1.96*sd((X_HW_Orth*2)/LayerLength)/length(X_HW_Orth)^0.5 )
All_GroupSummary=subset(All_GroupSummary, !is.na(All_GroupSummary$CON))



P1<-ggplot(All_GroupSummary, aes(x=Layer, y=NormWidth, group=Grouping, color=Grouping)) +  geom_line(size=0.5) + 
  geom_linerange(aes(ymin=NormWidth-Norm_CON, ymax=NormWidth+Norm_CON), size=1, fatten = 1) +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.text.x = element_text(size=18),  
    axis.text.y = element_text(size=18)) + 
    scale_y_continuous( limits = c(0, 3/9), expand = c(0,0) , breaks = c(0, signif(1/9, digits=2), signif(2/9, digits=2), signif(3/9, digits=2))) +
    ylab("Width (% of layer width)") +
    geom_hline(yintercept=signif(1/9, digits=2), linetype="dashed", color = "black") + 
    geom_hline(yintercept=signif(2/9, digits=2), linetype="dashed", color = "black") 

ggsave(paste(PlotDir, "NeuronClass_NormWidth_ByLayer" , ".pdf",sep=""), plot = P1, device='pdf', scale = 1, width = 8, height = 5, units ="in", dpi = 500, limitsize = TRUE,  bg = "transparent")


##################### Group by neuron types ###########################


All_Distributions_Fx_PFX=subset(All_Distributions, Grouping %in% c("FX","PB-FB-XX") )


All_Distributions_Fx_PFX$Grouping=NA
All_Distributions_Fx_PFX$type=as.character(All_Distributions_Fx_PFX$type)
All_Distributions_Fx_PFX$Grouping[ startsWith(All_Distributions_Fx_PFX$type, "FC")] = "FC"
All_Distributions_Fx_PFX$Grouping[ startsWith(All_Distributions_Fx_PFX$type, "FR")] = "FR"
All_Distributions_Fx_PFX$Grouping[ startsWith(All_Distributions_Fx_PFX$type, "FS")] = "FS"
All_Distributions_Fx_PFX$Grouping[ startsWith(All_Distributions_Fx_PFX$type, "PFN")] = "PFN"
All_Distributions_Fx_PFX$Grouping[ startsWith(All_Distributions_Fx_PFX$type, "PFL")] = "PFL"
All_Distributions_Fx_PFX$Grouping[ startsWith(All_Distributions_Fx_PFX$type, "PFG")] = "PFG"
All_Distributions_Fx_PFX$Grouping[ startsWith(All_Distributions_Fx_PFX$type, "PFR")] = "PFR"
All_Distributions_Fx_PFX$Grouping=factor(All_Distributions_Fx_PFX$Grouping, levels = c("FC", "FR", "FS", "PFN", "PFL", "PFG", "PFR"))



All_GroupSummary_Fx_PFX=All_Distributions_Fx_PFX %>% group_by(Grouping, Layer) %>% summarise(Width = mean(X_HW_Orth*2), CON= 1.96*sd(X_HW_Orth*2)/length(X_HW_Orth)^0.5,
  NormWidth=mean((X_HW_Orth*2)/LayerLength), Norm_CON = 1.96*sd((X_HW_Orth*2)/LayerLength)/length(X_HW_Orth)^0.5 )
All_GroupSummary_Fx_PFX=subset(All_GroupSummary_Fx_PFX, !is.na(All_GroupSummary_Fx_PFX$CON))



P1<-ggplot(All_GroupSummary_Fx_PFX, aes(x=Layer, y=NormWidth, group=Grouping, color=Grouping)) +  geom_line(size=0.5) + 
  geom_linerange(aes(ymin=NormWidth-Norm_CON, ymax=NormWidth+Norm_CON), size=1, fatten = 1) +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.text.x = element_text(size=18),  
    axis.text.y = element_text(size=18)) + 
    scale_y_continuous( limits = c(0, 2/9), expand = c(0,0) , breaks = c(0, signif(1/9, digits=2), signif(2/9, digits=2))) +
    ylab("Width (% of layer width)") +
    geom_hline(yintercept=signif(1/9, digits=2), linetype="dashed", color = "black")


ggsave(paste(PlotDir, "ColumnarType_NormWidth_ByLayer" , ".pdf",sep=""), plot = P1, device='pdf', scale = 1, width = 8, height = 5, units ="in", dpi = 500, limitsize = TRUE,  bg = "transparent")



```










# Delta 12 plots
```{r}


# Get D12 neuron data
All_D12=subset(FBC_SynsAll, startsWith(type,"Delta0") & startsWith(bodyname,"Delta12"))
Unique_type=unique(All_D12$type)

for (nnn in 1:length(unique(All_D12$bodyid))){
  
  TempSyns=subset(All_D12, type==Unique_type[nnn])
  
  
   # Make plot
  P1<-ggplot() + geom_point(data=TempSyns, aes(x=X, y=-Y, color=bodyname) ,  size=2, alpha = 0.1, stroke = 0, shape=16) + 
    xlim(c(-9000, 9000)) + coord_fixed(ratio = 1) +
    theme_void() + guides(fill=FALSE) + theme(legend.position = "left") +
    geom_path(data=Outline_FB_XY, aes(x=c1, y=c2), size = 1) + ggtitle(paste("Type: ", TempSyns$type[1],sep=""))

 
  ggsave(paste(DIR, "Two_Type_", TempSyns$type[1], ".png",sep=""), plot = P1, device='png', scale = 1, width = 8, height = 5, units ="in", dpi = 500, limitsize = TRUE) 
  
  
  
  TempTempSyns=TempSyns
  TempTempSyns$Class=NA
  TempTempSyns$Class[ startsWith(TempTempSyns$partner_type, "PF") ] = "PB-FB-XX"
  TempTempSyns$Class[ startsWith(TempTempSyns$partner_type, "FR") |
                      startsWith(TempTempSyns$partner_type, "FS") |
                      startsWith(TempTempSyns$partner_type, "FC") ] = "FX"
  TempTempSyns$Class[ startsWith(TempTempSyns$partner_type, "Delta0") ] = "Delta0"
  TempTempSyns$Class[ startsWith(TempTempSyns$partner_type, "Delta6") ] = "Delta6"
  TempTempSyns$Class[ startsWith(TempTempSyns$partner_type, "SAF") ] = "AB"
  TempTempSyns$Class[ startsWith(TempTempSyns$partner_type, "FB") ] = "FB Tan"
  TempTempSyns$Class=factor(TempTempSyns$Class, levels=c("Delta6", "AB", "PB-FB-XX", "FB Tan", "FX", "Delta0" ) )
  
  # Make plot
  P1<-ggplot() + geom_point(data=TempTempSyns, aes(x=X, y=-Y, color=Class) ,  size=2, alpha = 0.1, stroke = 0, shape=16) +
    xlim(c(-9000, 9000)) + coord_fixed(ratio = 1) +
    theme_void() + guides(fill=FALSE) + theme(legend.position = "left") +
    geom_path(data=Outline_FB_XY, aes(x=c1, y=c2), size = 1) + ggtitle(paste("Type: ", TempSyns$type[1],sep="")) + facet_grid(cols = vars(prepost)) + 
    guides(colour = guide_legend(override.aes = list(alpha = 1)))
  
  ggsave(paste(DIR, "Partners_", TempSyns$type[1], ".png",sep=""), plot = P1, device='png', scale = 1, width = 12, height = 5, units ="in", dpi = 500, limitsize = TRUE) 
    
  
  
}


```







# Make plots of FB layers as a schematic
```{r}


# Make scatter plot new projection
AAA=0.025
SSS=2
P1<-ggplot() + geom_point(data=Mesh_FB_Points, aes(x=X, y=-Y), colour= "azure4",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L1_Points, aes(x=X, y=-Y), colour= "azure2",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L2_Points, aes(x=X, y=-Y), colour= "azure4",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L3_Points, aes(x=X, y=-Y), colour= "azure2",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L4_Points, aes(x=X, y=-Y), colour= "azure4",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L5_Points, aes(x=X, y=-Y), colour= "azure2",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L6_Points, aes(x=X, y=-Y), colour= "azure4",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L7_Points, aes(x=X, y=-Y), colour= "azure2",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L8_Points, aes(x=X, y=-Y), colour= "azure4",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L9_Points, aes(x=X, y=-Y), colour= "azure2",  size=SSS, alpha = AAA) + 
          coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position="none")
ggsave(paste(PlotDir, "FB_1.png",sep=""),
       plot = P1, device='png', scale = 1, width = 6, height = 6, units ="in", dpi = 300, limitsize = TRUE)



```






# Old code
```{r}


# Set levels
PFX_Distribution$Layer=as.character(PFX_Distribution$Layer)
PFX_Distribution$Layer=factor(PFX_Distribution$Layer, levels = sort(unique(PFX_Distribution$Layer)) )

# Set group
PFX_Distribution$Grouping=NA
PFX_Distribution$Grouping[startsWith(as.character(PFX_Distribution$type),"PFN")]<-"PFN"
PFX_Distribution$Grouping[startsWith(as.character(PFX_Distribution$type),"PFR")]<-"PFR"
PFX_Distribution$Grouping[startsWith(as.character(PFX_Distribution$type),"PFL")]<-"PFL"
PFX_Distribution$Grouping[startsWith(as.character(PFX_Distribution$type),"PFG")]<-"PFG"
PFX_Distribution$Grouping=factor(PFX_Distribution$Grouping, levels=c("PFN","PFR","PFL","PFG"))


# compute mean and SEM 
PFX_TypeSummary=PFX_Distribution %>% group_by(Grouping, Layer) %>% summarise(Width = mean(X_HW_Orth*2), SEM= sd(X_HW_Orth*2)/length(X_HW_Orth)^0.5,
  NormWidth=mean((X_HW_Orth*2)/LayerLength), Norm_SEM = sd((X_HW_Orth*2)/LayerLength)/length(X_HW_Orth)^0.5 )

# Make plot
ggplot(PFX_TypeSummary, aes(x=Layer, y=Width, group=Grouping, color=Grouping)) + 
  geom_line() + geom_point()+ geom_errorbar(aes(ymin=Width-SEM, ymax=Width+SEM), width=.25,position=position_dodge(0)) +
  ylim(c(0,5000))

ggplot(PFX_TypeSummary, aes(x=Layer, y=NormWidth, group=Grouping, color=Grouping)) + 
  geom_line() + geom_point()+ geom_errorbar(aes(ymin=NormWidth-Norm_SEM, ymax=NormWidth+Norm_SEM), width=.25,position=position_dodge(0)) +
  ylim(c(0,0.25))



# Set levels
D0_Distribution$Layer=as.character(D0_Distribution$Layer)
D0_Distribution$Layer=factor(D0_Distribution$Layer, levels = sort(unique(D0_Distribution$Layer)) )


# Set group
D0_Distribution$Grouping=NA
D0_Distribution$Grouping[startsWith(as.character(D0_Distribution$type),"Delta0A") | 
                         startsWith(as.character(D0_Distribution$type),"Delta0B") ]<-"A-B"
D0_Distribution$Grouping[startsWith(as.character(D0_Distribution$type),"Delta0C") ]<-"C"
D0_Distribution$Grouping[startsWith(as.character(D0_Distribution$type),"Delta0D") | 
                         startsWith(as.character(D0_Distribution$type),"Delta0E") | 
                         startsWith(as.character(D0_Distribution$type),"Delta0F") ]<-"D-F"
D0_Distribution$Grouping[   startsWith(as.character(D0_Distribution$type),"Delta0G") | 
                         startsWith(as.character(D0_Distribution$type),"Delta0H") | 
                         startsWith(as.character(D0_Distribution$type),"Delta0I") | 
                         startsWith(as.character(D0_Distribution$type),"Delta0J") ]<-"G-J"
D0_Distribution$Grouping[   startsWith(as.character(D0_Distribution$type),"Delta0K") | 
                         startsWith(as.character(D0_Distribution$type),"Delta0L") | 
                         startsWith(as.character(D0_Distribution$type),"Delta0M") | 
                         startsWith(as.character(D0_Distribution$type),"Delta0N") ]<-"K-N"
D0_Distribution$Grouping=factor(D0_Distribution$Grouping, levels=c("A-B","C","D-F","G-J", "K-N"))





```














