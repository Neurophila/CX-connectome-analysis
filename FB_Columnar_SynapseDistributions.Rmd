---
title: "Notebook plotting synapse distributions for columnar neurons of the FB"
output:
  html_document:
    df_print: paged
---

### Command to clear environment is: rm(list = ls(all.names = TRUE))
### Command to update is remotes::update_packages('neuprintr')
### Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(plotly)
library(dplyr)
library(matlib)
library(car)
library(imager)
library(reshape2)
library(zoo)
library(ggpubr)
library(ks)
library(RColorBrewer)
require(alphahull)
options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose ROI and save/plot directories
```{r}

# The region of interest.
ROI="FB"  

# Directory to save data to.
SaveDir="Z:/Cx_Connectome/BradData/FB_Analysis/"

# Directory to save plots to.
PlotDir="Z:/Cx_Connectome/BradData/FB_Analysis/ColumnarSynapseLocs/"


```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint server.
```{r}
neuprint_login()
```

### Get general functions
```{r}
source("inputOutputRegionsVis.r")
source("GetNeuronsInRoi.r")
source("SynapsePCAUtils.r")
source("GetRoiMeshOutline.r")
```


### Get neurons in the ROI and
### Exclude neurons not in known FB types
```{r}

# get all FB bodies
NamedBodies = Get_AllNeurons_InRoi(ROI, FALSE)
NamedBodies=ComputeRelativeSynapseCounts(NamedBodies)

# Load known FB types
load(paste(SaveDir,"FB_Types.RData",sep=""))

# Exclude bodies that are not columnar
FB_Columnar_Type=c("PF","Delta","FR","FS","FC")
ExcludedTypes=unique(NamedBodies$bodytype[!( startsWith(NamedBodies$bodytype, FB_Columnar_Type))])
IncludedTypes=unique(NamedBodies$bodytype[( startsWith(NamedBodies$bodytype, FB_Columnar_Type))])
ColumnarBodies=subset(NamedBodies, NamedBodies$bodytype %in% IncludedTypes)


```


### Get synapse distributions for all columnar neurons (or load previous data) and subset by layer
```{r}
# load(paste(SaveDir,"FBColumnarSynapses.RData",sep=""))


# Get all synapses for the ring neurons
SynLocs=GetSynapseLocs(ColumnarBodies$bodyid, "FB",TRUE)
FBC_SynsAll=SynLocs
remove(SynLocs)


# Get meshes
Mesh_FB= neuprint_ROI_mesh("FB")
Mesh_FB_L1= neuprint_ROI_mesh("FBl1")
Mesh_FB_L2= neuprint_ROI_mesh("FBl2")
Mesh_FB_L3= neuprint_ROI_mesh("FBl3")
Mesh_FB_L4= neuprint_ROI_mesh("FBl4")
Mesh_FB_L5= neuprint_ROI_mesh("FBl5")
Mesh_FB_L6= neuprint_ROI_mesh("FBl6")
Mesh_FB_L7= neuprint_ROI_mesh("FBl7")
Mesh_FB_L8= neuprint_ROI_mesh("FBl8")
Mesh_FB_L9= neuprint_ROI_mesh("FBl9")


# Assign synapses to layers (Note ~0.05% of synapses are not in a layer, where layer=NA )
FBC_SynsAll$Layer=NA
FBC_SynsAll$Layer[pointsinside(FBC_SynsAll, Mesh_FB_L1)] <- "L1"
FBC_SynsAll$Layer[pointsinside(FBC_SynsAll, Mesh_FB_L2)] <- "L2"
FBC_SynsAll$Layer[pointsinside(FBC_SynsAll, Mesh_FB_L3)] <- "L3"
FBC_SynsAll$Layer[pointsinside(FBC_SynsAll, Mesh_FB_L4)] <- "L4"
FBC_SynsAll$Layer[pointsinside(FBC_SynsAll, Mesh_FB_L5)] <- "L5"
FBC_SynsAll$Layer[pointsinside(FBC_SynsAll, Mesh_FB_L6)] <- "L6"
FBC_SynsAll$Layer[pointsinside(FBC_SynsAll, Mesh_FB_L7)] <- "L7"
FBC_SynsAll$Layer[pointsinside(FBC_SynsAll, Mesh_FB_L8)] <- "L8"
FBC_SynsAll$Layer[pointsinside(FBC_SynsAll, Mesh_FB_L9)] <- "L9"
FBC_SynsAll$Layer=as.factor(FBC_SynsAll$Layer)

# Save synapse locations for later loading
save(FBC_SynsAll, Mesh_FB, Mesh_FB_L1, Mesh_FB_L2, Mesh_FB_L3, Mesh_FB_L4, Mesh_FB_L5,
     Mesh_FB_L6, Mesh_FB_L7, Mesh_FB_L8, Mesh_FB_L9, file = paste(SaveDir,"FBColumnarSynapses.RData",sep=""))



```


# Get mesh points
```{r}

Mesh_FB_Points=MeshPoints(Mesh_FB)
Mesh_FB_L1_Points=MeshPoints(Mesh_FB_L1)
Mesh_FB_L2_Points=MeshPoints(Mesh_FB_L2)
Mesh_FB_L3_Points=MeshPoints(Mesh_FB_L3)
Mesh_FB_L4_Points=MeshPoints(Mesh_FB_L4)
Mesh_FB_L5_Points=MeshPoints(Mesh_FB_L5)
Mesh_FB_L6_Points=MeshPoints(Mesh_FB_L6)
Mesh_FB_L7_Points=MeshPoints(Mesh_FB_L7)
Mesh_FB_L8_Points=MeshPoints(Mesh_FB_L8)
Mesh_FB_L9_Points=MeshPoints(Mesh_FB_L9)

```


# Center synapses and mesh points at new origin
```{r}


# define new origin from roi center of mass
origin = getCOM(Mesh_FB_Points)


#reset orgin of all layers
Mesh_FB_Points = resetOrigin(Mesh_FB_Points, origin)
Mesh_FB_L1_Points = resetOrigin(Mesh_FB_L1_Points, origin)
Mesh_FB_L2_Points = resetOrigin(Mesh_FB_L2_Points, origin)
Mesh_FB_L3_Points = resetOrigin(Mesh_FB_L3_Points, origin)
Mesh_FB_L4_Points = resetOrigin(Mesh_FB_L4_Points, origin)
Mesh_FB_L5_Points = resetOrigin(Mesh_FB_L5_Points, origin)
Mesh_FB_L6_Points = resetOrigin(Mesh_FB_L6_Points, origin)
Mesh_FB_L7_Points = resetOrigin(Mesh_FB_L7_Points, origin)
Mesh_FB_L8_Points = resetOrigin(Mesh_FB_L8_Points, origin)
Mesh_FB_L9_Points = resetOrigin(Mesh_FB_L9_Points, origin)


# Reset origin of all synapses 
FBC_SynsAll = resetOrigin(FBC_SynsAll, origin)


```


# Perform PCA and rotation to get axes
```{r}

#get eigenvectors
roiEigen = covPCA(Mesh_FB_Points)

# Rotate PCs some
RotMat=makeRotMatYZ(-33) # 33
roiEigen$vectors= roiEigen$vectors %*% RotMat
RotMat=makeRotMatXY(-3) # -3
roiEigen$vectors= roiEigen$vectors %*% RotMat

# Project meshes into PCA space
Mesh_FB_Points = changeBasis(Mesh_FB_Points, roiEigen)
Mesh_FB_L1_Points = changeBasis(Mesh_FB_L1_Points, roiEigen)
Mesh_FB_L2_Points = changeBasis(Mesh_FB_L2_Points, roiEigen)
Mesh_FB_L3_Points = changeBasis(Mesh_FB_L3_Points, roiEigen)
Mesh_FB_L4_Points = changeBasis(Mesh_FB_L4_Points, roiEigen)
Mesh_FB_L5_Points = changeBasis(Mesh_FB_L5_Points, roiEigen)
Mesh_FB_L6_Points = changeBasis(Mesh_FB_L6_Points, roiEigen)
Mesh_FB_L7_Points = changeBasis(Mesh_FB_L7_Points, roiEigen)
Mesh_FB_L8_Points = changeBasis(Mesh_FB_L8_Points, roiEigen)
Mesh_FB_L9_Points = changeBasis(Mesh_FB_L9_Points, roiEigen)


# Project synapses into PCA space
FBC_SynsAll=changeBasis_df(FBC_SynsAll, roiEigen)



```


# Get pre and post type names based on bodyids, and subset based on known types
```{r}

# Get pre and post body names (to get pb columns later)
BodyId_And_Names=NamedBodies[c("bodyid","bodyname")]
BodyId_And_PartnerNames=NamedBodies[c("bodyid","bodyname")]
colnames(BodyId_And_PartnerNames)<-c("partner","partnername")
FBC_SynsAll=merge(FBC_SynsAll, BodyId_And_Names, by="bodyid")
FBC_SynsAll=merge(FBC_SynsAll, BodyId_And_PartnerNames, by="partner")

# subset based on known types
FBC_SynsAll=subset(FBC_SynsAll, (type %in% FB_Type) & (partner_type %in% FB_Type) )


```



# Plot data in new and old reference frame
```{r message=FALSE}


# Make scatter plot new projection
ggplot(Mesh_FB_Points, aes(x=X, y=-Y)) + geom_point(size=1, alpha = 0.05) +  xlab("x=PC1") + ylab("y=PC2") + coord_fixed(ratio = 1) 
ggplot() + geom_point(data=Mesh_FB_Points, aes(x=X, y=-Y), colour= "cadetblue3",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L1_Points, aes(x=X, y=-Y), colour= "blueviolet",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L2_Points, aes(x=X, y=-Y), colour= "cadetblue3",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L3_Points, aes(x=X, y=-Y), colour= "blueviolet",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L4_Points, aes(x=X, y=-Y), colour= "cadetblue3",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L5_Points, aes(x=X, y=-Y), colour= "blueviolet",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L6_Points, aes(x=X, y=-Y), colour= "cadetblue3",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L7_Points, aes(x=X, y=-Y), colour= "blueviolet",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L8_Points, aes(x=X, y=-Y), colour= "cadetblue3",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L9_Points, aes(x=X, y=-Y), colour= "blueviolet",  size=1, alpha = 0.01) + coord_fixed(ratio = 1) 



# Make scatter plot of original space
ggplot(Mesh_FB_Points, aes(x=x, y=-z)) + geom_point(size=1, alpha = 0.05) +  xlab("x=PC1") + ylab("y=PC2") + coord_fixed(ratio = 1) 
ggplot() + geom_point(data=Mesh_FB_Points, aes(x=x, y=-z), colour= "cadetblue3",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L1_Points, aes(x=x, y=-z), colour= "blueviolet",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L2_Points, aes(x=x, y=-z), colour= "cadetblue3",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L3_Points, aes(x=x, y=-z), colour= "blueviolet",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L4_Points, aes(x=x, y=-z), colour= "cadetblue3",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L5_Points, aes(x=x, y=-z), colour= "blueviolet",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L6_Points, aes(x=x, y=-z), colour= "cadetblue3",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L7_Points, aes(x=x, y=-z), colour= "blueviolet",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L8_Points, aes(x=x, y=-z), colour= "cadetblue3",  size=1, alpha = 0.01) + 
           geom_point(data=Mesh_FB_L9_Points, aes(x=x, y=-z), colour= "blueviolet",  size=1, alpha = 0.01) + coord_fixed(ratio = 1) 


# Scatter subset of synapses, colored by layer
data2=FBC_SynsAll[seq(from = 1, to = length(FBC_SynsAll$x), by = 500), ]
ggplot() + geom_point(data=Mesh_FB_Points, aes(x=X, y=-Y), colour= "darkgray",  size=1, alpha = 0.01) +
           geom_point(data=data2, aes(x=X, y=-Y, colour= Layer),  size=1, alpha = 0.7) + coord_fixed(ratio = 1) 
remove(data2)




```



# Save data for later loading
```{r}
# load(paste(SaveDir,"FBColumnarSynapses_PostPCA.RData",sep=""))
# Save synapse locations for later loading
save(FBC_SynsAll, Mesh_FB_Points, Mesh_FB_L1_Points, Mesh_FB_L2_Points, Mesh_FB_L3_Points, Mesh_FB_L4_Points,
     Mesh_FB_L5_Points, Mesh_FB_L6_Points, Mesh_FB_L7_Points, Mesh_FB_L8_Points, Mesh_FB_L9_Points,
     roiEigen, origin, file = paste(SaveDir,"FBColumnarSynapses_PostPCA.RData",sep=""))

```


# Get rid of original frame (the lowercase x,y,z data)
```{r}

# Meshes
Mesh_FB_Points=Mesh_FB_Points[ , !(names(Mesh_FB_Points) %in% c("x","y","z"))]
Mesh_FB_L1_Points=Mesh_FB_L1_Points[ , !(names(Mesh_FB_L1_Points) %in% c("x","y","z"))]
Mesh_FB_L2_Points=Mesh_FB_L2_Points[ , !(names(Mesh_FB_L2_Points) %in% c("x","y","z"))]
Mesh_FB_L3_Points=Mesh_FB_L3_Points[ , !(names(Mesh_FB_L3_Points) %in% c("x","y","z"))]
Mesh_FB_L4_Points=Mesh_FB_L4_Points[ , !(names(Mesh_FB_L4_Points) %in% c("x","y","z"))]
Mesh_FB_L5_Points=Mesh_FB_L5_Points[ , !(names(Mesh_FB_L5_Points) %in% c("x","y","z"))]
Mesh_FB_L6_Points=Mesh_FB_L6_Points[ , !(names(Mesh_FB_L6_Points) %in% c("x","y","z"))]
Mesh_FB_L7_Points=Mesh_FB_L7_Points[ , !(names(Mesh_FB_L7_Points) %in% c("x","y","z"))]
Mesh_FB_L8_Points=Mesh_FB_L8_Points[ , !(names(Mesh_FB_L8_Points) %in% c("x","y","z"))]
Mesh_FB_L9_Points=Mesh_FB_L9_Points[ , !(names(Mesh_FB_L9_Points) %in% c("x","y","z"))]


#Synapses
FBC_SynsAll=FBC_SynsAll[ , !(names(FBC_SynsAll) %in% c("x","y","z"))]


```



# Get outlines of each layer
```{r}

# Get XY outlines of each layer, with Y direction reverse so dorsal is up
Outline_FB_XY=MeshOutline(Mesh_FB_Points, "XY")
Outline_L1_XY=MeshOutline(Mesh_FB_L1_Points, "XY")
Outline_L2_XY=MeshOutline(Mesh_FB_L2_Points, "XY")
Outline_L3_XY=MeshOutline(Mesh_FB_L3_Points, "XY")
Outline_L4_XY=MeshOutline(Mesh_FB_L4_Points, "XY")
Outline_L5_XY=MeshOutline(Mesh_FB_L5_Points, "XY")
Outline_L6_XY=MeshOutline(Mesh_FB_L6_Points, "XY")
Outline_L7_XY=MeshOutline(Mesh_FB_L7_Points, "XY")
Outline_L8_XY=MeshOutline(Mesh_FB_L8_Points, "XY")
Outline_L9_XY=MeshOutline(Mesh_FB_L9_Points, "XY")


# Get XZ outlines of each layer, with Y direction reverse so dorsal is up
Outline_FB_XZ=MeshOutline(Mesh_FB_Points, "XZ")
Outline_L1_XZ=MeshOutline(Mesh_FB_L1_Points, "XZ")
Outline_L2_XZ=MeshOutline(Mesh_FB_L2_Points, "XZ")
Outline_L3_XZ=MeshOutline(Mesh_FB_L3_Points, "XZ")
Outline_L4_XZ=MeshOutline(Mesh_FB_L4_Points, "XZ")
Outline_L5_XZ=MeshOutline(Mesh_FB_L5_Points, "XZ")
Outline_L6_XZ=MeshOutline(Mesh_FB_L6_Points, "XZ")
Outline_L7_XZ=MeshOutline(Mesh_FB_L7_Points, "XZ")
Outline_L8_XZ=MeshOutline(Mesh_FB_L8_Points, "XZ")
Outline_L9_XZ=MeshOutline(Mesh_FB_L9_Points, "XZ")


# Check layer 4/7, which have holes
ggplot() + geom_point(data=Mesh_FB_L4_Points, aes(x=X, y=Z), colour= 'blueviolet',  size=1, alpha = 0.05) + 
  coord_fixed(ratio = 1) +  theme_void() + guides(color=FALSE) +
  geom_path(data=Outline_L4_XZ, aes(x=c1, y=c2), size = 1) 

ggplot() + geom_point(data=Mesh_FB_L7_Points, aes(x=X, y=Z), colour= 'blueviolet',  size=1, alpha = 0.05) + 
  coord_fixed(ratio = 1) +  theme_void() + guides(color=FALSE) +
  geom_path(data=Outline_L7_XZ, aes(x=c1, y=c2), size = 1) 


```

# Post-process layers 4,6 to make smooth
```{r}

# Layer 4
Bad_L4_Inds=which( abs(diff(Outline_L4_XZ$c2))>1000)
Outline_L4_XZ = Outline_L4_XZ[ - seq((Bad_L7_Inds[1]+1),Bad_L4_Inds[length(Bad_L7_Inds)]), ]

# Layer 7 XZ
Bad_L7_Inds=which( abs(diff(Outline_L7_XZ$c2))>1000)
Outline_L7_XZ = Outline_L7_XZ[ - seq((Bad_L7_Inds[1]+1),Bad_L7_Inds[length(Bad_L7_Inds)]), ] 

# Check that holes have been removed
ggplot() + geom_point(data=Mesh_FB_L4_Points, aes(x=X, y=Z), colour= 'blueviolet',  size=1, alpha = 0.05) + 
  coord_fixed(ratio = 1) +  theme_void() + guides(color=FALSE) +
  geom_path(data=Outline_L4_XZ, aes(x=c1, y=c2), size = 1) 

ggplot() + geom_point(data=Mesh_FB_L7_Points, aes(x=X, y=Z), colour= 'blueviolet',  size=1, alpha = 0.05) + 
  coord_fixed(ratio = 1) +  theme_void() + guides(color=FALSE) +
  geom_path(data=Outline_L7_XZ, aes(x=c1, y=c2), size = 1) 

```



# Make plots of FB layers as a schematic
```{r}


# Make scatter plot new projection
CCC=rainbow(9)
AAA=0.02
SSS=2
P1<-ggplot() + geom_point(data=Mesh_FB_Points, aes(x=X, y=-Y), colour= "cadetblue3",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L1_Points, aes(x=X, y=-Y), colour= "blueviolet",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L2_Points, aes(x=X, y=-Y), colour= "cadetblue3",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L3_Points, aes(x=X, y=-Y), colour= "blueviolet",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L4_Points, aes(x=X, y=-Y), colour= "cadetblue3",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L5_Points, aes(x=X, y=-Y), colour= "blueviolet",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L6_Points, aes(x=X, y=-Y), colour= "cadetblue3",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L7_Points, aes(x=X, y=-Y), colour= "blueviolet",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L8_Points, aes(x=X, y=-Y), colour= "cadetblue3",  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L9_Points, aes(x=X, y=-Y), colour= "blueviolet",  size=SSS, alpha = AAA) + 
          coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position="none")
ggsave(paste(PlotDir, "FB_1.png",sep=""),
       plot = P1, device='png', scale = 1, width = 6, height = 6, units ="in", dpi = 300, limitsize = TRUE)


P1<-ggplot() + geom_point(data=Mesh_FB_L1_Points, aes(x=X, y=-Y), colour= CCC[1],  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L2_Points, aes(x=X, y=-Y), colour= CCC[2],  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L3_Points, aes(x=X, y=-Y), colour= CCC[3],  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L4_Points, aes(x=X, y=-Y), colour= CCC[4],  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L5_Points, aes(x=X, y=-Y), colour= CCC[5],  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L6_Points, aes(x=X, y=-Y), colour= CCC[6],  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L7_Points, aes(x=X, y=-Y), colour= CCC[7],  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L8_Points, aes(x=X, y=-Y), colour= CCC[8],  size=SSS, alpha = AAA) + 
           geom_point(data=Mesh_FB_L9_Points, aes(x=X, y=-Y), colour= CCC[9],  size=SSS, alpha = AAA) + 
           coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position="none")
ggsave(paste(PlotDir, "FB_2.png",sep=""),
       plot = P1, device='png', scale = 1, width = 6, height = 6, units ="in", dpi = 300, limitsize = TRUE)


```



# Get PB glomeruli or columns (Some columns are mixed and are named _L1/2 for example)
```{r}


# Assign side (pb or fb column half)
FBC_SynsAll$Side=NA
FBC_SynsAll$Side[grepl("_R",FBC_SynsAll$bodyname)]<-"R"
FBC_SynsAll$Side[grepl("_L",FBC_SynsAll$bodyname)]<-"L"

# Assign PB glom
FBC_SynsAll$PBglom=NA
RightColumns=str_extract(FBC_SynsAll$bodyname, "_R(\\d+)")
LeftColumns=str_extract(FBC_SynsAll$bodyname, "_L(\\d+)")
FBC_SynsAll$PBglom[which(!is.na(RightColumns))]=RightColumns[which(!is.na(RightColumns))]
FBC_SynsAll$PBglom[which(!is.na(LeftColumns))]=LeftColumns[which(!is.na(LeftColumns))]
FBC_SynsAll$PBglom=sapply(FBC_SynsAll$PBglom, substring, 2, 3)

# Assign FB glom
FBC_SynsAll$FBcol=NA
FBC_SynsAll$FBcol=str_extract(FBC_SynsAll$bodyname, "_C(\\d+)")
FBC_SynsAll$FBcol=sapply(FBC_SynsAll$FBcol, substring, 2, 3)

# print list of PF body names to make sure parsing worked. 
A=subset(FBC_SynsAll, startsWith(type, "PF"))
unique(A$bodyname)

```



# Various functions plotting synapse distributions across antire FB ROI
```{r}


SetColumnOrder <- function(TypeX_Syns){
  TypeX_MeanPos= aggregate(TypeX_Syns[c("X","Y","Z")], by = list(bodyid=TypeX_Syns$bodyid), FUN=mean)
  colnames(TypeX_MeanPos)[c(2,3,4)]<-c("mean_X","mean_Y","mean_Z")
  TypeX_MeanPos$Order_X=order(TypeX_MeanPos$mean_X)
  TypeX_Syns = merge(TypeX_Syns, TypeX_MeanPos)
  return(TypeX_Syns)
}



PlotSyns_byColumn <- function(Plot_Syns, Title, PlotName){
  
  
  col_vector=brewer.pal(8, "Paired")
  col_vector[9]=col_vector[1]
  col_vector=col_vector[c(1,4,7,2,5,8,3,6,9)]
  
  P1<-ggplot() + geom_point(data=Plot_Syns, aes(x=X, y=-Y, color=FBcol) ,  size=2, alpha = 0.05, stroke = 0, shape=16) + 
    coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position = "top") +
    geom_path(data=Outline_FB_XY, aes(x=c1, y=c2), size = 1) +  scale_color_manual(values=col_vector) + guides(colour = guide_legend(override.aes = list(alpha = 1))) + 
    ggtitle(Title)
  
  
  P2<-ggplot() + geom_point(data=Plot_Syns, aes(x=X, y=Z, color=FBcol) ,  size=2, alpha = 0.05, stroke = 0, shape=16) + 
    coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position = "top") +
    geom_path(data=Outline_FB_XZ, aes(x=c1, y=c2), size = 1) +  scale_color_manual(values=col_vector) + guides(colour = guide_legend(override.aes = list(alpha = 1))) + 
    ggtitle(Title)
  
  
  P12<-ggarrange(plotlist=list(P1,P2), ncol =2, nrow = 1)
  ggsave(paste(PlotDir, PlotName,".png",sep=""),
         plot = P12, device='png', scale = 1, width = 8, height = 5, units ="in", dpi = 300, limitsize = TRUE)
  
}


PlotSyns_byGlom <- function(Plot_Syns, Title, PlotName){
  
  # Get neurons that innervate the left or right pb
  Plot_Syns_Lpb=subset(Plot_Syns, startsWith(PBglom,"L") )
  Plot_Syns_Lpb$PBglom=factor( Plot_Syns_Lpb$PBglom, levels= sort(unique(Plot_Syns_Lpb$PBglom)) )
  
  Plot_Syns_Rpb=subset(Plot_Syns, startsWith(PBglom,"R") )
  Plot_Syns_Rpb$PBglom=factor( Plot_Syns_Rpb$PBglom, levels= sort(unique(Plot_Syns_Rpb$PBglom)) )
  
  
  L_col_vector=brewer.pal(8, "Paired")
  L_col_vector[9]=L_col_vector[1]
  L_col_vector=L_col_vector[c(1,4,7,2,5,8,3,6,9)]
  R_col_vector=rev(L_col_vector)
  RL_col_Vector=c(L_col_vector, R_col_vector)
  
  
  # Make color map for each that maps PB glomeruli to their appropriate columns
  P1<-ggplot() + geom_point(data=Plot_Syns_Lpb, aes(x=X, y=-Y, color=PBglom) ,  size=2, alpha = 0.05, stroke = 0, shape=16) + 
    coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position = "top") +
    geom_path(data=Outline_FB_XY, aes(x=c1, y=c2), size = 1) +  scale_color_manual(values=L_col_vector) + guides(colour = guide_legend(override.aes = list(alpha = 1))) + 
    ggtitle(paste("LEFT ", Title)) + xlim(c( min(Outline_FB_XZ$c1)-200 , max(Outline_FB_XZ$c1)+200)) 
  
  
  P2<-ggplot() + geom_point(data=Plot_Syns_Lpb, aes(x=X, y=Z, color=PBglom) ,  size=2, alpha = 0.05, stroke = 0, shape=16) + 
    coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position = "top") +
    geom_path(data=Outline_FB_XZ, aes(x=c1, y=c2), size = 1) +  scale_color_manual(values=L_col_vector) + guides(colour = guide_legend(override.aes = list(alpha = 1))) + 
    ggtitle(paste("LEFT ", Title)) + xlim(c( min(Outline_FB_XZ$c1)-200 , max(Outline_FB_XZ$c1)+200))
  
  
  
  P3<-ggplot() + geom_point(data=Plot_Syns_Rpb, aes(x=X, y=-Y, color=PBglom) ,  size=2, alpha = 0.05, stroke = 0, shape=16) + 
    coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position = "top") +
    geom_path(data=Outline_FB_XY, aes(x=c1, y=c2), size = 1) +  scale_color_manual(values=R_col_vector) + guides(colour = guide_legend(override.aes = list(alpha = 1))) + 
    ggtitle(paste("RIGHT ", Title)) + xlim(c( min(Outline_FB_XZ$c1)-200 , max(Outline_FB_XZ$c1)+200))
  
  
  P4<-ggplot() + geom_point(data=Plot_Syns_Rpb, aes(x=X, y=Z, color=PBglom) ,  size=2, alpha = 0.05, stroke = 0, shape=16) + 
    coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position = "top") +
    geom_path(data=Outline_FB_XZ, aes(x=c1, y=c2), size = 1) +  scale_color_manual(values=R_col_vector) + guides(colour = guide_legend(override.aes = list(alpha = 1))) + 
    ggtitle(paste("RIGHT ", Title)) + xlim(c( min(Outline_FB_XZ$c1)-200 , max(Outline_FB_XZ$c1)+200))
  
  
  
  P5<-ggplot() + geom_point(data=Plot_Syns, aes(x=X, y=-Y, color=PBglom) ,  size=2, alpha = 0.05, stroke = 0, shape=16) + 
    coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position = "top") +
    geom_path(data=Outline_FB_XY, aes(x=c1, y=c2), size = 1) +  scale_color_manual(values=RL_col_Vector) + guides(colour = guide_legend(override.aes = list(alpha = 1))) + 
    ggtitle(paste("RIGHT ", Title)) + xlim(c( min(Outline_FB_XZ$c1)-200 , max(Outline_FB_XZ$c1)+200))
  
  
  P6<-ggplot() + geom_point(data=Plot_Syns, aes(x=X, y=Z, color=PBglom) ,  size=2, alpha = 0.05, stroke = 0, shape=16) + 
    coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position = "top") +
    geom_path(data=Outline_FB_XZ, aes(x=c1, y=c2), size = 1) +  scale_color_manual(values=RL_col_Vector) + guides(colour = guide_legend(override.aes = list(alpha = 1))) + 
    ggtitle(paste("RIGHT ", Title)) + xlim(c( min(Outline_FB_XZ$c1)-200 , max(Outline_FB_XZ$c1)+200))
  
  
  
  P12<-ggarrange(plotlist=list(P1,P2,P3,P4,P5,P6), ncol =2, nrow = 3)
  ggsave(paste(PlotDir, PlotName,".png",sep=""),
         plot = P12, device='png', scale = 1, width = 8, height = 12, units ="in", dpi = 300, limitsize = TRUE)
  
}





```




# Functions for plotting layer by layer
```{r}



Plot_Layer <- function(Plot_Syns, Layer_To_Plot, Outline, Title, Grouping){
  
  # Get data
  PlotData=subset(Plot_Syns, Layer==Layer_To_Plot)
  
  # Get color map
  if (Grouping == "FBcol"){
    
    col_vector=brewer.pal(8, "Paired")
    col_vector[9]=col_vector[1]
    col_vector=col_vector[c(1,4,7,2,5,8,3,6,9)]
    
    ColorVar=PlotData$FBcol
    
  } else if (Grouping == "PBglom") {
    
    L_col_vector=brewer.pal(8, "Paired")
    L_col_vector[9]=L_col_vector[1]
    L_col_vector=L_col_vector[c(1,4,7,2,5,8,3,6,9)]
    R_col_vector=rev(L_col_vector)
    col_vector=c(L_col_vector, R_col_vector)
    
    ColorVar=PlotData$PBglom
  }
  
  # Make plot
  P1<-ggplot() + geom_point(data=PlotData, aes(x=X, y=Z, color=ColorVar) ,  size=2, alpha = 0.05, stroke = 0, shape=16) + 
    coord_fixed(ratio = 1) +  theme_void() + guides(fill=FALSE) + theme(legend.position = "none") +
    geom_path(data=Outline, aes(x=c1, y=c2), size = 1) +  scale_color_manual(values=col_vector) + xlim(c( min(Outline_FB_XZ$c1)-200 , max(Outline_FB_XZ$c1)+200)) +
    ggtitle(Title)
  
  return(P1)
}


PlotSyns_byLayer <- function(Plot_Syns, Type, PlotName, Grouping){
  
  
  P1 = Plot_Layer(Plot_Syns, "L1", Outline_L1_XZ, paste("L1 ", Type,sep=""), Grouping )
  P2 = Plot_Layer(Plot_Syns, "L2", Outline_L2_XZ, paste("L2 ", Type,sep=""), Grouping )
  P3 = Plot_Layer(Plot_Syns, "L3", Outline_L3_XZ, paste("L3 ", Type,sep=""), Grouping )
  P4 = Plot_Layer(Plot_Syns, "L4", Outline_L4_XZ, paste("L4 ", Type,sep=""), Grouping )
  P5 = Plot_Layer(Plot_Syns, "L5", Outline_L5_XZ, paste("L5 ", Type,sep=""), Grouping )
  P6 = Plot_Layer(Plot_Syns, "L6", Outline_L6_XZ, paste("L6 ", Type,sep=""), Grouping )
  P7 = Plot_Layer(Plot_Syns, "L7", Outline_L7_XZ, paste("L7 ", Type,sep=""), Grouping )
  P8 = Plot_Layer(Plot_Syns, "L8", Outline_L8_XZ, paste("L8 ", Type,sep=""), Grouping )
  P9 = Plot_Layer(Plot_Syns, "L9", Outline_L9_XZ, paste("L9 ", Type,sep=""), Grouping )

  P12<-ggarrange(plotlist=list(P1,P2,P3,P4,P5,P6,P7,P8,P9), ncol =3, nrow = 3)
  ggsave(paste(PlotDir, PlotName,".png",sep=""),
         plot = P12, device='png', scale = 1, width = 8, height = 5, units ="in", dpi = 300, limitsize = TRUE)
  
}


```



#Fx neuron plots/analysis
```{r}

# Get all FX neurons (FC, FS, FR)
All_Fx=subset(FBC_SynsAll, !(is.na(FBcol)) & startsWith(type,"F"))
All_Fx$FBcol=factor(All_Fx$FBcol, levels=sort(unique(All_Fx$FBcol)) )

# Plot synapses distributions in entire FB and my layer for all neurons
PlotSyns_byColumn(All_Fx, "FX All", "FX_All")
PlotSyns_byLayer(All_Fx, "FX All", "FX_All_Layers", "FBcol")

# Make the same plots but per type 
FX_Types=unique(All_Fx$type)
for (ttt in 1:length(FX_Types)){
  SubData=subset(All_Fx, type == FX_Types[ttt])
  PlotSyns_byColumn(SubData, FX_Types[ttt], paste("FX_",FX_Types[ttt],sep=""))
}
for (ttt in 1:length(FX_Types)){
  SubData=subset(All_Fx, type == FX_Types[ttt])
  PlotSyns_byLayer(SubData, FX_Types[ttt], paste("FX_",FX_Types[ttt],"_Layers",sep=""), "FBcol")
}


```


# PB-FB-X neuron plots/analys
```{r}

# Get PF neuron data
All_PFX=subset(FBC_SynsAll, !(is.na(PBglom)) & startsWith(type,"PF"))

# Plot synapses distributions in entire FB and my layer for all neurons
PlotSyns_byGlom(All_PFX, "PB-FB-XX ALL", "PB_FB_XX_ALL")
PlotSyns_byLayer(All_PFX, "PB-FB-XX All", "PB_FB_XX_All_Layers", "PBglom")


# Make the same plots but per type 
PFX_Types=unique(All_PFX$type)
for (ttt in 1:length(PFX_Types)){
  SubData=subset(All_PFX, type == PFX_Types[ttt])
  PlotSyns_byGlom(SubData, PFX_Types[ttt], paste("PB_FB_XX_",PFX_Types[ttt],sep=""))
}
for (ttt in 1:length(PFX_Types)){
  SubData=subset(All_PFX, type == PFX_Types[ttt])
  PlotSyns_byLayer(SubData, PFX_Types[ttt], paste("PB_FB_XX_",PFX_Types[ttt],"_Layers",sep=""), "PBglom")
}


```



# For each layer and neuron type, compute width of column
```{r}

Thresh=100
Layers_All=sort(unique(All_Fx$Layer))

FX_Distribution <- data.frame(bodyid=as.numeric(), type=as.character(), Layer=as.character(), 
                            Side=as.character(), PBglom=as.character(), FBcol=as.character(),
                            X_Mean=as.numeric(), X_STD=as.numeric(), 
                            Y_Mean=as.numeric(), Y_STD=as.numeric(), 
                            Z_Mean=as.numeric(), Z_STD=as.numeric(),
                            X_Layer_Range=as.numeric(),Y_Layer_Range=as.numeric(),Z_Layer_Range=as.numeric(),
                            X_Range=as.numeric(),Y_Range=as.numeric(),Z_Range=as.numeric()) 


# Loop over neuron types
for (ttt in 1:length(FX_Types)){
  SubData=subset(All_Fx, type == FX_Types[ttt])
  NeuronIDs=unique(SubData$bodyid)

  # Loop of layers
  for (lll in 1:9){
    LayerData=subset(SubData, Layer==Layers_All[lll])
  
    X_Layer_Range = abs(quantile(LayerData$X, probs = 0.01) - quantile(LayerData$X, probs = 0.99) )
    Y_Layer_Range = abs(quantile(LayerData$Y, probs = 0.01) - quantile(LayerData$Y, probs = 0.99) )
    Z_Layer_Range = abs(quantile(LayerData$Z, probs = 0.01) - quantile(LayerData$Z, probs = 0.99) )
    
    
    # Loop over individual neurons
    for (nnn in 1:length(NeuronIDs)){
      NeuronData=subset(LayerData, bodyid==NeuronIDs[nnn])
      

      if (length(NeuronData$X)>Thresh){
        
        # Mean and std
        TempMean=colMeans(NeuronData[c("X","Y","Z")])
        TempSTD=sapply(NeuronData[c("X","Y","Z")], sd)
        
        X_Range = abs(quantile(NeuronData$X, probs = 0.01) - quantile(NeuronData$X, probs = 0.99) )
        Y_Range = abs(quantile(NeuronData$Y, probs = 0.01) - quantile(NeuronData$Y, probs = 0.99) )
        Z_Range = abs(quantile(NeuronData$Z, probs = 0.01) - quantile(NeuronData$Z, probs = 0.99) )
        
        
        TempDF=data.frame(bodyid=NeuronData$bodyid[1], type=NeuronData$type[1], Layer=NeuronData$Layer[1], 
                          Side=NeuronData$Side[1], PBglom=NeuronData$PBglom[1], FBcol=NeuronData$FBcol[1],
                          X_Mean=TempMean["X"], X_STD=TempSTD["X"], 
                          Y_Mean=TempMean["Y"], Y_STD=TempSTD["Y"], 
                          Z_Mean=TempMean["Z"], Z_STD=TempSTD["Z"],
                          X_Layer_Range=X_Layer_Range,Y_Layer_Range=Y_Layer_Range,Z_Layer_Range=Z_Layer_Range,
                          X_Range=X_Range,Y_Range=Y_Range,Z_Range=Z_Range) 
        
        FX_Distribution=rbind(FX_Distribution,TempDF)
        
      }
    }
  }
}


# Set levels
FX_Distribution$Layer=as.character(FX_Distribution$Layer)
FX_Distribution$Layer=factor(FX_Distribution$Layer, levels = sort(unique(FX_Distribution$Layer)) )


# look at just column 5
FX_Distribution_C5=subset(FX_Distribution, FBcol=="C5")




ggplot() + geom_point(data=FX_Distribution_C5, aes(x=Layer, y=X_Range/X_Layer_Range, color=type))



ggplot() + geom_point(data=FX_Distribution, aes(x=Layer, y=X_Range/X_Layer_Range, color=type))



```












































