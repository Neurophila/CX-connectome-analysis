---
title: "Notebook illustrating how to use functions in inputOutputRegionVis"
output:
  html_document:
    df_print: paged
---

```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
options(nat.plotengine = 'rgl')
```

```{r}
neuprint_login()
```

### Import some custom functions into workspace
```{r}
source("inputOutputRegionsVis.R")

# Collections of functions for visualization of input/output regions per neuron type


get_rois_df <- function (){
  rois = neuprint_ROIs()
  return (data.frame(keyName=names(rois), value=rois, row.names=NULL))
}

renameRoiColumn <- function(df, slctROI) {
  df = df %>% rename_at(vars(starts_with(slctROI)), funs(str_replace(., slctROI, "ROI")))
  df = df %>%rename_at(vars(ends_with(".pre")), funs(str_replace(., ".pre", "_pre")))
  df = df %>%rename_at(vars(ends_with(".post")), funs(str_replace(., ".post", "_post")))
  df = df %>%rename_all(funs(str_replace(., "\\(", "")))
  df = df %>%rename_all(funs(str_replace(., "\\)", "")))
  
  return (df)
}

#remove missing values
cleanup <- function(df) {
  df <- unnest(df, colnames(df))
  df <- na.omit(df)
  df$bodyname <- as.factor(df$bodyname)
  df$bodytype <- as.factor(df$bodytype)
  
  return (df)
}

# Select neurons that are "significant" based on synapse statistics. This function should be adapted to common criterial we agreed on.
filterNeuronTypes = function(df,minSynapses,minSumSynapses){
  
  # -> Compute statistics across neurons of the same bodytype
  roi_synStats = df %>% group_by(bodytype) %>% summarise(mean_pre = mean(ROI_pre),
                                                         mean_post = mean(ROI_post),
                                                         sum_pre = sum(ROI_pre),
                                                         sum_post = sum(ROI_post),
                                                         fract_pre = mean(ROI_pre/npre),
                                                         fract_post = mean(ROI_post/npost),
                                                         fract_all = mean((ROI_pre+ROI_post)/(npost + npre)))
  
  df = full_join(full_join(filter(df, bodytype %in% filter(roi_synStats, mean_pre >= minSynapses)$bodytype),
                           filter(df, bodytype %in% filter(roi_synStats, mean_post >= minSynapses)$bodytype)),
                 full_join(filter(df, bodytype %in% filter(roi_synStats, sum_pre >= minSumSynapses)$bodytype),
                           filter(df, bodytype %in% filter(roi_synStats, sum_post >= minSumSynapses)$bodytype)))
  
  return(df)
}
```

### Get neuprint ROIs and reformat to data frame
```{r}
roisDf = get_rois_df()
```


### Get neurons in ROI
```{r}
slctROI = "GA"
pairedRegion = TRUE# FALSE

if (pairedRegion) {
  roiR_Connect = neuprint_find_neurons( paste(slctROI, "(R)", sep="") )
  roiL_Connect = neuprint_find_neurons( paste(slctROI, "(L)", sep="") )
} else {
  roi_Connect = neuprint_find_neurons(slctROI)
}
```

Remove rows where bodytype is "NA", converte name and type to factors, join data from left and right side
```{r message=FALSE, warning=FALSE}
if (pairedRegion) {
  
  roiR_Connect <- cleanup(roiR_Connect)
  roiL_Connect <- cleanup(roiL_Connect)
  
  #rename ROI columns 
  roiR_Connect = renameRoiColumn(roiR_Connect, slctROI)
  roiL_Connect = renameRoiColumn(roiL_Connect, slctROI)
  
  # join data from paired ROI
  roi_Connect = full_join(roiR_Connect,roiL_Connect)
  
  # get full synaptic count
  roi_Connect = roi_Connect %>% rowwise() %>%  mutate(ROI_pre = sum(ROIR_pre, ROIL_pre, na.rm = TRUE),  
                                                     ROI_post = sum(ROIR_post, ROIL_post, na.rm = TRUE)) %>% ungroup()
} else {
  roi_Connect <- cleanup(roi_Connect)
  roi_Connect = renameRoiColumn(roi_Connect, slctROI)
}
```


### Filter
Select "significant" neurons, i.e. neurons that make a significant number of connections in the respective ROI, based on 
  (a) consistently high pre- and postsynaptic connections across neurons of the same type (mean > minSynapses = 10)
  (b) large total number of pre- and postsynaptic connections across neurons of the same type (sum > minSumSynapses = 30)

```{r}
minSynapses = 10
minSumSynapses = 30

roi_Connect_filt = filterNeuronTypes(roi_Connect, minSynapses, minSumSynapses)
```



### Characterize input and output regions of NO neurons

```{r}
roi_Connect_rois = neuprint_get_roiInfo(roi_Connect_filt$bodyid)

roi_Connect_rois =  mutate(roi_Connect_rois,
                        name = neuprint_get_meta(bodyid)$name,
                        type = neuprint_get_meta(bodyid)$type,
                        pre = neuprint_get_meta(bodyid)$pre,
                        post = neuprint_get_meta(bodyid)$post) 
```

```{r message=FALSE, warning=FALSE}
# reorganize such that ROI, #pre and #post become variables
roi_Connect_rois_df = data.frame(bodyid = numeric(),
                              name = character(),
                              type = character(),
                              roi = character(),
                              prepost = character(),
                              count = numeric())

for (roi in as.character(colnames(roi_Connect_rois))[2:(length(colnames(roi_Connect_rois))-4)]) {

  if (length(as.character(filter(roisDf,value == unlist(strsplit(roi, "[.]"))[1])$keyName)) == 1) next
  
  roiname = as.character(unlist(strsplit(roi, "[.]"))[1])
  side = as.character(unlist(strsplit(roiname, "[(]"))[2])
  roi_Connect_roi = data.frame(bodyid = roi_Connect_rois$bodyid,
                            name = roi_Connect_rois$name, 
                            type = roi_Connect_rois$type,
                            roi = as.character(unlist(strsplit(roiname, "[(]"))[1]),
                            hemisphere = as.character(unlist(strsplit(side, "[)]"))[1]),
                            prepost = unlist(strsplit(roi, "[.]"))[2],
                            count = ( as.numeric(roi_Connect_rois[[roi]]) ), 
                            normcount = ( as.numeric(roi_Connect_rois[[roi]]) / (roi_Connect_rois$pre + roi_Connect_rois$post) ) )
  roi_Connect_rois_df = bind_rows(roi_Connect_rois_df, roi_Connect_roi)
}

```

```{r message=FALSE, warning=FALSE}
roi_Connect_rois_df = filter(roi_Connect_rois_df, count > minSynapses)
roi_Connect_rois_df = filter(roi_Connect_rois_df, type %in% unique(roi_Connect_filt$bodytype))
```

```{r}
ggplot(roi_Connect_rois_df, aes(x=roi, y=type, size=count)) + 
  geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) + #, rows = vars(hemisphere)
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE)

ggsave(paste(slctROI,"inputOutputRegions_perType.pdf",sep="_"), plot = last_plot(), device='pdf', path = "../neuprintR_analysis_plots/",
  scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```


```{r}
ggplot(roi_Connect_rois_df, aes(x=roi, y=type, size=count)) + 
  geom_point(aes(color=roi)) +
  facet_grid(. ~ hemisphere + prepost) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE)

#ggsave(paste(slctROI,"inputOutputRegions_perType_perROIside.pdf",sep="_"), plot = last_plot(), device='pdf', path = "../neuprintR_analysis_plots/",
#  scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```


### Characterize input and output regions of neurons for only a small selection of ROIs
Regions to look at
```{r}
regs = c('EBr1','EBr2r4','EBr3am','EBr3d','EBr3pw','EBr5','EBr6')#c("NO1(L)","NO1(R)","NO2(L)","NO2(R)","NO3(L)","NO3(R)")
```


```{r message=FALSE, warning=FALSE}
# reorganize such that ROI, #pre and #post become variables
roi_Connect_intraRegs_df = data.frame(bodyid = numeric(),
                              name = character(),
                              type = character(),
                              roi = character(),
                              prepost = character(),
                              count = numeric())

for (roi in as.character(colnames(roi_Connect_rois))[2:(length(colnames(roi_Connect_rois))-4)]) {
  roiname = as.character(unlist(strsplit(roi, "[.]"))[1])
  if (roiname %in% regs) {
      side = as.character(unlist(strsplit(roiname, "[(]"))[2])

      roi_Connect_reg = data.frame(bodyid = roi_Connect_rois$bodyid,
                                  name = roi_Connect_rois$name, 
                                  type = roi_Connect_rois$type,
                                  roi = as.character(unlist(strsplit(roiname, "[(]"))[1]),
                                  hemisphere = as.character(unlist(strsplit(side, "[)]"))[1]),
                                  prepost = unlist(strsplit(roi, "[.]"))[2],
                                  count = ( as.numeric(roi_Connect_rois[[roi]]) ),
                                  normcount = ( as.numeric(roi_Connect_rois[[roi]]) / (roi_Connect_rois$pre + roi_Connect_rois$post) ) )
      roi_Connect_intraRegs_df = bind_rows(roi_Connect_intraRegs_df, roi_Connect_reg)
  }
}
```

```{r message=FALSE, warning=FALSE}
roi_Connect_intraRegs_df = filter(roi_Connect_intraRegs_df, count > minSynapses)
roi_Connect_intraRegs_df = filter(roi_Connect_intraRegs_df, type %in% unique(roi_Connect_filt$bodytype))
```

```{r}
ggplot(roi_Connect_intraRegs_df, aes(x=roi, y=type, size=count)) + 
  geom_point(aes(color=roi)) +
  facet_grid(.~ prepost) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE)

#ggplot(roi_Connect_intraRegs_df, aes(x=roi, y=type, size=count)) + 
#  geom_point(aes(color=roi)) +
#  facet_grid(.~ hemisphere + prepost) +
#  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE)
```



