---
title: "Brad's EB analysis"
output: html_notebook
---


# Command to clear environment is: rm(list = ls(all.names = TRUE))
# Load libraries
```{r message=FALSE, warning=FALSE}

library(nat)
library(neuprintr)
library(tidyverse)
library(reshape2)
library(plotly)
options(nat.plotengine = 'rgl')

```


# Configurable inputs: choose ROI and Save directory
```{r}

# The region of interest.
ROI="EB"  

# Directory to save data to.
SaveDir="Z:/Cx_Connectome/BradData/EB_Analysis/"


```


# Create save directory if it doesnt exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
```


# Connect to neuprint server.
```{r}
neuprint_login()
```


# Get general functions
```{r}
source("inputOutputRegionsVis.r")
source("GetNeuronsInRoi.R")
```

### Get neuprint ROIs and reformat to data frame
```{r}
roisDf = get_rois_df()
```


### Get neurons in the ROI
```{r}
NamedBodies=Get_AllNeurons_InRoi(ROI, FALSE)
```


### Threshold neurons in NamedBodies
```{r}
PreMaxThresh=10
PostMaxThresh=10
Output <-  SynapseStats_And_Threshold(NamedBodies, SaveDir, PreMaxThresh, PostMaxThresh)
list2env(Output ,.GlobalEnv)
remove(Output)
```


# Compute the Pre-to-Post connection table.
```{r}

# Pre-to-Post connections for named bodies (return all segements and filter) --> subet at end is important or it returns bodyids not contained in NamedBodies
NamedConnectTable = neuprint_connection_table(NamedBodies$bodyid,"PRE",ROI, all_segments=FALSE)   %>%
                         mutate( PreName =neuprint_get_meta(bodyid)[["name"]], PostName = neuprint_get_meta(partner)[["name"]] )   %>% 
                         mutate( PreType =neuprint_get_meta(bodyid)[["type"]], PostType = neuprint_get_meta(partner)[["type"]])   %>%  
                         group_by(PreName) %>% 
                         ungroup() %>%
                         rename(Pre_bodyid = bodyid, Post_bodyid = partner)
NamedConnectTable = subset(NamedConnectTable, Pre_bodyid %in% as.numeric(NamedBodies$bodyid) & Post_bodyid %in% as.numeric(NamedBodies$bodyid) ) 

```


# Get average connection table, grouped by neuron type
```{r}

# Average weights by neuron type
NamedConnectTable_byType = aggregate(x=NamedConnectTable$weight,
          by=list(NamedConnectTable$PreType, NamedConnectTable$PostType), FUN=mean)
names(NamedConnectTable_byType) <- c("PreType", "PostType","weight")


```


# Plot adjacency matrix of types, with and without clustering
```{r}

## Get adjacency matrix (All-to-All)
UniqueNamedBodies=unique(NamedBodies$bodytype)
AdjacentMat_byType = matrix(0, nrow = length(UniqueNamedBodies), ncol = length(UniqueNamedBodies))
rownames(AdjacentMat_byType) = colnames(AdjacentMat_byType) = unlist(UniqueNamedBodies)
for (val in 1:nrow(NamedConnectTable_byType)){AdjacentMat_byType[ as.character(NamedConnectTable_byType$PreType[val]),
                        as.character(NamedConnectTable_byType$PostType[val])] = NamedConnectTable_byType$weight[val] }


## Do some clustering for visualization purposes
## Previously, I tried tsne and pca with less success.
## Making the weight matrix binary helps a lot so that the disances are comparable across neurons.
SynThresh=10
SymmetricBinary_Matix = AdjacentMat_byType + t(AdjacentMat_byType)
SymmetricBinary_Matix[SymmetricBinary_Matix<SynThresh]=0
SymmetricBinary_Matix[SymmetricBinary_Matix>=SynThresh]=1
dist_mat <- dist(SymmetricBinary_Matix, method = 'binary')
hclust_avg <- hclust(dist_mat, method = 'average')

# Sort adjacency matrix
SortedWeightMatrix=AdjacentMat_byType[hclust_avg$order,]
SortedWeightMatrix=SortedWeightMatrix[,hclust_avg$order]

# Plot clusters
PlotSynThresh=10
png(file=paste(SaveDir,"NeuronTypeCluster.png",sep=""), width=20, height=8, units='in', res=500)
plot(hclust_avg) + theme(text = element_text(size=16))
dev.off()

# Plot unsorted and sorted adjacency matrices
xticks <- list(autotick = FALSE, ticks = "outside", tick0 = 0, dtick = 1, ticklen = 1,
  tickwidth = 1, tickcolor = toRGB("black"),title="PRE")
yticks <- list(autotick = FALSE, ticks = "outside", tick0 = 0, dtick = 1, ticklen = 1,
  tickwidth = 1, tickcolor = toRGB("black"),title="POST")

PlotDataType= AdjacentMat_byType
PlotDataType[PlotDataType<PlotSynThresh]=0
PlotDataType= replace(PlotDataType, which( PlotDataType==0), NA)
p4 <- plot_ly(x = rownames(PlotDataType), y = colnames(PlotDataType), z = PlotDataType, type = "heatmap") %>%
 layout(xaxis = yticks, yaxis = xticks, title=paste("Unsorted Adjacency Matrix of neuron types, threshold at ",PlotSynThresh, " synapses"))
htmlwidgets::saveWidget(as_widget(p4), paste(SaveDir,"UnsortedAdjacencyMatrix_byType.html",sep=""))
remove(p4)

PlotDataType= SortedWeightMatrix
PlotDataType[PlotDataType<PlotSynThresh]=0
PlotDataType= replace(PlotDataType, which( PlotDataType==0), NA)
p5 <- plot_ly(x = rownames(PlotDataType), y = colnames(PlotDataType), z = PlotDataType, type = "heatmap") %>%
 layout(xaxis = yticks, yaxis = xticks, title=paste("Sorted Adjacency Matrix of neuron types, threshold at ",PlotSynThresh, " synapses"))
htmlwidgets::saveWidget(as_widget(p5), paste(SaveDir,"SortedAdjacencyMatrix_byType.html",sep=""))

remove(yticks, xticks, PlotDataType, p5)

```




 











