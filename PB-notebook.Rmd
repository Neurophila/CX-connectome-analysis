---
title: "PB explorations"
output: html_notebook
---

Load the libraries
```{r}
library(nat)
library(neuprintr)
library(tidyverse)
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\pathways.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\visualizeConnectivityTables.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\neuprintQueryUtils.R")
options(nat.plotengine = 'rgl')
```

Connect to neuprint
```{r}
neuprint_login()
```

Identify types that arborize within the PB
```{r}
PBNronTypes = neuprint_find_neurons("PB")$bodytype %>% unique()
PBNronTypes <- PBNronTypes[which(!is.na(PBNronTypes))]
```

Split the PB types into inputs, outputs, and inner neurons
```{r}
PBpreNpostRatios <- preNpostRatios(PBNronTypes,"PB")

PBpreNpostRatios <- PBpreNpostRatios[which(PBpreNpostRatios$preRelative > 0.02 | PBpreNpostRatios$postRelative > 0.02),]
PBpreNpostRatios <- PBpreNpostRatios[order(PBpreNpostRatios$prePostDiff),]

PBpreNpostRatios['classification'] = 'inner'
PBpreNpostRatios[which(PBpreNpostRatios$prePostDiff > 0.15),]$classification = 'input'
PBpreNpostRatios[which(PBpreNpostRatios$prePostDiff < -0.1),]$classification = 'output'
PBpreNpostRatios$classification <- factor(PBpreNpostRatios$classification, levels = c('input','inner','output'))

p <- ggplot(data = PBpreNpostRatios, aes()) + 
  geom_hline(yintercept = 0) +
  geom_point(aes(x= reorder(as.factor(type), -prePostRatio),
                 y=prePostDiff,
                 color=classification),
                 size = 3,
                 alpha = 0.2) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_manual(values = c('green','blue','red')) +
  xlab('neuron type') + ylab('pre ratio - post ratio')
print(p)
```

Sort names by the anatomical order of the glomeruli in the PB
```{r}

glomSort <- function(names){
  sortedNames = unique(append(
    sort(
      as.character(names[which(grepl("_L",names))]),
      decreasing = TRUE),
    sort(
      as.character(names[which(grepl("_R",names))]),
      decreasing = FALSE))
  )
  return(sortedNames)
}

```


Look at the E-PG to Delta7 connections
```{r}
# Get the connection matrix from the EPGs to the Delta7s
EPG_2_Delta7 <- getConnectionTable_forSubset(
  unique(neuprint_search("EPG.*")$bodyid),
  unique(neuprint_search("Delta7.*")$bodyid),
  "PB")

#EPG_2_Delta7 <- Delta7Rename(EPG_2_Delta7,Delta7Lookup)

EPG_2_Delta7$partnerid <- factor(EPG_2_Delta7$partnerid,
        levels = glomSort(EPG_2_Delta7$partnerid))

plotConnectivityMatrix(EPG_2_Delta7, synapseCutOff = 2, 0)


```

Shift the connections on the above so that the peaks are aligned
```{r}
allD7ids = EPG_2_Delta7$nameid %>% as.character() %>% unique()
D7Gloms = strsplit(allD7ids,"_") %>% lapply(function(x){x[3]}) %>% unlist()
allD7ids <- append(
  sort(allD7ids[which(grepl("L",D7Gloms))],decreasing = TRUE),
  sort(allD7ids[which(grepl("R",D7Gloms))],decreasing = FALSE))
allEPGids = EPG_2_Delta7$partnerid %>% as.character() %>% unique() %>% glomSort()

justWeights = matrix(0L,nrow=length(allD7ids),ncol=length(allEPGids))

for (i in 1:length(allD7ids)){
  for (j in 1:length(allEPGids)){
    w = EPG_2_Delta7[which(EPG_2_Delta7$nameid == allD7ids[i] & EPG_2_Delta7$partnerid == allEPGids[j]),]$weight
    if (length(w) > 0)
      justWeights[i,j] = w
  }
}

p1 <- ggplot()
for (i in 1:length(allD7ids)){
  wNow = justWeights[i,]
  shift = which.max(wNow)-10
  if (shift == 0)
    wNow
  else
    wNow <- c(tail(wNow, -shift), head(wNow, shift))
  
  pts = c(1:length(wNow))
  
  df = data.frame(pts = pts, wNow = wNow)
  fit <- nls(wNow ~ (C1 * exp(-(pts-mean1)**2/(2 * sigma1**2)) +
    C2 * exp(-(pts-mean2)**2/(2 * sigma2**2))), data=df,
    start=list(C1=20, mean1=15, sigma1=5,
               C2=20, mean2=35, sigma2=5), algorithm="port") 
  dffit <- data.frame(pts)
  dffit$wNow <- predict(fit, newdata=dffit)
  
  if (as.numeric(coef(fit)['C1'])>as.numeric(coef(fit)['C2']))
    shift = coef(fit)['mean1'] %>% as.numeric()-25
  else
    shift = coef(fit)['mean2'] %>% as.numeric()-25

  if (shift == 0)
    wNow
  else
    wNow <- c(tail(wNow, -shift), head(wNow, shift))
  justWeights[i,] <- wNow
  
  p1 <- p1 + geom_line(data = data.frame(x = pts, y = wNow), aes(x=x,y=y))
  
}
p1 <- p1 + geom_line(data = data.frame(x = pts, y = colMeans(justWeights)), aes(x=x,y=y),color="red",size=3)

df = data.frame(pts = pts, wMean = colMeans(justWeights))
fit <- nls(wMean ~ (C1 * cos(-C2*(pts-theta))+C3), data=df,
  start=list(C1=20, C2=0.4, C3=10, theta=35), algorithm="port") 
dffit <- data.frame(pts)
dffit$wMean <- predict(fit, newdata=dffit)
p1 <- p1 + geom_line(data = dffit, aes(x=pts,y=wMean),color="green",size=2)

p1 <- p1 + xlab('EPG input position') + ylab('# of synapses')
print(p1)

library(reshape2)
ggplot(melt(justWeights), aes(Var1,Var2, fill=value)) + geom_raster()

```

PB-Sps only synapses on PFNds - CONVERT THIS TO HISTOGRAM BY TYPE
```{r}
SpsP_Post <- getConnectionTable(getBodyIdsForList(c("SpsP")),"POST","PB")
conmatPlot <- plotConnectivityMatrix(SpsP_Post, synapseCutOff = 5, 0)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
print(conmatPlot)
```

LPsP inputs and outputs - CONVERT THIS TO HISTOGRAM BY TYPE
```{r}
LPsP_Post <- getConnectionTable(getBodyIdsForList(c("LPsP")),"POST","PB")
conmatPlot <- plotConnectivityMatrix(LPsP_Post, synapseCutOff = 5, 0)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
print(conmatPlot)

LPsP_Pre <- getConnectionTable(getBodyIdsForList(c("LPsP")),"PRE","PB")
conmatPlot <- plotConnectivityMatrix(LPsP_Pre, synapseCutOff = 5, 0)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
print(conmatPlot)
```

Look more closely at the P6-8P9 - come up with better way to show this!
```{r}
P68P9_Post <- getConnectionTable(getBodyIdsForList(c("P6-8P9")),"POST","PB")
conmatPlot <- plotConnectivityMatrix(P68P9_Post, synapseCutOff = 5, 0)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
print(conmatPlot)

P68P9_Pre <- getConnectionTable(getBodyIdsForList(c("P6-8P9")),"PRE","PB")
conmatPlot <- plotConnectivityMatrix(P68P9_Pre, synapseCutOff = 5, 0)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
print(conmatPlot)
```

Show EB<->PB and FB<->PB connections
```{r}
nronTypes = c("EPG","IbSpsP","Delta7","P6-8P9",
              "PE")
EB_PB <- getConnectionTable_forSubset(
  getBodyIdsForList(nronTypes)$bodyid,
  getBodyIdsForList(nronTypes)$bodyid,"PB")

conmatPlot <- plotConnectivityMatrix(EB_PB, synapseCutOff = 3, 0)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
print(conmatPlot)

nronTypes = c("EPG","IbSpsP","Delta7","P6-8P9",
              "PF")
EB_PB <- getConnectionTable_forSubset(
  getBodyIdsForList(nronTypes)$bodyid,
  getBodyIdsForList(nronTypes)$bodyid,"PB")

conmatPlot <- plotConnectivityMatrix(EB_PB, synapseCutOff = 3, 0)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
print(conmatPlot)
```

Look at PB-IB,SPS inputs
```{r}
IbSpsP_Pre <- getConnectionTable(getBodyIdsForList(c("IbSpsP")),"PRE","IB")
conmatPlot <- plotConnectivityMatrix(IbSpsP_Pre, synapseCutOff = 5, 0)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
print(conmatPlot)

IbSpsP_Pre <- getConnectionTable(getBodyIdsForList(c("IbSpsP")),"PRE","SPS(L)")
conmatPlot <- plotConnectivityMatrix(IbSpsP_Pre, synapseCutOff = 5, 0)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
print(conmatPlot)

IbSpsP_Pre <- getConnectionTable(getBodyIdsForList(c("IbSpsP")),"PRE","SPS(R)")
conmatPlot <- plotConnectivityMatrix(IbSpsP_Pre, synapseCutOff = 5, 0)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
print(conmatPlot)
```
