---
title: "PB explorations"
output: html_notebook
---

Load the libraries
```{r}
library(nat)
library(neuprintr)
library(tidyverse)
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\pathways.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\visualizeConnectivityTables.R")
options(nat.plotengine = 'rgl')
```

Connect to neuprint
```{r}
neuprint_login()
```

Identify types that arborize within the PB
```{r}
PBNronTypes = neuprint_find_neurons("PB")$bodytype %>% unique()
PBNronTypes <- PBNronTypes[which(!is.na(PBNronTypes))]
```

Split the PB types into inputs, outputs, and inner neurons
```{r}
PBpreNpostRatios <- preNpostRatios(PBNronTypes,"PB")

PBpreNpostRatios <- PBpreNpostRatios[which(PBpreNpostRatios$preRelative > 0.02 | PBpreNpostRatios$postRelative > 0.02),]
PBpreNpostRatios <- PBpreNpostRatios[order(PBpreNpostRatios$prePostDiff),]

PBpreNpostRatios['classification'] = 'inner'
PBpreNpostRatios[which(PBpreNpostRatios$prePostDiff > 0.15),]$classification = 'input'
PBpreNpostRatios[which(PBpreNpostRatios$prePostDiff < -0.1),]$classification = 'output'
PBpreNpostRatios$classification <- factor(PBpreNpostRatios$classification, levels = c('input','inner','output'))

p <- ggplot(data = PBpreNpostRatios, aes()) + 
  geom_hline(yintercept = 0) +
  geom_point(aes(x= reorder(as.factor(type), -prePostRatio),
                 y=prePostDiff,
                 color=classification),
                 size = 3,
                 alpha = 0.2) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_manual(values = c('green','blue','red')) +
  xlab('neuron type') + ylab('pre ratio - post ratio')
print(p)
```

Sort the Delta 7s according to their max output column
```{r}
# Get the PEN2 and Delta 7 bodyids
types = c("PEN\\\\\\\\(PB06\\\\\\\\)_b","Delta7")
allBodyIds = c()
for (t in 1:length(types)){
  allBodyIds <- append(allBodyIds,
                       neuprint_search(paste0(types[t],'.*'))$bodyid)
}

# Get the connection matrix from the Delta 7s to the PEN2s
Delta7_2_PEN1 <- neuprint_connection_table(allBodyIds)
Delta7_2_PEN1 <- Delta7_2_PEN1 %>%
                      mutate(partnerName = neuprint_get_meta(partner)[["name"]],
                             name =neuprint_get_meta(bodyid)[["name"]],
                             type = neuprint_get_meta(bodyid)[["type"]],
                             partnerType = neuprint_get_meta(partner)[["type"]])  
Delta7_2_PEN1 <- Delta7_2_PEN1[which(grepl("PEN",Delta7_2_PEN1$type) & grepl("Delta7",Delta7_2_PEN1$partnerType)),]
colnames(Delta7_2_PEN1)[colnames(Delta7_2_PEN1)=="bodyid"] <- "nameid"
colnames(Delta7_2_PEN1)[colnames(Delta7_2_PEN1)=="partner"] <- "partnerid"

# Create a lookup table of bodyids to names for the Delta 7s based off of where they strongly output to the PEN2s
Delta7bodyids = Delta7_2_PEN1$partnerid %>% unique()
Delta7names= c()

for (d in 1:length(Delta7bodyids)){
  
  datNow = Delta7_2_PEN1[which(Delta7_2_PEN1$partnerid == Delta7bodyids[d]),]
  PENnmPrts1 = datNow$name[which.max(datNow$weight)] %>% as.character() %>% strsplit('_')
  Glom1 = PENnmPrts1[[1]][[3]]
  
  datNow <- datNow[which(!grepl(Glom1,datNow$name)),]
  PENnmPrts2 = datNow$name[which.max(datNow$weight)] %>% as.character %>% strsplit('_')
  Glom2 = PENnmPrts2[[1]][[3]]
  
  while (grepl(substring(Glom1,1,1),substring(Glom2,1,1)) &
         ((as.integer(substring(Glom1,2,2)) == as.integer(substring(Glom2,2,2))+1)|
          (as.integer(substring(Glom1,2,2)) == as.integer(substring(Glom2,2,2))-1))) {
    datNow <- datNow[which(!grepl(Glom2,datNow$name)),]
    PENnmPrts2 = datNow$name[which.max(datNow$weight)] %>% as.character %>% strsplit('_')
    Glom2 = PENnmPrts2[[1]][[3]]
          }
  
  D7nmPrts = datNow$partnerName[which.max(datNow$weight)] %>% as.character() %>% strsplit('_')
  
  Delta7names = append(Delta7names,
                       paste(D7nmPrts[[1]][[1]], Glom1, Glom2, sep = '_'))
}

Delta7Lookup = data.frame(bodyids = Delta7bodyids, name = Delta7names)

```

A function to replace Delta 7 names according to the lookup table in connection matrices
```{r}

Delta7Rename <- function(df,Delta7Lookup){

  dfNames = df$name %>% as.character()
  dfPartnerNames = df$partnerName %>% as.character()
  dfBodyIds = df$nameid %>% as.numeric()
  dfPartnerBodyIds = df$partnerid %>% as.numeric()
  for (bid in 1:nrow(Delta7Lookup)){
    dfNames[which(dfBodyIds == Delta7Lookup$bodyids[bid])] <- Delta7Lookup$name[bid] %>% as.character()
    dfPartnerNames[which(dfPartnerBodyIds == Delta7Lookup$bodyids[bid])] <- Delta7Lookup$name[bid] %>% as.character()
  }
  
  D7Gloms = strsplit(as.character(Delta7Lookup$name),"_") %>% lapply(function(x){x[3]}) %>% unlist()
  D7Names = Delta7Lookup$name %>% as.character()
  
  df$name <- factor(dfNames,
                  levels = unique(append(append(
                    sort(
                      D7Names[which(grepl("L",D7Gloms))],
                      decreasing = TRUE),
                    sort(
                      D7Names[which(grepl("R",D7Gloms))],
                      decreasing = FALSE)
                    ),
                    dfNames[which(!(dfNames %in% D7Names))])))
  
  df$partnerName <- factor(dfPartnerNames,
                  levels = unique(append(append(
                    sort(
                      D7Names[which(grepl("L",D7Gloms))],
                      decreasing = TRUE),
                    sort(
                      D7Names[which(grepl("R",D7Gloms))],
                      decreasing = FALSE)
                    ),
                    dfPartnerNames[which(!(dfPartnerNames %in% D7Names))])))
  
  return(df)
}
```

```{r}

glomSort <- function(names){
  sortedNames = unique(append(
    sort(
      as.character(names[which(grepl("_L",names))]),
      decreasing = TRUE),
    sort(
      as.character(names[which(grepl("_R",names))]),
      decreasing = FALSE))
  )
  return(sortedNames)
}

```

```{r}
Delta7_2_PEN1_RO <- Delta7Rename(Delta7_2_PEN1,Delta7Lookup)

Delta7_2_PEN1_RO <- Delta7_2_PEN1_RO %>% mutate(longName = paste(as.character(name),as.character(nameid),sep='-')) %>%
  mutate(longPartnerName = paste(as.character(partnerName),as.character(partnerid),sep='-'))

D7Gloms = strsplit(as.character(Delta7_2_PEN1_RO$longPartnerName),"_") %>% lapply(function(x){x[3]}) %>% unlist()
D7Gloms <- strsplit(D7Gloms,"-") %>% lapply(function(x){x[1]}) %>% unlist()
D7Names = Delta7_2_PEN1_RO$longPartnerName %>% as.character()

Delta7_2_PEN1_RO$longName <- factor(Delta7_2_PEN1_RO$longName,
        levels = glomSort(Delta7_2_PEN1_RO$longName))
Delta7_2_PEN1_RO$longPartnerName <- factor(D7Names,
                  levels = unique(append(
                    sort(
                      D7Names[which(grepl("L",D7Gloms))],
                      decreasing = TRUE),
                    sort(
                      D7Names[which(grepl("R",D7Gloms))],
                      decreasing = FALSE)
                    )))


conmatPlot = ggplot(Delta7_2_PEN1_RO  %>% filter(weight > 2)) + 
    theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
    scale_fill_gradient2(low="ivory", mid="peachpuff", high="black", limits=c(0,max(Delta7_2_PEN1_RO$weight)))

conmatPlot <-  conmatPlot + geom_tile(aes(longName,longPartnerName,fill=weight))

print(conmatPlot)
```

