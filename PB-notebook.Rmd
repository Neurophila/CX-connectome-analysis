---
title: "PB explorations"
output: html_notebook
---

Load the libraries
```{r}
library(nat)
library(neuprintr)
library(tidyverse)
library(tidygraph)
library(ggraph)
library(gridExtra)
library(reshape2)

source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\pathways.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\PBAnalysisUtils.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\R\\supertypeUtils.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\visualizeConnectivityTables.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\neuprintQueryUtils.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\colorCodeLookup.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\FBNetworkVisUtils.R")
options(nat.plotengine = 'rgl')
```

Connect to neuprint
```{r}
neuprint_login()
```

Sort names by the anatomical order of the glomeruli in the PB
```{r}

glomSort <- function(names){
  sortedNames = unique(append(
    sort(
      as.character(names[which(grepl("_L",names))]),
      decreasing = TRUE),
    sort(
      as.character(names[which(grepl("_R",names))]),
      decreasing = FALSE))
  )
  return(sortedNames)
}

```

Plot a PB specific connectivity matrix (allows sorting by PB glomeruli)
```{r}
plotConnectivityMatrixPB = function(myConTab) {

  myConTab = myConTab %>% mutate(plotWeight = myConTab[["ROIweight"]])
  myConTab <- myConTab[which(myConTab$plotWeight>2),]
  
  myConTab$nameid = paste(as.character(myConTab$name.from), as.character(myConTab$from), sep = "_")
  myConTab$partnerid = paste(as.character(myConTab$name.to), as.character(myConTab$to), sep = "_")
  
  allNames = myConTab$nameid %>% unique() %>% sort()
  types = strsplit(allNames,'_') %>% lapply(function(x){x[[1]]}) %>% unique() %>% unlist()
  types = gsub("([\\(\\)])", "\\\\\\1",types)
  newNames = c()
  for (tp in 1:length(types)){
    newNames = append(newNames,
                      glomSort(allNames[which(grepl(types[tp],allNames))]))
  }
  myConTab$nameid <- factor(myConTab$nameid, levels = newNames)
  
  allNames = myConTab$partnerid %>% unique() %>% sort()
  types = strsplit(allNames,'_') %>% lapply(function(x){x[[1]]}) %>% unique() %>% unlist()
  types = gsub("([\\(\\)])", "\\\\\\1",types)
  newNames = c()
  for (tp in 1:length(types)){
    newNames = append(newNames,
                      glomSort(allNames[which(grepl(types[tp],allNames))]))
  }
  myConTab$partnerid <- factor(myConTab$partnerid, levels = newNames)
  
    
  conmatPlot = ggplot(myConTab) + 
    theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
    scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", midpoint =0.5*max(myConTab$plotWeight), limits=c(0,max(myConTab$plotWeight)))
  
  conmatPlot =  conmatPlot + geom_tile(aes(partnerid,nameid,fill=plotWeight))
}
```

Identify types that arborize within the PB
```{r}
PBNronTypes = neuprint_find_neurons("PB")$bodytype %>% unique()
PBNronTypes <- PBNronTypes[which(!is.na(PBNronTypes))]
```

Split the PB types into inputs, outputs, and inner neurons
```{r}
# For each single neuron
PBpreNpostRatios <- preNpostRatios(PBNronTypes,"PB")

# Look at the pre and post ratios and then cut those neurons with minimal innervations
ggplot(PBpreNpostRatios, aes(x=preRelative, y=postRelative,color=type)) + geom_point()
PBpreNpostRatios <- PBpreNpostRatios[which(PBpreNpostRatios$preRelative > 0.02 | PBpreNpostRatios$postRelative > 0.01),]
ggplot(PBpreNpostRatios, aes(x=preRelative, y=postRelative,color=type)) + geom_point()

# Order the neurons by the pre and post ratio difference
PBpreNpostRatios <- PBpreNpostRatios[order(PBpreNpostRatios$prePostDiff),]

# Classify the neurons into inner, input, or output neurons based off of the ratio difference
PBpreNpostRatios['classification'] = 'inner'
PBpreNpostRatios[which(PBpreNpostRatios$prePostDiff > 0.15),]$classification = 'input'
PBpreNpostRatios[which(PBpreNpostRatios$prePostDiff < -0.1),]$classification = 'output'
PBpreNpostRatios$classification <- factor(PBpreNpostRatios$classification, levels = c('input','inner','output'))

# Plot these ratios for each individual neuron
p1 <- ggplot(data = PBpreNpostRatios, aes()) + 
  geom_hline(yintercept = 0) +
  geom_point(aes(x= reorder(as.factor(type), -prePostRatio),
                 y=prePostDiff,
                 color=classification),
                 size = 4,
                 alpha = 0.2) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_manual(values = c('green','blue','red')) +
  xlab('neuron type') + ylab('pre ratio - post ratio')
print(p1)

```

Average the pre and post values within a given class
```{r}
PBpreNpost <- PBpreNpostRatios %>% group_by(type) %>% 
  summarize(diffMean = mean(prePostDiff),
            diffSD = sd(prePostDiff),
            relMeanPre = mean(preRelative),
            relSDPre = sd(preRelative),
            relMeanPost = mean(postRelative),
            relSDPost = sd(postRelative))

PBpreNpost['classification'] = 'inner'
PBpreNpost[which(PBpreNpost$diffMean > 0.15),]$classification = 'input'
PBpreNpost[which(PBpreNpost$diffMean < -0.12),]$classification = 'output'
PBpreNpost$classification <- factor(PBpreNpost$classification, levels = c('input','inner','output'))
PBpreNpost <- PBpreNpost[order(PBpreNpost$diffMean),]

ggplot(PBpreNpost, aes(x=relMeanPre, y=relMeanPost,color=classification,label=type)) +
  geom_point(size=6) +
  geom_text(aes(label=type),hjust=0, vjust=0,size = 6,show.legend = FALSE) +
  geom_errorbar(aes(ymin=relMeanPost-relSDPost, ymax=relMeanPost+relSDPost),
                width=.02, position=position_dodge(0.05)) +
  geom_errorbarh(aes(xmin=relMeanPre-relSDPre, xmax=relMeanPre+relSDPre),
                height=.02, position=position_dodge(0.05)) +
  theme_classic() + xlab('pre ratio') + ylab('post ratio') + 
  coord_fixed(ratio =1 ,xlim=c(0, 1.1),ylim=c(0, 1.1),expand=FALSE)  + 
  geom_abline(intercept = 0, slope = 1, color="black", linetype="dashed", size=1) +
  theme(panel.grid.major = element_line(colour = "gray",linetype="dashed"))
ggsave("PBInputsAndOutputsMean2D.svg", plot = last_plot(), device='svg', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)

dodge <- position_dodge(width = 0.9)
limits <- aes(ymax = PBpreNpost$diffMean + PBpreNpost$diffSD,
              ymin = PBpreNpost$diffMean - PBpreNpost$diffSD)

PBInNOutBarPlot <- ggplot(data = PBpreNpost, aes(x = reorder(as.factor(type), -diffMean), y = diffMean, fill = classification)) + 
  geom_hline(yintercept = 0) +
  geom_bar(stat = "identity", position = dodge) +
  geom_errorbar(limits, position = dodge, width = 0.25) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),text = element_text(size=18)) +
  scale_fill_manual(values = c('forestgreen','blue','red2')) +
  xlab('neuron type') + ylab('pre ratio - post ratio')
print(PBInNOutBarPlot)
ggsave("PBInputsAndOutputsMean.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```

Look at the E-PG to Delta7 connections
```{r}
# Get the connection matrix from the EPGs to the Delta7s
EPG_2_Delta7 <- getConnectionTable_forSubset(
  unique(neuprint_search("EPG\\\\\\\\(.*")$bodyid),
  unique(neuprint_search("Delta7.*")$bodyid),
  "PB")

EPG_2_Delta7$name.to <- factor(EPG_2_Delta7$name.to,
        levels = glomSort(EPG_2_Delta7$name.to))

EPG_2_Delta7$nameid = paste(as.character(EPG_2_Delta7$name.from), as.character(EPG_2_Delta7$from), sep = "_")
EPG_2_Delta7$partnerid = paste(as.character(EPG_2_Delta7$name.to), as.character(EPG_2_Delta7$to), sep = "_")

conmatPlot <- plotConnectivityMatrixPB(EPG_2_Delta7)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
conmatPlot <- addMatrixPlotLabs(conmatPlot, "pre-synaptic neuron", "post-synaptic neuron", "PB", connectionMeasure="ROIweights")

ggsave("EPGToD7inPB.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)

print(conmatPlot)

```

Look at the Delta7 to E-PG connections
```{r}
# Get the connection matrix from the EPGs to the Delta7s
Delta7_2_EPG<- getConnectionTable_forSubset(
  unique(neuprint_search("Delta7.*")$bodyid),
  unique(neuprint_search("EPG\\\\\\\\(.*")$bodyid),
  "PB")

Delta7_2_EPG$name.to <- factor(Delta7_2_EPG$name.to,
        levels = glomSort(Delta7_2_EPG$name.to))

Delta7_2_EPG$nameid = paste(as.character(Delta7_2_EPG$name.from), as.character(Delta7_2_EPG$from), sep = "_")
Delta7_2_EPG$partnerid = paste(as.character(Delta7_2_EPG$name.to), as.character(Delta7_2_EPG$to), sep = "_")

conmatPlot <- plotConnectivityMatrixPB(Delta7_2_EPG)
#conmatPlot <- structureMatrixPlotByType(conmatPlot)
conmatPlot <- addMatrixPlotLabs(conmatPlot, "pre-synaptic neuron", "post-synaptic neuron", "PB", connectionMeasure="ROIweights")

ggsave("D7ToEPGinPB.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)

print(conmatPlot)

```

Shift the connections on the above so that the peaks are aligned
```{r}
allD7ids = EPG_2_Delta7$partnerid %>% as.character() %>% unique()
D7Gloms = strsplit(allD7ids,"_") %>% lapply(function(x){x[3]}) %>% unlist()
allEPGids = EPG_2_Delta7$nameid %>% as.character() %>% unique() %>% glomSort()

justWeights = matrix(0L,nrow=length(allD7ids),ncol=length(allEPGids))

for (i in 1:length(allD7ids)){
  for (j in 1:length(allEPGids)){
    w = EPG_2_Delta7[which(EPG_2_Delta7$partnerid == allD7ids[i] & EPG_2_Delta7$nameid == allEPGids[j]),]$weight
    if (length(w) > 0)
      justWeights[i,j] = w
  }
}
library(reshape2)
ggplot(melt(justWeights), aes(Var1,Var2, fill=value)) + geom_raster()

PBRegInputsPlot <- ggplot()
for (i in 1:length(allD7ids)){
  wNow = justWeights[i,]
  shift = which.max(wNow)-12
  if (shift == 0){
    wNow
  } else {
    wNow <- c(tail(wNow, -shift), head(wNow, shift))
  }
  
  pts = c(1:length(wNow)-1)
  
  df = data.frame(pts = pts, wNow = wNow)
  fit <- nls(wNow ~ (C1 * exp(-(pts-mean1)**2/(2 * sigma1**2)) +
    C2 * exp(-(pts-mean2)**2/(2 * sigma2**2))), data=df,
    start=list(C1=20, mean1=15, sigma1=5,
               C2=20, mean2=35, sigma2=5), algorithm="port") 
  dffit <- data.frame(pts)
  dffit$wNow <- predict(fit, newdata=dffit)
  
  if (as.numeric(coef(fit)['C1'])>as.numeric(coef(fit)['C2']))
    shift = coef(fit)['mean1'] %>% as.numeric()-25
  else
    shift = coef(fit)['mean2'] %>% as.numeric()-25

  if (shift == 0)
    wNow
  else
    wNow <- c(tail(wNow, -shift), head(wNow, shift))
  justWeights[i,] <- wNow
  
  PBRegInputsPlot <- PBRegInputsPlot + geom_line(data = data.frame(x = pts, y = wNow), aes(x=x,y=y))
  
}
PBRegInputsPlot <- PBRegInputsPlot +  geom_line(data = data.frame(x = pts, y = colMeans(justWeights)), aes(x=x,y=y,color="red"),size=2) +
  scale_color_discrete(name="",labels = c("mean"))

df = data.frame(pts = pts, wMean = colMeans(justWeights))
fit <- nls(wMean ~ (C1 * cos(-C2*(pts-theta))+C3), data=df,
  start=list(C1=20, C2=0.4, C3=10, theta=35), algorithm="port") 
dffit <- data.frame(pts)
dffit$wMean <- predict(fit, newdata=dffit)
#p1 <- p1 + geom_line(data = dffit, aes(x=pts,y=wMean),color="green",size=2)

PBRegInputsPlot <- PBRegInputsPlot + theme_classic() + xlab('EPG input position') + ylab('# of synapses') + 
  scale_x_continuous(limits = c(pts[1], tail(pts,1)), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,50), expand = c(0, 0))
print(p1)

ggsave("EPGToD7Profile.pdf", plot = PBRegInputsPlot, device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)

ggplot(melt(justWeights), aes(Var1,Var2, fill=value)) + geom_raster()

```

############################################################
Propagate an E-PG bump through the Delta7s
############################################################

Plot the EPG input from D7s given a von Mises or Impulse input profile
```{r}
# Use a von Mises bump profile
actProfvM <- data.frame(act = vonMisesProf(),
                        glom = c("R1","L8","R2","L7","R3","L6","R4","L5",
                                 "R5","L4","R6","L3","R7","L2","R8","L1"))

# Transform the bump from EB coordinates to 
vMOut <- EPGToD7Transform("EPG\\\\\\\\(.*",actProfvM)

# Get the profile stats
D7OutputShape_stats <- D7ShapeMeanSD(vMOut)
  
# Fit a cosine to the data
fit <- D7CosFit(D7OutputShape_stats) 

# Plot
PBEPGToD7Prof_vM <- PBActPlot(D7OutputShape_stats,fit)
PBEPGToD7Prof_vM <- PBEPGToD7Prof_vM + ggtitle('von Mises input') 

# Use activity only in one set of EPGs in a given glom.
actProf <- vector(mode="numeric",length = 16)
actProf[8] <- 1
actProfImp <- data.frame(act = actProf,
                         glom = c("R1","L8","R2","L7","R3","L6","R4","L5",
                                 "R5","L4","R6","L3","R7","L2","R8","L1"))
impOut <- EPGToD7Transform("EPG\\\\\\\\(.*",actProfImp)

# Get the profile stats
D7OutputShape_stats <- D7ShapeMeanSD(impOut)
  
# Fit a cosine to the data
fit <- D7CosFit(D7OutputShape_stats) 

# Plot
PBEPGToD7Prof_imp <- PBActPlot(D7OutputShape_stats,fit)
PBEPGToD7Prof_imp <- PBEPGToD7Prof_imp + ggtitle('impulse input') 

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\PBEPGToD7Profiles.pdf", width = 5, height = 5)
print(grid.arrange(PBEPGToD7Prof_vM,PBEPGToD7Prof_imp,ncol=1))
dev.off()
```

Find the RSS for a cosine fit for the outputs of D7s onto PE and PF neurons
```{r}
# Use a von Mises bump profile
actProfvM <- data.frame(act = vonMisesProf(),
                        glom = c("R1","L8","R2","L7","R3","L6","R4","L5",
                                 "R5","L4","R6","L3","R7","L2","R8","L1"))

# Use activity only in one set of EPGs in a given glom.
actProf <- vector(mode="numeric",length = 16)
actProf[8] <- 1
actProfImp <- data.frame(act = actProf,
                         glom = c("R1","L8","R2","L7","R3","L6","R4","L5",
                                 "R5","L4","R6","L3","R7","L2","R8","L1"))

# Specify the search strings
PBTps <- c("EPG\\\\\\\\(","PEN_a","PEN_b","PEG",
           "PFNa","PFNd","PFNm_a","PFNm_b","PFNp_a","PFNp_b","PFNp_c","PFNv" )
PBTpNames <- c("EPG","PEN1","PEN2","PEG",
               "PFNa","PFNd","PFNm_a","PFNm_b","PFNp_a","PFNp_b","PFNp_c","PFNv" )

allvMPlts <- list()
allvMDev <- c()
allimpPlts <- list()
allimpDev <- c()
for (tp in 1:length(PBTps)){
  # Get the von Mises profiles
  vMOut <- EPGToD7Transform(paste0(PBTps[tp],".*"),actProfvM)
  
  # Get the profile stats
  D7OutputShape_stats <- D7ShapeMeanSD(vMOut)
  
  # Fit a cosine to the data
  fit <- D7CosFit(D7OutputShape_stats)
  allvMDev <- append(allvMDev,deviance(fit))

  # Plot
  PBEPGToD7Prof_vM <- PBActPlot(D7OutputShape_stats,fit)
  PBEPGToD7Prof_vM <- PBEPGToD7Prof_vM + ggtitle(paste('von Mises input',PBTps[tp],sep='-')) 
  allvMPlts[[tp]] <- PBEPGToD7Prof_vM
  
  # Get the impulse profiles
  impOut <- EPGToD7Transform(paste0(PBTps[tp],".*"),actProfImp)
  
  # Get the profile stats
  D7OutputShape_stats <- D7ShapeMeanSD(impOut)
  
  # Fit a cosine to the data
  fit <- D7CosFit(D7OutputShape_stats)
  allimpDev <- append(allimpDev,deviance(fit))

  # Plot
  PBEPGToD7Prof_imp <- PBActPlot(D7OutputShape_stats,fit)
  PBEPGToD7Prof_imp <- PBEPGToD7Prof_imp + ggtitle(paste('von Mises input',PBTps[tp],sep='-'))
  allimpPlts[[tp]] <- PBEPGToD7Prof_imp
}

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\PBEPGToD7Profiles_All.pdf", width = 50, height = 5)
print(grid.arrange(grobs = c(allvMPlts,allimpPlts),nrow=2))
dev.off()

vM_stats <- data.frame(type = PBTpNames, resid = allvMDev)
gvM <- ggplot(vM_stats,aes(x=as.factor(type),y=resid)) + geom_point(size=4) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  coord_cartesian(expand=FALSE)
imp_stats <- data.frame(type = PBTpNames, resid = allimpDev)
gimp <- ggplot(imp_stats,aes(x=as.factor(type),y=resid)) + geom_point(size=4) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  coord_cartesian(expand=FALSE)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\D7CosFitStats.pdf", width = 5, height = 5)
print(grid.arrange(gvM,gimp,nrow=1))
dev.off()

gvM <- gvM + theme(axis.text.x = element_text(size=24),
                     axis.text.y = element_text(size=24))
gimp <- gimp + theme(axis.text.x = element_text(size=24),
                     axis.text.y = element_text(size=24))
ggsave(file="C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\D7CosFitStats.svg", plot=grid.arrange(gvM,gimp,nrow=1), width=10, height=5)

```

############################################################
Look at various inputs and outputs
############################################################

Function to plot mean and sd of partner weights from a connection table with ONE original type
```{r}
connectivityBarPlot <- function(df,prepost){
  
  dfMean <- aggregate(weight~partnerType,
                      df,
                      mean)
  dfSD <- aggregate(weight~partnerType,
                      df,
                      sd)
  colnames(dfMean)[2] <- "mean"
  colnames(dfSD)[2] <- "sd"
  df <- merge(dfMean, dfSD,by="partnerType")
  
    dodge <- position_dodge(width = 0.9)
  limits <- aes(ymax = df$mean + df$sd,
                ymin = df$mean - df$sd)

  p <- ggplot(data = df, aes(x = reorder(as.factor(partnerType), -mean), y = mean, fill = partnerType)) + 
  geom_bar(stat = "identity", position = dodge) +
  geom_errorbar(limits, position = dodge, width = 0.25) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),text = element_text(size=12)) +
  xlab('neuron type') + theme(legend.position="none")
  
  if (grepl(prepost,"PRE")){
    p <- p + ylab("PSDs")
    
  }
  if (grepl(prepost,"POST")){
    p <- p  + ylab("tbars") 
  }
 

  
  return(p)
}
```

Look at IbSpsP inputs
```{r}
IbSpsP_Pre <- getConnectionTable(getBodyIdsForList(c("IbSpsP")),"PRE","IB")
p <- connectivityBarPlot(IbSpsP_Pre,"PRE") + ggtitle("IbSpsP inputs")
print(p)
ggsave("IbSpsPInputs.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```


PB-Sps only synapses on PFNds
```{r}
SpsP_Post <- getConnectionTable(getBodyIdsForList(c("SpsP")),"POST","PB")

p <- connectivityBarPlot(SpsP_Post,"POST") + ggtitle("SpsP outputs")
print(p)

ggsave("SpsPOutputs.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```

LPsP inputs and outputs
```{r}
LPsP_Post <- getConnectionTable(getBodyIdsForList(c("LPsP")),"POST","PB")
p <- connectivityBarPlot(LPsP_Post,"POST") + ggtitle("LPsP outputs")
print(p)
ggsave("LPsPOutputs.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)

LPsP_Pre <- getConnectionTable(getBodyIdsForList(c("LPsP")),"PRE","PB")
p <- connectivityBarPlot(LPsP_Pre,"PRE") + ggtitle("LPsP inputs")
print(p)
ggsave("LPsPInputs.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```

Look more closely at the P6-8P9
```{r}
P68P9_Post <- getConnectionTable(getBodyIdsForList(c("P6-8P9")),"POST","PB")
p <- connectivityBarPlot(P68P9_Post,"POST") + ggtitle("P6-8P9 outputs")
print(p)
ggsave("P6-8P9Outputs.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)

P68P9_Pre <- getConnectionTable(getBodyIdsForList(c("P6-8P9")),"PRE","PB")
p <- connectivityBarPlot(P68P9_Pre,"PRE") + ggtitle("P6-8P9 inputs")
print(p)
ggsave("P6-8P9Inputs.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```

Look at P1-9 inputs and outputs
```{r}
P19_Post <- getConnectionTable(getBodyIdsForList(c("P1-9")),"POST","PB")
p <- connectivityBarPlot(P19_Post,"POST") + ggtitle("P1-9 outputs")
print(p)
ggsave("P1-9Outputs.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)

P19_Pre <- getConnectionTable(getBodyIdsForList(c("P1-9")),"PRE","PB")
p <- connectivityBarPlot(P19_Pre,"PRE") + ggtitle("P1-9 inputs")
print(p)
ggsave("P1-9Inputs.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```

Show EB<->PB and FB<->PB connections
```{r}
nronTypes = c("EPG","IbSpsP","Delta7")

myConTab <- getConnectionTable_forSubset(
  getBodyIdsForList(nronTypes)$bodyid,
  getBodyIdsForList(nronTypes)$bodyid,"PB")

conmatPlotPBInner <- plotConnectivityMatrixPB(myConTab)
conmatPlotPBInner <- structureMatrixPlotByType(conmatPlotPBInner)
conmatPlotPBInner <- addMatrixPlotLabs(conmatPlotPBInner, "pre-synaptic neurons", "post-synaptic neurons", "PB")
print(conmatPlotPBInner)

ggsave("WithinPBConnections.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)


nronTypesPre = c("EPG","IbSpsP","Delta7")
nronTypesPost = c("PE")
EB_PB <- getConnectionTable_forSubset(
  getBodyIdsForList(nronTypesPre)$bodyid,
  getBodyIdsForList(nronTypesPost)$bodyid,"PB")

conmatPlotPBToEB <- plotConnectivityMatrixPB(EB_PB)
conmatPlotPBToEB <- structureMatrixPlotByType(conmatPlotPBToEB)
conmatPlotPBToEB <- addMatrixPlotLabs(conmatPlotPBToEB, "pre-synaptic neurons", "post-synaptic neurons", "PB")
print(conmatPlotPBToEB)

ggsave("PBToEBConnections.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 10, height = 15, units ="cm", dpi = 600, limitsize = TRUE)

nronTypesPre = c("EPG","IbSpsP","Delta7")
nronTypesPost = c("PF")
FB_PB <- getConnectionTable_forSubset(
  getBodyIdsForList(nronTypesPre)$bodyid,
  getBodyIdsForList(nronTypesPost)$bodyid,"PB")

conmatPlotPBToFB <- plotConnectivityMatrixPB(FB_PB)
conmatPlotPBToFB <- structureMatrixPlotByType(conmatPlotPBToFB)
conmatPlotPBToFB <- addMatrixPlotLabs(conmatPlotPBToFB, "pre-synaptic neurons", "post-synaptic neurons", "PB")
print(conmatPlotPBToFB)

ggsave("PBToFBConnections.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```

Look at P1-9s
```{r}
P19Inputs = getConnectionTable(getBodyIdsForList("P1-9")$bodyid,"PRE", "PB")
conmatPlot <- plotConnectivityMatrixPB(P19Inputs)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
conmatPlot <- addMatrixPlotLabs(conmatPlot, "pre-synaptic neurons", "post-synaptic neurons", "PB")
print(conmatPlot)

P19Outputs = getConnectionTable(getBodyIdsForList("P1-9")$bodyid,"POST", "PB")
conmatPlot <- plotConnectivityMatrixPB(P19Outputs)
conmatPlot <- structureMatrixPlotByType(conmatPlot)
conmatPlot <- addMatrixPlotLabs(conmatPlot, "pre-synaptic neurons", "post-synaptic neurons", "PB")
print(conmatPlot)
```

Assemble the plots into a figure
```{r}
pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\PB\\PB_Summary.pdf", width = 15, height = 15)
print(grid.arrange(PBInNOutBarPlot,
                   conmatPlotPBInner,
                   PBEPGToD7Prof_vM,
                   gvM,gimp,
                   conmatPlotPBToEB,
                   conmatPlotPBToFB,
                   layout_matrix = rbind(c(1,1,2,2),c(1,1,2,2),
                                         c(3,3,6,6),c(4,5,6,6),
                                         c(7,7,7,7))))
dev.off()
```
