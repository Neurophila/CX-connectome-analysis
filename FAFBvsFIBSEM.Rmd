---
title: "FAFB vs. FIBSEM"
output: html_notebook
---

Load the libraries
```{r}
library(nat)
library(neuprintr)
library(tidyverse)
library(tidygraph)
library(ggraph)
library(gridExtra)
library(paletteer)
library(reshape2)
library(combinat)
library(cowplot)
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\R\\supertypeUtils.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\visualizeConnectivityTables.R")
source("C:\\Users\\turnerevansd\\Documents\\FIBSEM\\neuprintR-notebooks\\neuprintQueryUtils.R")
options(nat.plotengine = 'rgl')
```

Connect to neuprint
```{r}
neuprint_login()
```

Function to plot connectivity matrices
```{r}
conMatPlot <- function(conMat,maxCts){
  g <- ggplot(conMat) + 
    theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
    scale_fill_gradient2(low="white", mid="#ff694a", high="#6b000d", midpoint =0.5*maxCts, limits=c(0,maxCts)) +
    geom_tile(aes(nameid.to,nameid.from,fill=ROIweight))+coord_fixed(ratio=1)
  return(g)
}
```

Function to load the FAFB data in a dataframe
```{r}
FAFBLoad <- function(region){
  #' Get data frame of FAFB data in a given region
  #' @return Returns a data frame of the FAFB data in the specified region
  #' @param region: The chosen ROI
  
  # Load the csv file
  FAFBDat = read.csv(paste0(
    '\\\\dm11\\jayaramanlab\\Kris\\Catmaid\\connectivity_matrices\\matrix_',region,'_despiked.txt')
    , header=TRUE, sep ="")
  
  # Get out the names of the neurons within the dataset and rename where appropriate
  nrons = rownames(FAFBDat)
  nrons <- gsub("D7-","Delta7-",nrons)
  nrons[which(nrons == "Ra")] <- "R4d-a"
  nrons[which(nrons == "Rb")] <- "R4d-b"
  nrons[which(nrons == "Rc")] <- "R4d-c"
  nrons[which(nrons == "Rd")] <- "R4d-d"
  nrons[which(nrons == "Re")] <- "R4d-e"
  nrons[which(nrons == "Rf")] <- "R4d-f"
  nrons[which(nrons == "Rg")] <- "R4d-g"

  # Create nameids and partnerids based off of the constituent neurons
  nameids = c()
  partnerids = c()
  for (rpt in (1:length(nrons))){
    nameids = append(nameids,nrons)
    for (r in (1:length(nrons))){
      partnerids = append(partnerids,nrons[rpt])
    }
  }
  
  # Populate a dataframe from the weight matrix
  colNames = names(FAFBDat)
  colNames <- gsub("\\.","-",colNames)
  colNames <- gsub("D7-","Delta7-",colNames)
  colNames[which(colNames == "Ra")] <- "R4d-a"
  colNames[which(colNames == "Rb")] <- "R4d-b"
  colNames[which(colNames == "Rc")] <- "R4d-c"
  colNames[which(colNames == "Rd")] <- "R4d-d"
  colNames[which(colNames == "Re")] <- "R4d-e"
  colNames[which(colNames == "Rf")] <- "R4d-f"
  colNames[which(colNames == "Rg")] <- "R4d-g"
  FAFB_df = data.frame(nameid.from = nameids,nameid.to = partnerids, ROIweight = integer(length(nrons)))
  for (i in 1:length(colNames)){
    for (j in 1:length(nrons)){
      FAFB_df$ROIweight[which(FAFB_df$nameid.to == colNames[i] & FAFB_df$nameid.from == nrons[j])] <- FAFBDat[j,i]
    }
  }
  
  return(FAFB_df)
}
  
```

Function to rename FIBSEM neurons
```{r}
FIBSEMRename <- function(nameids){
  #' Rename FIBSEM neurons to match the FIBSEM names
  #' @return Returns a renamed vector of neurons
  #' @param nameids: FIBSEM names as returned from neurprintr
  #' @param newNameids: A vector of renamed neuron names
  
  newNameids <- nameids
  newNameids <- gsub("\\([^\\)]+\\)","",newNameids)
  newNameids <- gsub("_L_","_",newNameids)
  newNameids <- gsub("_R_","_",newNameids)
  newNameids <- gsub("_a_","1_",newNameids)
  newNameids <- gsub("_b_","2_",newNameids)
  newNameids <- gsub("_","-",newNameids)
  
  glomNames <- sapply(newNameids, function(n){strsplit(n,'-')[[1]][2]}) %>% as.character()
  for (g in 1:length(glomNames)){
    if (nchar(glomNames[g]) == 2){
      if (substr(glomNames[g],1,1) == "R"){
        glomNames[g] <- paste0(substr(glomNames[g],2,2),"L")
      } else {
        glomNames[g] <- paste0(substr(glomNames[g],2,2),"R")
      }
    }
    if (nchar(glomNames[g]) == 4){
      if (substr(glomNames[g],1,1) == "R"){
        glomNames[g] <- paste0(substr(glomNames[g],2,2),"L",
                               substr(glomNames[g],4,4),"R")
      } else {
        glomNames[g] <- paste0(substr(glomNames[g],2,2),"R",
                               substr(glomNames[g],4,4),"L")
      }
    }
    if (nchar(glomNames[g]) == 6){
      if (substr(glomNames[g],1,1) == "R"){
        glomNames[g] <- paste0(substr(glomNames[g],2,2),"L",
                               substr(glomNames[g],4,4),"L",
                               substr(glomNames[g],6,6),"R")
      } else {
        glomNames[g] <- paste0(substr(glomNames[g],2,2),"R",
                               substr(glomNames[g],4,4),"R",
                               substr(glomNames[g],6,6),"L")
      }
    }
    newNameids[g] <- paste(strsplit(newNameids[g],'-')[[1]][1],glomNames[g],strsplit(newNameids[g],'-')[[1]][3],sep='-');
  }
  
  names <- sapply(newNameids, function(n) paste(strsplit(n,'-')[[1]][1],strsplit(n,'-')[[1]][2],sep='-')) %>%
    as.character() %>% unique() %>% sort()
  for (n in 1:length(names)){
    nronLocs <- which(grepl(names[n], newNameids))
    if (length(nronLocs) > 1){
      newNameids[nronLocs] <-paste0(names[n],letters[1:length(nronLocs)])
    } else {
      newNameids[nronLocs] <-names[n]
    }
  }
  
  return(newNameids)
}
```

Function to load the FIBSEM data
```{r}
FIBSEMLoad <- function(neuronList,region){
  #' Get data frame of FIBSEM data in a given region
  #' @return Returns a data frame of the FIBSEM data in the specified region
  #' @param region: The chosen ROI
  #' @param neuronList: A list of neuron names to pull
  
  # Get bodyids associated with the neurons
  bIDs <- getBodyIdsForList(neuronList)$bodyid
  bNames <- neuprint_get_meta(bIDs)$name
  
  # Pull the data for the given set of neurons
  FIBSEMDat = getConnectionTable(bIDs, "POST", region) %>%
    filter(to %in% bIDs) %>% select(name.from,from,name.to,to,ROIweight)
  
  # Fill in zeros where no values exist
  for (f in 1:length(bIDs)){
    for (t in 1:length(bIDs)){
      if (length(which(FIBSEMDat$from == bIDs[f] & FIBSEMDat$to == bIDs[t])) == 0){
        FIBSEMDat <- rbind(FIBSEMDat,
                           data.frame(name.from = bNames[f], from = bIDs[f],
                                      name.to = bNames[t], to = bIDs[t],
                                      ROIweight = 0))
      }
    }
  }
  
  # Establish unique names for each neuron that are consistent with the FAFB names
  FIBSEMDat$nameid.from <- paste(as.character(FIBSEMDat$name.from), as.character(FIBSEMDat$from), sep = "_")
  FIBSEMDat$nameid.to <- paste(as.character(FIBSEMDat$name.to), as.character(FIBSEMDat$to), sep = "_")
  
  
  oldNameIds <- c(FIBSEMDat$nameid.from,FIBSEMDat$nameid.to) %>% unique() 
  newNameIds <- FIBSEMRename(oldNameIds)
  FIBSEMDat$nameid.from <- sapply(FIBSEMDat$nameid.from,
                                  function(n){newNameIds[which(oldNameIds == n)] })
  FIBSEMDat$nameid.to <- sapply(FIBSEMDat$nameid.to,
                                  function(n){newNameIds[which(oldNameIds == n)] })
  FIBSEMDat <- FAFBSort(FIBSEMDat,region)
  
  return(FIBSEMDat %>% select(nameid.from, nameid.to, ROIweight))
}
```

Function to sort the FIBSEM data to match the FAFB data
```{r}
FAFBSort <- function(FIBSEMDat,region){
  #' Sort the names of the neurons in a FIBSEM connectivity matrix to match the FAFB data
  #' @return Returns a data frame of the FIBSEM data with the names sorted to match the FAFB data
  #' @param region: The chosen ROI
  #' @param FIBSEMDat: A FIBSEM dataframe that holds the connectivity data
  
  if (region == "PB"){
    nameOrder <- c("Delta7-1R9R8L","Delta7-2R7L","Delta7-5R4L","Delta7-6R3L","Delta7-7R2L",
                   "EPG-5L","EPG-5R","EPG-6L","EPG-6R",
                   "PEG-5L","PEG-5R","PEG-6L","PEG-6R",
                   "PEN1-5L","PEN1-5R","PEN1-6L","PEN1-6R","PEN1-7L","PEN1-7R",
                   "PEN2-5L","PEN2-5R","PEN2-6L","PEN2-6R","PEN2-7L", "PEN2-7R")
  }
  if (region == "PB-subset"){
    nameOrder <- c("EPG-5R","EPG-5L","EPG-6R","EPG-6L",
                   "Delta7-5R4L","Delta7-6R3L","Delta7-7R2L","Delta7-2R7L","Delta7-1R9R8L",
                   "PEN1-5R","PEN1-5L","PEN1-6R","PEN1-6L","PEN1-7R","PEN1-7L",
                   "PEN2-5R","PEN2-5L","PEN2-6R","PEN2-6L","PEN2-7R", "PEN2-7L",
                   "PEG-5R","PEG-5L","PEG-6R","PEG-6L")
  }
  if (region == "EB"){
    nameOrder <- c("EPG-5R","EPG-5L","EPG-6R","EPG-6L",
                   "PEN1-5R","PEN1-5L","PEN1-6R","PEN1-6L","PEN1-7R","PEN1-7L",
                   "PEN2-5R","PEN2-5L","PEN2-6R","PEN2-6L","PEN2-7R", "PEN2-7L",
                   "PEG-5R","PEG-5L","PEG-6R","PEG-6L",
                   "R4d")
  }
  if (region == "NO"){
    nameOrder <- c("PEN1-5R","PEN1-6R","PEN1-7R","PEN1-5L","PEN1-6L","PEN1-7L",
                   "PEN2-5R","PEN2-6R","PEN2-7R","PEN2-5L","PEN2-6L","PEN2-7L")
  }
  
  names <- c(FIBSEMDat$nameid.from %>% as.character(),FIBSEMDat$nameid.to %>% as.character()) %>% unique()
  nameLevels <- c()
  for (n in 1:length(nameOrder)){
    nameLevels <- c(nameLevels,
                   sort(names[which(grepl(nameOrder[n],names))]))
  }
  
  FIBSEMDat$nameid.from <- factor(FIBSEMDat$nameid.from, levels = nameLevels)
  FIBSEMDat$nameid.to <- factor(FIBSEMDat$nameid.to, levels = nameLevels)
  
  return(FIBSEMDat)
}
```

Function to downselect neurons of interest
```{r}
FIBSEMDownSel <- function(FIBSEMDat, names, nums){
  #' Remove randomly selected neurons of a given name from a dataframe
  #' @return Returns a downselected data frame of the FIBSEM data
  #' @param FIBSEMDat: A FIBSEM dataframe that holds the connectivity data
  #' @param names: A list of names of neurons to downselect
  #' @param nums: The number of neurons to keep from each named neuron group
  
  nronNames <- c(FIBSEMDat$nameid.to %>% as.character(),FIBSEMDat$nameid.from%>% as.character()) %>% unique()
  
  for (n in 1:length(names)){
    nronsNow <- nronNames[which(grepl(names[n],nronNames))]
    nronsToExclude <- sample(nronsNow,length(nronsNow)-nums[n])
    FIBSEMDat <- FIBSEMDat[which(!(FIBSEMDat$nameid.from %in% nronsToExclude) & !(FIBSEMDat$nameid.to %in% nronsToExclude)),]
  }
  return(FIBSEMDat)
}
```

Function to compare the FAFB and FIBSEM data
```{r}
datComp <- function(FAFBDat,FIBSEMDat){
  #' For a FAFB and a FIBSEM dataframe (that feature comprable neurons), find 
  #' 1) all instances where one dataset has connections that are are absent in the other
  #' 2) Where both datasets show a connection between neurons, compare the synapse counts by calculating: 
  #' (# of FAFB synapses - # of FIBSEM synapses) / (# of FAFB synapses + # of FIBSEM synapses).
  #' @return Returns a dataframe holding the metrics for comparison
  #' @param FIBSEMDat: A FIBSEM dataframe that holds the connectivity data
  #' @param names: A list of names of neurons to downselect
  #' @param nums: The number of neurons to keep from each named neuron group
  
  # Convert the dataframes to matrices
  FAFBMat <- FAFBDat %>% dcast(nameid.from~nameid.to)
  rownames(FAFBMat) <- FAFBMat$nameid.from
  FAFBMat <- FAFBMat[,2:ncol(FAFBMat)] %>% data.matrix

  FIBSEMMat <- FIBSEMDat %>% dcast(nameid.from~nameid.to)
  rownames(FIBSEMMat) <- FIBSEMMat$nameid.from
  FIBSEMMat <- FIBSEMMat[,2:ncol(FIBSEMMat)] %>% data.matrix

  # Find the sum and difference of the two matrices
  matDiff <- FAFBMat - FIBSEMMat
  matSum <- FAFBMat + FIBSEMMat

  # Calculate the two metrics
  perMat <- matrix(0L,nrow=nrow(matDiff),ncol=ncol(matDiff))
  diffMat <- matrix(0L,nrow=nrow(matDiff),ncol=ncol(matDiff))
  equalMat <- matrix(0L,nrow=nrow(matDiff),ncol=ncol(matDiff))
  for (r in 1:nrow(perMat)){
    for (c in 1:ncol(perMat)){
      if (FAFBMat[r,c] == 0){
        diffMat[r,c] <- -FIBSEMMat[r,c]
        next
      }
      if (FIBSEMMat[r,c] == 0){
        diffMat[r,c] <- FAFBMat[r,c]
        next
      }
      if (matSum[r,c] > 0)
        perMat[r,c] <- matDiff[r,c]/matSum[r,c]
      }
      if (FAFBMat[r,c] == FIBSEMMat[r,c]){
        equalMat[r,c] <- FAFBMat[r,c]
      }
  }
  
  # Name the rows and columns appropriately
  rownames(perMat) <- rownames(FAFBMat)
  rownames(diffMat) <- rownames(FAFBMat)
  rownames(equalMat) <- rownames(FAFBMat)
  colnames(perMat) <- colnames(FAFBMat)
  colnames(diffMat) <- colnames(FAFBMat)
  colnames(equalMat) <- colnames(FAFBMat)
  
  # Convert everything to a dataframe
  perMat <- melt(perMat,value.name="per",varnames=c("nameid.from","nameid.to"))
  diffMat <- melt(diffMat,value.name="diff",varnames=c("nameid.from","nameid.to"))
  equalMat <- melt(equalMat,value.name="equal",varnames=c("nameid.from","nameid.to"))
  metrics <- perMat
  metrics$diff <- diffMat$diff
  metrics$equal <- equalMat$equal
  
  return(metrics)
}
```




Get the FAFB data in the PB
```{r}
FAFB_PB_df <-FAFBLoad("PB")
FAFB_PB_df <- FAFB_PB_df %>% filter(grepl("EPG",nameid.from) | grepl("Delta7",nameid.from))

gFAFB <- conMatPlot(FAFB_PB_df,150) + ggtitle("FAFB data")

print(gFAFB)
```

Get the FIBSEM data in the PB
```{r}

neuronList = c("PEN_a\\\\\\\\(PB06a\\\\\\\\)_R5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R7",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L7",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R6",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L6",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R6",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L6",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L7R2",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L6R3",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L5R4",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L2R7",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L1")

FIBSEM_PB <- FIBSEMLoad(neuronList,"PB") %>% filter(grepl("Delta7",nameid.from) | grepl("EPG",nameid.from))

gFIBSEM <-conMatPlot(FIBSEM_PB,150)

print(gFIBSEM)

ggsave("FIBSEM_PB.pdf", plot = gFIBSEM, device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```

Downselect the FIBSEM neurons for a direct comparison
```{r}
DSneuronList <- c("EPG-6R",
                  "EPG-6L",
                  "Delta7-7R",
                  "Delta7-6R",
                  "Delta7-5R",
                  "Delta7-2R",
                  "Delta7-1R")
numNrons <-  c(2,2,1,2,2,1,1)

FIBSEM_PB_Cut <- FIBSEMDownSel(FIBSEM_PB, DSneuronList, numNrons)

gFIBSEM_DS <-conMatPlot(FIBSEM_PB_Cut,150) + ggtitle("select FIBSEM data")

print(gFAFB)
print(gFIBSEM_DS)
```

Compare the two matrices
```{r}
PBComp <- datComp(FAFB_PB_df,FIBSEM_PB_Cut)

gPer <- ggplot(PBComp) + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint =0, limits=c(-1,1)) +
  geom_tile(aes(nameid.to,nameid.from,fill=per))+coord_fixed(ratio=1,expand=FALSE) + ggtitle("diff/sum when both have synapses")

gDiff <- ggplot(PBComp) + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint =0, limits=c(-30,30)) +
  geom_tile(aes(nameid.to,nameid.from,fill=diff))+coord_fixed(ratio=1,expand=FALSE) + ggtitle("synapses for only one dataset")

print(gPer)
print(gDiff)
```

Put them all on one plot and compare
```{r}
pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\PBComp_test.pdf", width = 20, height = 20)
print(grid.arrange(gFAFB,gFIBSEM_DS,gPer,gDiff,
                   layout_matrix = rbind(c(1,2),c(3,4))))
dev.off()
```

Just plot EPG and D7 connections in the PB
```{r}
neuronList = c("EPG\\\\\\\\(PB08\\\\\\\\)_R5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R6",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L6",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L7R2",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L6R3",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L5R4",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L2R7",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L1")

FIBSEM_PB <- FIBSEMLoad(neuronList,"PB")
FIBSEM_PB <- FAFBSort(FIBSEM_PB,"PB-subset")

gFIBSEM <-conMatPlot(FIBSEM_PB,60) +
  geom_hline(yintercept = 12.5) + geom_vline(xintercept = 12.5)

print(gFIBSEM)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\PBEPGsD7s_FIBSEM_test.pdf", width = 10, height = 10)
print(gFIBSEM)
dev.off()
```

Just plot EPG and PEN1 connections in the PB
```{r}
neuronList = c("EPG\\\\\\\\(PB08\\\\\\\\)_R5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R6",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R7",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L7")

FIBSEM_PB <- FIBSEMLoad(neuronList,"PB")
FIBSEM_PB <- FAFBSort(FIBSEM_PB,"PB-subset")

gFIBSEM <-conMatPlot(FIBSEM_PB,40) +
  geom_hline(yintercept = 12.5) + geom_vline(xintercept = 12.5)

print(gFIBSEM)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\PBEPGsPEN1s_FIBSEM_test.pdf", width = 5, height = 5)
print(gFIBSEM)
dev.off()
```

Just plot EPG, Delta7, PEN2, and PEG connections in the PB
```{r}
neuronList = c("EPG\\\\\\\\(PB08\\\\\\\\)_R5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R6",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L7",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R6",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L6",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L7R2",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L6R3",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L5R4",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L2R7",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L1")

FIBSEM_PB <- FIBSEMLoad(neuronList,"PB") %>% 
  filter(grepl("Delta7",nameid.from) | grepl("EPG",nameid.from)) %>%
  filter(!grepl("Delta7",nameid.to) & !grepl("EPG",nameid.to))
FIBSEM_PB <- FAFBSort(FIBSEM_PB,"PB-subset")

gFIBSEM <-conMatPlot(FIBSEM_PB,150) +
  geom_hline(yintercept = 12.5) + geom_vline(xintercept = 8.5)

print(gFIBSEM)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\PBEPGsD7sPEN2sPEGs_FIBSEM_test.pdf", width = 10, height = 10)
print(gFIBSEM)
dev.off()
```

Just plot EPG, Delta7, and PEN1 in the PB
```{r}
neuronList = c("EPG\\\\\\\\(PB08\\\\\\\\)_R5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R6",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R7",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L7",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L7R2",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L6R3",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L5R4",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L2R7",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L1")

FIBSEM_PB <- FIBSEMLoad(neuronList,"PB") %>% 
  filter(grepl("Delta7",nameid.from) | grepl("EPG",nameid.from)) %>%
  filter(!grepl("Delta7",nameid.to) & !grepl("EPG",nameid.to))
FIBSEM_PB <- FAFBSort(FIBSEM_PB,"PB-subset")

gFIBSEM <-conMatPlot(FIBSEM_PB,40) +
  geom_hline(yintercept = 12.5)

print(gFIBSEM)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\PBEPGsD7sPEN1s_FIBSEM_test.pdf", width = 10, height = 10)
print(gFIBSEM)
dev.off()
```

Compare the FAFB data to the FIBSEM data - EB
```{r}
FAFB_EB_df <-FAFBLoad("EB") %>%
  filter(nameid.to != "GE-r1" & nameid.from != "GE-r1") %>%
  filter(!grepl("R4d",nameid.to) & !grepl("R4d",nameid.from))
FAFB_EB_df <-FAFBSort(FAFB_EB_df,"EB")

gFAFB <- conMatPlot(FAFB_EB_df,150) + geom_hline(yintercept = 10.5) + geom_hline(yintercept = 18.5) + geom_hline(yintercept = 26.5) + geom_hline(yintercept = 30.5) + 
  geom_vline(xintercept = 10.5) + geom_vline(xintercept = 18.5) + geom_vline(xintercept = 26.5) + geom_vline(xintercept = 30.5) +
  ggtitle("FAFB data")

print(gFAFB)

ggsave("FAFB_EB_test.pdf", plot = gFAFB, device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
neuronList = c("PEN_a\\\\\\\\(PB06a\\\\\\\\)_R5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R7",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L7",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R6",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L6",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R6",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L6")#"R4d"

FIBSEM_EB <- FIBSEMLoad(neuronList,"EB")

gFIBSEM <-conMatPlot(FIBSEM_EB,175)

print(gFIBSEM)

ggsave("FIBSEM_EB_test.pdf", plot = gFIBSEM, device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```

Downselect the FIBSEM neurons for a direct comparison
```{r}
DSneuronList <- c("EPG-6R",
                  "EPG-6L")
numNrons <-  c(2,2)#,7)

FIBSEM_EB_Cut <- FIBSEMDownSel(FIBSEM_EB, DSneuronList, numNrons)

gFIBSEM_DS <-conMatPlot(FIBSEM_EB_Cut,150) + ggtitle("select FIBSEM data") +
  geom_hline(yintercept = 10.5) + geom_hline(yintercept = 18.5) + geom_hline(yintercept = 26.5) + geom_hline(yintercept = 30.5) + 
  geom_vline(xintercept = 10.5) + geom_vline(xintercept = 18.5) + geom_vline(xintercept = 26.5) + geom_vline(xintercept = 30.5)

print(gFAFB)
print(gFIBSEM_DS)
```

Compare the two matrices
```{r}
EBComp <- datComp(FAFB_EB_df %>% 
                    filter(!grepl("R4d",nameid.from) & !grepl("R4d",nameid.to)),
                  FIBSEM_EB_Cut)

gPer <- ggplot(EBComp) + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint =0, limits=c(-1,1)) +
  geom_tile(aes(nameid.to,nameid.from,fill=per))+coord_fixed(ratio=1,expand=FALSE) + ggtitle("diff/sum when both have synapses") +
  geom_hline(yintercept = 10.5) + geom_hline(yintercept = 18.5) + geom_hline(yintercept = 26.5) + geom_hline(yintercept = 30.5) + 
  geom_vline(xintercept = 10.5) + geom_vline(xintercept = 18.5) + geom_vline(xintercept = 26.5) + geom_vline(xintercept = 30.5)

gDiff <- ggplot(EBComp) + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint =0, limits=c(-45,45)) +
  geom_tile(aes(nameid.to,nameid.from,fill=diff))+coord_fixed(ratio=1,expand=FALSE) + ggtitle("synapses for only one dataset") +
  geom_hline(yintercept = 10.5) + geom_hline(yintercept = 18.5) + geom_hline(yintercept = 26.5) + geom_hline(yintercept = 30.5) + 
  geom_vline(xintercept = 10.5) + geom_vline(xintercept = 18.5) + geom_vline(xintercept = 26.5) + geom_vline(xintercept = 30.5)

print(gPer)
print(gDiff)
```

Put them all on one plot and compare
```{r}
pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\EBComp_test.pdf", width = 20, height = 20)
print(grid.arrange(gFAFB,gFIBSEM_DS,gPer,gDiff,
                   layout_matrix = rbind(c(1,2),c(3,4))))
dev.off()
```



Just plot EPG to EPG connections in the EB
```{r}
neuronList = c("EPG\\\\\\\\(PB08\\\\\\\\)_R5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R6",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L6")

FIBSEM_EB <- FIBSEMLoad(neuronList,"EB")

gFIBSEM <-conMatPlot(FIBSEM_EB,100) +
  geom_hline(yintercept = 6.5) + geom_hline(yintercept = 9.5) + 
  geom_vline(xintercept = 6.5) + geom_vline(xintercept = 9.5)

print(gFIBSEM)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\EBEPGs_FIBSEM_test.pdf", width = 5, height = 5)
print(gFIBSEM)
dev.off()
```

Just plot EPG and PEN1 connections in the EB
```{r}
neuronList = c("EPG\\\\\\\\(PB08\\\\\\\\)_R5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R6",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R7",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L7")

FIBSEM_EB <- FIBSEMLoad(neuronList,"EB")

gFIBSEM <-conMatPlot(FIBSEM_EB,120) +
  geom_hline(yintercept = 12.5) + 
  geom_vline(xintercept = 12.5)

print(gFIBSEM)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\EBEPGsPEN1s_FIBSEM_test.pdf", width = 5, height = 5)
print(gFIBSEM)
dev.off()
```

Just plot EPG, PEN2, and PEG connections in the EB
```{r}
neuronList = c("EPG\\\\\\\\(PB08\\\\\\\\)_R5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R6",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L7",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R6",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L6")

FIBSEM_EB <- FIBSEMLoad(neuronList,"EB")

gFIBSEM <-conMatPlot(FIBSEM_EB,100) +
  geom_tile(aes(nameid.to,nameid.from,fill=ROIweight))+coord_fixed(ratio=1) +
  geom_hline(yintercept = 12.5) + geom_hline(yintercept = 20.5) +
  geom_vline(xintercept = 12.5) + geom_vline(xintercept = 20.5)

print(gFIBSEM)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\EBEPGsPEN2sPEGs_FIBSEM_test.pdf", width = 5, height = 5)
print(gFIBSEM)
dev.off()
```

Compare the FAFB data to the FIBSEM data - NO
```{r}
FAFB_NO_df <-FAFBLoad("NO") %>% filter(nameid.from != "NO-LAL-G" & nameid.to != "NO-LAL-G")
FAFB_NO_df <- FAFBSort(FAFB_NO_df,"NO")

gFAFB <- conMatPlot(FAFB_NO_df,50) +
  ggtitle("FAFB data")  +
  geom_hline(yintercept = 8.5) + geom_vline(xintercept = 8.5) +
  geom_hline(yintercept = 16.5) + geom_vline(xintercept = 16.5)

ggsave("FAFB_NO.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)

print(gFAFB)
```

```{r}
neuronList = c("PEN_a\\\\\\\\(PB06a\\\\\\\\)_R5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R7",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L7")

FIBSEM_NO <- FIBSEMLoad(neuronList,"NO") %>% filter(!is.na(nameid.from) & !is.na(nameid.to))

gFIBSEM <-conMatPlot(FIBSEM_NO,50) +
  geom_hline(yintercept = 8.5) + geom_vline(xintercept = 8.5) + 
  geom_hline(yintercept = 16.5) + geom_vline(xintercept = 16.5)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\NOPENs_FIBSEM.pdf", width = 5, height = 5)
print(gFIBSEM)

gFIBSEM <- gFIBSEM + ggtitle("FIBSEM data") +
  geom_hline(yintercept = 8.5) + geom_vline(xintercept = 8.5) + 
  geom_hline(yintercept = 16.5) + geom_vline(xintercept = 16.5)

ggsave("FIBSEM_NO.pdf", plot = last_plot(), device='pdf', 
       path = "C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\",
       scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```

Compare the two matrices
```{r}
NOComp <- datComp(FAFB_NO_df,FIBSEM_NO)

gPer <- ggplot(NOComp) + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint =0, limits=c(-1,1)) +
  geom_tile(aes(nameid.to,nameid.from,fill=per))+coord_fixed(ratio=1,expand=FALSE) + ggtitle("diff/sum when both have synapses") +
  geom_hline(yintercept = 8.5) + geom_vline(xintercept = 8.5) + 
  geom_hline(yintercept = 16.5) + geom_vline(xintercept = 16.5)

gDiff <- ggplot(NOComp) + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint =0, limits=c(-45,45)) +
  geom_tile(aes(nameid.to,nameid.from,fill=diff))+coord_fixed(ratio=1,expand=FALSE) + ggtitle("synapses for only one dataset") +
  geom_hline(yintercept = 8.5) + geom_vline(xintercept = 8.5) + 
  geom_hline(yintercept = 16.5) + geom_vline(xintercept = 16.5)

print(gPer)
print(gDiff)
```

Put them all on one plot and compare
```{r}
pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\NOComp_test.pdf", width = 20, height = 20)
print(grid.arrange(gFAFB,gFIBSEM,gPer,gDiff,
                   layout_matrix = rbind(c(1,2),c(3,4))))
dev.off()
```

Just plot PEN1 connections in the NO
```{r}
neuronList = c("PEN_a\\\\\\\\(PB06a\\\\\\\\)_R5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R7",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L7")

FIBSEM_NO <- FIBSEMLoad(neuronList,"NO")

gFIBSEM <-conMatPlot(FIBSEM_NO,50) +
  geom_hline(yintercept = 4.5) + 
  geom_vline(xintercept = 4.5)

print(gFIBSEM)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\NOPEN1s_FIBSEM.pdf", width = 5, height = 5)
print(gFIBSEM)
dev.off()
```



Function to find the names and numbers 
```{r}
namesAndNums <- function(df){
  
  names <- c(df$nameid.from %>% as.character(),df$nameid.to %>% as.character()) %>% unique()
  uniqueNames <- c(names[which(substr(names,nchar(names),nchar(names))=="L")],
                   names[which(substr(names,nchar(names),nchar(names))=="R")])
  otherNames <- names[which(substr(names,nchar(names),nchar(names))!="L" &
                              substr(names,nchar(names),nchar(names)) !="R")]
  otherNames <- substr(otherNames,1,nchar(otherNames)-1) %>% unique()
  allNames <- c(uniqueNames,otherNames) %>% sort()
  nameNums <- sapply(allNames, function(n){length(which(grepl(n,names)))}) %>% as.numeric()
  nameMatch <- data.frame(name=allNames, num=nameNums)
  
  return(nameMatch)
}
```

Function to return ...
```{r}
permuteComp <- function(FAFBDat, FIBSEMDat,region,maxIter){
  # Find the neuron names and the number of each name from the FAFB data
  FAFBNames <- c(FAFBDat$nameid.from,FAFBDat$nameid.to) %>% unique()
  uniqueNames <- c(FAFBNames[which(substr(FAFBNames,nchar(FAFBNames),nchar(FAFBNames))=="L")],
                 FAFBNames[which(substr(FAFBNames,nchar(FAFBNames),nchar(FAFBNames))=="R")])
  otherNames <- FAFBNames[which(substr(FAFBNames,nchar(FAFBNames),nchar(FAFBNames))!="L" &
                              substr(FAFBNames,nchar(FAFBNames),nchar(FAFBNames)) !="R")]
  otherNames <- substr(otherNames,1,nchar(otherNames)-1) %>% unique()
  allNames <- c(uniqueNames,otherNames)
  nameNums <- sapply(allNames, function(n){length(which(grepl(n,FAFBNames)))}) %>% as.numeric()
  nameMatch <- data.frame(name=allNames, num=nameNums)
  
  # Find the neuron names and the number of each name for each dataset
  nameMatch <- namesAndNums(FAFBDat)
  colnames(nameMatch) <- c("name","num_FAFB")
  nameMatch$num_FIBSEM <- namesAndNums(FIBSEMDat)$num
  nameMatch <- nameMatch %>% mutate(diff = num_FIBSEM - num_FAFB)
  nameMatch <- nameMatch[which(nameMatch$num_FIBSEM != 1),]
  nameMatch <- nameMatch %>% mutate(possibleCombs = factorial(num_FIBSEM)/factorial(num_FIBSEM-num_FAFB))
  totalCombs <- prod(nameMatch$possibleCombs)
  
  allMetrics <- data.frame(nameid.from <- c(), nameid.to <- c(),
                           per <- c(), diff <- c(), equal <- c(),
                           iteration <- c())
  
  FAFBDat <- FAFBSort(FAFBDat,region)
  if (totalCombs > maxIter){
    for (it in 1:maxIter){
      # Downselect the FIBSEM data
      FIBSEMDat_Cut <- FIBSEMDownSel(FIBSEMDat, nameMatch$name, nameMatch$num_FAFB)
      
      # Convert data to a matrix
      FIBSEMMat <- FIBSEMDat_Cut %>% dcast(nameid.from~nameid.to)
      rownames(FIBSEMMat) <- FIBSEMMat$nameid.from
      FIBSEMMat <- FIBSEMMat[,2:ncol(FIBSEMMat)] %>% data.matrix
      
      # Shuffle the rows of the matrix for the appropraite rows/columns
      FIBSEMMatShuf <- FIBSEMMat
      for (n in 1:nrow(nameMatch)){
        rows <- which(grepl(nameMatch$name[n],rownames(FIBSEMMat)))
        if (length(rows) > 1){
          FIBSEMMatShuf[sample(rows),]=FIBSEMMatShuf[rows,] %>% as.numeric()
        }
        cols <- which(grepl(nameMatch$name[n],colnames(FIBSEMMat)))
        if (length(cols) > 1){
          FIBSEMMatShuf[,sample(cols)]=FIBSEMMatShuf[,cols] %>% as.numeric()
        }
      }
      
      # Convert the data back to a dataframe
      FIBSEMDat_Cut_Shuf <- melt(FIBSEMMatShuf,value.name="ROIweight",varnames=c("nameid.from","nameid.to"))
      FIBSEMDat_Cut_Shuf <- FAFBSort(FIBSEMDat_Cut_Shuf,region)
      
      # Calculate the metrics
      metrics <- datComp(FAFBDat,FIBSEMDat_Cut_Shuf)
      metrics$iteration <- it
      
      allMetrics <- rbind(allMetrics,metrics)
    }
  } else {
    # Get the names of all of the FIBSEM neurons
    FIBSEMNames <- c(FIBSEMDat$nameid.from %>% as.character(),FIBSEMDat$nameid.to %>% as.character()) %>% unique()
    
    # Find the possible permuations for each name
    members <- list()
    for (n in 1:length(nameMatch$name)){
      posCombs <- combn(FIBSEMNames[which(grepl(nameMatch$name[n],FIBSEMNames))],nameMatch$num_FAFB)
      if (is.null(ncol(posCombs))){
        members[[n]] <- permn(posCombs)
      } else {
        permList <- list()
        for (c in 1:ncol(posCombs)){
          permList <- c(permList,permn(posCombs[,c]))
        }
        members[[n]] <- permList
      }
    }
    nameMatch$members <- members
    
    # Convert data to a matrix
    FIBSEMMat <- FIBSEMDat %>% dcast(nameid.from~nameid.to)
    rownames(FIBSEMMat) <- FIBSEMMat$nameid.from
    FIBSEMMat <- FIBSEMMat[,2:ncol(FIBSEMMat)] %>% data.matrix
    rowNamesOrig <- rownames(FIBSEMMat)
    colNamesOrig <- colnames(FIBSEMMat)
    
    # Step through the permutations
    for (it in 1:totalCombs){
      
      # Make a new FIBSEM data matrix
      FIBSEMMatPerm <- FIBSEMMat
      
      # Initialize new row and column names
      rowNamesPerm <- rowNamesOrig
      colNamesPerm <- colNamesOrig
      
      # Modify the row and column names according to the current permutation 
      fact <- 1
      order <- c()
      step <- 1
      while(step <= nrow(nameMatch)){
        orderNow <- nameMatch$members[[step]][1+((ceiling(it/fact)-1) %% nameMatch$num_FAFB[step])][[1]]
        rowIds <- which(grepl(nameMatch$name[step],rowNamesPerm))
        colIds <- which(grepl(nameMatch$name[step],colNamesPerm))
        if (length(rowIds)>0) {
          rowNamesPerm[rowIds] <- orderNow
        }
        if (length(colIds)>0) {
          colNamesPerm[colIds] <- orderNow
        }
        fact <- fact * nameMatch$num_FAFB[step]
        step <- step+1
      }
      
      # Assign the new row and column names to the matrix
      rownames(FIBSEMMatPerm) <- rowNamesPerm
      colnames(FIBSEMMatPerm) <- colNamesPerm
      
      # Convert the data back to a dataframe
      FIBSEMDat_Perm <- melt(FIBSEMMatPerm,value.name="ROIweight",varnames=c("nameid.from","nameid.to"))
      FIBSEMDat_Perm <- FAFBSort(FIBSEMDat_Perm,region)
      
      # Calculate the metrics
      metrics <- datComp(FAFBDat,FIBSEMDat_Perm)
      metrics$iteration <- it
      
      allMetrics <- rbind(allMetrics,metrics)
    }
  }
  return(allMetrics)
}
```

Find the difference in connections between neurons in the PB
```{r}

# Pull the FAFB data
FAFB_PB_df <-FAFBLoad("PB")
FAFB_PB_df <- FAFB_PB_df %>% filter(grepl("EPG",nameid.from) | grepl("Delta7",nameid.from))

# Pull the FIBSEM data
neuronList = c("PEN_a\\\\\\\\(PB06a\\\\\\\\)_R5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R7",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L7",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R6",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L6",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R6",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L6",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L7R2",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L6R3",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L5R4",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L2R7",
              "Delta7\\\\\\\\(PB15\\\\\\\\)_L1")
FIBSEM_PB <- FIBSEMLoad(neuronList,"PB") %>% filter(grepl("Delta7",nameid.from) | grepl("EPG",nameid.from))

allMetrics_PB <- permuteComp(FAFB_PB_df, FIBSEM_PB,"PB",200)
```

Find the difference in connections between neurons in the EB
```{r}

# Pull the FAFB data
FAFB_EB_df <-FAFBLoad("EB")
FAFB_EB_df <- FAFB_EB_df %>% filter(!grepl("GE-r1",nameid.from) & !grepl("GE-r1",nameid.to)) %>%
  filter(!grepl("R4d",nameid.from) & !grepl("R4d",nameid.to))

# Pull the FIBSEM data
neuronList = c("PEN_a\\\\\\\\(PB06a\\\\\\\\)_R5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R7",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L7",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L5",
              "EPG\\\\\\\\(PB08\\\\\\\\)_R6",
              "EPG\\\\\\\\(PB08\\\\\\\\)_L6",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L5",
              "PEG\\\\\\\\(PB07\\\\\\\\)_R6",
              "PEG\\\\\\\\(PB07\\\\\\\\)_L6")
FIBSEM_EB <- FIBSEMLoad(neuronList,"EB")

allMetrics_EB <- permuteComp(FAFB_EB_df, FIBSEM_EB,"EB",200)

				  
## Need to find 0 values
```

Find the difference in connections between neurons in the NO
```{r}

# Pull the FAFB data
FAFB_NO_df <-FAFBLoad("NO")
FAFB_NO_df <- FAFB_NO_df %>% filter(!grepl("NO-LAL-G",nameid.from) & !grepl("NO-LAL-G",nameid.to))


# Pull the FIBSEM data
neuronList = c("PEN_a\\\\\\\\(PB06a\\\\\\\\)_R5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R7",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L7")
FIBSEM_NO <- FIBSEMLoad(neuronList,"NO")

allMetrics_NO <- permuteComp(FAFB_NO_df, FIBSEM_NO,"NO",200)

```

Plot the different metrics
```{r}

# Plot the differences
allDiffs <- data.frame(d = allMetrics_EB %>% filter(diff != 0) %>% select(diff),
                       region = "EB")
allDiffs <- rbind(allDiffs,
                  data.frame(d = allMetrics_PB %>% filter(diff != 0) %>% select(diff),
                             region = "PB"))
allDiffs <- rbind(allDiffs,
                  data.frame(d = allMetrics_NO %>% filter(diff != 0) %>% select(diff),
                             region = "NO"))
allDiffs$region <- factor(allDiffs$region, levels = c("PB","EB","NO"))
diffPlot <- ggplot(allDiffs,aes(x=region,y=diff,fill=region)) + geom_violin() +
  theme_minimal_hgrid() + ylab('FIBSEM cts       FAFB cts') +
  theme(axis.title = element_text(size = 8), 
      axis.text = element_text(size = 6),
      legend.text = element_text(size = 6),
      legend.title = element_text(size = 8))

# Plot the ratios
allPers <- data.frame(per = allMetrics_EB %>% filter(per != 0 | equal !=0 ) %>% select(per),
                       region = "EB")
allPers <- rbind(allPers,
                  data.frame(per = allMetrics_PB %>% filter(per != 0 | equal !=0 ) %>% select(per),
                             region = "PB"))
allPers <- rbind(allPers,
                  data.frame(per = allMetrics_NO %>% filter(per != 0 | equal !=0 ) %>% select(per),
                             region = "NO"))
allPers$region <- factor(allPers$region, levels = c("PB","EB","NO"))
perPlot <- ggplot(allPers,aes(x=region,y=per,fill=region)) + geom_violin() +
  theme_minimal_hgrid() + ylab('(FAFB cts − FIBSEM cts)/(total cts)') + ylim(-1,1) +
  theme(axis.title = element_text(size = 8), 
      axis.text = element_text(size = 6),
      legend.text = element_text(size = 6),
      legend.title = element_text(size = 8))

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\FAFBVsFIBSEMComp.pdf", width = unit(8,"in"), height = unit(11,"in"))
plot_grid(gFAFB,gFIBSEM,gPer,gDiff,perPlot, diffPlot, 
          labels = c('A','B','C','D','E','F'), label_size = 8,
          ncol=2,
          rel_heights = c(1,1,0.5))
dev.off()

```



















All PEN FIBSEM data - NO
```{r}
neuronList = c("PEN_a\\\\\\\\(PB06a\\\\\\\\)_R5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L5",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L6",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_R7",
              "PEN_a\\\\\\\\(PB06a\\\\\\\\)_L7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L5",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L6",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_R7",
              "PEN_b\\\\\\\\(PB06b\\\\\\\\)_L7")

FIBSEM_NO = getConnectionTable_forSubset(getBodyIdsForList(neuronList)$bodyid, getBodyIdsForList(neuronList)$bodyid, "NO")
FIBSEM_NO$nameid.from = paste(as.character(FIBSEM_NO$name.from), as.character(FIBSEM_NO$from), sep = "_")
FIBSEM_NO$nameid.to = paste(as.character(FIBSEM_NO$name.to), as.character(FIBSEM_NO$to), sep = "_")

FIBSEMNames <- FIBSEM_NO$nameid.from %>% as.character() %>% append(FIBSEM_NO$nameid.to %>% as.character()) %>% unique() %>% sort()
newFIBSEMNames <- c("PEN1-5R", "PEN1-6Ra","PEN1-6Rb","PEN1-7R","PEN1-5L", "PEN1-6La","PEN1-6Lb","PEN1-7L",
                    "PEN2-5R", "PEN2-6Ra","PEN2-6Rb","PEN2-7R","PEN2-5L", "PEN2-6La","PEN2-6Lb","PEN2-7L")
newLevels <- c("PEN1-5R","PEN1-6Ra","PEN1-6Rb","PEN1-7R","PEN1-5L","PEN1-6La","PEN1-6Lb","PEN1-7L",
               "PEN2-5R","PEN2-6Ra","PEN2-6Rb","PEN2-7R","PEN2-5L","PEN2-6La","PEN2-6Lb","PEN2-7L") %>% as.factor()
nameLU_FIBSEM <- data.frame(oldName = FIBSEMNames, newName = newFIBSEMNames)
FIBSEM_NO$nameid.from <- sapply(FIBSEM_NO$nameid.from, function(x) nameLU_FIBSEM$newName[match(as.character(x), nameLU_FIBSEM$oldName)])
FIBSEM_NO$nameid.from <- factor(FIBSEM_NO$nameid.from, levels = newLevels)
FIBSEM_NO$nameid.to <- sapply(FIBSEM_NO$nameid.to, function(x) nameLU_FIBSEM$newName[match(as.character(x), nameLU_FIBSEM$oldName)])
FIBSEM_NO$nameid.to <- factor(FIBSEM_NO$nameid.to, levels = newLevels)

gFIBSEM <- ggplot(FIBSEM_NO) + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient2(low="white", mid="#ff694a", high="#6b000d", midpoint =30, limits=c(0,50)) +
  geom_tile(aes(nameid.to,nameid.from,fill=ROIweight))+coord_fixed(ratio=1) +
  geom_hline(yintercept = 8.5) + geom_vline(xintercept = 8.5)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\NOPENs_FIBSEM.pdf", width = 5, height = 5)
print(gFIBSEM)
dev.off()
```


EPG and D7 connections in PB
```{r}
neuronList <- c("EPG","Delta7")
FIBSEM_EPGD7PB <- getConnectionTable_forSubset(getBodyIdsForList(neuronList)$bodyid, getBodyIdsForList(neuronList)$bodyid, "PB")
FIBSEM_EPGD7PB <- FIBSEM_EPGD7PB %>% filter(type.to != "EPGt" & type.from != "EPGt")
conTabPlt <- plotConnectivityMatrix(FIBSEM_EPGD7PB, byGroup = "id", connectionMeasure="ROIweight")
conTabPlt <- structureMatrixPlotByType(conTabPlt)
pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\EPGD7PB_Connectivity.pdf", width = 5, height = 4)
print(conTabPlt)
dev.off()
```

hyper local recurrence in EB of EPGs
```{r}
neuronList <- c("EPG")
FIBSEM_EPGEB <- getConnectionTable_forSubset(getBodyIdsForList(neuronList)$bodyid, getBodyIdsForList(neuronList)$bodyid, "EB")
FIBSEM_EPGEB <- FIBSEM_EPGEB %>% filter(type.to != "EPGt" & type.from != "EPGt")
conTabPlt <- plotConnectivityMatrix(FIBSEM_EPGEB, byGroup = "id", connectionMeasure="ROIweight")
conTabPlt <- structureMatrixPlotByType(conTabPlt)
pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\EPGEB_Connectivity.pdf", width = 5, height = 4)
print(conTabPlt)
dev.off()
```

EPG + D7 to PEN1/2 in PB
```{r}
neuronList_Pre <- c("EPG","Delta7")
neuronList_Post <- c("PEN_a","PEN_b")
FIBSEM_EPGD7ToPENsPB <- getConnectionTable_forSubset(getBodyIdsForList(neuronList_Pre)$bodyid, getBodyIdsForList(neuronList_Post)$bodyid, "PB")
FIBSEM_EPGD7ToPENsPB <- FIBSEM_EPGD7ToPENsPB %>% filter(type.to != "EPGt" & type.from != "EPGt")
conTabPlt <- plotConnectivityMatrix(FIBSEM_EPGD7ToPENsPB, byGroup = "id", connectionMeasure="ROIweight")
conTabPlt <- structureMatrixPlotByType(conTabPlt)
pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\EPGD7ToPENPB_Connectivity.pdf", width = 4, height = 5)
print(conTabPlt)
dev.off()
```
 
EPG <-> PEN1/2 in EB
```{r}
neuronList <- c("EPG","PEN")
FIBSEM_EPGPENsEB <- getConnectionTable_forSubset(getBodyIdsForList(neuronList)$bodyid, getBodyIdsForList(neuronList)$bodyid, "EB")
FIBSEM_EPGPENsEB <- FIBSEM_EPGPENsEB %>% filter(type.to != "EPGt" & type.from != "EPGt")
conTabPlt <- plotConnectivityMatrix(FIBSEM_EPGPENsEB, byGroup = "id", connectionMeasure="ROIweight")
conTabPlt <- structureMatrixPlotByType(conTabPlt)
pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\EPGPENsEB_Connectivity.pdf", width = 5, height = 4)
print(conTabPlt)
dev.off()
```
 
Ring neuron connectivity in the ring
```{r}
neuronList <- c("EPG","R4m")
FIBSEM_EPGR4mEB <- getConnectionTable_forSubset(getBodyIdsForList(neuronList)$bodyid, getBodyIdsForList(neuronList)$bodyid, "EB")
FIBSEM_EPGR4mEB <- FIBSEM_EPGR4mEB %>% filter(type.to != "EPGt" & type.from != "EPGt")
conTabPlt <- plotConnectivityMatrix(FIBSEM_EPGR4mEB, byGroup = "id", connectionMeasure="ROIweight")
conTabPlt <- structureMatrixPlotByType(conTabPlt)
pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\EPGRingEB_Connectivity.pdf", width = 5, height = 4)
print(conTabPlt)
dev.off()
``` 

PEN1 -> EPG synapse counts in EB
```{r}
neuronList_Pre <- c("PEN_a")
neuronList_Post <- c("EPG")
FIBSEM_PEN1ToEPGEB <- getConnectionTable_forSubset(getBodyIdsForList(neuronList_Pre)$bodyid, getBodyIdsForList(neuronList_Post)$bodyid, "EB")
FIBSEM_PEN1ToEPGEB <- FIBSEM_PEN1ToEPGEB %>% filter(type.to != "EPGt" & type.from != "EPGt")
conTabPlt_PEN1 <- plotConnectivityMatrix(FIBSEM_PEN1ToEPGEB, byGroup = "id", connectionMeasure="ROIweight")
print(conTabPlt_PEN1)

FIBSEM_PEN1ToEPGEB <- FIBSEM_PEN1ToEPGEB %>% mutate(nameid.from = paste(name.from,from,sep='_'),
                                                    nameid.to = paste(name.to,to,sep='_'))
g_totSynsPEN1_L <- ggplot(FIBSEM_PENaToEPGEB %>% filter(grepl("_L",nameid.from))) +
  geom_bar(aes(y=ROIweight, x=nameid.to, fill = nameid.from),stat="identity") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(g_totSynsPEN1_L)
g_totSynsPEN1_R <- ggplot(FIBSEM_PENaToEPGEB %>% filter(grepl("_R",nameid.from))) +
  geom_bar(aes(y=ROIweight, x=nameid.to, fill = nameid.from),stat="identity") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(g_totSynsPEN1_R)

neuronList_Pre <- c("PEN_b")
neuronList_Post <- c("EPG")
FIBSEM_PEN2ToEPGEB <- getConnectionTable_forSubset(getBodyIdsForList(neuronList_Pre)$bodyid, getBodyIdsForList(neuronList_Post)$bodyid, "EB")
FIBSEM_PEN2ToEPGEB <- FIBSEM_PEN2ToEPGEB %>% filter(type.to != "EPGt" & type.from != "EPGt")
conTabPlt_PEN2 <- plotConnectivityMatrix(FIBSEM_PEN2ToEPGEB, byGroup = "id", connectionMeasure="ROIweight")
print(conTabPlt_PEN2)

FIBSEM_PEN2ToEPGEB <- FIBSEM_PEN2ToEPGEB %>% mutate(nameid.from = paste(name.from,from,sep='_'),
                                                    nameid.to = paste(name.to,to,sep='_'))
g_totSynsPEN2_L <- ggplot(FIBSEM_PEN2ToEPGEB %>% filter(grepl("_L",nameid.from))) +
  geom_bar(aes(y=ROIweight, x=nameid.to, fill = nameid.from),stat="identity") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(g_totSynsPEN2_L)
g_totSynsPEN2_R <- ggplot(FIBSEM_PEN2ToEPGEB %>% filter(grepl("_R",nameid.from))) +
  geom_bar(aes(y=ROIweight, x=nameid.to, fill = nameid.from),stat="identity") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(g_totSynsPEN2_R)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\PENsEB_SynNums.pdf", width = 25, height = 10)
print(grid.arrange(conTabPlt_PEN1,g_totSynsPEN1_L,g_totSynsPEN1_R,
                   conTabPlt_PEN2,g_totSynsPEN2_L,g_totSynsPEN2_R,
                   layout_matrix=rbind(c(1,2,3),c(4,5,6))))
dev.off()
```

Quantify ring synapses around the ring
```{r}
EPGOrder <- c("R5","L4","R6","L3","R7","L2","R8","L1","R1","L8","R2","L7","R3","L6","R4","L5")

neuronList_Pre <- c("R4m")
neuronList_Post <- c("EPG")
FIBSEM_R4mToEPGEB <- getConnectionTable_forSubset(getBodyIdsForList(neuronList_Pre)$bodyid, getBodyIdsForList(neuronList_Post)$bodyid, "EB")
FIBSEM_R4mToEPGEB <- FIBSEM_R4mToEPGEB %>% filter(type.to != "EPGt" & type.from != "EPGt")

FIBSEM_R4mToEPGEB <- FIBSEM_R4mToEPGEB %>% mutate(nameid.from = paste(name.from,from,sep='_'),
                                                    nameid.to = paste(name.to,to,sep='_'))
preNames <- FIBSEM_R4mToEPGEB$nameid.from %>% unique() %>% as.character()
preNames_R <- preNames[which(grepl("_R_",preNames))]
preNames_L <- preNames[which(grepl("_L_",preNames))]
postNames <- FIBSEM_R4mToEPGEB$nameid.to %>% unique() %>% as.character()
postNames_sorted <- c()
for (o in 1:length(EPGOrder)){
  postNames_sorted <- append(postNames_sorted,postNames[which(grepl(EPGOrder[o],postNames))])
}
FIBSEM_R4mToEPGEB$nameid.to <- factor(FIBSEM_R4mToEPGEB$nameid.to, levels = as.factor(postNames_sorted))
FIBSEM_R4mToEPGEB$RNLoc <- "R"
FIBSEM_R4mToEPGEB[which(FIBSEM_R4mToEPGEB$nameid.from %in% preNames_L),]$RNLoc <- "L"

conTabPlt <- plotConnectivityMatrix(FIBSEM_R4mToEPGEB, byGroup = "id", connectionMeasure="ROIweight")
print(conTabPlt)

g_R4Profile <- ggplot()
for (pn in 1:length(preNames_R)){
  g_R4Profile <- g_R4Profile + geom_line(data = FIBSEM_R4mToEPGEB %>% filter(nameid.from == preNames_R[pn]),aes(x=as.factor(nameid.to),y=ROIweight,group=1,color=RNLoc))
}
for (pn in 1:length(preNames_L)){
  g_R4Profile <- g_R4Profile + geom_line(data = FIBSEM_R4mToEPGEB %>% filter(nameid.from == preNames_L[pn]),aes(x=as.factor(nameid.to),y=ROIweight,group=1,color=RNLoc))
}
g_R4Profile <- g_R4Profile + theme_classic() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(g_R4Profile)

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\RNsToEPGsEB_SynNums.pdf", width = 10, height = 10)
print(grid.arrange(conTabPlt,g_R4Profile,ncol=1))
dev.off()
```
 
Number of EPGs, PEGs, PENs per glom
```{r}
gloms <- c("L9","L8","L7","L6","L5","L4","L3","L2","L1",
           "R1","R2","R3","R4","R5","R6","R7","R8","R9")

nrons <- c("EPG","PEN_a","PEN_b","PEG")
g_list <- list()
for (n in 1:length(nrons)){
  nronNames <- paste0(getBodyIdsForList(nrons[n])$name, getBodyIdsForList(nrons[n])$bodyid, sep='_') %>% unique
  glomCts <- vector(mode="numeric", length=length(gloms))
  for (g in 1:length(gloms)){
    glomCts[g] <- length(which(grepl(gloms[g],nronNames)))
  }
  glomDF <- data.frame(gloms = factor(gloms,levels=as.factor(gloms)), counts = glomCts)
  g_list[[n]] <- ggplot(glomDF) + geom_bar(aes(x=gloms, y=counts),stat="identity") + ggtitle(paste(nrons[n],"neurons per glomerulus",sep='-')) +
    theme_classic() + ylim(0,4)
}

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\GlomCounts.pdf", width = 10, height = 5)
print(grid.arrange(grobs=g_list,layout_matrix=rbind(c(1,2),c(4,3))))
dev.off()

```

 Entire weight matrix (of given types) from FIBSEM dataset in EB,PB,NO
```{r}
nrons <- c("EPG","PEN","PEG","Delta7","R4m")

FIBSEM_PB <- getConnectionTable_forSubset(getBodyIdsForList(nrons)$bodyid, getBodyIdsForList(nrons)$bodyid, "PB")
FIBSEM_PB <- FIBSEM_PB %>% filter(type.to != "EPGt" & type.from != "EPGt")
conTabPlt_PB <- plotConnectivityMatrix(FIBSEM_PB, byGroup = "id", connectionMeasure="ROIweight")
conTabPlt_PB <- structureMatrixPlotByType(conTabPlt_PB) + ggtitle("PB connectivity")

FIBSEM_EB <- getConnectionTable_forSubset(getBodyIdsForList(nrons)$bodyid, getBodyIdsForList(nrons)$bodyid, "EB")
FIBSEM_EB <- FIBSEM_EB %>% filter(type.to != "EPGt" & type.from != "EPGt")
conTabPlt_EB <- plotConnectivityMatrix(FIBSEM_EB, byGroup = "id", connectionMeasure="ROIweight")
conTabPlt_EB <- structureMatrixPlotByType(conTabPlt_EB) + ggtitle("EB connectivity")

FIBSEM_NO <- getConnectionTable_forSubset(getBodyIdsForList(nrons)$bodyid, getBodyIdsForList(nrons)$bodyid, "NO")
conTabPlt_NO <- plotConnectivityMatrix(FIBSEM_NO, byGroup = "id", connectionMeasure="ROIweight")
conTabPlt_NO <- structureMatrixPlotByType(conTabPlt_NO) + ggtitle("NO connectivity")

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\FIBSEM CX Paper Jan 2020\\Figures\\Overview\\FAFBComp\\EBPBNO_Connectivity.pdf", width = 30, height = 8)
print(grid.arrange(conTabPlt_PB,conTabPlt_EB,conTabPlt_NO,nrow=1))
dev.off()
```
 
 Plot a summary statistic for the per and diff metrics
```{r}
perPB <- melt(perMat)
diffPB <- melt(diffMat)

perPB <- perPB[which(perPB$value != 0),]
diffPB <- diffPB[which(diffPB$value != 0),]

perPB$supergroup.from <- "columnar"
perPB[which(grepl("Delta7",as.character(perPB$Var1))),]$supergroup.from <- "tangential"
perPB$supergroup.to <- "columnar"
perPB[which(grepl("Delta7",as.character(perPB$Var2))),]$supergroup.to <- "tangential"
perPB <- perPB %>% mutate(connType = paste(supergroup.from, supergroup.to, sep="->"))

diffPB$supergroup.from <- "columnar"
diffPB[which(grepl("Delta7",as.character(diffPB$Var1))),]$supergroup.from <- "tangential"
diffPB$supergroup.to <- "columnar"
diffPB[which(grepl("Delta7",as.character(diffPB$Var2))),]$supergroup.to <- "tangential"
diffPB <- diffPB %>% mutate(connType = paste(supergroup.from, supergroup.to, sep="->"))

ggplot(perPB) + geom_point(aes(x = as.factor(connType), y = value),size=4,alpha=0.25) + 
  theme_classic() + ylim(-1,1) + geom_hline(yintercept = 0) +
  xlab('partners') + ylab('(FAFB cts - FIBSEM cts)/(total cts)')

ggplot(diffPB) + geom_point(aes(x = as.factor(connType), y = value),size=4,alpha=0.25) + 
  theme_classic() + ylim(-30,30) + geom_hline(yintercept = 0) +
  xlab('partners') + ylab('FIBSEM cts  FAFB cts')
```

Plot a summary statistic for the per and diff metrics
```{r}
perEB <- melt(perMat)
diffEB <- melt(diffMat)

perEB <- perEB[which(perEB$value != 0),]
diffEB <- diffEB[which(diffEB$value != 0),]

perEB$supergroup.from <- "columnar"
#perEB[which(grepl("R4m",as.character(perEB$Var1))),]$supergroup.from <- "tangential"
perEB$supergroup.to <- "columnar"
#perEB[which(grepl("R4m",as.character(perEB$Var2))),]$supergroup.to <- "tangential"
perEB <- perEB %>% mutate(connType = paste(supergroup.from, supergroup.to, sep="->"))

diffEB$supergroup.from <- "columnar"
#diffEB[which(grepl("R4m",as.character(diffEB$Var1))),]$supergroup.from <- "tangential"
diffEB$supergroup.to <- "columnar"
#diffEB[which(grepl("R4m",as.character(diffEB$Var2))),]$supergroup.to <- "tangential"
diffEB <- diffEB %>% mutate(connType = paste(supergroup.from, supergroup.to, sep="->"))

ggplot(perEB) + geom_point(aes(x = as.factor(connType), y = value),size=4,alpha=0.25) + 
  theme_classic() + ylim(-1,1) + geom_hline(yintercept = 0) +
  xlab('partners') + ylab('(FAFB cts - FIBSEM cts)/(total cts)')

ggplot(diffEB) + geom_point(aes(x = as.factor(connType), y = value),size=4,alpha=0.25) + 
  theme_classic() + ylim(-30,30) + geom_hline(yintercept = 0) +
  xlab('partners') + ylab('FIBSEM cts  FAFB cts')
```

Plot a summary statistic for the per and diff metrics
```{r}
perNO <- melt(perMat)
diffNO <- melt(diffMat)

perNO <- perEB[which(perNO$value != 0),]
diffNO <- diffEB[which(diffNO$value != 0),]

perNO$supergroup.from <- "columnar"
perNO$supergroup.to <- "columnar"
perNO <- perNO %>% mutate(connType = paste(supergroup.from, supergroup.to, sep="->"))

diffNO$supergroup.from <- "columnar"
diffNO$supergroup.to <- "columnar"
diffNO <- diffNO %>% mutate(connType = paste(supergroup.from, supergroup.to, sep="->"))

ggplot(perNO) + geom_point(aes(x = as.factor(connType), y = value),size=4,alpha=0.25) + 
  theme_classic() + ylim(-1,1) + geom_hline(yintercept = 0) +
  xlab('partners') + ylab('(FAFB cts - FIBSEM cts)/(total cts)')

ggplot(diffNO) + geom_point(aes(x = as.factor(connType), y = value),size=4,alpha=0.25) + 
  theme_classic() + ylim(-30,30) + geom_hline(yintercept = 0) +
  xlab('partners') + ylab('FIBSEM cts  FAFB cts')
```


Plot the FIBSEM vs. FAFB comparison statistics for the PB, EB, and NO data
```{r}
dodge = position_dodge(width=0.25)

perPB$ROI <- "PB"
perEB$ROI <- "EB"
perNO$ROI <- "NO"

perAll <- rbind(perPB,rbind(perEB,perNO))

gPer <- ggplot(perAll) + geom_point(aes(x = as.factor(connType), y = value, color=ROI),size=3,alpha=0.1,position=dodge) + 
  theme_classic() + ylim(-1,1) + geom_hline(yintercept = 0) +
  ylab('(FAFB cts - FIBSEM cts)/(total cts)') + theme(axis.title.x = element_blank())

diffPB$ROI <- "PB"
diffEB$ROI <- "EB"
diffNO$ROI <- "NO"

diffAll <- rbind(diffPB,rbind(diffEB,diffNO))

gDiff <- ggplot(diffAll) + geom_point(aes(x = as.factor(connType), y = value, color=ROI),size=3,alpha=0.1,position=dodge) + 
  theme_classic() + ylim(-30,30) + geom_hline(yintercept = 0) +
  ylab('FIBSEM cts          FAFB cts') + theme(axis.title.x = element_blank()) + ggtitle("synapses in one dataset but not the other")

pdf("C:\\Users\\turnerevansd\\Dropbox (HHMI)\\2019_EMPaper\\Manuscript\\RevisionForNeuron\\Figures\\FIBSEMComp\\SummaryStatistics.pdf", width = 8, height = 8)
print(grid.arrange(gPer, gDiff, nrow = 2))
dev.off()

```