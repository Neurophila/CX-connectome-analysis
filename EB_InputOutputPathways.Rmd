---
title: "Notebook analyzing the input and output pathways of the EB"
output:
  html_document:
    df_print: paged
---

# Command to clear environment is: rm(list = ls(all.names = TRUE))
# Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
options(nat.plotengine = 'rgl')
```


# Configurable inputs: choose ROI and Save directory
```{r}

# The region of interest.
ROI="EB"  

# Directory to save data to.
SaveDir="Z:/Cx_Connectome/BradData/EB_Analysis/"

PlotDir="Z:/Cx_Connectome/BradData/EB_Analysis/RingNeuronSynapseLocs/"


```

# Create save directory if it doesnt exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
```

# Connect to neuprint server.
```{r}
neuprint_login()
```

# Get general functions
```{r}
source("inputOutputRegionsVis.r")
source("GetNeuronsInRoi.R")
```

### Get neuprint ROIs and reformat to data frame
```{r}
roisDf = get_rois_df()
```


### Get neurons in the ROI
```{r}
NamedBodies=Get_AllNeurons_InRoi(ROI, FALSE)
```


### Threshold neurons 
```{r}
PreMaxThresh=10
PostMaxThresh=10
Output <-  SynapseStats_And_Threshold(NamedBodies, SaveDir, PreMaxThresh, PostMaxThresh)
list2env(Output ,.GlobalEnv)
remove(Output)
```


### Characterize input and output regions of interest
```{r}

roi_Connect = neuprint_get_roiInfo(NamedBodies$bodyid)

roi_Connect =  mutate(roi_Connect,
                        name = neuprint_get_meta(bodyid)$name,
                        type = neuprint_get_meta(bodyid)$type,
                        neuron_hemi = "C",
                        pre = neuprint_get_meta(bodyid)$pre,
                        post = neuprint_get_meta(bodyid)$post) 


# rearrange so that information worth viewing is in first few columns
roi_Connect = roi_Connect[ , c(1,(ncol(roi_Connect)-4):ncol(roi_Connect),2:(ncol(roi_Connect)-5)) ]


# Assign neuron_hemi to Left (L), Right (R), or Center/NA (C)
roi_Connect$neuron_hemi[grepl("_R",as.character(roi_Connect$name))]='R'
roi_Connect$neuron_hemi[grepl("_L",as.character(roi_Connect$name))]='L'



```



# Get neuron type averages, keeping Left/Right/Center neurons separate
```{r message=FALSE, warning=FALSE}

# Set all NAs to zeros
roi_Connect[is.na((roi_Connect))] <- 0

# Average by type
roi_Connect_bytype=aggregate(roi_Connect[ ,5:length(colnames(roi_Connect))], by=list(unlist(roi_Connect$type[]), unlist(roi_Connect$neuron_hemi)), FUN=mean)
colnames(roi_Connect_bytype)[c(1,2)] <- c("type","neuron_hemi")

```



### Parse ROIs and reorganize such that ROI, #pre and #post become variables.
```{r message=FALSE, warning=FALSE}


roi_Connect_bytype_df = data.frame(type = character(),
                                 roi = character(),
                                 fullroi= character(),
                                 neuron_hemi=character(),
                                 roi_hemi=character(),
                                 prepost = character(),
                                 count = numeric() )


# Loop over columns, parse ROI info, and insert into new dataframe
for (roi in as.character(colnames(roi_Connect_bytype))[5:(length(colnames(roi_Connect_bytype)))] ) {
  
  roiname = as.character(unlist(strsplit(roi, "[.]"))[1])
  
  if (grepl("(R", roi,fixed=TRUE )){
    roi_hemi="R"
  } else if ( grepl("(L", roi,fixed=TRUE ) ) {
     roi_hemi="L"
  } else {roi_hemi='C'}
  
  
  side = as.character(unlist(strsplit(roiname, "[(]"))[2])
  
  Temp_df = data.frame(type = as.character(roi_Connect_bytype$type),
                       roi = as.character(unlist(strsplit(roiname, "[(]"))[1]),
                       fullroi = as.character(unlist(roi)),
                       neuron_hemi =  as.character(roi_Connect_bytype$neuron_hemi),
                       roi_hemi = as.character(roi_hemi),
                       prepost = as.character(unlist(strsplit(roi, "[.]"))[2]),
                       count = roi_Connect_bytype[[roi]]  ) 
  
  roi_Connect_bytype_df = bind_rows(roi_Connect_bytype_df, Temp_df)
  remove(Temp_df)
}



```



```{r message=FALSE, warning=FALSE}
minSynapses = 10
roi_Connect_bytype_df = filter(roi_Connect_bytype_df, count > minSynapses)
roi_Connect_bytype_df = filter(roi_Connect_bytype_df, type %in% unique(NamedBodies$bodytype))
```


### Plot input and output of all ROIs, both Left/Right/C
```{r}

ggplot(roi_Connect_bytype_df, aes(x=roi, y=type, size=count)) + 
  geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) + #, rows = vars(hemisphere)
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE)

#ggsave(paste(slctROI,"inputOutputRegions_perType.pdf",sep="_"), plot = last_plot(), device='pdf', path = "../neuprintR_analysis_plots/",
 # scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)

```


# Look at just the R neurons
```{r}

Rneuron_Connect_bytype_df=filter(roi_Connect_bytype_df, startsWith(unlist(roi_Connect_bytype_df$type), "R"))

# get right ring neurons and the right side ROIs and left right neurons and left ROIs
R_R_plotdata=filter(Rneuron_Connect_bytype_df, neuron_hemi=='R' & (roi_hemi=='R' || roi_hemi=='C') )
R_R_plotdata$roi_names = paste(R_R_plotdata$roi, '(', R_R_plotdata$roi_hemi, ')', sep="")
R_R_plotdata$prepost[R_R_plotdata$prepost=="post"]="Input ROI"
R_R_plotdata$prepost[R_R_plotdata$prepost=="pre"]="Output ROI"


pdf(file=paste(PlotDir, "RingNeuron_","inputOutputRegions_perType.pdf",sep=""), width=14, height=8)
ggplot(R_R_plotdata, aes(x=roi_names, y=type, size=count)) + 
  geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) + #, rows = vars(roi_hemi) )
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE)
dev.off()


ROI_List=c("BU","LAL","GA","CRE","INP","EB", "EBr1","EBr2r4","EBr3am","EBr3d","EBr5","EBr6")
R_R_plotdataSubset=filter(R_R_plotdata, R_R_plotdata$roi %in% ROI_List)

ggplot(R_R_plotdataSubset, aes(x=roi_names, y=type, size=count)) + 
  geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) + #, rows = vars(roi_hemi) )
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE)


```



# Get synapse distribution for all ring neurons
```{r}

# Get type name for all ring neurons
UniqueNamedBodies=as.character(unique(NamedBodies$bodytype))
RingNeuronTypes=UniqueNamedBodies[startsWith(unlist(UniqueNamedBodies), "R")]
RingNeuronBodies=filter(NamedBodies, startsWith(as.character(unlist(NamedBodies$bodytype)), "R") )

# Get all synapses for the ring neurons
for (typeNow in 1:length(RingNeuronTypes)){
  # Get BU synapses
  RingNeuronSyns = NamedBodies[ which(unlist(NamedBodies$bodytype) == RingNeuronTypes[typeNow]),]$bodyid %>% neuprint_get_synapses()
  RingNeuronSyns <-  RingNeuronSyns %>% mutate(name=as.character(RingNeuronTypes[typeNow]))%>%     mutate(x=as.numeric(x),y=as.numeric(y),z=as.numeric(z),prepost=as.logical(prepost))
  if (typeNow==1){
    RingNeuronSynsAll= RingNeuronSyns
  }else{
    RingNeuronSynsAll <- rbind(RingNeuronSynsAll,RingNeuronSyns)
  }
  
}



```

# Make plot of each ring neuron's distribution of synapses 
```{r}



# Get neuron morphologies
RingNeuronMorpho = neuprint_read_neurons(RingNeuronBodies$bodyid)


# Get min/max of x,y,z from morphologies
RingNeuronCharacter=names(RingNeuronMorpho)



MaxOut <- function getmorphomax(RingNeuronMorpho,RingNeuronCharacter){
  X_MaxOut=c()
  X_MinOut=c()
  Y_MaxOut=c()
  Y_MinOut=c()
  Z_MaxOut=c()
  Z_MinOut=c()
  for (NNN in 1:length(RingNeuronCharacter)){
    X_tempstring=paste("RingNeuronMorpho$'",as.symbol(as.name(RingNeuronCharacter[NNN])),"'$d$X",sep="")
    Y_tempstring=paste("RingNeuronMorpho$'",as.symbol(as.name(RingNeuronCharacter[NNN])),"'$d$Y",sep="")
    Z_tempstring=paste("RingNeuronMorpho$'",as.symbol(as.name(RingNeuronCharacter[NNN])),"'$d$Z",sep="")
    
    
    X_MaxOut=max( c(X_MaxOut, max(eval(parse(text=X_tempstring))) ) )
    X_MinOut=max( c(X_MinOut, max(eval(parse(text=X_tempstring))) ) )
    Y_MaxOut=max( c(Y_MaxOut, max(eval(parse(text=Y_tempstring))) ) )
    Y_MinOut=max( c(Y_MinOut, max(eval(parse(text=Y_tempstring))) ) )
    Z_MaxOut=max( c(Z_MaxOut, max(eval(parse(text=Z_tempstring))) ) )
    Z_MinOut=max( c(Z_MinOut, max(eval(parse(text=Z_tempstring))) ) )
   
  }
  MaxOut=c(X_MaxOut,X_MinOut,Y_MaxOut,Y_MinOut,Z_MaxOut,Z_MinOut)
  return(MaxOut)
}





A=max(RingNeuronMorpho$`1105834722`$d$X)


# Get meshes for ROIs
ebMesh = neuprint_ROI_mesh("EB")
RbuMesh = neuprint_ROI_mesh("BU(R)")
noMesh = neuprint_ROI_mesh("NO")
lalMesh = neuprint_ROI_mesh("LAL(R)")
galMesh = neuprint_ROI_mesh("GA(R)")

# Get max and min synapse positions, since clipping doesnt work well.
XLIM=c(min(RingNeuronSynsAll$x)/0.75, max(RingNeuronSynsAll$x)*1.25)
YLIM=c(min(RingNeuronSynsAll$y)/0.75, max(RingNeuronSynsAll$y)*1.25)
ZLIM=c(min(RingNeuronSynsAll$z)/0.75, max(RingNeuronSynsAll$z)*1.25)

# Get view file
RingNeuronView= readRDS('Z:/Cx_Connectome/BradData/code/RingNeuronView.rds')





# For each ring neuron type, loop over and plot synapse distributions
for (typeNow in 1:length(RingNeuronTypes)){

  
  TempBodies=NamedBodies$bodyid[ as.character(NamedBodies$bodytype)==RingNeuronTypes[typeNow] ]
  
  TempMorphos=RingNeuronMorpho[as.character(TempBodies)]
  TempMorphos=TempMorphos[lengths(TempMorphos) != 0 ]

  
  RingNeuronSyns = subset(RingNeuronSynsAll,RingNeuronSynsAll$name==RingNeuronTypes[typeNow])
  
  # Assign synapses into pre and post groups
  RingNeuronSyns_Post = RingNeuronSyns %>% filter(prepost==0) 
  RingNeuronSyns_Pre = RingNeuronSyns %>% filter(prepost==1)
  
  # Get view paramters
  #zoom<-par3d()$zoom
  #userMatrix<-par3d()$userMatrix
  #windowRect<-par3d()$windowRect
  #bbox2<-par3d()$bbox
  #scale<-par3d()$scale
  #viewport<-par3d()$viewport
  #FOV<-par3d()$FOV
  #pp2 <- par3d(no.readonly=TRUE)
  
  nclear3d()
  
  
  bgplot3d({
    plot.new()
    title(main = as.character(RingNeuronTypes[typeNow]), line = 3)})
  
  plot3d(RingNeuronSyns_Pre[c('x','y','z')], col='seagreen3', xlim = c(XLIM), ylim = YLIM, zlim = ZLIM,	forceClipregion = TRUE)
  plot3d(RingNeuronSyns_Post[c('x','y','z')], col='violet', add=TRUE, xlim = XLIM, ylim = YLIM, zlim = ZLIM,	forceClipregion = TRUE)
  
  
  plot3d(TempMorphos,color="black")
  plot3d(ebMesh, color="blue", alpha=0.1,  WithNodes=FALSE, add=TRUE)
  plot3d(RbuMesh, color="blue", alpha=0.1,  WithNodes=FALSE, add=TRUE)
  plot3d(noMesh, type="shade", alpha=0.05,  WithNodes=FALSE, add=TRUE)
  plot3d(lalMesh, type="shade", alpha=0.05,  WithNodes=FALSE, add=TRUE)
  plot3d(galMesh, type="shade", alpha=0.05,  WithNodes=FALSE, add=TRUE)
  decorate3d(box=FALSE) 
  #aspect3d(1,1,1)
  listener=par3d()$listener
   

  #FrontView=rbind(c(1,0,0,0),c(0, -0.15,-1,0),c(0, 1, -0.14,0),c(0,0,0,1))
  #par3d(zoom=0.6)
  #par3d(windowRect=c(1271, 332, 2563, 1231))
  #par3d(scale=c(0.813438, 1.333599, 1.038952))
  #par3d(viewport=c(0, 0, 1292, 899))
  #par3d(FOV=30)
  #par3d(userMatrix=FrontView)
  
  par3d(RingNeuronView)
  par3d(listeners=listener)
  par3d(viewport=c(0, 0, 1292, 899))
  par3d(windowRect=c(1271, 332, 2563, 1231))
  
  
  
  
  FileName=paste('Z:/Cx_Connectome/BradData/EB_Analysis/RingNeuronSynapseLocs/',as.character(RingNeuronTypes[typeNow]),'.png', sep = "")
  rgl.snapshot(FileName,fmt='png')

  
  rgl.close()
  
}

```













