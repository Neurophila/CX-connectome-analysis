---
title: "Notebook analyzing the input and output pathways of the EB at the ROI level"
output:
  html_document:
    df_print: paged
---

### Command to clear environment is: rm(list = ls(all.names = TRUE))
### Command to update is remotes::update_packages('neuprintr')
### Command to load Renviron file is usethis::edit_r_environ()
### Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(plotly)
library(dplyr)
options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose ROI and save/plot directories
```{r}

# The region of interest.
ROI="EB"  

# Directory to save data to.
SaveDir="Z:/Cx_Connectome/BradData/EB_Analysis/"

# Directory to save plots to.
PlotDir="Z:/Cx_Connectome/BradData/EB_Analysis/"

```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint server.
```{r}
neuprint_login()
```

### Get general functions
```{r}
source("inputOutputRegionsVis.r")
source("GetNeuronsInRoi.r")
```

### Get neuprint ROIs 
```{r}
rois = neuprint_ROIs()
heir=neuprint_ROI_hierarchy()
heir[, ] <- lapply(heir[, ], as.character)

# Restructure ROIs to add PB(L) and PB(R)
heir$parent[ grepl("[[:digit:]]",heir$roi) & grepl("PB[(]L",heir$roi) ] = "PB(L)"
heir$parent[ grepl("[[:digit:]]",heir$roi) & grepl("PB[(]R",heir$roi) ] <- "PB(R)"
heir <- rbind(heir, data.frame(parent='PB',roi='PB(L)'))
heir <- rbind(heir, data.frame(parent='PB',roi='PB(R)'))

```


### Get the number of synapses in each ROI for all neurons and neuron types (unthresholded)
```{r}

Output=Get_SynapseCount_In_Rois(ROI, FALSE)
list2env(Output ,.GlobalEnv)
remove(Output)

```


# Filter data by synapse counts, which also gets rid of NA values
```{r}

roi_Connect_bytype_df=filter(roi_Connect_bytype_df, count > 0 )
roi_Connect_df=filter(roi_Connect_df, count > 0 )

```


## Make plot of ALL neurons and histogram of synapse counts
```{r}

# Plot all of the ROIs (and sub ROIs) that all EB neurons innervate
p0<-ggplot(roi_Connect_bytype_df, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("ALL EB Neuron Input/Output ROIs")
ggsave(paste(PlotDir, "ALL_EB_","inputOutputRegions_perType.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 30, height = 20, units ="in", dpi = 300, limitsize = TRUE)


# Plot histogram of synapse counts
HistDat=data.frame(NumberOfSyns= roi_Connect_bytype_df$count)
p1<-ggplot(HistDat, aes(x=NumberOfSyns)) + geom_histogram(binwidth=10) + xlim(0, 500) +
  ylim(0, length(HistDat$NumberOfSyns[HistDat$NumberOfSyns>2 & HistDat$NumberOfSyns<=11]) )
print(p1)

```


### Threshold relative synapse numbers and remove neurons that don't actually belong
```{r}

# 0.01 is good
RelSynThresh=0.01

# Get types based on relative synapse counts (This should be be moved to SynapseStats_And_Threshold)
EB_Type=NamedBodies_TypeAverage$bodytype[NamedBodies_TypeAverage$PrePost_Relative>RelSynThresh]

# Add/Remove types as needed
EB_Type = EB_Type[ !(EB_Type %in% c("FB1C","FB3E","Delta6I","FB6P","FQ10_a","SA3","SIFamide" )) ]

# Threshold EB neurons
ExcludedTypes=unique(filter(roi_Connect_bytype_df, !(type %in% EB_Type) )$type)
roi_Connect_bytype_df=filter(roi_Connect_bytype_df, type %in% EB_Type)

# Save neuron type list for other's use
save(EB_Type, RelSynThresh, ExcludedTypes, file = paste(SaveDir,"EB_Types.RData",sep=""))

```



## Subset on parent ROIs and some sub ROIs as a princpled way of chosing which ROIs to plot
```{r}


# Divide parent ROIs into smaller subROIs that we want to show
ROI_LIST=c("hemibrain","CX","NO","LX","LX(R)","LX(L)","PB","LAL(R)","EB") # List of parent ROIs to include
HB_Children=subset(heir, parent %in%  ROI_LIST)
HB_Children=subset(HB_Children, !(roi %in% ROI_LIST) )
HB_Children=subset(HB_Children, !(roi %in% c("POC","mALT(L)","mALT(R)","GF(R)","GC","AOT(R)"))) # Remove fiber bundles
colnames(HB_Children)[2]='roi_heir_names'
HB_Children$roi_heir_names=as.character(HB_Children$roi_heir_names)


# Create new dataframe (ROISubset) and create a new field (roi_heir_names) with roi names that match those in HB_Children$roi_heir_names
ROISubset=roi_Connect_bytype_df
ROISubset=filter(ROISubset, !(startsWith(type,"R") & neuron_hemi=="L") )
ROISubset$roi_heir_names= ROISubset$roi_names # Make new field with names that match those in HB_Children$roi, the desired ROI list
ROISubset$roi_heir_names= unlist(strsplit(as.character(ROISubset$roi_names), "[(]C[)]")) # Get rid of (C) in those ROIs that have it


# Check ExcludedRois to make sure we arent missing an ROI we want
ExcludedRois=unique( unlist(ROISubset$roi_heir_names[ !(ROISubset$roi_heir_names %in% HB_Children$roi_heir_names) ]))


# Remove ROIs in ROISubset that aren't in the list provided by HB_Children$roi_heir_names Also remove LAL(R) and MB(R), which have super ROIs.
ROISubset=subset(ROISubset, (roi_heir_names %in% HB_Children$roi) & !(roi_names %in% c("LAL(R)","MB(R)")) )


# Join ROISubset with the ROI level information
ROISubset <- merge(ROISubset,HB_Children,by="roi_heir_names")

# Compute relative synapse counts in each ROI for each neuron type
ROISubset=ROI_RelativeSynapses(ROISubset)

# check to make sure that all plotted ROIs are a subset of the HD_Children ROIs
if (sum(ROISubset$roi_heir_names %in% unique(HB_Children$roi_heir_names)) != length(ROISubset$roi_heir_names)){
  warning('Not all plotted ROIs are in HD_Children!!!!')}


```



# Set the levels for the X-axis (ROIs) and Y-axis (neuron types) and plot the data.
```{r}


# Manually set levels for x Axis
ROI_LEVELS=c("BU(L)","BU(R)","LAL(L)","LAL(-GA)(R)","GA(R)",
             "EBr1(C)","EBr2r4(C)","EBr3am(C)","EBr3d(C)","EBr3pw(C)","EBr5(C)","EBr6(C)",
             "PB(L)","PB(R)","NO(L)","NO(R)","FB(C)","AB(L)","AB(R)",
             "VLNP(R)","INP(C)","VMNP(C)","SNP(L)","SNP(R)",
             "GNG(C)","AL(R)","MB(L)","MB(+ACA)(R)","PENP(C)")
ROI_LEVELS[which(!ROI_LEVELS %in% unique(ROISubset$roi_names))]
ROISubset$roi_names[ which(!ROISubset$roi_names %in% ROI_LEVELS)]
ROISubset$roi_names <- factor(ROISubset$roi_names, levels = ROI_LEVELS)


# Make facet for y axis
ROISubset$FACET <- NA
ROISubset$FACET[ startsWith(ROISubset$type_name,"R") ] <- "Right Ring Neurons"
ROISubset$FACET[ startsWith(ROISubset$type_name,"ExR")] <- "Extrinsic Ring Neurons"
ROISubset$FACET[ startsWith(ROISubset$type_name,"EP") | startsWith(ROISubset$type_name,"PE")|
                   startsWith(ROISubset$type_name,"PE") | startsWith(ROISubset$type_name,"EQ")] <- "Columnar Neurons"
ROISubset$FACET[ startsWith(ROISubset$type_name,"FB") | startsWith(ROISubset$type_name,"Delta")] <- "FB-EB Neurons"
ROISubset$type_name[is.na(ROISubset$FACET)]
sum(is.na(ROISubset$FACET))
ROISubset$FACET = factor(ROISubset$FACET, levels=c('Right Ring Neurons','Extrinsic Ring Neurons',
                                                   'Columnar Neurons','FB-EB Neurons'))


# Factor the types for plotting so the color is good
ROISubset$type = factor(ROISubset$type, levels=c( sort(unique(ROISubset$type[ROISubset$FACET == "Right Ring Neurons"]),decreasing = TRUE),
                                                         sort(unique(ROISubset$type[ROISubset$FACET == "Extrinsic Ring Neurons"]),decreasing = TRUE),
                                                         sort(unique(ROISubset$type[ROISubset$FACET == "Columnar Neurons"]),decreasing = TRUE),
                                                         sort(unique(ROISubset$type[ROISubset$FACET == "FB-EB Neurons"]),decreasing = TRUE)) )



# Plot all of the ROIs (and sub ROIs) that all EB neurons innervate
p0<-ggplot(ROISubset, aes(x=roi_names, y=type_name, size=count)) + geom_point()  + 
  facet_grid(cols=vars(prepost), rows=vars(FACET), scales="free_y", space="free_y") +  scale_fill_manual(values = vars(type)) + aes(color = type) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("EB Neuron Input/Output ROIs")
ggsave(paste(PlotDir, "All_Abs_Figure_EBAll_InputOutput_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 16, height = 16, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all EB neurons innervate
p0<-ggplot(ROISubset, aes(x=roi_names, y=type_name, size=RelativeCount)) + geom_point()  + 
  facet_grid(cols=vars(prepost), rows=vars(FACET), scales="free_y", space="free_y") +  scale_fill_manual(values = vars(type)) + aes(color = type) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("EB Neuron Relative Input/Output ROIs"))
ggsave(paste(PlotDir, "All_Rel_Figure_EBAll_InputOutput_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 16, height = 16, units ="in", dpi = 600, limitsize = TRUE)


```


# Plot the relative data and thresholded relative data
```{r}


Input_MaxThresh=30               # 30 is good
Input_MinSynThresh=12            # 12 is good
Input_MinRelSynThresh=0.0125     # 0.0125 is good
Ouput_MaxThresh=30               # 30 is good  
Output_MinSynThresh=6            # 6 is good
Output_MinRelSynThresh=0.01      # 0.01 is good


# Include neurons that have a minimum relative AND absolute number of synapses OR have above a certain higher number of absolute synapses.
# This second threshold is meant to catch large neurons whos relative counts may be low in an ROI but their absolute counts are high, as happens with many ExR neurons.
ROISubset_Thresh =   filter(ROISubset,   ((  ((count > Input_MinSynThresh   & RelativeCount  > Input_MinRelSynThresh)   | count > Input_MaxThresh) &  prepost == "Input ROI")     |
                                         (   ((count > Output_MinSynThresh  & RelativeCount  > Output_MinRelSynThresh)  | count > Ouput_MaxThresh) &  prepost == "Output ROI"))   )
ROISubset_Excluded = filter(ROISubset,  !((  ((count > Input_MinSynThresh   & RelativeCount  > Input_MinRelSynThresh)   | count > Input_MaxThresh) &  prepost == "Input ROI")     |
                                         (   ((count > Output_MinSynThresh  & RelativeCount  > Output_MinRelSynThresh)  | count > Ouput_MaxThresh) &  prepost == "Output ROI"))   )



# Plot scatter plots of absolute and relative synapse counts for input and output ROIs
InputHistDat= rbind( subset(ROISubset, (prepost == "Input ROI")) %>% mutate(TTT='ALL'), 
                     subset(ROISubset_Excluded, (prepost == "Input ROI")) %>% mutate(TTT='Excluded'))
OutputHistDat= rbind(subset(ROISubset, (prepost == "Output ROI")) %>% mutate(TTT='ALL'), 
                     subset(ROISubset_Excluded, (prepost == "Output ROI")) %>% mutate(TTT='Excluded'))
plot_ly(data = InputHistDat,  x = ~count, y = ~RelativeCount, color = ~TTT, text = ~paste("ROI: ", roi_names, '$<br>Type:', type_name)) %>% layout(title = 'Inputs')
plot_ly(data = OutputHistDat,  x = ~count, y = ~RelativeCount, color = ~TTT, text = ~paste("ROI: ", roi_names, '$<br>Type:', type_name)) %>% layout(title = 'Outputs')



# Plot all of the ROIs (and sub ROIs) that all neurons innervate
p0<-ggplot(ROISubset_Thresh, aes(x=roi_names, y=type_name, size=count))   + 
  facet_grid(cols=vars(prepost), rows=vars(FACET), scales="free_y", space="free_y") + 
  geom_point(shape = 21, colour = "black", aes(fill = type, stroke=1.5)) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("EB Neuron Relative Input/Output ROIs"," Thresholded "))
ggsave(paste(PlotDir, "FIGURE_Thresh_Abs_Figure_EBAll_InputOutput_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 16, height = 16, units ="in", dpi = 600, limitsize = TRUE)



# Plot all of the ROIs (and sub ROIs) that all neurons innervate
p0<-ggplot(ROISubset_Thresh, aes(x=roi_names, y=type_name, size=RelativeCount)) + geom_point()  + 
  facet_grid(cols=vars(prepost), rows=vars(FACET), scales="free_y", space="free_y") +  scale_fill_manual(values = vars(type)) + aes(color = type) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("EB Neuron Input/Output ROIs", " Thresholded"))
ggsave(paste(PlotDir, "Thresh_Rel_Figure_EBAll_InputOutput_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 16, height = 16, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all neurons innervate
p0<-ggplot(ROISubset_Thresh, aes(x=roi_names, y=type_name, size=log10(count))) + geom_point()  + 
  facet_grid(cols=vars(prepost), rows=vars(FACET), scales="free_y", space="free_y") +  scale_fill_manual(values = vars(type)) + aes(color = type) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("EB Neuron Input/Output ROIs", " Thresholded"))
ggsave(paste(PlotDir, "Thresh_LogAbs_Figure_EBAll_InputOutput_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 16, height = 16, units ="in", dpi = 600, limitsize = TRUE)


# Plot the excluded data
p0<-ggplot(ROISubset_Excluded, aes(x=roi_names, y=type_name, size=count)) + geom_point()  + 
  facet_grid(cols=vars(prepost), rows=vars(FACET), scales="free_y", space="free_y") +  scale_fill_manual(values = vars(type)) + aes(color = type) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("EB Neuron Relative Input/Output ROIs"," Thresholded "))
ggsave(paste(PlotDir, "Ex_Abs_Figure_EBAll_InputOutput_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 16, height = 16, units ="in", dpi = 600, limitsize = TRUE)



# Look at single rows to adjust thresholds as needed
ROISubset[ (ROISubset$roi_names=="PFGs(R)" & ROISubset$roi_names=="LAL(-GA)(R)" & ROISubset$prepost=="Output ROI")  , ]



plot_ly(data = subset(ROISubset, prepost=="Input ROI"),  x = ~roi_names, y = ~type_name, z = ~RelativeCount, type = "heatmap") %>% layout(title = 'All Outputs')
plot_ly(data = subset(ROISubset, prepost=="Input ROI"),  x = ~roi_names, y = ~type_name, z = ~count, type = "heatmap") %>% layout(title = 'All Outputs')


```
