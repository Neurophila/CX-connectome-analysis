---
title: "Notebook analyzing the input and output pathways of the EB"
output:
  html_document:
    df_print: paged
---

# Command to clear environment is: rm(list = ls(all.names = TRUE))
# Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
options(nat.plotengine = 'rgl')
```


# Configurable inputs: choose ROI and Save directory
```{r}

# The region of interest.
ROI="EB"  

# Directory to save data to.
SaveDir="Z:/Cx_Connectome/BradData/EB_Analysis/"


```

# Create save directory if it doesnt exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
```

# Connect to neuprint server.
```{r}
neuprint_login()
```

# Get general functions
```{r}
source("inputOutputRegionsVis.r")
source("GetNeuronsInRoi.R")
```

### Get neuprint ROIs and reformat to data frame
```{r}
roisDf = get_rois_df()
```


### Get neurons in the ROI
```{r}
NamedBodies=Get_AllNeurons_InRoi(ROI, FALSE)
```


### Threshold neurons 
```{r}
PreMaxThresh=10
PostMaxThresh=10
Output <-  SynapseStats_And_Threshold(NamedBodies, SaveDir, PreMaxThresh, PostMaxThresh)
list2env(Output ,.GlobalEnv)
remove(Output)
```



















### Characterize input and output regions of NO neurons

```{r}
roi_Connect_rois = neuprint_get_roiInfo(roi_Connect_filt$bodyid)

roi_Connect_rois =  mutate(roi_Connect_rois,
                        name = neuprint_get_meta(bodyid)$name,
                        type = neuprint_get_meta(bodyid)$type,
                        pre = neuprint_get_meta(bodyid)$pre,
                        post = neuprint_get_meta(bodyid)$post) 
```



```{r message=FALSE, warning=FALSE}

# reorganize such that ROI, #pre and #post become variables
roi_Connect_rois_df = data.frame(bodyid = numeric(),
                              name = character(),
                              type = character(),
                              roi = character(),
                              prepost = character(),
                              count = numeric())


for (roi in as.character(colnames(roi_Connect_rois))[2:(length(colnames(roi_Connect_rois))-4)]) {

  if (length(as.character(filter(roisDf,value == unlist(strsplit(roi, "[.]"))[1])$keyName)) == 1) next
  
  roiname = as.character(unlist(strsplit(roi, "[.]"))[1])
  side = as.character(unlist(strsplit(roiname, "[(]"))[2])
  roi_Connect_roi = data.frame(bodyid = roi_Connect_rois$bodyid,
                            name = roi_Connect_rois$name, 
                            type = roi_Connect_rois$type,
                            roi = as.character(unlist(strsplit(roiname, "[(]"))[1]),
                            hemisphere = as.character(unlist(strsplit(side, "[)]"))[1]),
                            prepost = unlist(strsplit(roi, "[.]"))[2],
                            count = ( as.numeric(roi_Connect_rois[[roi]]) ) ) 
                            #count = ( as.numeric(roi_Connect_rois[[roi]]) / (roi_Connect_rois$pre + roi_Connect_rois$post) ) )
  roi_Connect_rois_df = bind_rows(roi_Connect_rois_df, roi_Connect_roi)
}

```



```{r message=FALSE, warning=FALSE}
roi_Connect_rois_df = filter(roi_Connect_rois_df, count > minSynapses)
roi_Connect_rois_df = filter(roi_Connect_rois_df, type %in% unique(roi_Connect_filt$bodytype))
```



```{r}
ggplot(roi_Connect_rois_df, aes(x=roi, y=type, size=count)) + 
  geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) + #, rows = vars(hemisphere)
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE)

#ggsave(paste(slctROI,"inputOutputRegions_perType.pdf",sep="_"), plot = last_plot(), device='pdf', path = "../neuprintR_analysis_plots/",
 # scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```


```{r}
ggplot(roi_Connect_rois_df, aes(x=roi, y=type, size=count)) + 
  geom_point(aes(color=roi)) +
  facet_grid(. ~ hemisphere + prepost) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE)

#ggsave(paste(slctROI,"inputOutputRegions_perType_perROIside.pdf",sep="_"), plot = last_plot(), device='pdf', path = "../neuprintR_analysis_plots/",
#  scale = 1.5, width = 20, height = 15, units ="cm", dpi = 600, limitsize = TRUE)
```


### Characterize input and output regions of NO neurons *within the NO*
Regions to look at
```{r}
regs = c("NO1(L)","NO1(R)","NO2(L)","NO2(R)","NO3(L)","NO3(R)")
```

```{r message=FALSE, warning=FALSE}
# reorganize such that ROI, #pre and #post become variables
roi_Connect_intraNO_df = data.frame(bodyid = numeric(),
                              name = character(),
                              type = character(),
                              roi = character(),
                              prepost = character(),
                              count = numeric())

for (roi in as.character(colnames(roi_Connect_rois))[2:(length(colnames(roi_Connect_rois))-4)]) {
  roiname = as.character(unlist(strsplit(roi, "[.]"))[1])
  side = as.character(unlist(strsplit(roiname, "[(]"))[2])
    
  if (roiname %in% regs) {
      roi_Connect_no = data.frame(bodyid = roi_Connect_rois$bodyid,
                                  name = roi_Connect_rois$name, 
                                  type = roi_Connect_rois$type,
                                  roi = as.character(unlist(strsplit(roiname, "[(]"))[1]),
                                  hemisphere = as.character(unlist(strsplit(side, "[)]"))[1]),
                                  prepost = unlist(strsplit(roi, "[.]"))[2],
                                  count = ( as.numeric(roi_Connect_rois[[roi]]) ) ) 
      roi_Connect_intraNO_df = bind_rows(roi_Connect_intraNO_df, roi_Connect_no)
  }
}
```

```{r message=FALSE, warning=FALSE}
roi_Connect_intraNO_df = filter(roi_Connect_intraNO_df, count > minSynapses)
roi_Connect_intraNO_df = filter(roi_Connect_intraNO_df, type %in% unique(roi_Connect_filt$bodytype))
```

```{r}
ggplot(roi_Connect_intraNO_df, aes(x=roi, y=type, size=count)) + 
  geom_point(aes(color=roi)) +
  facet_grid(.~ prepost) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE)

ggplot(roi_Connect_intraNO_df, aes(x=roi, y=type, size=count)) + 
  geom_point(aes(color=roi)) +
  facet_grid(.~ hemisphere + prepost) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE)
```



