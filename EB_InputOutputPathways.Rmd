---
title: "Notebook analyzing the input and output pathways of the EB at the ROI level"
output:
  html_document:
    df_print: paged
---

### Command to clear environment is: rm(list = ls(all.names = TRUE))
### Command to update is remotes::update_packages('neuprintr')
### Command to load Renviron file is usethis::edit_r_environ()
### Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(plotly)
library(dplyr)
options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose ROI and save/plot directories
```{r}

# The region of interest.
ROI="EB"  

# Directory to save data to.
SaveDir="Z:/Cx_Connectome/BradData/EB_Analysis/"

# Directory to save plots to.
PlotDir="Z:/Cx_Connectome/BradData/EB_Analysis/"

```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint server.
```{r}
neuprint_login()
```

### Get general functions
```{r}
source("inputOutputRegionsVis.r")
source("GetNeuronsInRoi.r")
```

### Get neuprint ROIs 
```{r}
rois = neuprint_ROIs()
heir=neuprint_ROI_hierarchy()
```

### Get neurons in the ROI
```{r}

NamedBodies = Get_AllNeurons_InRoi(ROI, FALSE)

```

### Threshold neurons (need to agree on criteria and clean up code)
```{r}

PreMaxThresh=10
PostMaxThresh=10
Output <-  SynapseStats_And_Threshold(NamedBodies, SaveDir, PreMaxThresh, PostMaxThresh, "EB")
list2env(Output ,.GlobalEnv)
remove(Output)

```

### Compute type averages of named bodies to get an idea of which neurons belong in which compartments
### and where threshold on relative synapse counts should be
```{r}

NamedBodies_TypeAverage= aggregate(NamedBodies[, 6:length(colnames(NamedBodies))], list(NamedBodies$bodytype), mean)
colnames(NamedBodies_TypeAverage)[1]="bodytype"

```


### Get the number of synapses in each ROI for individual neurons and individual neuron types
```{r message=FALSE, warning=FALSE}

minSynapses = 4
Output=InputOutput_ROI_PerNeuron(NamedBodies, minSynapses)
list2env(Output ,.GlobalEnv)
remove(Output)

```


### Add ROI and neuron type names that will be displayed on plots
```{r}

roi_Connect_bytype_df$roi_names = paste(roi_Connect_bytype_df$roi, '(', roi_Connect_bytype_df$roi_hemi, ')', sep="")
roi_Connect_bytype_df$type_name = paste(roi_Connect_bytype_df$type, '(',roi_Connect_bytype_df$neuron_hemi, ')', sep="")

```


## Make plot of ALL neurons
```{r}

# Plot all of the ROIs (and sub ROIs) that all NO neurons innervate
p0<-ggplot(roi_Connect_bytype_df, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("ALL NO Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "ALL_EB_","inputOutputRegions_perType.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 30, height = 20, units ="in", dpi = 300, limitsize = TRUE)


```



### Threshold relative synapse numbers and remove neurons that don't actually belong
```{r}

# 0.01 is good
RelSynThresh=0.01

# Get types based on relative synapse counts (This should be be moved to SynapseStats_And_Threshold)
EB_Type=NamedBodies_TypeAverage$bodytype[NamedBodies_TypeAverage$PrePost_Relative>RelSynThresh]

# Add/Remove types as needed
EB_Type = EB_Type[ !(EB_Type %in% c("FB1C","FB3E")) ]

# Threshold EB neurons
ExcludedTypes=unique(filter(roi_Connect_bytype_df, !(type %in% EB_Type) )$type)
roi_Connect_bytype_dfThresh=filter(roi_Connect_bytype_df, type %in% EB_Type)


save(EB_Type, RelSynThresh, ExcludedTypes, file = paste(SaveDir,"EB_Types.RData",sep=""))

```




## Subset on parent ROIs and some sub ROIs as a princpled way of showing ROIs
```{r}

# Divide parent ROIs into smaller subROIs that we want to show
ROI_LIST=c("hemibrain","CX","NO","LX","LX(R)","LX(L)","PB","LAL(R)","EB") # List of parent ROIs to include
HB_Children=subset(heir, parent %in%  ROI_LIST)
HB_Children=subset(HB_Children, !(roi %in% ROI_LIST) )
HB_Children=subset(HB_Children, !(roi %in% c("POC","mALT(L)","mALT(R)","GF(R)","GC","AOT(R)"))) # Remove fiber bundles


# Create new dataframe (ROISubset) and create a new field (roi_heir_names) with roi names that match those in HB_Children$roi
ROISubset=roi_Connect_bytype_dfThresh
ROISubset$roi_heir_names=ROISubset$roi_names # Make new field with names that match those in HB_Children$roi, the desired ROI list
ROISubset$roi_heir_names= strsplit(as.character(ROISubset$roi_names), "[(]C[)]") # Get rid of (C) in those ROIs that have it
ROISubset$roi_heir_names[ startsWith(as.character(ROISubset$roi_heir_names), "PB(R") ] = 
  strsplit(as.character(ROISubset$roi_heir_names[ startsWith(as.character(ROISubset$roi_heir_names), "PB(R") ]), "[(]R[)]")
ROISubset$roi_heir_names[ startsWith(as.character(ROISubset$roi_heir_names), "PB(L") ] = 
  strsplit(as.character(ROISubset$roi_heir_names[ startsWith(as.character(ROISubset$roi_heir_names), "PB(L") ]), "[(]L[)]")


# Check ExcludedRois to make sure we arent missing an ROI we want
ExcludedRois=unique( ROISubset$roi_heir_names[ !(ROISubset$roi_heir_names %in% HB_Children$roi) ])


# Remove ROIs in ROISubset that aren't in the list provided by HB_Children$roi. Also remove LAL(R) and MB(R), which have super ROIs.
ROISubset=subset(ROISubset, (roi_heir_names %in% HB_Children$roi) & !(roi_names %in% c("LAL(R)","MB(R)")) )


# Relabel roi and roi_names field so that PB(R#) and PB(L#) rois are just PB(R) and PB(L)
ROISubset$roi[startsWith(ROISubset$roi,'PB(L')] <- "PB"
ROISubset$roi[startsWith(ROISubset$roi,'PB(R')] <- "PB"
ROISubset$roi_names = paste(ROISubset$roi, '(', ROISubset$roi_hemi, ')', sep="")
ROISubset$roi_heir_names[startsWith(ROISubset$roi_names,"PB(L")] <- "PB(L)"
ROISubset$roi_heir_names[startsWith(ROISubset$roi_names,"PB(R")] <- "PB(R)"
ROISubset$roi_heir_names=as.character(ROISubset$roi_heir_names)


# Do the same for HB_Children
colnames(HB_Children)[2]='roi_heir_names'
HB_Children$roi_heir_names=as.character(HB_Children$roi_heir_names)
HB_Children$parent=as.character(HB_Children$parent)
HB_Children$roi_heir_names[startsWith(HB_Children$roi_heir_names,"PB(L")] <- "PB(L)"
HB_Children$roi_heir_names[startsWith(HB_Children$roi_heir_names,"PB(R")] <- "PB(R)"
HB_Children=distinct(HB_Children)
HB_Children$parent[ endsWith(as.character(HB_Children$parent), "(L)") ] = 
  strsplit(as.character(HB_Children$parent[ endsWith(as.character(HB_Children$parent), "(L)") ]), "[(]L[)]")
HB_Children$parent[ endsWith(as.character(HB_Children$parent), "(R)") ] = 
  strsplit(as.character(HB_Children$parent[ endsWith(as.character(HB_Children$parent), "(R)") ]), "[(]R[)]")
HB_Children$parent[HB_Children$parent=="LAL"]<-"LX"


# Average PB(L) and PB(R) rois by cell type
ROISubset=aggregate(ROISubset$count, by=list(ROISubset$type, ROISubset$type_name,
                                                             ROISubset$roi,  ROISubset$roi_names, ROISubset$roi_heir_names,
                                                             ROISubset$prepost), mean)
colnames(ROISubset)[c(1,2,3,4,5,6,7)]=c("type","type_name","roi","roi_names","roi_heir_names","prepost","count")


# check to make sure that all plotted ROIs are a subset of the HD_Children ROIs
if (sum(ROISubset$roi_heir_names %in% unique(HB_Children$roi_heir_names)) != length(ROISubset$roi_heir_names)){
  warning('Not all plotted ROIs are in HD_Children!!!!')}


# Join ROISubset with the ROI level information
ROISubset <- merge(ROISubset,HB_Children,by="roi_heir_names")



# Manually set levels for x Axis
ROI_LEVELS=c("BU(L)","BU(R)","LAL(L)","LAL(-GA)(R)","GA(R)",
             "EBr1(C)","EBr2r4(C)","EBr3am(C)","EBr3d(C)","EBr3pw(C)","EBr5(C)","EBr6(C)",
             "PB(L)","PB(R)","NO(L)","NO(R)","FB(C)","AB(R)",
             "VLNP(R)","INP(C)","VMNP(C)","SNP(L)","SNP(R)",
             "GNG(C)")
ROI_LEVELS[which(!ROI_LEVELS %in% unique(ROISubset$roi_names))]
ROISubset$roi_names[ which(!ROISubset$roi_names %in% ROI_LEVELS)]
ROISubset$roi_names <- factor(ROISubset$roi_names, levels = ROI_LEVELS)


# Make facet for y axis
ROISubset$FACET <- NA
ROISubset$FACET[ startsWith(ROISubset$type_name,"R") ] <- "Ring Neurons"
ROISubset$FACET[ startsWith(ROISubset$type_name,"ExR")] <- "Extrinsic Ring Neurons"
ROISubset$FACET[ startsWith(ROISubset$type_name,"EP") | startsWith(ROISubset$type_name,"PE")|
                   startsWith(ROISubset$type_name,"PE") | startsWith(ROISubset$type_name,"EQ")] <- "Columnar Neurons"
ROISubset$FACET[ startsWith(ROISubset$type_name,"FB") | startsWith(ROISubset$type_name,"Delta")] <- "FB-EB Neurons"
ROISubset$type_name[is.na(ROISubset$FACET)]
sum(is.na(ROISubset$FACET))
ROISubset$FACET = factor(ROISubset$FACET, levels=c('Ring Neurons','Extrinsic Ring Neurons',
                                                   'Columnar Neurons','FB-EB Neurons'))


# Factor the types for plotting so the color is good
ROISubset$type = factor(ROISubset$type, levels=c( sort(unique(ROISubset$type[ROISubset$FACET == "Ring Neurons"]),decreasing = TRUE),
                                                         sort(unique(ROISubset$type[ROISubset$FACET == "Extrinsic Ring Neurons"]),decreasing = TRUE),
                                                         sort(unique(ROISubset$type[ROISubset$FACET == "Columnar Neurons"]),decreasing = TRUE),
                                                         sort(unique(ROISubset$type[ROISubset$FACET == "FB-EB Neurons"]),decreasing = TRUE)) )



# Plot all of the ROIs (and sub ROIs) that all NO neurons innervate
p0<-ggplot(ROISubset, aes(x=roi_names, y=type_name, size=count)) + geom_point()  + 
  facet_grid(cols=vars(prepost), rows=vars(FACET), scales="free", space="free") +  scale_fill_manual(values = vars(type)) + aes(color = type) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh/Subset EB Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "Figure_EbAll_InputOutput_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 16, height = 16, units ="in", dpi = 600, limitsize = TRUE)



# Remove left ring neurons and make plot again
ROISubset_Remove_Lring=subset(ROISubset, !(startsWith(ROISubset$type_name,"R") &  endsWith(ROISubset$type_name,"(L)")) )

# Plot all of the ROIs (and sub ROIs) that all NO neurons innervate
p0<-ggplot(ROISubset_Remove_Lring, aes(x=roi_names, y=type_name, size=count)) + geom_point()  + 
  facet_grid(cols=vars(prepost), rows=vars(FACET), scales="free", space="free") +  scale_fill_manual(values = vars(type)) + aes(color = type) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh/Subset EB Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "Figuref_EbNoLringNeurons_InputOutput_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 14, height = 14, units ="in", dpi = 600, limitsize = TRUE)



```































# Look at just the right ring neurons, since all ring neurons innervate only one hemisphere.
```{r}

# Get just the ring neuron data
Rneuron_Connect_bytype_df=filter(roi_Connect_bytype_df, startsWith(unlist(roi_Connect_bytype_df$type), "R"))
Rneuron_Connect_bytype_df$roi_names = paste(Rneuron_Connect_bytype_df$roi, '(', Rneuron_Connect_bytype_df$roi_hemi, ')', sep="")
Rneuron_Connect_bytype_df$type_name = paste(Rneuron_Connect_bytype_df$type, '(', Rneuron_Connect_bytype_df$neuron_hemi, ')', sep="")

# Get right ring neurons 
R_R_plotdata=filter(Rneuron_Connect_bytype_df, neuron_hemi=='R')

# Plot all of the ROIs (and sub ROIs) that the right ring neurons innervate
p1<-ggplot(R_R_plotdata, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Right Ring Neuron Input/Output ROIs")
print(p1)
ggsave(paste(PlotDir, "RingNeuronRight_","inputOutputRegions_perType.pdf",sep=""), plot = p1, device='pdf', scale = 1, width = 14, height = 8, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "RingNeuronRight_","inputOutputRegions_perType.png",sep=""), plot = p1, device='png', scale = 1, width = 14, height = 8, units ="in", dpi = 600, limitsize = TRUE)


# Threshold based on synapse counts and plot again with ROIs arranged
R_R_plotdataSubset=R_R_plotdata
R_R_plotdataSubset=filter(R_R_plotdataSubset, !(R_R_plotdataSubset$roi %in% "LX") )
R_R_plotdataSubset$roi_names = as.factor(R_R_plotdataSubset$roi_names)
R_R_plotdataSubset$roi_names <- factor(R_R_plotdataSubset$roi_names, levels = c("BU(R)","LAL(R)","GA(R)","EB(C)", "EBr1(C)","EBr2r4(C)","EBr3am(C)","EBr3d(C)","EBr3pw(C)","EBr5(C)","EBr6(C)"))

p2<-ggplot(R_R_plotdataSubset, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) + 
  facet_grid(cols=vars(prepost)) + theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) + 
  ggtitle(paste("Right Ring Neuron Input/Output ROIs with rel#synapses > ",as.character(RelSynThresh),sep=""))
print(p2)
ggsave(paste(PlotDir, "F_RingNeuronRight_Thresh_","inputOutputRegions_perType.pdf",sep=""), plot = p2, device='pdf', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "F_RingNeuronRight_Thresh_","inputOutputRegions_perType.png",sep=""), plot = p2, device='png', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)

remove(list=c("p1","p2"))

```



# Look at just the ExRs
```{r}

# Get just the ExR neuron data
ExRneuron_Connect_bytype_df=filter(roi_Connect_bytype_df, startsWith(unlist(roi_Connect_bytype_df$type), "ExR"))

# add an ROI name field
ExRneuron_Connect_bytype_df$roi_names = paste(ExRneuron_Connect_bytype_df$roi, '(', ExRneuron_Connect_bytype_df$roi_hemi, ')', sep="")
ExRneuron_Connect_bytype_df$type_name = paste(ExRneuron_Connect_bytype_df$type, '(', ExRneuron_Connect_bytype_df$neuron_hemi, ')', sep="")

# Plot all of the ROIs (and sub ROIs) that the ALLs ExRs innervate
p3<-ggplot(ExRneuron_Connect_bytype_df, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("ALL ExR Input/Output ROIs with #synapses")
print(p3)
ggsave(paste(PlotDir, "ExR_ALL_","InOutRegions_perType.pdf",sep=""), plot = p3, device='pdf', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "ExR_ALL_","InOutRegions_perType.png",sep=""), plot = p3, device='png', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)


# Filter by synapse counts
ExRneuron_Connect_bytype_dfThresh=filter(ExRneuron_Connect_bytype_df, count>SynThresh)

# Plot all ExRs again
p4<-ggplot(ExRneuron_Connect_bytype_dfThresh, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL ExR  Input/Output ROIs with #synapses count thresholding at ",as.character(SynThresh),sep=""))
print(p4)
ggsave(paste(PlotDir, "ExR_ALLThresh1_","InOutRegions_perType.pdf",sep=""), plot = p4, device='pdf', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "ExR_ALLThresh1_","InOutRegions_perType.png",sep=""), plot = p4, device='png', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)


# Filter out some ROIs
ExRneuron_Connect_bytype_dfThresh=filter(ExRneuron_Connect_bytype_dfThresh, !(ExRneuron_Connect_bytype_dfThresh$roi %in% c("LX","CX","None","FB-column3")))

# Plot all ExRs again
p5<-ggplot(ExRneuron_Connect_bytype_dfThresh, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL ExR  Input/Output ROIs with #synapses count thresholding at ",as.character(SynThresh),sep=""))
print(p5)
ggsave(paste(PlotDir, "ExR_ALLThresh2_","InOutRegions_perType.pdf",sep=""), plot = p5, device='pdf', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "ExR_ALLThresh2_","InOutRegions_perType.png",sep=""), plot = p5, device='png', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)


# Plot the ExRs again, but excluding Fb and Eb subregions
ExRneuron_Connect_bytype_dfThresh_NoLayers=filter(ExRneuron_Connect_bytype_dfThresh, !(startsWith(ExRneuron_Connect_bytype_dfThresh$roi,"EBr") | startsWith(ExRneuron_Connect_bytype_dfThresh$roi,"FBl")) )

p6<-ggplot(ExRneuron_Connect_bytype_dfThresh_NoLayers, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL ExR  Input/Output ROIs with #synapses count thresholding at ",as.character(SynThresh),sep=""))
print(p6)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_NoLayers_","InOutRegions_perType.pdf",sep=""), plot = p6, device='pdf', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_NoLayers_","InOutRegions_perType.png",sep=""), plot = p6, device='png', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)

# Plot the ExRs again, but only in EB
ExRneuron_Connect_bytype_dfThresh_EBLayers=filter(ExRneuron_Connect_bytype_dfThresh, (startsWith(ExRneuron_Connect_bytype_dfThresh$roi,"EB")))

p7<-ggplot(ExRneuron_Connect_bytype_dfThresh_EBLayers, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL ExR  Input/Output ROIs with #synapses count thresholding at ",as.character(SynThresh),sep=""))
print(p7)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_EBLayers_","InOutRegions_perType.pdf",sep=""), plot = p7, device='pdf', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_EBLayers_","InOutRegions_perType.png",sep=""), plot = p7, device='png', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)


# Plot the ExRs again, but only in FB
ExRneuron_Connect_bytype_dfThresh_FBLayers=filter(ExRneuron_Connect_bytype_dfThresh, (startsWith(ExRneuron_Connect_bytype_dfThresh$roi,"FB")))

p8<-ggplot(ExRneuron_Connect_bytype_dfThresh_FBLayers, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL ExR  Input/Output ROIs with #synapses after count thresholding at ",as.character(SynThresh),sep=""))
print(p8)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_FBLayers_","InOutRegions_perType.pdf",sep=""), plot = p8, device='pdf', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_FBLayers_","InOutRegions_perType.png",sep=""), plot = p8, device='png', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)

remove(list=c("p3","p4","p5","p6","p7","p8"))


```



### Make same facet plots for all EB neurons that are not ring neurons or ExRs
```{r}

# Get all neurons that are not ring or ExRs
NonR_Connect_bytype_df=filter(roi_Connect_bytype_df, !(startsWith(unlist(roi_Connect_bytype_df$type), "ExR") | startsWith(unlist(roi_Connect_bytype_df$type), "R")) )

# add an ROI name field
NonR_Connect_bytype_df$roi_names = paste(NonR_Connect_bytype_df$roi, '(', NonR_Connect_bytype_df$roi_hemi, ')', sep="")
NonR_Connect_bytype_df$type_name = paste(NonR_Connect_bytype_df$type, '(', NonR_Connect_bytype_df$neuron_hemi, ')', sep="")

# Plot all of the ROIs (and sub ROIs) that the ALLs Non Rs innervate
p9<-ggplot(NonR_Connect_bytype_df, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("ALL Non R Input/Output ROIs with #synapses")
print(p9)
ggsave(paste(PlotDir, "NonR_ALL_","InOutRegions_perType.pdf",sep=""), plot = p9, device='pdf', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "NonR_ALL_","InOutRegions_perType.png",sep=""), plot = p9, device='png', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)


# Filter by synapse counts
NonR_Connect_bytype_dfThresh=filter(NonR_Connect_bytype_df, count>SynThresh)

# Plot all Non Rs again
p10<-ggplot(NonR_Connect_bytype_dfThresh, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL Non R  Input/Output ROIs with #synapses after count thresholding at ",as.character(SynThresh),sep=""))
print(p10)
ggsave(paste(PlotDir, "NonR_ALLThresh1_","InOutRegions_perType.pdf",sep=""), plot = p10, device='pdf', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "NonR_ALLThresh1_","InOutRegions_perType.png",sep=""), plot = p10, device='png', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)



# Filter out some ROIs
NonR_Connect_bytype_dfThresh=filter(NonR_Connect_bytype_dfThresh, !(NonR_Connect_bytype_dfThresh$roi %in% c("LX","CX","None","FB-column3")))

# Plot all Non Rs again
p11<-ggplot(NonR_Connect_bytype_dfThresh, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL Non R  Input/Output ROIs with #synapses after count thresholding at ",as.character(SynThresh),sep=""))
print(p11)
ggsave(paste(PlotDir, "NonR_ALLThresh2_","InOutRegions_perType.pdf",sep=""), plot = p11, device='pdf', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "NonR_ALLThresh2_","InOutRegions_perType.png",sep=""), plot = p11, device='png', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)


# Plot the Non Rs again, but excluding Fb and Eb subregions
NonR_Connect_bytype_dfThresh_NoLayers=filter(NonR_Connect_bytype_dfThresh, !(startsWith(NonR_Connect_bytype_dfThresh$roi,"EBr") | startsWith(NonR_Connect_bytype_dfThresh$roi,"FBl")) )

p12<-ggplot(NonR_Connect_bytype_dfThresh_NoLayers, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL Non R  Input/Output ROIs with #synapses after count thresholding at ",as.character(SynThresh),sep=""))
print(p12)
ggsave(paste(PlotDir, "F_NonR_ALLThresh2_NoLayers_","InOutRegions_perType.pdf",sep=""), plot = p12, device='pdf', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "F_NonR_ALLThresh2_NoLayers_","InOutRegions_perType.png",sep=""), plot = p12, device='png', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)

# Plot the Non Rs again, but only in EB
NonRneuron_Connect_bytype_dfThresh_EBLayers=filter(NonR_Connect_bytype_dfThresh, (startsWith(NonR_Connect_bytype_dfThresh$roi,"EB")))

p13<-ggplot(NonRneuron_Connect_bytype_dfThresh_EBLayers, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL Non R  Input/Output ROIs with #synapses after count thresholding at ",as.character(SynThresh),sep=""))
print(p13)
ggsave(paste(PlotDir, "F_NonR_ALLThresh2_EBLayers_","InOutRegions_perType.pdf",sep=""), plot = p13, device='pdf', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "F_NonR_ALLThresh2_EBLayers_","InOutRegions_perType.png",sep=""), plot = p13, device='png', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)

# Plot the Non Rs again, but only in FB
NonRneuron_Connect_bytype_dfThresh_FBLayers=filter(NonR_Connect_bytype_dfThresh, (startsWith(NonR_Connect_bytype_dfThresh$roi,"FB")))

p14<-ggplot(NonRneuron_Connect_bytype_dfThresh_FBLayers, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL Non R  Input/Output ROIs with #synapses after count thresholding at ",as.character(SynThresh),sep=""))
print(p14)
ggsave(paste(PlotDir, "F_NonR_ALLThresh2_FBLayers_","InOutRegions_perType.pdf",sep=""), plot = p14, device='pdf', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "F_NonR_ALLThresh2_FBLayers_","InOutRegions_perType.png",sep=""), plot = p14, device='png', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)

remove(list=c("p9","p10","p11","p12","p13","p14"))


```

































