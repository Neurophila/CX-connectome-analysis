---
title: "Analysis of anterior visual pathway: AOTU connectivity"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
#Analysis of mechanosensory information pathway coming into CX via R1 neurons

```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
library(neuprintrExtra)
library(igraph)
library(paletteer)
library(gridExtra)

options(nat.plotengine = 'rgl')
source("../R/visualizeConnectivityTables.R")
source("../R/SynapsePCAUtils.R")

getBodyIdsForList = function (neuronList,prefix="",postfix=".*",...){
  #' Get one dataframe of bodyIDs for all search strings in neuronList
  #' @param neuronList: A list of search strings to be passed.
  #' @param prefix: String to be added before each query (default "")
  #' @param postfix: String to be added after each query (default ".*")
  #' @param ...: Parameters to be passed to neuprint_search. Note that meta=FALSE won't work for now.
  #' @return A data frame of metadata for the results of all the queries
  #' @examples
  #' \dontrun{
  #' # Both will return the same
  #' getBodyIdsForList(c("PFL1","PFL2"))
  #' getBodyIdsForList(c("PFL1","PFL2"),postfix="",field="type")
  #' }
  
  neuronList <-  paste0(prefix,neuronList,postfix)
  bodiesList <- lapply(neuronList,neuprint_search,...)
  return(bind_rows(bodiesList))
}
```

```{r}
neuprint_login()
```

### AOTU046 to TB connectivity
```{r}
myNeurons = getBodyIdsForList(c("AOTU046","TuBu"))

conTab = getConnectionTable(myNeurons, "POST", by.roi = TRUE) 

conTab_AOTU2TB = conTab %>% 
  filter(type.from == "AOTU046" & supertype2.to == "TuBu" & roi %in% c("AOTU(R)","BU(R)"))
conTab_TB2AOTU = conTab %>% 
  filter(type.to == "AOTU046" & supertype2.from == "TuBu" & roi %in% c("AOTU(R)","BU(R)"))

roiTree = getRoiTree()
```

```{r}
typesTable <- getTypesTable(unique(conTab_AOTU2TB$databaseType.to))

# Subdivide types and build a custom types table
conTab_AOTU2TB = lateralize_types(conTab_AOTU2TB, postfix="to")
conTab_AOTU2TB = lateralize_types(conTab_AOTU2TB, postfix="from")
typesTable = lateralize_types(typesTable, postfix="raw")
conTabT2T_AOTU2TB = getTypeToTypeTable(conTab_AOTU2TB, typesTable = typesTable)


typesTable <- getTypesTable(unique(conTab_TB2AOTU$databaseType.to))

# Subdivide types and build a custom types table
conTab_TB2AOTU = lateralize_types(conTab_TB2AOTU, postfix="to")
conTab_TB2AOTU = lateralize_types(conTab_TB2AOTU, postfix="from")
typesTable = lateralize_types(typesTable, postfix="raw")
conTabT2T_TB2AOTU = getTypeToTypeTable(conTab_TB2AOTU, typesTable = typesTable)

```

```{r}
plotW = 10
plotH = 5

conMatPlot = plotConnectivityMatrix(conTabT2T_AOTU2TB, byGroup = "type","weightRelative", cmax=NULL)
conMatPlot = conMatPlot + xlab("Post-synaptic neuron")+ylab("Pre-synaptic neuron") +
  labs(fill="relative weight") + facet_grid(roi ~ .)
print(conMatPlot)

ggsave("AOTU46_2_TuBu_connectivity.pdf", plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",scale = 2, width = plotW, height =plotH, units ="cm", dpi = 600, limitsize = TRUE)

conMatPlot = plotConnectivityMatrix(conTabT2T_TB2AOTU, byGroup = "type","weightRelative", cmax=NULL)
conMatPlot = conMatPlot + xlab("Post-synaptic neuron")+ylab("Pre-synaptic neuron") +
  labs(fill="relative weight") + facet_grid(roi ~ .)
print(conMatPlot)

ggsave("TuBu_2_AOTU46_connectivity.pdf", plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",scale = 2, width = plotW, height =plotH, units ="cm", dpi = 600, limitsize = TRUE)
```

```{r}
myNeurons = getBodyIdsForList(c("ExR3","TuBu"))

conTab = getConnectionTable(myNeurons, "POST", by.roi = TRUE) 

conTab_AOTU2TB = conTab %>% 
  filter(type.from == "ExR3" & supertype2.to == "TuBu" & roi %in% c("BU(R)"))
conTab_TB2AOTU = conTab %>% 
  filter(type.to == "ExR3" & supertype2.from == "TuBu" & roi %in% c("BU(R)"))
```

```{r}
typesTable <- getTypesTable(unique(conTab_AOTU2TB$databaseType.to))

# Subdivide types and build a custom types table
conTab_AOTU2TB = lateralize_types(conTab_AOTU2TB, postfix="to")
conTab_AOTU2TB = lateralize_types(conTab_AOTU2TB, postfix="from")
typesTable = lateralize_types(typesTable, postfix="raw")
conTabT2T_AOTU2TB = getTypeToTypeTable(conTab_AOTU2TB, typesTable = typesTable)


typesTable <- getTypesTable(unique(conTab_TB2AOTU$databaseType.to))

# Subdivide types and build a custom types table
conTab_TB2AOTU = lateralize_types(conTab_TB2AOTU, postfix="to")
conTab_TB2AOTU = lateralize_types(conTab_TB2AOTU, postfix="from")
typesTable = lateralize_types(typesTable, postfix="raw")
conTabT2T_TB2AOTU = getTypeToTypeTable(conTab_TB2AOTU, typesTable = typesTable)

```

```{r}
plotW = 4
plotH = 3
cmax = 0.35 #NULL
conMatPlot = plotConnectivityMatrix(conTabT2T_AOTU2TB, byGroup = "type","weightRelative", cmax=cmax)
conMatPlot = conMatPlot + xlab("Post-synaptic neuron")+ylab("Pre-synaptic neuron") +
  labs(fill="relative weight") + facet_grid(roi ~ .)
print(conMatPlot)

ggsave("ExR3_2_TuBu_connectivity.pdf", plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",scale = 2, width = plotW+2, height =plotH, units ="cm", dpi = 600, limitsize = TRUE)

conMatPlot = plotConnectivityMatrix(conTabT2T_TB2AOTU, byGroup = "type","weightRelative", cmax=cmax)
conMatPlot = conMatPlot + xlab("Post-synaptic neuron")+ylab("Pre-synaptic neuron") +
  labs(fill="relative weight") + facet_grid(roi ~ .)
print(conMatPlot)

ggsave("TuBu_2_ExR3_connectivity.pdf", plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",scale = 2, width = plotH+2, height =plotW, units ="cm", dpi = 600, limitsize = TRUE)
```

### (0) Get some synapse locations
Choose ROI and get curated list of neurons
```{r}
myROI = "AOTU(R)"

saveName = paste0("MC_to_TB_in_", myROI)
my_types = c("TuBu") #This should be the post-synaptic partners
my_types = paste0(my_types, ".*")

my_neurons = getBodyIdsForList(my_types)
```

```{r}
cmapNames = c("RingNeurons", "TuBus", "columnar",  "ExR_and_AOTU46")

myColorMap <- read.csv(paste0("../colorMap_",cmapNames[1],".csv"))
if(length(cmapNames) > 1){
  for(cmapName in cmapNames[2:length(cmapNames)]){ 
    tmp = read.csv(paste0("../colorMap_",cmapName,".csv"))
    myColorMap <- full_join(myColorMap[c("Type", "Simpletype", "hex")], tmp[c("Type", "Simpletype","hex")])
    }
}
```

...use this list to get synapse locations
```{r}
my_synapses = neuprint_get_synapses(as.numeric(getBodyIdsForList(my_types)$bodyid),myROI)
# From the doc: A data frame, where each entry is a connection between the specified bodyid and its partner, either presynaptic to the bodyid (prepost=0) or postsynaptic (prepost=1). Each connection is associated with a synapse that has its own unique connector_id, XYZ coordinates and a confidence in its existence.
```

```{r}
my_synapses = my_synapses %>% mutate(
name=neuprint_get_meta(as.numeric(bodyid), all_segments = TRUE)[["name"]],
type=neuprint_get_meta(as.numeric(bodyid), all_segments = TRUE)[["type"]],
partnerName=neuprint_get_meta(as.numeric(partner), all_segments = TRUE)[["name"]],
partnertype=neuprint_get_meta(as.numeric(partner), all_segments = TRUE)[["type"]])
```

### (1) Import of ROI meshes and get vertices in x,y,z
```{r}
roiMesh = neuprint_ROI_mesh(myROI)
roiMeshPts = data.frame(dotprops(roiMesh)$points)
names(roiMeshPts) <- c("x","y","z")
```


### (2) Find convenient coordinate system based on PCA of vertices and center of mass of the ROI
***Transform mesh  and synapse locations***
```{r}
# define new origin from roi center of mass
origin = getCOM(roiMeshPts)

#reset orgin
roiMeshPts = resetOrigin(roiMeshPts, origin)

#get eigenvectors
roiEigen = covPCA(roiMeshPts)

roiMeshPtsRot = changeBasis(roiMeshPts, roiEigen)

#Synapse locations
synPts = data.frame(x=as.numeric(my_synapses$x),
                    y=as.numeric(my_synapses$y),
                    z=as.numeric(my_synapses$z))
synPts = resetOrigin(synPts, origin)
synPtsRot = changeBasis(synPts, roiEigen)

```

***Select either original or EV coordinates and rotate***
```{r}
rot = c(0,0, 0) #BU (45,180, 0) EB: (0,0,180) AOTU: (0,0,0)
flipx = 1
flipy = -1
flipz = 1

roiMeshPtsPlane = data.frame(x=roiMeshPtsRot$X,
                             y=roiMeshPtsRot$Y,
                             z=roiMeshPtsRot$Z)
synPtsPlane = data.frame(x=synPtsRot$X,
                             y=synPtsRot$Y,
                             z=synPtsRot$Z)
# rotate points
roiMeshPtsPlane = data.matrix(roiMeshPtsPlane)
synPtsPlane = data.matrix(synPtsPlane)

roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatXY(rot[1])
synPtsPlane = synPtsPlane %*% makeRotMatXY(rot[1])
roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatYZ(rot[2])
synPtsPlane = synPtsPlane %*% makeRotMatYZ(rot[2])
roiMeshPtsPlane = roiMeshPtsPlane %*% makeRotMatXZ(rot[3])
synPtsPlane = synPtsPlane %*% makeRotMatXZ(rot[3])

roiMeshPtsPlane = data.frame(x=flipx*roiMeshPtsPlane[,1],y=flipy*roiMeshPtsPlane[,2],z=flipz*roiMeshPtsPlane[,3])
synPtsPlane = data.frame(x=flipx*synPtsPlane[,1],y=flipy*synPtsPlane[,2],z=flipz*synPtsPlane[,3],
                         type = as.factor(my_synapses$type), 
                         partnerType = as.factor(my_synapses$partnertype),
                         name = as.factor(my_synapses$name), 
                         partnerName = as.factor(my_synapses$partnerName),
                         id = as.factor(my_synapses$bodyid),
                         partnerid = as.factor(my_synapses$partner),
                         prepost = as.factor(my_synapses$prepost))

#Add simple type name
synPtsPlane = synPtsPlane %>% mutate(simpleType = gsub("_.*", "",type))
```

```{r}
synCount = synPtsPlane %>% count(type)
typeFilter = synCount$type[synCount$n > 10]

# generate color map
dataFilt = synPtsPlane %>% filter(type %in% typeFilter)

myTypeCols = myColorMap %>% filter(Type %in% unique(dataFilt$simpleType)) %>% filter(Simpletype == "yes")
myTypeCols = myTypeCols[match(as.character(unique(dataFilt$simpleType)), myTypeCols$Type),] %>%
  arrange(unique(dataFilt$simpleType))

mySubtypeCols = myColorMap %>% filter(Type %in% unique(dataFilt$type)) %>% filter(Simpletype == "no")
mySubtypeCols = mySubtypeCols[match(as.character(unique(dataFilt$type)), mySubtypeCols$Type),] %>%
  arrange(unique(dataFilt$type))

```

### Look at synapse distributions of individual neurons

```{r}
require(alphahull)

if(myROI=="AOTU(R)"){
  alphaval = 120
}else{alphaval = 100}

# get outline
meshOutline <- ahull(x=roiMeshPtsPlane$x,y=roiMeshPtsPlane$y,alpha=alphaval)
outline_xy = data.frame(meshOutline$arcs)

meshOutline <- ahull(x=roiMeshPtsPlane$z,y=roiMeshPtsPlane$y,alpha=alphaval)
outline_zy = data.frame(meshOutline$arcs)

meshOutline <- ahull(x=roiMeshPtsPlane$x,y=roiMeshPtsPlane$z,alpha=alphaval)
outline_xz = data.frame(meshOutline$arcs)

```

3D plot
```{r}
post = 1
partnerType = "MC61"#"TuBu08"#
partnerSubset = getBodyIdsForList(paste0(c(partnerType),".*")) #  "TuBu", "ER"
focustype = "TuBu10"#"ER4d"# 
data = synPtsPlane %>% filter(partnerType %in% partnerSubset$type) %>% 
  filter(type %in% c(focustype) & prepost == post)

minConnections = data %>% group_by(id) %>% count() %>% filter(n >= 10)
data = data %>% filter(id %in% minConnections$id)

myids = unique(data$id)
mycols = paletteer_c("pals::ocean.phase", n=1+length(myids))[-1]

nclear3d()
for (i in seq(1,length(myids),1)){
  toplot = synPtsPlane%>%filter(id == myids[i]) %>% select(c('x','y','z'))
  if (! i %% 2){
    plot3d(toplot, col=mycols[i], add=TRUE,  size=5, alpha=0.4)
    plot3d(toplot %>% summarize_each(mean), col=mycols[i], size=10, add=TRUE)
  }
  plot3d(toplot %>% summarize_each(mean), col=mycols[i], size=8, add=TRUE)
}

plot3d(roiMeshPtsPlane, size=2, alpha=0.1, add=TRUE)
decorate3d(box=FALSE)
```


```{r, warning=FALSE}
perspective = "post"

prePartnerList =c("MC61","MC64") # c(paste0("TuBu0",seq(1,9)),"TuBu10")#
preGroup = "MC"
postPartnerList = getBodyIdsForList(my_types)
postPartnerList = unique(postPartnerList$type)#c(paste0("TuBu0",seq(1,9)),"TuBu10")
postGroup = "TuBu"

xrange = c(-5000, 2000)#c(-1500, 1000)
yrange = c(-3000, 4000)#c(-500, 1500)
zrange = c(-2000, 3000)#c(-800, 400)

for (post in seq(0,1)){
  if (perspective  == "pre"){
    partnertypelist = prePartnerList
  }else{
    partnertypelist = postPartnerList
  }
  for (partnertype in partnertypelist){ #
    #print(partnertype)
    #partnertype = "TuBu01"
    
    if (perspective  == "pre"){
      dataTypefilt = synPtsPlane %>% filter(partnerType == partnertype)
      focustypelist = postPartnerList
    }else{
      dataTypefilt = synPtsPlane %>% filter(type == partnertype)
      focustypelist = prePartnerList
    }
    
    for (focustype in focustypelist){
      savestring = paste0(partnertype,'_and_',focustype,"_per_",focustype)
      
      if (perspective  == "pre"){
        data = dataTypefilt %>% filter((type %in% c(focustype)) & (prepost == post)) %>%
          mutate(groupingvar = id)
      }else{
        data = dataTypefilt %>% filter((partnerType %in% c(focustype)) & (prepost == post)) %>%
          mutate(groupingvar = partnerid)
      }
      
      minConnections = data %>% group_by(groupingvar) %>% count() %>% filter(n >= 10)
      data = data %>% filter(groupingvar %in% minConnections$groupingvar)
      
      toplot_2D = data %>% mutate(groupingvar = as.character(groupingvar)) %>% select(c('x','y','z', 'groupingvar'))
      
      if(is_empty(unique(toplot_2D$groupingvar))){next}
      if(length((toplot_2D$groupingvar))<=10){ next}
      print(savestring)

      colPal = paletteer_c("pals::ocean.phase",n=1+length(unique(toplot_2D$groupingvar)))[-1]
        #polychrome: paletteer_d("Polychrome::palette36")[-2]
      
      xyproj <- ggplot(toplot_2D) + geom_point(aes(x=x, y=y, color=groupingvar, size=1, alpha=0.8)) + 
        geom_point(data=toplot_2D %>% group_by(groupingvar) %>% 
                     summarize_each(mean), aes(x=x, y=y, color=groupingvar, size=3)) +
        scale_color_manual(values = colPal, breaks = unique(toplot_2D$groupingvar)) + 
        geom_path(data=outline_xy, aes(x=c1, y=c2), size = 0.5)  +
        coord_fixed() + theme_void() + guides(size=FALSE, color=FALSE, alpha=FALSE) + lims(x=xrange,  y=yrange)
      
      zyproj <- ggplot(toplot_2D) + geom_point(aes(x=z, y=y, color=groupingvar, size=1, alpha=0.8)) + 
        geom_point(data=toplot_2D %>% group_by(groupingvar) %>% 
                     summarize_each(mean), aes(x=z,y=y, color=groupingvar, size=3)) +
        scale_color_manual(values = colPal, breaks = unique(toplot_2D$groupingvar)) + 
        geom_path(data=outline_zy, aes(x=c1, y=c2), size = 0.5) +
        coord_fixed() +theme_void() + guides(size=FALSE, color=FALSE, alpha=FALSE) + lims(x=zrange,  y=yrange)
      
      xzproj <- ggplot(toplot_2D) + geom_point(aes(x=x, y=z, color=groupingvar, size=1, alpha=0.8)) + 
        geom_point(data=toplot_2D %>% group_by(groupingvar) %>% 
                     summarize_each(mean), aes(x=x,y=z, color=groupingvar, size=3)) +
        scale_color_manual(values = colPal, breaks = unique(toplot_2D$groupingvar)) + 
        geom_path(data=outline_xz, aes(x=c1, y=c2), size = 0.5) +
        coord_fixed() +theme_void() + guides(size=FALSE, color=FALSE, alpha=FALSE) + lims(x=xrange,  y=zrange)
      
      projPlot <- grid.arrange(xyproj,zyproj,xzproj, nrow=1)
      
      if (post){
        ggsave(paste("synapseDistributions_",savestring,'_post_projection.pdf', sep=''),
                plot = projPlot, device='pdf', path = "../../neuprintR_analysis_plots/", 
                scale = 1, width = 60, height = 20, units ="cm", dpi = 600, useDingbats=FALSE)
      }else{
        ggsave(paste("synapseDistributions_",savestring,'_pre_projection.pdf', sep=''),
                plot = projPlot, device='pdf', path = "../../neuprintR_analysis_plots/", 
                scale = 1, width = 60, height = 20, units ="cm", dpi = 600, useDingbats=FALSE)
      }
     
    }
  }
}

```

### Quantification of convergence/divergence for a type-2-type connection

(a) From how many type A cells does a single type B cell get input?
(b) To how many type A cells does a single type B cell give input?

```{r, warning=FALSE}
prePartnerList = c("MC61","MC64")#c(paste0("TuBu0",seq(1,9)),"TuBu10")#
preGroup = "MC"#"TuBu"#
postPartnerList = getBodyIdsForList(my_types)
postPartnerList = c(paste0("TuBu0",seq(1,9)),"TuBu10")#unique(postPartnerList$type)#
postGroup = "TuBu"#"ER"#

conPattern = data.frame("focustype"=character(0), "partnertype"=character(0), "focustypeid"=character(0), "n_partners"=integer(0))
for (post in seq(0,1)){
  partnertypelist = prePartnerList

  for (partnertype in partnertypelist){ #
    #print(partnertype)
    #partnertype = "TuBu01"
    dataTypefilt = synPtsPlane %>% filter(partnerType == partnertype)
    focustypelist = c(postPartnerList, prePartnerList)
   
    for (focustype in focustypelist){
      if(post == 1){ direction = paste0(preGroup,"2",postGroup) }else{ direction = paste0(postGroup,"2",preGroup)}
      
      data = dataTypefilt %>% filter((type %in% c(focustype)) & (prepost == post)) %>%
          mutate(groupingvar = id)
      neuron2neuron = data %>% select(type, partnerType, id, partnerid, prepost) %>% group_by(id, partnerid) %>% mutate(nsyn =  length(prepost))
    
      neuron2neuron = unique(neuron2neuron)
      
      if(is_empty(unique(data$groupingvar))){next}
      #if(length((data$groupingvar))<=10){ next}
      #print(savestring)
      postFocus = neuron2neuron  %>% group_by(id) %>% summarize(n = length(prepost), s = sum(nsyn))
      tmpDF = data.frame("focustypeSyn"="post", "focustypeid"=postFocus$id, "n_partners"= postFocus$n,
                         "focustype" = focustype, "partnertype" = partnertype, syndir = direction, "syn"=postFocus$s)
      conPattern =  bind_rows(conPattern, tmpDF)
      
      preFocus = neuron2neuron  %>% group_by(partnerid) %>% summarize(n = length(prepost), s = sum(nsyn))
      tmpDF = data.frame("focustypeSyn"="pre", "focustypeid"=preFocus$partnerid, "n_partners"= preFocus$n,
                         "focustype" = partnertype, "partnertype" = focustype, syndir = direction, "syn"=preFocus$s)
      conPattern =  bind_rows(conPattern, tmpDF)
    }
  }
}

```

```{r}
# For MC -> TB
filtdat = conPattern %>% filter(focustypeSyn == "post")
postPlot <- ggplot(data=filtdat,aes(x=partnertype, y=n_partners, size = syn)) + 
  geom_boxplot(outlier.shape = NA,lwd=.3) + geom_jitter(width = 0.2, height = 0, aes(color=partnertype)) +
  scale_size(range=c(0,2)) +
  facet_grid(rows = vars(syndir), cols = vars(focustype), scales = "free_x",space='free_x') + theme_classic() + 
  theme(axis.text.x = element_text(angle = 90),text = element_text(size=8), axis.line = element_line(colour = 'black', size = .3)) +
  guides(color=FALSE) + labs(title = paste(postGroup, "gets input from..."))

filtdat = conPattern %>% filter(focustypeSyn == "pre")
myCM = myColorMap %>% filter(Type %in% unique(filtdat$partnertype))
myCM = myCM[match(as.character(unique(filtdat$partnertype)), myCM$Type),] %>% arrange(unique(filtdat$partnertype))
prePlot <- ggplot(data=filtdat,aes(x=partnertype, y=n_partners,size = syn)) + 
  geom_boxplot(outlier.shape = NA,lwd=.3) + geom_jitter(width = 0.2,height = 0, aes(color=partnertype)) + 
  scale_color_manual(values = as.character(myCM$hex)) + scale_size(range=c(0,2)) +
  facet_grid(rows = vars(syndir), cols = vars(focustype), scales = "free_x",space='free_x') + theme_classic()   +
  theme(axis.text.x = element_text(angle = 90), text = element_text(size=8), axis.line = element_line(colour = 'black', size = .3)) +
  guides(color=FALSE) + labs(title=paste(preGroup, "gives output to..."))

conPatternPlot <- grid.arrange(postPlot,prePlot, nrow=2) 

ggsave(paste("connectionPattern",preGroup,"_and_",postGroup,'.pdf', sep=''),
                plot = conPatternPlot, device='pdf', path = "../../neuprintR_analysis_plots/", 
                scale = 1, width = 20, height = 26, units ="cm", dpi = 600, useDingbats=FALSE) #height 12

```

```{r}
# For MC -> TB
selectDir = "MC2TuBu"
filtdat = conPattern %>% filter(focustypeSyn == "post" & syndir == selectDir)
postPlot <- ggplot(data=filtdat,aes(x=partnertype, y=n_partners,size = syn)) + 
  geom_boxplot(outlier.shape = NA,lwd=.3) + geom_jitter(width = 0.2, height = 0, aes(color=partnertype)) +
  facet_grid(cols = vars(focustype), scales = "free_x",space='free_x') + theme_classic() + 
  scale_size(range=c(0,2)) +
  theme(axis.text.x = element_text(angle = 90),text = element_text(size=8), axis.line = element_line(colour = 'black', size = .3)) +
  guides(color=FALSE) + labs(title = paste(postGroup, "gets input from..."))

filtdat = conPattern %>% filter(focustypeSyn == "pre" & syndir == selectDir)
prePlot <- ggplot(data=filtdat,aes(x=partnertype, y=n_partners,size = syn)) + 
  geom_boxplot(outlier.shape = NA,lwd=.3) + geom_jitter(width = 0.2,height = 0, aes(color=partnertype)) + 
  facet_grid(cols = vars(focustype), scales = "free_x",space='free_x') + theme_classic()   +
  scale_color_manual(values = as.character(myCM$hex)) + scale_size(range=c(0,2)) +
  theme(axis.text.x = element_text(angle = 90), text = element_text(size=8), axis.line = element_line(colour = 'black', size = .3)) +
  guides(color=FALSE) + labs(title=paste(preGroup, "gives output to..."))

conPatternPlot <- grid.arrange(postPlot,prePlot, nrow=2) #nrow-1

ggsave(paste("connectionPattern",preGroup,"_and_",postGroup,'_', selectDir,'.pdf', sep=''),
                plot = conPatternPlot, device='pdf', path = "../../neuprintR_analysis_plots/", 
                scale = 1, width = 20, height = 16, units ="cm", dpi = 600, useDingbats=FALSE) #height = 8

```
