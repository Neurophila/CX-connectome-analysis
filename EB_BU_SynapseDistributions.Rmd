---
title: "Notebook plotting synapse distributions for ring neurons in the BU and EB"
output:
  html_document:
    df_print: paged
---

### Command to clear environment is: rm(list = ls(all.names = TRUE))
### Command to update is remotes::update_packages('neuprintr')
### Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(plotly)
library(dplyr)
library(matlib)
options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose ROI and save/plot directories
```{r}

# The region of interest.
ROI="EB"  

# Directory to save data to.
SaveDir="Z:/Cx_Connectome/BradData/EB_Analysis/"

# Directory to save plots to.
PlotDir="Z:/Cx_Connectome/BradData/EB_Analysis/RingNeuronSynapseLocs/"

```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint server.
```{r}
neuprint_login()
```

### Get general functions
```{r}
source("inputOutputRegionsVis.r")
source("GetNeuronsInRoi.R")
source("SynapsePCAUtils.R")
```


### Get neurons in the ROI and
### Threshold neurons (need to agree on criteria and clean up code)
```{r}

# get all EB bodies
NamedBodies = Get_AllNeurons_InRoi(ROI, FALSE)

# Threshold based on weights (criteria needs to be agreed on)
PreMaxThresh=10
PostMaxThresh=10
Output <-  SynapseStats_And_Threshold(NamedBodies, SaveDir, PreMaxThresh, PostMaxThresh)
list2env(Output ,.GlobalEnv)
remove(Output)

```


### Get synapse distributions for all ring neurons
```{r}

# Get type name for all ring neurons
UniqueNamedBodies=as.character(unique(NamedBodies$bodytype))
RingNeuronTypes=UniqueNamedBodies[startsWith(unlist(UniqueNamedBodies), "R")]
RingNeuronBodies=filter(NamedBodies, startsWith(as.character(unlist(NamedBodies$bodytype)), "R") )

# Get all synapses for the ring neurons
RingNeuronSynsAll = RingNeuronBodies$bodyid %>% neuprint_get_synapses()
RingNeuronSynsAll = mutate(RingNeuronSynsAll, name=neuprint_get_meta(bodyid)$type,
                           x=as.numeric(x),y=as.numeric(y),z=as.numeric(z),prepost=as.logical(prepost))

# Get just those synapses in the EB and BU
RingNeuron_EBsyns =  neuprint_get_synapses(RingNeuronBodies$bodyid, roi = 'EB') 
RingNeuron_EBsyns = mutate(RingNeuron_EBsyns, name=neuprint_get_meta(bodyid)$type,
                           x=as.numeric(x),y=as.numeric(y),z=as.numeric(z),prepost=as.logical(prepost))
RingNeuron_BUsyns =  neuprint_get_synapses(RingNeuronBodies$bodyid, roi = 'BU(R)') 
RingNeuron_BUsyns = mutate(RingNeuron_BUsyns, name=neuprint_get_meta(bodyid)$type,
                           x=as.numeric(x),y=as.numeric(y),z=as.numeric(z),prepost=as.logical(prepost))


```


### Get ROIs and ROI coordinates
```{r}

# Get meshes for ROIs
ebMesh = neuprint_ROI_mesh("EB")
EBData=data.frame(x=ebMesh$vb[1,], y=ebMesh$vb[2,],z=ebMesh$vb[3,],name="EB")

buMesh = neuprint_ROI_mesh("BU(R)")
BUData=data.frame(x=buMesh$vb[1,], y=buMesh$vb[2,],z=buMesh$vb[3,],name="BU(R)")

RlalMesh = neuprint_ROI_mesh("LAL(R)")
RlaData=data.frame(x=RlalMesh$vb[1,], y=RlalMesh$vb[2,],z=RlalMesh$vb[3,],name="LAL(R)")


```


### Use PCA to get axes with the most variance and project the data onto 
### a plane defined by the first two PCs (with an optional rotation).
```{r}

# Perform PCA + rotation on ROI meshes to get new axes
EB_Axes=PCA_SynapseRoi(EBData, 0)
BU_Axes=PCA_SynapseRoi(BUData, 45)

# Project the synapse locations and meshes onto the new axes (no longer PCs if rotated)
RingNeuron_EBsyns_EBax=Project_NewCoordinates(RingNeuron_EBsyns, EB_Axes)
EBData_EBax=Project_NewCoordinates(EBData, EB_Axes)
RingNeuron_BUsyns_BUax=Project_NewCoordinates(RingNeuron_BUsyns, BU_Axes)
BUData_BUax=Project_NewCoordinates(BUData, BU_Axes)


```



# Get the ROI outlines in their new coordinate frame
```{r}

# Load libraries. Might have to install.packages("car") or install.packages("imager")
library(car)
library(imager)
library(reshape2)
library(zoo)
library(ggpubr)
library(ks)


# Load function
source("GetRoiMeshOutline.r")


# Get EB Mesh outline in x/y
OUTPUT=Get_MeshRoiOutline(EBData_EBax, 40, 3,"EB", DIM=c(1,2)) # Spacing=40, smooth=3 is good
list2env(OUTPUT ,.GlobalEnv)
remove(OUTPUT)
EB_Ring1=EdgesOrdered1_OUT %>% mutate(name="EB1")
EB_Ring2=EdgesOrdered2_OUT %>% mutate(name="EB2")
remove(list=c("EdgesOrdered","EdgesOrdered1_OUT","EdgesOrdered2_OUT"))


# Get BU Mesh in x/y
OUTPUT=Get_MeshRoiOutline(BUData_BUax, 40, 3,"BU", DIM=c(1,2)) # Spacing=40, smooth=3 is good
list2env(OUTPUT ,.GlobalEnv)
remove(OUTPUT)
BU_Outline=EdgesOrdered1_OUT %>% mutate(name="BU(R)")
remove(list=c("EdgesOrdered","EdgesOrdered1_OUT","EdgesOrdered2_OUT"))


# Plot the synapses and the ROI outlines in same plot to make sure they are in the same coordinates
ggplot()  + geom_point(data=RingNeuron_BUsyns_BUax, aes(x = x, y = -y, color=name)) +  geom_polygon(data=BU_Outline, aes(x = x, y = -y), colour='black', fill=NA)

ggplot()  + geom_point(data=RingNeuron_EBsyns_EBax, aes(x = x, y = -y, color=name)) +  geom_polygon(data=EB_Ring1, aes(x = x, y = -y), colour='black', fill=NA) +  geom_polygon(data=EB_Ring2, aes(x = x, y = -y), colour='black', fill=NA)



```


### Make plots of 2D synapse distributions for BU and EB
```{r}


# Get just the synapses in the BU
RingNeuronSynsAll_BU=filter(RingNeuronSynsAll,pointsinside(RingNeuronSynsAll,RbuMesh))

# Get average synapses in BU per type
SynsPerType=RingNeuronSynsAll_BU %>% group_by(name) %>% summarize(n=n())
SynsPerType=filter(SynsPerType,n>10)

# filter BU synapses by type
RingNeuronSynsAll_BU=filter(RingNeuronSynsAll_BU,name %in% SynsPerType$name)

# Smooth BU outline
BU_Outline_Smooth=data.frame(x = rollmean(BU_Outline$x,8),
                             y = rollmean(BU_Outline$y,8),
                             z = rollmean(BU_Outline$z,8))

# Get max and min synapse positions, since clipping doesnt work well.
Extra=500
XLIM=c( min(c(RingNeuronSynsAll_BU$x))-Extra , max(c(RingNeuronSynsAll_BU$x))+Extra )
YLIM=c( min(c(RingNeuronSynsAll_BU$y))-Extra , max(c(RingNeuronSynsAll_BU$y))+Extra )
ZLIM=c( min(c(-RingNeuronSynsAll_BU$z))-Extra , max(c(-RingNeuronSynsAll_BU$z))+Extra )


# For each ring neuron type, plot synapse distribution in BU 
# Not this excludes synapses that are just outside the bulb since the ROI isnt perect.
for (nnn in 1:length(unique(RingNeuronSynsAll_BU$name)) ){
  ToPlotSyns=subset(RingNeuronSynsAll_BU, RingNeuronSynsAll_BU$name == sort(unique(RingNeuronSynsAll_BU$name))[nnn] )
  
  ppp=ggplot()  + geom_polygon(data=BU_Outline_Smooth, aes(x = x, y = -z), colour='black', fill=NA, size = 0.75 ) +
    geom_hex(data=ToPlotSyns, aes(x = x, y = -z), bins=50 ) + 
    scale_fill_gradientn(colors = brewer.pal(3,"Blues"), breaks=c(0,15), limits=c(0, 15), oob = scales::squish) +
    xlim(XLIM[1], XLIM[2]) + ylim(ZLIM[1], ZLIM[2]) + ggtitle(sort(unique(RingNeuronSynsAll_BU$name))[nnn]) +
    theme_void() + theme(legend.position="none")
  
  eval(parse(text=paste("ppp_",as.character(nnn),"=ppp",sep="")))
  
  ggsave(paste(PlotDir, "BUr_RingNeuronSynDistribution_",sort(unique(RingNeuronSynsAll_BU$name))[nnn],".png",sep=""),
         plot = ppp, device='png', scale = 1, width = 8, height = 7, units ="in", dpi = 600, limitsize = TRUE)
  remove(ppp)
  
}


# Plot every ring neuron arranged on a grid
ppp=ggarrange(ppp_1, ppp_2, ppp_3, ppp_4, ppp_5, ppp_6, ppp_7, ppp_8, ppp_9, ppp_10 , ppp_11,
          ppp_12, ppp_13, ppp_14, ppp_15, ppp_16, ppp_17, ppp_18,
          ncol = 6, nrow = 3)
ggsave(paste(PlotDir, "BUr_RingNeuronSynDistribution_ALL",".png",sep=""),
         plot = ppp, device='png', scale = 1, width = 12, height = 7, units ="in", dpi = 600, limitsize = TRUE)


# Plot all ring neurons synapses overlayed
ggplot() + geom_density_2d( data=RingNeuronSynsAll_BU, aes(x=x, y=-z, color=factor(name) ) )  +
  geom_polygon(data=BU_Outline, aes(x = x, y = -z), colour='black', fill=NA, size = 1 )


# Get 95% contour and plot all on one plot
for (nnn in 1:length(unique(RingNeuronSynsAll_BU$name)) ){
  
  ToPlotSyns=subset(RingNeuronSynsAll_BU, RingNeuronSynsAll_BU$name == sort(unique(RingNeuronSynsAll_BU$name))[nnn] )
  
  
  # Get synapse 99% contour, but this seems to only work well for gaussian-like distributions
  d <- data.frame(x=ToPlotSyns$x,y=ToPlotSyns$z)
  kd <- ks::kde(d, compute.cont=TRUE, bgridsize=c(15,15))
  contour_95 <- with(kd, contourLines(x=eval.points[[1]], y=eval.points[[2]], z=estimate, levels=cont["5%"])[[1]])
  contour_95 <- data.frame(contour_95)
  contour_95$name=sort(unique(RingNeuronSynsAll_BU$name))[nnn]
  
  ppp = ggplot() + geom_polygon(data=BU_Outline_Smooth, aes(x = x, y = -z), colour='black', fill=NA, size = 0.75 ) +
    geom_hex(data=ToPlotSyns, aes(x = x, y = -z), bins=50 ) + 
    geom_polygon(data=contour_95, aes(x=x, y=-y), colour='red', fill=NA, size = 0.5) +
    scale_fill_gradientn(colors = brewer.pal(3,"Blues"), breaks=c(0,15), limits=c(0, 15), oob = scales::squish) +
    xlim(XLIM[1], XLIM[2]) + ylim(ZLIM[1], ZLIM[2]) + ggtitle(sort(unique(RingNeuronSynsAll_BU$name))[nnn]) +
    theme_void() + theme(legend.position="none") 
  
  eval(parse(text=paste("ppp_",as.character(nnn),"=ppp",sep="")))
  
  ggsave(paste(PlotDir, "BUr_RingNeuronSynDistribution_Contour_",sort(unique(RingNeuronSynsAll_BU$name))[nnn],".png",sep=""),
         plot = ppp, device='png', scale = 1, width = 8, height = 7, units ="in", dpi = 600, limitsize = TRUE)
  remove(ppp)
  
  if (nnn==1){
    ContourAll=contour_95
  } else {
    ContourAll=rbind(ContourAll,contour_95)
  }
}


# Plot every ring neuron arranged on a grid with contour
ppp=ggarrange(ppp_1, ppp_2, ppp_3, ppp_4, ppp_5, ppp_6, ppp_7, ppp_8, ppp_9, ppp_10 , ppp_11,
          ppp_12, ppp_13, ppp_14, ppp_15, ppp_16, ppp_17, ppp_18,
          ncol = 6, nrow = 3)
ggsave(paste(PlotDir, "BUr_RingNeuronSynDistribution_Contour_ALL",".png",sep=""),
         plot = ppp, device='png', scale = 1, width = 12, height = 7, units ="in", dpi = 600, limitsize = TRUE)



ppp=ggplot() + geom_polygon(data=BU_Outline_Smooth, aes(x = x, y = -z), colour='black', fill=NA, size = 0.75 ) + 
  geom_polygon(data=ContourAll, aes(x=x, y=-y,color=name, fill = name), alpha=0.05) + theme_bw()
ggsave(paste(PlotDir, "BUr_RingNeuronSynDistribution_75percent",".png",sep=""),
         plot = ppp, device='png', scale = 1, width = 8, height = 7, units ="in", dpi = 600, limitsize = TRUE)




```

















