---
title: "Notebook plotting synapse distributions for ring neurons in the BU and EB"
output:
  html_document:
    df_print: paged
---

### Command to clear environment is: rm(list = ls(all.names = TRUE))
### Command to update is remotes::update_packages('neuprintr')
### Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(plotly)
library(dplyr)
library(matlib)
options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose ROI and save/plot directories
```{r}

# The region of interest.
ROI="EB"  

# Directory to save data to.
SaveDir="Z:/Cx_Connectome/BradData/EB_Analysis/"

# Directory to save plots to.
PlotDir="Z:/Cx_Connectome/BradData/EB_Analysis/RingNeuronSynapseLocs/"

```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint server.
```{r}
neuprint_login()
```

### Get general functions and load libraries
```{r}
source("inputOutputRegionsVis.r")
source("GetNeuronsInRoi.R")
source("SynapsePCAUtils.R")
source("GetRoiMeshOutline.r")
library(car)
library(imager)
library(reshape2)
library(zoo)
library(ggpubr)
library(ks)
library(RColorBrewer)

```


### Get neurons in the ROI and
### Threshold neurons (need to agree on criteria and clean up code)
```{r}

# get all EB bodies
NamedBodies = Get_AllNeurons_InRoi(ROI, FALSE)

# Threshold based on weights (criteria needs to be agreed on)
PreMaxThresh=10
PostMaxThresh=10
Output <-  SynapseStats_And_Threshold(NamedBodies, SaveDir, PreMaxThresh, PostMaxThresh)
list2env(Output ,.GlobalEnv)
remove(Output)

```


### Get synapse distributions for all ring neurons
```{r}

# Get type name for all ring neurons
UniqueNamedBodies=as.character(unique(NamedBodies$bodytype))
RingNeuronTypes=UniqueNamedBodies[startsWith(unlist(UniqueNamedBodies), "R")]
RingNeuronBodies=filter(NamedBodies, startsWith(as.character(unlist(NamedBodies$bodytype)), "R") )

# Get all synapses for the ring neurons
RingNeuronSynsAll = RingNeuronBodies$bodyid %>% neuprint_get_synapses()
RingNeuronSynsAll = mutate(RingNeuronSynsAll, name=neuprint_get_meta(bodyid)$type,
                           x=as.numeric(x),y=as.numeric(y),z=as.numeric(z),prepost=as.logical(prepost))

# Get just those synapses in the EB and BU
RingNeuron_EBsyns =  neuprint_get_synapses(RingNeuronBodies$bodyid, roi = 'EB') 
RingNeuron_EBsyns = mutate(RingNeuron_EBsyns, name=neuprint_get_meta(bodyid)$type,
                           x=as.numeric(x),y=as.numeric(y),z=as.numeric(z),prepost=as.logical(prepost))
RingNeuron_BUsyns =  neuprint_get_synapses(RingNeuronBodies$bodyid, roi = 'BU(R)') 
RingNeuron_BUsyns = mutate(RingNeuron_BUsyns, name=neuprint_get_meta(bodyid)$type,
                           x=as.numeric(x),y=as.numeric(y),z=as.numeric(z),prepost=as.logical(prepost))


```


### Get average number of synapses per type and filter 
```{r}

MinSyns=10

# Get average synapses in EB per type and filter
SynsPerType_EB=RingNeuron_EBsyns %>% group_by(name) %>% summarize(n=n())
SynsPerType_EB=filter(SynsPerType_EB,n>10)
RingNeuron_EBsyns=filter(RingNeuron_EBsyns,name %in% SynsPerType_EB$name)

# Get average synapses in BU per type and filter
SynsPerType_BU=RingNeuron_BUsyns %>% group_by(name) %>% summarize(n=n())
SynsPerType_BU=filter(SynsPerType_BU,n>10)
RingNeuron_BUsyns=filter(RingNeuron_BUsyns,name %in% SynsPerType_BU$name)


```


### Get ROIs and ROI coordinates
```{r}

# Get meshes for ROIs
ebMesh = neuprint_ROI_mesh("EB")
EBData=data.frame(x=ebMesh$vb[1,], y=ebMesh$vb[2,],z=ebMesh$vb[3,],name="EB")

buMesh = neuprint_ROI_mesh("BU(R)")
BUData=data.frame(x=buMesh$vb[1,], y=buMesh$vb[2,],z=buMesh$vb[3,],name="BU(R)")

RlalMesh = neuprint_ROI_mesh("LAL(R)")
RlaData=data.frame(x=RlalMesh$vb[1,], y=RlalMesh$vb[2,],z=RlalMesh$vb[3,],name="LAL(R)")


```


### Use PCA to get axes with the most variance and project the data onto 
### a plane defined by the first two PCs (with an optional rotation).
```{r}

# Perform PCA + rotation on ROI meshes to get new axes
EB_Axes=PCA_SynapseRoi(EBData, 0)
BU_Axes=PCA_SynapseRoi(BUData, 45)

# Project the synapse locations and meshes onto the new axes (no longer PCs if rotated)
RingNeuron_EBsyns_EBax=Project_NewCoordinates(RingNeuron_EBsyns, EB_Axes)
EBData_EBax=Project_NewCoordinates(EBData, EB_Axes)
RingNeuron_BUsyns_BUax=Project_NewCoordinates(RingNeuron_BUsyns, BU_Axes)
BUData_BUax=Project_NewCoordinates(BUData, BU_Axes)


```



# Get the ROI outlines in their new coordinates
```{r}


# Get EB Mesh outline in x/y
OUTPUT=Get_MeshRoiOutline(EBData_EBax, 40, 3,"EB", DIM=c(1,2)) # Spacing=40, smooth=3 is good
list2env(OUTPUT ,.GlobalEnv)
remove(OUTPUT)
EB_Ring1=EdgesOrdered1_OUT %>% mutate(name="EB1")
EB_Ring2=EdgesOrdered2_OUT %>% mutate(name="EB2")
remove(list=c("EdgesOrdered","EdgesOrdered1_OUT","EdgesOrdered2_OUT"))


# Get EB Mesh outline in x/z (Not used at the moment, but might be useful later)
OUTPUT=Get_MeshRoiOutline(EBData_EBax, 6, 21,"EB", DIM=c(1,3)) # Spacing=40, smooth=3 is good
list2env(OUTPUT ,.GlobalEnv)
remove(OUTPUT)


# Get BU Mesh in x/y
OUTPUT=Get_MeshRoiOutline(BUData_BUax, 40, 3,"BU", DIM=c(1,2)) # Spacing=40, smooth=3 is good
list2env(OUTPUT ,.GlobalEnv)
remove(OUTPUT)
BU_Outline=EdgesOrdered1_OUT %>% mutate(name="BU(R)")
remove(list=c("EdgesOrdered","EdgesOrdered1_OUT","EdgesOrdered2_OUT"))


# Plot the synapses and the ROI outlines in same plot to make sure they are in the same coordinates
ggplot()  + geom_point(data=RingNeuron_BUsyns_BUax, aes(x = x, y = -y, color=name)) +  geom_polygon(data=BU_Outline, aes(x = x, y = -y), colour='black', fill=NA)

ggplot()  + geom_point(data=RingNeuron_EBsyns_EBax, aes(x = x, y = -y, color=name)) +  geom_polygon(data=EB_Ring1, aes(x = x, y = -y), colour='black', fill=NA) +  geom_polygon(data=EB_Ring2, aes(x = x, y = -y), colour='black', fill=NA)



```


### Make plots of 2D synapse distributions for BU and EB
```{r}

# To Do:
# 0) 2D plots of ring neurons with LAL synapses
# 1) Improve getting outline of data and get it to work with ring neurons in EB
# 2) Look at synapse distributions in BU in Z
# 3) Look at synapse distributions in cross section of EB


# Make plots for BU 
Cmax=25 # Max for color bar
ROI_Name="BUr"

Output=PlotSynapseDistributions(RingNeuron_BUsyns_BUax, BU_Outline, BU_Outline, ROI_Name , Cmax, PlotDir)
list2env(Output ,.GlobalEnv)
remove(Output)

ppp=ggarrange(plotlist=PlotHandles1, ncol = length(PlotHandles1)/3, nrow = length(PlotHandles1)/6)
ggsave(paste(PlotDir, ROI_Name, "_RingNeuronSynDistribution_NoContour_ALL",".png",sep=""),
       plot = ppp, device='png', scale = 1, width = 12, height = 7, units ="in", dpi = 600, limitsize = TRUE)

ppp=ggarrange(plotlist=PlotHandles2, ncol = length(PlotHandles2)/3, nrow = length(PlotHandles2)/6)
ggsave(paste(PlotDir, ROI_Name, "_RingNeuronSynDistribution_Contour_ALL",".png",sep=""),
       plot = ppp, device='png', scale = 1, width = 12, height = 7, units ="in", dpi = 600, limitsize = TRUE)



# Make plots for BU 
Cmax=100 # Max for color bar
ROI_Name="EB"

Output=PlotSynapseDistributions(RingNeuron_EBsyns_EBax, EB_Ring1, EB_Ring2, ROI_Name , Cmax, PlotDir)
list2env(Output ,.GlobalEnv)
remove(Output)

ppp=ggarrange(plotlist=PlotHandles1, ncol = length(PlotHandles1)/3, nrow = length(PlotHandles1)/6)
ggsave(paste(PlotDir, ROI_Name, "_RingNeuronSynDistribution_NoContour_ALL",".png",sep=""),
       plot = ppp, device='png', scale = 1, width = 12, height = 7, units ="in", dpi = 600, limitsize = TRUE)

ppp=ggarrange(plotlist=PlotHandles2, ncol = length(PlotHandles2)/3, nrow = length(PlotHandles2)/6)
ggsave(paste(PlotDir, ROI_Name, "_RingNeuronSynDistribution_Contour_ALL",".png",sep=""),
       plot = ppp, device='png', scale = 1, width = 12, height = 7, units ="in", dpi = 600, limitsize = TRUE)


# Make plots of all neurons
ggplot(RingNeuron_BUsyns_BUax, aes(x=x, y=-y, fill=name)) +
  stat_density_2d(aes(alpha = 0.00001 ),bins=5, geom = "polygon") +
  facet_grid(cols=vars(post)) + theme_classic() + xlim(500, 5000) + ylim(-1500, 1500) #+ guides(color=FALSE)






plot_data=RingNeuron_BUsyns_BUax[,c(3,4,9)]
colnames(plot_data) <- c("X","Y","Label")
plot_data$Label=as.factor(plot_data$Label)


#Genrate the kernel density for each group
newplot_data <- plot_data %>% group_by(Label) %>% do(Dens=kde2d(.$X, .$Y, h=20, n=250, lims=c(XLIM,-YLIM)))

#Transform the density in  data.frame
newplot_data  %<>%  do(Label=.$Label, V=expand.grid(.$Dens$x,.$Dens$y), Value=c(.$Dens$z)) %>% do(data.frame(Label=.$Label,x=.$V$Var1, y=.$V$Var2, Value=.$Value))

Thresh=quantile(newplot_data$Value, c(0.7)) 
newplot_data$Value[newplot_data$Value>Thresh]<-1
newplot_data$Value[newplot_data$Value<=Thresh]<-0

ggplot()  + geom_polygon(data=ROI_Outline1, aes(x = x, y = -y), colour='black', fill=NA, size = 0.75 ) +
  geom_polygon(data=ROI_Outline2, aes(x = x, y = -y), colour='black', fill=NA, size = 0.75 ) +
  stat_contour(data=newplot_data, aes(x=x, y=-y, z=Value, fill=Label), geom="polygon", alpha=0.05)
    

```

















