---
title: "Gall, Rob, Rub"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
library(plotly)
library(paletteer)
library(igraph)
library(neuprintrExtra)
library(gridExtra)
options(nat.plotengine = 'rgl')

source(file.path("..","R","visualizeConnectivityTables.R"))
source(file.path("..","R","paperTheme.R"))

neuprint_login()
```

This notebook generates the following figure panels:
* Figure 56D, F
* Figure 56 figure supplement 1A

# Make ROI selection
```{r}
roiTree = getRoiTree()
slctROIs = selectRoiSet(roiTree, default_level = 1, 
                        exceptions = list("OL(R)"=1,"AL(R)"=1,"PENP"=1,"AL(L)"=1,"MB(+ACA)(R)"=1,"MB(L)"=1,
                                          "VMNP"=1,"INP"=2, "LX(R)"=3, "LX(L)"=3), exceptionLevelMatch = 1)

GallPlusROIs = c("CRE(R)","CRE(L)","LAL(-GA)(R)","GA(R)","LAL(L)") 
```

## Generate summary of all neurons that make connections in gall, then select subset
```{r}
gaTable = getTypesInRoiTable("GA(R)", minTypePercentage = 0.5)
```

```{r}
allGAneurons <-  unique(c(gaTable$outputs$databaseType.from,gaTable$inputs$databaseType.to))
gapre = getBodyIdsForList(unique(gaTable$outputs$databaseType.from))
gapost = getBodyIdsForList(unique(gaTable$inputs$databaseType.from))
```

```{r}
myConnections_out = getConnectionTable(gapre$bodyid, "POST", by.roi = TRUE) %>% filter(roi == "GA(R)") 
myConnections_in = getConnectionTable(gapost$bodyid, "POST", by.roi = TRUE) %>% filter(roi == "GA(R)") 

myConnections = unique(bind_rows(myConnections_out,myConnections_in))

typesTable <- getTypesTable(unique(myConnections$databaseType.to))
# Subdivide types and build a custom types table
myConnections = lateralize_types(myConnections, postfix="to")
myConnections = lateralize_types(myConnections, postfix="from")
typesTable = lateralize_types(typesTable, postfix="raw")

myConnectionsT2T = getTypeToTypeTable(myConnections,typesTable = typesTable)
```

```{r}
conMatPlot <-  plotConnectivity(myConnections, 
                              grouping =  "bodyid",
                              facetInputs = "type.from",
                              facetOutputs = "type.to",
                              legendName = "relative weight",
                              theme = theme_paper_rects(strip.placement="outside"),
                              switch = "both",
                              xaxis="outputs",
                              flipy_facet=T
                              ) +theme(
                                strip.text.x=element_text(angle=90),
                                strip.text.y.left=element_text(angle=0),
                                                        axis.ticks.x=element_blank(),
                                                        axis.ticks.y=element_blank()
                                                       )
conMatPlot
```

Plot connectivity matrix in **Figure 56 figure supplement 1A**
```{r}
connectionMeasure = "weightRelative"
preName = "gall selection"
postName = preName
saveName = ""
saveName = paste0(saveName,"_LR")
roiName = "allGAr"

conMatPlot = plotConnectivityMatrix(myConnections, byGroup = "id", connectionMeasure, cmax=NULL)
conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)
conMatPlot = structureMatrixPlotByType_lines(conMatPlot)
print(conMatPlot)
ggsave("connectivityMatrix_allGAconnections_connectionMeasure_byID.pdf", plot = conMatPlot, device='pdf', path = "..",
  scale = 2, width = 14, height =10, units ="cm", dpi = 600, limitsize = TRUE)
```

Since the Gall is a badly defined region, we can't easily collect neurons that go to the Gall based in the EM ROI. For **Figure 56 D** we selected a subset of neurons that we consider as arborizing in the gall.
```{r}
gallSlctTypes =  c("EPG","PEG","EL","PFG","ER6")
gallSlctIDs = getBodyIdsForList(gallSlctTypes)
pre = gallSlctIDs$bodyid
post = pre

gasavename = "selctGallTypes_small"

myConnections = getConnectionTable(pre, "POST", by.roi = TRUE)
myConnections = myConnections %>% filter(to %in% post) 

myConnections = myConnections %>% filter(roi %in% GallPlusROIs) %>% filter(roi != "CX")

# combine data from all ROIs
myConnectionsCombo = combineRois(myConnections,unique(myConnections$roi),'nonCx')

# Subdivide types and build a custom types table
myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="to")
myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="from")
```

```{r}
typesTable <- getTypesTable(unique(myConnectionsCombo$databaseType.to))
# Subdivide types and build a custom types table
myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="to")
myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="from")
typesTable = lateralize_types(typesTable, postfix="raw")

myConnectionsT2T = getTypeToTypeTable(myConnectionsCombo,typesTable = typesTable)
```

plot the connectivity matrix (used in **Figure 56 D**)
```{r}
plotW = 13# 45 # 20
plotH = 11 #4 #40  #17
cmax = NULL
connectionMeasure = "weightRelative"
preName = "gall selection"
postName = preName
saveName = ""
saveName = paste0(saveName,"_LR")
roiName = "nonCX_gallTypes"
  
conMatPlot = plotConnectivityMatrix(myConnectionsCombo, byGroup = "id", connectionMeasure, cmax)
conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)
conMatPlot = structureMatrixPlotByType_lines(conMatPlot)
print(conMatPlot)
ggsave( paste("../connectivityMatrix_",gasavename,'in_',roiName,'_',connectionMeasure,'_byID.pdf', sep=''), plot = conMatPlot, device='pdf', path = "..", scale = 1.5, width = plotW*0.8, height = plotH*0.8, units ="cm", dpi = 600, limitsize = TRUE)
```


###  Draw connectivity graphs 

```{r, warning=FALSE} 
connectionMeasures = c("weightRelative","weightROIRelativeTotal")
connectionMeasure = connectionMeasures[1]
cutoff = 0.05 # for weight 0.05, 0.01, 0
selfFeedbackScale = 10
edcurve = 0.1
edgeNorm = 0.07

# Graph parameter
vertexSize = 12
plotSize = 10
selfFBscale = vertexSize
arrowSize = 0.8
```

Graph with defined colormap from file
```{r, warning=FALSE} 
cmapNames = c("RingNeurons", "TuBus", "columnar",  "ExR_and_AOTU46")

myColorMap <- read.csv(file.path("..","colormaps",paste0("colorMap_",cmapNames[1],".csv")))
if(length(cmapNames) > 1){
  for(cmapName in cmapNames[2:length(cmapNames)]){ 
    tmp = read.csv(file.path("..","colormaps",paste0("colorMap_",cmapName,".csv")))
    myColorMap <- full_join(myColorMap[c("Type", "Simpletype", "hex")], tmp[c("Type", "Simpletype","hex")])
    }
}
myColorMap_R = myColorMap %>% mutate(Type = paste0(Type, "_R"))
myColorMap_L = myColorMap %>% mutate(Type = paste0(Type, "_L"))
myColorMap= bind_rows(myColorMap_L, myColorMap_R)

myColorMap = myColorMap %>% filter(Simpletype == "no")
# drop na in "to" column
myConnectionsT2T = myConnectionsT2T %>% filter(databaseType.to !="EPGt") %>% filter(databaseType.from !="EPGt") %>% drop_na(type.to)
graphData = data.frame(from = myConnectionsT2T$type.from, to = myConnectionsT2T$type.to, relWeight = myConnectionsT2T$weightRelative)

graphData_noSelf = getNoSelfGraphData(graphData)  
graphData_self = getSelfFBGraphData(graphData)

graphName = saveName


myGraph = constructConnectivityGraph(graphData, cutoff, vertexSize, selfFBscale, arrowSize, edgeNorm, colormap = myColorMap)

l = layout_with_fr(myGraph)#layout_with_dh(myGraph)#

myGraph$main = paste0("Connectivity within the gall(R) ")
plot(myGraph,edge.curved=edcurve, layout=l, edge.color = customizeGraphEdges(myGraph))

dev.print(pdf, paste0("../connectivityGraph_",graphName,'_in_GAr',"_",connectionMeasure, round(100*cutoff),"perc_custCol.pdf"), width=plotSize, height=plotSize)
```

Connectivity between PEG, ER6, EL and EPGs in the EB
```{r}
myConnections = getConnectionTable(pre, "POST", slctROI = "EB")
myConnections = myConnections %>% filter(to %in% post) 

typesTable <- getTypesTable(unique(myConnections$databaseType.to))
# Subdivide types and build a custom types table
myConnections = lateralize_types(myConnections, postfix="to")
myConnections = lateralize_types(myConnections, postfix="from")
typesTable = lateralize_types(typesTable, postfix="raw")

myConnectionsT2T = getTypeToTypeTable(myConnections,typesTable = typesTable)
```

Graph with defined colormap from file
```{r, warning=FALSE} 
myColorMap = myColorMap %>% filter(Simpletype == "no")
# drop na in "to" column
myConnectionsT2T = myConnectionsT2T %>% filter(databaseType.to !="EPGt") %>% filter(databaseType.from !="EPGt") %>% drop_na(type.to)
graphData = data.frame(from = myConnectionsT2T$type.from, to = myConnectionsT2T$type.to, relWeight = myConnectionsT2T$weightRelative)

graphData_noSelf = getNoSelfGraphData(graphData)  
graphData_self = getSelfFBGraphData(graphData)
graphName = saveName

myGraphEB = constructConnectivityGraph(graphData, cutoff, vertexSize, selfFBscale, arrowSize, edgeNorm, colormap = myColorMap)

l = layout_with_fr(myGraphEB)

myGraphEB$main = paste0("Connectivity within the EB")
plot(myGraphEB,edge.curved=edcurve, layout=l, edge.color = customizeGraphEdges(myGraphEB))

dev.print(pdf, paste0("../connectivityGraph_",graphName,'_in_EB_',connectionMeasure, round(100*cutoff),"perc_custCol.pdf"), width=plotSize, height=plotSize)
```




# Visulaze small neuropiles (not used in figure)
```{r}
gaMesh = neuprint_ROI_mesh("GA(R)")
gaMeshPts = data.frame(dotprops(gaMesh)$points)
names(gaMeshPts) <- c("x","y","z")

ruMesh = neuprint_ROI_mesh("RUB(R)")
ruMeshPts = data.frame(dotprops(ruMesh)$points)
names(ruMeshPts) <- c("x","y","z")

roMesh = neuprint_ROI_mesh("ROB(R)")
roMeshPts = data.frame(dotprops(roMesh)$points)
names(roMeshPts) <- c("x","y","z")

ebMesh = neuprint_ROI_mesh("EB")
ebMeshPts = data.frame(dotprops(ebMesh)$points)
names(ebMeshPts) <- c("x","y","z")

laMesh = neuprint_ROI_mesh("LAL(-GA)(R)")
laMeshPts = data.frame(dotprops(laMesh)$points)
names(laMeshPts) <- c("x","y","z")

```

Example neurons
```{r}
# single neuron selection
EPGexample = neuprint_read_skeletons(696362840)
ELexample = neuprint_read_skeletons(912596952)
PEGsexample = neuprint_read_skeletons(788461444)
PFRaexample = neuprint_read_skeletons(819828716) #PFR_b(PB11b)_L4_C5
FRexample = neuprint_read_skeletons(356670712)  #FR2(FQ4)_C4_L_small

```

```{r}
# group selection

EPGexample = neuprint_read_skeletons(neuprint_search("EPG.*_L.*",meta = FALSE))
ELexample = neuprint_read_skeletons(neuprint_search("EL.*_L.*",meta = FALSE))
PFGsexample = neuprint_read_skeletons(neuprint_search("PFGs.*_L.*",meta = FALSE))
PFRaexample = neuprint_read_skeletons(neuprint_search("PFR_b.*_L.*",meta = FALSE))
FRexample = neuprint_read_skeletons(neuprint_search("FR2.*_L.*",meta = FALSE))
```

```{r}
plot3d(gaMesh, col='seagreen', alpha=0.4, add=TRUE)
plot3d(roMesh, col='slateblue', alpha=0.4, add=TRUE)
plot3d(ruMesh, col='goldenrod', alpha=0.4, add=TRUE)
#plot3d(ebMesh, col='dimgrey',alpha=0.2, add=TRUE)
#plot3d(laMesh, col='dimgrey',alpha=0.2, add=TRUE)

plot3d(EPGexample, col='seagreen', add=TRUE, WithNode=F)
plot3d(ELexample, col='tomato', add=TRUE, WithNode=F)
plot3d(PFGsexample, col='maroon', add=TRUE, WithNode=F)
plot3d(PFRaexample, col='slateblue', add=TRUE, WithNode=F)
plot3d(FRexample, col='goldenrod', add=TRUE, WithNode=F)


```

