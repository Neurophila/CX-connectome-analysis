---
title: "Find/define the neurons that innervate a neuropil"
output: html_notebook
---


# Command to clear environment is: rm(list = ls(all.names = TRUE))
# Load libraries
```{r message=FALSE, warning=FALSE}

library(nat)
library(neuprintr)
library(tidyverse)
library(reshape2)
library(plotly)
options(nat.plotengine = 'rgl')

```


# Configurable inputs: choose your ROI
```{r}


# The region of interest.
ROI="FB"  

# Directory to save data to.
SaveDir="Z:/Cx_Connectome/NeuronsInROIs/FB/"


```


# Create save directory if it doesnt exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
```


# Connect to neuprint server.
```{r}
neuprint_login()
```


# Get all bodies with input OR output synapses in the ROI
```{r}

NamedBodies = neuprint_find_neurons(ROI,ROI,all_segments = FALSE)
NamedBodies = NamedBodies %>% arrange(unlist(bodytype)) %>% subset(bodytype != "NA") 

```


# Get Pre-to-Post connection table.
```{r}

# Pre-to-Post connections for named bodies (return all segements and filter) --> subet at end is important or it returns bodyids not contained in NamedBodies
NamedConnectTable = neuprint_connection_table(NamedBodies$bodyid,"PRE",ROI, all_segments=FALSE)   %>%
                         mutate( PreName =neuprint_get_meta(bodyid)[["name"]], PostName = neuprint_get_meta(partner)[["name"]] )   %>% 
                         mutate( PreType =neuprint_get_meta(bodyid)[["type"]], PostType = neuprint_get_meta(partner)[["type"]])   %>%  
                         group_by(PreName) %>% 
                         ungroup() %>%
                         rename(Pre_bodyid = bodyid, Post_bodyid = partner)
NamedConnectTable = subset(NamedConnectTable, Pre_bodyid %in% as.numeric(NamedBodies$bodyid) & Post_bodyid %in% as.numeric(NamedBodies$bodyid) ) 

```


# Get total synapses (Pre+Post) and the relative percent of Pre and Post synapses in the ROI.
```{r}

# Compute the total number of synapses in the ROI
NamedBodies=mutate(NamedBodies, PrePost_Syns = (NamedBodies[[paste(ROI, "_pre",sep="")]] + NamedBodies[[paste(ROI, "_post",sep="")]]) )

# Compute the percent of each body's PRE synapses in the ROI. 
NamedBodies=mutate(NamedBodies, Pre_Relative = NamedBodies[[paste(ROI, "_pre",sep="")]]/unlist(NamedBodies$npre) )
NamedBodies$Pre_Relative[is.nan(NamedBodies$Pre_Relative)] = 0

# Compute the percent of each body's POST synapses in the ROI.
NamedBodies=mutate(NamedBodies, Post_Relative = NamedBodies[[paste(ROI, "_post",sep="")]]/unlist(NamedBodies$npost) )
NamedBodies$Post_Relative[is.nan(NamedBodies$Post_Relative)] = 0

# Average the relative PRE and relative POST synapses. It's best to average after computing the relative PRE and relative POST
# so that the measure isn't biased by there being more post synapses than pre synapses on average. 
NamedBodies=mutate(NamedBodies, PrePost_Relative = (Pre_Relative+Post_Relative)/2)

```


# Calculate the max PRE weight and max POST weight for each bodyID
```{r}

# Loop over pre-synaptic neurons and find max output weight
PreMaxWeights=numeric()
for (prepre in (1:length(NamedBodies$bodyid)) )
  {
  Temp=subset(NamedConnectTable, NamedConnectTable$Pre_bodyid==unlist(NamedBodies$bodyid[[prepre]]) )
  if (length(Temp$Pre_bodyid)==0){PreMaxWeights[prepre]=0
  }else{PreMaxWeights[prepre]=max(Temp$weight)}
}

# Loop over post-synaptic neurons and find max output weight
PostMaxWeights=numeric()
for (postpost in (1:length(NamedBodies$bodyid)) )
  {
  Temp=subset(NamedConnectTable, NamedConnectTable$Post_bodyid==unlist(NamedBodies$bodyid[[postpost]]) )
  if (length(Temp$Post_bodyid)==0){PostMaxWeights[postpost]=0
  }else{PostMaxWeights[postpost]=max(Temp$weight)}
}
remove(Temp)

# Add data to NamedBodies dataframe
NamedBodies=mutate(NamedBodies, PreMax = PreMaxWeights)
NamedBodies=mutate(NamedBodies, PostMax = PostMaxWeights)
NamedBodies=mutate(NamedBodies, PrePost_Max = (PreMaxWeights+PostMaxWeights))

```


# Get the average number of Pre and Post synapses for each neuron type for both relative and absolute synapse counts.
```{r}

NamedBodies_byType <- aggregate(x=NamedBodies[c(paste(ROI, "_pre",sep=""),paste(ROI, "_post",sep=""),"PrePost_Syns","Pre_Relative",
                                                "Post_Relative","PrePost_Relative","PreMax","PostMax","PrePost_Max")],by=list(unlist(NamedBodies$bodytype[])), FUN=mean)
names(NamedBodies_byType) <- c("Type","PreSyns", "PostSyns","PrePost_Syns","Pre_Relative","Post_Relative","PrePost_Relative","PreMax","PostMax","PrePost_Max")

```


# Make scatter plot of max pre and post synaptic weight.
```{r}

# Interactive plot of maximum pre vs post synapse weight for named neuron types, where cursor brings up neuron type name
f <- list(size = 18, color = "black")
p3a <- plot_ly(type = 'scatter', x = NamedBodies_byType$PreMax, y = NamedBodies_byType$PostMax, mode='markers',
  text = paste("Type: ", NamedBodies_byType$Type )) %>% 
  layout(xaxis = list(title = paste("Max PRE Weight in", ROI),titlefont = f), yaxis = list(title = paste("Max POST Weight in",ROI),titlefont = f), 
         title=" \n \n  Each point is a neuron type")
htmlwidgets::saveWidget(as_widget(p3a), paste(SaveDir,"Pre_Vs_Post_MaxWeightsPerType_widget.html",sep=""))
remove(p3a)


# Interactive plot of maximum pre+post weight VS relative pre+post weight
f <- list(size = 18, color = "black")
p3b <- plot_ly(type = 'scatter', x = NamedBodies_byType$PrePost_Max, y = NamedBodies_byType$PrePost_Relative, mode='markers',
  text = paste("Type: ", NamedBodies_byType$Type )) %>% 
  layout(xaxis = list(title = paste("Max PRE+POST Weight in", ROI),titlefont = f), yaxis = list(title = paste("Relative Pre+POST synapses in",ROI),titlefont = f), 
         title=" \n \n  Each point is a neuron type")
htmlwidgets::saveWidget(as_widget(p3b), paste(SaveDir,"PrePostMax_Vs_PrePostRelativeSyns_PerType.html",sep=""))
remove(p3b)


```



