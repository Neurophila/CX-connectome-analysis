---
title: "Analysis of wind (mechanosensoy) info comming into CX"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
#Analysis of mechanosensory information pathway coming into CX via R1 neurons

```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
library(neuprintrExtra)
library(igraph)

options(nat.plotengine = 'rgl')
```

```{r}
neuprint_login()
```

```{r messages=FALSE, warning=FALSE}
# Get some custom functions
source("visualizeConnectivityTables.R")
#source("inputOutputRegionsVis.R")
```

## Bodyid's of neurons that are potentially involved
The propose pathway presented in Suver et al is Johnstons organs -> APN3/APN2 -> WPN

Here we will try to identify which neurons in the EM volume correspond to APN2, APN3 and WPN and illustrate a potential route toward the fly's heading circuit.
```{r}
#APN3s (presynaptic of APN2s):
APN3ids = c(975289165, 1099073905, 1130458829)
#APN2s (postsynaptic of APN3s): 
APN2ids = c(1539649574, 2096909915, 2096913987)

# get names
for (i in APN3ids) {
  print(neuprint_get_neuron_names(i))
}
for (i in APN2ids) {
  print(neuprint_get_neuron_names(i))
}
```
Get all neurons of the type described by the bodyids  above
```{r}
APN3 = neuprint_search("PDM14n_pct.*")
APN2 = bind_rows(neuprint_search("ADM06d_pct.*"),neuprint_search("ADM06p_pct.*")) 

APNBodies = c(APN3$bodyid,APN2$bodyid)
```

We will also consider the putative WL-L neuron, which is wind sensitive and connects to R1
```{r}
#WL-L
WLLids = c(1386849677, 1539632818)

for (i in WLLids) {
  print(neuprint_get_neuron_names(i))
}

WLL = neuprint_search("PVL06h_pct.*")
```

Also get body ID's of putative downstream partners
```{r}
# Putative WPN, based on morphology and connectivity: PDL27e
#(these were identified in a shortest path analysis as shown later)
WPN = neuprint_search("PDL27e_pct.*")

# R1s
R1 = neuprint_search("R1_.*")
R1a = neuprint_search("R1_a.*")
R1b = neuprint_search("R1_b.*")

#R3a_b
R3a_b = neuprint_search("R3a_b.*")

splitLR = TRUE
majorOutputThreshold=0.8
singleNeuronThreshold=0.01
singleNeuronThresholdN=3
pThresh = 0.05

cutoff = 0#0.005#0.01#
edcurve = 0
vertexSize = 9
edgeNorm = 0.008
```

## Find paths to the CX
```{r}
allPathFromAPN_to_R1 = neuprint_get_paths(APNBodies,R1$bodyid, n=4, weightT = 10, chunk = 1)
```

```{r}
allPathFromWLL_to_R1 = neuprint_get_paths(WLL$bodyid,R1$bodyid, n=2, weightT = 10, chunk = 2)
```

```{r}
allPathFromAPN_to_WLL = neuprint_get_paths(APNBodies,WLL$bodyid, n=4, weightT = 10, chunk = 1)
```

```{r}
allPathFromAPN_to_R3 = neuprint_get_paths(APNBodies,R3a_b$bodyid, n=4, weightT = 10, chunk = 1)
```

```{r}
allPathFromWLL_to_R3 = neuprint_get_paths(WLL$bodyid,R3a_b$bodyid, n=2, weightT = 10, chunk = 1)
```

```{r}
allPathFromWPN_to_R1 = neuprint_get_paths(WPN$bodyid,R1$bodyid, n=2, weightT = 10, chunk = 1)
```

```{r}
allPathFromWPN_to_R3 = neuprint_get_paths(WPN$bodyid,R3a_b$bodyid, n=2, weightT = 10, chunk = 1)
```

```{r}
allPathFromAPN_to_WPN = neuprint_get_paths(APNBodies, WPN$bodyid, n=3, weightT = 10, chunk = 1)
```


## Viusualize paths to the CX

```{r}
# helper functions
getPathConnections <- function(fromIDs, toIDs){
  
  pathConnections = getConnectionTable(unique(fromIDs), "POST")
  pathConnections = pathConnections %>% filter(to %in% unique(toIDs) )
  
  if (splitLR){
    pathConnections = lateralize_types(pathConnections, postfix="to")
    pathConnections = lateralize_types(pathConnections, postfix="from")
    typesTable = lateralize_types(typesTable, postfix="raw")
  }
  return(pathConnections)
}

```

### APN or WLL to R1
```{r}
#APN -> R1
APNpathConnections = getPathConnections(allPathFromAPN_to_R1$from,allPathFromAPN_to_R1$to)
typesTable <- getTypesTable(unique(APNpathConnections$databaseType.to))
if (splitLR){
  typesTable = lateralize_types(typesTable, postfix="raw")
}

myAPNPathT2T = getTypeToTypeTable(APNpathConnections,majorOutputThreshold,singleNeuronThreshold, singleNeuronThresholdN, pThresh,typesTable = typesTable)

# WLL -> R1
WLLpathConnections = getPathConnections(allPathFromWLL_to_R1$from,allPathFromWLL_to_R1$to)
typesTable <- getTypesTable(unique(WLLpathConnections$databaseType.to))
if (splitLR){
  typesTable = lateralize_types(typesTable, postfix="raw")
}

myWLLPathT2T = getTypeToTypeTable(WLLpathConnections,majorOutputThreshold,singleNeuronThreshold, singleNeuronThresholdN, pThresh,typesTable = typesTable)

# WPN -> R1
WPNpathConnections = getPathConnections(allPathFromWPN_to_R1$from,allPathFromWPN_to_R1$to)
typesTable <- getTypesTable(unique(WPNpathConnections$databaseType.to))
if (splitLR){
  typesTable = lateralize_types(typesTable, postfix="raw")
}

myWPNPathT2T = getTypeToTypeTable(WPNpathConnections,majorOutputThreshold,singleNeuronThreshold, singleNeuronThresholdN, pThresh,typesTable = typesTable)
```

```{r}
myPathT2T = full_join(full_join(myAPNPathT2T, myWLLPathT2T),myWPNPathT2T)
```

```{r}
graphData = data.frame(from = myPathT2T$type.from,
                       to = myPathT2T$type.to,
                       relWeight = myPathT2T$weightRelative)

myGraph = constructConnectivityGraph(graphData, cutoff, vertexSize, selfFBscale=1, arrowSize=0, edgeNorm)

# remove nodes that are not on path
if (splitLR){
  path2R1_1 = all_simple_paths(myGraph, V(myGraph)[c("PDM14n_pct_R")], to = V(myGraph)[c("R1_a_R","R1_b_L","R1_b_R")], mode = "out")
  path2R1_2 = all_simple_paths(myGraph, V(myGraph)[c("ADM06d_pct_R")], to = V(myGraph)[c("R1_a_R","R1_b_L","R1_b_R")], mode = "out")
  path2R1_3 = all_simple_paths(myGraph, V(myGraph)[c("ADM06p_pct_R")], to = V(myGraph)[c("R1_a_R","R1_b_L","R1_b_R")], mode = "out")
  path2R1_4 = all_simple_paths(myGraph, V(myGraph)[c("PDL27e_pct_R")], to = V(myGraph)[c("R1_a_R","R1_b_L","R1_b_R")], mode = "out")
  path2R1_5 = all_simple_paths(myGraph, V(myGraph)[c("PVL06h_pct_L")], to = V(myGraph)[c("R1_b_L","R1_b_R","R1_a_R")], mode = "out")
}else{
  path2R1_1 = all_simple_paths(myGraph, V(myGraph)[c("PDM14m_pct")], to = V(myGraph)[c("R1_a","R1_b")], mode = "out")
  path2R1_2 = all_simple_paths(myGraph, V(myGraph)[c("ADM06d_pct")], to = V(myGraph)[c("R1_a","R1_b")], mode = "out")
  path2R1_3 = all_simple_paths(myGraph, V(myGraph)[c("ADM06p_pct")], to = V(myGraph)[c("R1_a","R1_b")], mode = "out")
  path2R1_4 = all_simple_paths(myGraph, V(myGraph)[c("PDL27e_pct")], to = V(myGraph)[c("R1_a","R1_b")], mode = "out")
  path2R1_5 = all_simple_paths(myGraph, V(myGraph)[c("PVL06h_pct")], to = V(myGraph)[c("R1_b")], mode = "out")
}
onpath = V(myGraph)[unique(c(unlist(path2R1_1),unlist(path2R1_2),unlist(path2R1_3),unlist(path2R1_4),unlist(path2R1_5)))]

if(length(onpath) > 0){
  myR1Graph_filt = subgraph(myGraph, onpath)
}else{
  myR1Graph_filt = myGraph
}

l = layout_with_dh(myR1Graph_filt)

plot(myR1Graph_filt,edge.curved=edcurve, layout=l, edge.color = customizeGraphEdges(myR1Graph_filt))

if(splitLR){
  dev.print(pdf, paste0("../neuprintR_analysis_plots/mechanoPW/connectivityGraph_APN_or_WPN_or_WLL_to_R1b_LR_",100*cutoff,"prcCutoff.pdf"), width=10, height=10)
}else{
  dev.print(pdf, paste0("../neuprintR_analysis_plots/mechanoPW/connectivityGraph_APN_or_WPN_or_WLL_to_R1b_",100*cutoff,"prcCutoff.pdf"), width=10, height=10)
}
```

# APN -> WLL
```{r}
pathConnections = getPathConnections(allPathFromAPN_to_WLL$from,allPathFromAPN_to_WLL$to)
typesTable <- getTypesTable(unique(pathConnections$databaseType.to))
if (splitLR){
  typesTable = lateralize_types(typesTable, postfix="raw")
}

myPathT2T = getTypeToTypeTable(pathConnections,majorOutputThreshold,singleNeuronThreshold, singleNeuronThresholdN, pThresh,typesTable = typesTable)

graphData = data.frame(from = myPathT2T$type.from,
                       to = myPathT2T$type.to,
                       relWeight = myPathT2T$weightRelative)

myGraph = constructConnectivityGraph(graphData, cutoff, vertexSize, selfFBscale=1, arrowSize=0, edgeNorm)

# remove nodes that are not on path
if (splitLR){
  path2WLL_1 = all_simple_paths(myGraph, V(myGraph)[c("PDM14n_pct_R")], to = V(myGraph)[c("PVL06h_pct_L","PVL06h_pct_R" )], mode = "out")
  path2WLL_2 = all_simple_paths(myGraph, V(myGraph)[c("ADM06d_pct_R")], to = V(myGraph)[c("PVL06h_pct_L","PVL06h_pct_R" )], mode = "out")
  path2WLL_3 = all_simple_paths(myGraph, V(myGraph)[c("ADM06p_pct_R")], to = V(myGraph)[c("PVL06h_pct_L","PVL06h_pct_R" )], mode = "out")
}else{
  path2WLL_1 = all_simple_paths(myGraph, V(myGraph)[c("PDM14n_pct")], to = V(myGraph)[c("PVL06h_pct" )], mode = "out")
  path2WLL_2 = all_simple_paths(myGraph, V(myGraph)[c("ADM06d_pct")], to = V(myGraph)[c("PVL06h_pct" )], mode = "out")
  path2WLL_3 = all_simple_paths(myGraph, V(myGraph)[c("ADM06p_pct")], to = V(myGraph)[c("PVL06h_pct" )], mode = "out")
}
onpath = V(myGraph)[unique(c(unlist(path2WLL_1),unlist(path2WLL_2),unlist(path2WLL_3)))]

if(length(onpath) > 0){
  myWLLGraph_filt = subgraph(myGraph, onpath)
}else{
  myWLLGraph_filt = myGraph
}

l = layout_with_dh(myWLLGraph_filt)

plot(myWLLGraph_filt,edge.curved=edcurve, layout=l, edge.color = customizeGraphEdges(myWLLGraph_filt))
if(splitLR){
  dev.print(pdf, paste0("../neuprintR_analysis_plots/mechanoPW/connectivityGraph_APN_to_WLL_LR_",100*cutoff,".pdf"), width=10, height=10)
}else{
  dev.print(pdf, paste0("../neuprintR_analysis_plots/mechanoPW/connectivityGraph_APN_to_WLL_",100*cutoff,".pdf"), width=10, height=10)
}
```

### APN -> R3
```{r}
#APN -> R3
APNpathConnections = getPathConnections(allPathFromAPN_to_R3$from,allPathFromAPN_to_R3$to)
typesTable <- getTypesTable(unique(APNpathConnections$databaseType.to))
if (splitLR){
  typesTable = lateralize_types(typesTable, postfix="raw")
}
myAPNPathT2T = getTypeToTypeTable(APNpathConnections,majorOutputThreshold,singleNeuronThreshold, singleNeuronThresholdN, pThresh,typesTable = typesTable)

# WLL -> R3
WLLpathConnections = getPathConnections(allPathFromWLL_to_R3$from,allPathFromWLL_to_R3$to)
typesTable <- getTypesTable(unique(WLLpathConnections$databaseType.to))
if (splitLR){
  typesTable = lateralize_types(typesTable, postfix="raw")
}
myWLLPathT2T = getTypeToTypeTable(WLLpathConnections,majorOutputThreshold,singleNeuronThreshold, singleNeuronThresholdN, pThresh,typesTable = typesTable)

# WPN -> R3
WPNpathConnections = getPathConnections(allPathFromWPN_to_R3$from,allPathFromWPN_to_R3$to)
typesTable <- getTypesTable(unique(WPNpathConnections$databaseType.to))
if (splitLR){
  typesTable = lateralize_types(typesTable, postfix="raw")
}
myWPNPathT2T = getTypeToTypeTable(WPNpathConnections,majorOutputThreshold,singleNeuronThreshold, singleNeuronThresholdN, pThresh,typesTable = typesTable)
```

```{r}
myPathT2T = full_join(full_join(myAPNPathT2T,myWPNPathT2T),myWLLPathT2T)

graphData = data.frame(from = myPathT2T$type.from,
                       to = myPathT2T$type.to,
                       relWeight = myPathT2T$weightRelative)

myGraph = constructConnectivityGraph(graphData, cutoff, vertexSize, selfFBscale=1, arrowSize=0, edgeNorm)

# remove nodes that are not on path
if (splitLR){
  path2R3_1 = all_simple_paths(myGraph, V(myGraph)[c("PDM14n_pct_R")], to = V(myGraph)[c("R3a_b_R","R3a_b_L")], mode = "out")
  path2R3_2 = all_simple_paths(myGraph, V(myGraph)[c("ADM06d_pct_R")], to = V(myGraph)[c("R3a_b_R","R3a_b_L")], mode = "out")
  #path2R3_3 = all_simple_paths(myGraph, V(myGraph)[c("ADM06p_pct_R")], to = V(myGraph)[c("R3a_b_R","R3a_b_L")], mode = "out")
  path2R3_4 = all_simple_paths(myGraph, V(myGraph)[c("PVL06h_pct_L")], to = V(myGraph)[c("R3a_b_R","R3a_b_L")], mode = "out")
  path2R3_5 = all_simple_paths(myGraph, V(myGraph)[c("PDL27e_pct_R")], to = V(myGraph)[c("R3a_b_R","R3a_b_L")], mode = "out")
}else{
  path2R3_1 = all_simple_paths(myGraph, V(myGraph)[c("PDM14n_pct")], to = V(myGraph)[c("R3a_b")], mode = "out")
  path2R3_2 = all_simple_paths(myGraph, V(myGraph)[c("ADM06d_pct")], to = V(myGraph)[c("R3a_b")], mode = "out")
  path2R3_3 = all_simple_paths(myGraph, V(myGraph)[c("ADM06p_pct")], to = V(myGraph)[c("R3a_b")], mode = "out")
  path2R3_4 = all_simple_paths(myGraph, V(myGraph)[c("PVL06h_pct")], to = V(myGraph)[c("R3a_b")], mode = "out")
  path2R3_5 = all_simple_paths(myGraph, V(myGraph)[c("PDL27e_pct")], to = V(myGraph)[c("R3a_b")], mode = "out")
}
onpath = V(myGraph)[unique(c(unlist(path2R3_1),unlist(path2R3_2),unlist(path2R3_4),unlist(path2R3_5)))] #,unlist(path2R3_3)

if(length(onpath) > 0){
  myR3Graph_filt = subgraph(myGraph, onpath)
}else{
  myR3Graph_filt = myGraph
}

l = layout_with_dh(myR3Graph_filt)

plot(myR3Graph_filt,edge.curved=edcurve, layout=l, edge.color = customizeGraphEdges(myR3Graph_filt))

if(splitLR){
  dev.print(pdf, paste0("../neuprintR_analysis_plots/mechanoPW/connectivityGraph_APN_or_WPN_or_WLL_to_R3a_b_LR_",100*cutoff,".pdf"), width=10, height=10)
}else{
  dev.print(pdf, paste0("../neuprintR_analysis_plots/mechanoPW/connectivityGraph_APN_or_WPN_or_WLL_to_R3a_b_",100*cutoff,".pdf"), width=10, height=10)
}
```
### Merge graphs of APN -> R1 and APN -> WLL and APN -> R3a_b
```{r}
myGraph_union_data = bind_rows(as_long_data_frame(myR1Graph_filt),as_long_data_frame(myWLLGraph_filt),
                               as_long_data_frame(myR3Graph_filt))

myGraph_union_data = myGraph_union_data %>% select(c(from_name, to_name, relWeight)) %>% 
  rename(from = from_name, to = to_name)

myGraph_union = constructConnectivityGraph(myGraph_union_data, cutoff, vertexSize, selfFBscale=1, arrowSize=0, edgeNorm)

l = layout_with_dh(myGraph_union)

plot(myGraph_union,edge.curved=edcurve, layout=l, edge.color = customizeGraphEdges(myGraph_union))

if(splitLR){
  dev.print(pdf, paste0("../neuprintR_analysis_plots/mechanoPW/connectivityGraph_APN_to_WLL_to_R1_or_R3_LR_",100*cutoff,".pdf"), width=10, height=10)
}else{
  dev.print(pdf, paste0("../neuprintR_analysis_plots/mechanoPW/connectivityGraph_APN_to_WLL_to_R1_or_R3_",100*cutoff,".pdf"), width=10, height=10)
}
```


### Illustrate overlap of inputs to R1_a and R1_b.
```{r}
source("InputOutputByTypeUtils.R")

# Make neuron bags fro R1_a and R1_b
R1a_bag = buildInputsOutputsByType("R1_a")
R1b_bag = buildInputsOutputsByType("R1_a")

slctRoi = "LAL(R)"

R1a_in = R1a_bag$inputs %>% filter(roi == slctRoi)
R1b_in = R1b_bag$inputs %>% filter(roi == slctRoi)

# Filter out neurons from left side?
splitLR = TRUE
```

```{r}
R1_in = bind_rows(R1a_in, R1b_in)

ggplot(data = R1_in, aes(x=))
```


```{r}
#construct data frame for scatter plot

sharedInputs_R1 <- data.frame(
  
)


```
