---
title: "Gall, Rob, Rub"
output: html_notebook
---


```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
library(plotly)
library(paletteer)
library(igraph)
library(neuprintrExtra)
library(gridExtra)
options(nat.plotengine = 'rgl')

library(igraph)

neuprint_login()
```


```{r}
source("../R/connectivityMatricesTools.R")
source("../R/visualizeConnectivityTables.R")

getBodyIdsForList = function (neuronList,prefix="",postfix=".*",...){
  #' Get one dataframe of bodyIDs for all search strings in neuronList
  #' @param neuronList: A list of search strings to be passed.
  #' @param prefix: String to be added before each query (default "")
  #' @param postfix: String to be added after each query (default ".*")
  #' @param ...: Parameters to be passed to neuprint_search. Note that meta=FALSE won't work for now.
  #' @return A data frame of metadata for the results of all the queries
  #' @examples
  #' \dontrun{
  #' # Both will return the same
  #' getBodyIdsForList(c("PFL1","PFL2"))
  #' getBodyIdsForList(c("PFL1","PFL2"),postfix="",field="type")
  #' }
  
  neuronList <-  paste0(prefix,neuronList,postfix)
  bodiesList <- lapply(neuronList,neuprint_search,...)
  return(bind_rows(bodiesList))
}

```

# Make ROI selection
```{r}
roiTree = getRoiTree()
slctROIs = selectRoiSet(roiTree, default_level = 1, 
                        exceptions = list("OL(R)"=1,"AL(R)"=1,"PENP"=1,"AL(L)"=1,"MB(+ACA)(R)"=1,"MB(L)"=1,
                                          "VMNP"=1,"INP"=2, "LX(R)"=3, "LX(L)"=3), exceptionLevelMatch = 1)

GallPlusROIs = c("CRE(R)","CRE(L)","LAL(-GA)(R)","GA(R)","LAL(L)") #as.character(unique(slctROIs$roi)) %>% 
```

# Visulaze small neuropiles
```{r}
gaMesh = neuprint_ROI_mesh("GA(R)")
gaMeshPts = data.frame(dotprops(gaMesh)$points)
names(gaMeshPts) <- c("x","y","z")

ruMesh = neuprint_ROI_mesh("RUB(R)")
ruMeshPts = data.frame(dotprops(ruMesh)$points)
names(ruMeshPts) <- c("x","y","z")

roMesh = neuprint_ROI_mesh("ROB(R)")
roMeshPts = data.frame(dotprops(roMesh)$points)
names(roMeshPts) <- c("x","y","z")

ebMesh = neuprint_ROI_mesh("EB")
ebMeshPts = data.frame(dotprops(ebMesh)$points)
names(ebMeshPts) <- c("x","y","z")

laMesh = neuprint_ROI_mesh("LAL(-GA)(R)")
laMeshPts = data.frame(dotprops(laMesh)$points)
names(laMeshPts) <- c("x","y","z")

```

Example neurons
```{r}
EPGexample = neuprint_read_skeletons(696362840)
ELexample = neuprint_read_skeletons(912596952)
PEGsexample = neuprint_read_skeletons(788461444)
PFRaexample = neuprint_read_skeletons(819828716) #PFR_b(PB11b)_L4_C5
FRexample = neuprint_read_skeletons(356670712)  #FR2(FQ4)_C4_L_small

```

```{r}
EPGexample = neuprint_read_skeletons(neuprint_search("EPG.*_L.*",meta = FALSE))
ELexample = neuprint_read_skeletons(neuprint_search("EL.*_L.*",meta = FALSE))
PFGsexample = neuprint_read_skeletons(neuprint_search("PFGs.*_L.*",meta = FALSE))
PFRaexample = neuprint_read_skeletons(neuprint_search("PFR_b.*_L.*",meta = FALSE))
FRexample = neuprint_read_skeletons(neuprint_search("FR2.*_L.*",meta = FALSE))

```

```{r}
plot3d(gaMesh, col='seagreen', alpha=0.4, add=TRUE)
plot3d(roMesh, col='slateblue', alpha=0.4, add=TRUE)
plot3d(ruMesh, col='goldenrod', alpha=0.4, add=TRUE)
#plot3d(ebMesh, col='dimgrey',alpha=0.2, add=TRUE)
#plot3d(laMesh, col='dimgrey',alpha=0.2, add=TRUE)

plot3d(EPGexample, col='seagreen', add=TRUE, WithNode=F)
plot3d(ELexample, col='tomato', add=TRUE, WithNode=F)
plot3d(PFGsexample, col='maroon', add=TRUE, WithNode=F)
plot3d(PFRaexample, col='slateblue', add=TRUE, WithNode=F)
plot3d(FRexample, col='goldenrod', add=TRUE, WithNode=F)


```


# Round body ########

```{r}
robTable = getTypesInRoiTable("ROB(R)",lateralize = TRUE, minTypePercentage = 0.5)
```

# Select neurons to be considered
```{r}
robSlctTypes = c("PFR.*")

splitLR = TRUE

robSlctIDs = getBodyIdsForList(rubSlctTypes)
pre = robSlctIDs$bodyid
post = pre
myConnections = getConnectionTable(pre, "POST", by.roi = TRUE)
#myConnections = myConnections %>% filter(to %in% post) 

myConnections = myConnections %>% filter(roi %in% "ROB(R)") %>% filter(roi != "CX") %>% 
  filter( roi %in% unique(myConnections$roi)[ grep("\\(R\\)",unique(myConnections$roi))])

#combine data from all ROIs
myConnectionsCombo = combineRois(myConnections,unique(myConnections$roi),'nonCx')

```

```{r}
typesTable <- getTypesTable(unique(myConnectionsCombo$databaseType.to))
# Subdivide types and build a custom types table
myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="to")
myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="from")
typesTable = lateralize_types(typesTable, postfix="raw")

if (splitLR){
  # Subdivide types and build a custom types table
  myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="to")
  myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="from")
}

myConnectionsT2T = getTypeToTypeTable(myConnectionsCombo,typesTable = typesTable)
```

### Connectivity matrix
```{r}
plotW = 14
plotH = 6
cmax = NULL
connectionMeasures = c("weightRelative")
preName = "rubus selection"
postName = preName
saveName = ""
if(splitLR){saveName = paste0(saveName,"_LR")}
roiName = "nonCX_rubusTypes"

for (connectionMeasure in connectionMeasures){
  
  conMatPlot = plotConnectivityMatrix(myConnectionsT2T, byGroup = "type", connectionMeasure, cmax)
  conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)
  
  print(conMatPlot)
  ggsave( paste("connectivityMatrix_",saveName,'in_',roiName,'_',connectionMeasure,'_byType.pdf', sep=''), plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW*0.8, height = plotH*0.8, units ="cm", dpi = 600, limitsize = TRUE)
  
  conMatPlot = plotConnectivityMatrix(myConnectionsCombo, byGroup = "id", connectionMeasure, cmax)
  conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)
  conMatPlot = structureMatrixPlotByType_lines(conMatPlot)
  print(conMatPlot)
  ggsave(paste("connectivityMatrix_",saveName,'in_',roiName,'_',connectionMeasure,'_byID.pdf', sep=''), 
    plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",
    scale = 2, width = plotW, height =plotH, units ="cm", dpi = 600, limitsize = TRUE)
  
  conMatPlot = plotConnectivityMatrix(myConnectionsCombo, byGroup = "name", connectionMeasure,cmax)
  conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)
  #conMatPlot = structureMatrixPlotByType(conMatPlot)
  print(conMatPlot)
  ggsave( paste("connectivityMatrix_",saveName,'in_',roiName,'_',connectionMeasure,'_byName.pdf', sep=''), 
    plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",
      scale = 1, width = plotW*2, height = plotH*2, units ="cm", dpi = 600, limitsize = TRUE)
}
```



# GA ################
## Generate summary of all neurons that make connections in gall, then focus on a subset
```{r}
gaTable = getTypesInRoiTable("GA(R)",lateralize = TRUE, minTypePercentage = 0.5)
```

```{r}

typeGAplot = plotConnectivityMatrix(bind_rows(gaTable$outputs,gaTable$inputs) , byGroup = "type", connectionMeasure, cmax)
typeGAplot

```
```{r}
allGAneurons = unique(c(gaTable$outputs$databaseType.from,gaTable$inputs$databaseType.to))
gapre = getBodyIdsForList(unique(gaTable$outputs$databaseType.from))
gapost = getBodyIdsForList(unique(gaTable$inputs$databaseType.from))
```

```{r}
myConnections_out = getConnectionTable(gapre$bodyid, "POST", by.roi = TRUE) %>% filter(roi == "GA(R)") 
myConnections_in = getConnectionTable(gapost$bodyid, "POST", by.roi = TRUE) %>% filter(roi == "GA(R)") 

myConnections = unique(bind_rows(myConnections_out,myConnections_in))

typesTable <- getTypesTable(unique(myConnections$databaseType.to))
# Subdivide types and build a custom types table
myConnections = lateralize_types(myConnections, postfix="to")
myConnections = lateralize_types(myConnections, postfix="from")
typesTable = lateralize_types(typesTable, postfix="raw")

myConnectionsT2T = getTypeToTypeTable(myConnections,typesTable = typesTable)
```

```{r}
plotW = 14# 45 # 20
plotH = 11 #4 #40  #17
cmax = NULL
connectionMeasure = "weightRelative"
preName = "gall selection"
postName = preName
saveName = ""
if(splitLR){saveName = paste0(saveName,"_LR")}
roiName = "allGA(R)"

conMatPlot = plotConnectivityMatrix(myConnectionsT2T, byGroup = "type", connectionMeasure, cmax)
conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)

print(conMatPlot)
ggsave("connectivityMatrix_allGAconnections_connectionMeasure_byType.pdf", plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",
  scale = 1.5, width = plotW*0.8, height = plotH*0.8, units ="cm", dpi = 600, limitsize = TRUE)

conMatPlot = plotConnectivityMatrix(myConnections, byGroup = "id", connectionMeasure, cmax)
conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)
conMatPlot = structureMatrixPlotByType_lines(conMatPlot)
print(conMatPlot)
ggsave("connectivityMatrix_allGAconnections_connectionMeasure_byID.pdf", plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",
  scale = 2, width = plotW, height =plotH, units ="cm", dpi = 600, limitsize = TRUE)
```


## Select neurons to be considered
Since the Gall is a badly defined region, we can't easily collect neurons that go to the Gall based in the EM ROI.

```{r}
gallSlctTypes =  c("EPG","PEG","EL","PFG","ER6")
  #c("EPG","PEG","EL","ER6","ExR1","ExR2","ExR4","ExR6","PFG")
gallSlctIDs = getBodyIdsForList(gallSlctTypes)
pre = gallSlctIDs$bodyid
post = pre

gasavename = "selctGallTypes_small"

splitLR = TRUE

myConnections = getConnectionTable(pre, "POST", by.roi = TRUE)
myConnections = myConnections %>% filter(to %in% post) 

myConnections = myConnections %>% filter(roi %in% GallPlusROIs) %>% filter(roi != "CX")

# combine data from all ROIs
myConnectionsCombo = combineRois(myConnections,unique(myConnections$roi),'nonCx')

if (splitLR){
  # Subdivide types and build a custom types table
  myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="to")
  myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="from")
}
```

```{r}
typesTable <- getTypesTable(unique(myConnectionsCombo$databaseType.to))
# Subdivide types and build a custom types table
myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="to")
myConnectionsCombo = lateralize_types(myConnectionsCombo, postfix="from")
typesTable = lateralize_types(typesTable, postfix="raw")

myConnectionsT2T = getTypeToTypeTable(myConnectionsCombo,typesTable = typesTable)
```

### Connectivity matrix
```{r}
plotW = 13# 45 # 20
plotH = 11 #4 #40  #17
cmax = NULL
connectionMeasure = "weightRelative"
preName = "gall selection"
postName = preName
saveName = ""
if(splitLR){saveName = paste0(saveName,"_LR")}
roiName = "nonCX_gallTypes"
  
conMatPlot = plotConnectivityMatrix(myConnectionsT2T, byGroup = "type", connectionMeasure, cmax)
conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)

print(conMatPlot)
ggsave( paste("connectivityMatrix_",gasavename,'in_',roiName,'_',connectionMeasure,'_byType.pdf', sep=''), plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",
  scale = 1.5, width = plotW*0.8, height = plotH*0.8, units ="cm", dpi = 600, limitsize = TRUE)

conMatPlot = plotConnectivityMatrix(myConnectionsCombo, byGroup = "id", connectionMeasure, cmax)
conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)
conMatPlot = structureMatrixPlotByType_lines(conMatPlot)
print(conMatPlot)
ggsave(paste("connectivityMatrix_",gasavename,'in_',roiName,'_',connectionMeasure,'_byID.pdf', sep=''), 
  plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",
  scale = 2, width = plotW, height =plotH, units ="cm", dpi = 600, limitsize = TRUE)

conMatPlot = plotConnectivityMatrix(myConnectionsCombo, byGroup = "name", connectionMeasure,cmax)
conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)
#conMatPlot = structureMatrixPlotByType(conMatPlot)
print(conMatPlot)
ggsave( paste("connectivityMatrix_",gasavename,'in_',roiName,'_',connectionMeasure,'_byName.pdf', sep=''), 
  plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW, height = plotH, units ="cm", dpi = 600, limitsize = TRUE)
```


###  Draw graph

```{r, warning=FALSE} 
connectionMeasures = c("weightRelative","weightROIRelativeTotal")
connectionMeasure = connectionMeasures[1]
cutoff = 0.05 # for weight 0.05, 0.01, 0

largeGraph = FALSE
selfFeedbackScale = 10
edcurve = 0.1#0.15
edgeNorm = 0.07#0.05#0.07#0.03#

showself = TRUE 

# Graph parameter
if(largeGraph){
  vertexSize = 7#+ 7 * graphData$relWeightSelf * selfFeedbackScale
  plotSize = 15
}else{
  vertexSize = 12 #+ 12 * graphData$relWeightSelf * selfFeedbackScale
  plotSize = 10
}

selfFBscale = vertexSize
arrowSize= 0
```

Graph with defined colormap from file
```{r, warning=FALSE} 
cmapNames = c("RingNeurons", "TuBus", "columnar",  "ExR_and_AOTU46")

myColorMap <- read.csv(paste0("~/Documents/code/neuprintR-notebooks/colorMap_",cmapNames[1],".csv"))
if(length(cmapNames) > 1){
  for(cmapName in cmapNames[2:length(cmapNames)]){ 
    tmp = read.csv(paste0("~/Documents/code/neuprintR-notebooks/colorMap_",cmapName,".csv"))
    myColorMap <- full_join(myColorMap[c("Type", "Simpletype", "hex")], tmp[c("Type", "Simpletype","hex")])
    }
}

myColorMap_R = myColorMap %>% mutate(Type = paste0(Type, "_R"))
myColorMap_L = myColorMap %>% mutate(Type = paste0(Type, "_L"))
myColorMap= bind_rows(myColorMap_L, myColorMap_R)

myColorMap = myColorMap %>% filter(Simpletype == "no")
# drop na in "to" column
myConnectionsT2T = myConnectionsT2T %>% drop_na(type.to)
graphData = data.frame(from = myConnectionsT2T$type.from, to = myConnectionsT2T$type.to, relWeight = myConnectionsT2T$weightRelative)

graphData_noSelf = getNoSelfGraphData(graphData)  
graphData_self = getSelfFBGraphData(graphData)

if (showself){
  graphData = graphData
  graphName = saveName
} else {
  graphData = left_join(graphData_noSelf, graphData_self)
  graphName = paste(saveName, "_noSelf")
}

myGraph = constructConnectivityGraph(graphData, cutoff, vertexSize, selfFBscale, arrowSize, edgeNorm, colormap = myColorMap, useRandCol = FALSE)

l = layout_with_fr(myGraph)#layout_with_dh(myGraph)#

myGraph$main = paste0("Connectivity within   the ",roiName)
plot(myGraph,edge.curved=edcurve, layout=l, edge.color = customizeGraphEdges(myGraph))

dev.print(pdf, paste0("../../neuprintR_analysis_plots/connectivityGraph_",graphName,'_in_',roiName,
                      "_",connectionMeasure, round(100*cutoff),"perc_custCol.pdf"), width=plotSize, height=plotSize)
```

Connectivity between PEG, ER6, EL and EPGs in the EB
```{r}
myConnections = getConnectionTable(pre, "POST", slctROI = "EB")
myConnections = myConnections %>% filter(to %in% post) 

typesTable <- getTypesTable(unique(myConnections$databaseType.to))
# Subdivide types and build a custom types table
myConnections = lateralize_types(myConnections, postfix="to")
myConnections = lateralize_types(myConnections, postfix="from")
typesTable = lateralize_types(typesTable, postfix="raw")

myConnectionsT2T = getTypeToTypeTable(myConnections,typesTable = typesTable)
```

```{r}
plotW = 25# 45 # 20
plotH = 21 #4 #40  #17
cmax = NULL
connectionMeasures = c("weightRelative")
preName = "gall selection"
postName = preName
saveName = "gallTypes"
roiName = "EB"

for (connectionMeasure in connectionMeasures){
  
  conMatPlot = plotConnectivityMatrix(myConnectionsT2T, byGroup = "type", connectionMeasure, cmax)
  conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)
  
  print(conMatPlot)
  ggsave( paste("connectivityMatrix_",saveName,'in_',roiName,'_',connectionMeasure,'_byType.pdf', sep=''), plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",
    scale = 1.5, width = plotW*0.8, height = plotH*0.8, units ="cm", dpi = 600, limitsize = TRUE)
  
  conMatPlot = plotConnectivityMatrix(myConnections, byGroup = "id", connectionMeasure, cmax)
  conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)
  conMatPlot = structureMatrixPlotByType_lines(conMatPlot)
  print(conMatPlot)
  ggsave(paste("connectivityMatrix_",saveName,'in_',roiName,'_',connectionMeasure,'_byID.pdf', sep=''), 
    plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",
    scale = 2, width = plotW, height =plotH, units ="cm", dpi = 600, limitsize = TRUE)
  
  conMatPlot = plotConnectivityMatrix(myConnections, byGroup = "name", connectionMeasure,cmax)
  conMatPlot = addMatrixPlotLabs(conMatPlot, preName,  postName, roiName, connectionMeasure)
  #conMatPlot = structureMatrixPlotByType(conMatPlot)
  print(conMatPlot)
  ggsave( paste("connectivityMatrix_",saveName,'in_',roiName,'_',connectionMeasure,'_byName.pdf', sep=''), 
    plot = conMatPlot, device='pdf', path = "../../neuprintR_analysis_plots/",
      scale = 1.5, width = plotW*0.8, height = plotH*0.8, units ="cm", dpi = 600, limitsize = TRUE)
}
```

Graph with defined colormap from file
```{r, warning=FALSE} 
myColorMap = myColorMap %>% filter(Simpletype == "no")
# drop na in "to" column
myConnectionsT2T = myConnectionsT2T %>% drop_na(type.to)
graphData = data.frame(from = myConnectionsT2T$type.from, to = myConnectionsT2T$type.to, relWeight = myConnectionsT2T$weightRelative)

graphData_noSelf = getNoSelfGraphData(graphData)  
graphData_self = getSelfFBGraphData(graphData)

if (showself){
  graphData = graphData
  graphName = saveName
} else {
  graphData = left_join(graphData_noSelf, graphData_self)
  graphName = paste(saveName, "_noSelf")
}

myGraphEB = constructConnectivityGraph(graphData, cutoff, vertexSize, selfFBscale, arrowSize, edgeNorm, colormap = myColorMap, useRandCol = FALSE)

l = layout_with_fr(myGraphEB)#layout_with_dh(myGraph)#

myGraphEB$main = paste0("Connectivity within   the ",roiName)
plot(myGraphEB,edge.curved=edcurve, layout=l, edge.color = customizeGraphEdges(myGraphEB))

dev.print(pdf, paste0("../../neuprintR_analysis_plots/connectivityGraph_",graphName,'_in_',roiName,
                      "_",connectionMeasure, round(100*cutoff),"perc_custCol.pdf"), width=plotSize, height=plotSize)
```


# What do PFGs do in the Gall?
```{r}
PFGs = create_neuronBag("PFGs.*")
```

```{r}
inOutsideCx = PFGs$inputs_raw %>% filter(roi != "CX") %>% filter(roi %in% slctROIs) %>% 
  group_by(roi, type.from, type.to) %>% summarise(weight=sum(weight))
inOutsideCx

outOutsideCx = PFGs$outputs_raw %>% filter(roi != "CX") %>% filter(roi %in% slctROIs)  %>%
  group_by(roi, type.from, type.to) %>% summarise(weight=sum(weight))
outOutsideCx
```


```{r}
inOutsideCx = PFGs$inputs_raw %>% filter(roi == "PB") %>% 
  group_by(roi, type.from, type.to) %>% summarise(weight=sum(weight))
inOutsideCx

outOutsideCx = PFGs$outputs_raw %>% filter(roi == "PB")  %>%
  group_by(roi, type.from, type.to) %>% summarise(weight=sum(weight))
outOutsideCx
```
