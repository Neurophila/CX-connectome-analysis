---
title: "Notebook analyzing the input and output pathways of the NO at the ROI level"
output:
  html_document:
    df_print: paged
---

### Command to clear environment is: rm(list = ls(all.names = TRUE))
### Command to update is remotes::update_packages('neuprintr')
### Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(plotly)
library(dplyr)
options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose ROI and save/plot directories
```{r}

# The region of interest.
ROI="NO"  

# Directory to save data to.
SaveDir="Z:/Cx_Connectome/BradData/NO_Analysis/"

# Directory to save plots to.
PlotDir="Z:/Cx_Connectome/BradData/NO_Analysis/"

```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint server.
```{r}
neuprint_login()
```

### Get general functions
```{r}
source("inputOutputRegionsVis.r")
source("GetNeuronsInRoi.R")
```

### Get neuprint ROIs 
```{r}
rois = neuprint_ROIs()
heir=neuprint_ROI_hierarchy()
```

### Get neurons in the ROI
```{r}

NamedBodies = Get_AllNeurons_InRoi("NO", TRUE)


```

### Threshold neurons (need to agree on criteria and clean up code)
```{r}

PreMaxThresh=10
PostMaxThresh=10
Output <-  SynapseStats_And_Threshold(NamedBodies, SaveDir, PreMaxThresh, PostMaxThresh)
list2env(Output ,.GlobalEnv)
remove(Output)

```

### Get the number of synapses in each ROI for individual neurons and individual neuron types
```{r message=FALSE, warning=FALSE}

minSynapses = 10
Output=InputOutput_ROI_PerNeuron(NamedBodies, minSynapses)
list2env(Output ,.GlobalEnv)
remove(Output)

```

### Set synapse count threshold, below which to exclude ROIs 
```{r}

SynThresh=30

```

## Make plot of ALL neurons in ALL ROis
```{r}

# Make roi and cell names for all EB neurons
plotdata=roi_Connect_bytype_df
plotdata$roi_names = paste(roi_Connect_bytype_df$roi, '(', roi_Connect_bytype_df$roi_hemi, ')', sep="")
plotdata$type_name = paste(roi_Connect_bytype_df$type, '(', roi_Connect_bytype_df$neuron_hemi, ')', sep="")

# Plot all of the ROIs (and sub ROIs) that all NO neurons innervate
p0<-ggplot(plotdata, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("ALL NO Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "ALL_NO_","inputOutputRegions_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, width = 20, height = 10, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "ALL_NO_","inputOutputRegions_perType.png",sep=""), plot = p0, device='png', scale = 1, width = 20, height = 10, units ="in", dpi = 600, limitsize = TRUE)


```

### Divide data into NO1, NO2, and NO3
```{r}


unique(roi_Connect_bytype_df$roi)



```



# Look at just the right ring neurons, since all ring neurons innervate only one hemisphere.
```{r}

# Get just the ring neuron data
Rneuron_Connect_bytype_df=filter(roi_Connect_bytype_df, startsWith(unlist(roi_Connect_bytype_df$type), "R"))
Rneuron_Connect_bytype_df$roi_names = paste(Rneuron_Connect_bytype_df$roi, '(', Rneuron_Connect_bytype_df$roi_hemi, ')', sep="")
Rneuron_Connect_bytype_df$type_name = paste(Rneuron_Connect_bytype_df$type, '(', Rneuron_Connect_bytype_df$neuron_hemi, ')', sep="")

# Get right ring neurons 
R_R_plotdata=filter(Rneuron_Connect_bytype_df, neuron_hemi=='R')

# Plot all of the ROIs (and sub ROIs) that the right ring neurons innervate
p1<-ggplot(R_R_plotdata, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Right Ring Neuron Input/Output ROIs")
print(p1)
ggsave(paste(PlotDir, "RingNeuronRight_","inputOutputRegions_perType.pdf",sep=""), plot = p1, device='pdf', scale = 1, width = 14, height = 8, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "RingNeuronRight_","inputOutputRegions_perType.png",sep=""), plot = p1, device='png', scale = 1, width = 14, height = 8, units ="in", dpi = 600, limitsize = TRUE)


# Threshold based on synapse counts and plot again with ROIs arranged
R_R_plotdataSubset=filter(R_R_plotdata, R_R_plotdata$count > SynThresh)
R_R_plotdataSubset=filter(R_R_plotdataSubset, !(R_R_plotdataSubset$roi %in% "LX") )
R_R_plotdataSubset$roi_names = as.factor(R_R_plotdataSubset$roi_names)
R_R_plotdataSubset$roi_names <- factor(R_R_plotdataSubset$roi_names, levels = c("BU(R)","LAL(R)","GA(R)","EB(C)", "EBr1(C)","EBr2r4(C)","EBr3am(C)","EBr3d(C)","EBr3pw(C)","EBr5(C)","EBr6(C)"))

p2<-ggplot(R_R_plotdataSubset, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) + 
  facet_grid(cols=vars(prepost)) + theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) + 
  ggtitle(paste("Right Ring Neuron Input/Output ROIs with #synapses > ",as.character(SynThresh),sep=""))
print(p2)
ggsave(paste(PlotDir, "F_RingNeuronRight_Thresh_","inputOutputRegions_perType.pdf",sep=""), plot = p2, device='pdf', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "F_RingNeuronRight_Thresh_","inputOutputRegions_perType.png",sep=""), plot = p2, device='png', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)

remove(list=c("p1","p2"))

```



# Look at just the ExRs
```{r}

# Get just the ExR neuron data
ExRneuron_Connect_bytype_df=filter(roi_Connect_bytype_df, startsWith(unlist(roi_Connect_bytype_df$type), "ExR"))

# add an ROI name field
ExRneuron_Connect_bytype_df$roi_names = paste(ExRneuron_Connect_bytype_df$roi, '(', ExRneuron_Connect_bytype_df$roi_hemi, ')', sep="")
ExRneuron_Connect_bytype_df$type_name = paste(ExRneuron_Connect_bytype_df$type, '(', ExRneuron_Connect_bytype_df$neuron_hemi, ')', sep="")

# Plot all of the ROIs (and sub ROIs) that the ALLs ExRs innervate
p3<-ggplot(ExRneuron_Connect_bytype_df, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("ALL ExR Input/Output ROIs with #synapses")
print(p3)
ggsave(paste(PlotDir, "ExR_ALL_","InOutRegions_perType.pdf",sep=""), plot = p3, device='pdf', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "ExR_ALL_","InOutRegions_perType.png",sep=""), plot = p3, device='png', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)


# Filter by synapse counts
ExRneuron_Connect_bytype_dfThresh=filter(ExRneuron_Connect_bytype_df, count>SynThresh)

# Plot all ExRs again
p4<-ggplot(ExRneuron_Connect_bytype_dfThresh, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL ExR  Input/Output ROIs with #synapses count thresholding at ",as.character(SynThresh),sep=""))
print(p4)
ggsave(paste(PlotDir, "ExR_ALLThresh1_","InOutRegions_perType.pdf",sep=""), plot = p4, device='pdf', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "ExR_ALLThresh1_","InOutRegions_perType.png",sep=""), plot = p4, device='png', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)


# Filter out some ROIs
ExRneuron_Connect_bytype_dfThresh=filter(ExRneuron_Connect_bytype_dfThresh, !(ExRneuron_Connect_bytype_dfThresh$roi %in% c("LX","CX","None","FB-column3")))

# Plot all ExRs again
p5<-ggplot(ExRneuron_Connect_bytype_dfThresh, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL ExR  Input/Output ROIs with #synapses count thresholding at ",as.character(SynThresh),sep=""))
print(p5)
ggsave(paste(PlotDir, "ExR_ALLThresh2_","InOutRegions_perType.pdf",sep=""), plot = p5, device='pdf', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "ExR_ALLThresh2_","InOutRegions_perType.png",sep=""), plot = p5, device='png', scale = 1, width = 20, height = 8, units ="in", dpi = 600, limitsize = TRUE)


# Plot the ExRs again, but excluding Fb and Eb subregions
ExRneuron_Connect_bytype_dfThresh_NoLayers=filter(ExRneuron_Connect_bytype_dfThresh, !(startsWith(ExRneuron_Connect_bytype_dfThresh$roi,"EBr") | startsWith(ExRneuron_Connect_bytype_dfThresh$roi,"FBl")) )

p6<-ggplot(ExRneuron_Connect_bytype_dfThresh_NoLayers, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL ExR  Input/Output ROIs with #synapses count thresholding at ",as.character(SynThresh),sep=""))
print(p6)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_NoLayers_","InOutRegions_perType.pdf",sep=""), plot = p6, device='pdf', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_NoLayers_","InOutRegions_perType.png",sep=""), plot = p6, device='png', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)

# Plot the ExRs again, but only in EB
ExRneuron_Connect_bytype_dfThresh_EBLayers=filter(ExRneuron_Connect_bytype_dfThresh, (startsWith(ExRneuron_Connect_bytype_dfThresh$roi,"EB")))

p7<-ggplot(ExRneuron_Connect_bytype_dfThresh_EBLayers, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL ExR  Input/Output ROIs with #synapses count thresholding at ",as.character(SynThresh),sep=""))
print(p7)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_EBLayers_","InOutRegions_perType.pdf",sep=""), plot = p7, device='pdf', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_EBLayers_","InOutRegions_perType.png",sep=""), plot = p7, device='png', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)


# Plot the ExRs again, but only in FB
ExRneuron_Connect_bytype_dfThresh_FBLayers=filter(ExRneuron_Connect_bytype_dfThresh, (startsWith(ExRneuron_Connect_bytype_dfThresh$roi,"FB")))

p8<-ggplot(ExRneuron_Connect_bytype_dfThresh_FBLayers, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type_name)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle(paste("ALL ExR  Input/Output ROIs with #synapses after count thresholding at ",as.character(SynThresh),sep=""))
print(p8)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_FBLayers_","InOutRegions_perType.pdf",sep=""), plot = p8, device='pdf', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)
ggsave(paste(PlotDir, "F_ExR_ALLThresh2_FBLayers_","InOutRegions_perType.png",sep=""), plot = p8, device='png', scale = 1, width = 14, height = 7, units ="in", dpi = 600, limitsize = TRUE)

remove(list=c("p3","p4","p5","p6","p7","p8"))


```





































