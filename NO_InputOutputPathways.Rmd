---
title: "Notebook analyzing the input and output pathways of the NO at the ROI level"
output:
  html_document:
    df_print: paged
---

### Command to clear environment is: rm(list = ls(all.names = TRUE))
### Command to update is remotes::update_packages('neuprintr')
### Command to load Renviron file is usethis::edit_r_environ()
### Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(plotly)
library(dplyr)
options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose ROI and save/plot directories
```{r}

# The region of interest.
ROI="NO"  

# Directory to save data to.
SaveDir="Z:/Cx_Connectome/BradData/NO_Analysis/"

# Directory to save plots to.
PlotDir="Z:/Cx_Connectome/BradData/NO_Analysis/"

```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint server.
```{r}
neuprint_login()
```

### Get general functions
```{r}
source("inputOutputRegionsVis.r")
source("GetNeuronsInRoi.r")
```

### Get neuprint ROIs 
```{r}
rois = neuprint_ROIs()
heir=neuprint_ROI_hierarchy()
```

### Get neurons in the ROI
```{r}
NO_NamedBodies = Get_AllNeurons_InRoi("NO", TRUE)
NO1_NamedBodies = Get_AllNeurons_InRoi("NO1", TRUE)
NO2_NamedBodies = Get_AllNeurons_InRoi("NO2", TRUE)
NO3_NamedBodies = Get_AllNeurons_InRoi("NO3", TRUE)
```


### Threshold neurons (need to agree on criteria and clean up code)
```{r}

PreMaxThresh=10
PostMaxThresh=10

# NO
Output <-  SynapseStats_And_Threshold(NO_NamedBodies, SaveDir, PreMaxThresh, PostMaxThresh, "NO")
list2env(Output ,.GlobalEnv)
NO_NamedBodies=NamedBodies
rm(Output, NamedBodies)

# NO1
Output <-  SynapseStats_And_Threshold(NO1_NamedBodies, SaveDir, PreMaxThresh, PostMaxThresh, "NO1")
list2env(Output ,.GlobalEnv)
NO1_NamedBodies=NamedBodies
rm(Output, NamedBodies)

# NO2
Output <-  SynapseStats_And_Threshold(NO2_NamedBodies, SaveDir, PreMaxThresh, PostMaxThresh, "NO2")
list2env(Output ,.GlobalEnv)
NO2_NamedBodies=NamedBodies
rm(Output, NamedBodies)

# NO3
Output <-  SynapseStats_And_Threshold(NO3_NamedBodies, SaveDir, PreMaxThresh, PostMaxThresh, "NO3")
list2env(Output ,.GlobalEnv)
NO3_NamedBodies=NamedBodies
rm(Output, NamedBodies)


```

### Compute type averages of named bodies to get an idea of which neurons belong in which compartments
### and where threshold on relative synapse counts should be
```{r}

# NO
NO_NamedBodies_TypeAverage= aggregate(NO_NamedBodies[, 6:length(colnames(NO_NamedBodies))], list(NO_NamedBodies$bodytype), mean)
colnames(NO_NamedBodies_TypeAverage)[1]="bodytype"

#NO1
NO1_NamedBodies_TypeAverage=aggregate(NO1_NamedBodies[, 6:length(colnames(NO1_NamedBodies))], list(NO1_NamedBodies$bodytype), mean)
colnames(NO1_NamedBodies_TypeAverage)[1]="bodytype"

#NO2
NO2_NamedBodies_TypeAverage=aggregate(NO2_NamedBodies[, 6:length(colnames(NO2_NamedBodies))], list(NO2_NamedBodies$bodytype), mean)
colnames(NO2_NamedBodies_TypeAverage)[1]="bodytype"

#NO3
NO3_NamedBodies_TypeAverage=aggregate(NO3_NamedBodies[, 6:length(colnames(NO3_NamedBodies))], list(NO3_NamedBodies$bodytype), mean)
colnames(NO3_NamedBodies_TypeAverage)[1]="bodytype"

```



### Get the number of synapses in each ROI for individual neurons and individual neuron types
```{r message=FALSE, warning=FALSE}

# 4 is good
minSynapses = 4

# NO
Output=InputOutput_ROI_PerNeuron(NO_NamedBodies, minSynapses)
list2env(Output ,.GlobalEnv)
NO_roi_Connect_bytype_df=roi_Connect_bytype_df
NO_roi_Connect_df=roi_Connect_df
rm(Output, roi_Connect_bytype_df, roi_Connect_df)

# NO1
Output=InputOutput_ROI_PerNeuron(NO1_NamedBodies, minSynapses)
list2env(Output ,.GlobalEnv)
NO1_roi_Connect_bytype_df=roi_Connect_bytype_df
NO1_roi_Connect_df=roi_Connect_df
rm(Output, roi_Connect_bytype_df, roi_Connect_df)

# NO2
Output=InputOutput_ROI_PerNeuron(NO2_NamedBodies, minSynapses)
list2env(Output ,.GlobalEnv)
NO2_roi_Connect_bytype_df=roi_Connect_bytype_df
NO2_roi_Connect_df=roi_Connect_df
rm(Output, roi_Connect_bytype_df, roi_Connect_df)

# NO3
Output=InputOutput_ROI_PerNeuron(NO3_NamedBodies, minSynapses)
list2env(Output ,.GlobalEnv)
NO3_roi_Connect_bytype_df=roi_Connect_bytype_df
NO3_roi_Connect_df=roi_Connect_df
rm(Output, roi_Connect_bytype_df, roi_Connect_df)


```



### Add ROI and neuron type names that will be displayed on plots
```{r}

# NO
NO_roi_Connect_bytype_df$roi_names = paste(NO_roi_Connect_bytype_df$roi, '(', NO_roi_Connect_bytype_df$roi_hemi, ')', sep="")
NO_roi_Connect_bytype_df$type_name = paste(NO_roi_Connect_bytype_df$type, '(', NO_roi_Connect_bytype_df$neuron_hemi, ')', sep="")

# NO1
NO1_roi_Connect_bytype_df$roi_names = paste(NO1_roi_Connect_bytype_df$roi, '(', NO1_roi_Connect_bytype_df$roi_hemi, ')', sep="")
NO1_roi_Connect_bytype_df$type_name = paste(NO1_roi_Connect_bytype_df$type, '(', NO1_roi_Connect_bytype_df$neuron_hemi, ')', sep="")

# NO2
NO2_roi_Connect_bytype_df$roi_names = paste(NO2_roi_Connect_bytype_df$roi, '(', NO2_roi_Connect_bytype_df$roi_hemi, ')', sep="")
NO2_roi_Connect_bytype_df$type_name = paste(NO2_roi_Connect_bytype_df$type, '(', NO2_roi_Connect_bytype_df$neuron_hemi, ')', sep="")

# NO3
NO3_roi_Connect_bytype_df$roi_names = paste(NO3_roi_Connect_bytype_df$roi, '(', NO3_roi_Connect_bytype_df$roi_hemi, ')', sep="")
NO3_roi_Connect_bytype_df$type_name = paste(NO3_roi_Connect_bytype_df$type, '(', NO3_roi_Connect_bytype_df$neuron_hemi, ')', sep="")

  
```



## Make plot of ALL neurons in NO, NO1, NO2, and NO3, before thresholding
```{r}


# Plot all of the ROIs (and sub ROIs) that all NO neurons innervate
p0<-ggplot(NO_roi_Connect_bytype_df, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("ALL NO Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "ALL_NO_","inputOutputRegions_perType.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 20, height = 10, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all NO1 neurons innervate
p0<-ggplot(NO1_roi_Connect_bytype_df, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("ALL NO1 Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "ALL_NO1_","inputOutputRegions_perType.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 20, height = 10, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all NO2 neurons innervate
p0<-ggplot(NO2_roi_Connect_bytype_df, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("ALL NO2 Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "ALL_NO2_","inputOutputRegions_perType.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 20, height = 10, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all NO3 neurons innervate
p0<-ggplot(NO3_roi_Connect_bytype_df, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("ALL NO3 Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "ALL_NO3_","inputOutputRegions_perType.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 20, height = 10, units ="in", dpi = 600, limitsize = TRUE)


```



### Plot synapse counts in just the NO compartments, which will help decide which neurons belong in which ROIs
```{r}

# get just the NO compartments
JustNoROIs=filter(NO_roi_Connect_bytype_df, NO_roi_Connect_bytype_df$roi %in% c("NO1","NO2","NO3") )

# Plot all of the ROIs (and sub ROIs) that all NO neurons innervate
p0<-ggplot(JustNoROIs, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("NO Neuron Input/Output NO sub ROIs")
print(p0)
ggsave(paste(PlotDir, "ALL_NO_","subROIs.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 15, height = 7.5, units ="in", dpi = 600, limitsize = TRUE)


```



### Threshold relative synapse numbers and remove neurons that don't actually belong
```{r}

# 0.01 is good
RelSynThresh=0.01

# Get types based on relative synapse counts (This should be be moved to SynapseStats_And_Threshold)
NO_Type=NO_NamedBodies_TypeAverage$bodytype[NO_NamedBodies_TypeAverage$PrePost_Relative>RelSynThresh]
NO1_Type=NO1_NamedBodies_TypeAverage$bodytype[NO1_NamedBodies_TypeAverage$PrePost_Relative>RelSynThresh]
NO2_Type=NO2_NamedBodies_TypeAverage$bodytype[NO2_NamedBodies_TypeAverage$PrePost_Relative>RelSynThresh]
NO3_Type=NO3_NamedBodies_TypeAverage$bodytype[NO3_NamedBodies_TypeAverage$PrePost_Relative>RelSynThresh]

# Add/Remove types as needed
NO1_Type = NO1_Type[ !(NO1_Type %in% c("FB4M","LN3")) ]
NO2_Type = NO2_Type[ !(NO2_Type %in% c("FB1C","LNa")) ]
NO3_Type = NO3_Type[ !(NO3_Type %in% c()) ]
NO_Type = NO_Type[ NO_Type %in% c(NO1_Type, NO2_Type, NO3_Type) ]

# Threshold NO
NO_ExcludedTypes=unique(filter(NO_roi_Connect_bytype_df, !(type %in% NO_Type) )$type)
NO_roi_Connect_bytype_dfThresh=filter(NO_roi_Connect_bytype_df, type %in% NO_Type)

# Threshold NO1
NO1_ExcludedTypes=unique(filter(NO1_roi_Connect_bytype_df, !(type %in% NO1_Type) )$type)
NO1_roi_Connect_bytype_dfThresh=filter(NO1_roi_Connect_bytype_df, type %in% NO1_Type)

# Threshold NO2
NO2_ExcludedTypes=unique(filter(NO2_roi_Connect_bytype_df, !(type %in% NO2_Type) )$type)
NO2_roi_Connect_bytype_dfThresh=filter(NO2_roi_Connect_bytype_df, type %in% NO2_Type)

# Threshold NO3
NO3_ExcludedTypes=unique(filter(NO3_roi_Connect_bytype_df, !(type %in% NO3_Type) )$type)
NO3_roi_Connect_bytype_dfThresh=filter(NO3_roi_Connect_bytype_df, type %in% NO3_Type)

save(NO_Type, NO1_Type, NO2_Type, NO3_Type, RelSynThresh, NO_ExcludedTypes, file = paste(SaveDir,"NO_Types.RData",sep=""))

```



## Make plot of THRESHOLDED neurons in NO, NO1, NO2, and NO3
```{r}

# Plot all of the ROIs (and sub ROIs) that all NO neurons innervate
p0<-ggplot(NO_roi_Connect_bytype_dfThresh, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh NO Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "Thresh_NO_","inputOutputRegions_perType.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 20, height = 10, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all NO1 neurons innervate
p0<-ggplot(NO1_roi_Connect_bytype_dfThresh, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh NO1 Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "Thresh_NO1_","inputOutputRegions_perType.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 20, height = 10, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all NO2 neurons innervate
p0<-ggplot(NO2_roi_Connect_bytype_dfThresh, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh NO2 Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "Thresh_NO2_","inputOutputRegions_perType.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 20, height = 10, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all NO3 neurons innervate
p0<-ggplot(NO3_roi_Connect_bytype_dfThresh, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=roi)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh NO3 Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "Thresh_NO3_","inputOutputRegions_perType.png",sep=""), plot = p0, device='png', scale = 1, 
       width = 20, height = 10, units ="in", dpi = 600, limitsize = TRUE)


```



# Remove some regions/layers and replot data
```{r}

Remove_NO_ROIs=c("CX", "FB-column3", "LX","NO","dACA","gL")
Remove_SubRois=c("PB[(]R","PB[(]L","FBl","EBr","a","b","g")


NO_ROISubset=subset(NO_roi_Connect_bytype_dfThresh, !((roi %in% Remove_NO_ROIs) | 
                                                      roi_names %in% c("PB(C)","LAL(R)") | 
                                                      grepl(paste(Remove_SubRois, collapse="|"), roi)) ) 
NO1_ROISubset=subset(NO1_roi_Connect_bytype_dfThresh, !((roi %in% Remove_NO_ROIs) | 
                                                      roi_names %in% c("PB(C)","LAL(R)") | 
                                                      grepl(paste(Remove_SubRois, collapse="|"), roi)) ) 
NO2_ROISubset=subset(NO2_roi_Connect_bytype_dfThresh, !((roi %in% Remove_NO_ROIs) | 
                                                      roi_names %in% c("PB(C)","LAL(R)") | 
                                                      grepl(paste(Remove_SubRois, collapse="|"), roi)) ) 
NO3_ROISubset=subset(NO3_roi_Connect_bytype_dfThresh, !((roi %in% Remove_NO_ROIs) | 
                                                      roi_names %in% c("PB(C)","LAL(R)") | 
                                                      grepl(paste(Remove_SubRois, collapse="|"), roi)) ) 


# Plot all of the ROIs (and sub ROIs) that all NO neurons innervate
p0<-ggplot(NO_ROISubset, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh/Subset NO Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "F_ThreshSubset_NO_","inputOutputRegions_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 20, height = 10, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all NO1 neurons innervate
p0<-ggplot(NO1_ROISubset, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh/Subset NO1 Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "F_ThreshSubset_NO1_","inputOutputRegions_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 12, height = 6, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all NO2 neurons innervate
p0<-ggplot(NO2_ROISubset, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh/Subset NO2 Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "F_ThreshSubset_NO2_","inputOutputRegions_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 16, height = 8, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all NO3 neurons innervate
p0<-ggplot(NO3_ROISubset, aes(x=roi_names, y=type_name, size=count)) + geom_point(aes(color=type)) +
  facet_grid(cols=vars(prepost)) +  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh/Subset NO3 Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "F_ThreshSubset_NO3_","inputOutputRegions_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 16, height = 8, units ="in", dpi = 600, limitsize = TRUE)



```


## Subset on parent ROIs and some sub ROIs as a princpled way of showing ROIs
```{r}

# Divide parent ROIs into smaller subROIs that we want to show
ROI_LIST=c("hemibrain","CX","NO","NO(R)","NO(L)","LX","LX(R)","LX(L)","PB","LAL(R)") # List of parent ROIs to include
HB_Children=subset(heir, parent %in%  ROI_LIST)
HB_Children=subset(HB_Children, !(roi %in% ROI_LIST) )
HB_Children=subset(HB_Children, !(roi %in% c("POC","mALT(L)","mALT(R)","GF(R)","GC","AOT(R)"))) # Remove fiber bundles


# Create new dataframe (NO_ROISubset) and create a new field (roi_heir_names) with roi names that match those in HB_Children$roi
NO_ROISubset=NO_roi_Connect_bytype_dfThresh
NO_ROISubset$roi_heir_names=NO_ROISubset$roi_names # Make new field with names that match those in HB_Children$roi, the desired ROI list
NO_ROISubset$roi_heir_names= strsplit(as.character(NO_ROISubset$roi_names), "[(]C[)]") # Get rid of (C) in those ROIs that have it
NO_ROISubset$roi_heir_names[ startsWith(as.character(NO_ROISubset$roi_heir_names), "PB(R") ] = 
  strsplit(as.character(NO_ROISubset$roi_heir_names[ startsWith(as.character(NO_ROISubset$roi_heir_names), "PB(R") ]), "[(]R[)]")
NO_ROISubset$roi_heir_names[ startsWith(as.character(NO_ROISubset$roi_heir_names), "PB(L") ] = 
  strsplit(as.character(NO_ROISubset$roi_heir_names[ startsWith(as.character(NO_ROISubset$roi_heir_names), "PB(L") ]), "[(]L[)]")


# Check ExcludedRois to make sure we arent missing an ROI we want
ExcludedRois=unique( NO_ROISubset$roi_heir_names[ !(NO_ROISubset$roi_heir_names %in% HB_Children$roi) ])


# Remove ROIs in NO_ROISubset that aren't in the list provided by HB_Children$roi. Also remove LAL(R) and MB(R), which have super ROIs.
NO_ROISubset=subset(NO_ROISubset, (roi_heir_names %in% HB_Children$roi) & !(roi_names %in% c("LAL(R)","MB(R)")) )


# Relabel roi and roi_names field so that PB(R#) and PB(L#) rois are just PB(R) and PB(L)
NO_ROISubset$roi[startsWith(NO_ROISubset$roi,'PB(L')] <- "PB"
NO_ROISubset$roi[startsWith(NO_ROISubset$roi,'PB(R')] <- "PB"
NO_ROISubset$roi_names = paste(NO_ROISubset$roi, '(', NO_ROISubset$roi_hemi, ')', sep="")
NO_ROISubset$roi_heir_names[startsWith(NO_ROISubset$roi_names,"PB(L")] <- "PB(L)"
NO_ROISubset$roi_heir_names[startsWith(NO_ROISubset$roi_names,"PB(R")] <- "PB(R)"
NO_ROISubset$roi_heir_names=as.character(NO_ROISubset$roi_heir_names)


# Do the same for HB_Children
colnames(HB_Children)[2]='roi_heir_names'
HB_Children$roi_heir_names=as.character(HB_Children$roi_heir_names)
HB_Children$parent=as.character(HB_Children$parent)
HB_Children$roi_heir_names[startsWith(HB_Children$roi_heir_names,"PB(L")] <- "PB(L)"
HB_Children$roi_heir_names[startsWith(HB_Children$roi_heir_names,"PB(R")] <- "PB(R)"
HB_Children=distinct(HB_Children)
HB_Children$parent[ endsWith(as.character(HB_Children$parent), "(L)") ] = 
  strsplit(as.character(HB_Children$parent[ endsWith(as.character(HB_Children$parent), "(L)") ]), "[(]L[)]")
HB_Children$parent[ endsWith(as.character(HB_Children$parent), "(R)") ] = 
  strsplit(as.character(HB_Children$parent[ endsWith(as.character(HB_Children$parent), "(R)") ]), "[(]R[)]")
HB_Children$parent[HB_Children$parent=="LAL"]<-"LX"


# Average PB(L) and PB(R) rois by cell type
NO_ROISubset=aggregate(NO_ROISubset$count, by=list(NO_ROISubset$type, NO_ROISubset$type_name,
                                                             NO_ROISubset$roi,  NO_ROISubset$roi_names, NO_ROISubset$roi_heir_names,
                                                             NO_ROISubset$prepost), mean)
colnames(NO_ROISubset)[c(1,2,3,4,5,6,7)]=c("type","type_name","roi","roi_names","roi_heir_names","prepost","count")


# check to make sure that all plotted ROIs are a subset of the HD_Children ROIs
if (sum(NO_ROISubset$roi_heir_names %in% unique(HB_Children$roi_heir_names)) != length(NO_ROISubset$roi_heir_names)){
  warning('Not all plotted ROIs are in HD_Children!!!!')}


# Join NO_ROISubset with the ROI level information
NO_ROISubset <- merge(NO_ROISubset,HB_Children,by="roi_heir_names")



# Manually set levels for x Axis
ROI_LEVELS=c("NO1(L)","NO1(R)","NO2(L)","NO2(R)","NO3(L)","NO3(R)","EB(C)","PB(L)","PB(R)","FB(C)","AB(R)",
             "BU(L)","BU(R)","LAL(L)","LAL(-GA)(R)","GA(R)","VLNP(R)","INP(C)","VMNP(C)","SNP(L)","SNP(R)",
             "GNG(C)","MB(+ACA)(R)","MB(L)","LH(R)","AL(R)")
ROI_LEVELS[which(!ROI_LEVELS %in% unique(NO_ROISubset$roi_names))]
NO_ROISubset$roi_names[ which(!NO_ROISubset$roi_names %in% ROI_LEVELS)]
NO_ROISubset$roi_names <- factor(NO_ROISubset$roi_names, levels = ROI_LEVELS)


# Make facet for y axis
NO_ROISubset$FACET <- NA
NO_ROISubset$FACET[ (NO_ROISubset$type %in% NO1_Type) & !( (NO_ROISubset$type %in% NO2_Type) | (NO_ROISubset$type %in% NO3_Type) ) ] <- "NO1"
NO_ROISubset$FACET[ (NO_ROISubset$type %in% NO2_Type) & !( (NO_ROISubset$type %in% NO1_Type) | (NO_ROISubset$type %in% NO3_Type) ) ] <- "NO2"
NO_ROISubset$FACET[ (NO_ROISubset$type %in% NO3_Type) & !( (NO_ROISubset$type %in% NO1_Type) | (NO_ROISubset$type %in% NO2_Type) ) ] <- "NO3"
NO_ROISubset$FACET[ (NO_ROISubset$type %in% NO1_Type  &     NO_ROISubset$type %in% NO2_Type) & !(NO_ROISubset$type %in% NO3_Type)  ] <- "NO1/2"
NO_ROISubset$FACET[ (NO_ROISubset$type %in% NO1_Type  &     NO_ROISubset$type %in% NO3_Type) & !(NO_ROISubset$type %in% NO2_Type)  ] <- "NO1/3"
NO_ROISubset$FACET[ (NO_ROISubset$type %in% NO2_Type  &     NO_ROISubset$type %in% NO3_Type) & !(NO_ROISubset$type %in% NO1_Type)  ] <- "NO2/3"
sum(is.na(NO_ROISubset$FACET))
NO_ROISubset$FACET = factor(NO_ROISubset$FACET, levels=c('NO1','NO2','NO3','NO1/2','NO1/3','NO2/3'))


# Factor the types for plotting so the color is good
NO_ROISubset$type = factor(NO_ROISubset$type, levels=c( sort(unique(NO_ROISubset$type[NO_ROISubset$FACET == "NO1"]),decreasing = TRUE),
                                                         sort(unique(NO_ROISubset$type[NO_ROISubset$FACET == "NO2"]),decreasing = TRUE),
                                                         sort(unique(NO_ROISubset$type[NO_ROISubset$FACET == "NO3"]),decreasing = TRUE),
                                                         sort(unique(NO_ROISubset$type[NO_ROISubset$FACET == "NO1/3"]),decreasing = TRUE),
                                                         sort(unique(NO_ROISubset$type[NO_ROISubset$FACET == "NO2/3"]),decreasing = TRUE)))



# Plot all of the ROIs (and sub ROIs) that all NO neurons innervate
p0<-ggplot(NO_ROISubset, aes(x=roi_names, y=type_name, size=count)) + geom_point()  + 
  facet_grid(cols=vars(prepost), rows=vars(FACET), scales="free", space="free") +  scale_fill_manual(values = vars(type)) + aes(color = type) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh/Subset NO Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "Figure_ThreshSubset_NO_","inputOutputRegions_perType.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 12, height = 12, units ="in", dpi = 600, limitsize = TRUE)


# Plot all of the ROIs (and sub ROIs) that all NO neurons innervate
p0<-ggplot(NO_ROISubset, aes(x=roi_names, y=type_name, size=log10(count))) + geom_point()  + 
  facet_grid(cols=vars(prepost), rows=vars(FACET), scales="free", space="free") +  scale_fill_manual(values = vars(type)) + aes(color = type) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90))  + guides(fill=FALSE) +
  ggtitle("Thresh/Subset NO Neuron Input/Output ROIs")
print(p0)
ggsave(paste(PlotDir, "Figure_ThreshSubset_NO_","inputOutputRegions_perTypeLOG10.pdf",sep=""), plot = p0, device='pdf', scale = 1, 
       width = 15, height = 15, units ="in", dpi = 600, limitsize = TRUE)


```



### Plot synapse distributions for questionable neurons
```{r}

```

























