---
title: "Validation analysis"
output: html_notebook
---

```{r}
library(nat)
library(neuprintr)
library(tidyverse)
library(cowplot)

source("neuprintQueryUtils.R")
source("R/table2ggraphUtils.R")
source("InputOutputByTypeUtils.R")
source("R/rois.R")
source("R/ggNeuron.R")
```
  


  
## FB Column 3 vs the rest of the FB

Collecting info on neurons innervating that volume.
```{r}
FBC3Neurons <- neuprint_bodies_in_ROI("FB-column3",all_segments = FALSE)
FBC3Info <- neuprint_get_roiInfo(FBC3Neurons$bodyid,all_segments = FALSE)
```

```{r}
FBC3Meta <- neuprint_get_meta(FBC3Neurons$bodyid,all_segments = FALSE) %>% filter(status=="Traced")
```

```{r}
FBC3Neurons <- left_join(FBC3Meta,FBC3Info %>% select(bodyid,FB.downstream,FB.upstream,!!as.name("FB-column3.downstream"),!!as.name("FB-column3.upstream")),by = "bodyid") %>% filter(!is.na(type))
FBC3Neurons[is.na(FBC3Neurons)] <- 0
FBC3Neurons <- rename(FBC3Neurons,C3.d = !!as.name("FB-column3.downstream"),C3.u = !!as.name("FB-column3.upstream")) %>% mutate(C3.ratio = (C3.d + C3.u)/(FB.upstream+FB.downstream),C3.uRatio=C3.u/FB.upstream,C3.dRatio=C3.d/FB.downstream,databaseType=type)
FBC3Neurons[is.na(FBC3Neurons)] <- 0
FBC3Neurons <- supertype(FBC3Neurons)
```

Filter for "really in this region": neurons we're confident belong here. At least 30 synapses and 10% of it's FB synapses in Column3. This is because the type to type quantification, which will be slightly different here, cannot do the job (as we want to normalize "types" to the area)
```{r}
FBC3Real <- FBC3Neurons %>% filter(C3.uRatio > 0.8 & FB.upstream > 500) 
FBC3RealOut <- FBC3Neurons %>% filter(C3.dRatio > 0.8 & FB.downstream > 500) 
FBC3OutTypes <- FBC3Neurons %>% filter(C3.u > 400) ## Used to filter outputs to consider
```

Compare raw synapse counts in the FB for comparison.
```{r}
FBCTypes_In <- getTypesTable(unique(FBC3Real$type))
FBCTypes_Out <- getTypesTable(unique(FBC3RealOut$type))
FBCTypes_In <- left_join(FBCTypes_In,neuprint_get_roiInfo(FBCTypes_In$bodyid) %>% select(bodyid,FB.upstream))
FBCTypes_Out <- left_join(FBCTypes_Out,neuprint_get_roiInfo(FBCTypes_Out$bodyid) %>% select(bodyid,FB.downstream))
```

```{r}
FBCXReal <- FBCTypes_In %>% filter(!(name %in% FBC3Neurons$name) & FB.upstream>300)
FBCXRealOut <- FBCTypes_Out %>% filter(!(name %in% FBC3Neurons$name) & FB.downstream>300)
```

```{r}
FBCTypes_In <- mutate(FBCTypes_In,C3 = name %in% FBC3Real$name)
FBCTypes_Out <- mutate(FBCTypes_Out,C3 = name %in% FBC3RealOut$name)
```

To be recompared with C7 ?
```{r}
ggplot(supertype(FBCTypes_In),aes(y=FB.upstream,x=as.factor(C3),group=type,color=supertype1)) + stat_summary(fun = mean, geom="point")+ stat_summary(fun = mean, geom="line",aes(group=type)) + scale_color_paletteer_d("Polychrome::palette36")
ggplot(supertype(FBCTypes_Out),aes(y=FB.downstream,x=as.factor(C3),group=type,color=supertype1)) + stat_summary(fun = mean, geom="point")+ stat_summary(fun = mean, geom="line",aes(group=type))+ scale_color_paletteer_d("Polychrome::palette36")
```



Building the full bag in the FB and in the restricted column. Notice that at this stage the numbers for FC3 in the type to type DFs won't "make sense" as they are normalized on all instances.
```{r}
FBC3NeuronsBag <- buildInputsOutputsByType(unique(c(FBC3Real$type,FBC3RealOut$type)),fixed=TRUE,slctROI="FB")
```

Do not redefine the partners (maybe make that an option in the neuronBag method)
```{r}
FBC3Set <- unique(FBC3Real$name)
FBC3OutSet <- unique(FBC3RealOut$name)
FBCXSet <- unique(FBCXReal$name)
FBCXOutSet <- unique(FBCXRealOut$name)
retypedBag <- FBC3NeuronsBag

for (t in unique(FBC3Real$type)){
retypedBag$inputs_raw <- redefineType(retypedBag$inputs_raw,type = t,condition = retypedBag$inputs_raw$name.to %in% FBC3Set,type_col = "type.to",c(paste0(t,"_C3"),t))
retypedBag$names <- redefineType(retypedBag$names,type = t,condition = retypedBag$names$name %in% FBC3Set,type_col = "type",c(paste0(t,"_C3"),t))
retypedBag$inputs_raw <- redefineType(retypedBag$inputs_raw,type = t,condition = retypedBag$inputs_raw$name.to %in% FBCXSet,type_col = "type.to",c(paste0(t,"_CX"),t))
retypedBag$names <- redefineType(retypedBag$names,type = t,condition = retypedBag$names$name %in% FBCXSet,type_col = "type",c(paste0(t,"_CX"),t))
}

for (t in unique(FBC3RealOut$type)){
retypedBag$outputs_raw <- redefineType(retypedBag$outputs_raw,type = t,condition = retypedBag$outputs_raw$name.from %in% FBC3OutSet,type_col = "type.from",c(paste0(t,"_C3"),t))
retypedBag$outputs_raw <- redefineType(retypedBag$outputs_raw,type = t,condition = retypedBag$outputs_raw$name.from %in%  FBCXOutSet,type_col = "type.from",c(paste0(t,"_CX"),t))
}
retypedBag$inputs <- getTypeToTypeTable(retypedBag$inputs_raw,typesTable=retypedBag$names,oldTable=retypedBag$inputs)
retypedBag$outputs <-  getTypeToTypeTable(retypedBag$outputs_raw,typesTable=retypedBag$outputsTableRef,oldTable=retypedBag$outputs) 
```

```{r}
FBC3InputComp <- retypedBag$inputs %>% filter(grepl("_C[3|X]",type.to)) %>% 
  mutate(column=substring(str_extract(type.to,"_C[3|X]"),2)) %>%
  group_by(databaseType.from,databaseType.to,column) %>%
  summarize(weightRelative=sum(weightRelative)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype.from",1:3)),c(paste0("supertype.to",1:3))),
              names_from= "column",
              values_from = "weightRelative",
              values_fill=list("weightRelative"=0))
```

```{r}
FBC3OutputComp <- retypedBag$outputs %>% filter(grepl("_C[3|X]",type.from) & (type.to %in% unique(FBC3OutTypes$type))) %>% 
  mutate(column=substring(str_extract(type.from,"_C[3|X]"),2)) %>%
  group_by(databaseType.from,databaseType.to,column) %>%
  summarize(outputContribution=mean(outputContribution)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype.from",1:3)),c(paste0("supertype.to",1:3))),
              names_from= "column",
              values_from = "outputContribution",
              values_fill=list("outputContribution"=0))
```

```{r}
inputCor <- cor(FBC3InputComp$C3,FBC3InputComp$CX)
outputCor <- cor(FBC3OutputComp$C3,FBC3OutputComp$CX)
```

```{r}
allTypes <- unique(c(retypedBag$inputs_raw$supertype.from2,retypedBag$outputs_raw$supertype.to2))
myPal <- typesPalette(allTypes)
```


```{r}
inputPlot <- ggplot(FBC3InputComp,aes(x=C3,y=CX,group=databaseType.to)) + geom_point(aes(color=supertype.from2),size=4)  + geom_abline(linetype=2) + theme_minimal()  + scale_color_manual(values=myPal,name="Partner type",breaks=allTypes) + xlab("Relative input weight in column 3") + ylab("Relative input weight in the rest of the FB") + facet_wrap(supertype.to2~.) + ggtitle("Receiving in FB")
outputPlot <- ggplot(FBC3OutputComp,aes(x=C3,y=CX,group=databaseType.from)) + geom_point(aes(color=supertype.to2),size=4) +  geom_abline(linetype=2) +theme_minimal()+ scale_color_manual(values=myPal)  + xlab("Relative output contribution in column 3") + ylab("Relative output contribution in the rest of the FB") + facet_wrap(supertype.from2~.) + ggtitle("Sending in FB")
FBComp <- plot_grid(inputPlot+ theme(legend.position = "none"),outputPlot+ theme(legend.position = "none"))
leg <- get_legend(inputPlot + theme(legend.box.margin = margin(0, 0, 0, 12)))
FBComp <- plot_grid(FBComp,leg, rel_widths = c(3, .4))
FBComp
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/C3CompPlot.svg",FBComp,height=7,width=13)
```



```{r}
FBC3NeuronsBagRe <- FBC3NeuronsBag
for (FBCol in paste0("_C",1:9)){
  print(FBCol)
  FBC3NeuronsBagRe <- redefineTypeByNameInList(FBC3NeuronsBagRe,unique(FBC3NeuronsBagRe$names$type),pattern = FBCol,newPostFixes = c(FBCol,""))
}
```

```{r}
FBC3Ratios <- FBC3NeuronsBagRe$names
FBC3Ratios <- mutate(FBC3Ratios,C3.uRatio = ifelse(bodyid %in% FBC3Neurons$bodyid,FBC3Neurons$C3.uRatio[match(bodyid,FBC3Neurons$bodyid)],0),
                                C3.dRatio = ifelse(bodyid %in% FBC3Neurons$bodyid,FBC3Neurons$C3.dRatio[match(bodyid,FBC3Neurons$bodyid)],0)) %>% 
              group_by(type) %>%
              summarize_at(c("C3.uRatio","C3.dRatio"),mean)
```


```{r}
ColumnsInputComp <- FBC3NeuronsBagRe$inputs %>% filter(grepl("_C[1-9]",type.to)) %>% 
  mutate(column=substring(str_extract(type.to,"_C[1-9]"),2),
         C3.uRatio=FBC3Ratios$C3.uRatio[match(type.to,FBC3Ratios$type)]) %>%
  group_by(databaseType.from,databaseType.to,column) %>%
  summarize(weightRelative=sum(weightRelative),
            C3.uRatio=mean(C3.uRatio)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype.from",1:3)),c(paste0("supertype.to",1:3))),
              names_from= "column",
              values_from = c("weightRelative","C3.uRatio"),
              values_fill=list("weightRelative"=0,"C3.uRatio"=0))
```

```{r}
ColumnsOutputComp <- FBC3NeuronsBagRe$outputs %>% filter(grepl("_C[1-9]",type.from)) %>% 
  mutate(column=substring(str_extract(type.from,"_C[1-9]"),2)) %>%
  group_by(databaseType.from,databaseType.to,column) %>%
  summarize(weightRelative=sum(weightRelative)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype.from",1:3)),c(paste0("supertype.to",1:3))),names_from= "column",values_from = "weightRelative") %>%
  replace_na(list("C1"=0,"C2"=0,"C5"=0,"C3"=0,"C4"=0,"C6"=0,"C7"=0,"C8"=0,"C9"=0))

```




```{r}
columnsCorPlot <- ggcorr(ColumnsInputComp %>% select_at(c("C1","C2","C3","C4","C5","C6","C7","C8","C9")),limits=c(0.8,1),midpoint=0.8,label = TRUE,label_round = 2)
columnsCorPlot
```
```{r}
my_cor_fn <- function(data, mapping, method="p", use="pairwise", minV = 0,...){

              # grab data
              x <- eval_data_col(data, mapping$x)
              y <- eval_data_col(data, mapping$y)

              # calculate correlation
              corr <- cor(x, y, method=method, use=use)

              # calculate colour based on correlation value
              # Here I have set a correlation of minus one to blue, 
              # zero to white, and one to red 
              # Change this to suit: possibly extend to add as an argument of `my_fn`
              colFn <-paletteer_c("ggthemes::Red",200)
              fill <- colFn[findInterval(corr, seq(minV, 1, length=200))]

              ggally_cor(data = data, mapping = mapping, color="black",...) + 
                theme_void() +
                theme(panel.background = element_rect(fill=fill,size = 0))
            }

my_res_fn <- function(data,mapping,bins=50,...){
  x <- eval_data_col(data, mapping$x)
  y <- eval_data_col(data, mapping$y)
  varProp <- str_extract(as_label(mapping$x),pattern = "C[1-9]")
  columnProp <-  eval_data_col(data, mapping[[varProp]])
  ggplot(data) + geom_point(aes(x=x,y=y,color=columnProp),...) + geom_abline(linetype=2,color="grey80") + scale_color_paletteer_c("ggthemes::Blue",direction = -1,limits=c(0,1),"Proportion of \nsynapses in \nthe better traced volume") + theme_minimal()
}

myDiagFunc <- function(data,mapping,theme=theme_minimal()){
  ggally_densityDiag(data,mapping) + theme
}
  
```

```{r}
fullPairsPlot <- ggpairs(FBC3InputComp,columns = paste0("weightRelative_C",1:9),aes(C1=C3.uRatio_C1,
                                                                                    C2=C3.uRatio_C2,
                                                                                    C3=C3.uRatio_C3,
                                                                                    C4=C3.uRatio_C4,
                                                                                    C5=C3.uRatio_C5,
                                                                                    C6=C3.uRatio_C6,
                                                                                    C7=C3.uRatio_C7,
                                                                                    C8=C3.uRatio_C8,
                                                                                    C9=C3.uRatio_C9),columnLabels = paste0("C",1:9),
                    upper = list(continuous = wrap(my_res_fn,alpha=0.5)),lower=list(continuous=wrap(my_res_fn,alpha=0.5)),diag = list(continuous=myDiagFunc),progress = FALSE,legend=c(2,1))
fullPairsPlot
```


```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/ColumnsPairPlot.svg",fullPairsPlot,width=15,height=13)
```

### Anatomy illustration of FB column 3
```{r}
FC3Mesh <- readobj::read.obj("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/FB-column3.obj",convert.rgl = TRUE)[[1]]
```

```{r}
FBC3 <- roiOutline(FC3Mesh,roiName = "FB Column3")
```

```{r}
FB <- roiOutline("FB")
```

```{r}
FBC3InputsAnatomies <- neuprint_read_neurons(FBC3Real$bodyid,resample=10) ## Resampling usually avoids cutting artefacts to appear
FBC3OutputsAnatomies <- neuprint_read_neurons(FBC3RealOut$bodyid,resample=10)
```


```{r}
FBC3InputsAnatomies <- bind_rows(list(neuronForGG(FBC3InputsAnatomies) %>% mutate(proj="xy"),neuronForGG(FBC3InputsAnatomies,axis=c("x","z")) %>% mutate(proj="xz")))
FBC3OutputsAnatomies <- bind_rows(list(neuronForGG(FBC3OutputsAnatomies) %>% mutate(proj="xy"),neuronForGG(FBC3OutputsAnatomies,axis=c("x","z")) %>% mutate(proj="xz")))
```


```{r}
FBC3InputsAnatomiesDF <- mutate(FBC3InputsAnatomies,supertype2 = FBC3Real$supertype2[match(bodyid,FBC3Real$bodyid)])
FBC3OutputsAnatomiesDF <- mutate(FBC3OutputsAnatomies,supertype2 = FBC3RealOut$supertype2[match(bodyid,FBC3RealOut$bodyid)])
```

```{r}
C3InputsPlot <- ggplot(FBC3InputsAnatomiesDF,aes(x,y,group=bodyid,fill=supertype2),alpha=0.5) + geom_polygon() + geom_path(data=FB,aes(x=x,y=y),inherit.aes = FALSE)   + geom_polygon(data=FBC3,aes(x=x,y=y),fill="grey50",alpha=0.3,inherit.aes = FALSE)+ coord_fixed() + scale_fill_manual(values=myPal,name="Type",breaks=allTypes) + scale_y_reverse() + theme_void() +facet_grid(proj~.)
```

```{r}
C3InputsPlot
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/C3TargetsAnatomies.svg",C3InputsPlot,height=21)
```
```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/C3TargetsAnatomies.png",C3InputsPlot,height=21)
```

```{r}
C3OutputsPlot <- ggplot(FBC3OutputsAnatomiesDF,aes(x,y,group=bodyid,fill=supertype2),alpha=0.5) + geom_polygon() + geom_path(data=FB,aes(x=x,y=y),inherit.aes = FALSE)   + geom_polygon(data=FBC3,aes(x=x,y=y),fill="grey50",alpha=0.3,inherit.aes = FALSE)+ coord_fixed() + scale_fill_manual(values=myPal,name="Type",breaks=allTypes) + scale_y_reverse() + theme_void() +facet_grid(proj~.)
```

```{r}
C3OutputsPlot
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/C3TargetingAnatomies.svg",C3OutputsPlot,height=21)
```
```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/C3TargetingAnatomies.png",C3OutputsPlot,height=21)
```

### Comparing with the old version of the dataset
```{r}
newConnection <- neuprint_connection()
```

```{r}
oldConnection <- neuprint_connection(server="https://emdata1.int.janelia.org:11000/",token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InJvbWFpbi5mcmFuY29udmlsbGVAZ21haWwuY29tIiwibGV2ZWwiOiJyZWFkd3JpdGUiLCJpbWFnZS11cmwiOiJodHRwczovL2xoNi5nb29nbGV1c2VyY29udGVudC5jb20vLWdtUDkxREF4LTNvL0FBQUFBQUFBQUFJL0FBQUFBQUFBQUFBL0FBS1dKSk14RURObVNiekk5TjNULWw2RkRySWhHdG5LNncvcGhvdG8uanBnP3N6PTUwP3N6PTUwIiwiZXhwIjoxNzY2NDY0NjI2fQ.HsBHKOqeLUUcBcOY-GwzbCHrBMdCBesaICM4UUQSH_k",config=httr::config(ssl_verifypeer=0L))
```

```{r,warning=FALSE}
newRawTable <- neuprint_connection_table(FBC3Real$bodyid,"PRE",roi="FB-column3",conn=newConnection) %>% drop_na(ROIweight)
oldRawTable <- neuprint_connection_table(FBC3Real$bodyid,"PRE",roi="FB-column3",conn=oldConnection) %>% drop_na(ROIweight)
```

```{r,warning=FALSE}
newRefTable <- neuprint_get_meta(FBC3Real$bodyid,conn=newConnection)
oldRefTable <- neuprint_get_meta(FBC3Real$bodyid,conn=oldConnection) %>% mutate(type=newRefTable$type[match(bodyid,newRefTable$bodyid)]) 

newPartnerTable <- neuprint_get_meta(newRawTable$partner,conn=newConnection)
```

We want to remove bodyids that do not exist in one of the dataframes.
```{r,warning=FALSE}
newPartnersOldDataset <- neuprint_get_meta(newRawTable$partner,conn=oldConnection)
oldPartnersNewDataset <- neuprint_get_meta(oldRawTable$partner,conn=newConnection)

oldPartnerTable <- neuprint_get_meta(oldRawTable$partner,conn=oldConnection) %>% mutate(type=oldPartnersNewDataset$type[match(bodyid,oldPartnersNewDataset$bodyid)]) 

newRawTable <- filter(newRawTable,partner %in% newPartnersOldDataset$bodyid)
oldRawTable <- filter(oldRawTable,partner %in% oldPartnersNewDataset$bodyid)

newPartnerTable <- filter(newPartnerTable,bodyid %in% newPartnersOldDataset$bodyid)
oldPartnerTable <- filter(oldPartnerTable,bodyid %in% oldPartnersNewDataset$bodyid)
```



```{r,warning=FALSE}
newConnTable <- processConnectionTable(newRawTable,newRefTable,newPartnerTable,newRefTable,"PRE",slctROI="FB-column3",by.roi=FALSE,verbose=FALSE,chunk_meta=TRUE,conn=newConnection)
oldConnTable <- processConnectionTable(oldRawTable,oldRefTable,oldPartnerTable,oldRefTable,"PRE",slctROI="FB-column3",by.roi=FALSE,verbose=FALSE,chunk_meta=TRUE,conn=oldConnection)
```

```{r,warning=FALSE}
newRawTableOut <- neuprint_connection_table(FBC3RealOut$bodyid,"POST",roi="FB-column3",conn=newConnection) %>% drop_na(ROIweight)
oldRawTableOut <- neuprint_connection_table(FBC3RealOut$bodyid,"POST",roi="FB-column3",conn=oldConnection) %>% drop_na(ROIweight)
```

```{r,warning=FALSE}
newRefTableOut <- neuprint_get_meta(FBC3RealOut$bodyid,conn=newConnection)
oldRefTableOut <- neuprint_get_meta(FBC3RealOut$bodyid,conn=oldConnection) %>% mutate(type=newRefTableOut$type[match(bodyid,newRefTableOut$bodyid)]) 

newPartnerTableOut <- neuprint_get_meta(newRawTableOut$partner,conn=newConnection)
```

We want to remove bodyids that do not exist in one of the dataframes.
```{r,warning=FALSE}
newPartnersOldDatasetOut <- neuprint_get_meta(newRawTableOut$partner,conn=oldConnection)
oldPartnersNewDatasetOut <- neuprint_get_meta(oldRawTableOut$partner,conn=newConnection)

oldPartnerTableOut <- neuprint_get_meta(oldRawTableOut$partner,conn=oldConnection) %>% mutate(type=oldPartnersNewDatasetOut$type[match(bodyid,oldPartnersNewDatasetOut$bodyid)]) 

newRawTableOut <- filter(newRawTableOut,partner %in% newPartnersOldDatasetOut$bodyid)
oldRawTableOut <- filter(oldRawTableOut,partner %in% oldPartnersNewDatasetOut$bodyid)

newPartnerTableOut <- filter(newPartnerTableOut,bodyid %in% newPartnersOldDatasetOut$bodyid)
oldPartnerTableOut <- filter(oldPartnerTableOut,bodyid %in% oldPartnersNewDatasetOut$bodyid)
```

```{r,warning=FALSE}
newConnTableOut <- processConnectionTable(newRawTableOut,newRefTableOut,newPartnerTableOut,newRefTableOut,"POST",slctROI="FB-column3",by.roi=FALSE,verbose=FALSE,chunk_meta=TRUE,conn=newConnection)
oldConnTableOut <- processConnectionTable(oldRawTableOut,oldRefTableOut,oldPartnerTableOut,oldRefTableOut,"POST",slctROI="FB-column3",by.roi=FALSE,verbose=FALSE,chunk_meta=TRUE,conn=oldConnection)
```

```{r}
inputsAges <- full_join(newConnTable,oldConnTable,by = c("from","to","roi","type.from","type.to","supertype.from2","supertype.to2"),suffix=c(".new",".old")) %>% replace_na(list("ROIweight.new"=0,
                                                                                                                                                                               "ROIweight.old"=0,
                                                                                                                                                                               "weight.new"=0,
                                                                                                                                                                               "weight.old"=0,
                                                                                                                                                                               "weightRelative.new"=0,
                                                                                                                                                                               "weightRelative.old"=0,
                                                                                                                                                                               "outputContribution.new"=0,
                                                                                                                                                                               "outputContribution.old"=0))

outputsAges <- full_join(newConnTableOut,oldConnTableOut,by = c("from","to","roi","type.from","type.to","supertype.from2","supertype.to2"),suffix=c(".new",".old")) %>% replace_na(list("ROIweight.new"=0,
                                                                                                                                                                               "ROIweight.old"=0,
                                                                                                                                                                               "weight.new"=0,
                                                                                                                                                                               "weight.old"=0,
                                                                                                                                                                               "weightRelative.new"=0,
                                                                                                                                                                               "weightRelative.old"=0,
                                                                                                                                                                               "outputContribution.new"=0,
                                                                                                                                                                               "outputContribution.old"=0))

```

```{r}
oldNewInputs <- ggplot(inputsAges,aes(x=weightRelative.old,y=weightRelative.new)) + geom_point(alpha=0.5,aes(color=supertype.from2,size=ROIweight.new))  + geom_abline(linetype=2) + scale_color_manual(values=myPal,name="Partner type",breaks=allTypes) + theme_minimal() + facet_wrap(supertype.to2~.) + xlab("Relative weight in the old dataset") + ylab("Relative weight in the new dataset") + scale_size(name="# synapses in new dataset") + ggtitle("Receiving in FB column3")
oldNewOutputs <- ggplot(outputsAges,aes(x=outputContribution.old,y=outputContribution.new)) + geom_point(alpha=0.5,aes(color=supertype.to2,size=ROIweight.new)) + geom_abline(linetype=2) + scale_color_manual(values=myPal,name="Partner type",breaks=allTypes) + theme_minimal() + facet_wrap(supertype.from2~.)+ xlab("Output contribution in the old dataset") + ylab("Output contribution in the new dataset") + ggtitle("Sending in FB column3")
FBCompOldNew <- plot_grid(oldNewInputs+ theme(legend.position = "none"),oldNewOutputs+ theme(legend.position = "none"))
legOldNew <- get_legend(oldNewInputs + theme(legend.box.margin = margin(0, 0, 0, 12)))
FBCompOldNew <- plot_grid(FBCompOldNew,legOldNew, rel_widths = c(3, .4))
FBCompOldNew
```
```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/C3CompPlotOldNew.svg",FBCompOldNew,height=7,width=13)
```

```{r}
ggplot(inputsAges,aes(x=ROIweight.new,y=abs(weightRelative.old-weightRelative.new))) + geom_point(alpha=0.2)
```

## PB glomeruli comparisons
```{r}
PBTypesTable <- getTypesInRoiTable("PB",lateralize = FALSE,slctROI="PB")
```


```{r}
PBL3 <- PBTypesTable$names %>% filter(grepl("_L3_",name))
PBL4 <- PBTypesTable$names %>% filter(grepl("_L4_",name))
PBR3 <- PBTypesTable$names %>% filter(grepl("_R3_",name))
PBR4 <- PBTypesTable$names %>% filter(grepl("_R4_",name))
```

```{r}
PBL3LocalBag <- localized(PBTypesTable,"PB",localRef = PBL3)
PBL4LocalBag <- localized(PBTypesTable,"PB",localRef = PBL4)
PBR3LocalBag <- localized(PBTypesTable,"PB",localRef = PBR3)
PBR4LocalBag <- localized(PBTypesTable,"PB",localRef = PBR4)
```

```{r}
PBTypesTableInputComp <- bind_rows(PBL3LocalBag$inputs %>% mutate(roi="L3"),
                                   PBR4LocalBag$inputs %>% mutate(roi="R4"),
                                   PBR3LocalBag$inputs %>% mutate(roi="R3"),
                                   PBL4LocalBag$inputs %>% mutate(roi="L4")) %>% mutate(weightRelativeR = weightRelative*n_type/n_targets)
PBTypesTableInputComp <- PBTypesTableInputComp %>% pivot_wider(id_cols=c("type.from","type.to",c(paste0("supertype.from",1:3)),c(paste0("supertype.to",1:3))),names_from="roi",values_from = "weightRelativeR")
PBTypesTableInputComp <-  replace_na(PBTypesTableInputComp,list("R3"=0,"L4"=0,"R4"=0,"L3"=0))
```

```{r}
PBPairsPlot <- ggpairs(PBTypesTableInputComp,columns = c("L4","R3","R4","L3"),aes(alpha=0.5),
                    upper = list(continuous = function(data,mapping) my_cor_fn(data,mapping,minV=0.65)),progress = FALSE)
PBPairsPlot
```


```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/PBPairPlot.svg",PBPairsPlot,width=8,height=7)
```



