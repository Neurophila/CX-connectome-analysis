---
title: "Validation analysis"
output: html_notebook
---

```{r}
library(neuprintr)
library(tidyverse)
library(cowplot)
library(ggiraph)
library(neuprintrExtra)
library(paletteer)
```
  
```{r}
validationFolder <- "~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/"
```


  
## FB Column 3 vs the rest of the FB

Collecting info on neurons innervating that volume.
```{r}
FBC3Neurons <- neuprint_bodies_in_ROI("FB-column3",all_segments = FALSE)
FBC3Info <- neuprint_get_roiInfo(FBC3Neurons$bodyid,all_segments = FALSE)
```

```{r}
FBC3Meta <- neuprint_get_meta(FBC3Neurons$bodyid,all_segments = FALSE) %>% filter(status=="Traced")
```

```{r}
FBC3Neurons <- left_join(FBC3Meta,FBC3Info %>% select(bodyid,FB.downstream,FB.upstream,!!as.name("FB-column3.downstream"),!!as.name("FB-column3.upstream")),by = "bodyid") %>% filter(!is.na(type))
FBC3Neurons[is.na(FBC3Neurons)] <- 0
FBC3Neurons <- rename(FBC3Neurons,C3.d = !!as.name("FB-column3.downstream"),C3.u = !!as.name("FB-column3.upstream")) %>% mutate(C3.ratio = (C3.d + C3.u)/(FB.upstream+FB.downstream),C3.uRatio=C3.u/FB.upstream,C3.dRatio=C3.d/FB.downstream,databaseType=type)
FBC3Neurons[is.na(FBC3Neurons)] <- 0
FBC3Neurons <- supertype(FBC3Neurons)
```

Filter for "really in this region": neurons we're confident belong here. At least 200 synapses and 90% of it's FB synapses in Column3. This is because the type to type quantification, which will be slightly different here, cannot do the job (as we want to normalize "types" to the area)
```{r}
FBC3Real <- FBC3Neurons %>% filter(C3.uRatio > 0.8 & FB.upstream > 200) 
FBC3RealOut <- FBC3Neurons %>% filter(C3.dRatio > 0.8 & FB.downstream > 200) 
```

Compare raw synapse counts in the FB for comparison. To be done before/after instead.
```{r}
FBCTypes_In <- getTypesTable(unique(FBC3Real$type))
FBCTypes_Out <- getTypesTable(unique(FBC3RealOut$type))
FBCTypes_In <- left_join(FBCTypes_In,neuprint_get_roiInfo(FBCTypes_In$bodyid) %>% select(bodyid,FB.upstream,FB.post))
FBCTypes_Out <- left_join(FBCTypes_Out,neuprint_get_roiInfo(FBCTypes_Out$bodyid) %>% select(bodyid,FB.downstream,FB.pre))
```

```{r}
FBCXReal <- FBCTypes_In %>% filter(!(bodyid %in% FBC3Neurons$bodyid))
FBCXRealOut <- FBCTypes_Out %>% filter(!(bodyid %in% FBC3Neurons$bodyid))# & FB.downstream>500)
```

```{r}
FBCTypes_In <- mutate(FBCTypes_In,C3 = bodyid %in% FBC3Real$bodyid)
FBCTypes_Out <- mutate(FBCTypes_Out,C3 = bodyid %in% FBC3RealOut$bodyid)
```


Building the full bag in the FB and in the restricted column. Notice that at this stage the numbers for FC3 in the type to type DFs won't "make sense" as they are normalized on all instances.
```{r}
FBC3NeuronsBag <- create_neuronBag(unique(c(FBC3Real$type,FBC3RealOut$type)),fixed=TRUE,slctROI="FB",synThresh=0,computeKnownRatio=TRUE,verbose=TRUE)
```

Redefine types (different renaming for inputs and outputs)
```{r}
FBC3Set <- unique(FBC3Real$name)
FBC3OutSet <- unique(FBC3RealOut$name)
FBCXSet <- unique(FBCXReal$name)
FBCXOutSet <- unique(FBCXRealOut$name)
retypedBag <- FBC3NeuronsBag

retypedBag$inputs_raw <- redefineTypeByName(FBC3NeuronsBag$inputs_raw,postfix="to",sets=list(FBC3Set,FBCXSet),nameModifiers=c("_C3","_CX"))
retypedBag$names <- redefineTypeByName(FBC3NeuronsBag$names,sets=list(FBC3Set,FBCXSet),nameModifiers=c("_C3","_CX"),postfix = "raw")
retypedBag$outputs_raw <- redefineTypeByName(retypedBag$outputs_raw,postfix="from",sets=list(FBC3OutSet,FBCXOutSet),nameModifiers=c("_C3","_CX"))

retypedBag$inputs <- getTypeToTypeTable(retypedBag$inputs_raw,typesTable=retypedBag$names,oldTable=retypedBag$inputs)
retypedBag$outputs <-  getTypeToTypeTable(retypedBag$outputs_raw,typesTable=retypedBag$outputsTableRef,oldTable=retypedBag$outputs) 
```

```{r}
FBC3InputComp <- retypedBag$inputs %>% filter(grepl("_C[3|X]",type.to)) %>% 
  mutate(column=substring(str_extract(type.to,"_C[3|X]"),2)) %>%
  group_by(databaseType.from,databaseType.to,column) %>%
  summarize(weightRelative=sum(knownWeightRelative)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype.from",1:3)),c(paste0("supertype.to",1:3))),
              names_from= "column",
              values_from = "weightRelative",
              values_fill=list("weightRelative"=0))
```

```{r}
FBC3OutputComp <- retypedBag$outputs %>% filter(grepl("_C[3|X]",type.from)) %>% 
  mutate(column=substring(str_extract(type.from,"_C[3|X]"),2)) %>%
  group_by(databaseType.from,databaseType.to,column) %>%
  summarize(outputContribution=mean(knownOutputContribution)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype.from",1:3)),c(paste0("supertype.to",1:3))),
              names_from= "column",
              values_from = "outputContribution",
              values_fill=list("outputContribution"=0))
```

```{r}
inputCor <- cor(FBC3InputComp$C3,FBC3InputComp$CX)
outputCor <- cor(FBC3OutputComp$C3,FBC3OutputComp$CX)
```

```{r}
allTypes <- unique(c(retypedBag$inputs_raw$supertype.from2,retypedBag$outputs_raw$supertype.to2))
myPal <- typesPalette(allTypes)
```


```{r}
inputPlot <- ggplot(FBC3InputComp,aes(x=C3,y=CX)) + geom_point_interactive(aes(color=supertype.to2,
                                                                               tooltip=paste0(databaseType.from," to ", databaseType.to,".\n",
                                                                                              format(C3,digits=3,scientific=FALSE)," in C3, ",
                                                                                              format(CX,digits=3,scientific=FALSE)," outside C3.")),alpha=0.5)  + 
  geom_abline(linetype=2) + theme_minimal()  + scale_color_manual(values=myPal,name="Type",breaks=allTypes) + xlab("Relative input weight in column 3") + 
  ylab("Relative input weight in the rest of the FB") + ggtitle(paste0("Receiving in FB. r = ",format(inputCor,digits = 3)))

outputPlot <- ggplot(FBC3OutputComp,aes(x=C3,y=CX)) + geom_point_interactive(aes(color=supertype.from2,
                                                                               tooltip=paste0(databaseType.from," to ", databaseType.to,".\n",
                                                                                              format(C3,digits=3,scientific=FALSE)," in C3, ",
                                                                                              format(CX,digits=3,scientific=FALSE)," outside C3.")),alpha=0.5) +  
  geom_abline(linetype=2) + theme_minimal()+ scale_color_manual(values=myPal)  + 
  xlab("Relative output weight in column 3") + ylab("Relative output weight in the rest of the FB") + ggtitle(paste0("Sending in FB. r = ",format(outputCor,digits = 3)))
FBComp <- plot_grid(inputPlot+ theme(legend.position = "none"),outputPlot+ theme(legend.position = "none"))
leg <- get_legend(inputPlot + theme(legend.box.margin = margin(0, 0, 0, 12)))
FBComp <- plot_grid(FBComp,leg, rel_widths = c(3, .4))
FBComp
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/C3CompPlot.svg",FBComp,height=5,width=8)
```

```{r}
FBComp_inter <- girafe(ggobj = FBComp, width_svg=7,height_svg=7)
```

```{r}
htmlwidgets::saveWidget(FBComp_inter,paste0(validationFolder,"C3CompPlot.html"))
```

```{r}
inputPlotQQ <- ggplot(FBC3InputComp,aes(sample=C3-CX)) + stat_qq(aes(color=supertype.to2,alpha=0.5)) + stat_qq_line(linetype=2) + ggtitle(paste0("Receiving in FB. r = ",format(inputCor,digits = 3))) + theme_minimal()+ scale_color_manual(values=myPal)+ ylim(c(-0.1,0.2))

outputPlotQQ <- ggplot(FBC3OutputComp,aes(sample=C3-CX)) +  stat_qq(aes(color=supertype.from2,alpha=0.5)) + stat_qq_line(linetype=2) +
 theme_minimal()+ scale_color_manual(values=myPal)  + 
 ggtitle(paste0("Sending in FB. r = ",format(outputCor,digits = 3))) + ylim(c(-0.1,0.2))
FBCompQQ <- plot_grid(inputPlotQQ+ theme(legend.position = "none"),outputPlotQQ+ theme(legend.position = "none"))
leg <- get_legend(inputPlotQQ + theme(legend.box.margin = margin(0, 0, 0, 12)))
FBCompQQ <- plot_grid(FBCompQQ,leg, rel_widths = c(3, .4))
FBCompQQ
```
```{r}
ggsave(paste0(validationFolder,"FBC3CompQQ.svg"))
```


### Anatomy illustration of FB column 3
```{r}
FC3Mesh <- readobj::read.obj("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/FB-column3.obj",convert.rgl = TRUE)[[1]]
```

```{r}
FBC3 <- roiOutline(FC3Mesh,roiName = "FB Column3")
```

```{r}
FB <- roiOutline("FB")
```

```{r}
FBC3InputsAnatomies <- neuprint_read_neurons(FBC3Real$bodyid,resample=10,meta=FALSE,connectors=FALSE) ## Resampling usually avoids cutting artefacts to appear
FBC3OutputsAnatomies <- neuprint_read_neurons(FBC3RealOut$bodyid,resample=10,meta=FALSE,connectors=FALSE)
```

```{r}
FBC3InputsAnatomies <- bind_rows(list(neuron2polygon(FBC3InputsAnatomies,cl=20),neuron2polygon(FBC3InputsAnatomies,axis=c("x","z"),cl=20)))
FBC3OutputsAnatomies <- bind_rows(list(neuron2polygon(FBC3OutputsAnatomies,cl=20),neuron2polygon(FBC3OutputsAnatomies,axis=c("x","z"),cl=20)))
```

```{r}
FBC3InputsAnatomies <- mutate(FBC3InputsAnatomies,supertype2 = FBC3Real$supertype2[match(bodyid,FBC3Real$bodyid)])
FBC3OutputsAnatomies <- mutate(FBC3OutputsAnatomies,supertype2 = FBC3RealOut$supertype2[match(bodyid,FBC3RealOut$bodyid)])
```

```{r}
ExampleC3Anat <- filter(FBC3InputsAnatomies,bodyid %in% filter(FBC3Real,type=="FC2A")$bodyid)
```

```{r}
FBCXExampleAnatomies <- neuprint_read_neurons(filter(FBCXReal,type=="FC2A")$bodyid,resample=10,meta=FALSE,connectors=FALSE)
```

```{r}
FBCXExampleAnatomies <- bind_rows(list(neuron2polygon(FBCXExampleAnatomies,cl=20),neuron2polygon(FBCXExampleAnatomies,axis=c("x","z"),cl=20)))
```



```{r}
C3InputsPlot <- ggplot() + geom_polygon(data=FBCXExampleAnatomies[seq(1,by=10,to = nrow(FBCXExampleAnatomies)),],aes(x,y,group=bodyid),fill="grey50") + 
  geom_polygon(data=ExampleC3Anat[seq(1,by=10,to = nrow(ExampleC3Anat)),],aes(x,y,group=bodyid),fill="#0072B2") + geom_path(data=FB,aes(x=x,y=y),inherit.aes = FALSE)   + geom_polygon(data=FBC3,aes(x=x,y=y),linetype=2,alpha=0.3,inherit.aes = FALSE,fill="#908827")+ coord_fixed() + scale_fill_manual(values=myPal,name="Type",breaks=allTypes) + scale_y_reverse() + theme_void() +facet_grid(proj~.)
```

```{r}
C3InputsPlot
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/C3TargetsAnatomies.svg",C3InputsPlot,height=21)
```

```{r}
C3OutputsPlot <- ggplot(FBC3OutputsAnatomies,aes(x,y,group=bodyid,fill=supertype2)) + geom_polygon() + geom_path(data=FB,aes(x=x,y=y),inherit.aes = FALSE)   + geom_polygon(data=FBC3,aes(x=x,y=y),linetype=2,alpha=0.3,inherit.aes = FALSE)+ coord_fixed() + scale_fill_manual(values=myPal,name="Type",breaks=allTypes) + scale_y_reverse() + theme_void() +facet_grid(proj~.)
```

```{r}
FBC3Panel <- plot_grid(C3InputsPlot+ theme(legend.position = "none"),FBComp,rel_widths = c(0.5,1))
FBC3Panel
```

```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/FBC3.svg",FBC3Panel,height=7,width=17)
```

### FBC3 vs FB, figure panel

## PB glomeruli comparisons

 Do not use names, do the exact same kind of criterion as before.
```{r}
PBTypesTable <- getTypesInRoiTable("PB",lateralize = FALSE,slctROI="PB",synThresh=0,computeKnownRatio=TRUE)
```

Redefine types (different renaming for inputs and outputs)
```{r}
PBL3 <- PBTypesTable$names %>% filter(grepl("_L3_",name))
PBL4 <- PBTypesTable$names %>% filter(grepl("_L4_",name))
PBR3 <- PBTypesTable$names %>% filter(grepl("_R3_",name))
PBR4 <- PBTypesTable$names %>% filter(grepl("_R4_",name))

retypedBagPB <- PBTypesTable

retypedBagPB$inputs_raw <- redefineTypeByName(retypedBagPB$inputs_raw,postfix="to",sets=list(PBL3$name,PBL4$name,PBR3$name,PBR4$name),nameModifiers=c("_L3","_L4","_R3","_R4"))
retypedBagPB$names <- redefineTypeByName(retypedBagPB$names,sets=list(PBL3$name,PBL4$name,PBR3$name,PBR4$name),nameModifiers=c("_L3","_L4","_R3","_R4"),postfix = "raw")
retypedBagPB$outputs_raw <- redefineTypeByName(retypedBagPB$outputs_raw,postfix="from",sets=list(PBL3$name,PBL4$name,PBR3$name,PBR4$name),nameModifiers=c("_L3","_L4","_R3","_R4"))

retypedBagPB$inputs <- getTypeToTypeTable(retypedBagPB$inputs_raw,typesTable=retypedBagPB$names,oldTable=retypedBagPB$inputs)
retypedBagPB$outputs <-  getTypeToTypeTable(retypedBagPB$outputs_raw,typesTable=retypedBagPB$outputsTableRef,oldTable=retypedBagPB$outputs) 
```

```{r}
PB3InputComp <- retypedBagPB$inputs %>% filter(grepl("_[L|R]3",type.to)) %>% 
  mutate(column=substring(str_extract(type.to,"_[L|R]3"),2)) %>%
  group_by(databaseType.from,databaseType.to,column) %>%
  summarize(weightRelative=sum(knownWeightRelative)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype.from",1:3)),c(paste0("supertype.to",1:3))),
              names_from= "column",
              values_from = "weightRelative",
              values_fill=list("weightRelative"=0))
```

```{r}
PB3OutputComp <- retypedBagPB$outputs %>% filter(grepl("_[L|R]3",type.from)) %>% 
  mutate(column=substring(str_extract(type.from,"_[L|R]3"),2)) %>%
  group_by(databaseType.from,databaseType.to,column) %>%
  summarize(outputContribution=mean(knownOutputContribution)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype.from",1:3)),c(paste0("supertype.to",1:3))),
              names_from= "column",
              values_from = "outputContribution",
              values_fill=list("outputContribution"=0))
```

```{r}
inputCor3 <- cor(PB3InputComp$R3,PB3InputComp$L3)
outputCor3 <- cor(PB3OutputComp$R3,PB3OutputComp$L3)
```

```{r}
allTypesPB <- unique(c(retypedBagPB$inputs_raw$supertype.from2,retypedBagPB$outputs_raw$supertype.to2))
myPalPB <- typesPalette(allTypesPB)
```

```{r}
inputPlot <- ggplot(PB3InputComp,aes(x=R3,y=L3)) + geom_point_interactive(aes(color=supertype.to2,
                                                                               tooltip=paste0(databaseType.from," to ", databaseType.to,".\n",
                                                                                              format(R3,digits=3,scientific=FALSE)," in R3, ",
                                                                                              format(L3,digits=3,scientific=FALSE)," in L3.")),alpha=0.5)  + 
  geom_abline(linetype=2) + theme_minimal()  + scale_color_manual(values=myPal,name="Type",breaks=allTypes)

outputPlot <- ggplot(PB3OutputComp,aes(x=R3,y=L3)) + geom_point_interactive(aes(color=supertype.to2,
                                                                               tooltip=paste0(databaseType.from," to ", databaseType.to,".\n",
                                                                                              format(R3,digits=3,scientific=FALSE)," in R3, ",
                                                                                              format(L3,digits=3,scientific=FALSE)," in L3.")),alpha=0.5)  + 
  geom_abline(linetype=2) + theme_minimal()  + scale_color_manual(values=myPal,name="Type",breaks=allTypes)
```

```{r}
outputPlot
```



### Comparing with the old version of the dataset
```{r}
newConnection <- neuprint_connection()
```

```{r}
oldConnection <- neuprint_connection(server="https://emdata1.int.janelia.org:11000/",token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InJvbWFpbi5mcmFuY29udmlsbGVAZ21haWwuY29tIiwibGV2ZWwiOiJyZWFkd3JpdGUiLCJpbWFnZS11cmwiOiJodHRwczovL2xoNi5nb29nbGV1c2VyY29udGVudC5jb20vLWdtUDkxREF4LTNvL0FBQUFBQUFBQUFJL0FBQUFBQUFBQUFBL0FBS1dKSk14RURObVNiekk5TjNULWw2RkRySWhHdG5LNncvcGhvdG8uanBnP3N6PTUwP3N6PTUwIiwiZXhwIjoxNzY2NDY0NjI2fQ.HsBHKOqeLUUcBcOY-GwzbCHrBMdCBesaICM4UUQSH_k",config=httr::config(ssl_verifypeer=0L))
```

```{r,warning=FALSE}
newRawTable <- neuprint_connection_table(FBC3Real$bodyid,"PRE",roi="FB-column3",conn=newConnection) %>% drop_na(ROIweight)
oldRawTable <- neuprint_connection_table(FBC3Real$bodyid,"PRE",roi="FB-column3",conn=oldConnection) %>% drop_na(ROIweight)
```

```{r,warning=FALSE}
newRefTable <- neuprint_get_meta(FBC3Real$bodyid,conn=newConnection)
oldRefTable <- neuprint_get_meta(FBC3Real$bodyid,conn=oldConnection) %>% mutate(type=newRefTable$type[match(bodyid,newRefTable$bodyid)]) 

newPartnerTable <- neuprint_get_meta(newRawTable$partner,conn=newConnection)
```

We want to remove bodyids that do not exist in one of the dataframes.
```{r,warning=FALSE}
newPartnersOldDataset <- neuprint_get_meta(newRawTable$partner,conn=oldConnection)
oldPartnersNewDataset <- neuprint_get_meta(oldRawTable$partner,conn=newConnection)

oldPartnerTable <- neuprint_get_meta(oldRawTable$partner,conn=oldConnection) %>% mutate(type=oldPartnersNewDataset$type[match(bodyid,oldPartnersNewDataset$bodyid)]) 

newRawTable <- filter(newRawTable,partner %in% newPartnersOldDataset$bodyid)
oldRawTable <- filter(oldRawTable,partner %in% oldPartnersNewDataset$bodyid)

newPartnerTable <- filter(newPartnerTable,bodyid %in% newPartnersOldDataset$bodyid)
oldPartnerTable <- filter(oldPartnerTable,bodyid %in% oldPartnersNewDataset$bodyid)
```



```{r,warning=FALSE}
newConnTable <- processConnectionTable(newRawTable,newRawTable,newRefTable,newPartnerTable,newRefTable,"PRE",slctROI="FB-column3",by.roi=FALSE,verbose=FALSE,chunk_meta=TRUE,conn=newConnection)
oldConnTable <- processConnectionTable(oldRawTable,oldRawTable,oldRefTable,oldPartnerTable,oldRefTable,"PRE",slctROI="FB-column3",by.roi=FALSE,verbose=FALSE,chunk_meta=TRUE,conn=oldConnection)
```

```{r,warning=FALSE}
newRawTableOut <- neuprint_connection_table(FBC3RealOut$bodyid,"POST",roi="FB-column3",conn=newConnection) %>% drop_na(ROIweight)
oldRawTableOut <- neuprint_connection_table(FBC3RealOut$bodyid,"POST",roi="FB-column3",conn=oldConnection) %>% drop_na(ROIweight)
```

```{r,warning=FALSE}
newRefTableOut <- neuprint_get_meta(FBC3RealOut$bodyid,conn=newConnection)
oldRefTableOut <- neuprint_get_meta(FBC3RealOut$bodyid,conn=oldConnection) %>% mutate(type=newRefTableOut$type[match(bodyid,newRefTableOut$bodyid)]) 

newPartnerTableOut <- neuprint_get_meta(newRawTableOut$partner,conn=newConnection)
```

We want to remove bodyids that do not exist in one of the dataframes.
```{r,warning=FALSE}
newPartnersOldDatasetOut <- neuprint_get_meta(newRawTableOut$partner,conn=oldConnection)
oldPartnersNewDatasetOut <- neuprint_get_meta(oldRawTableOut$partner,conn=newConnection)

oldPartnerTableOut <- neuprint_get_meta(oldRawTableOut$partner,conn=oldConnection) %>% mutate(type=oldPartnersNewDatasetOut$type[match(bodyid,oldPartnersNewDatasetOut$bodyid)]) 

newRawTableOut <- filter(newRawTableOut,partner %in% newPartnersOldDatasetOut$bodyid)
oldRawTableOut <- filter(oldRawTableOut,partner %in% oldPartnersNewDatasetOut$bodyid)

newPartnerTableOut <- filter(newPartnerTableOut,bodyid %in% newPartnersOldDatasetOut$bodyid)
oldPartnerTableOut <- filter(oldPartnerTableOut,bodyid %in% oldPartnersNewDatasetOut$bodyid)
```

```{r,warning=FALSE}
newConnTableOut <- processConnectionTable(newRawTableOut,newRawTableOut,newRefTableOut,newPartnerTableOut,newRefTableOut,"POST",slctROI="FB-column3",by.roi=FALSE,verbose=FALSE,chunk_meta=TRUE,conn=newConnection,chunk_connections = TRUE)
oldConnTableOut <- processConnectionTable(oldRawTableOut,oldRefTableOut,oldRefTableOut,oldPartnerTableOut,oldRefTableOut,"POST",slctROI="FB-column3",by.roi=FALSE,verbose=FALSE,chunk_meta=TRUE,conn=oldConnection,chunk_connections = TRUE)
```

```{r}
inputsAges <- full_join(newConnTable,oldConnTable,by = c("from","to","roi","type.from","type.to","supertype.from2","supertype.to2"),suffix=c(".new",".old")) %>% replace_na(list("ROIweight.new"=0,
                                                                                                                                                                               "ROIweight.old"=0,
                                                                                                                                                                               "weight.new"=0,
                                                                                                                                                                               "weight.old"=0,
                                                                                                                                                                               "weightRelative.new"=0,
                                                                                                                                                                               "weightRelative.old"=0,
                                                                                                                                                                               "outputContribution.new"=0,
                                                                                                                                                                               "outputContribution.old"=0))

outputsAges <- full_join(newConnTableOut,oldConnTableOut,by = c("from","to","roi","type.from","type.to","supertype.from2","supertype.to2"),suffix=c(".new",".old")) %>% replace_na(list("ROIweight.new"=0,
                                                                                                                                                                               "ROIweight.old"=0,
                                                                                                                                                                               "weight.new"=0,
                                                                                                                                                                               "weight.old"=0,
                                                                                                                                                                               "weightRelative.new"=0,
                                                                                                                                                                               "weightRelative.old"=0,
                                                                                                                                                                               "outputContribution.new"=0,
                                                                                                                                                                               "outputContribution.old"=0))

```

```{r}
oldNewInputs <- ggplot(inputsAges,aes(x=weightRelative.old,y=weightRelative.new)) + geom_point(alpha=0.5,aes(color=supertype.from2,size=ROIweight.new))  + geom_abline(linetype=2) + scale_color_manual(values=myPal,name="Partner type",breaks=allTypes) + theme_minimal() + facet_wrap(supertype.to2~.) + xlab("Relative weight in the old dataset") + ylab("Relative weight in the new dataset") + scale_size(name="# synapses in new dataset") + ggtitle("Receiving in FB column3")
oldNewOutputs <- ggplot(outputsAges,aes(x=outputContribution.old,y=outputContribution.new)) + geom_point(alpha=0.5,aes(color=supertype.to2,size=ROIweight.new)) + geom_abline(linetype=2) + scale_color_manual(values=myPal,name="Partner type",breaks=allTypes) + theme_minimal() + facet_wrap(supertype.from2~.)+ xlab("Output contribution in the old dataset") + ylab("Output contribution in the new dataset") + ggtitle("Sending in FB column3")
FBCompOldNew <- plot_grid(oldNewInputs+ theme(legend.position = "none"),oldNewOutputs+ theme(legend.position = "none"))
legOldNew <- get_legend(oldNewInputs + theme(legend.box.margin = margin(0, 0, 0, 12)))
FBCompOldNew <- plot_grid(FBCompOldNew,legOldNew, rel_widths = c(3, .4))
FBCompOldNew
```
```{r}
ggsave("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/C3CompPlotOldNew.svg",FBCompOldNew,height=7,width=13)
```

```{r}
ggplot(inputsAges,aes(x=ROIweight.new,y=abs(weightRelative.old-weightRelative.new))) + geom_point(alpha=0.2)
```


