---
title: "Notebook analyzing MBON to CX connections"
output:
  html_document:
    df_print: paged
---


### Command to clear environment is: rm(list = ls(all.names = TRUE))
### Command to update is remotes::update_packages('neuprintr')
### Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
library(matlib)
library(RColorBrewer)
library(ggraph)
library(robustbase)
require(alphahull)
library(zoo)
library(ggpubr)
library(ggraph)
library(igraph)
library(tidygraph)
library(xlsx)
library(dtplyr)
library(neuprintrExtra)
library("xlsx")
library(tidyselect)
library(reshape2)
library(scales)
library(cowplot)
options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose save/plot directories
```{r}

# Directory to save data to.
SaveDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/MB_Analysis/"

# Create save/plot directory if they dont exists yet
if (!dir.exists(SaveDir)){dir.create(SaveDir)}

```

### Connect to neuprint server.
```{r}
neuprint_login()
```

### Get general functions
```{r}

#source("../inputOutputRegionsVis.r")
#source("../R/connectivityMatricesTools.R")

```


# Get all MBONs from right MB
```{r}

# Get list of MBONS
MB_NamedBodies=getNeuronsInRoiTable("MB(R)",0)
MB_NamedBodies=subset(MB_NamedBodies, startsWith(name,"MBON"))


```


# Get everything up to 2 steps downstream of MBONs
```{r}


# Get meta data on sleep-wake types
MBONs_Types_Table=getTypesTable(unique(MB_NamedBodies$type))


# Get downstream connections
Method="no thresh"
Ttest_Thresh=1
if (Method=="no thresh"){
  
  # Get first layer outputs
  DownBag_L1=neuronBag(MBONs_Types_Table, by.roi=FALSE, omitInputs=TRUE, omitOutputs=FALSE)
  DownBag_L1=lateralize_types(DownBag_L1)
  DownTypes_L1=getTypesTable(unique(c(DownBag_L1$outputs_raw$databaseType.from,
                                      DownBag_L1$outputs_raw$databaseType.to))) %>% lateralize_types()
  Downstream_T2T_L1=getTypeToTypeTable(DownBag_L1$outputs_raw, majorOutputThreshold = 0.8, singleNeuronThreshold = 0,
                                     singleNeuronThresholdN = 3, pThresh = Ttest_Thresh, typesTable = DownTypes_L1, oldTable = NULL)
  
  # Get second layer outputs
  DownType_L1=getTypesTable(unique(Downstream_T2T_L1$databaseType.to))
  DownBag_L2=neuronBag(DownType_L1, by.roi=FALSE, omitInputs=TRUE, omitOutputs=FALSE)
  DownBag_L2=lateralize_types(DownBag_L2)
  DownTypes_L2=getTypesTable(unique(c(DownBag_L2$outputs_raw$databaseType.from,
                                      DownBag_L2$outputs_raw$databaseType.to))) %>% lateralize_types()
  Downstream_T2T_L2=getTypeToTypeTable(DownBag_L2$outputs_raw, majorOutputThreshold = 0.8, singleNeuronThreshold = 0,
                                     singleNeuronThresholdN = 3, pThresh = Ttest_Thresh, typesTable = DownTypes_L2, oldTable = NULL)  
  
  # Get pathways using normal methods
  Downstream_list=list(Downstream_T2T_L1, Downstream_T2T_L2)
  Downstream=tableChain2path(Downstream_list)
  Downstream_Graph=distinct(rbind(Downstream_list[[1]], Downstream_list[[2]]))
  
  #remove(Downstream_list)
} else if (Method=="type thresh"){
  
  Downstream_list <- get_type2typePath_raw(type.from=MBONs_Types_Table, type.to = NULL,
                                          n_steps=1:2, by.roi=FALSE, renaming=lateralize_types )
  Downstream=tableChain2path(Downstream_list)
  Downstream_Graph=distinct(rbind(Downstream_Raw[[1]], Downstream_Raw[[2]]))

}


```



# ####################################################################################################################
# ######### Figure 0: Replicate MB Paper's MBON-->CX results #########################################################
# ####################################################################################################################


# A list of direct CX targets from the MB paper
```{r}

CXTypes <- supertype(read_csv("C:\\Users\\labadmin\\Dropbox\\FIBSEM CX Paper Jan 2020\\CX-cell-types060920"))$n.type

MB_Paper_Direct_Types=c("FB1C", "FB1H", "FB2A","FB2C","FB2L","FB4A","FB4C","FB4D","FB4F_b",
                        "FB4G","FB4H","FB4I","FB4J","FB4L","FB4M","FB4N","FB4O",
                        "FB4P_a","FB4P_b","FB4R","FB4X","FB4Y","FB5A","FB5AB","FB5C","FB5D",
                        "FB5E","FB5H","FB5I","FB5J","FB5K","FB5L","FB5M","FB5V","FB5X",
                        "FB6A","FB6P","FB6Q","FB6R","FB6T","FB6V","FB8F_a",
                        "LCNOp","LCNOpm","LNO2")

```


# Target list from the MB paper, using their criteria, to make sure we can mostly replicate their analysis.
# We get the exact same list as Li et al, with the exceptions of ER1_a(ring)_R which receives 10 synapses from MBON26(B'2d)_R.
# Perhaps their threshold was >10 instead of >=10 (as they report)?
```{r}

# MB paper's criteria
Li_DownBag=neuronBag(MBONs_Types_Table, by.roi=FALSE, omitInputs=TRUE, omitOutputs=FALSE)
Li_Direct=Li_DownBag$outputs_raw
Li_Direct=subset(Li_Direct, databaseType.to %in% CXTypes)
Li_Direct=subset(Li_Direct, weight>=10)

sort(unique(Li_Direct$type.to)) %in% MB_Paper_Direct_Types

sort(unique(Li_Direct$type.to))
MB_Paper_Direct_Types

```



# ####################################################################################################################
# ######### Figure 1: MBON to CX direct connections ##################################################################
# ####################################################################################################################


```{r}


# Get direct MBON to CX connections
MB2CX_Direct=subset(Downstream_T2T_L1, weightRelative > 0.01 & databaseType.to %in% CXTypes)
sort(unique(MB2CX_Direct$databaseType.to))





A=connectivityCluster(inputsTable = NULL, outputsTable = MB2CX_Direct)
B=setClusters(A, h = 0.8, k = NULL)







AA=addClusters(A, partnerClusters, h = 0.8, k = NULL)



AA=A$inputsTable


setClusters(connCl, h = 0.8, k = NULL)














```























# Decide on pathway threshold for input and output pathways (0.005 is good)
```{r}

PathwayThresh=0.005

```



# Function for custom retyping of input and output types
```{r}


OutputTyping <- function(DF_ToType){
  
  # Group output types
  DF_ToType$SuperType_Custom=NA
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.to,"5-HT") |
                                                startsWith(DF_ToType$type.to,"SI") |
                                                startsWith(DF_ToType$type.to,"SL") |
                                                startsWith(DF_ToType$type.to,"SM") |
                                                startsWith(DF_ToType$type.to,"DGI") |
                                                startsWith(DF_ToType$type.to,"IB042") ]="SNP"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.to,"EL") |
                                                startsWith(DF_ToType$type.to,"ER") |
                                                startsWith(DF_ToType$type.to,"Ex") |
                                                startsWith(DF_ToType$type.to,"TuB")|
                                                startsWith(DF_ToType$type.to,"AOT")]="EB and BU"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.to,"PF") |
                                                startsWith(DF_ToType$type.to,"hDelta") |
                                                startsWith(DF_ToType$type.to,"vDelta") |
                                                startsWith(DF_ToType$type.to,"FS") |
                                                startsWith(DF_ToType$type.to,"FR") |
                                                startsWith(DF_ToType$type.to,"FC")]="FB Columnar"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.to,"FB") | startsWith(DF_ToType$type.to,"OA")]="FB Tangential"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.to,"LAL")]="LAL"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.to,"CRE")]="CRE"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.to,"ATL") | startsWith(DF_ToType$type.to,"LH") |
                                                startsWith(DF_ToType$type.to,"PAM") | startsWith(DF_ToType$type.to,"PPL204")]="Olfactory"
  DF_ToType$SuperType_Custom[is.na(DF_ToType$SuperType_Custom)]="Unknown Type"
  
  DF_ToType$SuperType_Custom=factor(DF_ToType$SuperType_Custom, 
            levels=rev(c("FB Tangential","FB Columnar","EB and BU","SNP","LAL","CRE","Olfactory","Unknown Type")))

  
  return(DF_ToType)
  
}


```




# Get which FB layer each Sleep-wake neuron projects most strongly to, for keeping plot with FBt axes across steps
```{r}

SW_Downstream_Layer=subset(SW_Downstream, weightRelative_path>PathwayThresh)
SW_Downstream_Layer_Sum=SW_Downstream_Layer %>% group_by(type.from, type.to, supertype3.to) %>%
  summarize(weightRelative_path=sum(weightRelative_path))
SW_Downstream_Layer_Sum=subset(SW_Downstream_Layer_Sum, (startsWith(type.to,"FB") |  startsWith(type.to,"OA-")) & 
                                 !supertype3.to=="Unassigned")
MaxInputDownstream= SW_Downstream_Layer_Sum %>% group_by(type.to) %>% slice(which.max(weightRelative_path))
MaxInputDownstream$Layer=substr(MaxInputDownstream$type.from, 3, 3) 
MaxInputDownstream=MaxInputDownstream[c("type.to","Layer")]
remove(SW_Downstream_Layer, SW_Downstream_Layer_Sum)

```



# Plot the downstream neurons
```{r}



# Chose number of steps to consider
Step=2


# Get pathways, grouped by type.from and type.to
SW_Downstream_Filt=subset(SW_Downstream, weightRelative_path>PathwayThresh) # threshold out weak paths (0.001)
SW_Downstream_Filt$weightRelative_path[SW_Downstream_Filt$n_steps>Step]=NA # Set pathways greater than Step length to NA
SW_Downstream_Filt_Sum=SW_Downstream_Filt %>% group_by(type.from, type.to, supertype3.to) %>% 
  summarize(weightRelative_path=sum(weightRelative_path, na.rm=TRUE)) # Nan-Sum over all pathways
SW_Downstream_Filt_Sum$weightRelative_path[SW_Downstream_Filt_Sum$weightRelative_path==0]=NA # set nan pathways that turned to 0 to nan again



# Make unformatted plots to see all the types downstream of the sleep-wake types 
P1=ggplot(SW_Downstream_Filt_Sum) +  
  geom_tile(aes(type.to,type.from,fill=weightRelative_path)) +
  scale_fill_paletteer_c("ggthemes::Blue", limits=c(0,0.1), breaks = c(0,0.05,0.1), oob=squish, na.value="gray50") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + coord_fixed() 
  ggsave(paste(OutDir, "SW_OutputAll","_Step",as.character(Step),".png",sep=""),
         plot = P1, device='png', scale = 1, width =12, height = 6, units ="in", dpi = 500, limitsize = TRUE)

P2=ggplot(subset(SW_Downstream_Filt_Sum, !(startsWith(type.to,"FB") |  startsWith(type.to,"OA-")) & !supertype3.to=="Unassigned")) +
  geom_tile(aes(type.to,type.from,fill=weightRelative_path)) +
  scale_fill_paletteer_c("ggthemes::Blue", limits=c(0,0.1), breaks = c(0,0.05,0.1), oob=squish, na.value="gray50") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + coord_fixed()
  ggsave(paste(OutDir, "SW_Output_noFBt","_Step",as.character(Step),".png",sep=""),
         plot = P2, device='png', scale = 1, width =12, height = 6, units ="in", dpi = 500, limitsize = TRUE)

P3=ggplot(subset(SW_Downstream_Filt_Sum, (startsWith(type.to,"FB") | startsWith(type.to,"OA-")) & !supertype3.to=="Unassigned")) +
  geom_tile(aes(type.to,type.from,fill=weightRelative_path)) +
  scale_fill_paletteer_c("ggthemes::Blue", limits=c(0,0.1), breaks = c(0,0.05,0.1), oob=squish, na.value="gray50") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) + coord_fixed()
  ggsave(paste(OutDir, "SW_Output_FBt","_Step",as.character(Step),".png",sep=""),
         plot = P3, device='png', scale = 1, width =12, height = 6, units ="in", dpi = 500, limitsize = TRUE)

  
# Group downstream neurons into custom supertypes, and see which custom types are included in the unknown category to make sure none were missed
SW_Downstream_Filt_Sum=OutputTyping(SW_Downstream_Filt_Sum)
print(unique(SW_Downstream_Filt_Sum$type.to[SW_Downstream_Filt_Sum$SuperType_Custom == "Unknown Type"]))
  

# Group downstream types by supertype and compute average pathway weight and the number of target types
SW_Downstream_Filt_Sum_Bar=subset(SW_Downstream_Filt_Sum, !is.na(weightRelative_path)) %>% 
  group_by(type.from, SuperType_Custom) %>% 
  summarize(weightRelative_path=mean(weightRelative_path), n=n())


####################################################################################################
##### Bar plots of downstream supertpe average pathway weight and the number of target types #######
####################################################################################################


# Set palette
library(prismatic)
BarPalette=rev(color(c("mediumpurple4","mediumpurple1","forestgreen","darkorange1","bisque3","gray50","thistle4","black")))


# Make bar plot of downstream targets, plotting both mean pathway weight and the number of types targeted
P4=ggplot(SW_Downstream_Filt_Sum_Bar, aes(type.from)) +   geom_bar( aes(weight=weightRelative_path, fill = SuperType_Custom)) +
  scale_fill_manual(values=BarPalette, drop=FALSE) +  theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  ylab("Mean pathway relative weight ") + ylim(0,0.2)
  ggsave(paste(OutDir, "FIGURE_SW_Output_PathwayWeight_Bar","_Step",as.character(Step),".pdf",sep=""),
         plot = P4, device='pdf', scale = 1, width =8, height =4, units ="in", dpi = 500, limitsize = TRUE)

P5=ggplot(SW_Downstream_Filt_Sum_Bar, aes(type.from)) +   geom_bar( aes(weight=n,fill = SuperType_Custom)) +
  scale_fill_manual(values=BarPalette, drop=FALSE) +  theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  ylab("# downstream types") + ylim(0,100)
  ggsave(paste(OutDir, "FIGURE_SW_Output_NumberOfTypes_Bar","_Step",as.character(Step),".pdf",sep=""),
         plot = P5, device='pdf', scale = 1, width =8, height = 4, units ="in", dpi = 500, limitsize = TRUE)


  
####################################################################################################
##### Matrix plots of downstream targets types #####################################################
#################################################################################################### 
  
  
# remake matrix plots but with faceting by region 
PlotData=subset(SW_Downstream_Filt_Sum, !(startsWith(type.to,"FB") |startsWith(type.to,"OA-")) & !supertype3.to=="Unassigned")
PlotData$SuperType_Custom=factor(PlotData$SuperType_Custom, levels=rev(levels(PlotData$SuperType_Custom)))
P6=ggplot(PlotData) +
  geom_tile(aes(type.to,type.from,fill=weightRelative_path)) +
  scale_fill_paletteer_c("ggthemes::Blue", limits=c(0,0.1), breaks = c(0,0.05,0.1), oob=squish, na.value="gray50") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
  facet_grid(cols=vars(SuperType_Custom),space = "free",  scales = "free" ) + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        aspect.ratio = 1) 
ggsave(paste(OutDir, "FIGURE_SW_Output_noFBt_FIGURE","_Step",as.character(Step),".pdf",sep=""),
        plot = P6, device='pdf', scale = 1, width =12, height = 6, units ="in", dpi = 500, limitsize = TRUE)
  

# remake matrix plots but with faceting by region 
PlotData=subset(SW_Downstream_Filt_Sum, (startsWith(type.to,"FB") | startsWith(type.to,"OA-")) & !supertype3.to=="Unassigned")
PlotData=merge(PlotData, MaxInputDownstream, by="type.to")
PlotData$Layer=factor(PlotData$Layer, levels=c("6","7"))

P7=ggplot(PlotData) +
  geom_tile(aes(type.to,type.from,fill=weightRelative_path)) +
  scale_fill_paletteer_c("ggthemes::Blue", limits=c(0,0.1), breaks = c(0,0.05,0.1), oob=squish, na.value="gray50") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
   facet_grid(cols=vars(Layer),space = "free",  scales = "free" ) + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        aspect.ratio = 1) 
ggsave(paste(OutDir, "FIGURE_SW_Output_FBt_FIGURE","_Step",as.character(Step),".pdf",sep=""),
        plot = P7, device='pdf', scale = 1, width =12, height = 6, units ="in", dpi = 500, limitsize = TRUE)
  

```



# Function for custom typing of inputs
```{r}

InputTyping <- function(DF_ToType){
  
  # Group output types
  DF_ToType$SuperType_Custom=NA
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.from,"5-HT") |
                                                startsWith(DF_ToType$type.from,"SI") |
                                                startsWith(DF_ToType$type.from,"SL") |
                                                startsWith(DF_ToType$type.from,"SM") |
                                                startsWith(DF_ToType$type.from,"DGI") |
                                                startsWith(DF_ToType$type.from,"IB042") ]="SNP"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.from,"EL") |
                                                startsWith(DF_ToType$type.from,"ER") |
                                                startsWith(DF_ToType$type.from,"Ex") |
                                                startsWith(DF_ToType$type.from,"TuB")|
                                                startsWith(DF_ToType$type.from,"AOT")|
                                                startsWith(DF_ToType$type.from,"PEN")|
                                                startsWith(DF_ToType$type.from,"EPG")|
                                                startsWith(DF_ToType$type.from,"Delta7")]="EB + PB + BU"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.from,"PF") |
                                                startsWith(DF_ToType$type.from,"hDelta") |
                                                startsWith(DF_ToType$type.from,"vDelta") |
                                                startsWith(DF_ToType$type.from,"FS") |
                                                startsWith(DF_ToType$type.from,"FR") |
                                                startsWith(DF_ToType$type.from,"FC") |
                                                startsWith(DF_ToType$type.from,"PFN")]="FB Columnar"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.from,"FB") | startsWith(DF_ToType$type.from,"OA-VPM3")]="FB Tangential"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.from,"CRE")]="CRE"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.from,"LCN")]="LAL"
  DF_ToType$SuperType_Custom[startsWith(DF_ToType$type.from,"ATL") | startsWith(DF_ToType$type.from,"LH") |
                               startsWith(DF_ToType$type.from,"PAM") | startsWith(DF_ToType$type.from,"PPL204")]="Olfactory"
  DF_ToType$SuperType_Custom[is.na(DF_ToType$SuperType_Custom)]="Unknown Type"
  
  DF_ToType$SuperType_Custom=factor(DF_ToType$SuperType_Custom, 
            levels=rev(c("FB Tangential","FB Columnar","EB + PB + BU","SNP","LAL","CRE", "Olfactory","Unknown Type")))

  
  return(DF_ToType)
  
}

```


# Get which layer each upstream neuron projects most strongly to, for keeping plot axes the same across steps
```{r}

SW_Upstream_Layer=subset(SW_Upstream, weightRelative_path>PathwayThresh)
SW_Upstream_Layer_Sum=SW_Upstream_Layer %>% group_by(type.from, type.to, supertype3.from) %>%
  summarize(weightRelative_path=sum(weightRelative_path))
SW_Upstream_Layer_Sum=subset(SW_Upstream_Layer_Sum, (startsWith(type.from,"FB") | startsWith(type.from,"OA")) & !supertype3.from=="Unassigned")
MaxInput= SW_Upstream_Layer_Sum %>% group_by(type.from) %>% slice(which.max(weightRelative_path))
MaxInput$Layer=substr(MaxInput$type.to, 3, 3) 
MaxInput=MaxInput[c("type.from","Layer")]
remove(SW_Upstream_Layer,SW_Upstream_Layer_Sum)

```



# Plot the upstream neurons neurons
```{r}

# Analysis to show that SW neurons receive almost all their input from known types
SW_KnownUpstream=subset(SW_Upstream,  weightRelative_path>PathwayThresh)
AllUpstream=unique(SW_KnownUpstream$type.from) # list of all upstream types
print(AllUpstream)
sum(AllUpstream %in% unique(SW_KnownUpstream$type.from[SW_KnownUpstream$supertype3.from=="Unassigned"]))/length(AllUpstream) # only 5% of upstream unknown


# Chose number of steps to consider
Step=2


# Get pathways, grouped by type.from and type.to
SW_Upstream_Filt=subset(SW_Upstream, weightRelative_path>PathwayThresh) # threshold out weak paths
SW_Upstream_Filt$weightRelative_path[SW_Upstream_Filt$n_steps>Step]=NA # Set pathways greater than Step length to NA
SW_Upstream_Filt_Sum=SW_Upstream_Filt %>% group_by(type.from, type.to, supertype3.from) %>%
  summarize(weightRelative_path=sum(weightRelative_path, na.rm=TRUE)) # Nan-Sum over all pathways
SW_Upstream_Filt_Sum$weightRelative_path[SW_Upstream_Filt_Sum$weightRelative_path==0]=NA # set nan pathways that turned to 0 to nan again


# Make unformatted plots to see all the types Upstream of the sleep-wake types 
PlotData=subset(SW_Upstream_Filt_Sum, !supertype3.from=="Unassigned" & (startsWith(as.character(type.from),"FB") | startsWith(type.from,"OA")) )
P1=ggplot(PlotData) +  geom_tile(aes(type.to,type.from,fill=weightRelative_path)) +
  scale_fill_paletteer_c("ggthemes::Blue", limits=c(0,0.1), breaks = c(0,0.05,0.1), oob=squish, na.value="gray50") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + coord_fixed() 
  ggsave(paste(InDir, "SW_Inputs_FBt","_Step",as.character(Step),".png",sep=""),
         plot = P1, device='png', scale = 1, width =10, height = 10, units ="in", dpi = 500, limitsize = TRUE)

  
PlotData=subset(SW_Upstream_Filt_Sum, !supertype3.from=="Unassigned" & !(startsWith(as.character(type.from),"FB") | startsWith(type.from,"OA")) ) 
P2=ggplot(PlotData) +  geom_tile(aes(type.to,type.from,fill=weightRelative_path)) +
  scale_fill_paletteer_c("ggthemes::Blue", limits=c(0,0.1), breaks = c(0,0.05,0.1), oob=squish, na.value="gray50") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + coord_fixed() 
  ggsave(paste(InDir, "SW_Inputs_NotFBt","_Step",as.character(Step),".png",sep=""),
         plot = P2, device='png', scale = 1, width =10, height = 10, units ="in", dpi = 500, limitsize = TRUE)  
  
  
# Group Upstream neurons into custom supertypes 
SW_Upstream_Filt_Sum=InputTyping(SW_Upstream_Filt_Sum)
print(unique(SW_Upstream_Filt_Sum$type.from[SW_Upstream_Filt_Sum$SuperType_Custom == "Unknown Type"]))
  

# Group Upstream types by supertype and compute average pathway weight and the number of target types
SW_Upstream_Filt_Sum_Bar=subset(SW_Upstream_Filt_Sum, !is.na(weightRelative_path)) %>% 
  group_by(type.to, SuperType_Custom) %>% 
  summarize(weightRelative_path=mean(weightRelative_path), n=n())


####################################################################################################
##### Bar plots of Upstream supertpe average pathway weight and the number of target types #######
####################################################################################################


sort(unique(SW_Upstream_Filt_Sum_Bar$SuperType_Custom))

# Set palette
library(prismatic)
BarPalette=rev(color(c("mediumpurple4","mediumpurple1","forestgreen","darkorange1","bisque3","gray50","thistle4","black")))


# Make bar plot of Upstream targets, plotting both mean pathway weight and the number of types targeted
P4=ggplot(SW_Upstream_Filt_Sum_Bar, aes(type.to)) +   geom_bar( aes(weight=weightRelative_path,fill = SuperType_Custom)) +
  scale_fill_manual(values=BarPalette, drop=FALSE) +  theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  ylab("Mean pathway relative weight ") + ylim(0,0.2)
  ggsave(paste(InDir, "FIGURE_SW_Input_PathwayWeight_Bar","_Step",as.character(Step),".pdf",sep=""),
         plot = P4, device='pdf', scale = 1, width =8, height =4, units ="in", dpi = 500, limitsize = TRUE)

P5=ggplot(SW_Upstream_Filt_Sum_Bar, aes(type.to)) +   geom_bar( aes(weight=n,fill = SuperType_Custom)) +
  scale_fill_manual(values=BarPalette, drop=FALSE) +  theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  ylab("# Upstream types") + ylim(0,50)
  ggsave(paste(InDir, "FIGURE_SW_Input_NumberOfTypes_Bar","_Step",as.character(Step),".pdf",sep=""),
         plot = P5, device='pdf', scale = 1, width =8, height = 4, units ="in", dpi = 500, limitsize = TRUE)


  
####################################################################################################
##### Matrix plots of Upstream targets types #####################################################
#################################################################################################### 
  
  
# remake matrix plots but with faceting by region 
PlotData=subset(SW_Upstream_Filt_Sum, !startsWith(type.from,"FB") & !startsWith(type.from,"OA") & !supertype3.from=="Unassigned")
PlotData$SuperType_Custom=factor(PlotData$SuperType_Custom, levels=rev(levels(PlotData$SuperType_Custom)))
P6=ggplot(PlotData) +
  geom_tile(aes(type.to,type.from,fill=weightRelative_path)) +
  scale_fill_paletteer_c("ggthemes::Blue", limits=c(0,0.1), breaks = c(0,0.05,0.1), oob=squish, na.value="gray50") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
  facet_grid(rows=vars(SuperType_Custom),space = "free",  scales = "free" ) + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        aspect.ratio = 1) 
ggsave(paste(InDir, "FIGURE_SW_Input_noFBt_FIGURE","_Step",as.character(Step),".pdf",sep=""),
        plot = P6, device='pdf', scale = 1, width =6, height = 12, units ="in", dpi = 500, limitsize = TRUE)
  


# remake matrix plots but with faceting by region 
PlotData=subset(SW_Upstream_Filt_Sum, (startsWith(type.from,"FB") | startsWith(type.from,"OA")) & !supertype3.from=="Unassigned")
PlotData=merge(PlotData, MaxInput, by="type.from")
PlotData$Layer=factor(PlotData$Layer, levels=c("6","7"))

P7=ggplot(PlotData) +
  geom_tile(aes(type.to,type.from,fill=weightRelative_path)) +
  scale_fill_paletteer_c("ggthemes::Blue", limits=c(0,0.1), breaks = c(0,0.05,0.1), oob=squish, na.value="gray50") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
  facet_grid(rows=vars(Layer),space = "free",  scales = "free" ) + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        aspect.ratio = 1) 
ggsave(paste(InDir, "FIGURE_SW_Input_FBt_FIGURE","_Step",as.character(Step),".pdf",sep=""),
        plot = P7, device='pdf', scale = 1, width =6, height = 12, units ="in", dpi = 500, limitsize = TRUE)
  

```



# ####################################################################################################################
# ######### Make graph of core sleep circuit #########################################################################
# ####################################################################################################################



# Make graph of core sleep network
```{r}


# Define core sleep pathway types connecting EB to FB
SleepWakeTypes_EbFb=c("FB6A","PFGs","hDeltaK","hDeltaF","ExR3","ExR1","ER5",
                      "PEN_b(PEN2)","ER3d_a","ER3d_b","ER3d_c","ER3d_d","FB8B",
                      "hDeltaD","FB7A","FB7B","FB7K", "FB6H", "OA-VPM3")
SleepWakeTypes_EbFb_Table=getTypesTable(SleepWakeTypes_EbFb)


# Get connection table just between these types
SW_EbFb_Bag=neuronBag(SleepWakeTypes_EbFb_Table, by.roi=TRUE)
SW_EbFb_N2N=SW_EbFb_Bag$inputs_raw
SW_EbFb_N2N_Sub=subset(SW_EbFb_N2N, type.to %in% SleepWakeTypes_EbFb & type.from %in% SleepWakeTypes_EbFb)
SW_EbFb_N2N_Sub=subset(SW_EbFb_N2N_Sub, weightRelative > 0.01)


# Compute neuron-to-neuron connectivity
SW_EbFb_T2T=getTypeToTypeTable(SW_EbFb_Bag$inputs_raw, majorOutputThreshold = 0.8, singleNeuronThreshold = 0.01, singleNeuronThresholdN = 3,
                                      pThresh = 1, typesTable = NULL, oldTable = NULL)
SW_EbFb_T2T_Sub=subset(SW_EbFb_T2T, type.to %in% SleepWakeTypes_EbFb & type.from %in% SleepWakeTypes_EbFb)
SW_EbFb_T2T_Sub=subset(SW_EbFb_T2T_Sub, weightRelative>0.01)


# Plot EB connectivity matrix
P1=ggplot(subset(SW_EbFb_T2T_Sub, roi=="EB")) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) +
   scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", 
                        midpoint=0.2,limits=c(0,0.4),oob=squish,breaks = c(0,0.2,0.4)) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        aspect.ratio = 1) 


# Plot EB connectivity matrix
P2=ggplot(subset(SW_EbFb_T2T_Sub, roi=="FB")) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) +
   scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", 
                        midpoint=0.2,limits=c(0,0.4),oob=squish,breaks = c(0,0.2,0.4)) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        aspect.ratio = 1) 

P3=ggarrange(P1,P2,ncol=1,nrow=2)

ggsave(paste(PlotDir, "EbFb_Matrix.png",sep=""),
        plot = P3, device='png', scale = 1, width =6, height = 10, units ="in", dpi = 500, limitsize = TRUE)
 



```





# Make graphs for the EB
```{r}

# Get input data
GraphTable=subset(SW_EbFb_T2T_Sub, roi=="EB" & weightRelative >0.01)

# remove self connections
GraphTable=subset(GraphTable, !(type.from == type.to) )


# Set node IDs
IDs_Type=sort(unique(c(unique(GraphTable$type.from),unique(GraphTable$type.to))))
EB_NODES=data.frame(name=IDs_Type)


# Set node positions
EB_NODES$name=EB_NODES$name
EB_NODES$x=NA
EB_NODES$y=NA
EB_NODES[EB_NODES$name == "ExR1",c(2,3)]=c(-140,0)
EB_NODES[EB_NODES$name == "ExR3",c(2,3)]=c(-90,0)
EB_NODES[EB_NODES$name == "hDeltaK",c(2,3)]=c(-40,0)
EB_NODES[EB_NODES$name == "ER3d_a",c(2,3)]=c(-150,-10)
EB_NODES[EB_NODES$name == "ER3d_b",c(2,3)]=c(-130,-15)
EB_NODES[EB_NODES$name == "ER3d_c",c(2,3)]=c(-95,-15)
EB_NODES[EB_NODES$name == "ER3d_d",c(2,3)]=c(-75,-10)
EB_NODES[EB_NODES$name == "ER5",c(2,3)]=c(-175,-5)
EB_NODES[EB_NODES$name == "PEN_b(PEN2)",c(2,3)]=c(-40,-10)
EB_NODES$y=EB_NODES$y*5+50


# EB_NODES
EB_NODES$COLORZ="gray50"
EB_NODES$COLORZ[EB_NODES$name == "ExR1" | EB_NODES$name == "ExR3" | EB_NODES$name == "hDeltaK"]="cyan3"
EB_NODES$COLORZ[startsWith(as.character(EB_NODES$name),"ER3")]="seagreen3"
EB_NODES$COLORZ[startsWith(as.character(EB_NODES$name),"ER5")]="plum3"
EB_NODES$COLORZ[startsWith(as.character(EB_NODES$name),"PEN")]="lightseagreen"

# edges
EB_EDGES=GraphTable[c("type.from","type.to","weightRelative")]


# edges
colnames(EB_EDGES)=c("from","to","weight")
EB_EDGES$from=as.character(EB_EDGES$from)
EB_EDGES$to=as.character(EB_EDGES$to)
EB_EDGES$COLORZ=NA
EB_EDGES$COLORZ[EB_EDGES$from == "ExR1" | EB_EDGES$from == "ExR3" | EB_EDGES$from == "hDeltaK"]="cyan3"
EB_EDGES$COLORZ[startsWith(as.character(EB_EDGES$from),"ER3")]="seagreen3"
EB_EDGES$COLORZ[startsWith(as.character(EB_EDGES$from),"ER5")]="plum3"
EB_EDGES$COLORZ[startsWith(as.character(EB_EDGES$from),"PEN")]="lightseagreen"
EB_EDGES$COLORZ=factor(EB_EDGES$COLORZ, levels=unique(EB_EDGES$COLORZ))

# Make ggraph object
graph = tbl_graph(EB_NODES, EB_EDGES)


# colors
col_vector=levels(EB_EDGES$COLORZ)


# Make plot and save
P4=ggraph(graph,layout="manual",x=EB_NODES$x,y=EB_NODES$y) + 
  geom_edge_fan( aes(width=weight, color=COLORZ), 
                 arrow = arrow(length = unit(2, 'mm'),ends = "last", type = "closed"), end_cap = circle(0.75, 'cm'), alpha=1,strength=1) +
  geom_node_point(color=EB_NODES$COLORZ, size=15) +
  geom_node_text(aes(label=name),angle=0,size=2, nudge_y = c(rep(0.06,18),rep(-0.06,9)), color='black' ) +
  theme_classic() + 
  theme(legend.text=element_text(size=6),legend.title=element_text(size=6),
        axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_edge_width(range = c(0.5,2)) + scale_edge_color_manual(values=col_vector) +
   xlim(-220,20) + ylim(-50,100)

ggsave(paste(PlotDir, "EB_Graph_V1.pdf",sep=""),
        plot = P4, device='pdf', scale = 1, width =10, height = 6, units ="in", dpi = 500, limitsize = TRUE)
 


# Plot neuron-to-neuron connection matrix
EB_N2N=subset(SW_EbFb_N2N, roi=="EB" & type.to %in% c("ExR1","ExR3","hDeltaK"))


P3=ggplot(EB_N2N) +
  geom_tile(aes(name.to, name.from, fill=weightRelative)) +
    scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", 
                        midpoint=0.05,limits=c(0,0.1),oob=squish,breaks = c(0,0.05,0.1)) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        aspect.ratio = 1) +
  facet_grid(rows=vars(type.from), cols=vars(type.to), space="free", scales="free")

ggsave(paste(PlotDir, "Eb_N2N_Matrix.png",sep=""),
        plot = P3, device='png', scale = 1, width =8, height = 10, units ="in", dpi = 500, limitsize = TRUE)
 



```



# Make graphs for the FB
```{r}

# Get input data
GraphTable=subset(SW_EbFb_T2T_Sub, roi=="FB" & weightRelative >0.01)


# remove self connections
GraphTable=subset(GraphTable, !(type.from == type.to) )


# Set node IDs
IDs_Type=sort(unique(c(unique(GraphTable$type.from),unique(GraphTable$type.to))))
FB_NODES=data.frame(name=IDs_Type)


# Set node positions
FB_NODES$name=FB_NODES$name
FB_NODES$x=NA
FB_NODES$y=NA
FB_NODES[FB_NODES$name == "ExR1",c(2,3)]=c(-140,0)
FB_NODES[FB_NODES$name == "ExR3",c(2,3)]=c(-90,0)
FB_NODES[FB_NODES$name == "hDeltaK",c(2,3)]=c(-40,0)
FB_NODES[FB_NODES$name == "PFGs",c(2,3)]=c(-90-20,10)
FB_NODES[FB_NODES$name == "FB6A",c(2,3)]=c(-20,10)
FB_NODES[FB_NODES$name == "hDeltaF",c(2,3)]=c(-110,15.25)
FB_NODES[FB_NODES$name == "FB7K",c(2,3)]=c(-150-38-10,12)
FB_NODES[FB_NODES$name == "FB7B",c(2,3)]=c(-137.5-35-5,17)
FB_NODES[FB_NODES$name == "FB7A",c(2,3)]=c(-125-35,14)
FB_NODES[FB_NODES$name == "FB8B",c(2,3)]=c(-175,5)
FB_NODES[FB_NODES$name == "hDeltaD",c(2,3)]=c(-200,5)
FB_NODES[FB_NODES$name == "FB6H",c(2,3)]=c(-15,17.5)
FB_NODES[FB_NODES$name == "OA-VPM3",c(2,3)]=c(-35,14)

FB_NODES$y=FB_NODES$y*5


# Get sleep wake colors
pcCols <- paletteer_d("Polychrome::palette36")
col_vector=c(pcCols[15],pcCols[13])


# FB_NODES
FB_NODES$COLORZ=NA
FB_NODES$COLORZ[startsWith(as.character(FB_NODES$name),"hDelta")]="salmon1"
FB_NODES$COLORZ[FB_NODES$name == "ExR1" | FB_NODES$name == "ExR3" | FB_NODES$name == "hDeltaK"]="cyan3"
FB_NODES$COLORZ[startsWith(as.character(FB_NODES$name),"FB")]="seagreen3"
FB_NODES$COLORZ[startsWith(as.character(FB_NODES$name),"PFG")]="slateblue1"
FB_NODES$COLORZ[FB_NODES$name == "FB6A" | FB_NODES$name=="FB7A" | FB_NODES$name=="FB7K"]=col_vector[1]
FB_NODES$COLORZ[FB_NODES$name == "FB7B" | FB_NODES$name == "FB6H"]=col_vector[2]
FB_NODES$COLORZ[FB_NODES$name == "OA-VPM3"]="red"

# edges
FB_EDGES=GraphTable[c("type.from","type.to","weightRelative")]


# FB_EDGES
colnames(FB_EDGES)=c("from","to","weight")
FB_EDGES$from=as.character(FB_EDGES$from)
FB_EDGES$to=as.character(FB_EDGES$to)
FB_EDGES$COLORZ=NA
FB_EDGES$COLORZ[startsWith(as.character(FB_EDGES$from),"hDelta")]="salmon1"
FB_EDGES$COLORZ[FB_EDGES$from == "ExR1" | FB_EDGES$from == "ExR3" | FB_EDGES$from == "hDeltaK"]="cyan3"
FB_EDGES$COLORZ[startsWith(as.character(FB_EDGES$from),"FB")]="seagreen3"
FB_EDGES$COLORZ[startsWith(as.character(FB_EDGES$from),"PFG")]="slateblue1"
FB_EDGES$COLORZ[FB_EDGES$from == "FB6A" | FB_EDGES$from=="FB7A" | FB_EDGES$from=="FB7K"]=col_vector[1]
FB_EDGES$COLORZ[FB_EDGES$from == "FB7B" | FB_EDGES$from == "FB6H"]=col_vector[2]
FB_EDGES$COLORZ[FB_EDGES$from == "OA-VPM3"]="red"

# make factor
FB_EDGES$COLORZ=factor(FB_EDGES$COLORZ, levels=unique(FB_EDGES$COLORZ))

# Make ggraph object
graph = tbl_graph(FB_NODES, FB_EDGES)


# colors
col_vector=levels(FB_EDGES$COLORZ)


# Make plot and save
P4=ggraph(graph,layout="manual",x=FB_NODES$x,y=FB_NODES$y) + 
  geom_edge_fan( aes(width=weight, color=COLORZ), 
                 arrow = arrow(length = unit(2, 'mm'),ends = "last", type = "closed"), end_cap = circle(0.75, 'cm'), alpha=1,strength=1) +
  geom_node_point(color=FB_NODES$COLORZ, size=15) +
  geom_node_text(aes(label=name),angle=0,size=2, nudge_y = c(rep(0.06,18),rep(-0.06,9)), color='black' ) +
  theme_classic() + 
  theme(legend.text=element_text(size=6),legend.title=element_text(size=6),
        axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_edge_width(range = c(0.5,2)) + scale_edge_color_manual(values=col_vector) +
  xlim(-220,20) + ylim(-50,100)

ggsave(paste(PlotDir, "FB_Graph_V1.pdf",sep=""),
        plot = P4, device='pdf', scale = 1, width =10, height = 6, units ="in", dpi = 500, limitsize = TRUE)
 



```




# Make combined graph
```{r}

# Change names for ExR3, ExR1, and hDeltaK
EB_NODES_New=EB_NODES
EB_NODES_New$name=as.character(EB_NODES_New$name)
EB_NODES_New$name[EB_NODES_New$name=="ExR1"]="EB_ExR1"
EB_NODES_New$name[EB_NODES_New$name=="ExR3"]="EB_ExR3"
EB_NODES_New$name[EB_NODES_New$name=="hDeltaK"]="EB_hDeltaK"

EB_EDGES_New=EB_EDGES
EB_EDGES_New$from=as.character(EB_EDGES_New$from)
EB_EDGES_New$from[EB_EDGES_New$from=="ExR1"]="EB_ExR1"
EB_EDGES_New$from[EB_EDGES_New$from=="ExR3"]="EB_ExR3"
EB_EDGES_New$from[EB_EDGES_New$from=="hDeltaK"]="EB_hDeltaK"

EB_EDGES_New$to=as.character(EB_EDGES_New$to)
EB_EDGES_New$to[EB_EDGES_New$to=="ExR1"]="EB_ExR1"
EB_EDGES_New$to[EB_EDGES_New$to=="ExR3"]="EB_ExR3"
EB_EDGES_New$to[EB_EDGES_New$to=="hDeltaK"]="EB_hDeltaK"


FB_NODES_New=FB_NODES
FB_NODES_New$name=as.character(FB_NODES_New$name)
FB_NODES_New$name[FB_NODES_New$name=="ExR1"]="FB_ExR1"
FB_NODES_New$name[FB_NODES_New$name=="ExR3"]="FB_ExR3"
FB_NODES_New$name[FB_NODES_New$name=="hDeltaK"]="FB_hDeltaK"

FB_EDGES_New=FB_EDGES
FB_EDGES_New$from=as.character(FB_EDGES_New$from)
FB_EDGES_New$from[FB_EDGES_New$from=="ExR1"]="FB_ExR1"
FB_EDGES_New$from[FB_EDGES_New$from=="ExR3"]="FB_ExR3"
FB_EDGES_New$from[FB_EDGES_New$from=="hDeltaK"]="FB_hDeltaK"

FB_EDGES_New$to=as.character(FB_EDGES_New$to)
FB_EDGES_New$to[FB_EDGES_New$to=="ExR1"]="FB_ExR1"
FB_EDGES_New$to[FB_EDGES_New$to=="ExR3"]="FB_ExR3"
FB_EDGES_New$to[FB_EDGES_New$to=="hDeltaK"]="FB_hDeltaK"




EB_NODES_New$y=EB_NODES_New$y-100


NODES=rbind(EB_NODES_New,FB_NODES_New)
EDGES=rbind(EB_EDGES_New,FB_EDGES_New)


# make factor
EDGES$COLORZ=factor(EDGES$COLORZ, levels=unique(EDGES$COLORZ))


# Make ggraph object
graph = tbl_graph(NODES, EDGES)


# colors
col_vector=levels(EDGES$COLORZ)


# Make plot and save
P4=ggraph(graph,layout="manual",x=NODES$x,y=NODES$y) + 
  geom_edge_fan( aes(width=weight, color=COLORZ), 
                 arrow = arrow(length = unit(2, 'mm'),ends = "last", type = "closed"), end_cap = circle(0.75, 'cm'), alpha=1,strength=1) +
  geom_node_point(color=NODES$COLORZ, size=15) +
  geom_node_text(aes(label=name),angle=0,size=2, nudge_y = c(rep(0.06,18),rep(-0.06,9)), color='black' ) +
  theme_classic() + 
  theme(legend.text=element_text(size=6),legend.title=element_text(size=6),
        axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_edge_width(range = c(0.5,2)) + scale_edge_color_manual(values=col_vector)
  #xlim(-220,20) + ylim(-50,100)

ggsave(paste(PlotDir, "FIGURE_Graph_V1.pdf",sep=""),
        plot = P4, device='pdf', scale = 1, width =7, height = 8, units ="in", dpi = 500, limitsize = TRUE)
 


```





