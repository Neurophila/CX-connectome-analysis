---
title: "Notebook analyzing MBON to CX connections"
output:
  html_document:
    df_print: paged
---

# Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
library(matlib)
library(RColorBrewer)
library(ggraph)
library(robustbase)
require(alphahull)
library(zoo)
library(ggpubr)
library(ggraph)
library(igraph)
library(tidygraph)
library(xlsx)
library(dtplyr)
library(neuprintrExtra)
library("xlsx")
library(tidyselect)
library(reshape2)
library(scales)
library(cowplot)
options(nat.plotengine = 'rgl')
```

# Make directory to save plots to
```{r}

PlotDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/MB_Analysis/"
if (!dir.exists(PlotDir)){dir.create(PlotDir)}

```

# Connect to neuprint server.
```{r}
neuprint_login()
```

# Get general functions
```{r}

source("FB_Mbon_to_Cx_Utils")

```

# Get all MBONs and table of CX neuron types
```{r message=FALSE, warning=FALSE}

# Get MBONs
MB_NamedBodies=getNeuronsInRoiTable("MB(R)",0)
MB_NamedBodies=subset(MB_NamedBodies, startsWith(name,"MBON"))
MBONs_Types_Table=getTypesTable(unique(MB_NamedBodies$type))

# Load table of known CX types
CXTypes <- supertype(read_csv("C:\\Users\\labadmin\\Dropbox\\FIBSEM CX Paper Jan 2020\\CX-cell-types060920"))$n.type

```


# ####################################################################################################################
# ######### Figure 1: MBON to CX direct connections ##################################################################
# ####################################################################################################################


# Get MBON to CX direct connections
```{r}

# Get MBON downstream connections, segregated by hemisphere (i.e. lateralized)
# Lateralization is important because it keeps the postsynaptic L and R groups separate.
# That way, when computing type-to-type weights, we aren't biased by postsyanptic neurons whose
# inputs may be cut, which could contribute a 0 just because of cut fibers. 
DownBag_L1=neuronBag(MBONs_Types_Table, by.roi=TRUE, omitInputs=TRUE, omitOutputs=FALSE)
DownBag_L1=lateralize_types(DownBag_L1) 

# Compute relative weight by summing ROIs not in the CX and not on the left side of the brain, which deals with polarity and lateralization issues.
# Polarity, since most FBt types receive a lot of input in the CX, the roi-independent relative weight can be very low.
# Lateralization, since some CX targets could have  dendrites on the left or dendrites on the right or both. So it makes sense to use all MBONs (L and R)
#   and just look at their targets in right ROIs (which should be more complete).
roiH <- getRoiTree()
outsideRegions <- unique(selectRoiSet(exceptions=sapply(as.character(unique(roiH$level1[grepl(roiH$level1,pattern="(R)")])),
                  function(i) return(1),USE.NAMES = TRUE,simplify=FALSE), exceptionLevelMatch = 1)$roi[roiH$level1!="CX" & roiH$side4!="Left"])
DownBag_L1 <- combineRois(DownBag_L1, outsideRegions, newRoi="NonCX") # Sum synapses across all non-CX ROIs on the right side 
                                  
# Recompute the lateralized type-to-type table but without using the t-test significance criteria. Because many FB tangential types 
# are composed of two neurons, the t-test can occasionally filter out strong connetions involving two neurons with variable weights. 
DownTypes_L1=getTypesTable(unique(c(DownBag_L1$outputs_raw$databaseType.from, DownBag_L1$outputs_raw$databaseType.to))) %>% lateralize_types()
Downstream_T2T_L1=getTypeToTypeTable(DownBag_L1$outputs_raw, majorOutputThreshold = 0.8, singleNeuronThreshold = 0,
                                     singleNeuronThresholdN = 3, pThresh = 1, typesTable = DownTypes_L1, oldTable = NULL) 

# Restrict to just strong CX targets (i.e. relative weight > 0.01 and at least 10 synapses).
MB2CX_Direct=subset(Downstream_T2T_L1, databaseType.to %in% CXTypes  & weightRelative>0.01 & weight>10)
MB2CX_Direct_Exclude=subset(Downstream_T2T_L1, databaseType.to %in% CXTypes & !(weightRelative>0.01 & weight>10) )

```


# Make network graph showing MBON to CX direct connections
```{r}

# Get just the MBON-->CX pairs with max weight, regardless of hemisphere. We can't jut average L/R pairs because relative
# weights needs to first be summed over all postsynaptic neurons, but this is hard to do for the hemibrain, since we don't
# know for certain which fibers have been cut (would have to look at all CX and MBON neurons in detail). 
Graph_Data=MB2CX_Direct %>% group_by(databaseType.from, databaseType.to) %>% filter(weight == max(weight))
Graph_Data$type.from=Graph_Data$databaseType.from
Graph_Data$type.to=Graph_Data$databaseType.to

# Cluster the FB neurons by their input vectors
Graph_Data_Clust=connectivityCluster(inputsTable = Graph_Data, outputsTable = NULL) %>% setClusters(h = 0.8, k = NULL)
Graph_Data_Clust=Graph_Data_Clust$inputsTable %>% arrange(cluster.to)

# Now sort MBONs by which cluster they project most strongly to
PreOrder=Graph_Data_Clust %>% group_by(type.from) %>% filter(weightRelative == max(weightRelative))
PreOrder=PreOrder[c("type.from","cluster.to")]
colnames(PreOrder)=c("type.from","cluster.from")
Graph_Data_Clust=merge(Graph_Data_Clust,PreOrder, by="type.from")

  








P1=ggraph(graph,layout="manual",x=NODES$x,y=NODES$y) + 
  geom_edge_fan( aes(width=weight, color=COLORZ),
                 arrow = arrow(length = unit(2, 'mm'),ends = "last", type = "closed"),
                 end_cap = circle(0.66, 'cm'), alpha=1,strength=1, n=2, linemitre=1) +
  geom_node_point(aes(size = Size), color=NODES$COLORZ, fill=NODES$FILLZ) + scale_size(range = c(7,12)) +
  geom_node_text(aes(label=name),angle=0,size=3, nudge_x = NODES$x*0.08, color='black' ) +
  theme_classic() + 
  theme(legend.text=element_text(size=6),legend.title=element_text(size=6),
        axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_edge_width(range = c(1,6)) + scale_edge_color_manual(values=col_vector)
print(P1)
ggsave(paste(SaveDir, "Graph_V1.pdf",sep=""),
        plot = P1, device='pdf', scale = 1, width =8, height = 13, units ="in", dpi = 500, limitsize = TRUE)



```



# Plot threshold dependence
```{r}


# For each MBON with direct connections to the CX plot the max relative weight
All_MB2CX_Direct=Downstream_T2T_L1 %>% 
  subset(databaseType.to %in% CXTypes & !databaseType.from=="MBON15-like") %>%
  group_by(databaseType.from, databaseType.to) %>% filter(weight == max(weight))
All_MB2CX_Direct$type.from=All_MB2CX_Direct$databaseType.from
All_MB2CX_Direct$type.to=All_MB2CX_Direct$databaseType.to
MBON_Direct_byThresh_Plot=All_MB2CX_Direct %>% group_by(databaseType.from) %>% summarize(weightRelative=max(weightRelative))


P1a=ggplot(data=MBON_Direct_byThresh_Plot, aes(x=databaseType.from, y=weightRelative)) + 
  geom_bar(stat="identity", color="black", fill='black', width=0.850) + theme_classic()  + 
  theme(axis.text.x = element_text(angle = 90)) + scale_y_continuous(breaks = seq(from=0, to=0.14, by=0.01), lim=c(0,0.14) )
  ggsave(paste(SaveDir, "MBON_by_Thrsh.pdf",sep=""),
         plot = P1a, device='pdf', scale = 1, width =6, height = 3.5, units ="in", dpi = 500, limitsize = TRUE)

  
  
# Loop over different relative weight thresholds and compute the number of direction MBON-->CX targets
Threshes=seq(from=0.001, to=0.2, by=0.001)
Num_of_Cx_Types=data.frame(thresh=numeric(), NumofCxTypes=numeric())
for (ttt in 1:length(Threshes)){
  Temp_All_MB2CX_Direct=All_MB2CX_Direct %>% subset(weightRelative>Threshes[ttt] & weight > 0)
  if (length(Temp_All_MB2CX_Direct$databaseType.from)>0){
    Num_of_Cx_Types[ttt,1]=Threshes[ttt]
    Num_of_Cx_Types[ttt,2]=length(unique(Temp_All_MB2CX_Direct$databaseType.to))
  }
}

P2=ggplot(data=Num_of_Cx_Types, aes(x=thresh, y=NumofCxTypes)) +
  geom_line() + theme_classic() + 
  theme(axis.text.x = element_text(angle = 90)) + scale_x_continuous(breaks = seq(from=0, to=0.12, by=0.01), lim=c(0,0.12) )
  ggsave(paste(SaveDir, "NumOfCxTypes_by_Thrsh.pdf",sep=""),
         plot = P2, device='pdf', scale = 1, width =4, height = 3.5, units ="in", dpi = 500, limitsize = TRUE)
  
  
  
# Make a scatter plot of weight vs relative weight for each connection
P3=ggplot(data=All_MB2CX_Direct, aes(x=weight, y=weightRelative)) + geom_point(size=1, shape=1) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(breaks = seq(from=0, to=0.12, by=0.01), lim=c(0,0.12) ) + 
  scale_x_continuous(breaks = seq(from=0, to=150, by=10), lim=c(0,150) )

ggsave(paste(SaveDir, "Thresh_Scatter.pdf",sep=""),
         plot = P3, device='pdf', scale = 1, width =4, height = 3.5, units ="in", dpi = 500, limitsize = TRUE)

  

```



# ####################################################################################################################
# ######### Figure 2: MBON to CX indirect connections ################################################################
# ####################################################################################################################


# Get indirect connections
```{r}


# Get strong connections from MBONs to non-CX neurons
MB2NonCX=subset(Downstream_T2T_L1, !(databaseType.to %in% CXTypes)  & weightRelative>0.02 & weight>20) ########


# Get type table
L2_Types=sort(unique(MB2NonCX$databaseType.to))
L2_Types=L2_Types[is.na(as.numeric(L2_Types))]
L2_Types=L2_Types[! (startsWith(L2_Types,"(") | startsWith(L2_Types,"Ascending") | startsWith(L2_Types, "MBON"))]
L2_Types_Table=getTypesTable(L2_Types)


# Get second layer lateralized outputs
# Lateralization is important because it keeps the postsynaptic L and R groups separate.
# That way, when computing type-to-type weights, we aren't biased by postsyanptic neurons whose
# inputs may be cut, which could contribute a 0 just because of cut fibers. 
DownBag_L2=neuronBag(L2_Types_Table, by.roi=TRUE, omitInputs=TRUE, omitOutputs=FALSE)
DownBag_L2=lateralize_types(DownBag_L2)


# Compute weight relative by summing ROIs not in the CX and not on the left side of the brain, which deals with polarity and lateralization issues.
# Polarity, since most FBt types receive a lot of input in the CX, the roi-independent relative weight can be very low.
# Lateralization, since some CX targets could have  dendrites on the left or dendrites on the right or both. So it makes sense to use all MBONs (L and R)
#   and just look at their targets in right ROIs (which should be more complete).
DownBag_L2 <- combineRois(DownBag_L2, outsideRegions, newRoi="NonCX") # Sum synapses across all non-CX ROIs on the right side
           
                       
# Recompute type-to-type table
DownTypes_L2=getTypesTable(unique(c(DownBag_L2$outputs_raw$databaseType.from,
                                    DownBag_L2$outputs_raw$databaseType.to))) %>% lateralize_types()
Downstream_T2T_L2=getTypeToTypeTable(DownBag_L2$outputs_raw, majorOutputThreshold = 0.8, singleNeuronThreshold = 0,
                                     singleNeuronThresholdN = 3, pThresh = 1, typesTable = DownTypes_L2, oldTable = NULL) # No t-test type-to-type tables 




```



# Get just indirect connections to the CX and plot
```{r}


# Get first and second layer of projections
L2_to_Cx=subset(Downstream_T2T_L2, databaseType.to %in% CXTypes  & weightRelative>0.02 & weight>20)
L1_to_L2=subset(MB2NonCX, databaseType.to %in% L2_to_Cx$databaseType.from & weightRelative>0.02 & weight>20
                & !startsWith(type.to,"MBON") & !databaseType.from=="MBON15-like")


# Average over left and right 
L2_to_Cx_Ave=L2_to_Cx %>% group_by(databaseType.from, databaseType.to) %>%  filter(weight == max(weight))
L2_to_Cx_Ave$type.from=L2_to_Cx_Ave$databaseType.from
L2_to_Cx_Ave$type.to=L2_to_Cx_Ave$databaseType.to

L1_to_L2_Ave=L1_to_L2 %>% group_by(databaseType.from, databaseType.to) %>%  filter(weight == max(weight))
L1_to_L2_Ave$type.from=L1_to_L2_Ave$databaseType.from
L1_to_L2_Ave$type.to=L1_to_L2_Ave$databaseType.to



TempOrder= L1_to_L2_Ave %>% arrange(type.from) %>% group_by(type.to) %>% filter(weight == max(weight))
P2=plotConnectivity(L1_to_L2_Ave, slctROI = NULL, grouping = "type", connectionMeasure = "weightRelative",
  xaxis = c("outputs"), facetInputs = NULL, facetOutputs = NULL, theme = theme_minimal(),
  cmax = NULL, replacementLabels = NULL, 
  orderIn = (sort(unique(L1_to_L2_Ave$type.from))), 
  orderOut = TempOrder$type.to,
  legendName = NULL, showTable = "inputs")
P2 = P2 +   coord_fixed(ratio = 1) +
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        text = element_text(size=6)) 
print(P2)
ggsave(paste(SaveDir, "L1_to_L2_Ave.Pdf",sep=""),
        plot = P2, device='pdf', scale = 1, width =8, height = 6, units ="in", dpi = 500, limitsize = TRUE)


TempOrder2= L2_to_Cx_Ave %>% arrange(match(type.from, unique(TempOrder$type.to))) %>%
                                       group_by(type.to) %>% filter(weight == max(weight))
P2=plotConnectivity(L2_to_Cx_Ave, slctROI = NULL, grouping = "type", connectionMeasure = "weightRelative",
  xaxis = c("outputs"), facetInputs = NULL, facetOutputs = NULL, theme = theme_minimal(),
  cmax = NULL, replacementLabels = NULL,
  orderIn = unique(TempOrder2$type.from),
  orderOut = NULL,
  legendName = NULL, showTable = "inputs")
P2 = P2 + coord_fixed(ratio = 1) + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        text = element_text(size=6)) 
print(P2)
ggsave(paste(SaveDir, "L2_to_Cx_Ave.Pdf",sep=""),
        plot = P2, device='pdf', scale = 1, width =8, height = 6, units ="in", dpi = 500, limitsize = TRUE)



# Construct pathway object
MBON2CX_Indirect_Ave=tableChain2path(L1_to_L2_Ave, L2_to_Cx_Ave)
MBON2CX_Indirect_Ave=subset(MBON2CX_Indirect_Ave, !is.na(type_N1) )

sort(unique(MBON2CX_Indirect_Ave$databaseType.to))


```


# Plot the number of pathways from MBONs to the various FB layers
```{r}


library(prismatic)
library(paletteer)


# Group my projections to FB layer
MBON2CX_Indirect_Ave_FBlayer=subset(MBON2CX_Indirect_Ave, startsWith(databaseType.to,"FB"))
MBON2CX_Indirect_Ave_FBlayer$FBlayer=paste("L", substr(MBON2CX_Indirect_Ave_FBlayer$databaseType.to,3,3), sep="")
MBON2CX_Indirect_Ave_FBlayer=MBON2CX_Indirect_Ave_FBlayer %>% group_by(databaseType.from, FBlayer) %>%
  summarize(NumOfPaths=n(), NumOfFBt=length(unique(databaseType.to)), weightRelative_path=mean(weightRelative_path))
MBON2CX_Indirect_Ave_FBlayer$FBlayer=factor(MBON2CX_Indirect_Ave_FBlayer$FBlayer, levels=c("L1","L2","L3","L4","L5","L6","L7","L8","L9"))


  
PP2=ggplot(MBON2CX_Indirect_Ave_FBlayer) +
  geom_tile(aes(databaseType.from,FBlayer,fill=NumOfFBt)) + scale_y_discrete(drop=FALSE) +
  scale_fill_paletteer_c("ggthemes::Sunset-Sunrise Diverging", limits=c(0,14), breaks = c(0,7,14), oob=squish, na.value="gray50") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"))  + coord_fixed(ratio = 1)
ggsave(paste(SaveDir, "byLayer_NumOfFBt.Pdf",sep=""),
        plot = PP2, device='pdf', scale = 1, width =8, height = 4, units ="in", dpi = 500, limitsize = TRUE)


# Make plot again, but with higher threshold
# Group my projections to FB layer
MBON2CX_Indirect_Ave_FBlayer_High=subset(MBON2CX_Indirect_Ave, startsWith(databaseType.to,"FB") & weightRelative_N1>0.02 & weightRelative_N2>0.02)
MBON2CX_Indirect_Ave_FBlayer_High$FBlayer=paste("L", substr(MBON2CX_Indirect_Ave_FBlayer_High$databaseType.to,3,3), sep="")
MBON2CX_Indirect_Ave_FBlayer_High=MBON2CX_Indirect_Ave_FBlayer_High %>% group_by(databaseType.from, FBlayer) %>%
  summarize(NumOfPaths=n(), NumOfFBt=length(unique(databaseType.to)), weightRelative_path=mean(weightRelative_path))
MBON2CX_Indirect_Ave_FBlayer_High$FBlayer=factor(MBON2CX_Indirect_Ave_FBlayer_High$FBlayer, levels=c("L1","L2","L3","L4","L5","L6","L7","L8","L9"))
MBON2CX_Indirect_Ave_FBlayer_High$databaseType.from=factor(MBON2CX_Indirect_Ave_FBlayer_High$databaseType.from,
                                                           levels=sort(unique(MBON2CX_Indirect_Ave_FBlayer$databaseType.from)))


PP2=ggplot(MBON2CX_Indirect_Ave_FBlayer_High) +
  geom_tile(aes(databaseType.from,FBlayer,fill=NumOfFBt)) + scale_y_discrete(drop=FALSE) + scale_x_discrete(drop=FALSE) +
  scale_fill_paletteer_c("ggthemes::Sunset-Sunrise Diverging", limits=c(0,14), breaks = c(0,7,14), oob=squish, na.value="gray50") +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"))  + coord_fixed(ratio = 1)
ggsave(paste(SaveDir, "byLayer_NumOfFBt_High.Pdf",sep=""),
        plot = PP2, device='pdf', scale = 1, width =8, height = 4, units ="in", dpi = 500, limitsize = TRUE)



```



# Use CD's code from CX_ContextualAnalysisUtils.R to get the MBON info larry provided
```{r}

#source("../CX_ContextualAnalysisUtils.R")

# Read tables of PN to MBON with input modality percentages and return a data frame
getPN2MBONinputTable <- function(){
  PN2MBON_InputPc <- read.csv('C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FIGURE_MB/PN2MBON.csv', header = FALSE)
  PN2ATMBON_InputPc <- read.csv('C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FIGURE_MB/PN2ATMBON.csv', header = FALSE)
  PNtypes <- c('UniGlom', 'MultiGlom', 'ThermoHygro', 'Visual')
  colnames(PN2MBON_InputPc) <- PNtypes
  colnames(PN2ATMBON_InputPc) <- PNtypes
  MBONtypeNames <- c('MBON01', 'MBON02', 'MBON03', 'MBON04', 'MBON05', 'MBON06', 'MBON07', 'MBON09', 'MBON11', 'MBON12', 'MBON13', 'MBON14', 'MBON15', 'MBON16', 'MBON17', 'MBON18', 'MBON19a', 'MBON19b', 'MBON20', 'MBON21', 'MBON22', 'MBON23')
  atypicalMBONtypeNames <- c('MBON10', 'MBON24', 'MBON25', 'MBON26', 'MBON27', 'MBON29', 'MBON30', 'MBON31', 'MBON32', 'MBON33', 'MBON34', 'MBON35', 'MBON28')
  allMBONtypeNames <- c(MBONtypeNames,atypicalMBONtypeNames)
  rownames(PN2MBON_InputPc) <- MBONtypeNames
  rownames(PN2ATMBON_InputPc) <- atypicalMBONtypeNames
  PN2allMBON_InputPct <- rbind(PN2MBON_InputPc,PN2ATMBON_InputPc)
  PN2allMBON_InputPct <- PN2allMBON_InputPct %>% mutate(Olfactory = UniGlom + MultiGlom) # add a column for the sum of UniGlom and MultiGlom as Olfactory
  PN2allMBON_InputPct <- PN2allMBON_InputPct %>% mutate(MBON = allMBONtypeNames) # add a column for matching MBON type names
  
  PN2allMBON_InputPct[[17,"MBON"]] <- "MBON19" # combine the 2 MBON19 types
  PN2allMBON_InputPct[[18,"MBON"]] <- "MBON19"
  
  return(PN2allMBON_InputPct)
}
```


# Get visual and thermo/hygro types
```{r}

MBON_Input_Percents=getPN2MBONinputTable()
Visual_MBONs=unique(MBON_Input_Percents$MBON[MBON_Input_Percents$Visual>20])
ThermoHygro_MBONs=unique(MBON_Input_Percents$MBON[MBON_Input_Percents$ThermoHygro>20])


# Get intermediate supertypes
Temp=subset(MBON2CX_Indirect_Ave, type.from %in% c(Visual_MBONs,ThermoHygro_MBONs) & weightRelative_N1>0.02 & weightRelative_N2>0.02)
Int_all=sort(unique(Temp$supertype1_N1))


```


# Make plots of indirect visual connections
```{r}


# Convert pathway dataframe to connecitiy table (from-to pairs)
Graph_Pathway=subset(MBON2CX_Indirect_Ave, type.from %in% Visual_MBONs & weightRelative_N1>0.02 & weightRelative_N2>0.02)
Graph_Data_L1=Graph_Pathway[c("type.from","type_N1","weightRelative_N1","supertype1_N1")]
colnames(Graph_Data_L1)=c("from","to","weight","supertype1_N1")
Graph_Data_L1$Layer="L1"
Graph_Data_L2=Graph_Pathway[c("type_N1","type.to","weightRelative_N2","supertype1_N1")]
colnames(Graph_Data_L2)=c("from","to","weight","supertype1_N1")
Graph_Data_L2$Layer="L2"
Graph_Data=rbind(Graph_Data_L1,Graph_Data_L2)
remove(Graph_Data_L1, Graph_Data_L2)


# Get a list of intermediate and CX nodes
IntermediateNodes=unique(Graph_Pathway$type_N1)
CXNodes=unique(Graph_Pathway$type.to)


# Make edges
EDGES=Graph_Data


# Make nodes
NODES=data.frame(name=unique(c(EDGES$from,EDGES$to)))
NODES$name=as.character(NODES$name)

NODES$x=NA
MBONlogica=startsWith(NODES$name,"MBON")
NODES$x[MBONlogica]=-1
NODES$y[MBONlogica]=seq(from=-1, to=1, by=2/(sum(MBONlogica)-1))*0.35

Intermediatelogica=NODES$name %in% IntermediateNodes
NODES$x[Intermediatelogica]=0
NODES$y[Intermediatelogica]=seq(from=-1, to=1, by=2/(sum(Intermediatelogica)-1))*1

CXlogica=NODES$name %in% CXNodes
NODES$x[CXlogica]=1
NODES$y[CXlogica]=seq(from=-1, to=1, by=2/(sum(CXlogica)-1))*1.3


# Set node colors
NODES$COLORZ="Black"
NODES$FILLZ="Black"


# Set edge color
EDGES$supertype1_N1=factor(EDGES$supertype1_N1,levels=Int_all)
col_vector=(color(c("navy","dodgerblue2","limegreen", "magenta3","hotpink1","darkviolet","slateblue1")))


# Make graph
graph = tbl_graph(NODES, EDGES)


G1=ggraph(graph,layout="manual",x=NODES$x,y=NODES$y) + 
  geom_edge_fan( aes(width=weight, color=EDGES$supertype1_N1),
                 arrow = arrow(length = unit(2, 'mm'),ends = "last", type = "closed"),
                 end_cap = circle(0.3, 'cm'), alpha=1,strength=1, n=2, linemitre=1) +
  geom_node_point(size=4, color=NODES$COLORZ, fill=NODES$FILLZ) +
  geom_node_text(aes(label=name),angle=0,size=3, nudge_x = NODES$x*0.18, color='red' ) +
  theme_classic() + 
  theme(legend.text=element_text(size=6),legend.title=element_text(size=6),
        axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_edge_width(range = c(0.5,4)) + scale_edge_color_manual(values=col_vector, drop=FALSE)


G1=ggsave(paste(SaveDir, "Visual_Graph_V1.pdf",sep=""),
        plot = G1, device='pdf', scale = 1, width =8, height = 10, units ="in", dpi = 500, limitsize = TRUE)





```



# Make plots of indirect thermo/hygro connections
```{r}


# Convert pathway dataframe to connecitiy table (from-to pairs)
Graph_Pathway=subset(MBON2CX_Indirect_Ave, type.from %in% ThermoHygro_MBONs  & weightRelative_N1>0.02 & weightRelative_N2>0.02) %>% arrange(type.from)
Graph_Data_L1=Graph_Pathway[c("type.from","type_N1","weightRelative_N1","supertype1_N1")]
colnames(Graph_Data_L1)=c("from","to","weight","supertype1_N1")
Graph_Data_L1$Layer="L1"
Graph_Data_L2=Graph_Pathway[c("type_N1","type.to","weightRelative_N2","supertype1_N1")]
colnames(Graph_Data_L2)=c("from","to","weight","supertype1_N1")
Graph_Data_L2$Layer="L2"
Graph_Data=rbind(Graph_Data_L1,Graph_Data_L2)
remove(Graph_Data_L1, Graph_Data_L2)


# Get a list of intermediate and CX nodes
IntermediateNodes=unique(Graph_Pathway$type_N1)
CXNodes=unique(Graph_Pathway$type.to)


# Make edges
EDGES=Graph_Data


# Make nodes
NODES=data.frame(name=unique(c(EDGES$from,EDGES$to)))
NODES$name=as.character(NODES$name)


NODES$x=NA
MBONlogica=startsWith(NODES$name,"MBON")
NODES$x[MBONlogica]=-1
NODES$y[MBONlogica]=seq(from=-1, to=1, by=2/(sum(MBONlogica)-1))*0.35

Intermediatelogica=NODES$name %in% IntermediateNodes
NODES$x[Intermediatelogica]=0
NODES$y[Intermediatelogica]=seq(from=-1, to=1, by=2/(sum(Intermediatelogica)-1))*1

CXlogica=NODES$name %in% CXNodes
NODES$x[CXlogica]=1
NODES$y[CXlogica]=seq(from=-1, to=1, by=2/(sum(CXlogica)-1))*1.3


# Set node colors
NODES$COLORZ="Black"
NODES$FILLZ="Black"


# Set edge color
EDGES$supertype1_N1=factor(EDGES$supertype1_N1,levels=Int_all)
col_vector=(color(c("navy","dodgerblue2","limegreen", "magenta3","hotpink1","darkviolet","slateblue1")))


# Make graph
graph = tbl_graph(NODES, EDGES)


G1=ggraph(graph,layout="manual",x=NODES$x,y=NODES$y) + 
  geom_edge_fan( aes(width=weight, color=EDGES$supertype1_N1),
                 arrow = arrow(length = unit(2, 'mm'),ends = "last", type = "closed"),
                 end_cap = circle(0.3, 'cm'), alpha=1,strength=1, n=2, linemitre=1) +
  geom_node_point(size=4, color=NODES$COLORZ, fill=NODES$FILLZ) +
  geom_node_text(aes(label=name),angle=0,size=3, nudge_x = NODES$x*0.18, color='red' ) +
  theme_classic() + 
  theme(legend.text=element_text(size=6),legend.title=element_text(size=6),
        axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_edge_width(range = c(0.5,4)) + scale_edge_color_manual(values=col_vector, drop=FALSE)


G1=ggsave(paste(SaveDir, "ThermoHygro_Graph_V1.pdf",sep=""),
        plot = G1, device='pdf', scale = 1, width =8, height = 5, units ="in", dpi = 500, limitsize = TRUE)





```





# Make plots of indirect thermo/hygro connections
```{r}


# Convert pathway dataframe to connecitiy table (from-to pairs)
Graph_Pathway=subset(MBON2CX_Indirect_Ave, !startsWith(type.to,"FB")  & weightRelative_N1>0.02 & weightRelative_N2>0.02) %>% arrange(type.from)
Graph_Data_L1=Graph_Pathway[c("type.from","type_N1","weightRelative_N1","supertype1_N1")]
colnames(Graph_Data_L1)=c("from","to","weight","supertype1_N1")
Graph_Data_L1$Layer="L1"
Graph_Data_L2=Graph_Pathway[c("type_N1","type.to","weightRelative_N2","supertype1_N1")]
colnames(Graph_Data_L2)=c("from","to","weight","supertype1_N1")
Graph_Data_L2$Layer="L2"
Graph_Data=rbind(Graph_Data_L1,Graph_Data_L2)
remove(Graph_Data_L1, Graph_Data_L2)


# Get a list of intermediate and CX nodes
IntermediateNodes=unique(Graph_Pathway$type_N1)
CXNodes=unique(Graph_Pathway$type.to)


# Make edges
EDGES=Graph_Data


# Make nodes
NODES=data.frame(name=unique(c(EDGES$from,EDGES$to)))
NODES$name=as.character(NODES$name)


NODES$x=NA
MBONlogica=startsWith(NODES$name,"MBON")
NODES$x[MBONlogica]=-1
NODES$y[MBONlogica]=seq(from=-1, to=1, by=2/(sum(MBONlogica)-1))*1

Intermediatelogica=NODES$name %in% IntermediateNodes
NODES$x[Intermediatelogica]=0
NODES$y[Intermediatelogica]=seq(from=-1, to=1, by=2/(sum(Intermediatelogica)-1))*1

CXlogica=NODES$name %in% CXNodes
NODES$x[CXlogica]=1
NODES$y[CXlogica]=seq(from=-1, to=1, by=2/(sum(CXlogica)-1))*0.8


# Set node colors
NODES$COLORZ="Black"
NODES$FILLZ="Black"


# Set edge color
EDGES$supertype1_N1=factor(EDGES$supertype1_N1,levels=Int_all)
col_vector=(color(c("navy","dodgerblue2","limegreen", "magenta3","hotpink1","darkviolet","slateblue1")))


# Make graph
graph = tbl_graph(NODES, EDGES)


G1=ggraph(graph,layout="manual",x=NODES$x,y=NODES$y) + 
  geom_edge_fan( aes(width=weight, color=EDGES$supertype1_N1),
                 arrow = arrow(length = unit(2, 'mm'),ends = "last", type = "closed"),
                 end_cap = circle(0.3, 'cm'), alpha=1,strength=1, n=2, linemitre=1) +
  geom_node_point(size=4, color=NODES$COLORZ, fill=NODES$FILLZ) +
  geom_node_text(aes(label=name),angle=0,size=3, nudge_x = NODES$x*0.18, color='red' ) +
  theme_classic() + 
  theme(legend.text=element_text(size=6),legend.title=element_text(size=6),
        axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_edge_width(range = c(0.5,4)) + scale_edge_color_manual(values=col_vector, drop=FALSE)


G1=ggsave(paste(SaveDir, "Non_FB_Graph_V1.pdf",sep=""),
        plot = G1, device='pdf', scale = 1, width =8, height = 4, units ="in", dpi = 500, limitsize = TRUE)





```






# Make plots of non-FBt pathways
```{r}

NonFBt_Types=sort(unique(MBON2CX_Indirect_Ave$databaseType.to)) 
NonFBt_Types=NonFBt_Types[!startsWith(NonFBt_Types, "FB")]


ExRPaths=subset(MBON2CX_Indirect_Ave, startsWith(databaseType.to,"ExR"))
LalNoPaths=subset(MBON2CX_Indirect_Ave, startsWith(databaseType.to,"LC") | startsWith(databaseType.to,"GLN") | startsWith(databaseType.to,"LNO"))


```


