---
title: "Notebook plotting columnar structure of hDelta neurons"
output:
  html_document:
    df_print: paged
---


### Command to clear environment is: rm(list = ls(all.names = TRUE))
### Command to update is remotes::update_packages('neuprintr')
### Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
library(matlib)
library(RColorBrewer)
library(ggraph)
library(robustbase)
require(alphahull)
library(zoo)
library(ggpubr)
library(ggraph)
library(igraph)
library(tidygraph)
library(xlsx)
library(dtplyr)
library(neuprintrExtra)
library("xlsx")
library(tidyselect)
library(paletteer)
library(quantmod)
options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose ROI and save/plot directories
```{r}

# Directory to save data to.
SaveDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/"

# Directory to save plots to.
PlotDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/hDelta_Columns/"

# Create save/plot directory if they dont exists yet
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}


```

### Connect to neuprint server.
```{r}
neuprint_login()
```

### Get general functions
```{r}

source("FB_SynapseDistribution_Utils.r")
source("FB_LayerOutline_Utils.r")
source("FB_ConnectivityOffsetPlotting_Utils.r")
source("../visualizeConnectivityTables.r", chdir = TRUE)
source("../inputOutputRegionsVis.r")
source("../GetNeuronsInRoi.r")


```


# Get all FB bodies and columnar types
```{r}

NamedBodies = Get_AllNeurons_InRoi("FB", FALSE)
Columnar_Types=sort(unique( NamedBodies$bodytype[ startsWith(NamedBodies$bodytype, "PF" ) | startsWith(NamedBodies$bodytype, "FR" ) | 
               startsWith(NamedBodies$bodytype, "FS" ) | startsWith(NamedBodies$bodytype, "FC" ) | 
                 startsWith(NamedBodies$bodytype, "vDelta" ) | startsWith(NamedBodies$bodytype, "hDelta")] ))
FBBodyCount=NamedBodies %>% group_by(bodytype) %>% summarize(NumofNeurons=n())
FBColumnarBodyCount=subset(FBBodyCount, bodytype %in% Columnar_Types)

```


# Load pre-processed synapse location data and remove variables that won't be used
# NOTE: Need to rebuild this periodically in case types/names get changed
```{r}

load(paste(SaveDir,"FBColumnarSynapses_PostPCA.RData",sep=""))
rm(list=c("roiEigen","Mesh_FB_Points","Mesh_FB_L1_Points", "Mesh_FB_L2_Points","Mesh_FB_L3_Points", "Mesh_FB_L4_Points",
          "Mesh_FB_L5_Points", "Mesh_FB_L6_Points","Mesh_FB_L7_Points", "Mesh_FB_L8_Points", "Mesh_FB_L9_Points","origin"))

# Assign Side, PB glom, and FB col info
FBC_SynsAll=Assign_FBcol_PBglom(FBC_SynsAll, "bodyname", "Side", "PBglom", "FBcol", "bodyid")


```



# Plot synapse locations for each neuron type
```{r}

hDelta_SynsAll=subset(FBC_SynsAll, startsWith(type,"hDelta"))
hDelta_Types=unique(hDelta_SynsAll$type)

# Make pre/post = 1/0
hDelta_SynsAll$prepost[hDelta_SynsAll$prepost == "Output"] = 1
hDelta_SynsAll$prepost[hDelta_SynsAll$prepost == "Input"] = 0
hDelta_SynsAll$prepost=as.numeric(hDelta_SynsAll$prepost)
hDelta_ColumnPositions=data.frame(LR=character(),X=numeric(),Y=numeric(), Z=numeric(), 
                                  bodyid=character(), type=character(), bodyname=character(), prepost=numeric())

# Loop over hDelta types and individual neurons and find approximate location of pre/post arbors
LayerSubset=TRUE
for (ttt in 1:length(hDelta_Types)){
  print(as.character(ttt))
  
  # Get synapses for just this neuron type
  TempTypeSyns=subset(hDelta_SynsAll, type == hDelta_Types[ttt])
  
  
  if (LayerSubset==TRUE & !hDelta_Types[ttt]=="hDeltaK"){
    # Find layer with most synapses and assume it has axon/dendrites
    TempSynsPerLayer=TempTypeSyns %>% group_by(Layer) %>% summarize(n=n()) ###
    MaxLayer=as.character(TempSynsPerLayer$Layer[which(TempSynsPerLayer$n == max(TempSynsPerLayer$n))]) ###
    eval(parse( text= paste("OUTLINE=Outline_", MaxLayer,"_XZ",sep="") )) ###
    
    # Get just the synapses in that layer
    TempTypeSyns=subset(TempTypeSyns, Layer==MaxLayer) ###
  } else {
    OUTLINE = Outline_FB_XZ
    MaxLayer = "All"
  }
  
  
  # Loop over neurons and plot data
  TempBodyIds=unique(TempTypeSyns$bodyid)
  for (nnn in 1:length(TempBodyIds)){
    
    TempNeuronData=subset(TempTypeSyns, bodyid == TempBodyIds[nnn])
    TempNeuronData$LR=NA
    
    METHOD=2    
    if (METHOD==1){
      
      # Find point that divides the two innervated columns
      histinfo<-hist(TempNeuronData$X, breaks = seq(from = -9000, to = 9000, by = 1200), plot=FALSE)
      histinfo_df=data.frame(counts=histinfo$counts, breaks= histinfo$breaks[1:length(histinfo$breaks)-1] )
      A=findPeaks(histinfo$counts, thresh=2)
      A=c(min(A), max(A))
      Center=mean(histinfo$breaks[A])
      
      # Divide synapses in L/R columns
      TempNeuronData$LR[TempNeuronData$X>Center]="L"
      TempNeuronData$LR[TempNeuronData$X<=Center]="R"
      
      
      TempNeuronData$prepost=as.character( TempNeuronData$prepost)
      
    } else if (METHOD==2){
      
      # Perform K-means clusters (n=2 clusters to get pre/post arbors)
      TempSynLocs=TempNeuronData[c("X","Y")]
      k2 <- kmeans(TempSynLocs, centers = 2)
      TempClusters=k2$cluster
      Centers=k2$centers
      
      
      Cluster_LR=data.frame(Cluster=c(1,2),LR=NA)
      if (Centers[1,1] > Centers[2,1]){
        Cluster_LR$LR=c("L","R")
      } else {
        Cluster_LR$LR=c("R","L")
      }
      
      TempNeuronData$LR[TempClusters==1]=Cluster_LR$LR[1]
      TempNeuronData$LR[TempClusters==2]=Cluster_LR$LR[2]
    }
    
    # Calculate mean position of L/R and assign as input or output arbor
    ColumnPositions= TempNeuronData %>% group_by(LR) %>% summarise(X=median(X),Y=median(Y), Z=median(Z), prepost=mean(prepost))
    ColumnPositions$bodyid=TempNeuronData$bodyid[1]
    ColumnPositions$type=TempNeuronData$type[1]
    ColumnPositions$bodyname=TempNeuronData$bodyname[1]
    InputInd=which(ColumnPositions$prepost == min(ColumnPositions$prepost))
    ColumnPositions$prepost[InputInd] = "Input"
    if (InputInd == 1){
      ColumnPositions$prepost[2] = "Output"
    } else {
      ColumnPositions$prepost[1] = "Output"
    }
    
    
    # Add to data frame
    hDelta_ColumnPositions=rbind(hDelta_ColumnPositions,ColumnPositions)
    
    
    P0 = ggplot() + geom_path(data=histinfo_df, aes(x=breaks, y=counts), size = 1) + ggtitle(paste("Center = ", as.character(Center),sep="")) +  theme_bw()
    
    P1=ggplot() + geom_point(data=subset(TempNeuronData,LR=="L"), aes(x=X, y=Z), colour="midnightblue" ,  size=1, alpha = 0.1) + 
      geom_point(data=subset(TempNeuronData,LR=="R"), aes(x=X, y=Z), colour="black" ,  size=1, alpha = 0.05) +
      geom_point(data=(ColumnPositions), aes(x=X, y=Z, color=prepost),  size=5, alpha = 1) +
      coord_fixed(ratio = 1) +  geom_path(data=OUTLINE, aes(x=c1, y=c2), size = 1) + 
      ggtitle(paste( TempNeuronData$type[1], " ", as.character(TempNeuronData$bodyid[1]), " ", MaxLayer, sep="" )) +  theme_bw() +
      guides(colour = guide_legend(override.aes = list(alpha = 1)))
    
    P2=ggarrange(P1, P0, nrow=1, ncol = 2)
    
    ggsave(paste(PlotDir, TempNeuronData$type[1], " ", as.character(TempNeuronData$bodyid[1]), " ", MaxLayer, ".png", sep=""),
             plot = P2, device='png', scale = 1, width = 10, height = 5, units ="in", dpi = 500, limitsize = TRUE)

  }
  
}







```




# Plot the column positions
```{r}


hDelta_ColumnPositions$bodyid=as.factor(hDelta_ColumnPositions$bodyid)


for (ttt in 1:length(hDelta_Types)){

  # Get synapses for just this neuron type
  TempTypeSyns=subset(hDelta_SynsAll, type == hDelta_Types[ttt])
  
  
  if (LayerSubset==TRUE & !hDelta_Types[ttt]=="hDeltaK"){
    # Find layer with most synapses and assume it has axon/dendrites
    TempSynsPerLayer=TempTypeSyns %>% group_by(Layer) %>% summarize(n=n()) ###
    MaxLayer=as.character(TempSynsPerLayer$Layer[which(TempSynsPerLayer$n == max(TempSynsPerLayer$n))]) ###
    eval(parse( text= paste("OUTLINE=Outline_", MaxLayer,"_XZ",sep="") )) ###
    
    # Get just the synapses in that layer
    TempTypeSyns=subset(TempTypeSyns, Layer==MaxLayer) ###
  } else {
    OUTLINE = Outline_FB_XZ
    MaxLayer = "All"
  }
  
  # get color palette
  Colors=paletteer_d("Polychrome::palette36", length(unique(TempTypeSyns$bodyid)))
  
  
  TempColumnPositions=subset(hDelta_ColumnPositions, type == hDelta_Types[ttt] )
  
  P3=ggplot() + geom_point(data=TempColumnPositions, aes(x=X, y=Z, colour=bodyid, shape=prepost),  size=2, alpha = 1) + 
    coord_fixed(ratio = 1) +  geom_path(data=OUTLINE, aes(x=c1, y=c2), size = 1) + 
    ggtitle(paste(TempColumnPositions$type[1], " ", MaxLayer , sep=""))  +  theme_bw() + scale_color_manual(values=Colors)
  
   ggsave(paste(PlotDir, "ColumnLocs_", TempColumnPositions$type[1], ".png", sep=""),
             plot = P3, device='png', scale = 1, width = 10, height = 5, units ="in", dpi = 500, limitsize = TRUE)


}

```











