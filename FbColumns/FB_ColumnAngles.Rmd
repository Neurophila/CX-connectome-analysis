---
title: "Notebook for measuring approximate angles of FB columns"
output:
  html_document:
    df_print: paged
---

### Load libraries
```{r message=FALSE, warning=FALSE}
library(neuprintrExtra)
library(neuprintr)
library(ggraph)
library(stringr)
library(zoo)
library(robustbase)
library(numbers)
library(dplyr)
library(tidyr)
library(tibble)
library(circular)
```

# Make directories where figures will be saved to
```{r}

# Directory where synapse location data is stored (output of FB_GetAndSave_Synapses.Rmd)
SaveDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/"

# Directory to save main plots to
PlotDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/Figure_ColumnAngle/"
if (!dir.exists(PlotDir)){dir.create(PlotDir)}

```

# Connect to neuprint server
```{r}
neuprint_login()
```

# Get general functions
```{r}

source("FB_Analysis_Utils.r")

```

# Load pre-processed synapse location data and remove variables that won't be used
```{r}

load(paste(SaveDir,"FBColumnarSynapses_PostPCA.RData",sep=""))
rm(list=c("roiEigen","Mesh_FB_Points","Mesh_FB_L1_Points", "Mesh_FB_L2_Points","Mesh_FB_L3_Points", "Mesh_FB_L4_Points",
          "Mesh_FB_L5_Points", "Mesh_FB_L6_Points","Mesh_FB_L7_Points", "Mesh_FB_L8_Points", "Mesh_FB_L9_Points","origin"))

# Assign Side, PB glom, and FB col info
FBC_SynsAll=Assign_FBcol_PBglom(FBC_SynsAll, "name", "Side", "PBglom", "FBcol")

```


# Get FB connectivity matrix
```{r message=FALSE, warning=FALSE}

# Get all PB-FB-XX neurons (except PFLs) and parse name to get PB glomeruli and FB column info
FB_Bodies_All=getNeuronsInRoiTable("FB",0)
FB_Bodies_Meta_All=neuprint_get_meta(FB_Bodies_All$bodyid)
PB_FB_Bodies=subset(FB_Bodies_Meta_All, startsWith(type,"PF") & !startsWith(type,"PFL"))
PB_FB_Bodies=Assign_FBcol_PBglom(PB_FB_Bodies, "name", "Side", "PBglom", "FBcol")

# Get FB connectivity table
PB_FB_Bag=neuronBag(PB_FB_Bodies, slctROI="FB")
PB_FB_Outputs_T2T=PB_FB_Bag$outputs
PB_FB_Outputs_N2N=PB_FB_Bag$outputs_raw

# Look at only postsynaptic connections to columnar types
PB_FB_Outputs_T2T= subset(PB_FB_Outputs_T2T,  startsWith(type.to,"PF") | startsWith(type.to,"FC")     | startsWith(type.to,"FR") | 
                                              startsWith(type.to,"FS") | startsWith(type.to,"hDelta") | startsWith(type.to,"vDelta"))
PB_FB_Outputs_N2N= subset(PB_FB_Outputs_N2N,  startsWith(type.to,"PF") | startsWith(type.to,"FC")     | startsWith(type.to,"FR") | 
                                              startsWith(type.to,"FS") | startsWith(type.to,"hDelta") | startsWith(type.to,"vDelta"))

```


# A function for assigning EPG and Delta7 angles to neurons
```{r}

Assign_Angles_ToNeurons <- function(Table_w_NeuronName, To_From){
  if (To_From=="to"){
    Angle_Table=data.frame(PBglom.to=c("L9","L8","L7","L6","L5","L4","L3","L2","L1",
                                       "R1","R2","R3","R4","R5","R6","R7","R8","R9" ),
                           EPG_Angle.to=c(0, 45, 90, 135, 180, 225, 270, 315, 0,
                                          22.5, 67.5, 112.5, 157.5, 202.5, 247.5, 292.5, 337.5, 22.5),
                           D7_Angle.to=c(348.75, 33.75, 78.75, 123.75, 168.75, 213.75, 258.75, 303.75, 348.75,
                                         33.75, 78.75, 123.75, 168.75, 213.75, 258.75, 303.75, 348.75, 33.75))
    Table_w_NeuronName=inner_join(Table_w_NeuronName, Angle_Table, "PBglom.to")
  } else if (To_From=="from"){
    Angle_Table=data.frame(PBglom.from=c("L9","L8","L7","L6","L5","L4","L3","L2","L1",
                                       "R1","R2","R3","R4","R5","R6","R7","R8","R9" ),
                           EPG_Angle.from=c(0, 45, 90, 135, 180, 225, 270, 315, 0,
                                          22.5, 67.5, 112.5, 157.5, 202.5, 247.5, 292.5, 337.5, 22.5),
                           D7_Angle.from=c(348.75, 33.75, 78.75, 123.75, 168.75, 213.75, 258.75, 303.75, 348.75,
                                         33.75, 78.75, 123.75, 168.75, 213.75, 258.75, 303.75, 348.75, 33.75))
    Table_w_NeuronName=inner_join(Table_w_NeuronName, Angle_Table, "PBglom.from")
  }
}


```


# Loop over all postsynaptic neurons and compute their average angular inputs
```{r}

# Get upstream and downstream types
PB_FB_Types=unique(PB_FB_Outputs_T2T$type.from)
Downstream_Types=unique(PB_FB_Outputs_T2T$type.to)

# Get PB glom and FB column names
PB_FB_Outputs_N2N=Assign_FBcol_PBglom(PB_FB_Outputs_N2N, "name.to", "Side.to", "PBglom.to", "FBcol.to")
PB_FB_Outputs_N2N=Assign_FBcol_PBglom(PB_FB_Outputs_N2N, "name.from", "Side.from", "PBglom.from", "FBcol.from")

# Assign angles to PB-FB-XX neurons
PB_FB_Outputs_N2N=Assign_Angles_ToNeurons(PB_FB_Outputs_N2N, "from")


# Loop over all postsynaptic neurons and plot histogram of their angles
Post_Neurons=unique(PB_FB_Outputs_N2N$to)
FB_Neuron_Angles=data.frame(to=numeric(), type.to=character(), name.to=character(), FBcol.to=character(), type.from=character(),
                            EPG_Angle=numeric(), D7_Angle=numeric(), TotalSyns=numeric())
for (nnn in 1:length(Post_Neurons)){
  
  # Get all connections to just this neuron
  TempConnect_All=subset(PB_FB_Outputs_N2N, to == Post_Neurons[nnn])
 
  # Loop over all presynaptic neuron types and compute angle 
  TempPreTypes=unique(TempConnect_All$type.from)
  for (ttt in 1:length(TempPreTypes)){
    
    # Get just this pretype
    TempConnect=subset(TempConnect_All, type.from == TempPreTypes[ttt])
    
    # calculate weighted circular mean for EPG and D7 angles
    EPG_TempAngle = weighted.mean( rad(TempConnect$EPG_Angle.from) , TempConnect$weight) %>% deg()
    D7_TempAngle  = weighted.mean( rad(TempConnect$D7_Angle.from)  , TempConnect$weight) %>% deg()
    TotalSyns_Temp=sum(TempConnect$weight)
    
    # Add data to dataframe
    Temp_DF=TempConnect[c("to","type.to","name.to","FBcol.to")][1,]
    Temp_DF$type.from=TempPreTypes[ttt]
    Temp_DF$EPG_Angle=EPG_TempAngle
    Temp_DF$D7_Angle=D7_TempAngle
    Temp_DF$TotalSyns=TotalSyns_Temp
    FB_Neuron_Angles=rbind(FB_Neuron_Angles,Temp_DF)
  }
}


```



# Plot the data
```{r}

# Need to beware of double striped connection matrices



FB_Neuron_Angles$FBcol.to=factor(FB_Neuron_Angles$FBcol.to, 
                                 levels=c("C0","C1","C2","C3","C4","C5","C6","C7","C8","C9","C10","C11","C12"))
PrePostTypes=distinct(FB_Neuron_Angles[(c("type.from","type.to"))])
for (ttt in 1:length(PrePostTypes)){
  
  # Get just this prepost pair
  TempNeuronAngles=subset(FB_Neuron_Angles, type.to   == PrePostTypes$type.to[ttt] &
                                            type.from == PrePostTypes$type.from[ttt])
  
  
  ggplot() +  geom_point(data=TempNeuronAngles, aes(x=FBcol.to, y=EPG_Angle),size=3, color="black", shape=21) +
     geom_point(data=TempNeuronAngles, aes(x=FBcol.to, y=D7_Angle),size=3, color="red", shape=21) +
    ylim(0,360)
  
  
}


# Look at just the FX, which all have 9 columns
FX_Data=subset(FB_Neuron_Angles, startsWith(type.to, "F"))
ggplot() +  geom_point(data=FX_Data, aes(x=FBcol.to, y=EPG_Angle),size=3, color="black", shape=21) +
  geom_point(data=FX_Data, aes(x=FBcol.to, y=D7_Angle),size=3, color="red", shape=21) + 
  scale_y_continuous(breaks=c(0, 45, 90, 135, 180, 225, 270, 315, 360))


# Look at just the vDeltas, which all have 9 columns
vDelta_Data=subset(FB_Neuron_Angles, startsWith(type.to, "vDelta"))
ggplot() +  geom_point(data=vDelta_Data, aes(x=FBcol.to, y=EPG_Angle),size=3, color="black", shape=21) +
  geom_point(data=FX_Data, aes(x=FBcol.to, y=D7_Angle),size=3, color="red", shape=21) + 
  scale_y_continuous(breaks=c(0, 45, 90, 135, 180, 225, 270, 315, 360))



# What's going on here? Why do D7 angles have 8 peaks and EPG angles have twice that?
# Probably because EPG angles actually have double the unique values. 
hist(FB_Neuron_Angles$EPG_Angle,200)
hist(FB_Neuron_Angles$D7_Angle,200)


```















