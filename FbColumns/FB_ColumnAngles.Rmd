---
title: "Notebook for measuring approximate angles of FB columns and PB-FB phase shifts"
output:
  html_document:
    df_print: paged
---

### Load libraries
```{r message=FALSE, warning=FALSE}
library(neuprintrExtra)
library(neuprintr)
library(ggraph)
library(stringr)
library(zoo)
library(robustbase)
library(numbers)
library(dplyr)
library(tidyr)
library(tibble)
library(circular)
library(ggbeeswarm)
library(paletteer)
library(scales)
```

# Make directories where figures will be saved to
```{r}

# Directory where synapse location data is stored (output of FB_GetAndSave_Synapses.Rmd)
SaveDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/"

# Directory to save main plots to
PlotDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/Figure_ColumnAngle/"
if (!dir.exists(PlotDir)){dir.create(PlotDir)}

```

# Connect to neuprint server
```{r}
neuprint_login()
```

# Get general functions
```{r}

source("FB_Analysis_Utils.r")

```

# Load pre-processed column location data (output of FB_ColumnLocations.Rmd)
```{r}

load(paste(SaveDir,"FB_ColumnPositions.RData",sep=""))

```


# Get FB connectivity matrix
```{r message=FALSE, warning=FALSE}

# Get all PB-FB-XX neurons (except PFLs) and parse name to get PB glomeruli and FB column info
FB_Bodies_All=getNeuronsInRoiTable("FB",0)
FB_Bodies_Meta_All=neuprint_get_meta(FB_Bodies_All$bodyid)
PB_FB_Bodies=subset(FB_Bodies_Meta_All, startsWith(type,"PF") & !startsWith(type,"PFL"))
PB_FB_Bodies=Assign_FBcol_PBglom(PB_FB_Bodies, "name", "Side", "PBglom", "FBcol")

# Get FB connectivity table
PB_FB_Bag=neuronBag(PB_FB_Bodies, slctROI="FB")
PB_FB_Outputs_T2T=PB_FB_Bag$outputs
PB_FB_Outputs_N2N=PB_FB_Bag$outputs_raw

# Look at only postsynaptic connections to columnar types (Excluding other PB-FB-XX types)
PB_FB_Outputs_T2T= subset(PB_FB_Outputs_T2T,  startsWith(type.to,"FC")     | startsWith(type.to,"FR") | 
                                              startsWith(type.to,"FS")     | startsWith(type.to,"hDelta") | startsWith(type.to,"vDelta"))
PB_FB_Outputs_N2N= subset(PB_FB_Outputs_N2N,  startsWith(type.to,"FC")     | startsWith(type.to,"FR") | 
                                              startsWith(type.to,"FS")     | startsWith(type.to,"hDelta") | startsWith(type.to,"vDelta"))

```


# Define some functions called in the analyses below
```{r}

# Function for assigning EPG and Delta7 angles to neurons
Assign_Angles_ToNeurons <- function(Table_w_NeuronName){
  Angle_Table=data.frame(PBglom.from=c("L9","L8","L7","L6","L5","L4","L3","L2","L1",
                                       "R1","R2","R3","R4","R5","R6","R7","R8","R9" ),
                         EPG_Angle.from=c(0, 45, 90, 135, 180, 225, 270, 315, 0,
                                          22.5, 67.5, 112.5, 157.5, 202.5, 247.5, 292.5, 337.5, 22.5),
                         D7_Angle.from=c(348.75, 33.75, 78.75, 123.75, 168.75, 213.75, 258.75, 303.75, 348.75,
                                         33.75, 78.75, 123.75, 168.75, 213.75, 258.75, 303.75, 348.75, 33.75))
  Table_w_NeuronName=inner_join(Table_w_NeuronName, Angle_Table, "PBglom.from")
}


# Function for creating a distribution of angles according to the # of synapses at each angle
GetAllAngles <- function(TempConnectFun){
  if (nrow(TempConnectFun>0)){
    AllAngles=c()
    for (rrr in 1:nrow(TempConnectFun)){
      AllAngles=c(AllAngles, rep(TempConnectFun$EPG_Angle.from[rrr], TempConnectFun$ROIweight[rrr]) ) 
    }
  } else {
    AllAngles=NaN
  }
  return(AllAngles)
}


```


# Loop over all postsynaptic neurons and compute their average angular inputs. 
# Take the average over all presynaptic neurons provides an estimate of the postsynaptic neuron's mean phase.
# Taking the average over left and right PB-FB-XX inputs separately will allow us to estimate phase shifts.
```{r message=FALSE, warning=FALSE}

# Get PB glom and FB column names
PB_FB_Outputs_N2N=Assign_FBcol_PBglom(PB_FB_Outputs_N2N, "name.to", "Side.to", "PBglom.to", "FBcol.to")
PB_FB_Outputs_N2N=Assign_FBcol_PBglom(PB_FB_Outputs_N2N, "name.from", "Side.from", "PBglom.from", "FBcol.from")

# Assign angles to PB-FB-XX neurons
PB_FB_Outputs_N2N=Assign_Angles_ToNeurons(PB_FB_Outputs_N2N)

# Loop over all postsynaptic neurons and compute phase estimates
Post_Neurons=unique(PB_FB_Outputs_N2N$to)
FB_Neuron_Angles=data.frame(to=numeric(), type.to=character(), name.to=character(), FBcol.to=character(), type.from=character(),
                            EPG_Angle=numeric(), EPG_Angle_rho=numeric(), TotalSyns=numeric(),
                            EPG_Angle_L=numeric(), EPG_Angle_L_rho=numeric(), EPG_Angle_R=numeric(), EPG_Angle_R_rho=numeric(),
                            InputGlomNum=numeric(), UniqueAngle=numeric())
for (nnn in 1:length(Post_Neurons)){
  
  # Get all connections to just this neuron
  TempConnect_All=subset(PB_FB_Outputs_N2N, to == Post_Neurons[nnn])
 
  # Loop over all presynaptic neuron types and compute angle 
  TempPreTypes=unique(TempConnect_All$type.from)
  for (ttt in 1:length(TempPreTypes)){
    
    # Get just this pretype
    TempConnect=subset(TempConnect_All, type.from == TempPreTypes[ttt])
    
    # Create a temporary dataframe to store the angle data
    Temp_DF=TempConnect[c("to","type.to","name.to","FBcol.to")][1,]
    Temp_DF$type.from=TempPreTypes[ttt]
    
    # Calculate weighted circular mean of EPG angles, from left and right populations together
    TempAngles_All = GetAllAngles(TempConnect)
    Temp_DF$EPG_Angle = circular::mean.circular(rad(TempAngles_All)) %>% deg()
    Temp_DF$EPG_Angle_rho  = circular::rho.circular(rad(TempAngles_All))
    Temp_DF$TotalSyns = sum(TempConnect$weight)
    
    # Calculate weighted circular mean of EPG angles for the left and right populations separate
    TempConnect_L = subset(TempConnect, Side.from=="L")
    TempAngles_L = GetAllAngles(TempConnect_L)
    Temp_DF$EPG_Angle_L = circular::mean.circular(rad(TempAngles_L)) %>% deg()
    Temp_DF$EPG_Angle_L_rho = circular::rho.circular(rad(TempAngles_L))
    
    TempConnect_R = subset(TempConnect, Side.from=="R")
    TempAngles_R = GetAllAngles(TempConnect_R)
    Temp_DF$EPG_Angle_R = circular::mean.circular(rad(TempAngles_R)) %>% deg()
    Temp_DF$EPG_Angle_R_rho = circular::rho.circular(rad(TempAngles_R))
    
    # Calculate the number of unique input glomeruli (i.e. angles)
    Temp_DF$InputGlomNum=length(unique(TempConnect$PBglom.from))
    Temp_DF$UniqueAngle=length(unique(TempAngles_All))
    
    # Add data to dataframe
    FB_Neuron_Angles=rbind(FB_Neuron_Angles,Temp_DF)
  }
}

remove(Temp_DF, TempConnect, TempConnect_All, TempConnect_L, TempConnect_R)
```


# Adjust angles so they are within the 0 to 360 degrees range
```{r}

FB_Neuron_Angles$EPG_Angle=(FB_Neuron_Angles$EPG_Angle + 360) %% 360 %>% as.numeric()
FB_Neuron_Angles$EPG_Angle_L=(FB_Neuron_Angles$EPG_Angle_L + 360) %% 360 %>% as.numeric()
FB_Neuron_Angles$EPG_Angle_R=(FB_Neuron_Angles$EPG_Angle_R + 360) %% 360 %>% as.numeric()

```


# Decide on which connections to use to estimate phase
# Need to exclude connections to hDeltas that receive input on their axon and dendritic compartments
# Should also exclude connections that are inconsistent (i.e. where a low % of pre-post neurons have connections)
```{r message=FALSE, warning=FALSE}

# Get the significant type-to-type connections
PrePostTypes_T2T=distinct(PB_FB_Outputs_T2T[(c("type.from","type.to"))])

# List of types where PB-FB-XX type synapses onto both axon and dendrites of hDelta type, which could corrupt phase estimates,
# since a postsynaptic neuron will receive input from 4 regions of the PB whose angles will tend to cancel out.
hDelta_Exclude=data.frame(type.from=c("PFNd","PFGs","PFR_a","PFR_a","PFR_a","PFR_a",
                                      "PFR_a","PFR_a","PFR_a","PFR_a","PFR_b","PFR_b","PFR_b"),
                          type.to=  c("hDeltaB","hDeltaC","hDeltaA","hDeltaB","hDeltaC","hDeltaG",
                                      "hDeltaH","hDeltaI","hDeltaJ","hDeltaM","hDeltaG","hDeltaH","hDeltaA"))
          
# Exclude these double-banded hDelta connections
PrePostTypes=anti_join(PrePostTypes_T2T, hDelta_Exclude, by=c("type.from","type.to"))

# Calculate how many columns are involved and exclude any connection with less than 8 columns
ColumnNums=PB_FB_Outputs_N2N %>% group_by(type.from,type.to) %>% summarise(PreColNum=length(unique(FBcol.from)))
ColumnNums=subset(ColumnNums, PreColNum<=7)

# Remove inconsistent connections
PrePostTypes=anti_join(PrePostTypes, ColumnNums, by=c("type.from","type.to"))

# Loop over and plot N2N connection matrices to make sure no double-banded matrices remain
PB_FB_Outputs_N2N$FBcol.from=factor(PB_FB_Outputs_N2N$FBcol.from, levels=c("C0","C1","C2","C3","C4","C5","C6","C7","C8","C9","C10","C11","C12"))
PB_FB_Outputs_N2N$FBcol.to=factor(PB_FB_Outputs_N2N$FBcol.to, levels=c("C0","C1","C2","C3","C4","C5","C6","C7","C8","C9","C10","C11","C12"))
for (ttt in 1:length(PrePostTypes$type.from)){
  Temp_Connect=subset(PB_FB_Outputs_N2N, type.from == PrePostTypes$type.from[ttt] & type.to == PrePostTypes$type.to[ttt])
  if (nrow(Temp_Connect)>0){ # Some T2T connections have neurons with no assigned glomeruli (needed for angle), so skip.
  Pa=ggplot(Temp_Connect) + 
    theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
    scale_fill_gradient2(low="gray30", high="black", 
                         limits=c(0,max(Temp_Connect$ROIweight)), oob=squish)  +
    geom_tile(aes(name.to,name.from,fill=ROIweight)) + ylab(PrePostTypes$type.from[ttt]) + xlab(PrePostTypes$type.to[ttt]) +
    facet_grid(rows=vars(FBcol.from), cols=vars(FBcol.to), scales="free")
  ggsave(paste(PlotDir, "ConnectMat_",  as.character(ttt),"_", PrePostTypes$type.from[ttt], "_2_", PrePostTypes$type.to[ttt], ".png", sep=""),
       plot = Pa, device='png', scale = 1, width = 7, height = 5, units ="in", dpi = 200, limitsize = TRUE)
  }
}

```



# Analyze the PB-FB phase shifts for each PB-FB-XX neuron type
```{r message=FALSE, warning=FALSE}

# Why do PFNp_a, d, e have so few output synapses?
# Is phase shift consistent across columns?
# Need to set criteria on # of posynaptic neurons somewhere else
# Plot mean phase shift of neurons with more than 2 glom input?


# Get just those neurons that reeive input from left and right populations, are part of a significant T2T connections
# without axon+dendrite input to hDeltas, and are not C0 vDelta neurons.  
PhaseShiftData=inner_join(FB_Neuron_Angles, PrePostTypes, by=c("type.from","type.to"))
PhaseShiftData=subset(PhaseShiftData, !(is.na(EPG_Angle_L) | is.na(EPG_Angle_R)) & !FBcol.to=="C0")

# Compute difference in phases from right-left
PhaseShiftData$EPG_Angle_Diff=((PhaseShiftData$EPG_Angle_R-PhaseShiftData$EPG_Angle_L)+360) %% 360 %>% as.numeric()

# Set order of neuron types for plotting
NeuronTypeOrder=c("PFGs","PFR_a","PFNa","PFNd","PFNv","PFNm_a","PFNm_b","PFNp_a","PFNp_b","PFNp_c","PFNp_d","PFNp_e","PFR_b")

# Average across postsynaptic types
PhaseShiftData_Type=PhaseShiftData %>% group_by(type.from,type.to) %>% 
                    summarize(EPG_Angle_Diff=(deg(mean.circular(rad(EPG_Angle_Diff))) + 360) %% 360,
                              NeuronNum=length(unique(to)))
PhaseShiftData_Type=subset(PhaseShiftData_Type, NeuronNum>=5) # this should be done somewhere else
PhaseShiftData_Type$type.from=factor(PhaseShiftData_Type$type.from, levels=NeuronTypeOrder)

# Get supertype color pallete and assign colors 
Colorz=supertype2Palette()
FBPal=c(Colorz[["pal"]]["vDelta"], Colorz[["pal"]]["hDelta"], Colorz[["pal"]]["FR"], Colorz[["pal"]]["FS"], Colorz[["pal"]]["FC"])
PhaseShiftData_Type$Colorz=NA
PhaseShiftData_Type$Colorz[startsWith(as.character(PhaseShiftData_Type$type.to),"vDelta")]="vDelta"
PhaseShiftData_Type$Colorz[startsWith(as.character(PhaseShiftData_Type$type.to),"hDelta")]="hDelta"
PhaseShiftData_Type$Colorz[startsWith(as.character(PhaseShiftData_Type$type.to),"FR")]="FR"
PhaseShiftData_Type$Colorz[startsWith(as.character(PhaseShiftData_Type$type.to),"FS")]="FS"
PhaseShiftData_Type$Colorz[startsWith(as.character(PhaseShiftData_Type$type.to),"FC")]="FC"
PhaseShiftData_Type$Colorz=factor(PhaseShiftData_Type$Colorz,levels=c("vDelta", "hDelta", "FR", "FS", "FC"))

# Compute the mean difference for each PB-FB-XX type
PhaseShift_TypeMean=PhaseShiftData %>% group_by(type.from) %>% 
                    summarise(EPG_Angle_Diff_Mean=as.numeric(deg(mean.circular(rad(EPG_Angle_Diff))))) 
PhaseShift_TypeMean$EPG_Angle_Diff_Mean=(PhaseShift_TypeMean$EPG_Angle_Diff_Mean+360) %% 360 %>% as.numeric()
PhaseShift_TypeMean=subset(PhaseShift_TypeMean, !type.from=="PFR_b")


# Plot average R-L phase shift
P1=ggplot() +  
  geom_hline(yintercept=0, linetype="dashed", color = "gray50") +
  geom_hline(yintercept=90, linetype="dashed", color = "gray50") + 
  geom_hline(yintercept=180, linetype="dashed", color = "gray50") + 
  geom_hline(yintercept=270, linetype="dashed", color = "gray50") +
  geom_hline(yintercept=360, linetype="dashed", color = "gray50") +
  geom_beeswarm(data=PhaseShiftData_Type, aes(x=type.from, y=EPG_Angle_Diff, size=NeuronNum, color=Colorz), shape=21) +
  scale_y_continuous(breaks=c(0, 45, 90, 135, 180, 225, 270, 315, 360), limits=c(0, 360)) + theme_classic() +
  geom_line(data=PhaseShift_TypeMean, aes(x=type.from, y=EPG_Angle_Diff_Mean, group=1), color="black") +
  xlab("Pre-synaptic PFN type") + ylab("PB-FB Phase shift (deg)") + theme(axis.text.x = element_text(angle = 90)) +
  scale_color_manual(values=FBPal) + scale_size_continuous(range = c(1,4))
ggsave(paste(PlotDir, "PB_FB_PhaseShift_Type", ".png", sep=""),
       plot = P1, device='png', scale = 1, width = 7, height = 5, units ="in", dpi = 500, limitsize = TRUE)
P1


```


# Plot hisogram of phase shifts to explore how the 90 degree shift arrises from peaks at 67.5 & 112.5 degrees
```{r}

library(ggpubr)


PFN_PhaseShiftData=subset(PhaseShiftData, startsWith(type.from, "PFN"))
PFN_PhaseShiftData$InputGlomNum=factor(PFN_PhaseShiftData$InputGlomNum, levels=seq(from=2, to=3))
Ps=ggplot(PFN_PhaseShiftData, aes(x=EPG_Angle_Diff, group = InputGlomNum, color=InputGlomNum)) + 
   geom_freqpoly(binwidth = 2) + theme_classic() + xlab("PB-FB Phase Shift (deg)") +
   ylab("# of neurons")
Pt=ggplot(PFN_PhaseShiftData, aes(x=EPG_Angle_Diff, after_stat(density), group = InputGlomNum, color=InputGlomNum)) + 
   geom_freqpoly(binwidth = 2) + theme_classic() + xlab("PB-FB Phase Shift (deg)") +
  ylab("probability")
Pu=ggarrange(Ps,Pt,ncol=2)
Pu
ggsave(paste(PlotDir, "PhaseShift_by_AngleNume", ".png", sep=""),
       plot = Pu, device='png', scale = 1, width = 10, height = 3, units ="in", dpi = 500, limitsize = TRUE)


```



# Show the correlation between each neuron's medial-lateral position and its directional tuning
```{r}

## Should add mean resultant vector length and dot size to these plots
## Should I only be using neurons that receive L and R input, as above?
## I don't think the angles in the FB correspond to those expexcted from PB-FB projections? Averaging problem?

# Get each neuron's average columnar position in the layer with the most synapses
PositionInfo=ColumnPositions_All[c("bodyid","type" ,"X","Y","Z","Layer","prepost","numsyns", "FBcol")] 

# Get rid of C0 vDelta(s), which don't have a single position, as well as hDelta output locations
PositionInfo=subset(PositionInfo, !FBcol=="C0" & prepost %in% c("Neither", "Input"))

# Except for hDeltaK, get rid of FB layer
PositionInfo=subset(PositionInfo, !(Layer=="FB") | (Layer=="FB" & type=="hDeltaK")) 

# Find layer with maximum number of synapses 
MaxLayers=PositionInfo %>% group_by(type, Layer) %>% summarise(TotSyns=sum(numsyns)) %>% filter(TotSyns==max(TotSyns))
PositionInfo=inner_join(PositionInfo, MaxLayers, by=c("type","Layer")) 

# Combine position and tuning information
colnames(PositionInfo)[colnames(PositionInfo)=="bodyid"]="to"
PositionInfo$to=as.character(PositionInfo$to)
PhaseShiftData$to=as.character(PhaseShiftData$to)
Position_And_Tuning=inner_join(PhaseShiftData, PositionInfo, by=c("to"))

# For each neuron type and layer, compute the min and max medial-lateral position
Position_Norm=Position_And_Tuning %>% group_by(type.to, type.from, Layer) %>% summarize(Min_X=min(X), Max_X=max(X))
Position_Norm$Total_X=Position_Norm$Max_X-Position_Norm$Min_X
Position_And_Tuning=left_join(Position_And_Tuning, Position_Norm, by=c("type.from","type.to","Layer"))
Position_And_Tuning$X_Norm=(Position_And_Tuning$X - Position_And_Tuning$Min_X)/Position_And_Tuning$Total_X

# Make presynaptic type a factor
Position_And_Tuning$PresynapticClass =NA
Position_And_Tuning$PresynapticClass [startsWith(as.character(Position_And_Tuning$type.from),"PFGs")]="PFGs"
Position_And_Tuning$PresynapticClass [startsWith(as.character(Position_And_Tuning$type.from),"PFNa")]="PFNa"
Position_And_Tuning$PresynapticClass [startsWith(as.character(Position_And_Tuning$type.from),"PFNd")]="PFNd"
Position_And_Tuning$PresynapticClass [startsWith(as.character(Position_And_Tuning$type.from),"PFNm")]="PFNm (a/b)"
Position_And_Tuning$PresynapticClass [startsWith(as.character(Position_And_Tuning$type.from),"PFNp")]="PFNp (a/b/c/d/e)"
Position_And_Tuning$PresynapticClass [startsWith(as.character(Position_And_Tuning$type.from),"PFNv")]="PFNv"
Position_And_Tuning$PresynapticClass [startsWith(as.character(Position_And_Tuning$type.from),"PFR")]="PFR (a/b)"


ScatterColors <- paletteer_d("Polychrome::palette36")
ScatterColors = ScatterColors[c(5,17,8,6,11,33,1)]

# Plot all data from all FX neurons
Temp_Pos_And_Tune=subset(Position_And_Tuning, startsWith(type.to, "F"))
AX=ceiling(max(abs(Temp_Pos_And_Tune$X))*8/1000/10)*10
Px=ggplot() + 
  geom_point(data=Temp_Pos_And_Tune, aes(x=X*8/1000, y=EPG_Angle, color=PresynapticClass))  +
  xlab("medial-lateral position (um)") + ylab("EPG phase (deg)") +  theme_classic() +
  scale_y_continuous(breaks=c(0, 45, 90, 135, 180, 225, 270, 315, 360), limits=c(0, 360)) +
  scale_x_continuous(breaks=seq(from=-AX, to=AX, by=30), limits=c(-AX, AX)) +
  ggtitle("All FX neurons") +
  scale_color_manual(values=ScatterColors, drop=FALSE) +
  theme(text = element_text(size=16), 
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"))
Px
ggsave(paste(PlotDir, "FX_MeanPhase", ".png", sep=""),
       plot = Px, device='png', scale = 1, width = 8, height = 5, units ="in", dpi = 500, limitsize = TRUE)


Px=ggplot() + 
  geom_point(data=Temp_Pos_And_Tune, aes(x=X_Norm, y=EPG_Angle, color=PresynapticClass))  +
  xlab("medial-lateral position (au)") + ylab("EPG phase (deg)") +  theme_classic() +
  scale_y_continuous(breaks=c(0, 45, 90, 135, 180, 225, 270, 315, 360), limits=c(0, 360)) +
  scale_x_continuous(breaks=seq(from=0, to=1, by=0.25), limits=c(0, 1)) +
  ggtitle("All FX neurons") +
  scale_color_manual(values=ScatterColors, drop=FALSE) +
  theme(text = element_text(size=16), 
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"))
Px
ggsave(paste(PlotDir, "FX_MeanPhaseNorm", ".png", sep=""),
       plot = Px, device='png', scale = 1, width = 8, height = 5, units ="in", dpi = 500, limitsize = TRUE)


Temp_Pos_And_Tune=subset(Position_And_Tuning, startsWith(type.to, "vDe"))
Px=ggplot() + 
  geom_point(data=Temp_Pos_And_Tune, aes(x=X_Norm, y=EPG_Angle, color=PresynapticClass))  +
  xlab("medial-lateral position (au)") + ylab("EPG phase (deg)") +  theme_classic() +
  scale_y_continuous(breaks=c(0, 45, 90, 135, 180, 225, 270, 315, 360), limits=c(0, 360)) +
  scale_x_continuous(breaks=seq(from=0, to=1, by=0.25), limits=c(0, 1)) +
  ggtitle("All vDelta neurons") +
  scale_color_manual(values=ScatterColors, drop=FALSE) +
  theme(text = element_text(size=16), 
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"))
Px
ggsave(paste(PlotDir, "vDelta_MeanPhase", ".png", sep=""),
       plot = Px, device='png', scale = 1, width = 8, height = 5, units ="in", dpi = 500, limitsize = TRUE)




```















