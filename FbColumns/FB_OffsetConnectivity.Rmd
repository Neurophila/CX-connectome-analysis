---
title: "Notebook plotting offsets in connectivity between PB-FB-XX neurons and other columnar neurons"
output:
  html_document:
    df_print: paged
---

### Command to clear environment is: rm(list = ls(all.names = TRUE))
### Command to update is remotes::update_packages('neuprintr')
### Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
library(matlib)
library(RColorBrewer)
library(ggraph)
library(robustbase)
require(alphahull)
library(zoo)
library(ggpubr)
library(ggraph)
library(igraph)
library(tidygraph)
library(xlsx)
library(dtplyr)
options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose ROI and save/plot directories
```{r}

# Directory to save data to.
SaveDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/"

# Directory to save plots to.
PlotDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/OffsetConnectivity/"

# Create save/plot directory if they dont exists yet
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}

# Other plotting directories
PFX_Dir=paste(PlotDir,"PFX_Plots_All","/",sep="")
PFX_Dir_Connectivity=paste(PFX_Dir,"PFX_ConnectivityOffsets","/",sep="")
PFX_Dir_Lat=paste(PFX_Dir,"PFX_Left_VS_Right","/",sep="")
PFX_Dir_PI=paste(PFX_Dir,"PFX_PI","/",sep="")
if (!dir.exists(PFX_Dir)){dir.create(PFX_Dir)}
if (!dir.exists(PFX_Dir_Connectivity)){dir.create(PFX_Dir_Connectivity)}
if (!dir.exists(PFX_Dir_Lat)){dir.create(PFX_Dir_Lat)}
if (!dir.exists(PFX_Dir_PI)){dir.create(PFX_Dir_PI)}

```

### Connect to neuprint server.
```{r}
neuprint_login()
```

### Get general functions
```{r}

source("FB_SynapseDistribution_Utils.r")
source("FB_LayerOutline_Utils.r")
source("FB_ConnectivityOffsetPlotting_Utils.r")
source("../InputOutputByTypeUtils.r", chdir = TRUE)
source("../neuprintQueryUtils.r", chdir = TRUE)
source("../visualizeConnectivityTables.r", chdir = TRUE)
source("../inputOutputRegionsVis.r")
source("../GetNeuronsInRoi.r")
library("xlsx")

```



# Get all FB bodies and columnar types
```{r}

NamedBodies = Get_AllNeurons_InRoi("FB", FALSE)
NamedBodies=ComputeRelativeSynapseCounts(NamedBodies)
Columnar_Types=sort(unique( NamedBodies$bodytype[ startsWith(NamedBodies$bodytype, "PF" ) | startsWith(NamedBodies$bodytype, "FR" ) | 
               startsWith(NamedBodies$bodytype, "FS" ) | startsWith(NamedBodies$bodytype, "FC" ) | startsWith(NamedBodies$bodytype, "Delta" )] ))

```


# Load pre-processed synapse location data and remove variables that won't be used
# NOTE: Need to rebuild this periodically in case types/names get changed
```{r}

load(paste(SaveDir,"FBColumnarSynapses_PostPCA.RData",sep=""))
rm(list=c("roiEigen","Mesh_FB_Points","Mesh_FB_L1_Points", "Mesh_FB_L2_Points","Mesh_FB_L3_Points", "Mesh_FB_L4_Points",
          "Mesh_FB_L5_Points", "Mesh_FB_L6_Points","Mesh_FB_L7_Points", "Mesh_FB_L8_Points", "Mesh_FB_L9_Points","origin"))

# Assign Side, PB glom, and FB col info
FBC_SynsAll=Assign_FBcol_PBglom(FBC_SynsAll, "bodyname", "Side", "PBglom", "FBcol", "bodyid")


```



# Plot connectivity of PB-FB-XX neurons to check for offsets predicted from PB glom to FB col mappings
```{r}


# Get input and output tables
PFX_Types=unique( FBC_SynsAll$type[startsWith(FBC_SynsAll$type, "PF" )] )
PFX_Bag=buildInputsOutputsByType(PFX_Types, slctROI="FB")
PFX_FB_Outputs_All=PFX_Bag[["outputs_raw"]]
PFX_FB_Inputs_All=PFX_Bag[["inputs_raw"]]


# Subset data on columnar types
PFX_FB_Outputs_All=subset(PFX_FB_Outputs_All, databaseType.to %in% Columnar_Types)
PFX_FB_Inputs_All=subset(PFX_FB_Inputs_All, databaseType.from %in% Columnar_Types)


# Assign PBglom, FBcol, and Side from neuron names
PFX_FB_Outputs_All=Assign_FBcol_PBglom(PFX_FB_Outputs_All, "name.from", "Side.from", "PBglom.from", "FBcol.from", "from")
PFX_FB_Outputs_All=Assign_FBcol_PBglom(PFX_FB_Outputs_All, "name.to", "Side.to", "PBglom.to", "FBcol.to", "to")
PFX_FB_Inputs_All=Assign_FBcol_PBglom(PFX_FB_Inputs_All, "name.from", "Side.from", "PBglom.from", "FBcol.from", "from")
PFX_FB_Inputs_All=Assign_FBcol_PBglom(PFX_FB_Inputs_All, "name.to", "Side.to", "PBglom.to", "FBcol.to", "to")


# Order input table
PFX_FB_Inputs_All$PBglom.to=factor(PFX_FB_Inputs_All$PBglom.to, levels = rev(c("R9","L1","R8","L2","R7","L3","R6","L4","R5","L5","R4","L6","R3","L7","R2","L8","R1","L9")))
PFX_FB_Inputs_All$FBcol.from=factor(PFX_FB_Inputs_All$FBcol.from, levels = rev(c("C9","C8","C7","C6","C5","C4","C3","C2","C1","C0",
                                                                         "DC14","DC13","DC12","DC11","DC10","DC09","DC08","DC07","DC06","DC05","DC04","DC03","DC02","DC01")))
PFX_FB_Inputs_All$name.from=factor(PFX_FB_Inputs_All$name.from, levels = unique((PFX_FB_Inputs_All$name.from)[order(PFX_FB_Inputs_All$FBcol.from)]) )
PFX_FB_Inputs_All$name.to=factor(PFX_FB_Inputs_All$name.to, levels = unique((PFX_FB_Inputs_All$name.to)[order(PFX_FB_Inputs_All$FBcol.to)]) )


# Order ouput table
PFX_FB_Outputs_All$PBglom.from=factor(PFX_FB_Outputs_All$PBglom.from, levels = rev(c("R9","L1","R8","L2","R7","L3","R6","L4","R5","L5","R4","L6","R3","L7","R2","L8","R1","L9")))
PFX_FB_Outputs_All$FBcol.to=factor(PFX_FB_Outputs_All$FBcol.to, levels = rev(c("C9","C8","C7","C6","C5","C4","C3","C2","C1","C0",
                                                                         "DC14","DC13","DC12","DC11","DC10","DC09","DC08","DC07","DC06","DC05","DC04","DC03","DC02","DC01")))
PFX_FB_Outputs_All$name.to=factor(PFX_FB_Outputs_All$name.to, levels = unique((PFX_FB_Outputs_All$name.to)[order(PFX_FB_Outputs_All$FBcol.to)]) )
PFX_FB_Outputs_All$name.from=factor(PFX_FB_Outputs_All$name.from, levels = unique((PFX_FB_Outputs_All$name.from)[order(PFX_FB_Outputs_All$FBcol.from)]) )


# Plot connectivity matrices with PBgloms and FBcols arranged to show mapping
Plot_Connectivity_Mappings(PFX_Types, PFX_FB_Outputs_All, PFX_FB_Inputs_All, PFX_Dir_Connectivity)


```



# Look for lateralized output patterns, where PB-FB-XX neurons of a single neuron type
# target distinct downstream neurons depending on  whether the PB-FB-XX neurons come 
# from the right bridge or left bridge.
```{r}



# Get unique pre-post pairs
Pre_Post=distinct(PFX_FB_Outputs_All[c("type.from","type.to")])


# Make to/from names
PFX_FB_Outputs_All$from_name = paste(PFX_FB_Outputs_All$PBglom.from, PFX_FB_Outputs_All$from, sep="__")
PFX_FB_Outputs_All$to_name   = paste(PFX_FB_Outputs_All$FBcol.to, PFX_FB_Outputs_All$to, sep="__")

# Compute percent input from left and right PB types
Scatter = PFX_FB_Outputs_All %>% group_by(to, Side.from, type.from, type.to) %>% summarise(weightRelative= sum(weightRelative))
Scatter_L=subset(Scatter, Side.from=="L")
colnames(Scatter_L)[colnames(Scatter_L) == "weightRelative"]="weightRelative_L"
Scatter_R=subset(Scatter, Side.from=="R")
colnames(Scatter_R)[colnames(Scatter_R) == "weightRelative"]="weightRelative_R"
Scatter_All=full_join(Scatter_L, Scatter_R, by="to")
Scatter_All$weightRelative_L[is.na(Scatter_All$weightRelative_L)]=0
Scatter_All$weightRelative_R[is.na(Scatter_All$weightRelative_R)]=0
rm(list=c("Scatter","Scatter_L","Scatter_R"))



Scatter_Zeros=subset(Scatter_All, weightRelative_L)

ggplot() + geom_point(data=Scatter_All, aes(x=weightRelative_L, y=weightRelative_R))
hist(Scatter_All$weightRelative_L-Scatter_All$weightRelative_R,100) +ylim(c(0,200))


for (ppp in 1:length(Pre_Post$type.from)){
  print(ppp)
  
  # Subset data and name neurons by column/glom and bodyid
  Temp_PFX_Out=subset(PFX_FB_Outputs_All, type.from == Pre_Post$type.from[ppp] & type.to == Pre_Post$type.to[ppp] & weightRelative >0.005)

  
  # Calculate number of pre and post neurons
  PreNum=length(unique(Temp_PFX_Out$PBglom.from))
  PostNum=length(unique(Temp_PFX_Out$FBcol.from))
  
  Scatter = Temp_PFX_Out %>% group_by(to, Side.from) %>% summarise(weightRelative= sum(weightRelative))
  Scatter_L=subset(Scatter, Side.from=="L")
  colnames(Scatter_L)[colnames(Scatter_L) == "weightRelative"]="weightRelative_L"
  Scatter_R=subset(Scatter, Side.from=="R")
  colnames(Scatter_R)[colnames(Scatter_R) == "weightRelative"]="weightRelative_R"
  Scatter=full_join(Scatter_L, Scatter_R, by="to")
  Scatter$weightRelative_L[is.na(Scatter$weightRelative_L)]=0
  Scatter$weightRelative_R[is.na(Scatter$weightRelative_R)]=0
  

  if (PreNum > 4 & PostNum > 7){
    
    if (Temp_PFX_Out$type.from[1] == Temp_PFX_Out$type.to[1]){
      Prefix="Recurrent"
    } else {
      Prefix=""
    }
    
    P1 <- ggplot(Temp_PFX_Out) + 
      theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
      scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", 
                           midpoint =0.5*max(Temp_PFX_Out$weightRelative), limits=c(0,max(Temp_PFX_Out$weightRelative))) +
      geom_tile(aes(to_name,from_name,fill=weightRelative)) +
      facet_grid(rows = vars(Side.from), scales="free_y") +
      ggtitle(paste(Temp_PFX_Out$type.from[1]," to ",Temp_PFX_Out$type.to[1],sep=""))
    
    
    
    P2=ggplot() + geom_point(data=Scatter, aes(x=weightRelative_L, y=weightRelative_R)) +
      ggtitle(paste(Temp_PFX_Out$type.from[1]," to ",Temp_PFX_Out$type.to[1],sep=""))
    
    P3=ggarrange(P1,P2,nrow=1, ncol=2)
    
    ggsave(paste(PFX_Dir_Lat, Prefix, Temp_PFX_Out$type.from[1],"_to_",Temp_PFX_Out$type.to[1], "_inFB.png",sep=""),
           plot = P3, device='png', scale = 1, width =15, height = 5, units ="in", dpi = 500, limitsize = TRUE)
    
  }
}




# Plot PFNd to PFNd connectivity
Temp_PFX_Out=subset(PFX_FB_Outputs_All, type.from == "PFNd" & type.to == "PFNd" & weightRelative >0.005)
Temp_PFX_Out$from_name = paste(Temp_PFX_Out$PBglom.from, Temp_PFX_Out$from, sep="__")
Temp_PFX_Out$to_name   = paste(Temp_PFX_Out$PBglom.to, Temp_PFX_Out$to, sep="__")
  

PP <- ggplot(Temp_PFX_Out) + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", 
                       midpoint =0.5*max(Temp_PFX_Out$weightRelative), limits=c(0,max(Temp_PFX_Out$weightRelative))) +
  geom_tile(aes(to_name,from_name,fill=weightRelative)) +
  facet_grid(rows = vars(Side.from), cols=vars(Side.to), scales="free") +
  ggtitle(paste(Temp_PFX_Out$type.from[1]," to ",Temp_PFX_Out$type.to[1],sep=""))

ggsave(paste(PFX_Dir_Lat, "Asym_", Temp_PFX_Out$type.from[1],"_to_",Temp_PFX_Out$type.to[1], "_inFB.png",sep=""),
       plot = PP, device='png', scale = 1, width = 7.5, height = 5, units ="in", dpi = 500, limitsize = TRUE)






```



# Look for evidence of PI motifs by plotting inputs to PFLs
```{r}


######## Part 1: Get the data ######################################################


# Get full input/output connectivity tables for all FB columnar types
Bag=buildInputsOutputsByType(Columnar_Types, slctROI="FB")
FB_ColumnarInputs_All=Bag[["inputs_raw"]]


# Subset data on columnar types
FB_ColumnarInputs_All=subset(FB_ColumnarInputs_All, databaseType.from %in% Columnar_Types)


# Assign PBglom, FBcol, and Side from neuron names
FB_ColumnarInputs_All=Assign_FBcol_PBglom(FB_ColumnarInputs_All, "name.from", "Side.from", "PBglom.from", "FBcol.from", "from")
FB_ColumnarInputs_All=Assign_FBcol_PBglom(FB_ColumnarInputs_All, "name.to", "Side.to", "PBglom.to", "FBcol.to", "to")


# Give each neuron a unique name
FB_ColumnarInputs_All$from_name = paste(FB_ColumnarInputs_All$FBcol.from, as.character(FB_ColumnarInputs_All$from), sep="__")
FB_ColumnarInputs_All$to_name   = paste(FB_ColumnarInputs_All$FBcol.to, as.character(FB_ColumnarInputs_All$to), sep="__")



######## Part 2: Look at inputs (and inputs to inputs) to PFLn ######################################################


# Get a list of neuron types that give significant input to PFLn
PFL_Type="PFL3"
PFLn_Inputs=subset(FB_ColumnarInputs_All, type.to == PFL_Type)
PFLn_InputsPerColumn=PFLn_Inputs %>% group_by(type.from, FBcol.from) %>% summarise(n=n()) %>%
  group_by(type.from) %>% summarize(Columns = n())
PFLn_InputsPerColumn_Filt = subset(PFLn_InputsPerColumn, (startsWith(type.from, "Delta6")  & Columns >= 4) | 
                                                         (!startsWith(type.from, "Delta6") & Columns >= 4 ) )

# Get the network
PFLn_Network_Types=c(unique( PFLn_InputsPerColumn_Filt$type.from ), PFL_Type)
PFLn_Input_Network=subset(FB_ColumnarInputs_All,  type.to %in% PFLn_Network_Types)
PFLn_Input_Network=subset(PFLn_Input_Network, weight > 3)


# Plot the full matrix
P1=Plot_ColCol_Matix(PFLn_Input_Network)
ggsave(paste(PFX_Dir_PI, PFL_Type, ".png",sep=""),
           plot = P1, device='png', scale = 1, width =15, height = 15, units ="in", dpi = 500, limitsize = TRUE)


P2=Plot_ColCol_Matix(subset(PFLn_Input_Network, type.from %in% Columnar_Types[startsWith(Columnar_Types,"Delta0")] ))
ggsave(paste(PFX_Dir_PI, PFL_Type, "Delta0_Outputs.png",sep=""),
       plot = P2, device='png', scale = 1, width =15, height = 15, units ="in", dpi = 500, limitsize = TRUE)


P2=Plot_ColCol_Matix(subset(PFLn_Input_Network, type.from %in% Columnar_Types[startsWith(Columnar_Types,"Delta6")] ))
ggsave(paste(PFX_Dir_PI, PFL_Type, "Delta6_Outputs.png",sep=""),
       plot = P2, device='png', scale = 1, width =15, height = 15, units ="in", dpi = 500, limitsize = TRUE)


P3=Plot_ColCol_Matix(subset(PFLn_Input_Network, type.from %in% Columnar_Types[!startsWith(Columnar_Types,"Delta6")] &
                              type.from %in% Columnar_Types[!startsWith(Columnar_Types,"Delta0")]))
ggsave(paste(PFX_Dir_PI, PFL_Type, "NonDelta_Outputs.png",sep=""),
       plot = P3, device='png', scale = 1, width =15, height = 15, units ="in", dpi = 500, limitsize = TRUE)



InputsPlot_Sub = plotConnectivityMatrix(PFLn_Input_Network, byGroup = "type", connectionMeasure = "weightRelative")
ggsave(paste(PFX_Dir_PI, PFL_Type, "_Type.png",sep=""),
       plot = InputsPlot_Sub, device='png', scale = 1, width =15, height = 15, units ="in", dpi = 500, limitsize = TRUE)


```




















