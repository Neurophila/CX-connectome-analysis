---
title: "Notebook analyzing the dFB sleep-wake circuit, including how it connects to sleep neurons in the EB"
output:
  html_document:
    df_print: paged
---

# Command to clear environment is: rm(list = ls(all.names = TRUE))
# Load libraries
```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(dplyr)
library(matlib)
library(RColorBrewer)
library(ggraph)
library(robustbase)
require(alphahull)
library(zoo)
library(ggpubr)
library(ggraph)
library(igraph)
library(tidygraph)
library(xlsx)
library(dtplyr)
library(neuprintrExtra)
library("xlsx")
library(tidyselect)
library(reshape2)
library(scales)
library(cowplot)
library(paletteer)
library(prismatic)
options(nat.plotengine = 'rgl')
```

# Configurable inputs: choose save/plot directories
```{r}

# Directory to save plots to.
PlotDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/Sleep/"
if (!dir.exists(PlotDir)){dir.create(PlotDir)}

```

# Connect to neuprint server.
```{r}
neuprint_login()
```

# Get general functions
```{r}

#source("FB_SynapseDistribution_Utils.r")
#source("FB_LayerOutline_Utils.r")
#source("FB_ConnectivityOffsetPlotting_Utils.r")
#source("../inputOutputRegionsVis.r")
#source("../R/connectivityMatricesTools.R")
source("FB_SleepSection_Utils.r")

```

# Get neurons in the dFB sleep-wake circuit
```{r message=FALSE, warning=FALSE}

# Get meta information on all neurons likely to be contained in 23E10 (based on EM-LM matches)
dFB23E10_Types=c("FB7A","FB7K", "FB6A", "FB6C_a", "FB6C_b", "FB6E", "FB6G", "FB6I", "FB6Z")
dFB23E10_MetaAll=getTypesTable(dFB23E10_Types)

# Get meta information on PPL1 dopamine neurons (FB7B and FB6H) with connections to 23E10 neurons
# FB5H is also a PPL1 DAN but does not talk directly with the sleep-wake neurons
dFBdan_Types=c("FB6H","FB7B")
dFBdan_Meta=getTypesTable(dFBdan_Types)

# Neuron types in sleep-wake circuit
SleepWakeTypes=c(dFB23E10_Types,dFBdan_Types)
SleepWakeTypes_Meta=getTypesTable(SleepWakeTypes)

```


# ####################################################################################################################
# ######### Section 1: Connectivity of 23E10 and PPL1 circuit ########################################################
# ####################################################################################################################


# Plot similarity between 23E10 neurons to show that there a multiple distinct types
```{r message=FALSE, warning=FALSE}

# Get all upstream and downstream partners of 23E10 neurons in the FB
dFB23E10_Bag=neuronBag(dFB23E10_MetaAll, slctROI="FB")
dFB23E10_Outputs=dFB23E10_Bag[["outputs_raw"]]
dFB23E10_Inputs=dFB23E10_Bag[["inputs_raw"]]

# Compute input and output connectivity vectors, then concatenate
dFB23E10_Thresh=0.008 # relative weight threshold to binarize connectivity (0.008 is a good)
dFB23E10_Outputs_Vectors= connectivityMatrix(subset(dFB23E10_Outputs, weightRelative>dFB23E10_Thresh),"FB", allToAll=FALSE, from="from",to="to")
dFB23E10_Inputs_Vectors=t(connectivityMatrix(subset(dFB23E10_Inputs,  weightRelative>dFB23E10_Thresh),"FB", allToAll=FALSE, from="from",to="to"))
dFB23E10_Outputs_Vectors=dFB23E10_Outputs_Vectors[order(rownames(dFB23E10_Outputs_Vectors)),]
dFB23E10_Inputs_Vectors=dFB23E10_Inputs_Vectors[order(rownames(dFB23E10_Inputs_Vectors)),]
dFB23E10_InputsOutputs_Vectors=cbind(dFB23E10_Outputs_Vectors, dFB23E10_Inputs_Vectors)

# Compute cosine similarity between the input/output connectivity vectors
dFB23E10_Similarity=Connectivity_VectorsDistance(dFB23E10_InputsOutputs_Vectors, "cosine", dFB23E10_MetaAll)

# Plot cosine similarity 
dFB23E10_Similarity$plotname=paste(dFB23E10_Similarity$type,  as.character(dFB23E10_Similarity$bodyid),sep="__")
dFB23E10_Similarity$plotname2=paste(dFB23E10_Similarity$type2, as.character(dFB23E10_Similarity$bodyid2),sep="__")
dFB23E10_Similarity$type=factor(dFB23E10_Similarity$type, levels=sort(unique(dFB23E10_Similarity$type)))
dFB23E10_Similarity$type2=factor(dFB23E10_Similarity$type2, levels=sort(unique(dFB23E10_Similarity$type2),decreasing = TRUE))

P1=ggplot(dFB23E10_Similarity) + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient2(low="white", mid="gray50", high="black", 
                        midpoint=0.5,limits=c(0,1),oob=squish,breaks = c(0,0.5,1)) +
  geom_tile(aes(plotname,plotname2,fill=Similarity))  + 
  facet_grid(rows=vars(type2),cols=vars(type), scales = "free", space = "free") + 
  theme(strip.background = element_blank(), 
        panel.border = element_rect(colour = "black", fill = NA, size = 0.5), 
        panel.spacing = unit(0, "lines"), axis.ticks = element_blank(), aspect.ratio = 1) 
P1
ggsave(paste(PlotDir, "23e10_SimilarityCosine.png",sep=""),
       plot = P1, device='png', scale = 1, width =12, height = 8, units ="in", dpi = 500, limitsize = TRUE)

```


# Look at neuron-to-neuron connectivity of dFB 23E10 and PPL1 dopamine neurons
```{r message=FALSE, warning=FALSE}

# Get upstream and downstream partners of sleep-wake types in FB
SW_Bag=neuronBag(SleepWakeTypes_Meta, slctROI="FB")
SW_N2N_Output=SW_Bag$outputs_raw

# Get neuron-to-neuron connectivity table involving just sleep-wake types, thresholded 0.0005
SleepWake_N2N_InputOutput=subset(SW_N2N_Output, type.to %in% SleepWakeTypes)
SleepWake_N2N_InputOutput=subset(SleepWake_N2N_InputOutput, weightRelative > 0.0005) 

# Plot neuron-to-neuron connectivity matrix
SleepWake_N2N_InputOutput$fromname=paste(SleepWake_N2N_InputOutput$type.from,  as.character(SleepWake_N2N_InputOutput$from),sep="__")
SleepWake_N2N_InputOutput$toname=paste(SleepWake_N2N_InputOutput$type.to, as.character(SleepWake_N2N_InputOutput$to),sep="__")
SleepWake_N2N_InputOutput$type.from=factor(SleepWake_N2N_InputOutput$type.from, levels=sort(unique(SleepWake_N2N_InputOutput$type.from), decreasing=TRUE))
SleepWake_N2N_InputOutput$type.to=factor(SleepWake_N2N_InputOutput$type.to, levels=sort(unique(SleepWake_N2N_InputOutput$type.to)))

P2=ggplot(SleepWake_N2N_InputOutput) + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", 
                        midpoint=0.05,limits=c(0,0.1),oob=squish,breaks = c(0,0.05,0.1)) +
  geom_tile(aes(toname,fromname,fill=weightRelative))  + 
  facet_grid(rows=vars(type.from),cols=vars(type.to), scales = "free", space = "free") + 
  theme(strip.background = element_blank(), 
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), 
        panel.spacing = unit(0, "lines"), axis.ticks = element_blank(), aspect.ratio = 1) 
P2
ggsave(paste(PlotDir, "SleepWake_N2N.png",sep=""),
       plot = P2, device='png', scale = 1, width =12, height = 8, units ="in", dpi = 500, limitsize = TRUE)

```


# Now look at type-to-type connectivity of dFB sleep-wake types
```{r message=FALSE, warning=FALSE}

# Compute type-to-type connections without using t-test significance criteria.
# Because many FB tangential types are composed of two neurons, the t-test can occasionally
# filter out strong connetions involving two neurons with variable weights.
SleepWake_T2T_Output=getTypeToTypeTable(SW_N2N_Output, majorOutputThreshold = 0.8, singleNeuronThreshold = 0.0, 
                                        singleNeuronThresholdN = 3, pThresh = 1, typesTable = NULL, oldTable = NULL)
SleepWake_T2T_Output=subset(SleepWake_T2T_Output, type.to %in% SleepWakeTypes & !type.to=="FB07?")

# Group presynaptic 23E10 types by FB layer
SleepWake_T2T_Output$InputGrouping=NA
SleepWake_T2T_Output$InputGrouping[startsWith(SleepWake_T2T_Output$type.from,"FB6")]=6
SleepWake_T2T_Output$InputGrouping[startsWith(SleepWake_T2T_Output$type.from,"FB7")]=7
SleepWake_T2T_Output$InputGrouping=factor(SleepWake_T2T_Output$InputGrouping, levels=c(7,6))

# Divide postsynaptic neurons into groups according to which layer provides their strongest input
OutputGrouping = SleepWake_T2T_Output %>% group_by(type.to) %>% filter(weightRelative == max(weightRelative)) 
OutputGrouping = OutputGrouping[c("type.from","type.to")]                                                                            
OutputGrouping$OutputGrouping=NA
OutputGrouping$OutputGrouping[startsWith(OutputGrouping$type.from,"FB6")]=6
OutputGrouping$OutputGrouping[startsWith(OutputGrouping$type.from,"FB7")]=7
OutputGrouping = OutputGrouping[c("type.to","OutputGrouping")]
SleepWake_T2T_Output=merge(SleepWake_T2T_Output,OutputGrouping, by = "type.to")
SleepWake_T2T_Output$OutputGrouping=factor(SleepWake_T2T_Output$OutputGrouping,levels=c(6,7))

# Plot type-to-type connectivity matrix
P3=ggplot(subset(SleepWake_T2T_Output,weightRelative>0.01)) + 
  theme_classic() + theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", midpoint =0.1, limits=c(0,0.2),oob=squish) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) + ggtitle("23E10 Outputs") + 
  facet_grid(rows=vars(InputGrouping), cols=vars(OutputGrouping),scales = "free", space = "free") +
  theme(strip.background = element_blank(), panel.border = element_rect(colour = "grey50", fill = NA), 
        panel.spacing = unit(0, "lines"), aspect.ratio = 1)  
P3
ggsave(paste(PlotDir, "SleepWake_T2T_Sorted.png",sep=""),
         plot = P3, device='png', scale = 1, width =12, height = 5, units ="in", dpi = 500, limitsize = TRUE)

# Plot the same type-to-type connectivity matrix as a network graph
GraphTable=subset(SleepWake_T2T_Output, weightRelative >0.01 & !(type.from == type.to))
P4=Plot_SleepWake_Graph(GraphTable, PlotDir)
P4

```


# ####################################################################################################################
# ######### Section 2: Analysis of upstream/downstream pathways to/from sleep-wake types #############################
# ####################################################################################################################


# Get 2-hop pathways to and from sleep-wake types. As mentioend above, this is done without using the t-test
# significant criteria, which filters out some strong but variable FBt connections involving 2-3 neurons.  
```{r message=FALSE, warning=FALSE}

################## Get downstream connections################## 

# Get first layer outputs (i.e. those neurons directly downstream of sleep-wake types)
DownBag1=neuronBag(SleepWakeTypes_Meta, by.roi=FALSE, omitInputs=TRUE, omitOutputs=FALSE)
SW_Downstream_Raw1=getTypeToTypeTable(DownBag1$outputs_raw, majorOutputThreshold = 0.8, singleNeuronThreshold = 0.01, singleNeuronThresholdN = 3,
                                      pThresh = 1, typesTable = NULL, oldTable = NULL)

# Get second layer outputs (i.e. those neurons two "hops" downstream of sleep-wake types)
DownType1=getTypesTable(unique(SW_Downstream_Raw1$type.to))
DownBag2=neuronBag(DownType1, by.roi=FALSE, omitInputs=TRUE, omitOutputs=FALSE)
SW_Downstream_Raw2=getTypeToTypeTable(DownBag2$outputs_raw, majorOutputThreshold = 0.8, singleNeuronThreshold = 0.01, singleNeuronThresholdN = 3,
                                      pThresh = 1, typesTable = NULL, oldTable = NULL)  

# Create pathway obects
SW_Downstream_Raw=list(SW_Downstream_Raw1, SW_Downstream_Raw2)
SW_Downstream=tableChain2path(SW_Downstream_Raw)
remove(DownBag1, SW_Downstream_Raw1, DownType1, DownBag2, SW_Downstream_Raw2, SW_Downstream_Raw)

################## Get upstream connections ##################

# Get first layer inputs (i.e. those neurons directly upstream of sleep-wake types)
UpBag1=neuronBag(SleepWakeTypes_Meta, by.roi=FALSE, omitInputs=FALSE, omitOutputs=TRUE)
SW_Upstream_Raw1=getTypeToTypeTable(UpBag1$inputs_raw, majorOutputThreshold = 0.8, singleNeuronThreshold = 0.01, singleNeuronThresholdN = 3,
                                    pThresh = 1, typesTable = NULL, oldTable = NULL)

# Get second layer inputs (i.e. those neurons two "hops" upstream of sleep-wake types)
UpType1=getTypesTable(unique(SW_Upstream_Raw1$type.from))
UpBag2=neuronBag(UpType1, by.roi=FALSE, omitInputs=FALSE, omitOutputs=TRUE)
SW_Upstream_Raw2=getTypeToTypeTable(UpBag2$inputs_raw, majorOutputThreshold = 0.8, singleNeuronThreshold = 0.01, singleNeuronThresholdN = 3,
                                    pThresh = 1, typesTable = NULL, oldTable = NULL)  

# Get pathways using normal methods
SW_Upstream_Raw=list(SW_Upstream_Raw1, SW_Upstream_Raw2)
SW_Upstream=tableChain2path(SW_Upstream_Raw)
SW_Upstream=subset(SW_Upstream, databaseType.to %in% SleepWakeTypes_Meta$type)
remove(UpBag1, SW_Upstream_Raw1, UpType1, UpBag2, SW_Upstream_Raw2, SW_Upstream_Raw)

```


# Pick a pathway weight threshold for input and output pathways (0.005 for figures)
```{r message=FALSE, warning=FALSE}
PathwayThresh=0.005
```


# Plot pathways downstream of sleep-wake types
```{r message=FALSE, warning=FALSE}

# Plot 1-step pathways
Plot_DownStream_Pathways(SW_Downstream, PathwayThresh, 1, PlotDir)

# Plot 2-step pathways
ExcludiedDownTypes=Plot_DownStream_Pathways(SW_Downstream, PathwayThresh, 2, PlotDir)

```


# Plot pathways upstream of sleep-wake types
```{r message=FALSE, warning=FALSE}

# Plot 1-step upstream pathways
Plot_UpStream_Pathways(SW_Upstream, PathwayThresh, 1, PlotDir)

# Plot 2-step upstream pathways
Plot_UpStream_Pathways(SW_Upstream, PathwayThresh, 2, PlotDir)
  

```


# ####################################################################################################################
# ######### Make graph of core sleep circuit #########################################################################
# ####################################################################################################################


# Make graph of core sleep network
```{r}


# Define core sleep pathway types connecting EB to FB
SleepWakeTypes_EbFb=c("FB6A","PFGs","hDeltaK","hDeltaF","ExR3","ExR1","ER5",
                      "PEN_b(PEN2)","ER3d_a","ER3d_b","ER3d_c","ER3d_d","FB8B",
                      "hDeltaD","FB7A","FB7B","FB7K", "FB6H", "OA-VPM3")
SleepWakeTypes_EbFb_Table=getTypesTable(SleepWakeTypes_EbFb)


# Get connection table just between these types
SW_EbFb_Bag=neuronBag(SleepWakeTypes_EbFb_Table, by.roi=TRUE)
SW_EbFb_N2N=SW_EbFb_Bag$inputs_raw
SW_EbFb_N2N_Sub=subset(SW_EbFb_N2N, type.to %in% SleepWakeTypes_EbFb & type.from %in% SleepWakeTypes_EbFb)
SW_EbFb_N2N_Sub=subset(SW_EbFb_N2N_Sub, weightRelative > 0.01)


# Compute neuron-to-neuron connectivity
SW_EbFb_T2T=getTypeToTypeTable(SW_EbFb_Bag$inputs_raw, majorOutputThreshold = 0.8, singleNeuronThreshold = 0.01, singleNeuronThresholdN = 3,
                                      pThresh = 1, typesTable = NULL, oldTable = NULL)
SW_EbFb_T2T_Sub=subset(SW_EbFb_T2T, type.to %in% SleepWakeTypes_EbFb & type.from %in% SleepWakeTypes_EbFb)
SW_EbFb_T2T_Sub=subset(SW_EbFb_T2T_Sub, weightRelative>0.01)


# Plot EB connectivity matrix
P1=ggplot(subset(SW_EbFb_T2T_Sub, roi=="EB")) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) +
   scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", 
                        midpoint=0.2,limits=c(0,0.4),oob=squish,breaks = c(0,0.2,0.4)) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        aspect.ratio = 1) 


# Plot EB connectivity matrix
P2=ggplot(subset(SW_EbFb_T2T_Sub, roi=="FB")) +
  geom_tile(aes(type.to,type.from,fill=weightRelative)) +
   scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", 
                        midpoint=0.2,limits=c(0,0.4),oob=squish,breaks = c(0,0.2,0.4)) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        aspect.ratio = 1) 

P3=ggarrange(P1,P2,ncol=1,nrow=2)

ggsave(paste(PlotDir, "EbFb_Matrix.png",sep=""),
        plot = P3, device='png', scale = 1, width =6, height = 10, units ="in", dpi = 500, limitsize = TRUE)
 



```


# Make graphs for the EB
```{r}

# Get input data
GraphTable=subset(SW_EbFb_T2T_Sub, roi=="EB" & weightRelative >0.01)

# remove self connections
GraphTable=subset(GraphTable, !(type.from == type.to) )


# Set node IDs
IDs_Type=sort(unique(c(unique(GraphTable$type.from),unique(GraphTable$type.to))))
EB_NODES=data.frame(name=IDs_Type)


# Set node positions
EB_NODES$name=EB_NODES$name
EB_NODES$x=NA
EB_NODES$y=NA
EB_NODES[EB_NODES$name == "ExR1",c(2,3)]=c(-140,0)
EB_NODES[EB_NODES$name == "ExR3",c(2,3)]=c(-90,0)
EB_NODES[EB_NODES$name == "hDeltaK",c(2,3)]=c(-40,0)
EB_NODES[EB_NODES$name == "ER3d_a",c(2,3)]=c(-150,-10)
EB_NODES[EB_NODES$name == "ER3d_b",c(2,3)]=c(-130,-15)
EB_NODES[EB_NODES$name == "ER3d_c",c(2,3)]=c(-95,-15)
EB_NODES[EB_NODES$name == "ER3d_d",c(2,3)]=c(-75,-10)
EB_NODES[EB_NODES$name == "ER5",c(2,3)]=c(-175,-5)
EB_NODES[EB_NODES$name == "PEN_b(PEN2)",c(2,3)]=c(-40,-10)
EB_NODES$y=EB_NODES$y*5+50


# EB_NODES
EB_NODES$COLORZ="gray50"
EB_NODES$COLORZ[EB_NODES$name == "ExR1" | EB_NODES$name == "ExR3" | EB_NODES$name == "hDeltaK"]="cyan3"
EB_NODES$COLORZ[startsWith(as.character(EB_NODES$name),"ER3")]="seagreen3"
EB_NODES$COLORZ[startsWith(as.character(EB_NODES$name),"ER5")]="plum3"
EB_NODES$COLORZ[startsWith(as.character(EB_NODES$name),"PEN")]="lightseagreen"

# edges
EB_EDGES=GraphTable[c("type.from","type.to","weightRelative")]


# edges
colnames(EB_EDGES)=c("from","to","weight")
EB_EDGES$from=as.character(EB_EDGES$from)
EB_EDGES$to=as.character(EB_EDGES$to)
EB_EDGES$COLORZ=NA
EB_EDGES$COLORZ[EB_EDGES$from == "ExR1" | EB_EDGES$from == "ExR3" | EB_EDGES$from == "hDeltaK"]="cyan3"
EB_EDGES$COLORZ[startsWith(as.character(EB_EDGES$from),"ER3")]="seagreen3"
EB_EDGES$COLORZ[startsWith(as.character(EB_EDGES$from),"ER5")]="plum3"
EB_EDGES$COLORZ[startsWith(as.character(EB_EDGES$from),"PEN")]="lightseagreen"
EB_EDGES$COLORZ=factor(EB_EDGES$COLORZ, levels=unique(EB_EDGES$COLORZ))

# Make ggraph object
graph = tbl_graph(EB_NODES, EB_EDGES)


# colors
col_vector=levels(EB_EDGES$COLORZ)


# Make plot and save
P4=ggraph(graph,layout="manual",x=EB_NODES$x,y=EB_NODES$y) + 
  geom_edge_fan( aes(width=weight, color=COLORZ), 
                 arrow = arrow(length = unit(2, 'mm'),ends = "last", type = "closed"), end_cap = circle(0.75, 'cm'), alpha=1,strength=1) +
  geom_node_point(color=EB_NODES$COLORZ, size=15) +
  geom_node_text(aes(label=name),angle=0,size=2, nudge_y = c(rep(0.06,18),rep(-0.06,9)), color='black' ) +
  theme_classic() + 
  theme(legend.text=element_text(size=6),legend.title=element_text(size=6),
        axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_edge_width(range = c(0.5,2)) + scale_edge_color_manual(values=col_vector) +
   xlim(-220,20) + ylim(-50,100)

ggsave(paste(PlotDir, "EB_Graph_V1.pdf",sep=""),
        plot = P4, device='pdf', scale = 1, width =10, height = 6, units ="in", dpi = 500, limitsize = TRUE)
 


# Plot neuron-to-neuron connection matrix
EB_N2N=subset(SW_EbFb_N2N, roi=="EB" & type.to %in% c("ExR1","ExR3","hDeltaK"))


P3=ggplot(EB_N2N) +
  geom_tile(aes(name.to, name.from, fill=weightRelative)) +
    scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", 
                        midpoint=0.05,limits=c(0,0.1),oob=squish,breaks = c(0,0.05,0.1)) +
  theme_classic() + theme(axis.text.x = element_text(angle = 90))  + 
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "grey50", fill = NA, size = 0.5), #add black border
        panel.spacing = unit(0, "lines"),#remove space between facets
        aspect.ratio = 1) +
  facet_grid(rows=vars(type.from), cols=vars(type.to), space="free", scales="free")

ggsave(paste(PlotDir, "Eb_N2N_Matrix.png",sep=""),
        plot = P3, device='png', scale = 1, width =8, height = 10, units ="in", dpi = 500, limitsize = TRUE)
 



```


# Make graphs for the FB
```{r}

# Get input data
GraphTable=subset(SW_EbFb_T2T_Sub, roi=="FB" & weightRelative >0.01)


# remove self connections
GraphTable=subset(GraphTable, !(type.from == type.to) )


# Set node IDs
IDs_Type=sort(unique(c(unique(GraphTable$type.from),unique(GraphTable$type.to))))
FB_NODES=data.frame(name=IDs_Type)


# Set node positions
FB_NODES$name=FB_NODES$name
FB_NODES$x=NA
FB_NODES$y=NA
FB_NODES[FB_NODES$name == "ExR1",c(2,3)]=c(-140,0)
FB_NODES[FB_NODES$name == "ExR3",c(2,3)]=c(-90,0)
FB_NODES[FB_NODES$name == "hDeltaK",c(2,3)]=c(-40,0)
FB_NODES[FB_NODES$name == "PFGs",c(2,3)]=c(-90-20,10)
FB_NODES[FB_NODES$name == "FB6A",c(2,3)]=c(-20,10)
FB_NODES[FB_NODES$name == "hDeltaF",c(2,3)]=c(-110,15.25)
FB_NODES[FB_NODES$name == "FB7K",c(2,3)]=c(-150-38-10,12)
FB_NODES[FB_NODES$name == "FB7B",c(2,3)]=c(-137.5-35-5,17)
FB_NODES[FB_NODES$name == "FB7A",c(2,3)]=c(-125-35,14)
FB_NODES[FB_NODES$name == "FB8B",c(2,3)]=c(-175,5)
FB_NODES[FB_NODES$name == "hDeltaD",c(2,3)]=c(-200,5)
FB_NODES[FB_NODES$name == "FB6H",c(2,3)]=c(-15,17.5)
FB_NODES[FB_NODES$name == "OA-VPM3",c(2,3)]=c(-35,14)

FB_NODES$y=FB_NODES$y*5


# Get sleep wake colors
pcCols <- paletteer_d("Polychrome::palette36")
col_vector=c(pcCols[15],pcCols[13])


# FB_NODES
FB_NODES$COLORZ=NA
FB_NODES$COLORZ[startsWith(as.character(FB_NODES$name),"hDelta")]="salmon1"
FB_NODES$COLORZ[FB_NODES$name == "ExR1" | FB_NODES$name == "ExR3" | FB_NODES$name == "hDeltaK"]="cyan3"
FB_NODES$COLORZ[startsWith(as.character(FB_NODES$name),"FB")]="seagreen3"
FB_NODES$COLORZ[startsWith(as.character(FB_NODES$name),"PFG")]="slateblue1"
FB_NODES$COLORZ[FB_NODES$name == "FB6A" | FB_NODES$name=="FB7A" | FB_NODES$name=="FB7K"]=col_vector[1]
FB_NODES$COLORZ[FB_NODES$name == "FB7B" | FB_NODES$name == "FB6H"]=col_vector[2]
FB_NODES$COLORZ[FB_NODES$name == "OA-VPM3"]="red"

# edges
FB_EDGES=GraphTable[c("type.from","type.to","weightRelative")]


# FB_EDGES
colnames(FB_EDGES)=c("from","to","weight")
FB_EDGES$from=as.character(FB_EDGES$from)
FB_EDGES$to=as.character(FB_EDGES$to)
FB_EDGES$COLORZ=NA
FB_EDGES$COLORZ[startsWith(as.character(FB_EDGES$from),"hDelta")]="salmon1"
FB_EDGES$COLORZ[FB_EDGES$from == "ExR1" | FB_EDGES$from == "ExR3" | FB_EDGES$from == "hDeltaK"]="cyan3"
FB_EDGES$COLORZ[startsWith(as.character(FB_EDGES$from),"FB")]="seagreen3"
FB_EDGES$COLORZ[startsWith(as.character(FB_EDGES$from),"PFG")]="slateblue1"
FB_EDGES$COLORZ[FB_EDGES$from == "FB6A" | FB_EDGES$from=="FB7A" | FB_EDGES$from=="FB7K"]=col_vector[1]
FB_EDGES$COLORZ[FB_EDGES$from == "FB7B" | FB_EDGES$from == "FB6H"]=col_vector[2]
FB_EDGES$COLORZ[FB_EDGES$from == "OA-VPM3"]="red"

# make factor
FB_EDGES$COLORZ=factor(FB_EDGES$COLORZ, levels=unique(FB_EDGES$COLORZ))

# Make ggraph object
graph = tbl_graph(FB_NODES, FB_EDGES)


# colors
col_vector=levels(FB_EDGES$COLORZ)


# Make plot and save
P4=ggraph(graph,layout="manual",x=FB_NODES$x,y=FB_NODES$y) + 
  geom_edge_fan( aes(width=weight, color=COLORZ), 
                 arrow = arrow(length = unit(2, 'mm'),ends = "last", type = "closed"), end_cap = circle(0.75, 'cm'), alpha=1,strength=1) +
  geom_node_point(color=FB_NODES$COLORZ, size=15) +
  geom_node_text(aes(label=name),angle=0,size=2, nudge_y = c(rep(0.06,18),rep(-0.06,9)), color='black' ) +
  theme_classic() + 
  theme(legend.text=element_text(size=6),legend.title=element_text(size=6),
        axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_edge_width(range = c(0.5,2)) + scale_edge_color_manual(values=col_vector) +
  xlim(-220,20) + ylim(-50,100)

ggsave(paste(PlotDir, "FB_Graph_V1.pdf",sep=""),
        plot = P4, device='pdf', scale = 1, width =10, height = 6, units ="in", dpi = 500, limitsize = TRUE)
 



```


# Make combined graph
```{r}

# Change names for ExR3, ExR1, and hDeltaK
EB_NODES_New=EB_NODES
EB_NODES_New$name=as.character(EB_NODES_New$name)
EB_NODES_New$name[EB_NODES_New$name=="ExR1"]="EB_ExR1"
EB_NODES_New$name[EB_NODES_New$name=="ExR3"]="EB_ExR3"
EB_NODES_New$name[EB_NODES_New$name=="hDeltaK"]="EB_hDeltaK"

EB_EDGES_New=EB_EDGES
EB_EDGES_New$from=as.character(EB_EDGES_New$from)
EB_EDGES_New$from[EB_EDGES_New$from=="ExR1"]="EB_ExR1"
EB_EDGES_New$from[EB_EDGES_New$from=="ExR3"]="EB_ExR3"
EB_EDGES_New$from[EB_EDGES_New$from=="hDeltaK"]="EB_hDeltaK"

EB_EDGES_New$to=as.character(EB_EDGES_New$to)
EB_EDGES_New$to[EB_EDGES_New$to=="ExR1"]="EB_ExR1"
EB_EDGES_New$to[EB_EDGES_New$to=="ExR3"]="EB_ExR3"
EB_EDGES_New$to[EB_EDGES_New$to=="hDeltaK"]="EB_hDeltaK"


FB_NODES_New=FB_NODES
FB_NODES_New$name=as.character(FB_NODES_New$name)
FB_NODES_New$name[FB_NODES_New$name=="ExR1"]="FB_ExR1"
FB_NODES_New$name[FB_NODES_New$name=="ExR3"]="FB_ExR3"
FB_NODES_New$name[FB_NODES_New$name=="hDeltaK"]="FB_hDeltaK"

FB_EDGES_New=FB_EDGES
FB_EDGES_New$from=as.character(FB_EDGES_New$from)
FB_EDGES_New$from[FB_EDGES_New$from=="ExR1"]="FB_ExR1"
FB_EDGES_New$from[FB_EDGES_New$from=="ExR3"]="FB_ExR3"
FB_EDGES_New$from[FB_EDGES_New$from=="hDeltaK"]="FB_hDeltaK"

FB_EDGES_New$to=as.character(FB_EDGES_New$to)
FB_EDGES_New$to[FB_EDGES_New$to=="ExR1"]="FB_ExR1"
FB_EDGES_New$to[FB_EDGES_New$to=="ExR3"]="FB_ExR3"
FB_EDGES_New$to[FB_EDGES_New$to=="hDeltaK"]="FB_hDeltaK"




EB_NODES_New$y=EB_NODES_New$y-100


NODES=rbind(EB_NODES_New,FB_NODES_New)
EDGES=rbind(EB_EDGES_New,FB_EDGES_New)


# make factor
EDGES$COLORZ=factor(EDGES$COLORZ, levels=unique(EDGES$COLORZ))


# Make ggraph object
graph = tbl_graph(NODES, EDGES)


# colors
col_vector=levels(EDGES$COLORZ)


# Make plot and save
P4=ggraph(graph,layout="manual",x=NODES$x,y=NODES$y) + 
  geom_edge_fan( aes(width=weight, color=COLORZ), 
                 arrow = arrow(length = unit(2, 'mm'),ends = "last", type = "closed"), end_cap = circle(0.75, 'cm'), alpha=1,strength=1) +
  geom_node_point(color=NODES$COLORZ, size=15) +
  geom_node_text(aes(label=name),angle=0,size=2, nudge_y = c(rep(0.06,18),rep(-0.06,9)), color='black' ) +
  theme_classic() + 
  theme(legend.text=element_text(size=6),legend.title=element_text(size=6),
        axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),axis.title.y=element_blank()) +
  scale_edge_width(range = c(0.5,2)) + scale_edge_color_manual(values=col_vector)
  #xlim(-220,20) + ylim(-50,100)

ggsave(paste(PlotDir, "FIGURE_Graph_V1.pdf",sep=""),
        plot = P4, device='pdf', scale = 1, width =7, height = 8, units ="in", dpi = 500, limitsize = TRUE)
 


```



