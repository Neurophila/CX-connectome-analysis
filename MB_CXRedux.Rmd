---
title: "MBON Redux"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(ggraph)
library(plotly)
library(dplyr)
library(pbapply)
library(tidygraph)
library(gridExtra)

# Go to the neurpintR-notebooks directory before loading these functions
source("visualizeConnectivityTables.R")
source("neuprintQueryUtils.R")
source("R/table2ggraphUtils.R")
source("InputOutputByTypeUtils.R")
source("R/rois.R")
source("R/supertypeUtils.R")
source("colorCodeLookup.R")
source("pathways.R")
source("inputOutputRegionsVis.R")
source("GetNeuronsInRoi.R")
source("FBNetworkVisUtils.R")
source("CX_ContextualAnalysisUtils.R")

options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose save/plot directories
```{r}
# Directory to save data to.
SaveDir = "/Users/danc/Dropbox (HHMI)/WorkDrop/Data/FIBSEM_Analysis"

# Directory to save plots to.
PlotDir = "/Users/danc/Dropbox (HHMI)/WorkDrop/Data/FIBSEM_Analysis"
```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint
```{r}
# neuprint_login()
neuprint_login(config=httr::set_config(httr::config(ssl_verifypeer = 0L)))
```

### Pulling neurons postsynaptic to MBONs
```{r}
MBON_Names <- neuprint_search("MBON.*")
# Find the postsynaptic partners of all MBONs
MBON_PostConnections <- getConnectionTable(MBON_Names,synapseType = "POST") ## Keeping the default threshold (3)
```

### Get MBON targets inside / outside of CX
```{r}
# Selecting CX types as those present in Romain's list.
CXTypes <- supertype(read_csv("/Users/danc/Dropbox (HHMI)/WorkDrop/Manuscripts/FIBSEM CX Paper Jan 2020/CX-cell-types052220") %>% rename(databaseType=n.type))
MBON_targets <- unique(MBON_PostConnections$type.to)

# Pick MBON targets in the CX
MBONCXTargetsL <- MBON_targets[MBON_targets %in% CXTypes$databaseType]
MBONCXTargets <- getTypesTable(MBONCXTargetsL)

# Pick MBON targets not in the CX
MBONnonCXTargetsL <- MBON_targets[!(MBON_targets %in% CXTypes$databaseType)]
MBONnonCXTargetsL <- na.omit(MBONnonCXTargetsL)
# Exclude MBONs from this list
MBONnonCXTargetsL <- MBONnonCXTargetsL[!(MBONnonCXTargetsL %in% MBON_Names$type)]
MBONnonCXTargets <- getTypesTable(MBONnonCXTargetsL)
```

### Creating a relatively high level ROI set
```{r}
roisH <- getRoiTree()
roiSelection <- selectRoiSet(roisH,default_level=1,exceptions=list("CX"=2))
```

### Find indirect CX targets of MBONs
```{r}
# Find the postsynaptic partners of MBON non-CX non-MBON targets
MBON_2ndaryPostConnections <- getConnectionTable(MBONnonCXTargets$bodyid,synapseType = "POST") ## Keeping the default threshold (3)

# Find the MBON secondary targets in the CX
MBONCX2ndaryTargetsL <- unique(MBON_2ndaryPostConnections$type.to)[unique(MBON_2ndaryPostConnections$type.to) %in% CXTypes$databaseType]
MBONCX2ndaryTargets <- getTypesTable(MBONCX2ndaryTargetsL)
```

### Creating neuron bags of MBON primary and secondary CX targets
```{r}
MBONTargetBag <- buildInputsOutputsByType(MBONCXTargets,slctROI=unique(roiSelection$roi))
MBON2ndaryTargetBag <- buildInputsOutputsByType(MBONCX2ndaryTargets,slctROI=unique(roiSelection$roi))
```

### Separating left and right neurons in there as some tangential input regions might be cut on the left.
```{r}
MBONTargetBagLat <- lateralizeInputOutputList(MBONTargetBag)
MBON2ndaryTargetBagLat <- lateralizeInputOutputList(MBON2ndaryTargetBag)
```

### Isolating the MBON primary and secondary inputs to right side neurons in there
```{r}
MBONTargetInp <- MBONTargetBagLat$inputs %>% filter(startsWith(type.from,"MBON") & grepl("_R",type.to))
MBON2ndaryTargetInp <- MBON2ndaryTargetBagLat$inputs %>% filter((databaseType.from %in% MBONnonCXTargetsL) & grepl("_R",type.to))
```

### Combine all input regions into one (to get a "more fair" relative weight). Add a variable, totalMBContribution, that summarize how much of the total input the MBONs contribute to, and use it to sort the CX types.
```{r}
MBONTargetInputCombined <- combineRois(MBONTargetBagLat,unique(MBONTargetInp$roi),newRoi="MBON outputs")
MBONTargetInpC <- MBONTargetInputCombined$inputs %>% filter(startsWith(type.from,"MBON") & grepl("_R",type.to)) %>% 
  group_by(roi,type.to) %>% mutate(totalMBContribution = sum(weightRelative)) %>% 
                            ungroup() %>%
                                     arrange(desc(totalMBContribution))  %>%
                                     mutate(type.to = factor(type.to,levels=unique(type.to)))## Filter MBON to right CX neurons (some of the left ones can be cut)

plotConnMat_MBON_CX_Romain <- plotConnectivityMatrix(MBONTargetInpC,byGroup="type")
print(plotConnMat_MBON_CX_Romain)
ggsave("MBON_CX_ConnectionsByType_weightRelative_Romain.eps", plot=plotConnMat_MBON_CX_Romain, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)

inputProportions <- ggplot(MBONTargetInpC,aes(x=type.to)) + geom_col(aes(y=weightRelative,fill=type.from)) + scale_fill_manual(values=typesPalette(unique(MBONTargetInpC$type.from)),name="MBON types",guide=guide_legend(ncol=2)) + theme_classic()  + theme(axis.text.x = element_text(angle = 90)) + labs(y="Relative weight in input regions",x="Type")
print(inputProportions)
ggsave("CXfromMBON_InputProportionsByType_weightRelative_Romain.eps", plot=inputProportions, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```


```{r}
### Pull significant MBONTargetInpC connections based on "totalMBContribution"
# Find Strongly connected MBON targets in the CX
StrongMBONTargetInpC <- MBONTargetInpC  %>% filter(totalMBContribution > 0.05)
StrongMBON2CX_TargetsType <- unique(as.vector(StrongMBONTargetInpC$databaseType.to))
StrongMBON2CX_TargetNeurons <- getTypesTable(StrongMBON2CX_TargetsType)
# head(StrongMBON2CX_TargetNeurons)

# Find the MBON bodyids
StrongMBON2CX_FromType <- unique(as.vector(StrongMBONTargetInpC$databaseType.from))
StrongMBON2CX_FromNeurons <- getTypesTable(StrongMBON2CX_FromType)
# head(StrongMBON2CX_FromNeurons)

# Find neuron to neuron connection table for strong direct MBON to CX connections
StrongMBON2CX_ConnTable <- getConnectionTable_forSubset(StrongMBON2CX_FromNeurons$bodyid, StrongMBON2CX_TargetNeurons$bodyid)

# Arrange StrongMBON2CX_ConnTable in the order of StrongMBONTargetInpC$databaseType.to
StrongMBON2CX_ConnTable$type.to <- factor(StrongMBON2CX_ConnTable$type.to,levels=unique(StrongMBONTargetInpC$databaseType.to),ordered=TRUE)
StrongMBON2CX_ConnTable <- arrange(StrongMBON2CX_ConnTable,type.to)
```

### Plot StrongMBON2CX_ConnTable
```{r}
plotStrongMBON2CX_ConnTable <- plotConnectivityMatrix(StrongMBON2CX_ConnTable,byGroup="id")
print(plotStrongMBON2CX_ConnTable)
ggsave("plotStrongMBON2CX_ConnTable.eps", plot=plotStrongMBON2CX_ConnTable, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```

```{r}
### Plot the pathways from MBONs to CX
# Set up the layout for the pathway plot
types <- unique(c(unique(as.vector(StrongMBONTargetInpC$type.from)),unique(as.vector(StrongMBONTargetInpC$type.to))))
numFrom <- length(unique(as.vector(StrongMBONTargetInpC$type.from)))
numTo <- length(unique(as.vector(StrongMBONTargetInpC$type.to)))
xyLookup = data.frame(type = types, x = c(rep(-1,times = numFrom),rep(0,times = numTo)), y = c(seq(-1,1,length.out = numFrom), seq(-1,1,length.out = numTo)))

# Graph the TypeToType ConnTable using the lookupTable
StrongMBONTargetInpCdf <- StrongMBONTargetInpC
StrongMBONTargetInpCdf$type.to <- as.vector(StrongMBONTargetInpCdf$type.to)
gg_MBON2TargetTab <- graphConTab_old(StrongMBONTargetInpCdf,xyLookup,FALSE,TRUE)
# gg_MBON2TargetTab <- graphConTabPolyChrome(StrongMBONTargetInpCdf,xyLookup,FALSE,TRUE)
gg_MBON2TargetTab <- gg_MBON2TargetTab + scale_y_reverse()
print(gg_MBON2TargetTab)
ggsave("StrongMBON2CXtargetsTab.svg", plot=gg_MBON2TargetTab, device="svg", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```
Notes: 
1) MBON05 has no branches ipsilateral to the cell body, only contralateral. FB4R only has dendrites ipsilateral to cell body. Therefore, only MBON05_L (not MBON05_R) makes synapses onto FB4R_R.
2) MBON09 has bilateral branches, but only makes contact with ipsilateral FB4R, i.e., MBON09_R onto FB4R_R.
3) MBON21 has bilateral branches, and synapses onto FB4R bilaterally.
4) MBON04 has bilateral branches, but more contralaterally relative to the name (although the *_L cell body is just off to the midline on the right side).
5) MBON12R and MBON13R only have branches ipsilateral to the cell body.
6) MBON03 has bilateral branches, but more contralaterally relative to the name.
7) MBON22 has ipsilateral branches in the calyz and bilateral branches in SIP/SMP.
8) MBON30 has bilateral branches, but more ipsilateral to the cell body.

### Find connections from strong direct MBON targets to secondary targets in CX
```{r}
# Find the postsynaptic partners of StrongMBON2CX_TargetNeurons
StrongMBON2CX_TargetsCnctTable <- getConnectionTable(StrongMBON2CX_TargetNeurons,synapseType="POST")
# head(StrongMBON2CX_TargetsCnctTable)
StrongMBON2CXTargetsToPostInFB <- getConnectionTable_forSubset(StrongMBON2CX_TargetNeurons$bodyid, StrongMBON2CX_TargetsCnctTable$to,"FB")

# Arrange StrongMBON2CXTargetsToPostInFB in the order of StrongMBONTargetInpC$databaseType.to
StrongMBON2CXTargetsToPostInFB$type.from <- factor(StrongMBON2CXTargetsToPostInFB$type.from,levels=unique(StrongMBONTargetInpC$databaseType.to),ordered=TRUE)
StrongMBON2CXTargetsToPostInFB <- arrange(StrongMBON2CXTargetsToPostInFB,type.from)

# Plot and save the StrongMBON2CXTargetsToPostInFB based on the connectionMeasure of "weightRelative"
plotStrongMBON2CXTargetsToPostInFB <- plotConnectivityMatrix(StrongMBON2CXTargetsToPostInFB,byGroup="id")
print(plotStrongMBON2CXTargetsToPostInFB)
ggsave("plotStrongMBON2CXTargetsToPostInFB.eps", plot=plotStrongMBON2CXTargetsToPostInFB, device="eps", path=PlotDir, scale=1, 
       width=80, height=10, units="in", dpi=300, limitsize=FALSE)
```

```{r}
# Get type to type connection table
StrongMBON2CXTargetsToPostInFB$type.from <- as.vector(StrongMBON2CXTargetsToPostInFB$type.from)
StrongMBON2CXTargetsToPostInFB_Type2TypeTab <- getTypeToTypeTable(StrongMBON2CXTargetsToPostInFB)
# StrongMBON2CXTargetsToPostInFB_Type2TypeTab <- StrongMBON2CXTargetsToPostInFB_Type2TypeTab %>% arrange(type.from %in% StrongMBON2CX_TargetsType)

# Filter the table by weightRelative
StrongMBON2CXTargetsToPostInFB_Type2TypeTab <- StrongMBON2CXTargetsToPostInFB_Type2TypeTab  %>% filter(weightRelative > 0.01)
# Exclude connections to self types
StrongMBON2CXTargetsToPostInFB_Type2TypeTab <- StrongMBON2CXTargetsToPostInFB_Type2TypeTab %>% filter(type.from != type.to)

# Arrange StrongMBON2CXTargetsToPostInFB_Type2TypeTab in the order of StrongMBONTargetInpC$databaseType.to
StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.from <- factor(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.from,levels=unique(StrongMBONTargetInpC$databaseType.to),ordered=TRUE)
StrongMBON2CXTargetsToPostInFB_Type2TypeTab <- arrange(StrongMBON2CXTargetsToPostInFB_Type2TypeTab,type.from)

# Plot and save the StrongMBON2CXTargetsToPostInFB_Type2TypeTab based on the connectionMeasure of "weightRelative"
plotStrongMBON2CXTargetsToPostInFB_Type2TypeConn <- plotConnectivityMatrix(StrongMBON2CXTargetsToPostInFB_Type2TypeTab,byGroup="type",connectionMeasure="weightRelative")
print(plotStrongMBON2CXTargetsToPostInFB_Type2TypeConn)
ggsave("StrongMBON2CXTargetsToPostInFB_Type2TypeTable_weightRelative.eps", plot=plotStrongMBON2CXTargetsToPostInFB_Type2TypeConn, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```

### Plot the pathways from strong direct MBON->CX targets to secondary CX targets
```{r}
# Set up the layout for the pathway plot
types <- unique(c(unique(as.vector(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.from)),sort(unique(as.vector(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.to)))  )   )
numTypes <- length(types)
numFrom <- length(unique(as.vector(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.from)))
numTo <- length(unique(as.vector(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.to)))

# Arrange the primary MBON->CX targets in a circle
angsFrom <- seq(-pi,pi,length.out = numFrom + 1)
angsFrom <- angsFrom[1:(length(angsFrom)-1)]
xFrom <- 1*sin(angsFrom)
yFrom <- 1*cos(angsFrom)

# Arrange the secondary MBON->CX targets in a bigger circle
angsTo <- seq(-pi,pi,length.out = numTypes - numFrom + 1)
angsTo <- angsTo[1:(length(angsTo)-1)]
xTo <-3*sin(angsTo)
yTo <-3*cos(angsTo)

# xyLookup = data.frame(type = types, x = c(rep(-1,times = numFrom),rep(0,times = numTypes-numFrom)), 
#                      y = c(seq(-1,1,length.out = numFrom), seq(-1,1,length.out = numTypes-numFrom)))

# xyLookup = data.frame(type = types, x = c(xFrom,rep(3,times = numTypes-numFrom)), 
#                      y = c(yFrom, seq(-8,8,length.out = numTypes-numFrom)))

xyLookup = data.frame(type = types, x = c(xFrom,xTo), y = c(yFrom,yTo))

# Graph the TypeToType ConnTable using the xyLookup lookupTable
StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.from <- as.vector(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.from)
gg_MBON1stTo2ndaryTargetTab <- graphConTab_old(StrongMBON2CXTargetsToPostInFB_Type2TypeTab,xyLookup,FALSE,TRUE)
gg_MBON1stTo2ndaryTargetTab <- gg_MBON1stTo2ndaryTargetTab + scale_y_reverse()
print(gg_MBON1stTo2ndaryTargetTab)
ggsave("MBON1stTo2ndaryTargetTab.svg", plot=gg_MBON1stTo2ndaryTargetTab, device="svg", path=PlotDir, scale=1, 
       width=16, height=16, units="in", dpi=300, limitsize=FALSE)
```

```{r}
# Plot the connections by pathwayWeight (= totalMBContribution * weightRelative)

```

### Find tertiary MBON targets in the CX
```{r}
# Find the postsynaptic partners of secondary StrongMBON2CX_TargetNeurons
StrongMBON2CX_2ndTargetsInFB_Types <- unique(as.vector(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$databaseType.to))
StrongMBON2CX_2ndTargetsInFB_Neurons <- getTypesTable(StrongMBON2CX_2ndTargetsInFB_Types)
StrongMBON2CX_2ndTargetsCnctTable <- getConnectionTable(StrongMBON2CX_2ndTargetsInFB_Neurons$bodyid,synapseType="POST")
# head(StrongMBON2CX_2ndTargetsCnctTable)
StrongMBON2CX_2ndTargetsToPostInFB <- getConnectionTable_forSubset(StrongMBON2CX_2ndTargetsInFB_Neurons$bodyid, StrongMBON2CX_2ndTargetsCnctTable$to,"FB")

# Arrange StrongMBON2CXTargetsToPostInFB in the order of StrongMBONTargetInpC$databaseType.to
# StrongMBON2CXTargetsToPostInFB$type.from <- factor(StrongMBON2CXTargetsToPostInFB$type.from,levels=unique(StrongMBONTargetInpC$databaseType.to),ordered=TRUE)
# StrongMBON2CXTargetsToPostInFB <- arrange(StrongMBON2CXTargetsToPostInFB,type.from)

# Plot and save the StrongMBON2CX_2ndTargetsToPostInFB based on the connectionMeasure of "weightRelative"
plotStrongMBON2CX2ndTargetsToPostInFB <- plotConnectivityMatrix(StrongMBON2CX_2ndTargetsToPostInFB,byGroup="id")
print(plotStrongMBON2CX2ndTargetsToPostInFB)
ggsave("plotStrongMBON2CX2ndTargetsToPostInFB.eps", plot=plotStrongMBON2CX2ndTargetsToPostInFB, device="eps", path=PlotDir, scale=1, 
       width=180, height=80, units="in", dpi=300, limitsize=FALSE)
```

```{r}
# Get type to type connection table
StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab <- getTypeToTypeTable(StrongMBON2CX_2ndTargetsToPostInFB)
# StrongMBON2CXTargetsToPostInFB_Type2TypeTab <- StrongMBON2CXTargetsToPostInFB_Type2TypeTab %>% arrange(type.from %in% StrongMBON2CX_TargetsType)

# Filter the table by weightRelative
StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab <- StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab  %>% filter(weightRelative > 0.01)
# Exclude connections to self types
StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab <- StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab %>% filter(type.from != type.to)

# Arrange StrongMBON2CXTargetsToPostInFB_Type2TypeTab in the order of StrongMBONTargetInpC$databaseType.to
# StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.from <- factor(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.from,levels=unique(StrongMBONTargetInpC$databaseType.to),ordered=TRUE)
# StrongMBON2CXTargetsToPostInFB_Type2TypeTab <- arrange(StrongMBON2CXTargetsToPostInFB_Type2TypeTab,type.from)

# Plot and save the StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab based on the connectionMeasure of "weightRelative"
plotStrongMBON2CX2ndTargetsToPostInFB_Type2Type <- plotConnectivityMatrix(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab,byGroup="type",connectionMeasure="weightRelative")
print(plotStrongMBON2CX2ndTargetsToPostInFB_Type2Type)
ggsave("StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTable_weightRelative.eps", plot=plotStrongMBON2CX2ndTargetsToPostInFB_Type2Type, device="eps", path=PlotDir, scale=1, 
       width=24, height=16, units="in", dpi=300, limitsize=FALSE)
```

### Plot the pathways from strong direct MBON->CX secondary CX targets to tertiary CX targets
```{r}
# Set up the layout for the pathway plot
types <- unique(c(unique(as.vector(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab$type.from)),sort(unique(as.vector(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab$type.to)))  )   )
numTypes <- length(types)
numFrom <- length(unique(as.vector(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab$type.from)))
numTo <- length(unique(as.vector(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab$type.to)))

# Arrange the secondary MBON->CX targets in a circle
angsFrom <- seq(-pi,pi,length.out = numFrom + 1)
angsFrom <- angsFrom[1:(length(angsFrom)-1)]
xFrom <- 4*sin(angsFrom)
yFrom <- 4*cos(angsFrom)

# Arrange the tertiary MBON->CX targets in a bigger circle
angsTo <- seq(-pi,pi,length.out = numTypes - numFrom + 1)
angsTo <- angsTo[1:(length(angsTo)-1)]
xTo <-5*sin(angsTo)
yTo <-5*cos(angsTo)

# xyLookup = data.frame(type = types, x = c(rep(-1,times = numFrom),rep(0,times = numTypes-numFrom)), 
#                      y = c(seq(-1,1,length.out = numFrom), seq(-1,1,length.out = numTypes-numFrom)))

# xyLookup = data.frame(type = types, x = c(xFrom,rep(3,times = numTypes-numFrom)), 
#                      y = c(yFrom, seq(-8,8,length.out = numTypes-numFrom)))

xyLookup = data.frame(type = types, x = c(xFrom,xTo), y = c(yFrom,yTo))

# Graph the TypeToType ConnTable using the xyLookup lookupTable
gg_MBON2ndTo3rdTargetTab <- graphConTab_old(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab,xyLookup,FALSE,TRUE)
gg_MBON2ndTo3rdTargetTab <- gg_MBON2ndTo3rdTargetTab + scale_y_reverse()
print(gg_MBON2ndTo3rdTargetTab)
ggsave("MBON2ndTo3rdCXTargetTab.svg", plot=gg_MBON2ndTo3rdTargetTab, device="svg", path=PlotDir, scale=1, 
       width=30, height=30, units="in", dpi=300, limitsize=FALSE)
```

### Cluster MB->CX secondary targets by the correlation of their weightRelative connectivity to tertiary targets and the inverse (clustering tertiary targets based their inputs)
```{r}
library(reshape2)
# Select only the relevant columns
Data4Clust <- StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab %>% select(type.from,type.to,weightRelative)

# Recast it into a matrix
Data4Clust <- dcast(Data4Clust,type.from~type.to) # rows are type.from, columns are type.to except the first column has the type.from names, values are weightRelative
Data4Clust[is.na(Data4Clust)] <- 0
rownames(Data4Clust) <- Data4Clust$type.from
Data4Clust <- Data4Clust %>% select(tail(colnames(Data4Clust),ncol(Data4Clust)-1)) # chop off the first column

# Plot the correlation matrix among type.to
library(corrplot)
postscript(file = paste(PlotDir,"corrplotByTo_StrongMBON2CX_2ndTargetsToPostInFB_Type2Type.eps",sep="/"),width=24,height=24)
corrplot(cor(Data4Clust), order="hclust", hclust.method="ward.D2", tl.cex=0.25, tl.col="black") # cor computes the correlation matrix between the columns of the input matrix
dev.off()

# Plot the correlation matrix among type.from
Data4Clust <- t(Data4Clust) # transpose Data4Clust if wanting to plot correlations between type.from
postscript(file = paste(PlotDir,"corrplotByFrom_StrongMBON2CX_2ndTargetsToPostInFB_Type2Type.eps",sep="/"),width=24,height=24)
corrplot(cor(Data4Clust), order="hclust", hclust.method="ward.D2", tl.cex=0.25, tl.col="black") # cor computes the correlation matrix between the columns of the input matrix
dev.off()

```

```{r}
# Calculate the dissimilarity matrix
Data4Clust <- t(Data4Clust) # transpose Data4Clust back so rows are type.from, columns are type.to
Data4ClustSc <- scale(Data4Clust) # centers/scales the columns of Data4Clust (ROMAIN: MIGHT INTRODUCE ARTIFACTS)
d <- dist(t(Data4ClustSc), method = "euclidean") # compute the distance matrix between rows (type.to)
# Perform hierarchical clustering and plot the dendrogram
hc <- hclust(d, method = "ward.D2" )
dend1 <- as.dendrogram(hc)
postscript(file = paste(PlotDir,"ClusterByTo_StrongMBON2CX_2ndTargetsToPostInFB_Type2Type.eps",sep="/"),width=36,height=24)
plot(dend1,lab.cex=0.25)
dev.off()

```

```{r}
# Order the StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab according to the clustering of the inputs to the tertiary targets
StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc <- StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab
StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc$type.to <- factor(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc$type.to, levels = hc$labels[hc$order], ordered=TRUE)
StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc <- arrange(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc,type.to)

# Plot and save the StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc based on the connectionMeasure of "weightRelative"
plotStrongMBON2CX2ndTargetsToPostInFB_Type2Type_hc <- plotConnectivityMatrix(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc,byGroup="type",connectionMeasure="weightRelative")
print(plotStrongMBON2CX2ndTargetsToPostInFB_Type2Type_hc)
ggsave("StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTable_weightRelative_clusterByTo.eps", plot=plotStrongMBON2CX2ndTargetsToPostInFB_Type2Type_hc, device="eps", path=PlotDir, scale=1, 
       width=24, height=16, units="in", dpi=300, limitsize=FALSE)

```

```{r}
# Pathway plot based on the clustered and rearranged StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc
# Set up the layout for the pathway plot
types <- unique(c(unique(as.vector(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc$type.from)),unique(as.vector(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc$type.to))))
numTypes <- length(types)
numFrom <- length(unique(as.vector(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc$type.from)))
numTo <- length(unique(as.vector(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc$type.to)))
xyLookup = data.frame(type = types, x = c(rep(-1,times = numFrom),rep(0,times = numTypes-numFrom)), y = c(seq(-1,1,length.out = numFrom), seq(-1,1,length.out = numTypes-numFrom)))

# Graph the TypeToType ConnTable using the lookupTable
StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc_copy <- StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc
StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc_copy$type.to <- as.vector(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc_copy$type.to)
StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc_pathway <- graphConTab_old(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc_copy,xyLookup,FALSE,TRUE)
# gg_MBON2TargetTab <- graphConTabPolyChrome(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc_pathway,xyLookup,FALSE,TRUE)
StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc_pathway <- StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc_pathway + scale_y_reverse()
print(StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc_pathway)
ggsave("StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_clusterByTo_pathway.svg", plot=StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab_hc_pathway, device="svg", path=PlotDir, scale=1, 
       width=30, height=60, units="in", dpi=300, limitsize=FALSE)

```

########### ran well up to here ################

### put a break here

```{r}
# Run t-SNE on the type.to of StrongMBON2CX_2ndTargetsToPostInFB_Type2TypeTab
library(M3C)
tsne(Data4Clust,perplex=15)

```

```{r}
MBON2ndaryCXTargetTypes <- unique(as.vector(MBON2ndaryTargetInp$databaseType.to))


```





Focus on the FB now (the only exception is LCNp which can probably be treated separately) and try to compute a "pathway weight" per CX target type. For every connection, `MBONInfluence` is the product of the relative weight with the total contribution of MBONs to the presynaptic neuron. `pathwaysWeight` is the sum of that over a target type (basically the sum of all its indirect MBON influences). 

***Should also find pathways through middle neurons outside of the CX. 
```{r}
MBONTargetFBOut <- MBONTargetBagLat$outputs %>% filter(roi=="FB" & type.from %in% MBONTargetInpC$type.to) %>% 
  mutate(MBONInfluence = MBONTargetInpC$totalMBContribution[match(type.from,MBONTargetInpC$type.to)]*weightRelative) %>% group_by(type.to) %>% mutate(pathwaysWeight = sum(MBONInfluence)) %>% ungroup()
  
```
Looking at this table and sorting it according to various ways, the things that first pops out is that it's mostly a FB tangential network (meaning most FB tangential neuron targets in the FB are other FB tangential neurons, I guess something reminiscent of the ring neurons). So we'd need a way to wean this recurrence in the way we consider which parts of the network are influenced by the MBONs.
```{r}
MBONTargetFBOutSummary <- MBONTargetFBOut %>% group_by(type.to) %>% summarise(pathwaysWeight = pathwaysWeight[1])
```

Considering FB4R separately
```{r}
MBONTargetFB4R <- MBONTargetFBOut %>% filter(type.from == "FB4R_R") %>% group_by(type.to) %>% summarise(pathwaysWeight = pathwaysWeight[1])
```

Suggestion: redo that, but study the pool of neurons influenced by a single MBON type at a time.

Other axis to explore: FB tangential inhomogeneous inputs onto columnar neurons.


