---
title: "MBON Redux"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(nat)
library(neuprintr)
library(tidyverse)
library(ggraph)

source("visualizeConnectivityTables.R")
source("neuprintQueryUtils.R")
source("R/table2ggraphUtils.R")
source("InputOutputByTypeUtils.R")
source("R/rois.R")
source("R/supertypeUtils.R")
source("colorCodeLookup.R")

options(nat.plotengine = 'rgl')
```

### Configurable inputs: choose save/plot directories
```{r}
# Directory to save data to.
SaveDir = "/Users/danc/Dropbox (HHMI)/WorkDrop/Data/FIBSEM_Analysis"

# Directory to save plots to.
PlotDir = "/Users/danc/Dropbox (HHMI)/WorkDrop/Data/FIBSEM_Analysis"
```

### Create save/plot directory if they dont exists yet
```{r}
if (!dir.exists(SaveDir)){dir.create(SaveDir)}
if (!dir.exists(PlotDir)){dir.create(PlotDir)}
```

### Connect to neuprint
```{r}
# neuprint_login()
neuprint_login(config=httr::set_config(httr::config(ssl_verifypeer = 0L)))
```

### Pulling neurons postsynaptic to MBONs
```{r}
MBON_Names <- neuprint_search("MBON.*")
# Find the postsynaptic partners of all MBONs
MBON_PostConnections <- getConnectionTable(MBON_Names,synapseType = "POST") ## Keeping the default threshold (3)
```

### Selecting CX types as those present in Shin-ya's list.
```{r}
CXTypes <- supertype(read_csv("/Users/danc/Dropbox (HHMI)/WorkDrop/Manuscripts/FIBSEM CX Paper Jan 2020/CX-cell-types042020") %>% rename(databaseType=n.type))
MBONCXTargetsL <- unique(MBON_PostConnections$type.to)[unique(MBON_PostConnections$type.to) %in% CXTypes$databaseType]
MBONCXTargets <- getTypesTable(MBONCXTargetsL)
```

### Creating a relatively high level ROI set
```{r}
roisH <- getRoiTree()
roiSelection <- selectRoiSet(roisH,default_level=1,exceptions=list("CX"=2))
```

### Find secondary targets of MBONs
```{r}
# Find the postsynaptic partners of all MBON targets
MBON_2ndaryPostConnections <- getConnectionTable(MBON_PostConnections$to,synapseType = "POST") ## Keeping the default threshold (3)
# head(MBON_2ndaryPostConnections)
```

```{r}
# Find the MBON secondary targets in the CX
MBONCX2ndaryTargetsL <- unique(MBON_2ndaryPostConnections$type.to)[unique(MBON_2ndaryPostConnections$type.to) %in% CXTypes$databaseType]
MBONCX2ndaryTargets <- getTypesTable(MBONCX2ndaryTargetsL)
```

### Creating neuron bags of MBON primary and secondary CX targets
```{r}
MBONTargetBag <- buildInputsOutputsByType(MBONCXTargets,slctROI=unique(roiSelection$roi))
MBON2ndaryTargetBag <- buildInputsOutputsByType(MBONCX2ndaryTargets,slctROI=unique(roiSelection$roi))
```

### Separating left and right neurons in there as some tangential input regions might be cut on the left.
```{r}
MBONTargetBagLat <- lateralizeInputOutputList(MBONTargetBag)
MBON2ndaryTargetBagLat <- lateralizeInputOutputList(MBON2ndaryTargetBag)
```

### Isolating the MBON primary and secondary inputs to right side neurons in there
```{r}
MBONTargetInp <- MBONTargetBagLat$inputs %>% filter(startsWith(type.from,"MBON")& grepl("_R",type.to))
MBON2ndaryTargetInp <- MBON2ndaryTargetBagLat$inputs %>% filter(grepl("_R",type.to))
```


```{r}
MBON2ndaryCXTargetTypes <- unique(as.vector(MBON2ndaryTargetInp$databaseType.to))


```



### Combine all input regions into one (to get a "more fair" relative weight). Add a variable, totalMBContribution, that summarize how much of the total input the MBONs contribute to, and use it to sort the CX types.
```{r}
MBONTargetInputCombined <- combineRois(MBONTargetBagLat,unique(MBONTargetInp$roi),newRoi="MBON outputs")
MBONTargetInpC <- MBONTargetInputCombined$inputs %>% filter(startsWith(type.from,"MBON") & grepl("_R",type.to)) %>% 
  group_by(roi,type.to) %>% mutate(totalMBContribution = sum(weightRelative)) %>% 
                            ungroup() %>%
                                     arrange(desc(totalMBContribution))  %>%
                                     mutate(type.to = factor(type.to,levels=unique(type.to)))## Filter MBON to right CX neurons (some of the left ones can be cut)

plotConnMat_MBON_CX_Romain <- plotConnectivityMatrix(MBONTargetInpC,byGroup="type")
print(plotConnMat_MBON_CX_Romain)
ggsave("MBON_CX_ConnectionsByType_weightRelative_Romain.eps", plot=plotConnMat_MBON_CX_Romain, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)

inputProportions <- ggplot(MBONTargetInpC,aes(x=type.to)) + geom_col(aes(y=weightRelative,fill=type.from)) + scale_fill_manual(values=typesPalette(unique(MBONTargetInpC$type.from)),name="MBON types",guide=guide_legend(ncol=2)) + theme_classic()  + theme(axis.text.x = element_text(angle = 90)) + labs(y="Relative weight in input regions",x="Type")
print(inputProportions)
ggsave("CXfromMBON_InputProportionsByType_weightRelative_Romain.eps", plot=inputProportions, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```


```{r}
### Pull significant MBONTargetInpC connections based on "totalMBContribution"
# Find Strongly connected MBON targets in the CX
StrongMBONTargetInpC <- MBONTargetInpC  %>% filter(totalMBContribution > 0.05)
StrongMBON2CX_TargetsType <- unique(as.vector(StrongMBONTargetInpC$databaseType.to))
StrongMBON2CX_TargetNeurons <- getTypesTable(StrongMBON2CX_TargetsType)
# head(StrongMBON2CX_TargetNeurons)
```

########### ran well up to here ################

```{r}
### Plot the pathways from MBONs to CX
# Set up the layout for the pathway plot
types <- unique(c(unique(as.vector(StrongMBONTargetInpC$type.from)),unique(as.vector(StrongMBONTargetInpC$type.to))))
xyLookup = data.frame(type = types,
                      x = c(-1,vector(mode = "numeric",length = (length(types)-1))),
                      y = c(0,seq(-1,1,length.out = (length(types)-1))))

# Graph the TypeToType ConnTable using the combined lookupTable
gg_MBON2TargetTab <- graphConTab(StrongMBONTargetInpC,xyLookup,FALSE,TRUE)
gg_MBON2TargetTab <- gg_MBON2TargetTab + scale_y_reverse()
print(gg_MBON2TargetTab)
ggsave("StrongMBON2CXtargetsTab.svg", plot=gg_MBON2TargetTab, device="svg", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```




### put a break here

```{r}
# Find the postsynaptic partners of StrongMBON2CX_TargetNeurons
StrongMBON2CX_TargetsCnctTable <- getConnectionTable(StrongMBON2CX_TargetNeurons,synapseType="POST",synThresh=5)
# head(StrongMBON2CX_TargetsCnctTable)
StrongMBON2CX_TargetsType2TypeTable <- getTypeToTypeTable(StrongMBON2CX_TargetsCnctTable)
# head(StrongMBON2CX_TargetsType2TypeTable)

# Plot and save the StrongMBON2CX_TargetsType2TypeTable based on the connectionMeasure of "weightRelative"
p4 <- plotConnectivityMatrix(StrongMBON2CX_TargetsType2TypeTable,byGroup="type",connectionMeasure="weightRelative")
print(p4)
ggsave("StrongMBON2CXTargetsType2TypeCnctTable_weightRelative.eps", plot=p4, device="eps", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)

```



```{r}

### Plot the pathways from MBONs to CX
# Get the subset of strong connections in the FB
StrongMBON2CXTargetsToPostInFB <- getConnectionTable_forSubset(StrongMBON2CX_TargetNeurons$bodyid, StrongMBONTargetInpC$databaseType.to,"FB")
StrongMBON2CXTargetsToPostInFB_Type2TypeTab <- getTypeToTypeTable(StrongMBON2CXTargetsToPostInFB)
# head(StrongMBON2CXTargetsToPostInFB_Type2TypeTab)

# Filter the table by weightRelative
StrongMBON2CXTargetsToPostInFB_Type2TypeTab <- StrongMBON2CXTargetsToPostInFB_Type2TypeTab  %>% filter(weightRelative > 0.05)

# Set up the layout for the pathway plot
types <- unique(c(unique(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.from),unique(StrongMBON2CXTargetsToPostInFB_Type2TypeTab$type.to)))
xyLookup = data.frame(type = types,
                      x = c(-1,vector(mode = "numeric",length = (length(types)-1))),
                      y = c(0,seq(-1,1,length.out = (length(types)-1))))

# Graph the TypeToType ConnTable using the combined lookupTable
gg_MBONtargetTab <- graphConTab(StrongMBON2CXTargetsToPostInFB_Type2TypeTab,xyLookup,FALSE,TRUE)
gg_MBONtargetTab <- gg_MBONtargetTab + scale_y_reverse()
print(gg_MBONtargetTab)
ggsave("gg_MBONtargetTab.svg", plot=gg_MBONtargetTab, device="svg", path=PlotDir, scale=1, 
       width=11, height=8, units="in", dpi=300, limitsize=TRUE)
```





```{r}



























Focus on the FB now (the only exception is LCNp which can probably be treated separately) and try to compute a "pathway weight" per CX target type. For every connection, `MBONInfluence` is the product of the relative weight with the total contribution of MBONs to the presynaptic neuron. `pathwaysWeight` is the sum of that over a target type (basically the sum of all its indirect MBON influences). 

***Should also find pathways through middle neurons outside of the CX. 
```{r}
MBONTargetFBOut <- MBONTargetBagLat$outputs %>% filter(roi=="FB" & type.from %in% MBONTargetInpC$type.to) %>% 
  mutate(MBONInfluence = MBONTargetInpC$totalMBContribution[match(type.from,MBONTargetInpC$type.to)]*weightRelative) %>% group_by(type.to) %>% mutate(pathwaysWeight = sum(MBONInfluence)) %>% ungroup()
  
```
Looking at this table and sorting it according to various ways, the things that first pops out is that it's mostly a FB tangential network (meaning most FB tangential neuron targets in the FB are other FB tangential neurons, I guess something reminiscent of the ring neurons). So we'd need a way to wean this recurrence in the way we consider which parts of the network are influenced by the MBONs.
```{r}
MBONTargetFBOutSummary <- MBONTargetFBOut %>% group_by(type.to) %>% summarise(pathwaysWeight = pathwaysWeight[1])
```

Considering FB4R separately
```{r}
MBONTargetFB4R <- MBONTargetFBOut %>% filter(type.from == "FB4R_R") %>% group_by(type.to) %>% summarise(pathwaysWeight = pathwaysWeight[1])
```

Suggestion: redo that, but study the pool of neurons influenced by a single MBON type at a time.

Other axis to explore: FB tangential inhomogeneous inputs onto columnar neurons.


