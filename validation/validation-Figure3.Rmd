---
title: "validation-Figure3"
output: html_notebook
---

This notebook generates the plots related to the first "validation" figure (figure 3), which compares connectivity in the EB in two different versions of the dataset.

## Preparing the environment:
- Loading necessary packages:
```{r,warning=FALSE,message=FALSE}
library(tidyverse)
library(neuprintrExtra)
library(paletteer)
```
  
- Path to the folder where the plots will be saved if need be (by default in a folder created for that in the validation folder)
```{r}
validationFolder <- file.path("validationFigures")
if (!dir.exists(validationFolder)) dir.create(validationFolder)
```

- Loading some local functions for the validation (+ the ggplot theme)
```{r}
source("validationFunctions.R")
source(file.path("..","R","paperTheme.R"))
```

## Preparing the data
One starts by creating two different logins for the database explicitely, one for the "current" version (v1.1), one for an old version. Be careful once you connect to different versions, it is important to explicitly specify the one you want to use in all neuprint commands. I recommend restarting your R session once you're done with this notebook if you want to avoid running your analysis on the old version of the database.
NOTE: FOR NOW IT ONLY WORKS IF CONNECTED ON THE JANELIA VPN (the old version of the database isn't public facing)

First the recent version:
```{r}
newConnection <- neuprint_login(server="https://neuprint.janelia.org",token="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InJvbWFpbi5mcmFuY29udmlsbGVAZ21haWwuY29tIiwibGV2ZWwiOiJyZWFkd3JpdGUiLCJpbWFnZS11cmwiOiJodHRwczovL2xoNi5nb29nbGV1c2VyY29udGVudC5jb20vLWdtUDkxREF4LTNvL0FBQUFBQUFBQUFJL0FBQUFBQUFBQUFBL0FDSGkzcmRaaThLWElURkNhTWpzQldIZUFqcTZ6SkdtX2cvcGhvdG8uanBnP3N6PTUwP3N6PTUwIiwiZXhwIjoxNzYzMzY1MTMyfQ.yCthFpsDrQJLl41WjLf3U-iN-21x_opCXDcnhbizC_g",Force = T)
```

Then the old version:
```{r}
oldConnection <- neuprint_login(server="https://emdata1.int.janelia.org:11000/",token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InJvbWFpbi5mcmFuY29udmlsbGVAZ21haWwuY29tIiwibGV2ZWwiOiJyZWFkd3JpdGUiLCJpbWFnZS11cmwiOiJodHRwczovL2xoNi5nb29nbGV1c2VyY29udGVudC5jb20vLWdtUDkxREF4LTNvL0FBQUFBQUFBQUFJL0FBQUFBQUFBQUFBL0FBS1dKSk14RURObVNiekk5TjNULWw2RkRySWhHdG5LNncvcGhvdG8uanBnP3N6PTUwP3N6PTUwIiwiZXhwIjoxNzY2NDY0NjI2fQ.HsBHKOqeLUUcBcOY-GwzbCHrBMdCBesaICM4UUQSH_k",config=httr::config(ssl_verifypeer=0L),dataset="hemibrain:v0.9pre_dense",Force=T)
```

Select EB neurons for inputs/outputs
```{r}
ebNeurons <- neuprint_bodies_in_ROI("EB",all_segments = FALSE,conn = newConnection)
ebInfo <- filter(getRoiInfo(ebNeurons$bodyid,conn=newConnection),roi=="EB")
ebInfo[is.na(ebInfo)] <- 0
```

```{r}
ebIns <- filter(ebInfo,upstream>200)
ebOuts <- filter(ebInfo,downstream>200)
```

```{r}
EBAges <- getCompConnectionTable(ebIns$bodyid,ebOuts$bodyid,"EB",newConnection,oldConnection)
```

```{r}
EBAges_filtered <- filter(EBAges,known_synapses_ratio>0.1)
EBAges_summary <-distinct(EBAges_filtered,bodyid,side,.keep_all = TRUE) 
synChangeEB <- ggplot(EBAges_summary,aes(x=databaseType,y=known_synapses_ratio*100,color=supertype2)) + geom_jitter(width=0.25,size=0.4) + 
     scale_color_CX_supertype(name="Supertype") + theme_paper() + facet_grid(.~side,scales="free_x") + xlab("") + ylab("known synapses change (%)") +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) + ylim(c(0,120))+ggforce::geom_mark_circle(aes(filter = (bodyid == exampleEPG & side=="inputs")),color="black",expand=0.03)
synChangeEB
```

```{r}
synChangeEBTot <- ggplot(distinct(EBAges,bodyid,side,.keep_all = TRUE),aes(x=databaseType,y=known_synapses_ratio*100,color=supertype2)) + geom_jitter(width=0.2,size=1) + scale_color_CX_supertype(name="Type") + theme_paper() + facet_grid(.~side,scales="free_x")+ xlab("") + ylab("known synapses change (%)") + theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) + geom_hline(yintercept = 10,linetype=2,color="grey") + ggforce::geom_mark_circle(aes(filter = (bodyid == exampleEPG & side =="inputs")),color="black",expand=0.03)
synChangeEBTot
```
```{r}
EBFits <- getFit(EBAges,groups = c("bodyid","databaseType","supertype2","side"),predicted="new",predictor="old")
EBFits <- left_join(EBFits,distinct(EBAges,bodyid,databaseType,supertype2,side,known_synapses_ratio,known_synapses.old,known_synapses.new),by=c("bodyid","databaseType","supertype2","side"))
```



```{r}
EBSlopes <- ggplot(filter(EBFits,paste(bodyid,side) %in% paste(EBAges_summary$bodyid,EBAges_summary$side)),aes(x=databaseType,y=estimate,ymin=estimate-std.error,ymax=estimate+std.error,color=supertype2)) + geom_pointrange(size=0.4/20,position=position_jitter(width=0.2)) + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +xlab("") +ylab("slope estimate") + ggforce::geom_mark_circle(aes(filter = (bodyid == exampleEPG & side=="inputs")),color="black",expand=0.03) + geom_hline(yintercept = 1,lty=2)
EBSlopes
```

```{r}
fitValsEPG <- filter(EBFits,bodyid==exampleEPG & side=="Inputs")
EBCompExample <- ggplot(filter(EBAges_filtered,bodyid==exampleEPG & side=="inputs"),aes(x=old,y=new)) + geom_point(aes(color=supertype2.from),size=0.4) + geom_smooth(formula=y~x,method="lm",color="grey70",alpha=0.1) + 
  geom_abline(linetype=2,lwd=0.2) + theme_paper()  + scale_color_CX_supertype(name="Supertype") + xlab("relative weight in the old dataset") + coord_fixed() +
  ylab("relative weight in the new dataset") + annotate(geom="text",x=0.015,y=0.002,label=paste0("s= ",format(fitValsEPG$estimate,digits = 3),"\n r\u00b2= ",format(fitValsEPG$adj.r.squared,digits=3)))

EBCompExample
```

```{r}
save_plot(paste0(validationFolder,"EBCounts.svg"),synChangeEB,base_width=6.5,base_height=2.25)
save_plot(paste0(validationFolder,"EBSlopes.svg"),EBSlopes,base_width=6.5,base_height=2.25)
save_plot(paste0(validationFolder,"EBExampleFit.svg"),EBCompExample,base_width=3,base_height=3)

```

#### EB validation: SI figure


```{r}
incSlope <-  ggplot(filter(EBFits,paste(bodyid,side) %in% paste(EBAges_summary$bodyid,EBAges_summary$side)),aes(x=known_synapses_ratio*100,y=estimate,ymin=estimate-std.error,ymax=estimate+std.error,color=supertype2)) + geom_pointrange(size=0.2/3) + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +xlab("known synapse increase") +ylab("slope estimate") + geom_hline(yintercept=1,lty=2)
incSlope
```
```{r}
incRS <-  ggplot(filter(EBFits,paste(bodyid,side) %in% paste(EBAges_summary$bodyid,EBAges_summary$side)),aes(x=known_synapses_ratio*100,y=adj.r.squared,color=supertype2)) + geom_point(size=1) + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333))  +xlab("known synapse increase") +ylab("adjusted r\u00b2") + geom_hline(yintercept=1,lty=2)
incRS
```


```{r}
nSlope <-  ggplot(filter(EBFits,paste(bodyid,side) %in% paste(EBAges_summary$bodyid,EBAges_summary$side)),aes(x=known_synapses.new,y=estimate,ymin=estimate-std.error,ymax=estimate+std.error,color=supertype2)) + geom_pointrange(size=0.2/3) + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +xlab("# synapses") +ylab("slope estimate")  + geom_hline(yintercept=1,lty=2)
nSlope
```
```{r}
nRS <-  ggplot(filter(EBFits,paste(bodyid,side) %in% paste(EBAges_summary$bodyid,EBAges_summary$side)),aes(x=known_synapses.new,y=adj.r.squared,color=supertype2)) + geom_point(size=1) + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +xlab("# synapses") +ylab("adjusted r\u00b2") +geom_hline(yintercept=1,lty=2)
nRS
```

```{r}
EBSI2 <- (incSlope + theme(legend.position="none",plot.margin = margin(b=50,r=50))+ggtitle("Slope estimates")| incRS+ theme(legend.position="none",plot.margin = margin(b=50))+ggtitle("Adjusted r\u00b2"))/
  (nSlope + theme(legend.position="none",plot.margin = margin(r=50))| nRS) + plot_layout(guides="collect") + plot_annotation(title="Validation Figure 1 - figure supplement 1",theme=theme(title=element_text(size=12,face="bold")))
EBSI2
```

```{r}
save_plot(paste0(validationFolder,"Validation-Figure1-SI1_new.svg"),EBSI2,base_width = 8.5*1.333333,base_height=6)
```