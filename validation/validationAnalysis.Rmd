---
title: "Validation analysis"
output: html_notebook
---

```{r,warning=FALSE,message=FALSE}
library(neuprintr)
library(tidyverse)
library(cowplot)
library(patchwork)
library(ggiraph)
library(neuprintrExtra)
library(paletteer)
library(nat)
library(broom)
library(Cairo)
```
  
```{r}
validationFolder <- "~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/"
```

## Helper functions

```{r}
#neuprint_login(config=httr::set_config(httr::config(ssl_verifypeer = 0L)))
source("../R/neuronMeshes.R")
source("validationFunctions.R")
source("../R/paperTheme_linux.R")
```

```{r}
pape_theme <- theme_paper(panel.spacing=unit(2, "lines")) 
```


## PB glomeruli comparisons

```{r}
PBL4Neurons <- subroiSet("PB(L4)","PB") 
PBR4Neurons <- subroiSet("PB(R4)","PB") 
PBL3Neurons <- subroiSet("PB(L3)","PB")
PBR3Neurons <- subroiSet("PB(R3)","PB")
PBL5Neurons <- subroiSet("PB(L5)","PB")
PBR5Neurons <- subroiSet("PB(R5)","PB")
PBL6Neurons <- subroiSet("PB(L6)","PB")
PBR6Neurons <- subroiSet("PB(R6)","PB")
PBNeurons <- bind_rows(PBL4Neurons,PBR4Neurons,PBL3Neurons,PBR3Neurons)
PBNeuronsControl <- bind_rows(PBL6Neurons,PBR6Neurons,PBL5Neurons,PBR5Neurons)
```
 
 Selecting neurons with strong innervation patterns, in all of 4 considered glomeruli
```{r}
PBTargets <- PBNeurons %>% filter(upstreamRatio > 0.8 & PB.upstream>20) %>%
  mutate(group= "targets") %>% 
  mutate(previous.type = type, 
         type = paste(type,str_extract(subregion,"[R|L][3-4]"),sep="_")) %>%
  group_by(databaseType) %>% mutate(nReg=length(unique(subregion))) %>%
  filter(nReg == 4)

PBOuts <- PBNeurons %>% filter(downstreamRatio > 0.8 & PB.downstream>20) %>% mutate(group= "outs") %>% mutate(previous.type = type, type = paste(type,str_extract(subregion,"[R|L][3-4]"),sep="_")) %>%
  group_by(databaseType) %>% mutate(nReg=length(unique(subregion))) %>%
  filter(nReg == 4)

```

Same thing for control
```{r}
PBTargetsControl <- PBNeuronsControl %>% filter(upstreamRatio > 0.8 & PB.upstream>20) %>%
  mutate(group= "targets") %>% 
  mutate(previous.type = type, 
         type = paste(type,str_extract(subregion,"[R|L][5-6]"),sep="_")) %>%
  group_by(databaseType) %>% mutate(nReg=length(unique(subregion))) %>%
  filter(nReg == 4)

PBOutsControl <- PBNeuronsControl %>% filter(downstreamRatio > 0.8 & PB.downstream>20) %>% mutate(group= "outs") %>% mutate(previous.type = type, type = paste(type,str_extract(subregion,"[R|L][5-6]"),sep="_")) %>%
  group_by(databaseType) %>% mutate(nReg=length(unique(subregion))) %>%
  filter(nReg == 4)
```

```{r}
PBTable <- neuronBag(unique(PBTargets$databaseType,PBOuts$databaseType),slctROI="PB",synThresh=0,computeKnownRatio=TRUE)
PBTableControl <- neuronBag(unique(PBTargetsControl$databaseType,PBOutsControl$databaseType),slctROI="PB",synThresh=0,computeKnownRatio=TRUE)
```

Redefine types (different renaming for inputs and outputs)
```{r}
PBreBag <- PBTable

PBreBag$inputs_raw<- redefineTypeByBodyId(PBTable$inputs_raw,postfix="to",sets=lapply(c("PB(R4)","PB(R3)","PB(L4)","PB(L3)"),function(x){filter(PBTargets,subregion == x)$bodyid}),nameModifiers=c("_R4","_R3","_L4","_L3")) %>% filter(type.to %in% PBTargets$type)
PBreBag$names <- redefineTypeByBodyId(PBTable$names,sets=lapply(c("PB(R4)","PB(R3)","PB(L4)","PB(L3)"),function(x){filter(PBTargets,subregion == x)$bodyid}),nameModifiers=c("_R4","_R3","_L4","_L3"),postfix = "raw") %>% filter(type %in% PBTargets$type)
PBreBag$outputs_raw <- redefineTypeByBodyId(PBTable$outputs_raw,postfix="from",sets=lapply(c("PB(R4)","PB(R3)","PB(L4)","PB(L3)"),function(x){filter(PBOuts,subregion == x)$bodyid}),nameModifiers=c("_R4","_R3","_L4","_L3")) %>% filter(type.from %in% PBOuts$type)

PBreBag$inputs <- getTypeToTypeTable(PBreBag$inputs_raw,typesTable=PBreBag$names,oldTable=PBreBag$inputs)
PBreBag$outputs <-  getTypeToTypeTable(PBreBag$outputs_raw,typesTable=PBreBag$outputsTableRef,oldTable=PBreBag$outputs) 
```

```{r}
PBreBagControl <- PBTableControl

PBreBagControl$inputs_raw<- redefineTypeByBodyId(PBTableControl$inputs_raw,postfix="to",sets=lapply(c("PB(R6)","PB(R5)","PB(L6)","PB(L5)"),function(x){filter(PBTargetsControl,subregion == x)$bodyid}),nameModifiers=c("_R6","_R5","_L6","_L5")) %>% filter(type.to %in% PBTargetsControl$type)
PBreBagControl$names <- redefineTypeByBodyId(PBTableControl$names,sets=lapply(c("PB(R6)","PB(R5)","PB(L6)","PB(L5)"),function(x){filter(PBTargetsControl,subregion == x)$bodyid}),nameModifiers=c("_R6","_R5","_L6","_L5"),postfix = "raw") %>% filter(type %in% PBTargetsControl$type)
PBreBagControl$outputs_raw <- redefineTypeByBodyId(PBTableControl$outputs_raw,postfix="from",sets=lapply(c("PB(R6)","PB(R5)","PB(L6)","PB(L5)"),function(x){filter(PBOutsControl,subregion == x)$bodyid}),nameModifiers=c("_R6","_R5","_L6","_L5")) %>% filter(type.from %in% PBOutsControl$type)

PBreBagControl$inputs <- getTypeToTypeTable(PBreBagControl$inputs_raw,typesTable=PBreBagControl$names,oldTable=PBreBagControl$inputs)
PBreBagControl$outputs <-  getTypeToTypeTable(PBreBagControl$outputs_raw,typesTable=PBreBagControl$outputsTableref,oldTable=PBreBagControl$outputs) 
```

```{r}
PB3InputComp <- PBreBag$inputs %>% filter(!is.na(databaseType.from)) %>%  
  mutate(glomerulus = substring(str_extract(type.to,"_[R|L][3-4]"),2)) %>%
  group_by(databaseType.from,databaseType.to,glomerulus) %>%
  summarize(weightRelative=mean(knownWeightRelative),
            known_synapses=first(knownTotalROIweight)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype",1:3,".from")),c(paste0("supertype",1:3,".to"))),
              names_from= glomerulus,
              values_from = c("weightRelative","known_synapses"),
              values_fill=list("weightRelative"=0))%>%
  rename(R3=weightRelative_R3,
         R4=weightRelative_R4,
         L3=weightRelative_L3,
         L4=weightRelative_L4)

PB3InputComp <-  group_by(PB3InputComp,databaseType.to) %>% mutate_at(vars(paste0("known_synapses_",c("R3","L3","R4","L4"))),~mean(.,na.rm=TRUE)) %>%
                                                                  mutate(known_synapses_ratio3 = (known_synapses_R3 - known_synapses_L3)/known_synapses_L3,
                                                                        known_synapses_ratio4 = (known_synapses_L4 - known_synapses_R4)/known_synapses_R4) %>% ungroup()
```

```{r}
PB3OutputComp <- PBreBag$outputs %>% filter(!is.na(databaseType.to)) %>%  
  mutate(glomerulus = substring(str_extract(type.from,"_[R|L][3-4]"),2)) %>%
  group_by(databaseType.from,databaseType.to,glomerulus) %>%
  summarize(outputContribution=mean(knownOutputContribution),
            known_synapses=first(knownTotalPreROIweight)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype",1:3,".from")),c(paste0("supertype",1:3,".to"))),
              names_from= glomerulus,
              values_from = c("outputContribution","known_synapses"),
              values_fill=list("outputContribution"=0))%>%
  rename(R3=outputContribution_R3,
         R4=outputContribution_R4,
         L3=outputContribution_L3,
         L4=outputContribution_L4)

PB3OutputComp <-  group_by(PB3OutputComp,databaseType.from) %>% mutate_at(vars(paste0("known_synapses_",c("R3","L3","R4","L4"))),~mean(.,na.rm=TRUE)) %>%
                                                                  mutate(known_synapses_ratio3 = (known_synapses_R3 - known_synapses_L3)/known_synapses_L3,
                                                                        known_synapses_ratio4 = (known_synapses_L4 - known_synapses_R4)/known_synapses_R4) %>% ungroup()
```

```{r}
PB3Comp <- bind_rows(mutate(PB3InputComp,side="inputs",
                                           supertype2=supertype2.to,
                                                   databaseType=databaseType.to),
                      mutate(PB3OutputComp,side="outputs",
                                           supertype2=supertype2.from,
                                           databaseType=databaseType.from)) 
```

```{r}
PB3CompLong <- pivot_longer(PB3Comp,c("known_synapses_ratio3","known_synapses_ratio4"),names_to="glomerulus",names_prefix="known_synapses_ratio",values_to = "known_synapses_ratio") %>%
  mutate(comp=ifelse(glomerulus==3,"L3 to R3","R4 to L4"),
         count_base=ifelse(glomerulus==3,L3,R4),
         count_heavy=ifelse(glomerulus==3,R3,L4)) %>% select(databaseType,side,glomerulus,comp,count_base,count_heavy,known_synapses_ratio,supertype2)
```

Make the fits per type/side/glomerulus
```{r}
PBCompFits <- getFit(PB3CompLong,predicted="count_heavy",predictor="count_base",groups = c("databaseType","side","supertype2","comp","glomerulus"))
```

#### Figures
##### Example inputs: PFNa in glom 3
```{r}
fitValsPFNa3 <- filter(PBCompFits,databaseType=="PFNa" & side=="inputs" & glomerulus ==3)
PBCompIn <- ggplot(filter(PB3Comp,databaseType=="PFNa"),aes(x=L3,y=R3)) + geom_point(aes(color=supertype2.from),size=2) + geom_smooth(formula=y~x,method="lm",color="grey70",alpha=0.1) + 
  geom_abline(linetype=2,lwd=0.2) + theme_paper()  + scale_color_CX_supertype(name="Partner\nsupertype") + xlab("relative input weight in L3") + coord_fixed() +
  ylab("relative input weight in R3") + annotate(geom="text",x=0.3,y=0.08,label=paste0("s= ",format(fitValsPFNa3$estimate,digits = 3),"\n r\u00b2= ",format(fitValsPFNa3$adj.r.squared,digits=3)))


PBCompIn
```

##### Example outputs: EPG outputs in glom 4
```{r}
fitValsEPG4 <- filter(PBCompFits,databaseType=="EPG" & side=="outputs" & glomerulus ==4)
PBCompOut <- ggplot(filter(PB3Comp,databaseType=="EPG" & side=="outputs"),aes(x=R4,y=L4)) + geom_point(aes(color=supertype2.to)) + geom_smooth(formula=y~x,method="lm",color="grey70",alpha=0.1) + 
  geom_abline(linetype=2,lwd=0.2) + theme_paper()  + scale_color_CX_supertype(name="Supertype") + xlab("relative output weight in R4") + coord_fixed() +
  ylab("relative output weight in L4") + annotate(geom="text",x=0.25,y=0.05,label=paste0("s= ",format(fitValsEPG4$estimate,digits = 3),"\n r\u00b2= ",format(fitValsEPG4$adj.r.squared,digits=3)))


PBCompOut
```

```{r}
#PBSynapseCountDiff <- ggplot(distinct(PB3CompLong,databaseType,side,glomerulus,.keep_all = TRUE),aes(x=databaseType,y=known_synapses_ratio*100,color=supertype2,shape=comp)) + geom_point() + scale_color_CX_supertype(name="Supertype") + theme_paper() + facet_grid(.~side,scales="free_x") + xlab("") + ylab("known synapses change (%)")+theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5)) + ggforce::geom_mark_circle(aes(filter = (databaseType == "EPG" & glomerulus==4 & side=="Outputs")),color="black",expand=0.03) + ggforce::geom_mark_circle(aes(filter = (databaseType == "PFNa" & glomerulus==3 & side=="Inputs")),color="black",expand=0.03) + scale_shape(name="Comparison")

PBSynapseCountDiffAlt <- ggplot(distinct(PB3CompLong,databaseType,side,glomerulus,.keep_all = TRUE),aes(x=databaseType,y=known_synapses_ratio*100,color=supertype2,shape=comp)) + geom_point() + scale_color_CX_supertype(name="Supertype") + theme_paper() + facet_grid(.~side,scales="free_x") + xlab("") + ylab("known synapses change (%)")+theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +  ggforce::geom_mark_circle(aes(filter = (databaseType == "PFNa" & glomerulus==3 & side=="inputs")),color="black",expand=0.03) + scale_shape(name="Comparison") + geom_hline(yintercept = 0,lty=2)
PBSynapseCountDiffAlt
```


```{r}
PBSlopesAlt <- ggplot(PBCompFits,aes(x=databaseType,y=estimate,ymin=estimate-std.error,ymax=estimate+std.error,color=supertype2,shape=comp)) + geom_point() + geom_linerange() + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +xlab("") +ylab("slope estimate") + scale_shape(name="Comparison") + ggforce::geom_mark_circle(aes(filter = (databaseType == "PFNa" & glomerulus==3 & side=="inputs")),color="black",alpha=1,expand = 0.03) + geom_hline(yintercept = 1,lty=2)
PBSlopesAlt
```

### PB anatomies

```{r}
PBMesh <- neuprint_ROI_mesh("PB")
R3Mesh <- neuprint_ROI_mesh("PB(R3)")
L3Mesh <- neuprint_ROI_mesh("PB(L3)")
R4Mesh <- neuprint_ROI_mesh("PB(R4)")
L4Mesh <- neuprint_ROI_mesh("PB(L4)")
```

```{r}
R3Example <- unique(filter(PBreBag$inputs_raw,type.to=="PFNa_R3")$to)
L3Example <- unique(filter(PBreBag$inputs_raw,type.to=="PFNa_L3")$to)
R3ExampleAnat <- lapply(R3Example,getNeuronMesh,cloud=TRUE)
L3ExampleAnat <- lapply(L3Example,getNeuronMesh,cloud=TRUE)
R4Example <- unique(filter(PBreBag$outputs_raw,type.from=="EPG_R4")$from)
L4Example <- unique(filter(PBreBag$outputs_raw,type.from=="EPG_L4")$from)
R4ExampleAnat <- lapply(R4Example,getNeuronMesh,cloud=TRUE)
L4ExampleAnat <- lapply(L4Example,getNeuronMesh,cloud=TRUE)
```


```{r}
nopen3d()
par3d(windowRect = c(20, 30, 1500, 1500))
plot3d(PBMesh,color="white",alpha=0.2,xlab="",ylab="",zlab="",box=FALSE,axes=FALSE)
par3d(scale=c(1,1,1))
plot3d(R3Mesh,color="#908827",add=TRUE,alpha=0.2)
plot3d(L3Mesh,color="grey30",add=TRUE,alpha=0.2)
shade3d(R3ExampleAnat[[1]],col="SteelBlue")
shade3d(R3ExampleAnat[[2]],col="SkyBlue")
shade3d(L3ExampleAnat[[1]],col="grey80")
shade3d(L3ExampleAnat[[2]],col="grey40")
nview3d("ventral")
rgl.snapshot(paste0(validationFolder,"frontPB3.png"))
```

```{r}
nopen3d()
par3d(windowRect = c(20, 30, 1500, 1500))
plot3d(PBMesh,color="white",alpha=0.2,xlab="",ylab="",zlab="",box=FALSE,axes=FALSE)
par3d(scale=c(1,1,1))
plot3d(L4Mesh,color="#908827",add=TRUE,alpha=0.2)
plot3d(R4Mesh,color="grey30",add=TRUE,alpha=0.2)
shade3d(L4ExampleAnat[[1]],col="SteelBlue")
shade3d(L4ExampleAnat[[2]],col="SkyBlue")
shade3d(L4ExampleAnat[[3]],col="royalblue")
shade3d(R4ExampleAnat[[1]],col="grey80")
shade3d(R4ExampleAnat[[2]],col="grey40")
shade3d(R4ExampleAnat[[3]],col="grey60")
nview3d("ventral")
rgl.snapshot(paste0(validationFolder,"frontPB4.png"))
```

```{r}
PBFrame3 <- ggdraw() + draw_image(paste0(validationFolder,"frontPB3.png"),scale=1.4,vjust=0.05,clip="on") + theme_paper_map()  
PBFrame3 <- PBFrame3 + annotate(geom="text",x=0.4,y=0.4,label="R3") + annotate(geom="text",x=0.61,y=0.42,label="L3")
PBFrame3 <- PBFrame3 + annotate(geom="text",x=0.5,y=0.95,label="PFNa inputs in glomeruli 3")
PBFrame3
```
```{r}
PBFrame4 <- ggdraw() + draw_image(paste0(validationFolder,"frontPB4.png"),scale=1.8,clip="on") + theme_paper_map()
PBFrame4 <- PBFrame4 + annotate(geom="text",x=0.48,y=0.54,label="R4") + annotate(geom="text",x=0.65,y=0.55,label="L4")
PBFrame4 <- PBFrame4 + annotate(geom="text",x=0.5,y=0.95,label="EPG outputs in glomeruli 4")
PBFrame4
```

```{r}
save_plot(paste0(validationFolder,"PBCounts.svg"),PBSynapseCountDiffAlt,base_width=4.25,base_height=2.25)
save_plot(paste0(validationFolder,"PBSlopes.svg"),PBSlopesAlt,base_width=4.25,base_height=2.25)
save_plot(paste0(validationFolder,"PBExampleFit.svg"),PBCompIn,base_width=3,base_height=3)

pbLayout <- c(
  area(t = 1, l = 1, b = 5, r = 5),
  area(t = 1, l = 6, b = 4, r = 10),
  area(t = 6, l = 2, b = 8, r = 4),
  area(t = 5, l = 6, b = 8, r = 10)
)


PBFigAlt <- (PBFrame3 + 
                         (PBSynapseCountDiffAlt + theme(legend.position="none")) + (PBCompIn+guides(color=FALSE)) + 
         (PBSlopesAlt + guides(color=FALSE)))  + plot_layout(design=pbLayout,guides="keep") + plot_annotation(tag_levels="i") 
PBFigAlt


```


#### PB 5-6 control

```{r}
PB3InputCompControl <- PBreBagControl$inputs %>% filter(!is.na(databaseType.from)) %>%  
  mutate(glomerulus = substring(str_extract(type.to,"_[R|L][5-6]"),2)) %>%
  group_by(databaseType.from,databaseType.to,glomerulus) %>%
  summarize(weightRelative=mean(knownWeightRelative),
            known_synapses=first(knownTotalROIweight)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype",1:3,".from")),c(paste0("supertype",1:3,".to"))),
              names_from= glomerulus,
              values_from = c("weightRelative","known_synapses"),
              values_fill=list("weightRelative"=0))%>%
  rename(R5=weightRelative_R5,
         R6=weightRelative_R6,
         L5=weightRelative_L5,
         L6=weightRelative_L6)

PB3InputCompControl <-  group_by(PB3InputCompControl,databaseType.to) %>% mutate_at(vars(paste0("known_synapses_",c("R5","L5","R6","L6"))),~mean(.,na.rm=TRUE)) %>%
                                                                  mutate(known_synapses_ratio5 = (known_synapses_R5 - known_synapses_L5)/known_synapses_L5,
                                                                        known_synapses_ratio6 = (known_synapses_L6 - known_synapses_R6)/known_synapses_R6) %>% ungroup()
```

```{r}
PB3OutputCompControl <- PBreBagControl$outputs %>% filter(!is.na(databaseType.to)) %>%  
  mutate(glomerulus = substring(str_extract(type.from,"_[R|L][5-6]"),2)) %>%
  group_by(databaseType.from,databaseType.to,glomerulus) %>%
  summarize(outputContribution=mean(knownOutputContribution),
            known_synapses=first(knownTotalPreROIweight)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype",1:3,".from")),c(paste0("supertype",1:3,".to"))),
              names_from= glomerulus,
              values_from = c("outputContribution","known_synapses"),
              values_fill=list("outputContribution"=0))%>%
  rename(R5=outputContribution_R5,
         R6=outputContribution_R6,
         L5=outputContribution_L5,
         L6=outputContribution_L6)

PB3OutputCompControl <-  group_by(PB3OutputCompControl,databaseType.from) %>% mutate_at(vars(paste0("known_synapses_",c("R5","L5","R6","L6"))),~mean(.,na.rm=TRUE)) %>%
                                                                  mutate(known_synapses_ratio5 = (known_synapses_R5 - known_synapses_L5)/known_synapses_L5,
                                                                        known_synapses_ratio6 = (known_synapses_L6 - known_synapses_R6)/known_synapses_R6) %>% ungroup()
```

```{r}
PB3CompControl <- bind_rows(mutate(PB3InputCompControl,side="inputs",
                                           supertype2=supertype2.to,
                                           databaseType=databaseType.to),
                      mutate(PB3OutputCompControl,side="outputs",
                                           supertype2=supertype2.from,
                                           databaseType=databaseType.from))
```

```{r}
PB3CompControlLong <- pivot_longer(PB3CompControl,c("known_synapses_ratio5","known_synapses_ratio6"),names_to="glomerulus",names_prefix="known_synapses_ratio",values_to = "known_synapses_ratio") %>%
  mutate(comp=ifelse(glomerulus==5,"L5 to R5","R6 to L6"),
         count_base=ifelse(glomerulus==5,L5,R6),
         count_heavy=ifelse(glomerulus==5,R5,L6)) %>% select(databaseType,side,glomerulus,comp,count_base,count_heavy,known_synapses_ratio,supertype2)
```

Make the fits per type/side/glomerulus
```{r}
PBCompControlFits <- getFit(PB3CompControlLong,predicted="count_heavy",predictor="count_base",groups = c("databaseType","side","supertype2","comp","glomerulus"))
```

##### Example inputs: PFNa in glom 5
```{r}
fitValsPFNa5 <- filter(PBCompControlFits,databaseType=="PFNa" & side=="inputs" & glomerulus ==5)
PBCompControlIn <- ggplot(filter(PB3CompControl,databaseType=="PFNa"),aes(x=L5,y=R5)) + geom_point(aes(color=supertype2.from)) + geom_smooth(formula=y~x,method="lm",color="grey70",alpha=0.1) + 
  geom_abline(linetype=2,lwd=0.2) + theme_paper()  + scale_color_CX_supertype(name="Supertype") + xlab("relative input weight in L5") + coord_fixed() +
  ylab("relative input weight in R5") + annotate(geom="text",x=0.3,y=0.08,label=paste0("s= ",format(fitValsPFNa5$estimate,digits = 3),"\n r\u00b2= ",format(fitValsPFNa5$adj.r.squared,digits=3)))

PBCompControlIn
```

##### Example outputs: EPG outputs in glom 6
```{r}
fitValsEPG6 <- filter(PBCompControlFits,databaseType=="EPG" & side=="outputs" & glomerulus ==6)
PBCompControlOut <- ggplot(filter(PB3CompControl,databaseType=="EPG" & side=="outputs"),aes(x=R6,y=L6)) + geom_point(aes(color=supertype2.to)) + geom_smooth(formula=y~x,method="lm",color="grey70",alpha=0.1) + 
  geom_abline(linetype=2,lwd=0.2) + theme_paper() + scale_color_CX_supertype(name="Supertype") + xlab("relative output weight in R6") + coord_fixed()+
  ylab("relative output weight in L6") + annotate(geom="text",x=0.3,y=0.08,label=paste0("s= ",format(fitValsEPG6$estimate,digits = 3),"\n r\u00b2= ",format(fitValsEPG6$adj.r.squared,digits=3)))


PBCompControlOut
```

```{r}
PBSynapseCountDiffControl <- ggplot(distinct(PB3CompControlLong,databaseType,side,glomerulus,.keep_all = TRUE),aes(x=databaseType,y=known_synapses_ratio*100,color=supertype2,shape=comp)) + geom_point() +  scale_color_CX_supertype(name="Type") + theme_paper() + facet_grid(.~side,scales="free_x") + xlab("") + ylab("known synapses change (%)")+theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333))  + scale_shape(name="Comparison")+ ggforce::geom_mark_circle(aes(filter = (databaseType == "EPG" & glomerulus==6 & side=="outputs")),color="black",expand=0.03) + ggforce::geom_mark_circle(aes(filter = (databaseType == "PFNa" & glomerulus==5 & side=="inputs")),color="black",expand=0.03)
PBSynapseCountDiffControl
```

```{r}
PBSlopesControl <- ggplot(PBCompControlFits,aes(x=databaseType,y=estimate,ymin=estimate-std.error,ymax=estimate+std.error,color=supertype2,shape=comp)) + geom_point() + geom_linerange() + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +xlab("") +ylab("slope estimate") + scale_shape(name="Comparison")+ ggforce::geom_mark_circle(aes(filter = (databaseType == "EPG" & glomerulus==6 & side=="outputs")),color="black",alpha=1,expand=0.03) + ggforce::geom_mark_circle(aes(filter = (databaseType == "PFNa" & glomerulus==5 & side=="inputs")),color="black",alpha=1,expand = 0.03)+geom_hline(yintercept=1,lty=2)
PBSlopesControl
```

```{r}
PBCompAllFits <- rbind(mutate(PBCompFits,type="Heavy tracing comparison (3/4)"),mutate(PBCompControlFits,type="Control (5/6)"))
PBCompSlopesComp <- ggplot(PBCompAllFits,aes(estimate,fill=type)) + geom_histogram(alpha=0.5,aes(y=..density..),position="identity")  + paletteer::scale_fill_paletteer_d("Polychrome::dark",name="Comparison") + theme_paper_grid() + xlab("slope estimate")
PBCompSlopesComp
```
```{r}
layout <- "ACC
           BDD
           EEE
           FFF
           FFF
          "

PBControlFig <- 
            ((PBCompControlIn+guides(color=FALSE))
              +  PBCompControlOut  +
         (PBSynapseCountDiffControl + theme(legend.position="none")) + 
         (PBSlopesControl + guides(color=FALSE)) +
         PBCompSlopesComp + plot_spacer()) + plot_layout(design=layout,guides="keep") + plot_annotation(tag_levels="A",title= "Validation Figure 2 - Figure supplement 1: comparing PB glomeruli at equivalent tracing levels",theme=theme(title=element_text(size=12*1.111111,face="bold")))
PBControlFig 

save_plot(paste0(validationFolder,"validation-Figure2-SI1.svg"),PBControlFig,base_width = 8.5*1.333333,base_height=11*1.333333)
```

## FB Column 3 vs the rest of the FB

Collecting info on neurons innervating that volume.
```{r}
FBC3Neurons <- subroiSet("FB-column3","FB")
```

Filter for "really in this region": neurons we're confident belong here. At least 200 synapses and 80% of it's FB synapses in Column3. This is because the type to type quantification, which will be slightly different here, cannot do the job (as we want to normalize "types" to the area)
```{r}
FBC3Real <- FBC3Neurons %>% filter(upstreamRatio > 0.8 & FB.upstream > 200) 
FBC3RealOut <- FBC3Neurons %>% filter(downstreamRatio > 0.8 & FB.downstream > 200) 
```

```{r}
FBCTypes_In <- getTypesTable(unique(FBC3Real$type))
FBCTypes_Out <- getTypesTable(unique(FBC3RealOut$type))
FBCTypes_In <- left_join(FBCTypes_In,neuprint_get_roiInfo(FBCTypes_In$bodyid) %>% select(bodyid,FB.upstream,FB.post))
FBCTypes_Out <- left_join(FBCTypes_Out,neuprint_get_roiInfo(FBCTypes_Out$bodyid) %>% select(bodyid,FB.downstream,FB.pre))
```

```{r}
FBCXReal <- FBCTypes_In %>% filter(!(bodyid %in% FBC3Neurons$bodyid))
FBCXRealOut <- FBCTypes_Out %>% filter(!(bodyid %in% FBC3Neurons$bodyid))# & FB.downstream>500)
```

```{r}
FBCTypes_In <- mutate(FBCTypes_In,C3 = bodyid %in% FBC3Real$bodyid)
FBCTypes_Out <- mutate(FBCTypes_Out,C3 = bodyid %in% FBC3RealOut$bodyid)
```


Building the full bag in the FB and in the restricted column. Notice that at this stage the numbers for FC3 in the type to type DFs won't "make sense" as they are normalized on all instances.
```{r}
FBC3NeuronsBag <- neuronBag(unique(c(FBC3Real$type,FBC3RealOut$type)),fixed=TRUE,slctROI="FB",synThresh=0,computeKnownRatio=TRUE,verbose=TRUE)
```

Redefine types (different renaming for inputs and outputs)
```{r}
FBC3Set <- unique(FBC3Real$bodyid)
FBC3OutSet <- unique(FBC3RealOut$bodyid)
FBCXSet <- unique(FBCXReal$bodyid)
FBCXOutSet <- unique(FBCXRealOut$bodyid)
retypedBag <- FBC3NeuronsBag
## Note selecting by bodyid is more rigorous but creates more weirdnesses in the results

retypedBag$inputs_raw <- redefineTypeByBodyId(FBC3NeuronsBag$inputs_raw,postfix="to",sets=list(FBC3Set,FBCXSet),nameModifiers=c("_C3","_CX"))
retypedBag$names <- redefineTypeByBodyId(FBC3NeuronsBag$names,sets=list(FBC3Set,FBCXSet),nameModifiers=c("_C3","_CX"),postfix = "raw")
retypedBag$outputs_raw <- redefineTypeByBodyId(retypedBag$outputs_raw,postfix="from",sets=list(FBC3OutSet,FBCXOutSet),nameModifiers=c("_C3","_CX"))

retypedBag$inputs <- getTypeToTypeTable(retypedBag$inputs_raw,typesTable=retypedBag$names,oldTable=retypedBag$inputs)
retypedBag$outputs <-  getTypeToTypeTable(retypedBag$outputs_raw,typesTable=retypedBag$outputsTableRef,oldTable=retypedBag$outputs) 
```

```{r}
FBC3InputComp <- retypedBag$inputs %>% filter(grepl("_C[3|X]",type.to)) %>% 
  mutate(column=substring(str_extract(type.to,"_C[3|X]"),2)) %>%
  group_by(databaseType.from,databaseType.to,column) %>%
  summarize(weightRelative=mean(knownWeightRelative),
            known_synapses=first(knownTotalROIweight)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype",1:3,".from")),c(paste0("supertype",1:3,".to"))),
              names_from= "column",
              values_from = c("weightRelative","known_synapses"),
              values_fill=list("weightRelative"=0)) %>%
  rename(C3=weightRelative_C3,
         CX=weightRelative_CX)

FBC3InputComp <-  group_by(FBC3InputComp,databaseType.to) %>% mutate(known_synapses_C3=mean(known_synapses_C3,na.rm=TRUE),
                                                                     known_synapses_CX=mean(known_synapses_CX,na.rm=TRUE),
                                                                     known_synapses_ratio = (known_synapses_C3 - known_synapses_CX)/known_synapses_CX) %>% ungroup()
```

```{r}
FBC3OutputComp <- retypedBag$outputs %>% filter(grepl("_C[3|X]",type.from)) %>% 
  mutate(column=substring(str_extract(type.from,"_C[3|X]"),2)) %>%
  group_by(databaseType.from,databaseType.to,column) %>%
  summarize(outputContribution=mean(knownOutputContribution),
            known_synapses=first(knownTotalPreROIweight)) %>%
  ungroup() %>%
  supertype() %>%
  pivot_wider(id_cols=c("databaseType.from","databaseType.to",c(paste0("supertype",1:3,".from")),c(paste0("supertype",1:3,".to"))),
              names_from= "column",
              values_from = c("outputContribution","known_synapses"),
              values_fill=list("outputContribution"=0)) %>%
  rename(C3=outputContribution_C3,
         CX=outputContribution_CX)

FBC3OutputComp <-  group_by(FBC3OutputComp,databaseType.from) %>% mutate(known_synapses_C3=mean(known_synapses_C3,na.rm=TRUE),
                                                                     known_synapses_CX=mean(known_synapses_CX,na.rm=TRUE),
                                                                     known_synapses_ratio = (known_synapses_C3 - known_synapses_CX)/known_synapses_CX) %>% ungroup()
```

```{r}
FBC3Comp <- bind_rows(mutate(FBC3InputComp,side="inputs",
                                           supertype2=supertype2.to,
                                           databaseType=databaseType.to),
                      mutate(FBC3OutputComp,side="outputs",
                                           supertype2=supertype2.from,
                                           databaseType=databaseType.from))
```

```{r}
synapseDiffC3 <- ggplot(distinct(FBC3Comp,databaseType,side,.keep_all = TRUE),aes(x=stringr::str_replace(databaseType,"Delta","\u0394"),y=known_synapses_ratio*100,color=supertype2)) + geom_point() + scale_color_CX_supertype(name="Supertype") + theme_paper() + facet_grid(.~side,scales="free_x") + xlab("") + ylab("known synapses change (%)")+theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333))+ ggforce::geom_mark_circle(aes(filter = (databaseType == "hDeltaA" & side=="outputs")),color="black",expand=0.03) + geom_hline(yintercept=0,lty=2)
synapseDiffC3
```




```{r}
FBCompFits <- getFit(FBC3Comp)
```

```{r}
FC3Slopes <- ggplot(FBCompFits,aes(x=stringr::str_replace(databaseType,"Delta","\u0394"),y=estimate,ymin=estimate-std.error,ymax=estimate+std.error,color=supertype2)) + geom_point() + geom_linerange() + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper()+theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +xlab("") +ylab("slope estimate")+ ggforce::geom_mark_circle(aes(filter = (databaseType == "hDeltaA" & side=="outputs")),color="black",expand=0.03) + geom_hline(lty=2,yintercept = 1)
FC3Slopes
```

```{r}
FBComp <- ggplot(filter(FBC3Comp,databaseType=="hDeltaA" & side=="outputs"),aes(x=CX,y=C3)) + geom_point(aes(color=supertype2.to))  + geom_smooth(formula=y~x,method="lm",color="grey") + coord_fixed()+
  geom_abline(linetype=2) + theme_paper()  + scale_color_CX_supertype(name="Supertype") + ylab("relative weight in column 3") + xlab("relative weight in other columns") 
FBComp
```

### Anatomy illustration of FB column 3
```{r}
FC3Mesh <- neuprintr::neuprint_ROI_mesh("FB-column3") #readobj::read.obj("~/Dropbox (HHMI)/FIBSEM CX Paper Jan 2020/Figures/validation/FB-column3.obj",convert.rgl = TRUE)[[1]]
FBMesh <- neuprintr::neuprint_ROI_mesh("FB")
```

```{r}
hDeltaA_C3Id <- distinct(filter(retypedBag$outputs_raw,type.from=="hDeltaA_C3"),from,type.from)$from
hDeltaA_CXId <- distinct(filter(retypedBag$outputs_raw,type.from=="hDeltaA_CX"),from,type.from)$from
```


```{r}
hDeltaA_C3 <- lapply(hDeltaA_C3Id,getNeuronMesh,cloud=TRUE)
hDeltaA_CX <- lapply(hDeltaA_CXId,getNeuronMesh,cloud=TRUE)
hDeltaA_C3Synapses <- neuprint_get_synapses(hDeltaA_C3Id,roi="FB") %>% filter(prepost==0)
hDeltaA_CXSynapses <- neuprint_get_synapses(hDeltaA_CXId,roi="FB") %>% filter(prepost==0)
```


```{r}
nopen3d()
par3d(windowRect = c(20, 30, 1500, 1500))
plot3d(FBMesh,color="white",alpha=0.2,xlab="",ylab="",zlab="",box=FALSE,axes=FALSE,smooth=FALSE)
par3d(scale=c(1,1,1))
plot3d(FC3Mesh,color="#908827",add=TRUE,alpha=0.2,smooth=FALSE,shininess=100)
plot3d(hDeltaA_C3[[1]],color="SteelBlue",add=TRUE,smooth=FALSE,shininess=100)
plot3d(hDeltaA_C3Synapses[c("x","y","z")],add=TRUE,col="orange",size=5)
plot3d(hDeltaA_CX[[1]],color="grey80",add=TRUE,smooth=FALSE,shininess=100)
plot3d(hDeltaA_CX[[2]],color="grey60",add=TRUE,smooth=FALSE,shininess=100)
plot3d(hDeltaA_CX[[3]],color="grey40",add=TRUE,smooth=FALSE,shininess=100)
plot3d(hDeltaA_CXSynapses[c("x","y","z")],add=TRUE,col="orange",size=5)
nview3d("ventral")
rgl.snapshot(paste0(validationFolder,"frontC3.png"))
```

```{r}
FBC3Frame <- ggdraw() + draw_image(paste0(validationFolder,"frontC3.png"),scale=1.55,vjust=0,clip="on") + theme_paper_map()
FBC3Frame <- FBC3Frame + annotate(geom="text",x=0.35,y=0.62,label="Column 3",color="#908827")
FBC3Frame <- FBC3Frame + annotate(geom="text",x=0.4,y=0.84,label="hΔA outputing \n in other columns",color="grey20")
FBC3Frame <- FBC3Frame + annotate(geom="text",x=0.76,y=0.92,label="hΔA outputing \n in column 3",color="SteelBlue")
FBC3Frame <- FBC3Frame + annotate(geom="point",x=0.73,y=0.79,color="orange",size=1) + 
  annotate(geom="text",x=0.84,y=0.79,label="Output synapses")
FBC3Frame
```

```{r}
#fcLayout <- "
#AAC
#BBD"
save_plot(paste0(validationFolder,"FBCounts.svg"),synapseDiffC3,base_width=6,base_height=2.25)
save_plot(paste0(validationFolder,"FBSlopes.svg"),FC3Slopes,base_width=6,base_height=2.25)
save_plot(paste0(validationFolder,"FBExampleFit.svg"),FBComp,base_width=3,base_height=3)


fcLayout <- c(
  area(t = 1, l = 1, b = 5, r = 5),
  area(t = 1, l = 6, b = 4, r = 10),
  area(t = 6, l = 2, b = 8, r = 4),
  area(t = 5, l = 6, b = 8, r = 10)
)


FC3Panel <- (FBC3Frame + 
  (synapseDiffC3 + theme(legend.position = "none")) + (FBComp + theme(legend.position = "none")) + 
  FC3Slopes) + plot_layout(design = fcLayout) + plot_annotation(tag_levels=c("i"))
FC3Panel
```

### EB before/after comparison
```{r}
EBMesh <- neuprint_ROI_mesh("EB")
```

```{r}
newConnection <- neuprint_login(server="https://neuprint.janelia.org",token="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InJvbWFpbi5mcmFuY29udmlsbGVAZ21haWwuY29tIiwibGV2ZWwiOiJyZWFkd3JpdGUiLCJpbWFnZS11cmwiOiJodHRwczovL2xoNi5nb29nbGV1c2VyY29udGVudC5jb20vLWdtUDkxREF4LTNvL0FBQUFBQUFBQUFJL0FBQUFBQUFBQUFBL0FDSGkzcmRaaThLWElURkNhTWpzQldIZUFqcTZ6SkdtX2cvcGhvdG8uanBnP3N6PTUwP3N6PTUwIiwiZXhwIjoxNzYzMzY1MTMyfQ.yCthFpsDrQJLl41WjLf3U-iN-21x_opCXDcnhbizC_g",Force = T)
```

```{r}
oldConnection <- neuprint_login(server="https://emdata1.int.janelia.org:11000/",token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InJvbWFpbi5mcmFuY29udmlsbGVAZ21haWwuY29tIiwibGV2ZWwiOiJyZWFkd3JpdGUiLCJpbWFnZS11cmwiOiJodHRwczovL2xoNi5nb29nbGV1c2VyY29udGVudC5jb20vLWdtUDkxREF4LTNvL0FBQUFBQUFBQUFJL0FBQUFBQUFBQUFBL0FBS1dKSk14RURObVNiekk5TjNULWw2RkRySWhHdG5LNncvcGhvdG8uanBnP3N6PTUwP3N6PTUwIiwiZXhwIjoxNzY2NDY0NjI2fQ.HsBHKOqeLUUcBcOY-GwzbCHrBMdCBesaICM4UUQSH_k",config=httr::config(ssl_verifypeer=0L),dataset="hemibrain:v0.9pre_dense",Force=T)
```

Select EB neurons for inputs/outputs
```{r}
ebNeurons <- neuprint_bodies_in_ROI("EB",all_segments = FALSE,conn = newConnection)
ebInfo <- filter(getRoiInfo(ebNeurons$bodyid,conn=newConnection),roi=="EB")
ebInfo[is.na(ebInfo)] <- 0
```

```{r}
ebIns <- filter(ebInfo,upstream>200)
ebOuts <- filter(ebInfo,downstream>200)
```

#### Comparing neuron to neuron connections
```{r}
exampleEPG <- 789126240
exampleEPGNew <- getNeuronMesh(exampleEPG,cloud=TRUE)
exampleEPGOld <- getNeuronMesh(exampleEPG,cloud=TRUE,node="34d7a")
epgInputSynapsesNew <- filter(neuprint_get_synapses(exampleEPG,roi="EB",conn=newConnection),prepost==1)# %>% select(x,y,z)
epgInputSynapsesOld <- filter(neuprint_get_synapses(exampleEPG,roi="EB",conn=oldConnection),prepost==1)# %>% select(x,y,z)
partnerListNew <- filter(neuprint_get_meta(unique(c(epgInputSynapsesNew$partner)),all_segments = FALSE,conn=newConnection),status=="Traced")
partnerListOld <- filter(neuprint_get_meta(unique(c(epgInputSynapsesOld$partner)),all_segments = FALSE,conn=oldConnection),status=="Traced")
epgInputSynapsesNew <-  filter(epgInputSynapsesNew,partner %in% partnerListNew$bodyid) %>% select(x,y,z)
epgInputSynapsesOld <- filter(epgInputSynapsesOld,partner %in% partnerListOld$bodyid) %>% select(x,y,z)
```


```{r}
nopen3d()
par3d(windowRect = c(30, 30, 1530, 1530))
plot3d(EBMesh,color="white",alpha=0.2,xlab="",ylab="",zlab="",box=FALSE,axes=FALSE)
par3d(scale=c(1,1,1))
shade3d(exampleEPGOld,color="grey80")
shade3d(exampleEPGNew,color="red")
plot3d(epgInputSynapsesOld,add=T,col="#B32DB5")
plot3d(epgInputSynapsesNew,add=T,col="#053CFF")
nview3d("ventral")
zoom0View <- par3d("userProjection")
rgl.snapshot(paste0(validationFolder,"frontEBZoom1.png"))
```

```{r}
nopen3d()
par3d(windowRect = c(30, 30, 1530, 1530))
par3d(userProjection=translationMatrix(-1.2,1.6,0) %*% zoom0View)
plot3d(EBMesh,color="white",alpha=0.2,xlab="",ylab="",zlab="",box=FALSE,axes=FALSE)
par3d(scale=c(1,1,1))
nview3d("ventral",zoom=0.1)
shade3d(addNormals(exampleEPGOld),color="grey80")
shade3d(addNormals(exampleEPGNew),color="red")


plot3d(epgInputSynapsesOld,add=T,col="#B32DB5",size=15)
plot3d(epgInputSynapsesNew,add=T,col="#053CFF",size=15)
```

```{r}
rgl.snapshot(paste0(validationFolder,"frontEBZoom2.png"))
```

```{r}
EPGViews <- ggdraw() + draw_image(paste0(validationFolder,"frontEBZoom1.png"),scale=1.6,clip="on") + draw_image(paste0(validationFolder,"frontEBZoom2.png"),scale=0.5,vjust=-0.23,hjust=0.05,clip="on") + theme_paper_map() + 
   annotate(geom="text",x=0.25,y=0.22,label="Synapses",hjust=0) +
  annotate(geom="point",x=0.25,y=0.18,color="#B32DB5",size=1) + 
  annotate(geom="point",x=0.25,y=0.14,color="#053CFF",size=1) +
  annotate(geom="text",x=0.26,y=0.18,label="Initially traced",hjust=0) +
  annotate(geom="text",x=0.26,y=0.14,label="New additions",hjust=0) +
  annotate(geom="text",x=0.33,y=0.68,label="*",hjust=0,size=8,color="red")
EPGViews
```


```{r}
EBAges <- getCompConnectionTable(ebIns$bodyid,ebOuts$bodyid,"EB",newConnection,oldConnection)
```

```{r}
EBAges_filtered <- filter(EBAges,known_synapses_ratio>0.1)
EBAges_summary <-distinct(EBAges_filtered,bodyid,side,.keep_all = TRUE) 
synChangeEB <- ggplot(EBAges_summary,aes(x=databaseType,y=known_synapses_ratio*100,color=supertype2)) + geom_jitter(width=0.25,size=0.4) + 
     scale_color_CX_supertype(name="Supertype") + theme_paper() + facet_grid(.~side,scales="free_x") + xlab("") + ylab("known synapses change (%)") +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) + ylim(c(0,120))+ggforce::geom_mark_circle(aes(filter = (bodyid == exampleEPG & side=="inputs")),color="black",expand=0.03)
synChangeEB
```

```{r}
synChangeEBTot <- ggplot(distinct(EBAges,bodyid,side,.keep_all = TRUE),aes(x=databaseType,y=known_synapses_ratio*100,color=supertype2)) + geom_jitter(width=0.2,size=1) + scale_color_CX_supertype(name="Type") + theme_paper() + facet_grid(.~side,scales="free_x")+ xlab("") + ylab("known synapses change (%)") + theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) + geom_hline(yintercept = 10,linetype=2,color="grey") + ggforce::geom_mark_circle(aes(filter = (bodyid == exampleEPG & side =="inputs")),color="black",expand=0.03)
synChangeEBTot
```
```{r}
EBFits <- getFit(EBAges,groups = c("bodyid","databaseType","supertype2","side"),predicted="new",predictor="old")
EBFits <- left_join(EBFits,distinct(EBAges,bodyid,databaseType,supertype2,side,known_synapses_ratio,known_synapses.old,known_synapses.new),by=c("bodyid","databaseType","supertype2","side"))
```



```{r}
EBSlopes <- ggplot(filter(EBFits,paste(bodyid,side) %in% paste(EBAges_summary$bodyid,EBAges_summary$side)),aes(x=databaseType,y=estimate,ymin=estimate-std.error,ymax=estimate+std.error,color=supertype2)) + geom_pointrange(size=0.4/20,position=position_jitter(width=0.2)) + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +xlab("") +ylab("slope estimate") + ggforce::geom_mark_circle(aes(filter = (bodyid == exampleEPG & side=="inputs")),color="black",expand=0.03) + geom_hline(yintercept = 1,lty=2)
EBSlopes
```

```{r}
fitValsEPG <- filter(EBFits,bodyid==exampleEPG & side=="Inputs")
EBCompExample <- ggplot(filter(EBAges_filtered,bodyid==exampleEPG & side=="inputs"),aes(x=old,y=new)) + geom_point(aes(color=supertype2.from),size=0.4) + geom_smooth(formula=y~x,method="lm",color="grey70",alpha=0.1) + 
  geom_abline(linetype=2,lwd=0.2) + theme_paper()  + scale_color_CX_supertype(name="Supertype") + xlab("relative weight in the old dataset") + coord_fixed() +
  ylab("relative weight in the new dataset") + annotate(geom="text",x=0.015,y=0.002,label=paste0("s= ",format(fitValsEPG$estimate,digits = 3),"\n r\u00b2= ",format(fitValsEPG$adj.r.squared,digits=3)))

EBCompExample
```

```{r}
save_plot(paste0(validationFolder,"EBCounts.svg"),synChangeEB,base_width=6.5,base_height=2.25)
save_plot(paste0(validationFolder,"EBSlopes.svg"),EBSlopes,base_width=6.5,base_height=2.25)
save_plot(paste0(validationFolder,"EBExampleFit.svg"),EBCompExample,base_width=3,base_height=3)


ebLayout <- c(
  area(t = 1, l = 1, b = 5, r = 5),
  area(t = 1, l = 6, b = 4, r = 10),
  area(t = 6, l = 2, b = 8, r = 4),
  area(t = 5, l = 6, b = 8, r = 10)
)

EBFig <- (EPGViews + 
  synChangeEB  + (EBCompExample + theme(legend.position="none")) +
  (EBSlopes+ theme(legend.position="none"))) +plot_layout(design = ebLayout) #+ plot_annotation(tag_levels=c("A","i"))

EBFig
```

```{r}
mainFig <- (EBFig + plot_layout(tag_level = "new")) / (PBFigAlt + plot_layout(tag_level = "new"))/(FC3Panel + plot_layout(tag_level="new")) + plot_annotation(tag_levels=c("A","i"),tag_sep = "",title="Validation - Figure 1: tracing effect on connection weights",theme=theme(title=element_text(size=12,face="bold"))) 
mainFig

save_plot(paste0(validationFolder,"Validation-Figure1.pdf"),mainFig,nrow = 4,ncol=2,base_width = 8.5/2,base_height=11/3,device=cairo_pdf)
```

#### EB SI
```{r}
EBCompFull <- ggplot(filter(EBAges_filtered),aes(x=old,y=new,fill=supertype2)) + geom_smooth(formula=y~x,aes(group=bodyid),method="lm",alpha=0.3,color="grey30",size=0.1) + 
  geom_abline(linetype=2,lwd=0.2) + scale_fill_CX_supertype(name="Supertype") + xlab("relative weight in the old dataset") + coord_fixed() +
  ylab("relative weight in the new dataset") + facet_wrap(supertype2~side)+ theme_paper() + ggtitle("Validation figure 1 - figure supplement 1: individual neuron to neuron fits")#+theme(panel.border = element_rect(color = "gray 50", fill = NA))
#EBCompFull
save_plot(paste0(validationFolder,"Validation-Figure1-SI1.pdf"),EBCompFull,nrow = 2,ncol=3,base_width = 8.5/3,device=cairo_pdf)
```

```{r}
incSlope <-  ggplot(filter(EBFits,paste(bodyid,side) %in% paste(EBAges_summary$bodyid,EBAges_summary$side)),aes(x=known_synapses_ratio*100,y=estimate,ymin=estimate-std.error,ymax=estimate+std.error,color=supertype2)) + geom_pointrange(size=0.2/3) + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +xlab("known synapse increase") +ylab("slope estimate") + geom_hline(yintercept=1,lty=2)
incSlope
```
```{r}
incRS <-  ggplot(filter(EBFits,paste(bodyid,side) %in% paste(EBAges_summary$bodyid,EBAges_summary$side)),aes(x=known_synapses_ratio*100,y=adj.r.squared,color=supertype2)) + geom_point(size=1) + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333))  +xlab("known synapse increase") +ylab("adjusted r\u00b2") + geom_hline(yintercept=1,lty=2)
incRS
```


```{r}
nSlope <-  ggplot(filter(EBFits,paste(bodyid,side) %in% paste(EBAges_summary$bodyid,EBAges_summary$side)),aes(x=known_synapses.new,y=estimate,ymin=estimate-std.error,ymax=estimate+std.error,color=supertype2)) + geom_pointrange(size=0.2/3) + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +xlab("# synapses") +ylab("slope estimate")  + geom_hline(yintercept=1,lty=2)
nSlope
```
```{r}
nRS <-  ggplot(filter(EBFits,paste(bodyid,side) %in% paste(EBAges_summary$bodyid,EBAges_summary$side)),aes(x=known_synapses.new,y=adj.r.squared,color=supertype2)) + geom_point(size=1) + scale_color_CX_supertype(name="Supertype") + facet_grid(.~side,scales = "free_x") + theme_paper() +theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust=0.5),strip.background = element_rect(color="black"),strip.text = element_text(family="arial",size=6*1.333333)) +xlab("# synapses") +ylab("adjusted r\u00b2") +geom_hline(yintercept=1,lty=2)
nRS
```

```{r}
EBSI2 <- (incSlope + theme(legend.position="none",plot.margin = margin(b=50,r=50))+ggtitle("Slope estimates")| incRS+ theme(legend.position="none",plot.margin = margin(b=50))+ggtitle("Adjusted r\u00b2"))/
  (nSlope + theme(legend.position="none",plot.margin = margin(r=50))| nRS) + plot_layout(guides="collect") + plot_annotation(title="Validation Figure 1 - figure supplement 1",theme=theme(title=element_text(size=12*1.111111,face="bold")))
EBSI2
```
```{r}
save_plot(paste0(validationFolder,"Validation-Figure1-SI1_new.svg"),EBSI2,base_width = 8.5*1.333333,base_height=6)
```




