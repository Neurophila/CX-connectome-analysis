---
title: "Notebook for plotting PB-FB phase shifts (discrete + continuous mappings & FB connectivity)"
output:
  html_document:
    df_print: paged
---

### Load libraries
```{r message=FALSE, warning=FALSE}
library(neuprintrExtra)
library(neuprintr)
library(ggraph)
library(stringr)
library(tidygraph)
library(dplyr)
library(prismatic)
```

# Make directory where figures will be saved to
```{r}

# Directory where synapse data (output of FB_GetAndSave_Synapses.Rmd) and column location data (output of FB_ColumnLocations.Rmd) are stored
SaveDir="C:/Users/labadmin/Documents/Cx_EM_Analysis/BradData/FB_Analysis/"

# Directory to save plots to
PlotDir=paste(SaveDir, "/Figure_PhaseShift/",sep="")
if (!dir.exists(PlotDir)){dir.create(PlotDir)}

```

# Connect to neuprint server.
```{r}
neuprint_login()
```

# Get general functions
```{r}

source("FB_Analysis_Utils.R")

```

# Load pre-processed synapse and column location data and remove variables that won't be used
```{r}

load(paste(SaveDir,"FBColumnarSynapses_PostPCA.RData",sep=""))
rm(list=c("roiEigen","Mesh_FB_Points","Mesh_FB_L1_Points", "Mesh_FB_L2_Points","Mesh_FB_L3_Points", "Mesh_FB_L4_Points",
          "Mesh_FB_L5_Points", "Mesh_FB_L6_Points","Mesh_FB_L7_Points", "Mesh_FB_L8_Points", "Mesh_FB_L9_Points","origin"))
load(paste(SaveDir,"FB_ColumnPositions.RData",sep=""))

# Assign Side, PB glom, and FB col info
FBC_SynsAll=Assign_FBcol_PBglom(FBC_SynsAll, "name", "Side", "PBglom", "FBcol")

```


# Plot discrete PB glomeruli to FB column mappings for all PB-FB-XX types
```{r message=FALSE, warning=FALSE}

# Get all PB-FB-XX neurons and parse name to get PB glomeruli and FB column info
FB_Bodies=getNeuronsInRoiTable("FB",0)
FB_Bodies_Meta=neuprint_get_meta(FB_Bodies$bodyid)
PB_FB_Bodies=subset(FB_Bodies_Meta, startsWith(type,"PF"))
PB_FB_Bodies=Assign_FBcol_PBglom(PB_FB_Bodies, "name", "Side", "PBglom", "FBcol")

# Make graphs showing number of neurons connecting each PB glomerulus to each FB column
Plot_PBglom_FBcol_Mapping(PB_FB_Bodies, PlotDir)

```


# Plot PB-FB-XX neuron columnar locations along with their PB-FB mappings to show continuous phase shifts
```{r message=FALSE, warning=FALSE}

# Loop over columnar neuron types and make plots
PbFb_Types=sort(unique(subset(ColumnPositions_All, startsWith(type,"PF"))$type))
for (ttt in 1:length(PbFb_Types)){
  
  # Get synapses for just this neuron type
  TempTypeSynsAll=subset(ColumnPositions_All, type == PbFb_Types[ttt] & !is.na(PBglom))
  
  # Find layer with most synapses 
  TempSynsPerLayer=subset(TempTypeSynsAll, !Layer=="FB") %>% group_by(Layer) %>% summarize(numsyns=mean(numsyns)) 
  MaxLayer=as.character(TempSynsPerLayer$Layer[which(TempSynsPerLayer$numsyns == max(TempSynsPerLayer$numsyns))]) 
  
  # Find max columns for this type
  TempColNum=length(unique(TempTypeSynsAll$FBcol))
  
  # Use layer with most synapses for plotting
  CurrentLayer=MaxLayer
  PlotData=subset(TempTypeSynsAll, Layer==CurrentLayer)
  eval(parse(text= paste("OUTLINE=Outline_", CurrentLayer,"_XZ",sep="")))
  
  # Get pixel to um converstion factor
  Convert=8/1000 # 8 nm/pixel, divided by 1000 nm per um.
  
  # Make nodes
  TempNodeNames=c( paste("R", as.character(seq(from=9,to=1,by=-1)),sep=""), 
                paste("L", as.character(seq(from=1,to=9,by=1)),sep=""),
                paste(PlotData$name, PlotData$bodyid,sep="_") )
  TempX=c(seq(from=-74,to=-10,by=8), seq(from=10,to=74,by=8), PlotData$X*Convert)
  TempY=c(rep(70,18), -PlotData$Z*Convert)
  CCC=c("C1","C2","C3","C4","C5","C6","C7","C8","C9",
        "C1","C2","C3","C4","C5","C6","C7","C8","C9",
        PlotData$FBcol)
  NNN=c(rep("R",9), rep("L",9), PlotData$Side)
  NODES=data.frame(name=TempNodeNames,x=TempX,y=TempY, COLORZ=CCC, Side=NNN)

  # Make edges, with colors that correspond to PB glomeruli anatomical phases
  EDGES=data.frame(from=PlotData$PBglom, to=paste(PlotData$name, PlotData$bodyid,sep="_") , weight=1, COLORZ=PlotData$PBglom)
  EDGES$COLORZ=factor(EDGES$COLORZ, levels=c("R9","R8","R7","R6","R5","R4","R3","R2","R1",
                                             "L1","L2","L3","L4","L5","L6","L7","L8","L9") )
  ColumnColors=color(c("#FFF688", "#FFA010", "#FF3610", "#FBB5DE", "#7D24E7", "#5C89C7", "#C7FFEF", "#81FB35", "#FFF688",
                       "#FFF688", "#FFA010", "#FF3610", "#FBB5DE", "#7D24E7", "#5C89C7", "#C7FFEF", "#81FB35", "#FFF688"))
  
  # Make ggraph object
  NODES$name=as.character(NODES$name)
  EDGES$from=as.character(EDGES$from)
  EDGES$to=as.character(EDGES$to)
  graph = tbl_graph(NODES, EDGES)

  # Node Colors
  NodeColors=color(c("#FFF688", "#FFA010", "#FF3610", "#FBB5DE", "#7D24E7", "#5C89C7", "#C7FFEF", "#81FB35", "#FFF688"))
  
  # Make graph
  P1=ggraph(graph,layout="manual",x=NODES$x,y=NODES$y) +
    geom_edge_diagonal(aes(width=weight, color=COLORZ),alpha=0.5,strength=0.5) +
    geom_point(data=subset(NODES,Side=="R"), aes(x=x,y=y, fill=COLORZ),size=3, color="black", shape=21) + 
    geom_point(data=subset(NODES,Side=="L"), aes(x=x,y=y, fill=COLORZ),size=3, color="black", shape=22) +
    scale_fill_manual(values=NodeColors, drop=FALSE) +
    coord_fixed(ratio = 1) +
    theme_classic() + 
    geom_path(data=OUTLINE, aes(x=c1*Convert, y=-c2*Convert), size = 0.5) + 
    scale_edge_color_manual(values=ColumnColors,drop=FALSE) +
    scale_edge_width(range = c(0.75,0.9)) + xlim(-80,80) + ylim(-50,80)
  ggsave(paste(PlotDir, "ColumnLocs_", PbFb_Types[ttt], "_", as.character(CurrentLayer), ".png", sep=""),
         plot = P1, device='png', scale = 1, width = 12, height = 8, units ="in", dpi = 500, limitsize = TRUE)
}

```


# Plot connectivity matrices to show that PB-FB phase shifts are realized in connectivity
```{r message=FALSE, warning=FALSE}

# Pick a pre (PB-FB-XX type) and post (and downstream FB columnar type) 
Pre="PFNa"    # (PFNa or PFNp_a)
Post="FC1B"   # (for PFNa: FC1B or hDeltaC; for PFNp_a: PFL2 or vDeltaL)

# Get connectivity matrix
ConnectMeta=subset(FB_Bodies_Meta, type %in% c(Pre,Post))
PbFb_Bag=neuronBag(ConnectMeta, slctROI="FB")
Connect_Mat=PbFb_Bag$outputs_raw
Connect_Mat=subset(Connect_Mat, databaseType.from==Pre & databaseType.to==Post)

# Get PB glomerulus and FB column info from neuron names and compute average relative weights
Connect_Mat=Assign_FBcol_PBglom(Connect_Mat, "name.from", "Side.from", "PBglom.from", "FBcol.from")
Connect_Mat=Assign_FBcol_PBglom(Connect_Mat, "name.to", "Side.to", "PBglom.to", "FBcol.to")
Connect_Mat_Phase=Connect_Mat %>% group_by(PBglom.from, FBcol.to) %>% summarise(weightRelative=mean(weightRelative))

# Set factor levels so PB glomruli and FB columns are arrange properly along each axis
Connect_Mat_Phase$PBglom.from=factor(Connect_Mat_Phase$PBglom.from,
    levels=c("L9","R1","L8","R2","L7","R3","L6","R4","L5","R5","L4","R6","L3","R7","L2","R8","L1","R9"))
Connect_Mat_Phase$FBcol.to=factor(Connect_Mat_Phase$FBcol.to,
    levels=c("C0","C1","C2","C3","C4","C5","C6","C7","C8","C9","C10","C11","C12"))

# Plot connectivity matrix
P1 <- ggplot(Connect_Mat_Phase) +
  scale_fill_gradient2(low="thistle", mid="blueviolet", high="black", midpoint =0.03, limits=c(0,0.06)) +
  geom_tile(aes(FBcol.to,PBglom.from,fill=weightRelative)) + scale_y_discrete(drop=FALSE) + theme_classic() +
  ggtitle(paste(Pre, " to ", Post, sep="")) + theme(axis.text.x = element_text(angle = 90))
P1
ggsave(paste(PlotDir, Pre, "_to_", Post,"_PhaseShift", ".png", sep=""),
       plot = P1, device='png', scale = 1, width = 4, height = 5, units ="in", dpi = 500, limitsize = TRUE)


```

